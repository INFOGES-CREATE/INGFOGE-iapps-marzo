<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Poblacional Premium - Infoges Salud Curicó</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/tablero.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando datos poblacionales avanzados...</div>
    </div>

    <!-- EXCEPTIONAL HEADER -->
    <header class="main-header">
        <div class="header-top">
            <div class="header-top-content">
                <div class="header-info">
                    <span><i class="fas fa-calendar-alt"></i> Actualizado: Septiembre 2024</span>
                    <span><i class="fas fa-users"></i> 150,113 habitantes</span>
                    <span><i class="fas fa-hospital"></i> 6 centros de salud</span>
                </div>
                <div class="header-actions">
                    <a href="#" class="header-btn">
                        <i class="fas fa-question-circle"></i> Ayuda
                    </a>
                    <a href="#" class="header-btn">
                        <i class="fas fa-cog"></i> Configuración
                    </a>
                </div>
            </div>
        </div>
        <div class="header-main">
            <div class="header-content">
                <div class="header-brand">
                    <div class="brand-logo">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="brand-text">
                        <h1>INFOGES TABLERO POBLACIONAL</h1>
                        <p>Sistema Avanzado de Información Poblacional</p>
                    </div>
                </div>
                <nav class="header-nav">
                    <a href="" class="nav-btn active">
                        <i class="fas fa-chart-pie"></i>
                        Tablero Poblacional
                    </a>
                    <a href="../metassanitarias/abril/" class="nav-btn" onclick="navigateToMetasSanitarias()">
                        <i class="fas fa-target"></i>
                        Metas Sanitarias
                    </a>
                    <a href="../iaaps/abril/" class="nav-btn" onclick="navigateToIAAPS()">
                        <i class="fas fa-heartbeat"></i>
                        IAAPS
                    </a>
                    <a href="georeferencial.html" class="nav-btn">
                        <i class="fas fa-map"></i>
                        Georeferencial
                     
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- PREMIUM FILTERS -->
        <div class="premium-filters">
            <div class="filters-header">
                <h2 class="filters-title">
                    <i class="fas fa-filter"></i>
                    Filtros Avanzados
                </h2>
                <div class="quick-filters">
                    <button class="quick-filter-btn active" data-preset="todos">Todos</button>
                    <button class="quick-filter-btn" data-preset="infantil">Infantil</button>
                    <button class="quick-filter-btn" data-preset="adulto-mayor">Adulto Mayor</button>
                    <button class="quick-filter-btn" data-preset="comparar">Comparar</button>
                </div>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Centro de Salud</label>
                    <select id="centroSelect" class="premium-select">
                        <option value="COMUNAL">COMUNA CURICÓ (Total)</option>
                        <option value="CENTRAL">CESFAM Curicó Centro</option>
                        <option value="MAAL">CESFAM Miguel Ángel Arenas López</option>
                        <option value="BMA">CESFAM Betty Muñoz Arce</option>
                        <option value="COLON">CESFAM Colón</option>
                        <option value="SARMIENTO">CESFAM Sarmiento</option>
                        <option value="LOS_NICHES">CESFAM Los Niches</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Grupo Etario</label>
                    <select id="grupoEtarioSelect" class="premium-select">
                        <option value="TODOS">Todos los grupos</option>
                        <option value="INFANTIL">Infantil (0-9 años)</option>
                        <option value="ADOLESCENTE">Adolescente (10-19 años)</option>
                        <option value="ADULTO">Adulto (20-64 años)</option>
                        <option value="ADULTO_MAYOR">Adulto Mayor (65+ años)</option>
                        <option value="PERSONALIZADO">Grupo personalizado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Año de Análisis</label>
                    <select id="yearSelect" class="premium-select">
                        <option value="2024">2024 (Actual)</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Tipo de Análisis</label>
                    <select id="analysisType" class="premium-select">
                        <option value="poblacion">Análisis Poblacional</option>
                        <option value="demografico">Análisis Demográfico</option>
                        <option value="epidemiologico">Análisis Epidemiológico</option>
                        <option value="comparativo">Análisis Comparativo</option>
                    </select>
                </div>
            </div>
            
            <div class="filters-actions">
                <div>
                    <button class="btn-secondary" id="resetFiltersBtn">
                        <i class="fas fa-undo"></i>
                        Resetear Filtros
                    </button>
                    <button class="btn-secondary" id="saveFiltersBtn">
                        <i class="fas fa-save"></i>
                        Guardar Vista
                    </button>
                </div>
                <button class="btn-premium" id="applyFiltersBtn">
                    <i class="fas fa-play"></i>
                    Aplicar Filtros
                </button>
            </div>
            
            <div class="active-filters" id="activeFilters">
                <!-- Filter chips will be added here dynamically -->
            </div>
        </div>
        
        <!-- MODALES PREMIUM COMPLETAMENTE FUNCIONALES -->
<!-- Modal de Ayuda -->
<div id="helpModal" class="premium-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-question-circle"></i> Centro de Ayuda INFOGES</h2>
            <button class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="help-tabs">
                <button class="help-tab active" data-tab="general">Inicio Rápido</button>
                <button class="help-tab" data-tab="charts">Gráficos</button>
                <button class="help-tab" data-tab="filters">Filtros</button>
                <button class="help-tab" data-tab="voice">Comandos de Voz</button>
                <button class="help-tab" data-tab="export">Exportación</button>
            </div>
            
            <div class="help-content">
                <div class="help-panel active" id="general-panel">
                    <h3>Bienvenido al Tablero Poblacional Premium</h3>
                    <p>Este sistema avanzado te permite visualizar y analizar datos demográficos de la población inscrita en los centros de salud de Curicó.</p>
                    
                    <div class="help-card">
                        <div class="help-icon"><i class="fas fa-rocket"></i></div>
                        <div class="help-info">
                            <h4>Navegación Básica</h4>
                            <ul>
                                <li>Utiliza el menú superior para cambiar entre módulos</li>
                                <li>Los indicadores clave muestran valores generales</li>
                                <li>Cada tarjeta del tablero puede expandirse para más detalles</li>
                                <li>Haz clic en elementos de los gráficos para obtener información adicional</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="help-card">
                        <div class="help-icon"><i class="fas fa-lightbulb"></i></div>
                        <div class="help-info">
                            <h4>Consejos Pro</h4>
                            <ul>
                                <li>Utiliza filtros rápidos para análisis comunes</li>
                                <li>Prueba la vista de comparación para contrastar centros</li>
                                <li>Guarda tus vistas frecuentes para acceso rápido</li>
                                <li>Aprovecha los comandos de voz para navegación sin manos</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="help-footer">
                        <button class="btn-premium help-video-btn" id="playTutorialBtn">
                            <i class="fas fa-play-circle"></i> Ver Video Tutorial
                        </button>
                    </div>
                </div>
                
                <div class="help-panel" id="charts-panel">
                    <h3>Guía de Gráficos y Visualizaciones</h3>
                    <p>El sistema ofrece múltiples visualizaciones interactivas que pueden personalizarse.</p>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-chart-pie"></i> Tipos de Gráficos</h4>
                        <div class="help-grid">
                            <div class="help-grid-item">
                                <strong>Gráfico Circular/Torta</strong>
                                <p>Ideal para mostrar proporciones y porcentajes de un total.</p>
                            </div>
                            <div class="help-grid-item">
                                <strong>Gráfico de Barras</strong>
                                <p>Perfecto para comparar valores entre diferentes categorías.</p>
                            </div>
                            <div class="help-grid-item">
                                <strong>Gráfico de Línea</strong>
                                <p>Utilizado para visualizar tendencias a lo largo del tiempo.</p>
                            </div>
                            <div class="help-grid-item">
                                <strong>Pirámide Poblacional</strong>
                                <p>Muestra la distribución por edad y sexo de la población.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-mouse-pointer"></i> Interacción con Gráficos</h4>
                        <ul>
                            <li>Posiciona el cursor sobre elementos para ver detalles</li>
                            <li>Haz clic en leyendas para ocultar/mostrar series</li>
                            <li>Utiliza los botones de tipo de gráfico para cambiar la visualización</li>
                            <li>En la pirámide poblacional, puedes ajustar el nivel de detalle</li>
                        </ul>
                    </div>

                    <div class="help-card">
                        <div class="help-info">
                            <h4>Ejemplo Interactivo</h4>
                            <p>Prueba la interacción con este gráfico de ejemplo:</p>
                            <div style="height:200px; width:100%; margin-top:20px;">
                                <canvas id="helpChartExample"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="help-panel" id="filters-panel">
                    <h3>Filtros y Análisis Personalizados</h3>
                    <p>Los filtros te permiten enfocar tu análisis en segmentos específicos de la población.</p>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-filter"></i> Tipos de Filtros</h4>
                        <ul>
                            <li><strong>Centro de Salud:</strong> Selecciona un centro específico o toda la comuna</li>
                            <li><strong>Grupo Etario:</strong> Filtra por grupos de edad predefinidos</li>
                            <li><strong>Año de Análisis:</strong> Compara datos de diferentes años</li>
                            <li><strong>Tipo de Análisis:</strong> Enfoca tu estudio en aspectos específicos</li>
                        </ul>
                    </div>
                    
                    <div class="help-card">
                        <div class="help-icon"><i class="fas fa-tools"></i></div>
                        <div class="help-info">
                            <h4>Grupos Personalizados</h4>
                            <p>Crea tus propios grupos de edad para análisis específicos:</p>
                            <ol>
                                <li>Selecciona "Grupo personalizado" en el selector de Grupo Etario</li>
                                <li>Define nombres y rangos de edad para cada grupo</li>
                                <li>Añade tantos grupos como necesites</li>
                                <li>Aplica para ver el análisis con tus grupos personalizados</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-save"></i> Guardar y Recuperar Vistas</h4>
                        <p>Las configuraciones de filtros pueden guardarse para uso futuro mediante el botón "Guardar Vista" en el panel de filtros.</p>
                    </div>
                </div>
                
                <div class="help-panel" id="voice-panel">
                    <h3>Comandos de Voz Inteligentes</h3>
                    <p>El sistema permite la navegación y el control mediante comandos de voz para una experiencia más eficiente.</p>
                    
                    <div class="help-card" style="background: var(--gradient-surface);">
                        <h4>Cómo activar el reconocimiento de voz</h4>
                        <p>Haz clic en el botón flotante con ícono de micrófono en la esquina inferior derecha de la pantalla para iniciar el reconocimiento de voz.</p>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn-premium" id="testVoiceCommandBtn">
                                <i class="fas fa-microphone"></i> Probar Reconocimiento de Voz
                            </button>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-microphone"></i> Comandos Disponibles</h4>
                        <div class="voice-commands-list">
                            <div class="voice-command-category">
                                <h5>Navegación</h5>
                                <ul>
                                    <li><strong>"Metas Sanitarias"</strong> - Navega al módulo de Metas Sanitarias</li>
                                    <li><strong>"IAAPS"</strong> - Navega al módulo de IAAPS</li>
                                </ul>
                            </div>
                            
                            <div class="voice-command-category">
                                <h5>Selección de Centro</h5>
                                <ul>
                                    <li><strong>"Centro Curicó"</strong> - Selecciona CESFAM Curicó Centro</li>
                                    <li><strong>"Miguel Ángel"</strong> - Selecciona CESFAM Miguel Ángel Arenas López</li>
                                    <li><strong>"Betty Muñoz"</strong> - Selecciona CESFAM Betty Muñoz Arce</li>
                                    <li><strong>"Colón"</strong> - Selecciona CESFAM Colón</li>
                                    <li><strong>"Sarmiento"</strong> - Selecciona CESFAM Sarmiento</li>
                                    <li><strong>"Los Niches"</strong> - Selecciona CESFAM Los Niches</li>
                                    <li><strong>"Comunal"</strong> - Muestra datos de toda la comuna</li>
                                </ul>
                            </div>
                            
                            <div class="voice-command-category">
                                <h5>Filtros de Edad</h5>
                                <ul>
                                    <li><strong>"Población Infantil"</strong> - Filtra por grupo infantil</li>
                                    <li><strong>"Adolescentes"</strong> - Filtra por grupo adolescente</li>
                                    <li><strong>"Adultos"</strong> - Filtra por grupo adulto</li>
                                    <li><strong>"Adultos Mayores"</strong> - Filtra por grupo adulto mayor</li>
                                    <li><strong>"Todos los grupos"</strong> - Muestra todos los grupos etarios</li>
                                </ul>
                            </div>
                            
                            <div class="voice-command-category">
                                <h5>Acciones</h5>
                                <ul>
                                    <li><strong>"Exportar"</strong> - Inicia la exportación a PDF</li>
                                    <li><strong>"Imprimir"</strong> - Abre el diálogo de impresión</li>
                                    <li><strong>"Comparar"</strong> - Activa la vista de comparación</li>
                                    <li><strong>"Resetear Filtros"</strong> - Limpia todos los filtros aplicados</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="help-panel" id="export-panel">
                    <h3>Exportación e Impresión</h3>
                    <p>El sistema permite exportar los datos y análisis en diferentes formatos para su uso fuera de la plataforma.</p>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-file-pdf"></i> Exportación a PDF</h4>
                        <p>Genera un informe detallado en formato PDF con los principales indicadores y análisis del centro o filtro seleccionado.</p>
                        <ol>
                            <li>Aplica los filtros deseados para personalizar la vista</li>
                            <li>Haz clic en el botón "Exportar a PDF" o usa el comando de voz "exportar"</li>
                            <li>El sistema generará automáticamente un documento PDF con los datos actuales</li>
                            <li>Se incluirán datos demográficos, indicadores clave y análisis</li>
                        </ol>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn-premium" id="demoExportBtn">
                                <i class="fas fa-file-pdf"></i> Demostración de Exportación
                            </button>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-print"></i> Impresión</h4>
                        <p>Imprime directamente el tablero con la configuración visual actual.</p>
                        <ul>
                            <li>Utiliza el botón "Imprimir" o el comando de voz "imprimir"</li>
                            <li>Se abrirá el diálogo de impresión del navegador</li>
                            <li>Ajusta las opciones de impresión según tus necesidades</li>
                        </ul>
                    </div>
                    
                    <div class="help-card">
                        <div class="help-icon"><i class="fas fa-clipboard"></i></div>
                        <div class="help-info">
                            <h4>Consejos para Reportes</h4>
                            <ul>
                                <li>Personaliza los filtros antes de exportar para crear informes específicos</li>
                                <li>Los PDFs incluyen metadatos con fecha de generación para seguimiento</li>
                                <li>Para análisis comparativos, activa la vista de comparación antes de exportar</li>
                                <li>Puedes generar informes por centro individual o por grupos etarios específicos</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <span>INFOGES Premium v2.5</span>
            <button class="btn-secondary" id="closeHelpBtn">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal de Configuración -->
<div id="configModal" class="premium-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-cog"></i> Configuración del Sistema</h2>
            <button class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="config-tabs">
                <button class="config-tab active" data-tab="visual">Apariencia</button>
                <button class="config-tab" data-tab="data">Datos</button>
                <button class="config-tab" data-tab="notifications">Notificaciones</button>
                <button class="config-tab" data-tab="accessibility">Accesibilidad</button>
                <button class="config-tab" data-tab="advanced">Avanzado</button>
            </div>
            
            <div class="config-content">
                <div class="config-panel active" id="visual-panel">
                    <h3>Personalización Visual</h3>
                    <p>Ajusta la apariencia del tablero según tus preferencias.</p>
                    
                    <div class="config-section">
                        <h4>Tema de Color</h4>
                        <div class="theme-selector">
                            <div class="theme-option active" data-theme="default">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #00695c 0%, #1e3a8a 100%);"></div>
                                <span>Predeterminado</span>
                            </div>
                            <div class="theme-option" data-theme="ocean">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #0277bd 0%, #01579b 100%);"></div>
                                <span>Océano</span>
                            </div>
                            <div class="theme-option" data-theme="forest">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);"></div>
                                <span>Bosque</span>
                            </div>
                            <div class="theme-option" data-theme="sunset">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #ff7043 0%, #d84315 100%);"></div>
                                <span>Atardecer</span>
                            </div>
                            <div class="theme-option" data-theme="lavender">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #7e57c2 0%, #4527a0 100%);"></div>
                                <span>Lavanda</span>
                            </div>
                            <div class="theme-option" data-theme="contrast">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #212121 0%, #000000 100%);"></div>
                                <span>Alto Contraste</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Densidad de Elementos</h4>
                        <div class="config-options">
                            <label class="radio-option">
                                <input type="radio" name="density" value="compact">
                                <span class="radio-label">Compacta</span>
                                <span class="radio-desc">Más contenido visible, menos espacio</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="density" value="standard" checked>
                                <span class="radio-label">Estándar</span>
                                <span class="radio-desc">Balance entre espacio y contenido</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="density" value="comfortable">
                                <span class="radio-label">Confortable</span>
                                <span class="radio-desc">Más espacio entre elementos</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Tamaño de Fuente</h4>
                        <div class="range-control">
                            <span>A</span>
                            <input type="range" min="80" max="120" value="100" class="config-range" id="fontSizeRange">
                            <span>A</span>
                        </div>
                        <div class="range-value" id="fontSizeValue">100%</div>
                    </div>
                </div>
                
                <div class="config-panel" id="data-panel">
                    <h3>Configuración de Datos</h3>
                    <p>Personaliza cómo se muestran y procesan los datos del tablero.</p>
                    
                    <div class="config-section">
                        <h4>Visualización de Datos</h4>
                        <div class="config-options">
                            <label class="switch-option">
                                <span class="switch-label">Mostrar valores absolutos</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="showAbsoluteValues">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Mostrar porcentajes</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="showPercentages">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Mostrar tendencias</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="showTrends">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Mostrar proyecciones</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="showProjections">
                                    <span class="slider"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Precisión Numérica</h4>
                        <div class="config-options">
                            <label class="radio-option">
                                <input type="radio" name="precision" value="0" id="precision0">
                                <span class="radio-label">Enteros</span>
                                <span class="radio-desc">Sin decimales (ej. 15%)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="precision" value="1" checked id="precision1">
                                <span class="radio-label">Un decimal</span>
                                <span class="radio-desc">Un decimal (ej. 15.2%)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="precision" value="2" id="precision2">
                                <span class="radio-label">Dos decimales</span>
                                <span class="radio-desc">Dos decimales (ej. 15.25%)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Actualización de Datos</h4>
                        <div class="update-settings">
                            <p class="config-info">Última actualización: <strong>Septiembre 2024</strong></p>
                            <p class="config-info">Próxima actualización programada: <strong>Diciembre 2024</strong></p>
                            <button class="btn-secondary config-btn" id="checkUpdatesBtn">
                                <i class="fas fa-sync"></i> Verificar Actualizaciones
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="config-panel" id="notifications-panel">
                    <h3>Configuración de Notificaciones</h3>
                    <p>Controla cómo y cuándo recibes notificaciones del sistema.</p>
                    
                    <div class="config-section">
                        <h4>Notificaciones del Sistema</h4>
                        <div class="config-options">
                            <label class="switch-option">
                                <span class="switch-label">Notificaciones en pantalla</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="screenNotifications">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Sonidos de notificación</span>
                                <div class="switch">
                                    <input type="checkbox" id="soundNotifications">
                                    <span class="slider"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Duración de Notificaciones</h4>
                        <div class="range-control">
                            <span>Corta</span>
                            <input type="range" min="2" max="10" value="3" class="config-range" id="notificationDurationRange">
                            <span>Larga</span>
                        </div>
                        <div class="range-value" id="notificationDurationValue">3 segundos</div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn-secondary" id="testNotificationBtn">
                                <i class="fas fa-bell"></i> Probar Notificación
                            </button>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Tipos de Notificaciones</h4>
                        <div class="config-options">
                            <label class="switch-option">
                                <span class="switch-label">Éxito (verde)</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="successNotifications">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Información (azul)</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="infoNotifications">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Advertencia (amarillo)</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="warningNotifications">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Error (rojo)</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="errorNotifications">
                                    <span class="slider"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="config-panel" id="accessibility-panel">
                    <h3>Configuración de Accesibilidad</h3>
                    <p>Ajusta la aplicación para mejorar su accesibilidad y usabilidad.</p>
                    
                    <div class="config-section">
                        <h4>Opciones de Lectura</h4>
                        <div class="config-options">
                            <label class="switch-option">
                                <span class="switch-label">Alto contraste</span>
                                <div class="switch">
                                    <input type="checkbox" id="highContrastToggle">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Fuente para dislexia</span>
                                <div class="switch">
                                    <input type="checkbox" id="dyslexiaFontToggle">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Animaciones reducidas</span>
                                <div class="switch">
                                    <input type="checkbox" id="reducedMotionToggle">
                                    <span class="slider"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Reconocimiento de Voz</h4>
                        <div class="config-options">
                            <label class="switch-option">
                                <span class="switch-label">Habilitar comandos de voz</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="voiceCommandsToggle">
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label class="select-option">
                                <span>Idioma de reconocimiento</span>
                                <select class="config-select" id="voiceLanguageSelect">
                                    <option value="es-ES" selected>Español (España)</option>
                                    <option value="es-CL">Español (Chile)</option>
                                    <option value="es-MX">Español (México)</option>
                                    <option value="es-AR">Español (Argentina)</option>
                                    <option value="en-US">Inglés (Estados Unidos)</option>
                                </select>
                            </label>
                            <button class="btn-secondary config-btn mt-10" id="testVoiceRecBtn">
                                <i class="fas fa-microphone"></i> Probar Reconocimiento
                            </button>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Color de Gráficos</h4>
                        <p>Selecciona la paleta de colores para mayor accesibilidad visual.</p>
                        <div class="config-options">
                            <label class="radio-option">
                                <input type="radio" name="colorScheme" value="default" checked id="colorDefault">
                                <span class="radio-label">Predeterminada</span>
                                <div class="color-preview">
                                    <span style="background: #00695c;"></span>
                                    <span style="background: #1e3a8a;"></span>
                                    <span style="background: #f59e0b;"></span>
                                    <span style="background: #dc2626;"></span>
                                </div>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="colorScheme" value="colorblind" id="colorBlind">
                                <span class="radio-label">Daltónicos</span>
                                <div class="color-preview">
                                    <span style="background: #0072B2;"></span>
                                    <span style="background: #E69F00;"></span>
                                    <span style="background: #56B4E9;"></span>
                                    <span style="background: #009E73;"></span>
                                </div>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="colorScheme" value="pastel" id="colorPastel">
                                <span class="radio-label">Tonos Suaves</span>
                                <div class="color-preview">
                                    <span style="background: #8dd3c7;"></span>
                                    <span style="background: #bebada;"></span>
                                    <span style="background: #fb8072;"></span>
                                    <span style="background: #80b1d3;"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="config-panel" id="advanced-panel">
                    <h3>Configuración Avanzada</h3>
                    <p>Opciones avanzadas para usuarios expertos.</p>
                    
                    <div class="config-section">
                        <h4>Rendimiento</h4>
                        <div class="config-options">
                            <label class="switch-option">
                                <span class="switch-label">Modo de alto rendimiento</span>
                                <div class="switch">
                                    <input type="checkbox" id="highPerformanceToggle">
                                    <span class="slider"></span>
                                </div>
                                <span class="switch-desc">Reduce efectos visuales para mejorar el rendimiento</span>
                            </label>
                            <label class="switch-option">
                                <span class="switch-label">Precarga de datos</span>
                                <div class="switch">
                                    <input type="checkbox" checked id="dataPreloadToggle">
                                    <span class="slider"></span>
                                </div>
                                <span class="switch-desc">Carga datos en segundo plano para una navegación más rápida</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Exportación</h4>
                        <div class="config-options">
                            <label class="select-option">
                                <span>Formato de exportación predeterminado</span>
                                <select class="config-select" id="exportFormatSelect">
                                    <option value="pdf" selected>PDF</option>
                                    <option value="excel">Excel</option>
                                    <option value="image">Imagen</option>
                                    <option value="json">JSON (datos)</option>
                                </select>
                            </label>
                            <label class="select-option">
                                <span>Calidad de imagen en PDF</span>
                                <select class="config-select" id="pdfQualitySelect">
                                    <option value="low">Baja (archivo más pequeño)</option>
                                    <option value="medium" selected>Media (recomendado)</option>
                                    <option value="high">Alta (mejor calidad)</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Caché y Datos</h4>
                        <div class="cache-controls">
                            <div class="cache-info">
                                <p>Datos en caché: <strong id="cacheSize">5.2 MB</strong></p>
                                <p>Última limpieza: <strong id="lastCleanDate">Nunca</strong></p>
                            </div>
                            <div class="cache-actions">
                                <button class="btn-secondary config-btn" id="clearCacheBtn">
                                    <i class="fas fa-broom"></i> Limpiar Caché
                                </button>
                                <button class="btn-secondary config-btn danger-btn" id="resetAllBtn">
                                    <i class="fas fa-trash-alt"></i> Restablecer Todo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="cancelConfigBtn">Cancelar</button>
            <button class="btn-premium" id="saveConfigBtn"><i class="fas fa-save"></i> Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- Modal de Reportes y Exportación Premium -->
<div id="reportsModal" class="premium-modal">
    <div class="modal-content reports-modal-content">
        <div class="modal-header reports-header">
            <ero><i class="fas fa-file-export"></i> Reportes Tablero Poblacional</h2>
            <button class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="reports-sidebar">
                <div class="sidebar-section">
                    <h3>Tipo de Reporte</h3>
                    <div class="report-type-selector">
                        <div class="report-type active" data-type="executive">
                            <div class="report-type-icon"><i class="fas fa-chart-line"></i></div>
                            <div class="report-type-label">Ejecutivo</div>
                        </div>
                        <div class="report-type" data-type="detailed">
                            <div class="report-type-icon"><i class="fas fa-chart-bar"></i></div>
                            <div class="report-type-label">Detallado</div>
                        </div>
                        <div class="report-type" data-type="comparative">
                            <div class="report-type-icon"><i class="fas fa-chart-pie"></i></div>
                            <div class="report-type-label">Comparativo</div>
                        </div>
                        <div class="report-type" data-type="demographic">
                            <div class="report-type-icon"><i class="fas fa-users"></i></div>
                            <div class="report-type-label">Demográfico</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Contenido</h3>
                    <div class="report-content-selector">
                        <label class="report-content-item">
                            <input type="checkbox" checked class="content-checkbox" data-content="summary">
                            <span class="checkbox-label">Resumen Ejecutivo</span>
                        </label>
                        <label class="report-content-item">
                            <input type="checkbox" checked class="content-checkbox" data-content="keyIndicators">
                            <span class="checkbox-label">Indicadores Clave</span>
                        </label>
                        <label class="report-content-item">
                            <input type="checkbox" checked class="content-checkbox" data-content="ageGroups">
                            <span class="checkbox-label">Grupos Etarios</span>
                        </label>
                        <label class="report-content-item">
                            <input type="checkbox" checked class="content-checkbox" data-content="genderDistribution">
                            <span class="checkbox-label">Distribución por Sexo</span>
                        </label>
                        <label class="report-content-item">
                            <input type="checkbox" checked class="content-checkbox" data-content="trends">
                            <span class="checkbox-label">Tendencias y Proyecciones</span>
                        </label>
                        <label class="report-content-item">
                            <input type="checkbox" class="content-checkbox" data-content="appendix">
                            <span class="checkbox-label">Apéndices y Metodología</span>
                        </label>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Formato</h3>
                    <div class="format-selector">
                        <div class="format-option active" data-format="pdf">
                            <div class="format-icon"><i class="fas fa-file-pdf"></i></div>
                            <div class="format-label">PDF</div>
                        </div>
                        <div class="format-option" data-format="excel">
                            <div class="format-icon"><i class="fas fa-file-excel"></i></div>
                            <div class="format-label">Excel</div>
                        </div>
                        <div class="format-option" data-format="ppt">
                            <div class="format-icon"><i class="fas fa-file-powerpoint"></i></div>
                            <div class="format-label">PowerPoint</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Diseño</h3>
                    <div class="template-selector">
                        <div class="template active" data-template="modern">
                            <div class="template-preview" style="background: linear-gradient(135deg, #00695c 0%, #1e3a8a 100%)"></div>
                            <div class="template-name">Moderno</div>
                        </div>
                        <div class="template" data-template="classic">
                            <div class="template-preview" style="background: linear-gradient(135deg, #334155 0%, #1e293b 100%)"></div>
                            <div class="template-name">Clásico</div>
                        </div>
                        <div class="template" data-template="vibrant">
                            <div class="template-preview" style="background: linear-gradient(135deg, #7e57c2 0%, #4527a0 100%)"></div>
                            <div class="template-name">Vibrante</div>
                        </div>
                        <div class="template" data-template="minimal">
                            <div class="template-preview" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)"></div>
                            <div class="template-name">Minimalista</div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>Personalización</h3>
                    <div class="customization-options">
                        <div class="option-row">
                            <label>Logo Institucional</label>
                            <label class="upload-button">
                                <span>Subir Logo</span>
                                <input type="file" id="logoUpload" accept="image/*" hidden>
                            </label>
                        </div>
                        <div class="option-row">
                            <label>Incluir Portada</label>
                            <label class="toggle">
                                <input type="checkbox" checked id="includeCover">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="option-row">
                            <label>Calidad de Imágenes</label>
                            <select id="imageQuality" class="premium-select">
                                <option value="high">Alta</option>
                                <option value="medium" selected>Media</option>
                                <option value="low">Baja</option>
                            </select>
                        </div>
                        <div class="option-row">
                            <label>Incluir Marcas de Agua</label>
                            <label class="toggle">
                                <input type="checkbox" id="includeWatermark">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="reports-preview">
                <div class="preview-header">
                    <h3>Vista Previa</h3>
                    <div class="preview-controls">
                        <button class="btn-secondary" id="refreshPreviewBtn">
                            <i class="fas fa-sync-alt"></i> Actualizar Vista
                        </button>
                        <button class="btn-secondary" id="fullscreenPreviewBtn">
                            <i class="fas fa-expand"></i> Pantalla Completa
                        </button>
                    </div>
                </div>

                <div class="preview-container">
                    <!-- Portada del reporte -->
                    <div class="report-page active" data-page="cover">
                        <div class="report-cover">
                            <div class="report-logo">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiMwMDY5NWMiIHJ4PSIyMCIgcnk9IjIwIi8+CjxwYXRoIGQ9Ik0zMCAzMEg3ME03MCAzMFY3ME0zMCAzMFY3ME0zMCA3MEg3MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI1Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjE1IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4=" alt="Logo INFOGES" id="previewLogo">
                            </div>
                            <div class="report-title" id="reportTitlePreview">Análisis Demográfico INFOGES</div>
                            <div class="report-subtitle">Tablero Poblacional Premium</div>
                            <div class="report-date">Generado el 30 de Mayo, 2025</div>
                            <div class="report-author">INFOGES Salud Curicó</div>
                        </div>
                    </div>

                    <!-- Resumen Ejecutivo -->
                    <div class="report-page" data-page="summary">
                        <div class="page-header">
                            <div class="page-title">Resumen Ejecutivo</div>
                        </div>
                        <div class="page-content summary-content">
                            <div class="summary-text">
                                <h3>Panorama Poblacional</h3>
                                <p>La comuna de Curicó presenta una población total de <span class="highlight">150,113 habitantes</span>, con una distribución por sexo de <span class="highlight">46.5% hombres</span> y <span class="highlight">53.5% mujeres</span>. El análisis demográfico revela una estructura etaria en transición, con una base de pirámide poblacional en contracción y un incremento progresivo de la población adulta mayor.</p>
                                
                                <h3>Hallazgos Clave</h3>
                                <ul>
                                    <li>Crecimiento poblacional de <span class="highlight">1.8%</span> respecto al año anterior</li>
                                    <li>Índice de dependencia infantil: <span class="highlight">18.0%</span> (en descenso)</li>
                                    <li>Índice de dependencia senil: <span class="highlight">22.9%</span> (en aumento)</li>
                                    <li>Edad mediana de la población: <span class="highlight">38.2 años</span></li>
                                </ul>
                                
                                <h3>Tendencias Principales</h3>
                                <p>Se observa un envejecimiento progresivo de la población, con incremento sostenido de los grupos mayores de 65 años y reducción de la población infantil. La distribución territorial muestra concentración en los centros urbanos y menor densidad en áreas periféricas.</p>
                            </div>
                            
                            <div class="summary-chart">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjI1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjQwMCIgaGVpZ2h0PSIyNTAiIGZpbGw9IiNmOGZhZmMiLz4KPGNpcmNsZSBjeD0iMjAwIiBjeT0iMTIwIiByPSI5MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTJlOGYwIiBzdHJva2Utd2lkdGg9IjIwIi8+CjxwYXRoIGQ9Ik0yMDAgMzBBOTAgOTAgMCAwIDEgMjg5IDEyMEw5MCA5MFoiIGZpbGw9IiMwMDY5NWMiLz4KPHBhdGggZD0iTTIwMCAzMEE5MCA5MCAwIDAgMCAxMTEgMTIwTDIwMCAxMjBaIiBmaWxsPSIjMWUzYThhIi8+CjxwYXRoIGQ9Ik0yMDAgMjEwQTkwIDkwIDAgMCAwIDI4OSAxMjBMMjAwIDEyMFoiIGZpbGw9IiNmNTllMGIiLz4KPHBhdGggZD0iTTIwMCAyMTBBOTAgOTAgMCAwIDEgMTExIDEyMEwyMDAgMTIwWiIgZmlsbD0iI2RjMjYyNiIvPgo8Y2lyY2xlIGN4PSIyMDAiIGN5PSIxMjAiIHI9IjQwIiBmaWxsPSJ3aGl0ZSIvPgo8Y2lyY2xlIGN4PSIyMDAiIGN5PSIxMjAiIHI9IjMwIiBmaWxsPSIjZjhmYWZjIi8+Cjwvc3ZnPg==" alt="Resumen Gráfico" class="preview-chart">
                            </div>
                        </div>
                    </div>

                    <!-- Indicadores Clave -->
                    <div class="report-page" data-page="keyIndicators">
                        <div class="page-header">
                            <div class="page-title">Indicadores Clave</div>
                        </div>
                        <div class="page-content indicators-content">
                            <div class="indicators-grid">
                                <div class="indicator-box">
                                    <div class="indicator-title">Población Total</div>
                                    <div class="indicator-value">150,113</div>
                                    <div class="indicator-change positive">+1.8%</div>
                                </div>
                                <div class="indicator-box">
                                    <div class="indicator-title">Proporción Hombres</div>
                                    <div class="indicator-value">46.5%</div>
                                    <div class="indicator-change neutral">0.0%</div>
                                </div>
                                <div class="indicator-box">
                                    <div class="indicator-title">Proporción Mujeres</div>
                                    <div class="indicator-value">53.5%</div>
                                    <div class="indicator-change neutral">0.0%</div>
                                </div>
                                <div class="indicator-box">
                                    <div class="indicator-title">Dep. Infantil</div>
                                    <div class="indicator-value">18.0%</div>
                                    <div class="indicator-change negative">-1.2%</div>
                                </div>
                                <div class="indicator-box">
                                    <div class="indicator-title">Dep. Senil</div>
                                    <div class="indicator-value">22.9%</div>
                                    <div class="indicator-change positive">+2.4%</div>
                                </div>
                                <div class="indicator-box">
                                    <div class="indicator-title">Edad Mediana</div>
                                    <div class="indicator-value">38.2</div>
                                    <div class="indicator-change positive">+0.6</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grupos Etarios -->
                    <div class="report-page" data-page="ageGroups">
                        <div class="page-header">
                            <div class="page-title">Grupos Etarios</div>
                        </div>
                        <div class="page-content age-groups-content">
                            <div class="age-groups-chart">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDUwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjQ1MCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiNmOGZhZmMiLz4KPGxpbmUgeDE9IjUwIiB5MT0iNTAiIHgyPSI1MCIgeTI9IjI1MCIgc3Ryb2tlPSIjZTJlOGYwIiBzdHJva2Utd2lkdGg9IjIiLz4KPGxpbmUgeDE9IjUwIiB5MT0iMjUwIiB4Mj0iNDAwIiB5Mj0iMjUwIiBzdHJva2U9IiNlMmU4ZjAiIHN0cm9rZS13aWR0aD0iMiIvPgo8IS0tIEluZmFudGlsIC0tPgo8cmVjdCB4PSI4MCIgeT0iMTg1IiB3aWR0aD0iNDAiIGhlaWdodD0iNjUiIGZpbGw9IiMwMDY5NWMiIHJ4PSI1IiByeT0iNSIvPgo8IS0tIEFkb2xlc2NlbnRlIC0tPgo8cmVjdCB4PSIxNjAiIHk9IjE2MCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjkwIiAgZmlsbD0iIzFlM2E4YSIgcng9IjUiIHJ5PSI1Ii8+CjwhLS0gQWR1bHRvIC0tPgo8cmVjdCB4PSIyNDAiIHk9IjgwIiB3aWR0aD0iNDAiIGhlaWdodD0iMTcwIiBmaWxsPSIjMGVhNWU5IiByeD0iNSIgcnk9IjUiLz4KPCEtLSBBZHVsdG8gTWF5b3IgLS0+CjxyZWN0IHg9IjMyMCIgeT0iMTcwIiB3aWR0aD0iNDAiIGhlaWdodD0iODAiIGZpbGw9IiNmNTllMGIiIHJ4PSI1IiByeT0iNSIvPgoKPCEtLSBFdGlxdWV0YXMgLS0+Cjx0ZXh0IHg9IjEwMCIgeT0iMjcwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM2NDc0OGIiPkluZmFudGlsPC90ZXh0Pgo8dGV4dCB4PSIxODAiIHk9IjI3MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjQ3NDhiIj5BZG9sZXNjZW50ZTwvdGV4dD4KPHRleHQgeD0iMjYwIiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY0NzQ4YiI+QWR1bHRvPC90ZXh0Pgo8dGV4dCB4PSIzNDAiIHk9IjI3MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjQ3NDhiIj5BZHVsdG8gTWF5b3I8L3RleHQ+Cgo8IS0tIFZhbG9yZXMgLS0+Cjx0ZXh0IHg9IjEwMCIgeT0iMTgwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwZjE3MmEiPjExJTwvdGV4dD4KPHRleHQgeD0iMTgwIiB5PSIxNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzBmMTcyYSI+MTMuNiU8L3RleHQ+Cjx0ZXh0IHg9IjI2MCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzBmMTcyYSI+NjEuMyU8L3RleHQ+Cjx0ZXh0IHg9IjM0MCIgeT0iMTY1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwZjE3MmEiPjE0LjElPC90ZXh0Pgo8L3N2Zz4=" alt="Grupos Etarios" class="preview-chart">
                            </div>
                            <div class="age-groups-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Grupo Etario</th>
                                            <th>Total</th>
                                            <th>Hombres</th>
                                            <th>Mujeres</th>
                                            <th>Porcentaje</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Infantil (0-9)</td>
                                            <td>16,579</td>
                                            <td>8,360</td>
                                            <td>8,219</td>
                                            <td>11.0%</td>
                                        </tr>
                                        <tr>
                                            <td>Adolescente (10-19)</td>
                                            <td>20,368</td>
                                            <td>10,298</td>
                                            <td>10,070</td>
                                            <td>13.6%</td>
                                        </tr>
                                        <tr>
                                            <td>Adulto (20-64)</td>
                                            <td>92,069</td>
                                            <td>41,825</td>
                                            <td>50,244</td>
                                            <td>61.3%</td>
                                        </tr>
                                        <tr>
                                            <td>Adulto Mayor (65+)</td>
                                            <td>21,097</td>
                                            <td>9,246</td>
                                            <td>11,851</td>
                                            <td>14.1%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Distribución por Sexo -->
                    <div class="report-page" data-page="genderDistribution">
                        <div class="page-header">
                            <div class="page-title">Distribución por Sexo</div>
                        </div>
                        <div class="page-content gender-content">
                            <div class="gender-chart">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjQwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiNmOGZhZmMiLz4KPGNpcmNsZSBjeD0iMjAwIiBjeT0iMTQwIiByPSIxMjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2UyZThmMCIgc3Ryb2tlLXdpZHRoPSI0Ii8+CjxwYXRoIGQ9Ik0yMDAgMjBBMTIwIDEyMCAwIDAgMSAyMDAgMjYwTDIwMCAxNDBaIiBmaWxsPSIjMWUzYThhIi8+CjxwYXRoIGQ9Ik0yMDAgMjBBMTIwIDEyMCAwIDAgMCAyMDAgMjYwTDIwMCAxNDBaIiBmaWxsPSIjZWM0ODk5Ii8+Cjx0ZXh0IHg9IjEzNSIgeT0iMTQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+NDYuNSU8L3RleHQ+Cjx0ZXh0IHg9IjI2NSIgeT0iMTQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+NTMuNSU8L3RleHQ+Cjx0ZXh0IHg9IjEzNSIgeT0iMTcwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIj5Ib21icmVzPC90ZXh0Pgo8dGV4dCB4PSIyNjUiIHk9IjE3MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSI+TXVqZXJlczwvdGV4dD4KCjx0ZXh0IHg9IjY1IiB5PSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjMWUzYThhIj42OS43MjkgaG9tYnJlczwvdGV4dD4KPHRleHQgeD0iMzAwIiB5PSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjZWM0ODk5Ij44MC4zODQgbXVqZXJlczwvdGV4dD4KPC9zdmc+" alt="Distribución por Sexo" class="preview-chart">
                            </div>
                            <div class="gender-stats">
                                <div class="gender-stat-box male">
                                    <div class="gender-icon"><i class="fas fa-male"></i></div>
                                    <div class="gender-title">Hombres</div>
                                    <div class="gender-values">
                                        <div class="gender-number">69,729</div>
                                        <div class="gender-percent">46.5%</div>
                                    </div>
                                </div>
                                <div class="gender-stat-box female">
                                    <div class="gender-icon"><i class="fas fa-female"></i></div>
                                    <div class="gender-title">Mujeres</div>
                                    <div class="gender-values">
                                        <div class="gender-number">80,384</div>
                                        <div class="gender-percent">53.5%</div>
                                    </div>
                                </div>
                                <div class="gender-stat-box ratio">
                                    <div class="gender-icon"><i class="fas fa-venus-mars"></i></div>
                                    <div class="gender-title">Razón H:M</div>
                                    <div class="gender-values">
                                        <div class="gender-number">86.7</div>
                                        <div class="gender-percent">Por cada 100 mujeres</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tendencias y Proyecciones -->
                    <div class="report-page" data-page="trends">
                        <div class="page-header">
                            <div class="page-title">Tendencias y Proyecciones</div>
                        </div>
                        <div class="page-content trends-content">
                            <div class="trends-chart">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjUwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiNmOGZhZmMiLz4KPCEtLSBFamVzIC0tPgo8bGluZSB4MT0iNTAiIHkxPSIyNTAiIHgyPSI0NTAiIHkyPSIyNTAiIHN0cm9rZT0iI2UyZThmMCIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxsaW5lIHgxPSI1MCIgeTE9IjUwIiB4Mj0iNTAiIHkyPSIyNTAiIHN0cm9rZT0iI2UyZThmMCIgc3Ryb2tlLXdpZHRoPSIyIi8+Cgo8IS0tIEdyw6FmaWNvIGRlIGzDrW5lYSAtLT4KPHBhdGggZD0iTTEwMCAyMDAgTDE3NSAxODAgTDI1MCAxNzAgTDMyNSAxNjAgTDQwMCAxNTUiIHN0cm9rZT0iIzFlM2E4YSIgc3Ryb2tlLXdpZHRoPSIzIiBmaWxsPSJub25lIi8+Cgo8IS0tIFB1bnRvcyAtLT4KPGNpcmNsZSBjeD0iMTAwIiBjeT0iMjAwIiByPSI1IiBmaWxsPSIjMWUzYThhIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPGNpcmNsZSBjeD0iMTc1IiBjeT0iMTgwIiByPSI1IiBmaWxsPSIjMWUzYThhIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPGNpcmNsZSBjeD0iMjUwIiBjeT0iMTcwIiByPSI1IiBmaWxsPSIjMWUzYThhIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPGNpcmNsZSBjeD0iMzI1IiBjeT0iMTYwIiByPSI1IiBmaWxsPSIjMWUzYThhIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPGNpcmNsZSBjeD0iNDAwIiBjeT0iMTU1IiByPSI1IiBmaWxsPSIjMWUzYThhIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KCjwhLS0gTMOtbmVhIGRlIHByb3llY2Npw7NuIC0tPgo8cGF0aCBkPSJNNDAwIDE1NSBMNDI1IDE1MCBMNDUwIDE0NSIgc3Ryb2tlPSIjZGM2MjQzIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1kYXNoYXJyYXk9IjUsNSIgZmlsbD0ibm9uZSIvPgo8Y2lyY2xlIGN4PSI0MjUiIGN5PSIxNTAiIHI9IjUiIGZpbGw9IiNkYzYyNDMiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgo8Y2lyY2xlIGN4PSI0NTAiIGN5PSIxNDUiIHI9IjUiIGZpbGw9IiNkYzYyNDMiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgoKPCEtLSBFdGlxdWV0YXMgWCAtLT4KPHRleHQgeD0iMTAwIiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY0NzQ4YiI+MjAyMDwvdGV4dD4KPHRleHQgeD0iMTc1IiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY0NzQ4YiI+MjAyMTwvdGV4dD4KPHRleHQgeD0iMjUwIiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY0NzQ4YiI+MjAyMjwvdGV4dD4KPHRleHQgeD0iMzI1IiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY0NzQ4YiI+MjAyMzwvdGV4dD4KPHRleHQgeD0iNDAwIiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY0NzQ4YiI+MjAyNDwvdGV4dD4KPHRleHQgeD0iNDI1IiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY0NzQ4YiI+MjAyNTwvdGV4dD4KPHRleHQgeD0iNDUwIiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY0NzQ4YiI+MjAyNjwvdGV4dD4KCjwhLS0gRXRpcXVldGFzIFkgLS0+Cjx0ZXh0IHg9IjQwIiB5PSIyNTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCIgdGV4dC1hbmNob3I9ImVuZCIgZmlsbD0iIzY0NzQ4YiI+MTQzLDgwMDwvdGV4dD4KPHRleHQgeD0iNDAiIHk9IjIwMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiB0ZXh0LWFuY2hvcj0iZW5kIiBmaWxsPSIjNjQ3NDhiIj4xNDYsMDAwPC90ZXh0Pgo8dGV4dCB4PSI0MCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIHRleHQtYW5jaG9yPSJlbmQiIGZpbGw9IiM2NDc0OGIiPjE1MCwwMDA8L3RleHQ+Cjx0ZXh0IHg9IjQwIiB5PSIxMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCIgdGV4dC1hbmNob3I9ImVuZCIgZmlsbD0iIzY0NzQ4YiI+MTU0LDAwMDwvdGV4dD4KPHRleHQgeD0iNDAiIHk9IjUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIHRleHQtYW5jaG9yPSJlbmQiIGZpbGw9IiM2NDc0OGIiPjE1OCwwMDA8L3RleHQ+Cgo8IS0tIExleWVuZGEgLS0+Cjx0ZXh0IHg9IjE1MCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzY0NzQ4YiI+UG9ibGFjacOzbiBSZWFsPC90ZXh0Pgo8cmVjdCB4PSIxMzAiIHk9IjIwIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiIGZpbGw9IiMxZTNhOGEiLz4KCjx0ZXh0IHg9IjI3MCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzY0NzQ4YiI+UHJveWVjY2nDs248L3RleHQ+CjxyZWN0IHg9IjI1MCIgeT0iMjAiIHdpZHRoPSIxNSIgaGVpZ2h0PSIxNSIgZmlsbD0iI2RjNjI0MyIvPgo8L3N2Zz4=" alt="Tendencias y Proyecciones" class="preview-chart">
                            </div>
                            <div class="trends-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Año</th>
                                            <th>Población</th>
                                            <th>Crecimiento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>2020</td>
                                            <td>139,365</td>
                                            <td>-1.2%</td>
                                        </tr>
                                        <tr>
                                            <td>2021</td>
                                            <td>138,872</td>
                                            <td>1.3%</td>
                                        </tr>
                                        <tr>
                                            <td>2022</td>
                                            <td>140,300</td>
                                            <td>1.1%</td>
                                        </tr>
                                        <tr>
                                            <td>2023</td>
                                            <td>145,902</td>
                                            <td>1.2%</td>
                                        </tr>
                                        <tr>
                                            <td>2024</td>
                                            <td>150,113</td>
                                            <td>0.8%</td>
                                        </tr>
                                        <tr class="projection-row">
                                            <td>2025</td>
                                            <td>151,500</td>
                                            <td>0.9%</td>
                                        </tr>
                                        <tr class="projection-row">
                                            <td>2026</td>
                                            <td>152,800</td>
                                            <td>0.9%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Paginación -->
                    <div class="report-pagination">
                        <div class="pagination-info">Página <span id="currentPage">1</span> de <span id="totalPages">6</span></div>
                        <div class="pagination-controls">
                            <button class="pagination-button" id="prevPageBtn" disabled><i class="fas fa-chevron-left"></i></button>
                            <div class="page-dots" id="pageDots">
                                <span class="page-dot active" data-page="1"></span>
                                <span class="page-dot" data-page="2"></span>
                                <span class="page-dot" data-page="3"></span>
                                <span class="page-dot" data-page="4"></span>
                                <span class="page-dot" data-page="5"></span>
                                <span class="page-dot" data-page="6"></span>
                            </div>
                            <button class="pagination-button" id="nextPageBtn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="export-info">
                <div class="report-metadata">
                    <div class="metadata-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Fecha: 30/05/2025</span>
                    </div>
                    <div class="metadata-item">
                        <i class="fas fa-file-alt"></i>
                        <span id="reportPagesCount">6 páginas</span>
                    </div>
                    <div class="metadata-item">
                        <i class="fas fa-chart-pie"></i>
                        <span id="reportChartsCount">5 gráficos</span>
                    </div>
                </div>
                <div class="export-options">
                    <input type="text" id="reportTitle" placeholder="Título del reporte" value="Análisis Demográfico INFOGES">
                </div>
            </div>
            <div class="export-actions">
                <button class="btn-secondary" id="cancelExportBtn">Cancelar</button>
                <button class="btn-secondary" id="previewExportBtn"><i class="fas fa-eye"></i> Vista Preliminar</button>
                <button class="btn-premium" id="exportReportBtn"><i class="fas fa-file-export"></i> Exportar</button>
            </div>
        </div>
    </div>
</div>



        <!-- CUSTOM GROUP BUILDER -->
        <div class="custom-group-builder" id="customGroupBuilder">
            <h3>Constructor de Grupos Personalizados</h3>
            <p>Define grupos de edad específicos para análisis avanzados según tus necesidades.</p>
            
            <div id="groupDefinitions">
                <div class="group-row">
                    <div class="group-name">
                        <input type="text" placeholder="Nombre del grupo" value="Primera Infancia">
                    </div>
                    <div class="age-range">
                        <input type="number" class="range-input" min="0" max="99" value="0"> 
                        <span>a</span> 
                        <input type="number" class="range-input" min="0" max="99" value="5">
                        <span>años</span>
                    </div>
                    <button class="btn-secondary"><i class="fas fa-times"></i></button>
                </div>
                <div class="group-row">
                    <div class="group-name">
                        <input type="text" placeholder="Nombre del grupo" value="Edad Escolar">
                    </div>
                    <div class="age-range">
                        <input type="number" class="range-input" min="0" max="99" value="6"> 
                        <span>a</span> 
                        <input type="number" class="range-input" min="0" max="99" value="12">
                        <span>años</span>
                    </div>
                    <button class="btn-secondary"><i class="fas fa-times"></i></button>
                </div>
            </div>
            
            <div style="margin-top: 24px; display: flex; gap: 16px; justify-content: center;">
                <button class="btn-secondary" id="addGroupBtn">
                    <i class="fas fa-plus"></i> Añadir Grupo
                </button>
                <button class="btn-premium" id="applyCustomGroupsBtn">
                    <i class="fas fa-check"></i> Aplicar Grupos
                </button>
                <button class="btn-secondary" id="cancelCustomGroupsBtn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>

        <!-- KEY INDICATORS -->
        <div class="key-indicators">
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="indicator-value" id="poblacionTotal">150,113</div>
                <div class="indicator-label">Población Total</div>
                <div class="indicator-trend trend-up">
                    <i class="fas fa-arrow-up"></i> 1.8% vs año anterior
                </div>
            </div>
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-male"></i>
                </div>
                <div class="indicator-value" id="propHombres">46.5%</div>
                <div class="indicator-label">Proporción Hombres</div>
                <div class="indicator-trend">
                    <i class="fas fa-equals"></i> Sin cambios
                </div>
            </div>
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-female"></i>
                </div>
                <div class="indicator-value" id="propMujeres">53.5%</div>
                <div class="indicator-label">Proporción Mujeres</div>
                <div class="indicator-trend">
                    <i class="fas fa-equals"></i> Sin cambios
                </div>
            </div>
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-baby"></i>
                </div>
                <div class="indicator-value" id="indiceDepInfantil">18.0%</div>
                <div class="indicator-label">Dependencia Infantil</div>
                <div class="indicator-trend trend-down">
                    <i class="fas fa-arrow-down"></i> 1.2% vs anterior
                </div>
            </div>
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-user-clock"></i>
                </div>
                <div class="indicator-value" id="indiceDepSenil">22.9%</div>
                <div class="indicator-label">Dependencia Senil</div>
                <div class="indicator-trend trend-up">
                    <i class="fas fa-arrow-up"></i> 2.4% vs anterior
                </div>
            </div>
        </div>

        <div class="dashboard">
            <!-- Population Distribution by Center -->
            <div class="dashboard-card medium-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-hospital"></i>
                        Distribución por Centro de Salud
                    </h3>
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-chart="doughnut">Circular</button>
                        <button class="chart-tab" data-chart="bar">Barras</button>
                        <button class="chart-tab" data-chart="pie">Torta</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container medium">
                        <canvas id="centrosSaludChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sex Distribution -->
            <div class="dashboard-card medium-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-venus-mars"></i>
                        Distribución por Sexo
                    </h3>
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-chart="pie">Torta</button>
                        <button class="chart-tab" data-chart="doughnut">Circular</button>
                        <button class="chart-tab" data-chart="bar">Barras</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="sexDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Age Groups by Sex -->
            <div class="dashboard-card medium-card premium-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-layer-group"></i>
                        Grupos Etarios por Sexo
                    </h3>
             
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-chart="bar">Barras</button>
                        <button class="chart-tab" data-chart="doughnut">Circular</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="ageGroupsBySexChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Age Groups Distribution -->
            <div class="dashboard-card medium-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-users"></i>
                        Distribución por Grupos Etarios
                    </h3>
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-chart="doughnut">Circular</button>
                        <button class="chart-tab" data-chart="pie">Torta</button>
                        <button class="chart-tab" data-chart="bar">Barras</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="ageGroupDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Population Pyramid -->
            <div class="dashboard-card large-card premium-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        Pirámide Poblacional Interactiva
                    </h3>
                 
                    <div>
                        <select id="piramideAgeGrouping" class="premium-select" style="width: auto;">
                            <option value="5">Grupos de 5 años</option>
                            <option value="10">Grupos de 10 años</option>
                            <option value="1">Detalle anual</option>
                        </select>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container large">
                        <canvas id="populationPyramidChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Population Trend -->
            <div class="dashboard-card medium-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Tendencia Poblacional (2020-2024)
                    </h3>
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-chart="line">Línea</button>
                        <button class="chart-tab" data-chart="bar">Barras</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="populationTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Age Distribution Heatmap -->
            <div class="dashboard-card medium-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-th"></i>
                        Densidad Poblacional por Edad
                    </h3>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="ageHeatmapChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Data Table -->
            <div class="dashboard-card large-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-table"></i>
                        Datos Detallados y Análisis
                    </h3>
                    <div class="tabs" id="dataTabs">
                        <button class="tab active" data-tab="resumen">Resumen Ejecutivo</button>
                        <button class="tab" data-tab="grupos-etarios">Grupos Etarios</button>
                        <button class="tab" data-tab="otros-grupos">Grupos Programáticos</button>
                        <button class="tab" data-tab="indicadores">Indicadores Demográficos</button>
                        <button class="tab" data-tab="tendencias">Análisis de Tendencias</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="data-table" id="dataTable">
                            <!-- Table will be populated dynamically -->
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare View -->
        <div class="compare-view" id="compareView">
            <div class="compare-header">
                <h2 class="compare-title">Análisis Comparativo de Centros de Salud</h2>
                <div style="display: flex; gap: 16px; align-items: center;">
                    <select class="premium-select" id="compareMetric" style="width: auto;">
                        <option value="poblacion-total">Población Total</option>
                        <option value="distribucion-sexo">Distribución por Sexo</option>
                        <option value="grupos-etarios">Grupos Etarios</option>
                        <option value="indicadores">Indicadores Demográficos</option>
                        <option value="tendencias">Tendencias Temporales</option>
                    </select>
                    <button class="btn-premium" id="closeCompareBtn">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
            <div class="compare-grid" id="compareGrid">
                <!-- Compare cards will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- PREMIUM VOICE COMMAND -->
    <div class="voice-command" id="voiceCommandBtn" title="Comandos de voz inteligentes">
        <i class="fas fa-microphone"></i>
    </div>
    <div class="voice-status" id="voiceStatus">
        <div id="voiceStatusText">Presiona para activar comandos de voz inteligentes</div>
    </div>

    <script>
        // Enhanced data object with more details
        const poblacionData = {
            centros: {
                "COMUNAL": {
                    nombre: "COMUNA CURICÓ (Total)",
                    poblacionTotal: 150113,
                    codigo: "07701",
                    superficie: "1328.4", // km²
                    densidad: "113.0", // hab/km²
                    sexo: {
                        masculino: 69729,
                        femenino: 80384
                    },
                    gruposEtarios: {
                        infantil: {
                            total: 16579,
                            masculino: 8360,
                            femenino: 8219,
                            porcentaje: 11.0
                        },
                        adolescente: {
                            total: 20368,
                            masculino: 10298,
                            femenino: 10070,
                            porcentaje: 13.6
                        },
                        adulto: {
                            total: 92069,
                            masculino: 41825,
                            femenino: 50244,
                            porcentaje: 61.3
                        },
                        adultoMayor: {
                            total: 21097,
                            masculino: 9246,
                            femenino: 11851,
                            porcentaje: 14.1
                        }
                    },
                    grupos: {
                        "0-9a": { masculino: 8360, femenino: 8219, total: 16579 },
                        "10-19a": { masculino: 10298, femenino: 10070, total: 20368 },
                        "20-64a": { masculino: 41825, femenino: 50244, total: 92069 },
                        "≥65a": { masculino: 9246, femenino: 11851, total: 21097 }
                    },
                    otrosGrupos: {
                        "0-4a": { masculino: 3504, femenino: 3524, total: 7028 },
                        "5-9a": { masculino: 4856, femenino: 4695, total: 9551 },
                        "10-14a": { masculino: 5262, femenino: 5150, total: 10412 },
                        "15-19a": { masculino: 5036, femenino: 4920, total: 9956 },
                        "20-24a": { masculino: 4696, femenino: 4923, total: 9619 },
                        "25-29a": { masculino: 5041, femenino: 5790, total: 10831 },
                        "30-34a": { masculino: 5472, femenino: 6834, total: 12306 },
                        "35a39": { masculino: 4969, femenino: 6495, total: 11464 },
                        "40a44": { masculino: 4360, femenino: 5662, total: 10022 },
                        "45a49": { masculino: 4355, femenino: 5205, total: 9560 },
                        "50a54": { masculino: 4219, femenino: 5061, total: 9280 },
                        "55a59": { masculino: 4471, femenino: 5335, total: 9806 },
                        "60a64": { masculino: 4242, femenino: 4939, total: 9181 },
                        "65-69a": { masculino: 3307, femenino: 3907, total: 7214 },
                        "70-74a": { masculino: 2465, femenino: 3011, total: 5476 },
                        "75-79a": { masculino: 1669, femenino: 2206, total: 3875 },
                        "≥80a": { masculino: 1805, femenino: 2727, total: 4532 }
                    },
                    indicadores: {
                        indiceDepInfantil: 18.0,
                        indiceDepSenil: 22.9,
                        razónSexos: 86.7,
                        edadMediana: 38.2,
                        proporciónAdultosMayores: 14.1,
                        crecimientoAnual: 1.8,
                        densidadPoblacional: 113.0,
                        razónDependencia: 40.9
                    },
                    tendencia: [
                        { año: 2020, poblacion: 139365, crecimiento: 1.2 },
                        { año: 2021, poblacion: 138872, crecimiento: -0.35 },
                        { año: 2022, poblacion: 140300, crecimiento: 1.03 },
                        { año: 2023, poblacion: 145902, crecimiento: 3.99 },
                        { año: 2024, poblacion: 150113, crecimiento: 2.89 }
                    ],
                    proyecciones: [
                        { año: 2025, poblacion: 151500 },
                        { año: 2026, poblacion: 152800 },
                        { año: 2027, poblacion: 154100 },
                        { año: 2028, poblacion: 155300 },
                        { año: 2029, poblacion: 156500 },
                        { año: 2030, poblacion: 157600 }
                    ]
                },
                "CENTRAL": {
                    nombre: "Centro de Salud Familiar Curicó Centro",
                    poblacionTotal: 41532,
                    cobertura: "27.7%",
                    sexo: {
                        masculino: 18111,
                        femenino: 23421
                    },
                    gruposEtarios: {
                        infantil: {
                            total: 3878,
                            masculino: 1922,
                            femenino: 1956,
                            porcentaje: 9.3
                        },
                        adolescente: {
                            total: 5444,
                            masculino: 2708,
                            femenino: 2736,
                            porcentaje: 13.1
                        },
                        adulto: {
                            total: 25601,
                            masculino: 10883,
                            femenino: 14718,
                            porcentaje: 61.7
                        },
                        adultoMayor: {
                            total: 6609,
                            masculino: 2598,
                            femenino: 4011,
                            porcentaje: 15.9
                        }
                    },
                    grupos: {
                        "0-9a": { masculino: 1922, femenino: 1956, total: 3878 },
                        "10-19a": { masculino: 2708, femenino: 2736, total: 5444 },
                        "20-64a": { masculino: 10883, femenino: 14718, total: 25601 },
                        "≥65a": { masculino: 2598, femenino: 4011, total: 6609 }
                    },
                    indicadores: {
                        indiceDepInfantil: 15.1,
                        indiceDepSenil: 25.8,
                        razónSexos: 77.3,
                        edadMediana: 42.1,
                        proporciónAdultosMayores: 15.9,
                        crecimientoAnual: 1.1,
                        razónDependencia: 40.9
                    },
                    tendencia: [
                        { año: 2020, poblacion: 39100, crecimiento: 0.8 },
                        { año: 2021, poblacion: 39800, crecimiento: 1.8 },
                        { año: 2022, poblacion: 40500, crecimiento: 1.8 },
                        { año: 2023, poblacion: 41100, crecimiento: 1.5 },
                        { año: 2024, poblacion: 41532, crecimiento: 1.1 }
                    ]
                },
                "MAAL": {
                    nombre: "Centro de Salud Familiar Miguel Ángel Arenas López",
                    poblacionTotal: 28763,
                    cobertura: "19.2%",
                    sexo: {
                        masculino: 14094,
                        femenino: 14669
                    },
                    gruposEtarios: {
                        infantil: {
                            total: 3199,
                            masculino: 1638,
                            femenino: 1561,
                            porcentaje: 11.1
                        },
                        adolescente: {
                            total: 3687,
                            masculino: 1896,
                            femenino: 1791,
                            porcentaje: 12.8
                        },
                        adulto: {
                            total: 18218,
                            masculino: 8935,
                            femenino: 9283,
                            porcentaje: 63.3
                        },
                        adultoMayor: {
                            total: 3659,
                            masculino: 1625,
                            femenino: 2034,
                            porcentaje: 12.7
                        }
                    },
                    grupos: {
                        "0-9a": { masculino: 1638, femenino: 1561, total: 3199 },
                        "10-19a": { masculino: 1896, femenino: 1791, total: 3687 },
                        "20-64a": { masculino: 8935, femenino: 9283, total: 18218 },
                        "≥65a": { masculino: 1625, femenino: 2034, total: 3659 }
                    },
                    indicadores: {
                        indiceDepInfantil: 17.6,
                        indiceDepSenil: 20.1,
                        razónSexos: 96.1,
                        edadMediana: 36.8,
                        proporciónAdultosMayores: 12.7,
                        crecimientoAnual: 0.9,
                        razónDependencia: 37.7
                    },
                    tendencia: [
                        { año: 2020, poblacion: 27500, crecimiento: 1.5 },
                        { año: 2021, poblacion: 27900, crecimiento: 1.5 },
                        { año: 2022, poblacion: 28200, crecimiento: 1.1 },
                        { año: 2023, poblacion: 28500, crecimiento: 1.1 },
                        { año: 2024, poblacion: 28763, crecimiento: 0.9 }
                    ]
                },
                "BMA": {
                    nombre: "Centro De Salud Familiar A.S. Betty Muñoz Arce",
                    poblacionTotal: 28461,
                    cobertura: "19.0%",
                    sexo: {
                        masculino: 12604,
                        femenino: 15857
                    },
                    gruposEtarios: {
                        infantil: {
                            total: 3782,
                            masculino: 1922,
                            femenino: 1860,
                            porcentaje: 13.3
                        },
                        adolescente: {
                            total: 4039,
                            masculino: 1985,
                            femenino: 2054,
                            porcentaje: 14.2
                        },
                        adulto: {
                            total: 16868,
                            masculino: 7094,
                            femenino: 9774,
                            porcentaje: 59.3
                        },
                        adultoMayor: {
                            total: 3772,
                            masculino: 1603,
                            femenino: 2169,
                            porcentaje: 13.3
                        }
                    },
                    grupos: {
                        "0-9a": { masculino: 1922, femenino: 1860, total: 3782 },
                        "10-19a": { masculino: 1985, femenino: 2054, total: 4039 },
                        "20-64a": { masculino: 7094, femenino: 9774, total: 16868 },
                        "≥65a": { masculino: 1603, femenino: 2169, total: 3772 }
                    },
                    indicadores: {
                        indiceDepInfantil: 22.4,
                        indiceDepSenil: 22.4,
                        razónSexos: 79.5,
                        edadMediana: 35.3,
                        proporciónAdultosMayores: 13.3,
                        crecimientoAnual: 0.9,
                        razónDependencia: 44.8
                    },
                    tendencia: [
                        { año: 2020, poblacion: 27000, crecimiento: 1.5 },
                        { año: 2021, poblacion: 27400, crecimiento: 1.5 },
                        { año: 2022, poblacion: 27800, crecimiento: 1.5 },
                        { año: 2023, poblacion: 28200, crecimiento: 1.4 },
                        { año: 2024, poblacion: 28461, crecimiento: 0.9 }
                    ]
                },
                "COLON": {
                    nombre: "Centro de Salud Familiar Colón",
                    poblacionTotal: 23785,
                    cobertura: "15.8%",
                    sexo: {
                        masculino: 11115,
                        femenino: 12670
                    },
                    gruposEtarios: {
                        infantil: {
                            total: 2858,
                            masculino: 1436,
                            femenino: 1422,
                            porcentaje: 12.0
                        },
                        adolescente: {
                            total: 3281,
                            masculino: 1698,
                            femenino: 1583,
                            porcentaje: 13.8
                        },
                        adulto: {
                            total: 14315,
                            masculino: 6471,
                            femenino: 7844,
                            porcentaje: 60.2
                        },
                        adultoMayor: {
                            total: 3331,
                            masculino: 1510,
                            femenino: 1821,
                            porcentaje: 14.0
                        }
                    },
                    grupos: {
                        "0-9a": { masculino: 1436, femenino: 1422, total: 2858 },
                        "10-19a": { masculino: 1698, femenino: 1583, total: 3281 },
                        "20-64a": { masculino: 6471, femenino: 7844, total: 14315 },
                        "≥65a": { masculino: 1510, femenino: 1821, total: 3331 }
                    },
                    indicadores: {
                        indiceDepInfantil: 20.0,
                        indiceDepSenil: 23.3,
                        razónSexos: 87.7,
                        edadMediana: 37.2,
                        proporciónAdultosMayores: 14.0,
                        crecimientoAnual: 1.2,
                        razónDependencia: 43.3
                    },
                    tendencia: [
                        { año: 2020, poblacion: 22600, crecimiento: 1.3 },
                        { año: 2021, poblacion: 22900, crecimiento: 1.3 },
                        { año: 2022, poblacion: 23200, crecimiento: 1.3 },
                        { año: 2023, poblacion: 23500, crecimiento: 1.3 },
                        { año: 2024, poblacion: 23785, crecimiento: 1.2 }
                    ]
                },
                "SARMIENTO": {
                    nombre: "Centro de Salud Familiar Sarmiento",
                    poblacionTotal: 13722,
                    cobertura: "9.1%",
                    sexo: {
                        masculino: 6792,
                        femenino: 6930
                    },
                    gruposEtarios: {
                        infantil: {
                            total: 1469,
                            masculino: 733,
                            femenino: 736,
                            porcentaje: 10.7
                        },
                        adolescente: {
                            total: 2078,
                            masculino: 1067,
                            femenino: 1011,
                            porcentaje: 15.1
                        },
                        adulto: {
                            total: 8583,
                            masculino: 4193,
                            femenino: 4390,
                            porcentaje: 62.6
                        },
                        adultoMayor: {
                            total: 1592,
                            masculino: 799,
                            femenino: 793,
                            porcentaje: 11.6
                        }
                    },
                    grupos: {
                        "0-9a": { masculino: 733, femenino: 736, total: 1469 },
                        "10-19a": { masculino: 1067, femenino: 1011, total: 2078 },
                        "20-64a": { masculino: 4193, femenino: 4390, total: 8583 },
                        "≥65a": { masculino: 799, femenino: 793, total: 1592 }
                    },
                    indicadores: {
                        indiceDepInfantil: 17.1,
                        indiceDepSenil: 18.5,
                        razónSexos: 98.0,
                        edadMediana: 36.0,
                        proporciónAdultosMayores: 11.6,
                        crecimientoAnual: 1.6,
                        razónDependencia: 35.6
                    },
                    tendencia: [
                        { año: 2020, poblacion: 13100, crecimiento: 1.5 },
                        { año: 2021, poblacion: 13300, crecimiento: 1.5 },
                        { año: 2022, poblacion: 13450, crecimiento: 1.1 },
                        { año: 2023, poblacion: 13600, crecimiento: 1.1 },
                        { año: 2024, poblacion: 13722, crecimiento: 0.9 }
                    ]
                },
                "LOS_NICHES": {
                    nombre: "Centro de Salud Familiar Los Niches",
                    poblacionTotal: 13850,
                    cobertura: "9.2%",
                    sexo: {
                        masculino: 7013,
                        femenino: 6837
                    },
                    gruposEtarios: {
                        infantil: {
                            total: 1393,
                            masculino: 709,
                            femenino: 684,
                            porcentaje: 10.1
                        },
                        adolescente: {
                            total: 1839,
                            masculino: 944,
                            femenino: 895,
                            porcentaje: 13.3
                        },
                        adulto: {
                            total: 8484,
                            masculino: 4249,
                            femenino: 4235,
                            porcentaje: 61.3
                        },
                        adultoMayor: {
                            total: 2134,
                            masculino: 1111,
                            femenino: 1023,
                            porcentaje: 15.4
                        }
                    },
                    grupos: {
                        "0-9a": { masculino: 709, femenino: 684, total: 1393 },
                        "10-19a": { masculino: 944, femenino: 895, total: 1839 },
                        "20-64a": { masculino: 4249, femenino: 4235, total: 8484 },
                        "≥65a": { masculino: 1111, femenino: 1023, total: 2134 }
                    },
                    indicadores: {
                        indiceDepInfantil: 16.4,
                        indiceDepSenil: 25.2,
                        razónSexos: 102.6,
                        edadMediana: 39.5,
                        proporciónAdultosMayores: 15.4,
                        crecimientoAnual: 1.1,
                        razónDependencia: 41.6
                    },
                    tendencia: [
                        { año: 2020, poblacion: 13200, crecimiento: 1.5 },
                        { año: 2021, poblacion: 13400, crecimiento: 1.5 },
                        { año: 2022, poblacion: 13550, crecimiento: 1.1 },
                        { año: 2023, poblacion: 13700, crecimiento: 1.1 },
                        { año: 2024, poblacion: 13850, crecimiento: 1.1 }
                    ]
                }
            }
        };

        // Enhanced chart colors with premium palette
        const chartColors = {
            primary: '#00695c',
            primaryLight: '#48a999',
            primaryDark: '#003d33',
            secondary: '#1e3a8a',
            secondaryLight: '#3b82f6',
            secondaryDark: '#1e1b4b',
            accent: '#f59e0b',
            accentLight: '#fbbf24',
            accentDark: '#b45309',
            success: '#059669',
            warning: '#d97706',
            danger: '#dc2626',
            info: '#0ea5e9',
            maleColor: '#1e3a8a',
            femaleColor: '#ec4899',
            gradient1: ['#00695c', '#1e3a8a'],
            gradient2: ['#f59e0b', '#dc2626'],
            gradient3: ['#059669', '#0ea5e9'],
            palette: [
                '#00695c', '#1e3a8a', '#f59e0b', '#dc2626', 
                '#059669', '#0ea5e9', '#7c3aed', '#db2777'
            ]
        };

        // Enhanced Chart.js configuration
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.resizeDelay = 200;
        Chart.defaults.color = '#0f172a';
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.plugins.tooltip.backgroundColor = "rgba(255, 255, 255, 0.98)";
        Chart.defaults.plugins.tooltip.titleColor = '#0f172a';
        Chart.defaults.plugins.tooltip.bodyColor = '#0f172a';
        Chart.defaults.plugins.tooltip.borderColor = '#e2e8f0';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.padding = 12;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.plugins.tooltip.titleFont = { weight: 700 };
        Chart.defaults.plugins.tooltip.bodyFont = { weight: 500 };

        // Utility Functions
        function formatNumber(number) {
            return new Intl.NumberFormat('es-CL').format(number);
        }

        function getPercentage(part, total) {
            return ((part / total) * 100).toFixed(1);
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 120px;
                right: 32px;
                background: ${type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#0ea5e9'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 12px 24px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                max-width: 400px;
                animation: slideInRight 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Enhanced chart creation functions
        function createCentrosSaludChart(chartType = 'doughnut') {
            const ctx = document.getElementById('centrosSaludChart');
            if (!ctx) return null;
            
            const centros = Object.values(poblacionData.centros)
                .filter(centro => centro.nombre !== "COMUNA CURICÓ (Total)");
            
            const data = centros.map(centro => centro.poblacionTotal);
            const labels = centros.map(centro => {
                const match = centro.nombre.match(/CESFAM\s+(.+)/) || centro.nombre.match(/Familiar\s+(.+)/);
                return match ? match[1].trim() : centro.nombre.split(' ').slice(-2).join(' ');
            });
            
            const backgroundColors = chartColors.palette.slice(0, data.length);
            
            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Población',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 15,
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: chartType === 'doughnut' ? 'right' : 'top',
                            labels: {
                                font: { size: 11, weight: 600 },
                                boxWidth: 15,
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const percentage = getPercentage(value, poblacionData.centros.COMUNAL.poblacionTotal);
                                    return `${label}: ${formatNumber(value)} (${percentage}%)`;
                                },
                                afterLabel: function(context) {
                                    const centro = centros[context.dataIndex];
                                    return `Cobertura: ${centro.cobertura || 'N/A'}`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    },
                    scales: chartType === 'bar' ? {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Población', font: { weight: 700 } },
                            ticks: { font: { size: 10, weight: 600 } },
                            grid: { color: '#f1f5f9' }
                        },
                        y: {
                            title: { display: true, text: 'Centro de Salud', font: { weight: 700 } },
                            ticks: {
                                font: { size: 10, weight: 600 },
                                callback: function(value) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 20 ? label.slice(0, 17) + '...' : label;
                                }
                            },
                            grid: { color: '#f1f5f9' }
                        }
                    } : {}
                }
            };
            
            if (chartType === 'doughnut') {
                chartConfig.options.cutout = '60%';
            }
            
            return new Chart(ctx.getContext('2d'), chartConfig);
        }

        function createSexDistributionChart(centroId, chartType = 'pie') {
            const ctx = document.getElementById('sexDistributionChart');
            if (!ctx) return null;
            
            const centro = poblacionData.centros[centroId];
            
            const chartConfig = {
                type: chartType,
                data: {
                    labels: ['Hombres', 'Mujeres'],
                    datasets: [{
                        label: 'Población',
                        data: [centro.sexo.masculino, centro.sexo.femenino],
                        backgroundColor: [chartColors.maleColor, chartColors.femaleColor],
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 15,
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 12, weight: 600 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const percentage = getPercentage(value, centro.poblacionTotal);
                                    return `${label}: ${formatNumber(value)} (${percentage}%)`;
                                },
                                afterLabel: function(context) {
                                    const razón = centro.indicadores ? centro.indicadores.razónSexos : 'N/A';
                                    return context.dataIndex === 0 ? `Razón de sexos: ${razón}` : '';
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    },
                    scales: chartType === 'bar' ? {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Población', font: { weight: 700 } },
                            grid: { color: '#f1f5f9' }
                        },
                        y: {
                            title: { display: true, text: 'Sexo', font: { weight: 700 } },
                            grid: { color: '#f1f5f9' }
                        }
                    } : {}
                }
            };
            
            if (chartType === 'bar') {
                chartConfig.options.indexAxis = 'y';
            }
            
            if (chartType === 'doughnut') {
                chartConfig.options.cutout = '60%';
            }
            
            return new Chart(ctx.getContext('2d'), chartConfig);
        }

          // Completar la función createAgeGroupsBySexChart desde donde se cortó
          function createAgeGroupsBySexChart(centroId, chartType = 'bar') {
            const ctx = document.getElementById('ageGroupsBySexChart');
            if (!ctx) return null;
            
            const centro = poblacionData.centros[centroId];
            
            const maleData = [
                centro.gruposEtarios.infantil.masculino,
                centro.gruposEtarios.adolescente.masculino,
                centro.gruposEtarios.adulto.masculino,
                centro.gruposEtarios.adultoMayor.masculino
            ];
            
            const femaleData = [
                centro.gruposEtarios.infantil.femenino,
                centro.gruposEtarios.adolescente.femenino,
                centro.gruposEtarios.adulto.femenino,
                centro.gruposEtarios.adultoMayor.femenino
            ];
            
            const labels = ['Infantil\n(0-9)', 'Adolescente\n(10-19)', 'Adulto\n(20-64)', 'Adulto Mayor\n(65+)'];
            
            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Hombres',
                            data: maleData,
                            backgroundColor: chartColors.maleColor,
                            borderColor: chartColors.maleColor,
                            borderWidth: 2,
                            borderRadius: chartType === 'bar' ? 8 : 0,
                            borderSkipped: false
                        },
                        {
                            label: 'Mujeres',
                            data: femaleData,
                            backgroundColor: chartColors.femaleColor,
                            borderColor: chartColors.femaleColor,
                            borderWidth: 2,
                            borderRadius: chartType === 'bar' ? 8 : 0,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 12, weight: 600 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw;
                                    const total = context.dataset.label === 'Hombres' ? 
                                        centro.sexo.masculino : centro.sexo.femenino;
                                    const percentage = getPercentage(value, total);
                                    const percentageTotal = getPercentage(value, centro.poblacionTotal);
                                    return [
                                        `${label}: ${formatNumber(value)}`,
                                        `${percentage}% del total ${label.toLowerCase()}`,
                                        `${percentageTotal}% de la población total`
                                    ];
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    },
                    scales: chartType === 'bar' ? {
                        x: {
                            title: { 
                                display: true, 
                                text: 'Grupo Etario', 
                                font: { weight: 700, size: 13 } 
                            },
                            ticks: { font: { size: 11, weight: 600 } },
                            grid: { color: '#f1f5f9' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { 
                                display: true, 
                                text: 'Población', 
                                font: { weight: 700, size: 13 } 
                            },
                            ticks: { 
                                font: { size: 11, weight: 600 },
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            },
                            grid: { color: '#f1f5f9' }
                        }
                    } : {}
                }
            };
            
            if (chartType === 'doughnut') {
                // Para gráfico circular, mostrar solo totales por grupo
                const totalData = [
                    centro.gruposEtarios.infantil.total,
                    centro.gruposEtarios.adolescente.total,
                    centro.gruposEtarios.adulto.total,
                    centro.gruposEtarios.adultoMayor.total
                ];
                
                chartConfig.data.datasets = [{
                    label: 'Población por Grupo',
                    data: totalData,
                    backgroundColor: chartColors.palette.slice(0, 4),
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    hoverOffset: 15
                }];
                chartConfig.options.cutout = '60%';
            }
            
            return new Chart(ctx.getContext('2d'), chartConfig);
        }

        function createAgeGroupDistributionChart(centroId, chartType = 'doughnut') {
            const ctx = document.getElementById('ageGroupDistributionChart');
            if (!ctx) return null;
            
            const centro = poblacionData.centros[centroId];
            
            const data = [
                centro.gruposEtarios.infantil.total,
                centro.gruposEtarios.adolescente.total,
                centro.gruposEtarios.adulto.total,
                centro.gruposEtarios.adultoMayor.total
            ];
            
            const labels = ['Infantil (0-9)', 'Adolescente (10-19)', 'Adulto (20-64)', 'Adulto Mayor (65+)'];
            const colors = [chartColors.primary, chartColors.secondary, chartColors.info, chartColors.accent];
            
            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Población',
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 15,
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: chartType === 'doughnut' ? 'right' : 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15,
                                font: { size: 11, weight: 600 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const percentage = getPercentage(value, centro.poblacionTotal);
                                    const grupo = Object.values(centro.gruposEtarios)[context.dataIndex];
                                    return [
                                        `${label}: ${formatNumber(value)} (${percentage}%)`,
                                        `Hombres: ${formatNumber(grupo.masculino)}`,
                                        `Mujeres: ${formatNumber(grupo.femenino)}`
                                    ];
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    }
                }
            };
            
            if (chartType === 'doughnut') {
                chartConfig.options.cutout = '60%';
            } else if (chartType === 'bar') {
                chartConfig.options.scales = {
                    x: {
                        title: { 
                            display: true, 
                            text: 'Grupo Etario', 
                            font: { weight: 700 } 
                        },
                        ticks: { font: { size: 11, weight: 600 } },
                        grid: { color: '#f1f5f9' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: 'Población', 
                            font: { weight: 700 } 
                        },
                        ticks: { 
                            font: { size: 11, weight: 600 },
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        },
                        grid: { color: '#f1f5f9' }
                    }
                };
            }
            
            return new Chart(ctx.getContext('2d'), chartConfig);
        }

        function createPopulationPyramidChart(centroId, grouping = 5) {
            const ctx = document.getElementById('populationPyramidChart');
            if (!ctx) return null;
            
            const centro = poblacionData.centros[centroId];
            
            let labels = [];
            let maleData = [];
            let femaleData = [];
            
            if (grouping === 10) {
                labels = ['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70-79', '80+'];
                
                // Usar datos base y aproximaciones
                maleData = [
                    centro.grupos['0-9a'].masculino,
                    centro.grupos['10-19a'].masculino
                ];
                
                femaleData = [
                    -centro.grupos['0-9a'].femenino,
                    -centro.grupos['10-19a'].femenino
                ];
                
                // Distribuir población adulta
                const adultMale = centro.gruposEtarios.adulto.masculino;
                const adultFemale = centro.gruposEtarios.adulto.femenino;
                const elderlyMale = centro.gruposEtarios.adultoMayor.masculino;
                const elderlyFemale = centro.gruposEtarios.adultoMayor.femenino;
                
                const maleDistribution = [0.23, 0.24, 0.20, 0.21, 0.12];
                const femaleDistribution = [0.21, 0.27, 0.21, 0.21, 0.10];
                
                for (let i = 0; i < 5; i++) {
                    maleData.push(Math.round(adultMale * maleDistribution[i]));
                    femaleData.push(-Math.round(adultFemale * femaleDistribution[i]));
                }
                
                // Grupos de edad avanzada
                maleData.push(Math.round(elderlyMale * 0.36));
                maleData.push(Math.round(elderlyMale * 0.45));
                maleData.push(Math.round(elderlyMale * 0.19));
                
                femaleData.push(-Math.round(elderlyFemale * 0.33));
                femaleData.push(-Math.round(elderlyFemale * 0.44));
                femaleData.push(-Math.round(elderlyFemale * 0.23));
                
            } else if (grouping === 5) {
                labels = ['0-4', '5-9', '10-14', '15-19', '20-24', '25-29', '30-34', '35-39', 
                         '40-44', '45-49', '50-54', '55-59', '60-64', '65-69', '70-74', '75-79', '80+'];
                
                if (centroId === 'COMUNAL' && poblacionData.centros.COMUNAL.otrosGrupos) {
                    const grupos = poblacionData.centros.COMUNAL.otrosGrupos;
                    maleData = [
                        grupos['0-4a'].masculino, grupos['5-9a'].masculino,
                        grupos['10-14a'].masculino, grupos['15-19a'].masculino,
                        grupos['20-24a'].masculino, grupos['25-29a'].masculino,
                        grupos['30-34a'].masculino, grupos['35a39'].masculino,
                        grupos['40a44'].masculino, grupos['45a49'].masculino,
                        grupos['50a54'].masculino, grupos['55a59'].masculino,
                        grupos['60a64'].masculino, grupos['65-69a'].masculino,
                        grupos['70-74a'].masculino, grupos['75-79a'].masculino,
                        grupos['≥80a'].masculino
                    ];
                    
                    femaleData = [
                        -grupos['0-4a'].femenino, -grupos['5-9a'].femenino,
                        -grupos['10-14a'].femenino, -grupos['15-19a'].femenino,
                        -grupos['20-24a'].femenino, -grupos['25-29a'].femenino,
                        -grupos['30-34a'].femenino, -grupos['35a39'].femenino,
                        -grupos['40a44'].femenino, -grupos['45a49'].femenino,
                        -grupos['50a54'].femenino, -grupos['55a59'].femenino,
                        -grupos['60a64'].femenino, -grupos['65-69a'].femenino,
                        -grupos['70-74a'].femenino, -grupos['75-79a'].femenino,
                        -grupos['≥80a'].femenino
                    ];
                } else {
                    // Aproximaciones para otros centros
                    const infantil = centro.gruposEtarios.infantil;
                    const adolescente = centro.gruposEtarios.adolescente;
                    const adulto = centro.gruposEtarios.adulto;
                    const adultoMayor = centro.gruposEtarios.adultoMayor;
                    
                    // Distribución aproximada
                    const infantilDist = [0.45, 0.55]; // 0-4, 5-9
                    const adolDist = [0.50, 0.50]; // 10-14, 15-19
                    const adultDist = [0.11, 0.12, 0.13, 0.12, 0.10, 0.10, 0.10, 0.11, 0.11]; // 20-64
                    const elderDist = [0.36, 0.27, 0.18, 0.19]; // 65+
                    
                    maleData = [
                        Math.round(infantil.masculino * infantilDist[0]),
                        Math.round(infantil.masculino * infantilDist[1]),
                        Math.round(adolescente.masculino * adolDist[0]),
                        Math.round(adolescente.masculino * adolDist[1])
                    ];
                    
                    femaleData = [
                        -Math.round(infantil.femenino * infantilDist[0]),
                        -Math.round(infantil.femenino * infantilDist[1]),
                        -Math.round(adolescente.femenino * adolDist[0]),
                        -Math.round(adolescente.femenino * adolDist[1])
                    ];
                    
                    // Adultos
                    for (let i = 0; i < adultDist.length; i++) {
                        maleData.push(Math.round(adulto.masculino * adultDist[i]));
                        femaleData.push(-Math.round(adulto.femenino * adultDist[i]));
                    }
                    
                    // Adultos mayores
                    for (let i = 0; i < elderDist.length; i++) {
                        maleData.push(Math.round(adultoMayor.masculino * elderDist[i]));
                        femaleData.push(-Math.round(adultoMayor.femenino * elderDist[i]));
                    }
                }
            } else {
                // Detalle anual (simplificado)
                labels = ['0-4', '5-9', '10-14', '15-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70-79', '80+'];
                
                const { infantil, adolescente, adulto, adultoMayor } = centro.gruposEtarios;
                
                maleData = [
                    Math.round(infantil.masculino * 0.45),
                    Math.round(infantil.masculino * 0.55),
                    Math.round(adolescente.masculino * 0.50),
                    Math.round(adolescente.masculino * 0.50),
                    Math.round(adulto.masculino * 0.23),
                    Math.round(adulto.masculino * 0.25),
                    Math.round(adulto.masculino * 0.22),
                    Math.round(adulto.masculino * 0.22),
                    Math.round(adulto.masculino * 0.08 + adultoMayor.masculino * 0.36),
                    Math.round(adultoMayor.masculino * 0.45),
                    Math.round(adultoMayor.masculino * 0.19)
                ];
                
                femaleData = [
                    -Math.round(infantil.femenino * 0.45),
                    -Math.round(infantil.femenino * 0.55),
                    -Math.round(adolescente.femenino * 0.50),
                    -Math.round(adolescente.femenino * 0.50),
                    -Math.round(adulto.femenino * 0.23),
                    -Math.round(adulto.femenino * 0.27),
                    -Math.round(adulto.femenino * 0.22),
                    -Math.round(adulto.femenino * 0.20),
                    -Math.round(adulto.femenino * 0.08 + adultoMayor.femenino * 0.33),
                    -Math.round(adultoMayor.femenino * 0.44),
                    -Math.round(adultoMayor.femenino * 0.23)
                ];
            }
            
            return new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Hombres',
                            data: maleData,
                            backgroundColor: chartColors.maleColor,
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false
                        },
                        {
                            label: 'Mujeres',
                            data: femaleData,
                            backgroundColor: chartColors.femaleColor,
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Población',
                                font: { weight: 700, size: 13 }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(Math.abs(value));
                                },
                                font: { size: 11, weight: 600 }
                            },
                            grid: { color: '#f1f5f9' }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Grupos de Edad',
                                font: { weight: 700, size: 13 }
                            },
                            ticks: { font: { size: 11, weight: 600 } },
                            grid: { color: '#f1f5f9' }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 12, weight: 600 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = Math.abs(context.raw);
                                    const percentage = getPercentage(value, centro.poblacionTotal);
                                    return [
                                        `${label}: ${formatNumber(value)}`,
                                        `${percentage}% de la población total`
                                    ];
                                },
                                title: function(context) {
                                    return `Grupo de edad: ${context[0].label}`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function createPopulationTrendChart(centroId, chartType = 'line') {
            const ctx = document.getElementById('populationTrendChart');
            if (!ctx) return null;
            
            const centro = poblacionData.centros[centroId];
            
            if (!centro.tendencia) {
                return null;
            }
            
            const labels = centro.tendencia.map(item => item.año);
            const data = centro.tendencia.map(item => item.poblacion);
            const crecimiento = centro.tendencia.map(item => item.crecimiento || 0);
            
            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Población',
                        data: data,
                        backgroundColor: chartType === 'line' ? 
                            `${chartColors.secondary}20` : chartColors.secondary,
                        borderColor: chartColors.secondary,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: chartType === 'line',
                        pointBackgroundColor: chartColors.secondary,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        borderRadius: chartType === 'bar' ? 8 : 0,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Población',
                                font: { weight: 700, size: 13 }
                            },
                            ticks: {
                                font: { size: 11, weight: 600 },
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            },
                            grid: { color: '#f1f5f9' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Año',
                                font: { weight: 700, size: 13 }
                            },
                            ticks: { font: { size: 11, weight: 600 } },
                            grid: { color: '#f1f5f9' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const year = context.label;
                                    const population = context.raw;
                                    const growthIndex = context.dataIndex;
                                    const growth = crecimiento[growthIndex];
                                    return [
                                        `Población: ${formatNumber(population)}`,
                                        `Crecimiento: ${growth}%`
                                    ];
                                },
                                title: function(context) {
                                    return `Año ${context[0].label}`;
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 6,
                            hoverRadius: 8
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            };
            
            return new Chart(ctx.getContext('2d'), chartConfig);
        }

        function createAgeHeatmapChart(centroId) {
            const ctx = document.getElementById('ageHeatmapChart');
            if (!ctx) return null;
            
            const centro = poblacionData.centros[centroId];
            const labels = ['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70-79', '80+'];
            
            const adultMale = centro.gruposEtarios.adulto.masculino;
            const adultFemale = centro.gruposEtarios.adulto.femenino;
            const elderlyMale = centro.gruposEtarios.adultoMayor.masculino;
            const elderlyFemale = centro.gruposEtarios.adultoMayor.femenino;
            
            const maleData = [
                centro.gruposEtarios.infantil.masculino,
                centro.gruposEtarios.adolescente.masculino,
                Math.round(adultMale * 0.23),
                Math.round(adultMale * 0.24),
                Math.round(adultMale * 0.20),
                Math.round(adultMale * 0.21),
                Math.round(adultMale * 0.12 + elderlyMale * 0.36),
                Math.round(elderlyMale * 0.45),
                Math.round(elderlyMale * 0.19)
            ];
            
            const femaleData = [
                centro.gruposEtarios.infantil.femenino,
                centro.gruposEtarios.adolescente.femenino,
                Math.round(adultFemale * 0.21),
                Math.round(adultFemale * 0.27),
                Math.round(adultFemale * 0.21),
                Math.round(adultFemale * 0.21),
                Math.round(adultFemale * 0.10 + elderlyFemale * 0.33),
                Math.round(elderlyFemale * 0.44),
                Math.round(elderlyFemale * 0.23)
            ];
            
            const totalPop = centro.poblacionTotal;
            const malePercent = maleData.map(val => (val / totalPop) * 100);
            const femalePercent = femaleData.map(val => (val / totalPop) * 100);
            const maxPercent = Math.max(...malePercent, ...femalePercent);
            
            return new Chart(ctx.getContext('2d'), {
                type: 'scatter',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Hombres',
                            data: maleData.map((value, index) => ({
                                x: index,
                                y: 0,
                                value: value,
                                percent: malePercent[index]
                            })),
                            backgroundColor: function(context) {
                                if (context.raw) {
                                    const value = context.raw.percent;
                                    const alpha = Math.min(1, value / (maxPercent * 0.7));
                                    return `${chartColors.maleColor}${Math.round(alpha * 255).toString(16).padStart(2, '0')}`;
                                }
                                return `${chartColors.maleColor}80`;
                            },
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            pointRadius: function(context) {
                                if (context.raw) {
                                    const value = context.raw.percent;
                                    return Math.max(12, Math.min(35, (value / maxPercent) * 35));
                                }
                                return 18;
                            },
                            pointStyle: 'circle'
                        },
                        {
                            label: 'Mujeres',
                            data: femaleData.map((value, index) => ({
                                x: index,
                                y: 1,
                                value: Math.abs(value),
                                percent: femalePercent[index]
                            })),
                            backgroundColor: function(context) {
                                if (context.raw) {
                                    const value = context.raw.percent;
                                    const alpha = Math.min(1, value / (maxPercent * 0.7));
                                    return `${chartColors.femaleColor}${Math.round(alpha * 255).toString(16).padStart(2, '0')}`;
                                }
                                return `${chartColors.femaleColor}80`;
                            },
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            pointRadius: function(context) {
                                if (context.raw) {
                                    const value = context.raw.percent;
                                    return Math.max(12, Math.min(35, (value / maxPercent) * 35));
                                }
                                return 18;
                            },
                            pointStyle: 'circle'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: 'category',
                            labels: labels,
                            grid: { 
                                display: true,
                                color: '#f1f5f9'
                            },
                            title: {
                                display: true,
                                text: 'Grupos de Edad',
                                font: { weight: 700, size: 13 }
                            },
                            ticks: { font: { size: 11, weight: 600 } }
                        },
                        y: {
                            type: 'category',
                            labels: ['Hombres', 'Mujeres'],
                            offset: true,
                            grid: { 
                                display: true,
                                color: '#f1f5f9'
                            },
                            title: {
                                display: true,
                                text: 'Sexo',
                                font: { weight: 700, size: 13 }
                            },
                            ticks: { font: { size: 11, weight: 600 } }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.raw) {
                                        const value = context.raw.value;
                                        const percent = context.raw.percent.toFixed(1);
                                        return [
                                            `${context.dataset.label}: ${formatNumber(value)}`,
                                            `${percent}% de la población total`,
                                            `Densidad relativa: ${(context.raw.percent / maxPercent * 100).toFixed(1)}%`
                                        ];
                                    }
                                    return '';
                                },
                                title: function(context) {
                                    const ageGroup = labels[context[0].raw.x];
                                    return `Grupo de edad: ${ageGroup}`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // ENHANCED TABLE FUNCTIONS
        function createResumenTable(centroId) {
            const centro = poblacionData.centros[centroId];
            const tableEl = document.getElementById('dataTable');
            
            let html = `
                <thead>
                    <tr>
                        <th style="width: 25%;">Indicador</th>
                        <th style="width: 15%;">Hombres</th>
                        <th style="width: 15%;">Mujeres</th>
                        <th style="width: 15%;">Total</th>
                        <th style="width: 12%;">Porcentaje</th>
                        <th style="width: 18%;">Análisis</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); font-weight: 700;">
                        <td><i class="fas fa-users" style="color: var(--primary); margin-right: 8px;"></i><strong>Población Total</strong></td>
                        <td>${formatNumber(centro.sexo.masculino)}</td>
                        <td>${formatNumber(centro.sexo.femenino)}</td>
                        <td style="font-weight: 800; color: var(--primary);">${formatNumber(centro.poblacionTotal)}</td>
                        <td>100%</td>
                        <td>
                            ${centro.cobertura ? `<span class="badge-primary">Cobertura: ${centro.cobertura}</span>` : ''}
                            ${centro.indicadores ? `<span style="font-size: 0.8rem; color: var(--text-secondary);">Razón: ${centro.indicadores.razónSexos}</span>` : ''}
                        </td>
                    </tr>
                    <tr class="expand-row" data-target="infantil-details">
                        <td style="color: var(--primary);"><i class="fas fa-baby" style="margin-right: 8px;"></i>Infantil (0-9 años)</td>
                        <td>${formatNumber(centro.gruposEtarios.infantil.masculino)}</td>
                        <td>${formatNumber(centro.gruposEtarios.infantil.femenino)}</td>
                        <td style="font-weight: 700;">${formatNumber(centro.gruposEtarios.infantil.total)}</td>
                        <td><span style="background: ${chartColors.primary}20; padding: 2px 8px; border-radius: 12px; font-weight: 600;">${getPercentage(centro.gruposEtarios.infantil.total, centro.poblacionTotal)}%</span></td>
                        <td>
                            <div style="font-size: 0.8rem;">
                                <div>♂ ${getPercentage(centro.gruposEtarios.infantil.masculino, centro.gruposEtarios.infantil.total)}%</div>
                                <div>♀ ${getPercentage(centro.gruposEtarios.infantil.femenino, centro.gruposEtarios.infantil.total)}%</div>
                            </div>
                        </td>
                    </tr>
                    <tr class="detail-row" id="infantil-details">
                        <td colspan="6">
                            <div class="detail-content">
                                <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid ${chartColors.primary};">
                                    <h4 style="color: var(--primary); margin-bottom: 12px;"><i class="fas fa-chart-pie" style="margin-right: 8px;"></i>Análisis Población Infantil</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                        <div>
                                            <strong>Distribución por sexo:</strong><br>
                                            Hombres: ${formatNumber(centro.gruposEtarios.infantil.masculino)} (${getPercentage(centro.gruposEtarios.infantil.masculino, centro.gruposEtarios.infantil.total)}%)<br>
                                            Mujeres: ${formatNumber(centro.gruposEtarios.infantil.femenino)} (${getPercentage(centro.gruposEtarios.infantil.femenino, centro.gruposEtarios.infantil.total)}%)
                                        </div>
                                        <div>
                                            <strong>Impacto poblacional:</strong><br>
                                            ${centro.gruposEtarios.infantil.porcentaje ? `${centro.gruposEtarios.infantil.porcentaje}% de la población` : `${getPercentage(centro.gruposEtarios.infantil.total, centro.poblacionTotal)}% de la población`}<br>
                                            Representa el futuro demográfico del territorio
                                        </div>
                                        <div>
                                            <strong>Consideraciones sanitarias:</strong><br>
                                            Control niño sano, vacunación, desarrollo psicomotor<br>
                                            Programas de estimulación temprana
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr class="expand-row" data-target="adolescente-details">
                        <td style="color: var(--secondary);"><i class="fas fa-user-graduate" style="margin-right: 8px;"></i>Adolescente (10-19 años)</td>
                        <td>${formatNumber(centro.gruposEtarios.adolescente.masculino)}</td>
                        <td>${formatNumber(centro.gruposEtarios.adolescente.femenino)}</td>
                        <td style="font-weight: 700;">${formatNumber(centro.gruposEtarios.adolescente.total)}</td>
                        <td><span style="background: ${chartColors.secondary}20; padding: 2px 8px; border-radius: 12px; font-weight: 600;">${getPercentage(centro.gruposEtarios.adolescente.total, centro.poblacionTotal)}%</span></td>
                        <td>
                            <div style="font-size: 0.8rem;">
                                <div>♂ ${getPercentage(centro.gruposEtarios.adolescente.masculino, centro.gruposEtarios.adolescente.total)}%</div>
                                <div>♀ ${getPercentage(centro.gruposEtarios.adolescente.femenino, centro.gruposEtarios.adolescente.total)}%</div>
                            </div>
                        </td>
                    </tr>
                    <tr class="detail-row" id="adolescente-details">
                        <td colspan="6">
                            <div class="detail-content">
                                <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid ${chartColors.secondary};">
                                    <h4 style="color: var(--secondary); margin-bottom: 12px;"><i class="fas fa-chart-pie" style="margin-right: 8px;"></i>Análisis Población Adolescente</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                        <div>
                                            <strong>Distribución por sexo:</strong><br>
                                            Hombres: ${formatNumber(centro.gruposEtarios.adolescente.masculino)} (${getPercentage(centro.gruposEtarios.adolescente.masculino, centro.gruposEtarios.adolescente.total)}%)<br>
                                            Mujeres: ${formatNumber(centro.gruposEtarios.adolescente.femenino)} (${getPercentage(centro.gruposEtarios.adolescente.femenino, centro.gruposEtarios.adolescente.total)}%)
                                        </div>
                                        <div>
                                            <strong>Características demográficas:</strong><br>
                                            ${centro.gruposEtarios.adolescente.porcentaje ? `${centro.gruposEtarios.adolescente.porcentaje}% de la población` : `${getPercentage(centro.gruposEtarios.adolescente.total, centro.poblacionTotal)}% de la población`}<br>
                                            Grupo en transición a la adultez
                                        </div>
                                        <div>
                                            <strong>Programas específicos:</strong><br>
                                            Salud sexual y reproductiva<br>
                                            Prevención de conductas de riesgo<br>
                                            Espacios amigables para adolescentes
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr class="expand-row" data-target="adulto-details">
                        <td style="color: var(--info);"><i class="fas fa-user-tie" style="margin-right: 8px;"></i>Adulto (20-64 años)</td>
                        <td>${formatNumber(centro.gruposEtarios.adulto.masculino)}</td>
                        <td>${formatNumber(centro.gruposEtarios.adulto.femenino)}</td>
                        <td style="font-weight: 700;">${formatNumber(centro.gruposEtarios.adulto.total)}</td>
                        <td><span style="background: ${chartColors.info}20; padding: 2px 8px; border-radius: 12px; font-weight: 600;">${getPercentage(centro.gruposEtarios.adulto.total, centro.poblacionTotal)}%</span></td>
                        <td>
                            <div style="font-size: 0.8rem;">
                                <div>♂ ${getPercentage(centro.gruposEtarios.adulto.masculino, centro.gruposEtarios.adulto.total)}%</div>
                                <div>♀ ${getPercentage(centro.gruposEtarios.adulto.femenino, centro.gruposEtarios.adulto.total)}%</div>
                            </div>
                        </td>
                    </tr>
                    <tr class="detail-row" id="adulto-details">
                        <td colspan="6">
                            <div class="detail-content">
                                <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid ${chartColors.info};">
                                    <h4 style="color: var(--info); margin-bottom: 12px;"><i class="fas fa-chart-pie" style="margin-right: 8px;"></i>Análisis Población Adulta</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                        <div>
                                            <strong>Fuerza laboral activa:</strong><br>
                                            Hombres: ${formatNumber(centro.gruposEtarios.adulto.masculino)} (${getPercentage(centro.gruposEtarios.adulto.masculino, centro.gruposEtarios.adulto.total)}%)<br>
                                            Mujeres: ${formatNumber(centro.gruposEtarios.adulto.femenino)} (${getPercentage(centro.gruposEtarios.adulto.femenino, centro.gruposEtarios.adulto.total)}%)
                                        </div>
                                        <div>
                                            <strong>Impacto económico:</strong><br>
                                            ${centro.gruposEtarios.adulto.porcentaje ? `${centro.gruposEtarios.adulto.porcentaje}% de la población` : `${getPercentage(centro.gruposEtarios.adulto.total, centro.poblacionTotal)}% de la población`}<br>
                                            Base productiva del territorio<br>
                                            Sostén del sistema de salud
                                        </div>
                                        <div>
                                            <strong>Programas prioritarios:</strong><br>
                                            Examen de medicina preventiva<br>
                                            Programa cardiovascular<br>
                                            Salud mental y laboral<br>
                                            Programas de la mujer
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr class="expand-row" data-target="adulto-mayor-details">
                        <td style="color: var(--accent);"><i class="fas fa-user-clock" style="margin-right: 8px;"></i>Adulto Mayor (65+ años)</td>
                        <td>${formatNumber(centro.gruposEtarios.adultoMayor.masculino)}</td>
                        <td>${formatNumber(centro.gruposEtarios.adultoMayor.femenino)}</td>
                        <td style="font-weight: 700;">${formatNumber(centro.gruposEtarios.adultoMayor.total)}</td>
                        <td><span style="background: ${chartColors.accent}20; padding: 2px 8px; border-radius: 12px; font-weight: 600;">${getPercentage(centro.gruposEtarios.adultoMayor.total, centro.poblacionTotal)}%</span></td>
                        <td>
                            <div style="font-size: 0.8rem;">
                                <div>♂ ${getPercentage(centro.gruposEtarios.adultoMayor.masculino, centro.gruposEtarios.adultoMayor.total)}%</div>
                                <div>♀ ${getPercentage(centro.gruposEtarios.adultoMayor.femenino, centro.gruposEtarios.adultoMayor.total)}%</div>
                            </div>
                        </td>
                    </tr>
                    <tr class="detail-row" id="adulto-mayor-details">
                        <td colspan="6">
                            <div class="detail-content">
                                <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid ${chartColors.accent};">
                                    <h4 style="color: var(--accent-dark); margin-bottom: 12px;"><i class="fas fa-chart-pie" style="margin-right: 8px;"></i>Análisis Población Adulto Mayor</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                        <div>
                                            <strong>Envejecimiento poblacional:</strong><br>
                                            Hombres: ${formatNumber(centro.gruposEtarios.adultoMayor.masculino)} (${getPercentage(centro.gruposEtarios.adultoMayor.masculino, centro.gruposEtarios.adultoMayor.total)}%)<br>
                                            Mujeres: ${formatNumber(centro.gruposEtarios.adultoMayor.femenino)} (${getPercentage(centro.gruposEtarios.adultoMayor.femenino, centro.gruposEtarios.adultoMayor.total)}%)
                                        </div>
                                        <div>
                                            <strong>Desafío demográfico:</strong><br>
                                            ${centro.gruposEtarios.adultoMayor.porcentaje ? `${centro.gruposEtarios.adultoMayor.porcentaje}% de la población` : `${getPercentage(centro.gruposEtarios.adultoMayor.total, centro.poblacionTotal)}% de la población`}<br>
                                            Transición demográfica avanzada<br>
                                            Mayor demanda de servicios
                                        </div>
                                        <div>
                                            <strong>Atención especializada:</strong><br>
                                            Programa del adulto mayor<br>
                                            Enfermedades crónicas<br>
                                            Dependencia y cuidados<br>
                                            Promoción del envejecimiento activo
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            `;
            
            tableEl.innerHTML = html;
            
            // Add event listeners for expandable rows
            const expandRows = document.querySelectorAll('.expand-row');
            expandRows.forEach(row => {
                row.addEventListener('click', function() {
                    const targetId = this.dataset.target;
                    const targetRow = document.getElementById(targetId);
                    
                    if (targetRow.style.display === 'table-row') {
                        targetRow.style.display = 'none';
                        this.classList.remove('expanded');
                    } else {
                        // Hide all detail rows
                        document.querySelectorAll('.detail-row').forEach(r => {
                            r.style.display = 'none';
                        });
                        
                        // Remove expanded class from all rows
                        document.querySelectorAll('.expand-row').forEach(r => {
                            r.classList.remove('expanded');
                        });
                        
                        // Show this detail row
                        targetRow.style.display = 'table-row';
                        this.classList.add('expanded');
                    }
                });
            });
        }

        function createGruposEtariosTable(centroId) {
            const centro = poblacionData.centros[centroId];
            const tableEl = document.getElementById('dataTable');
            
            const grupos = centro.grupos;
            
            let html = `
                <thead>
                    <tr>
                        <th>Grupo Etario</th>
                        <th>Hombres</th>
                        <th>Mujeres</th>
                        <th>Total</th>
                        <th>% Población</th>
                        <th>Razón H:M</th>
                        <th>Densidad</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            for (const [grupo, data] of Object.entries(grupos)) {
                const razon = ((data.masculino / data.femenino) * 100).toFixed(1);
                const densidad = centro.indicadores && centro.indicadores.densidadPoblacional ? 
                    ((data.total / centro.poblacionTotal) * centro.indicadores.densidadPoblacional).toFixed(1) : 'N/A';
                
                html += `
                    <tr class="hover-highlight" style="transition: all 0.3s ease;">
                        <td style="font-weight: 700; color: var(--primary);">
                            <i class="fas fa-users" style="margin-right: 8px; color: var(--primary);"></i>
                            ${grupo}
                        </td>
                        <td style="color: var(--male-color);">
                            <strong>${formatNumber(data.masculino)}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                ${getPercentage(data.masculino, data.total)}% del grupo
                            </div>
                        </td>
                        <td style="color: var(--female-color);">
                            <strong>${formatNumber(data.femenino)}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                ${getPercentage(data.femenino, data.total)}% del grupo
                            </div>
                        </td>
                        <td style="font-weight: 800; font-size: 1.1rem;">
                            ${formatNumber(data.total)}
                        </td>
                        <td>
                            <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">
                                ${getPercentage(data.total, centro.poblacionTotal)}%
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span style="font-weight: 700; font-size: 1.1rem;">${razon}</span>
                                <span style="font-size: 0.8rem; color: var(--text-secondary);">
                                    ${razon > 100 ? '(+H)' : razon < 100 ? '(+M)' : '(=)'}
                                </span>
                            </div>
                        </td>
                        <td style="text-align: center; font-weight: 600;">
                            ${densidad} <span style="font-size: 0.8rem; color: var(--text-secondary);">hab/km²</span>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody>';
            tableEl.innerHTML = html;
        }

        function createOtrosGruposTable(centroId) {
            const centro = poblacionData.centros[centroId];
            const tableEl = document.getElementById('dataTable');
            
            const otrosGrupos = centro.otrosGrupos || poblacionData.centros.COMUNAL.otrosGrupos;
            
            let html = `
                <thead>
                    <tr>
                        <th>Grupo Programático</th>
                        <th>Hombres</th>
                        <th>Mujeres</th>
                        <th>Total</th>
                        <th>% Población</th>
                        <th>Razón H:M</th>
                        <th>Relevancia Clínica</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            const relevanciaClinica = {
                "0-4a": "Control niño sano, vacunación",
                "5-9a": "Salud escolar, desarrollo",
                "10-14a": "Adolescencia temprana",
                "15-19a": "Salud sexual y reproductiva",
                "20-24a": "Adulto joven, planificación familiar",
                "25-29a": "Edad reproductiva peak",
                "30-34a": "Salud reproductiva, cardiovascular",
                "35a39": "Prevención cardiovascular",
                "40a44": "Climaterio, enfermedades crónicas",
                "45a49": "Menopausia, prevención",
                "50a54": "Enfermedades crónicas",
                "55a59": "Pre-adulto mayor",
                "60a64": "Transición a adulto mayor",
                "65-69a": "Adulto mayor activo",
                "70-74a": "Fragilidad, comorbilidades",
                "75-79a": "Alta complejidad",
                "≥80a": "Cuidados paliativos, dependencia"
            };
            
            for (const [grupo, data] of Object.entries(otrosGrupos)) {
                const razon = ((data.masculino / data.femenino) * 100).toFixed(1);
                const relevancia = relevanciaClinica[grupo] || "Programa específico";
                
                html += `
                    <tr class="hover-highlight" style="transition: all 0.3s ease;">
                        <td style="font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="background: var(--gradient-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 700;">
                                    ${grupo}
                                </span>
                            </div>
                        </td>
                        <td>${formatNumber(data.masculino)}</td>
                        <td>${formatNumber(data.femenino)}</td>
                        <td style="font-weight: 700;">${formatNumber(data.total)}</td>
                        <td>
                            <div style="background: var(--surface-alt); padding: 4px 8px; border-radius: 8px; text-align: center; font-weight: 600;">
                                ${getPercentage(data.total, centro.poblacionTotal)}%
                            </div>
                        </td>
                        <td style="text-align: center; font-weight: 600;">${razon}</td>
                        <td style="font-size: 0.85rem; color: var(--text-secondary); font-style: italic;">
                            ${relevancia}
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody>';
            tableEl.innerHTML = html;
        }

        function createIndicadoresTable(centroId) {
            const centro = poblacionData.centros[centroId];
            const tableEl = document.getElementById('dataTable');
            
            if (!centro.indicadores) {
                tableEl.innerHTML = `
                    <thead>
                        <tr>
                            <th>Indicador</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="2" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 16px; display: block;"></i>
                                No hay datos de indicadores demográficos disponibles para este centro de salud.
                            </td>
                        </tr>
                    </tbody>
                `;
                return;
            }
            
            const interpretaciones = {
                indiceDepInfantil: "Bajo: <15%, Medio: 15-25%, Alto: >25%",
                indiceDepSenil: "Bajo: <15%, Medio: 15-25%, Alto: >25%",
                razónSexos: "Equilibrado: 95-105, Déficit H: <95, Exceso H: >105",
                edadMediana: "Joven: <30, Adulto: 30-40, Envejecido: >40",
                proporciónAdultosMayores: "Bajo: <10%, Medio: 10-15%, Alto: >15%",
                crecimientoAnual: "Bajo: <1%, Moderado: 1-2%, Alto: >2%",
                razónDependencia: "Bajo: <50%, Medio: 50-70%, Alto: >70%"
            };
            
            const getIndicatorStatus = (indicator, value) => {
                switch(indicator) {
                    case 'indiceDepInfantil':
                        return value < 15 ? 'success' : value < 25 ? 'warning' : 'danger';
                    case 'indiceDepSenil':
                        return value < 15 ? 'success' : value < 25 ? 'warning' : 'danger';
                    case 'razónSexos':
                        return (value >= 95 && value <= 105) ? 'success' : 'warning';
                    case 'proporciónAdultosMayores':
                        return value < 10 ? 'success' : value < 15 ? 'warning' : 'danger';
                    case 'crecimientoAnual':
                        return value < 1 ? 'warning' : value < 2 ? 'success' : 'info';
                    default:
                        return 'info';
                }
            };
            
            let html = `
                <thead>
                    <tr>
                        <th style="width: 30%;">Indicador Demográfico</th>
                        <th style="width: 15%;">Valor</th>
                        <th style="width: 15%;">Estado</th>
                        <th style="width: 25%;">Interpretación</th>
                        <th style="width: 15%;">Tendencia</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-baby" style="color: var(--primary); font-size: 1.2rem;"></i>
                                <div>
                                    <strong>Índice de Dependencia Infantil</strong>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Relación 0-14 años / 15-64 años × 100</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 1.4rem; font-weight: 800; color: var(--primary);">
                            ${centro.indicadores.indiceDepInfantil}%
                        </td>
                        <td>
                            <span class="status-badge status-${getIndicatorStatus('indiceDepInfantil', centro.indicadores.indiceDepInfantil)}">
                                ${centro.indicadores.indiceDepInfantil < 15 ? 'Bajo' : centro.indicadores.indiceDepInfantil < 25 ? 'Medio' : 'Alto'}
                            </span>
                        </td>
                        <td style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${interpretaciones.indiceDepInfantil}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px; color: var(--danger);">
                                <i class="fas fa-arrow-down"></i>
                                <span style="font-size: 0.9rem; font-weight: 600;">Decreciente</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-user-clock" style="color: var(--accent); font-size: 1.2rem;"></i>
                                <div>
                                    <strong>Índice de Dependencia Senil</strong>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Relación 65+ años / 15-64 años × 100</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 1.4rem; font-weight: 800; color: var(--accent);">
                            ${centro.indicadores.indiceDepSenil}%
                        </td>
                        <td>
                            <span class="status-badge status-${getIndicatorStatus('indiceDepSenil', centro.indicadores.indiceDepSenil)}">
                                ${centro.indicadores.indiceDepSenil < 15 ? 'Bajo' : centro.indicadores.indiceDepSenil < 25 ? 'Medio' : 'Alto'}
                            </span>
                        </td>
                        <td style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${interpretaciones.indiceDepSenil}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px; color: var(--success);">
                                <i class="fas fa-arrow-up"></i>
                                <span style="font-size: 0.9rem; font-weight: 600;">Creciente</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-venus-mars" style="color: var(--secondary); font-size: 1.2rem;"></i>
                                <div>
                                    <strong>Razón de Sexos</strong>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Hombres por cada 100 mujeres</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 1.4rem; font-weight: 800; color: var(--secondary);">
                            ${centro.indicadores.razónSexos}
                        </td>
                        <td>
                            <span class="status-badge status-${getIndicatorStatus('razónSexos', centro.indicadores.razónSexos)}">
                                ${(centro.indicadores.razónSexos >= 95 && centro.indicadores.razónSexos <= 105) ? 'Equilibrado' : centro.indicadores.razónSexos < 95 ? 'Déficit H' : 'Exceso H'}
                            </span>
                        </td>
                        <td style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${interpretaciones.razónSexos}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px; color: var(--info);">
                                <i class="fas fa-equals"></i>
                                <span style="font-size: 0.9rem; font-weight: 600;">Estable</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-chart-line" style="color: var(--info); font-size: 1.2rem;"></i>
                                <div>
                                    <strong>Edad Mediana</strong>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Edad que divide la población en dos grupos iguales</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 1.4rem; font-weight: 800; color: var(--info);">
                            ${centro.indicadores.edadMediana} años
                        </td>
                        <td>
                            <span class="status-badge status-${centro.indicadores.edadMediana < 30 ? 'success' : centro.indicadores.edadMediana < 40 ? 'warning' : 'danger'}">
                                ${centro.indicadores.edadMediana < 30 ? 'Joven' : centro.indicadores.edadMediana < 40 ? 'Adulto' : 'Envejecido'}
                            </span>
                        </td>
                        <td style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${interpretaciones.edadMediana}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px; color: var(--success);">
                                <i class="fas fa-arrow-up"></i>
                                <span style="font-size: 0.9rem; font-weight: 600;">Aumentando</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-percentage" style="color: var(--warning); font-size: 1.2rem;"></i>
                                <div>
                                    <strong>Proporción de Adultos Mayores</strong>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">% de población de 65+ años</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 1.4rem; font-weight: 800; color: var(--warning);">
                            ${centro.indicadores.proporciónAdultosMayores}%
                        </td>
                        <td>
                            <span class="status-badge status-${getIndicatorStatus('proporciónAdultosMayores', centro.indicadores.proporciónAdultosMayores)}">
                                ${centro.indicadores.proporciónAdultosMayores < 10 ? 'Bajo' : centro.indicadores.proporciónAdultosMayores < 15 ? 'Medio' : 'Alto'}
                            </span>
                        </td>
                        <td style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${interpretaciones.proporciónAdultosMayores}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px; color: var(--success);">
                                <i class="fas fa-arrow-up"></i>
                                <span style="font-size: 0.9rem; font-weight: 600;">Creciente</span>
                            </div>
                        </td>
                    </tr>
                    ${centro.indicadores.crecimientoAnual ? `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-trending-up" style="color: var(--success); font-size: 1.2rem;"></i>
                                <div>
                                    <strong>Crecimiento Anual</strong>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Tasa de crecimiento poblacional anual</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 1.4rem; font-weight: 800; color: var(--success);">
                            ${centro.indicadores.crecimientoAnual}%
                        </td>
                        <td>
                            <span class="status-badge status-${getIndicatorStatus('crecimientoAnual', centro.indicadores.crecimientoAnual)}">
                                ${centro.indicadores.crecimientoAnual < 1 ? 'Bajo' : centro.indicadores.crecimientoAnual < 2 ? 'Moderado' : 'Alto'}
                            </span>
                        </td>
                        <td style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${interpretaciones.crecimientoAnual}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px; color: var(--warning);">
                                <i class="fas fa-arrow-down"></i>
                                <span style="font-size: 0.9rem; font-weight: 600;">Desacelerando</span>
                            </div>
                        </td>
                    </tr>
                    ` : ''}
                    ${centro.indicadores.razónDependencia ? `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-balance-scale" style="color: var(--danger); font-size: 1.2rem;"></i>
                                <div>
                                    <strong>Razón de Dependencia Total</strong>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">(0-14 + 65+) / 15-64 × 100</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 1.4rem; font-weight: 800; color: var(--danger);">
                            ${centro.indicadores.razónDependencia}%
                        </td>
                        <td>
                            <span class="status-badge status-${centro.indicadores.razónDependencia < 50 ? 'success' : centro.indicadores.razónDependencia < 70 ? 'warning' : 'danger'}">
                                ${centro.indicadores.razónDependencia < 50 ? 'Bajo' : centro.indicadores.razónDependencia < 70 ? 'Medio' : 'Alto'}
                            </span>
                        </td>
                        <td style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${interpretaciones.razónDependencia}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px; color: var(--info);">
                                <i class="fas fa-equals"></i>
                                <span style="font-size: 0.9rem; font-weight: 600;">Estable</span>
                            </div>
                        </td>
                    </tr>
                    ` : ''}
                </tbody>
            `;
            
            tableEl.innerHTML = html;
            
            // Add CSS for status badges
            const style = document.createElement('style');
            style.textContent = `
                .status-badge {
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .status-success {
                    background: var(--success);
                    color: white;
                }
                .status-warning {
                    background: var(--warning);
                    color: white;
                }
                .status-danger {
                    background: var(--danger);
                    color: white;
                }
                .status-info {
                    background: var(--info);
                    color: white;
                }
            `;
            document.head.appendChild(style);
        }

        function createTendenciasTable(centroId) {
            const centro = poblacionData.centros[centroId];
            const tableEl = document.getElementById('dataTable');
            
            if (!centro.tendencia) {
                tableEl.innerHTML = `
                    <thead><tr><th>Año</th><th>Población</th></tr></thead>
                    <tbody>
                        <tr><td colspan="2" style="text-align: center; padding: 40px;">
                            No hay datos de tendencias disponibles para este centro.
                        </td></tr>
                    </tbody>
                `;
                return;
            }
            
            let html = `
                <thead>
                    <tr>
                        <th>Año</th>
                        <th>Población Total</th>
                        <th>Crecimiento Anual</th>
                        <th>Variación Absoluta</th>
                        <th>Análisis</th>
                        <th>Proyección</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            centro.tendencia.forEach((item, index) => {
                const prevYear = index > 0 ? centro.tendencia[index - 1] : null;
                const variation = prevYear ? item.poblacion - prevYear.poblacion : 0;
                const growth = item.crecimiento || 0;
                
                let analysis = 'Año base';
                if (growth > 0) {
                    analysis = growth > 1.5 ? 'Crecimiento acelerado' : growth > 1 ? 'Crecimiento moderado' : 'Crecimiento lento';
                } else if (growth < 0) {
                    analysis = 'Decrecimiento poblacional';
                }
                
                // Proyección simple para el próximo año
                const nextYearProjection = index === centro.tendencia.length - 1 ? 
                    Math.round(item.poblacion * (1 + growth / 100)) : '';
                
                html += `
                    <tr>
                        <td style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">${item.año}</td>
                        <td style="font-weight: 700; font-size: 1.2rem;">
                            ${formatNumber(item.poblacion)}
                            ${variation !== 0 ? `
                                <div style="font-size: 0.8rem; color: ${variation > 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${variation > 0 ? '+' : ''}${formatNumber(variation)} hab.
                                </div>
                            ` : ''}
                        </td>
                        <td style="text-align: center;">
                            ${growth !== 0 ? `
                                <span style="background: ${growth > 1 ? 'var(--success)' : growth > 0 ? 'var(--warning)' : 'var(--danger)'}; 
                                             color: white; padding: 4px 12px; border-radius: 20px; font-weight: 700;">
                                    ${growth > 0 ? '+' : ''}${growth}%
                                </span>
                            ` : '-'}
                        </td>
                        <td style="text-align: center; font-weight: 600;">
                            ${variation !== 0 ? formatNumber(Math.abs(variation)) : '-'}
                        </td>
                        <td style="font-style: italic; color: var(--text-secondary);">
                            ${analysis}
                        </td>
                        <td style="text-align: center; font-weight: 600; color: var(--info);">
                            ${nextYearProjection ? formatNumber(nextYearProjection) : '-'}
                        </td>
                    </tr>
                `;
            });
            
            // Add projections if available
            if (centro.proyecciones) {
                html += `
                    <tr style="border-top: 3px solid var(--primary); background: var(--surface-alt);">
                        <td colspan="6" style="text-align: center; font-weight: 700; color: var(--primary); padding: 16px;">
                            <i class="fas fa-crystal-ball" style="margin-right: 8px;"></i>
                            PROYECCIONES DEMOGRÁFICAS
                        </td>
                    </tr>
                `;
                
                centro.proyecciones.forEach((proj, index) => {
                    const prevProjection = index > 0 ? centro.proyecciones[index - 1] : centro.tendencia[centro.tendencia.length - 1];
                    const projectedVariation = proj.poblacion - prevProjection.poblacion;
                    const projectedGrowth = ((proj.poblacion - prevProjection.poblacion) / prevProjection.poblacion * 100).toFixed(1);
                    
                    html += `
                        <tr style="background: rgba(var(--info-rgb), 0.05); font-style: italic;">
                            <td style="color: var(--info); font-weight: 600;">${proj.año} *</td>
                            <td style="color: var(--info); font-weight: 600;">
                                ${formatNumber(proj.poblacion)}
                                <div style="font-size: 0.8rem;">
                                    ${projectedVariation > 0 ? '+' : ''}${formatNumber(projectedVariation)} hab.
                                </div>
                            </td>
                            <td style="text-align: center; color: var(--info);">
                                ${projectedGrowth > 0 ? '+' : ''}${projectedGrowth}%
                            </td>
                            <td style="text-align: center; color: var(--info);">
                                ${formatNumber(Math.abs(projectedVariation))}
                            </td>
                            <td style="color: var(--text-muted);">Proyección estadística</td>
                            <td style="text-align: center; color: var(--text-muted);">-</td>
                        </tr>
                    `;
                });
                
                html += `
                    <tr>
                        <td colspan="6" style="font-size: 0.8rem; color: var(--text-muted); text-align: center; padding: 12px;">
                            * Proyecciones basadas en tendencias históricas y modelos demográficos
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody>';
            tableEl.innerHTML = html;
        }

        // Update summary stats
        function updateSummaryStats(centroId) {
            const centro = poblacionData.centros[centroId];
            
            document.getElementById('poblacionTotal').textContent = formatNumber(centro.poblacionTotal);
            document.getElementById('propHombres').textContent = getPercentage(centro.sexo.masculino, centro.poblacionTotal) + '%';
            document.getElementById('propMujeres').textContent = getPercentage(centro.sexo.femenino, centro.poblacionTotal) + '%';
            
            if (centro.indicadores) {
                document.getElementById('indiceDepInfantil').textContent = centro.indicadores.indiceDepInfantil + '%';
                document.getElementById('indiceDepSenil').textContent = centro.indicadores.indiceDepSenil + '%';
            }
        }

        // Chart instances for updating
        let charts = {
            centrosSalud: null,
            sexDistribution: null,
            ageGroupsBySex: null,
            populationPyramid: null,
            ageGroupDistribution: null,
            populationTrend: null,
            ageHeatmap: null
        };

        // Function to safely destroy charts
        function destroyChart(chartName) {
            if (charts[chartName]) {
                try {
                    charts[chartName].destroy();
                } catch (error) {
                    console.warn(`Error destroying chart ${chartName}:`, error);
                }
                charts[chartName] = null;
            }
        }

        // Function to update all charts based on filters
        function updateCharts(centroId, grupoEtario) {
            try {
                showNotification('Actualizando visualizaciones...', 'info');
                
                updateSummaryStats(centroId);
                
                // Update sex distribution chart
                destroyChart('sexDistribution');
                let sexDistType = 'pie';
                const sexDistTabActive = document.querySelector('#sexDistributionChart').closest('.dashboard-card').querySelector('.chart-tab.active');
                if (sexDistTabActive) {
                    sexDistType = sexDistTabActive.dataset.chart;
                }
                charts.sexDistribution = createSexDistributionChart(centroId, sexDistType);
                
                // Update age groups by sex chart
                destroyChart('ageGroupsBySex');
                let ageGroupsBySexType = 'bar';
                const ageGroupsBySexTabActive = document.querySelector('#ageGroupsBySexChart').closest('.dashboard-card').querySelector('.chart-tab.active');
                if (ageGroupsBySexTabActive) {
                    ageGroupsBySexType = ageGroupsBySexTabActive.dataset.chart;
                }
                charts.ageGroupsBySex = createAgeGroupsBySexChart(centroId, ageGroupsBySexType);
                
                // Update population pyramid chart
                destroyChart('populationPyramid');
                const grouping = parseInt(document.getElementById('piramideAgeGrouping').value);
                charts.populationPyramid = createPopulationPyramidChart(centroId, grouping);
                
                // Update age group distribution chart
                destroyChart('ageGroupDistribution');
                let ageGroupDistType = 'doughnut';
                const ageGroupDistTabActive = document.querySelector('#ageGroupDistributionChart').closest('.dashboard-card').querySelector('.chart-tab.active');
                if (ageGroupDistTabActive) {
                    ageGroupDistType = ageGroupDistTabActive.dataset.chart;
                }
                charts.ageGroupDistribution = createAgeGroupDistributionChart(centroId, ageGroupDistType);
                
                // Update population trend chart
                destroyChart('populationTrend');
                let trendChartType = 'line';
                const trendChartTabActive = document.querySelector('#populationTrendChart').closest('.dashboard-card').querySelector('.chart-tab.active');
                if (trendChartTabActive) {
                    trendChartType = trendChartTabActive.dataset.chart;
                }
                charts.populationTrend = createPopulationTrendChart(centroId, trendChartType);
                
                // Update age heatmap chart
                destroyChart('ageHeatmap');
                charts.ageHeatmap = createAgeHeatmapChart(centroId);
                
                // Update table based on active tab
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    updateTable(activeTab.dataset.tab, centroId);
                } else {
                    updateTable('resumen', centroId);
                }
                
                showNotification('Visualizaciones actualizadas correctamente', 'success');
            } catch (error) {
                console.error('Error updating charts:', error);
                showNotification('Error al actualizar visualizaciones', 'error');
            }
        }

        // Function to update the data table based on tab
        function updateTable(tabId, centroId) {
            try {
                switch (tabId) {
                    case 'resumen':
                        createResumenTable(centroId);
                        break;
                    case 'grupos-etarios':
                        createGruposEtariosTable(centroId);
                        break;
                    case 'otros-grupos':
                        createOtrosGruposTable(centroId);
                        break;
                    case 'indicadores':
                        createIndicadoresTable(centroId);
                        break;
                    case 'tendencias':
                        createTendenciasTable(centroId);
                        break;
                    default:
                        createResumenTable(centroId);
                }
            } catch (error) {
                console.error('Error updating table:', error);
            }
        }

        // Function to show details for a specific group
        function showDetails(groupId) {
            showNotification(`Generando análisis detallado para: ${groupId}`, 'info');
        }

        // PREMIUM VOICE RECOGNITION FUNCTIONALITY
        let recognition = null;
        let isListening = false;

        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.lang = 'es-ES';
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('voiceCommandBtn').classList.add('listening');
                    document.getElementById('voiceStatusText').textContent = 'Escuchando... Habla ahora';
                    showNotification('Reconocimiento de voz activado', 'info');
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    document.getElementById('voiceStatusText').textContent = `Comando reconocido: "${transcript}"`;
                    processVoiceCommand(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('Error en reconocimiento de voz:', event.error);
                    document.getElementById('voiceStatusText').textContent = `Error: ${event.error}`;
                    showNotification('Error en reconocimiento de voz', 'error');
                    stopListening();
                };
                
                recognition.onend = function() {
                    stopListening();
                };
                
                return true;
            }
            return false;
        }

        function startListening() {
            if (recognition && !isListening) {
                document.getElementById('voiceStatus').style.display = 'block';
                recognition.start();
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('voiceCommandBtn').classList.remove('listening');
            setTimeout(() => {
                document.getElementById('voiceStatus').style.display = 'none';
            }, 3000);
        }

        // ENHANCED VOICE COMMAND PROCESSING
        function processVoiceCommand(command) {
            console.log('Procesando comando avanzado:', command);
            
            // Normalize command
            const normalizedCommand = command.toLowerCase()
                .replace(/á/g, 'a').replace(/é/g, 'e').replace(/í/g, 'i')
                .replace(/ó/g, 'o').replace(/ú/g, 'u').replace(/ñ/g, 'n');
            
            try {
                // Navigation commands
                if (normalizedCommand.includes('metas sanitarias') || normalizedCommand.includes('metas')) {
                    navigateToMetasSanitarias();
                    showNotification('Navegando a Metas Sanitarias', 'success');
                    return;
                }
                
                if (normalizedCommand.includes('iaaps') || normalizedCommand.includes('indicadores')) {
                    navigateToIAAPS();
                    showNotification('Navegando a IAAPS', 'success');
                    return;
                }
                
                // Center selection commands
                const centroSelect = document.getElementById('centroSelect');
                if (centroSelect) {
                    if (normalizedCommand.includes('curico centro') || normalizedCommand.includes('centro curico')) {
                        centroSelect.value = 'CENTRAL';
                        updateCharts('CENTRAL', document.getElementById('grupoEtarioSelect').value);
                        showNotification('Centro cambiado a Curicó Centro', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('miguel angel') || normalizedCommand.includes('arenas lopez')) {
                        centroSelect.value = 'MAAL';
                        updateCharts('MAAL', document.getElementById('grupoEtarioSelect').value);
                        showNotification('Centro cambiado a Miguel Ángel Arenas López', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('betty munoz') || normalizedCommand.includes('betty muñoz')) {
                        centroSelect.value = 'BMA';
                        updateCharts('BMA', document.getElementById('grupoEtarioSelect').value);
                        showNotification('Centro cambiado a Betty Muñoz Arce', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('colon')) {
                        centroSelect.value = 'COLON';
                        updateCharts('COLON', document.getElementById('grupoEtarioSelect').value);
                        showNotification('Centro cambiado a Colón', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('sarmiento')) {
                        centroSelect.value = 'SARMIENTO';
                        updateCharts('SARMIENTO', document.getElementById('grupoEtarioSelect').value);
                        showNotification('Centro cambiado a Sarmiento', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('niches') || normalizedCommand.includes('los niches')) {
                        centroSelect.value = 'LOS_NICHES';
                        updateCharts('LOS_NICHES', document.getElementById('grupoEtarioSelect').value);
                        showNotification('Centro cambiado a Los Niches', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('comunal') || normalizedCommand.includes('todos los centros')) {
                        centroSelect.value = 'COMUNAL';
                        updateCharts('COMUNAL', document.getElementById('grupoEtarioSelect').value);
                        showNotification('Vista cambiada a Comuna completa', 'success');
                        return;
                    }
                }
                
                // Age group selection commands
                const grupoEtarioSelect = document.getElementById('grupoEtarioSelect');
                if (grupoEtarioSelect) {
                    if (normalizedCommand.includes('infantil') || normalizedCommand.includes('ninos') || normalizedCommand.includes('niños')) {
                        grupoEtarioSelect.value = 'INFANTIL';
                        updateCharts(document.getElementById('centroSelect').value, 'INFANTIL');
                        showNotification('Filtro aplicado: Población Infantil', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('adolescente') || normalizedCommand.includes('jovenes') || normalizedCommand.includes('jóvenes')) {
                        grupoEtarioSelect.value = 'ADOLESCENTE';
                        updateCharts(document.getElementById('centroSelect').value, 'ADOLESCENTE');
                        showNotification('Filtro aplicado: Población Adolescente', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('adulto mayor') || normalizedCommand.includes('ancianos') || normalizedCommand.includes('mayores')) {
                        grupoEtarioSelect.value = 'ADULTO_MAYOR';
                        updateCharts(document.getElementById('centroSelect').value, 'ADULTO_MAYOR');
                        showNotification('Filtro aplicado: Adultos Mayores', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('adulto') && !normalizedCommand.includes('mayor')) {
                        grupoEtarioSelect.value = 'ADULTO';
                        updateCharts(document.getElementById('centroSelect').value, 'ADULTO');
                        showNotification('Filtro aplicado: Población Adulta', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('todos') || normalizedCommand.includes('toda la poblacion')) {
                        grupoEtarioSelect.value = 'TODOS';
                        updateCharts(document.getElementById('centroSelect').value, 'TODOS');
                        showNotification('Filtro removido: Mostrando toda la población', 'success');
                        return;
                    }
                }
                
                // Tab navigation commands
                if (normalizedCommand.includes('tabla') || normalizedCommand.includes('mostrar')) {
                    if (normalizedCommand.includes('resumen')) {
                        const tab = document.querySelector('.tab[data-tab="resumen"]');
                        if (tab) {
                            tab.click();
                            showNotification('Mostrando resumen ejecutivo', 'success');
                        }
                        return;
                    }
                    
                    if (normalizedCommand.includes('grupos etarios')) {
                        const tab = document.querySelector('.tab[data-tab="grupos-etarios"]');
                        if (tab) {
                            tab.click();
                            showNotification('Mostrando grupos etarios', 'success');
                        }
                        return;
                    }
                    
                    if (normalizedCommand.includes('indicadores')) {
                        const tab = document.querySelector('.tab[data-tab="indicadores"]');
                        if (tab) {
                            tab.click();
                            showNotification('Mostrando indicadores demográficos', 'success');
                        }
                        return;
                    }
                    
                    if (normalizedCommand.includes('tendencias')) {
                        const tab = document.querySelector('.tab[data-tab="tendencias"]');
                        if (tab) {
                            tab.click();
                            showNotification('Mostrando análisis de tendencias', 'success');
                        }
                        return;
                    }
                }
                
                // Action commands
                if (normalizedCommand.includes('exportar') || normalizedCommand.includes('descargar')) {
                    const exportButton = document.getElementById('exportButton');
                    if (exportButton) {
                        exportButton.click();
                        showNotification('Iniciando exportación a PDF', 'success');
                    }
                    return;
                }
                
                if (normalizedCommand.includes('imprimir')) {
                    window.print();
                    showNotification('Iniciando impresión', 'success');
                    return;
                }
                
                if (normalizedCommand.includes('comparar') || normalizedCommand.includes('comparacion')) {
                    const compareButton = document.getElementById('compareButton');
                    if (compareButton) {
                        compareButton.click();
                        showNotification('Activando vista de comparación', 'success');
                    }
                    return;
                }
                
                if (normalizedCommand.includes('resetear') || normalizedCommand.includes('limpiar filtros')) {
                    const resetButton = document.getElementById('resetFiltersBtn');
                    if (resetButton) {
                        resetButton.click();
                        showNotification('Filtros reseteados', 'success');
                    }
                    return;
                }
                
                // Chart type commands
                if (normalizedCommand.includes('grafico') || normalizedCommand.includes('gráfico')) {
                    if (normalizedCommand.includes('circular') || normalizedCommand.includes('torta')) {
                        // Find active chart and switch to circular
                        const activeChartTabs = document.querySelectorAll('.chart-tab');
                        activeChartTabs.forEach(tab => {
                            if ((tab.dataset.chart === 'doughnut' || tab.dataset.chart === 'pie') && 
                                tab.closest('.dashboard-card').querySelector('canvas:hover')) {
                                tab.click();
                            }
                        });
                        showNotification('Cambiando a gráfico circular', 'success');
                        return;
                    }
                    
                    if (normalizedCommand.includes('barras')) {
                        // Find active chart and switch to bar
                        const activeChartTabs = document.querySelectorAll('.chart-tab');
                        activeChartTabs.forEach(tab => {
                            if (tab.dataset.chart === 'bar' && 
                                tab.closest('.dashboard-card').querySelector('canvas:hover')) {
                                tab.click();
                            }
                        });
                        showNotification('Cambiando a gráfico de barras', 'success');
                        return;
                    }
                }
                
                // If no command recognized
                showNotification(`Comando no reconocido: "${command}". Intenta con: "centro curicó", "población infantil", "mostrar indicadores", "exportar", etc.`, 'warning');
                
            } catch (error) {
                console.error('Error procesando comando de voz:', error);
                showNotification('Error procesando comando de voz', 'error');
            }
        }

        // NAVIGATION FUNCTIONS
        function navigateToMetasSanitarias() {
            // Simulate navigation to Metas Sanitarias module
            showNotification('Navegando a módulo de Metas Sanitarias...', 'info');
            setTimeout(() => {
                window.location.href = '#metas-sanitarias'; // This would be the actual route
            }, 1000);
        }

        function navigateToIAAPS() {
            // Simulate navigation to IAAPS module
            showNotification('Navegando a módulo de IAAPS...', 'info');
            setTimeout(() => {
                window.location.href = '#iaaps'; // This would be the actual route
            }, 1000);
        }

        // ENHANCED COMPARISON FUNCTIONS
        function generateComparisonCards(metric) {
            const compareGrid = document.getElementById('compareGrid');
            
            if (!compareGrid) return;
            
            compareGrid.innerHTML = '';
            showNotification('Generando análisis comparativo...', 'info');
            
            const centros = Object.values(poblacionData.centros)
                .filter(centro => centro.nombre !== "COMUNA CURICÓ (Total)");
            
            switch (metric) {
                case 'poblacion-total':
                    centros.forEach(centro => {
                        const card = document.createElement('div');
                        card.className = 'compare-card';
                        
                        const crecimiento = centro.indicadores ? centro.indicadores.crecimientoAnual : 0;
                        
                        card.innerHTML = `
                            <div class="compare-card-header">
                                <i class="fas fa-hospital" style="margin-right: 8px;"></i>
                                ${centro.nombre}
                            </div>
                            <div class="compare-card-content">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <div style="font-size: 2.5rem; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                                        ${formatNumber(centro.poblacionTotal)}
                                    </div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 16px;">
                                        Cobertura: ${centro.cobertura || 'N/A'}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                    <div style="text-align: center; padding: 12px; background: var(--surface-alt); border-radius: 12px;">
                                        <div style="font-weight: 700; color: var(--male-color); font-size: 1.2rem;">
                                            ${formatNumber(centro.sexo.masculino)}
                                        </div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Hombres</div>
                                        <div style="font-size: 0.8rem; font-weight: 600; color: var(--male-color);">
                                            ${getPercentage(centro.sexo.masculino, centro.poblacionTotal)}%
                                        </div>
                                    </div>
                                    <div style="text-align: center; padding: 12px; background: var(--surface-alt); border-radius: 12px;">
                                        <div style="font-weight: 700; color: var(--female-color); font-size: 1.2rem;">
                                            ${formatNumber(centro.sexo.femenino)}
                                        </div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Mujeres</div>
                                        <div style="font-size: 0.8rem; font-weight: 600; color: var(--female-color);">
                                            ${getPercentage(centro.sexo.femenino, centro.poblacionTotal)}%
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="text-align: center; padding: 12px; background: ${crecimiento > 1 ? 'var(--success)' : crecimiento > 0 ? 'var(--warning)' : 'var(--danger)'}20; border-radius: 12px; border: 2px solid ${crecimiento > 1 ? 'var(--success)' : crecimiento > 0 ? 'var(--warning)' : 'var(--danger)'}40;">
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">Crecimiento Anual</div>
                                    <div style="font-size: 1.4rem; font-weight: 800; color: ${crecimiento > 1 ? 'var(--success)' : crecimiento > 0 ? 'var(--warning)' : 'var(--danger)'};">
                                        ${crecimiento > 0 ? '+' : ''}${crecimiento}%
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        compareGrid.appendChild(card);
                    });
                    break;
                
                case 'distribucion-sexo':
                    centros.forEach(centro => {
                        const card = document.createElement('div');
                        card.className = 'compare-card';
                        
                        const canvasId = `compare-sex-${centro.nombre.replace(/\s+/g, '-').toLowerCase().replace(/[^\w-]/g, '')}`;
                        
                        card.innerHTML = `
                            <div class="compare-card-header">
                                <i class="fas fa-venus-mars" style="margin-right: 8px;"></i>
                                ${centro.nombre}
                            </div>
                            <div class="compare-card-content">
                                <div style="height: 220px; margin-bottom: 16px;">
                                    <canvas id="${canvasId}"></canvas>
                                </div>
                                <div style="background: var(--surface-alt); padding: 16px; border-radius: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">Razón H:M:</span>
                                        <span style="font-weight: 800; font-size: 1.2rem; color: var(--primary);">
                                            ${centro.indicadores ? centro.indicadores.razónSexos : ((centro.sexo.masculino / centro.sexo.femenino) * 100).toFixed(1)}
                                        </span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); text-align: center;">
                                        ${centro.indicadores && centro.indicadores.razónSexos > 105 ? 'Exceso de hombres' : 
                                          centro.indicadores && centro.indicadores.razónSexos < 95 ? 'Exceso de mujeres' : 'Distribución equilibrada'}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        compareGrid.appendChild(card);
                        
                        setTimeout(() => {
                            const ctx = document.getElementById(canvasId);
                            if (ctx) {
                                new Chart(ctx.getContext('2d'), {
                                    type: 'doughnut',
                                    data: {
                                        labels: ['Hombres', 'Mujeres'],
                                        datasets: [{
                                            data: [centro.sexo.masculino, centro.sexo.femenino],
                                            backgroundColor: [chartColors.maleColor, chartColors.femaleColor],
                                            borderWidth: 3,
                                            borderColor: '#ffffff',
                                            hoverOffset: 8
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        cutout: '60%',
                                        plugins: {
                                            legend: {
                                                position: 'bottom',
                                                labels: { 
                                                    font: { size: 10, weight: 600 },
                                                    usePointStyle: true,
                                                    pointStyle: 'circle'
                                                }
                                            },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        const value = context.raw;
                                                        const percentage = getPercentage(value, centro.poblacionTotal);
                                                        return `${context.label}: ${formatNumber(value)} (${percentage}%)`;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                        }, 100);
                    });
                    break;
                
                case 'grupos-etarios':
                    centros.forEach(centro => {
                        const card = document.createElement('div');
                        card.className = 'compare-card';
                        
                        const canvasId = `compare-age-${centro.nombre.replace(/\s+/g, '-').toLowerCase().replace(/[^\w-]/g, '')}`;
                        
                        card.innerHTML = `
                            <div class="compare-card-header">
                                <i class="fas fa-users" style="margin-right: 8px;"></i>
                                ${centro.nombre}
                            </div>
                            <div class="compare-card-content">
                                <div style="height: 240px; margin-bottom: 16px;">
                                    <canvas id="${canvasId}"></canvas>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
                                    <div style="text-align: center; padding: 8px; background: ${chartColors.primary}20; border-radius: 8px;">
                                        <div style="font-weight: 700; color: var(--primary);">
                                            ${getPercentage(centro.gruposEtarios.infantil.total, centro.poblacionTotal)}%
                                        </div>
                                        <div>Infantil</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: ${chartColors.secondary}20; border-radius: 8px;">
                                        <div style="font-weight: 700; color: var(--secondary);">
                                            ${getPercentage(centro.gruposEtarios.adolescente.total, centro.poblacionTotal)}%
                                        </div>
                                        <div>Adolescente</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: ${chartColors.info}20; border-radius: 8px;">
                                        <div style="font-weight: 700; color: var(--info);">
                                            ${getPercentage(centro.gruposEtarios.adulto.total, centro.poblacionTotal)}%
                                        </div>
                                        <div>Adulto</div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: ${chartColors.accent}20; border-radius: 8px;">
                                        <div style="font-weight: 700; color: var(--accent-dark);">
                                            ${getPercentage(centro.gruposEtarios.adultoMayor.total, centro.poblacionTotal)}%
                                        </div>
                                        <div>A. Mayor</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        compareGrid.appendChild(card);
                        
                        setTimeout(() => {
                            const ctx = document.getElementById(canvasId);
                            if (ctx) {
                                new Chart(ctx.getContext('2d'), {
                                    type: 'doughnut',
                                    data: {
                                        labels: ['Infantil', 'Adolescente', 'Adulto', 'Adulto Mayor'],
                                        datasets: [{
                                            data: [
                                                centro.gruposEtarios.infantil.total,
                                                centro.gruposEtarios.adolescente.total,
                                                centro.gruposEtarios.adulto.total,
                                                centro.gruposEtarios.adultoMayor.total
                                            ],
                                            backgroundColor: [
                                                chartColors.primary,
                                                chartColors.secondary,
                                                chartColors.info,
                                                chartColors.accent
                                            ],
                                            borderWidth: 3,
                                            borderColor: '#ffffff',
                                            hoverOffset: 8
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        cutout: '60%',
                                        plugins: {
                                            legend: {
                                                position: 'bottom',
                                                labels: { 
                                                    font: { size: 9, weight: 600 },
                                                    usePointStyle: true,
                                                    pointStyle: 'circle'
                                                }
                                            },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        const value = context.raw;
                                                        const percentage = getPercentage(value, centro.poblacionTotal);
                                                        return `${context.label}: ${formatNumber(value)} (${percentage}%)`;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                        }, 100);
                    });
                    break;
                
                case 'indicadores':
                    centros.forEach(centro => {
                        if (!centro.indicadores) return;
                        
                        const card = document.createElement('div');
                        card.className = 'compare-card';
                        
                        card.innerHTML = `
                            <div class="compare-card-header">
                                <i class="fas fa-chart-line" style="margin-right: 8px;"></i>
                                ${centro.nombre}
                            </div>
                            <div class="compare-card-content">
                                <div style="display: grid; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface-alt); border-radius: 8px;">
                                        <span style="font-size: 0.8rem; font-weight: 600;">Dep. Infantil</span>
                                        <span style="font-weight: 800; color: var(--primary);">${centro.indicadores.indiceDepInfantil}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface-alt); border-radius: 8px;">
                                        <span style="font-size: 0.8rem; font-weight: 600;">Dep. Senil</span>
                                        <span style="font-weight: 800; color: var(--accent);">${centro.indicadores.indiceDepSenil}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface-alt); border-radius: 8px;">
                                        <span style="font-size: 0.8rem; font-weight: 600;">Razón Sexos</span>
                                        <span style="font-weight: 800; color: var(--secondary);">${centro.indicadores.razónSexos}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface-alt); border-radius: 8px;">
                                        <span style="font-size: 0.8rem; font-weight: 600;">Edad Mediana</span>
                                        <span style="font-weight: 800; color: var(--info);">${centro.indicadores.edadMediana} años</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface-alt); border-radius: 8px;">
                                        <span style="font-size: 0.8rem; font-weight: 600;">% A. Mayores</span>
                                        <span style="font-weight: 800; color: var(--warning);">${centro.indicadores.proporciónAdultosMayores}%</span>
                                    </div>
                                    ${centro.indicadores.crecimientoAnual ? `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--success)20; border-radius: 8px; border: 2px solid var(--success)40;">
                                        <span style="font-size: 0.8rem; font-weight: 600;">Crecimiento</span>
                                        <span style="font-weight: 800; color: var(--success);">${centro.indicadores.crecimientoAnual}%</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        
                        compareGrid.appendChild(card);
                    });
                    break;
                
                case 'tendencias':
                    centros.forEach(centro => {
                        if (!centro.tendencia) return;
                        
                        const card = document.createElement('div');
                        card.className = 'compare-card';
                        
                        const canvasId = `compare-trend-${centro.nombre.replace(/\s+/g, '-').toLowerCase().replace(/[^\w-]/g, '')}`;
                        
                        const latestYear = centro.tendencia[centro.tendencia.length - 1];
                        const previousYear = centro.tendencia[centro.tendencia.length - 2];
                        const variation = latestYear.poblacion - previousYear.poblacion;
                        
                        card.innerHTML = `
                            <div class="compare-card-header">
                                <i class="fas fa-chart-line" style="margin-right: 8px;"></i>
                                ${centro.nombre}
                            </div>
                            <div class="compare-card-content">
                                <div style="height: 180px; margin-bottom: 16px;">
                                    <canvas id="${canvasId}"></canvas>
                                </div>
                                <div style="background: var(--surface-alt); padding: 16px; border-radius: 12px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; text-align: center;">
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">Población 2024</div>
                                            <div style="font-weight: 800; font-size: 1.1rem; color: var(--primary);">
                                                ${formatNumber(latestYear.poblacion)}
                                            </div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">Variación</div>
                                            <div style="font-weight: 800; font-size: 1.1rem; color: ${variation > 0 ? 'var(--success)' : 'var(--danger)'};">
                                                ${variation > 0 ? '+' : ''}${formatNumber(variation)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        compareGrid.appendChild(card);
                        
                        setTimeout(() => {
                            const ctx = document.getElementById(canvasId);
                            if (ctx) {
                                new Chart(ctx.getContext('2d'), {
                                    type: 'line',
                                    data: {
                                        labels: centro.tendencia.map(item => item.año),
                                        datasets: [{
                                            label: 'Población',
                                            data: centro.tendencia.map(item => item.poblacion),
                                            backgroundColor: `${chartColors.secondary}20`,
                                            borderColor: chartColors.secondary,
                                            borderWidth: 3,
                                            tension: 0.4,
                                            fill: true,
                                            pointBackgroundColor: chartColors.secondary,
                                            pointBorderColor: '#ffffff',
                                            pointBorderWidth: 2,
                                            pointRadius: 4,
                                            pointHoverRadius: 6
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        scales: {
                                            y: {
                                                beginAtZero: false,
                                                ticks: {
                                                    font: { size: 9 },
                                                    callback: function(value) {
                                                        return formatNumber(value);
                                                    }
                                                },
                                                grid: { color: '#f1f5f9' }
                                            },
                                            x: {
                                                ticks: { font: { size: 9 } },
                                                grid: { color: '#f1f5f9' }
                                            }
                                        },
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        return `Población: ${formatNumber(context.raw)}`;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                        }, 100);
                    });
                    break;
            }
            
            showNotification('Análisis comparativo generado exitosamente', 'success');
        }

        // ENHANCED FILTER MANAGEMENT
        function applyQuickFilter(preset) {
            const centroSelect = document.getElementById('centroSelect');
            const grupoEtarioSelect = document.getElementById('grupoEtarioSelect');
            
            // Remove active class from all quick filter buttons
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            switch(preset) {
                case 'todos':
                    centroSelect.value = 'COMUNAL';
                    grupoEtarioSelect.value = 'TODOS';
                    updateCharts('COMUNAL', 'TODOS');
                    showNotification('Vista general activada', 'success');
                    break;
                    
                case 'infantil':
                    grupoEtarioSelect.value = 'INFANTIL';
                    updateCharts(centroSelect.value, 'INFANTIL');
                    showNotification('Filtro rápido: Población Infantil', 'success');
                    break;
                    
                case 'adulto-mayor':
                    grupoEtarioSelect.value = 'ADULTO_MAYOR';
                    updateCharts(centroSelect.value, 'ADULTO_MAYOR');
                    showNotification('Filtro rápido: Adultos Mayores', 'success');
                    break;
                    
                case 'comparar':
                    document.getElementById('compareButton').click();
                    showNotification('Vista de comparación activada', 'success');
                    break;
            }
            
            updateActiveFilters();
        }

        function updateActiveFilters() {
            const activeFilters = document.getElementById('activeFilters');
            const centroSelect = document.getElementById('centroSelect');
            const grupoEtarioSelect = document.getElementById('grupoEtarioSelect');
            
            if (!activeFilters) return;
            
            activeFilters.innerHTML = '';
            
            // Add filter for selected center if not COMUNAL
            if (centroSelect.value !== 'COMUNAL') {
                const centroOption = centroSelect.options[centroSelect.selectedIndex];
                const centroFilter = document.createElement('div');
                centroFilter.className = 'filter-chip';
                centroFilter.innerHTML = `
                    <i class="fas fa-hospital" style="margin-right: 6px;"></i>
                    ${centroOption.text}
                    <div class="remove" onclick="removeFilter('centro')">×</div>
                `;
                activeFilters.appendChild(centroFilter);
            }
            
            // Add filter for selected group if not TODOS
            if (grupoEtarioSelect.value !== 'TODOS') {
                const grupoOption = grupoEtarioSelect.options[grupoEtarioSelect.selectedIndex];
                const grupoFilter = document.createElement('div');
                grupoFilter.className = 'filter-chip';
                grupoFilter.innerHTML = `
                    <i class="fas fa-users" style="margin-right: 6px;"></i>
                    ${grupoOption.text}
                    <div class="remove" onclick="removeFilter('grupo')">×</div>
                `;
                activeFilters.appendChild(grupoFilter);
            }
            
            // Add year filter if not default
            const yearSelect = document.getElementById('yearSelect');
            if (yearSelect && yearSelect.value !== '2024') {
                const yearFilter = document.createElement('div');
                yearFilter.className = 'filter-chip';
                yearFilter.innerHTML = `
                    <i class="fas fa-calendar" style="margin-right: 6px;"></i>
                    Año ${yearSelect.value}
                    <div class="remove" onclick="removeFilter('year')">×</div>
                `;
                activeFilters.appendChild(yearFilter);
            }
        }

        function removeFilter(type) {
            switch(type) {
                case 'centro':
                    document.getElementById('centroSelect').value = 'COMUNAL';
                    updateCharts('COMUNAL', document.getElementById('grupoEtarioSelect').value);
                    break;
                case 'grupo':
                    document.getElementById('grupoEtarioSelect').value = 'TODOS';
                    updateCharts(document.getElementById('centroSelect').value, 'TODOS');
                    break;
                case 'year':
                    document.getElementById('yearSelect').value = '2024';
                    break;
            }
            
            updateActiveFilters();
            showNotification('Filtro removido', 'info');
        }

        function resetAllFilters() {
            document.getElementById('centroSelect').value = 'COMUNAL';
            document.getElementById('grupoEtarioSelect').value = 'TODOS';
            document.getElementById('yearSelect').value = '2024';
            document.getElementById('analysisType').value = 'poblacion';
            
            // Reset quick filter buttons
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.quick-filter-btn[data-preset="todos"]').classList.add('active');
            
            updateCharts('COMUNAL', 'TODOS');
            updateActiveFilters();
            showNotification('Todos los filtros han sido reseteados', 'success');
        }

        function saveCurrentView() {
            const viewConfig = {
                centro: document.getElementById('centroSelect').value,
                grupo: document.getElementById('grupoEtarioSelect').value,
                year: document.getElementById('yearSelect').value,
                analysis: document.getElementById('analysisType').value,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage (in a real app, this would be saved to a database)
            const savedViews = JSON.parse(localStorage.getItem('savedViews') || '[]');
            const viewName = `Vista_${new Date().toLocaleString('es-CL').replace(/[^\w]/g, '_')}`;
            savedViews.push({ name: viewName, config: viewConfig });
            localStorage.setItem('savedViews', JSON.stringify(savedViews));
            
            showNotification(`Vista guardada como: ${viewName}`, 'success');
        }

        // PREMIUM EVENT LISTENERS SETUP
        document.addEventListener('DOMContentLoaded', function() {
            const loadingEl = document.getElementById('loading');
            
            try {
                // Initialize voice recognition
                const voiceSupported = initializeVoiceRecognition();
                if (!voiceSupported) {
                    console.warn('Reconocimiento de voz no soportado en este navegador');
                    document.getElementById('voiceCommandBtn').style.display = 'none';
                }
                
                // Initialize tabs
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        tabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        const centroId = document.getElementById('centroSelect').value;
                        updateTable(this.dataset.tab, centroId);
                        
                        showNotification(`Mostrando: ${this.textContent}`, 'info');
                    });
                });
                
                // Initialize chart tabs
                const chartTabs = document.querySelectorAll('.chart-tab');
                chartTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const card = this.closest('.dashboard-card');
                        const chartContainer = card.querySelector('.chart-container');
                        const chartId = chartContainer.querySelector('canvas').id;
                        
                        card.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        const chartType = this.dataset.chart;
                        const centroId = document.getElementById('centroSelect').value;
                        
                        try {
                            if (chartId === 'centrosSaludChart') {
                                destroyChart('centrosSalud');
                                charts.centrosSalud = createCentrosSaludChart(chartType);
                            } else if (chartId === 'sexDistributionChart') {
                                destroyChart('sexDistribution');
                                charts.sexDistribution = createSexDistributionChart(centroId, chartType);
                            } else if (chartId === 'ageGroupsBySexChart') {
                                destroyChart('ageGroupsBySex');
                                charts.ageGroupsBySex = createAgeGroupsBySexChart(centroId, chartType);
                            } else if (chartId === 'ageGroupDistributionChart') {
                                destroyChart('ageGroupDistribution');
                                charts.ageGroupDistribution = createAgeGroupDistributionChart(centroId, chartType);
                            } else if (chartId === 'populationTrendChart') {
                                destroyChart('populationTrend');
                                charts.populationTrend = createPopulationTrendChart(centroId, chartType);
                            }
                            
                            showNotification(`Gráfico cambiado a: ${chartType}`, 'info');
                        } catch (error) {
                            console.error('Error updating chart:', error);
                            showNotification('Error al cambiar tipo de gráfico', 'error');
                        }
                    });
                });
                
                // Initialize quick filters
                const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');
                quickFilterBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        applyQuickFilter(this.dataset.preset);
                    });
                });
                
                // Initialize main filter controls
                const applyFiltersBtn = document.getElementById('applyFiltersBtn');
                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', function() {
                        const centroId = document.getElementById('centroSelect').value;
                        const grupoEtario = document.getElementById('grupoEtarioSelect').value;
                        
                        if (grupoEtario === 'PERSONALIZADO') {
                            const customGroupBuilder = document.getElementById('customGroupBuilder');
                            if (customGroupBuilder) {
                                customGroupBuilder.style.display = 'block';
                                showNotification('Constructor de grupos personalizados activado', 'info');
                            }
                        } else {
                            updateCharts(centroId, grupoEtario);
                            updateActiveFilters();
                        }
                    });
                }
                
                // Reset filters button
                const resetFiltersBtn = document.getElementById('resetFiltersBtn');
                if (resetFiltersBtn) {
                    resetFiltersBtn.addEventListener('click', resetAllFilters);
                }
                
                // Save filters button
                const saveFiltersBtn = document.getElementById('saveFiltersBtn');
                if (saveFiltersBtn) {
                    saveFiltersBtn.addEventListener('click', saveCurrentView);
                }
                
                // Pyramid age grouping
                const piramideAgeGrouping = document.getElementById('piramideAgeGrouping');
                if (piramideAgeGrouping) {
                    piramideAgeGrouping.addEventListener('change', function() {
                        destroyChart('populationPyramid');
                        const grouping = parseInt(this.value);
                        const centroId = document.getElementById('centroSelect').value;
                        charts.populationPyramid = createPopulationPyramidChart(centroId, grouping);
                        
                        showNotification(`Pirámide actualizada: grupos de ${grouping} años`, 'info');
                    });
                }
                
                // Custom group builder
                const addGroupBtn = document.getElementById('addGroupBtn');
                const applyCustomGroupsBtn = document.getElementById('applyCustomGroupsBtn');
                const cancelCustomGroupsBtn = document.getElementById('cancelCustomGroupsBtn');
                
                if (addGroupBtn) {
                    addGroupBtn.addEventListener('click', function() {
                        const groupDefinitions = document.getElementById('groupDefinitions');
                        
                        const newGroup = document.createElement('div');
                        newGroup.className = 'group-row';
                        
                        newGroup.innerHTML = `
                            <div class="group-name">
                                <input type="text" placeholder="Nombre del grupo" class="group-name-input">
                            </div>
                            <div class="age-range">
                                <input type="number" class="range-input" min="0" max="99" value="0"> 
                                <span>a</span> 
                                <input type="number" class="range-input" min="0" max="99" value="0">
                                <span>años</span>
                            </div>
                            <button class="btn-secondary" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        groupDefinitions.appendChild(newGroup);
                        showNotification('Nuevo grupo añadido', 'info');
                    });
                }
                
                if (applyCustomGroupsBtn) {
                    applyCustomGroupsBtn.addEventListener('click', function() {
                        const groupRows = document.querySelectorAll('.group-row');
                        const customGroups = [];
                        
                        groupRows.forEach(row => {
                            const nameInput = row.querySelector('.group-name input') || row.querySelector('.group-name-input');
                            const rangeInputs = row.querySelectorAll('.range-input');
                            
                            if (nameInput && nameInput.value.trim() !== '' && 
                                rangeInputs.length >= 2 && rangeInputs[0].value !== '' && rangeInputs[1].value !== '') {
                                customGroups.push({
                                    name: nameInput.value.trim(),
                                    minAge: parseInt(rangeInputs[0].value),
                                    maxAge: parseInt(rangeInputs[1].value)
                                });
                            }
                        });
                        
                        if (customGroups.length > 0) {
                            // Process custom groups (this would require additional chart logic)
                            updateActiveFilters();
                            
                            const customGroupBuilder = document.getElementById('customGroupBuilder');
                            if (customGroupBuilder) {
                                customGroupBuilder.style.display = 'none';
                            }
                            
                            showNotification(`${customGroups.length} grupos personalizados aplicados`, 'success');
                        } else {
                            showNotification('Debe definir al menos un grupo válido', 'warning');
                        }
                    });
                }
                
                if (cancelCustomGroupsBtn) {
                    cancelCustomGroupsBtn.addEventListener('click', function() {
                        const customGroupBuilder = document.getElementById('customGroupBuilder');
                        if (customGroupBuilder) {
                            customGroupBuilder.style.display = 'none';
                        }
                        showNotification('Constructor de grupos cancelado', 'info');
                    });
                }
                
                // Export and print functionality
                const exportButton = document.getElementById('exportButton');
                const printButton = document.getElementById('printButton');
                
                if (exportButton) {
                    exportButton.addEventListener('click', function() {
                        try {
                            showNotification('Generando reporte PDF...', 'info');
                            
                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF();
                            
                            // Enhanced PDF generation
                            doc.setFontSize(20);
                            doc.setFont(undefined, 'bold');
                            doc.text('INFOGES - Tablero Poblacional Premium', 14, 20);
                            
                            doc.setFontSize(12);
                            doc.setFont(undefined, 'normal');
                            doc.text('Sistema Avanzado de Información Poblacional', 14, 30);
                            doc.text(`Fecha de generación: ${new Date().toLocaleDateString('es-CL')}`, 14, 40);
                            
                            const centroId = document.getElementById('centroSelect').value;
                            const centro = poblacionData.centros[centroId];
                            
                            doc.setFontSize(16);
                            doc.setFont(undefined, 'bold');
                            doc.text(`Análisis: ${centro.nombre}`, 14, 55);
                            
                            doc.setFontSize(12);
                            doc.setFont(undefined, 'normal');
                            
                            // Population summary
                            doc.text(`Población Total: ${formatNumber(centro.poblacionTotal)} habitantes`, 14, 70);
                            doc.text(`Hombres: ${formatNumber(centro.sexo.masculino)} (${getPercentage(centro.sexo.masculino, centro.poblacionTotal)}%)`, 14, 80);
                            doc.text(`Mujeres: ${formatNumber(centro.sexo.femenino)} (${getPercentage(centro.sexo.femenino, centro.poblacionTotal)}%)`, 14, 90);
                            
                            if (centro.cobertura) {
                                doc.text(`Cobertura territorial: ${centro.cobertura}`, 14, 100);
                            }
                            
                            // Age groups analysis
                            doc.setFontSize(14);
                            doc.setFont(undefined, 'bold');
                            doc.text('Distribución por Grupos Etarios', 14, 115);
                            
                            doc.setFontSize(11);
                            doc.setFont(undefined, 'normal');
                            doc.text(`• Infantil (0-9 años): ${formatNumber(centro.gruposEtarios.infantil.total)} (${getPercentage(centro.gruposEtarios.infantil.total, centro.poblacionTotal)}%)`, 14, 125);
                            doc.text(`• Adolescente (10-19 años): ${formatNumber(centro.gruposEtarios.adolescente.total)} (${getPercentage(centro.gruposEtarios.adolescente.total, centro.poblacionTotal)}%)`, 14, 135);
                            doc.text(`• Adulto (20-64 años): ${formatNumber(centro.gruposEtarios.adulto.total)} (${getPercentage(centro.gruposEtarios.adulto.total, centro.poblacionTotal)}%)`, 14, 145);
                            doc.text(`• Adulto Mayor (65+ años): ${formatNumber(centro.gruposEtarios.adultoMayor.total)} (${getPercentage(centro.gruposEtarios.adultoMayor.total, centro.poblacionTotal)}%)`, 14, 155);
                            
                            // Demographic indicators
                            if (centro.indicadores) {
                                doc.setFontSize(14);
                                doc.setFont(undefined, 'bold');
                                doc.text('Indicadores Demográficos', 14, 170);
                                
                                doc.setFontSize(11);
                                doc.setFont(undefined, 'normal');
                                doc.text(`• Índice de Dependencia Infantil: ${centro.indicadores.indiceDepInfantil}%`, 14, 180);
                                doc.text(`• Índice de Dependencia Senil: ${centro.indicadores.indiceDepSenil}%`, 14, 190);
                                doc.text(`• Razón de Sexos: ${centro.indicadores.razónSexos}`, 14, 200);
                                doc.text(`• Edad Mediana: ${centro.indicadores.edadMediana} años`, 14, 210);
                                doc.text(`• Proporción Adultos Mayores: ${centro.indicadores.proporciónAdultosMayores}%`, 14, 220);
                                
                                if (centro.indicadores.crecimientoAnual) {
                                    doc.text(`• Crecimiento Anual: ${centro.indicadores.crecimientoAnual}%`, 14, 230);
                                }
                            }
                            
                            // Footer
                            doc.setFontSize(8);
                            doc.setFont(undefined, 'italic');
                            doc.text('Generado por INFOGES - Sistema Premium de Análisis Poblacional', 14, 280);
                            doc.text('Datos basados en población inscrita validada - Ministerio de Salud', 14, 285);
                            
                            doc.save(`infoges_tablero_poblacional_${centroId}_${new Date().toISOString().split('T')[0]}.pdf`);
                            
                            showNotification('Reporte PDF generado exitosamente', 'success');
                        } catch (error) {
                            console.error('Error al exportar a PDF:', error);
                            showNotification('Error al generar PDF. Intente nuevamente.', 'error');
                        }
                    });
                }
                
                if (printButton) {
                    printButton.addEventListener('click', function() {
                        showNotification('Preparando impresión...', 'info');
                        setTimeout(() => {
                            window.print();
                        }, 500);
                    });
                }
                
                // Compare view functionality
                const compareButton = document.getElementById('compareButton');
                const closeCompareBtn = document.getElementById('closeCompareBtn');
                const compareMetric = document.getElementById('compareMetric');
                
                if (compareButton) {
                    compareButton.addEventListener('click', function() {
                        const compareView = document.getElementById('compareView');
                        if (compareView) {
                            compareView.style.display = 'block';
                            
                            if (compareMetric) {
                                generateComparisonCards(compareMetric.value);
                            }
                            
                            // Scroll to compare view
                            compareView.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                }
                
                if (closeCompareBtn) {
                    closeCompareBtn.addEventListener('click', function() {
                        const compareView = document.getElementById('compareView');
                        if (compareView) {
                            compareView.style.display = 'none';
                            showNotification('Vista de comparación cerrada', 'info');
                        }
                    });
                }
                
                if (compareMetric) {
                    compareMetric.addEventListener('change', function() {
                        generateComparisonCards(this.value);
                    });
                }
                
                // Voice command button
                const voiceCommandBtn = document.getElementById('voiceCommandBtn');
                if (voiceCommandBtn) {
                    voiceCommandBtn.addEventListener('click', function() {
                        if (isListening) {
                            recognition.stop();
                        } else {
                            startListening();
                        }
                    });
                }
                
                // Initialize charts with enhanced loading
                if (loadingEl) {
                    loadingEl.style.opacity = '0';
                    setTimeout(() => {
                        loadingEl.style.display = 'none';
                    }, 800);
                }
                
                setTimeout(() => {
                    try {
                        showNotification('Inicializando sistema premium...', 'info');
                        
                        charts.centrosSalud = createCentrosSaludChart();
                        charts.sexDistribution = createSexDistributionChart('COMUNAL');
                        charts.ageGroupsBySex = createAgeGroupsBySexChart('COMUNAL');
                        charts.populationPyramid = createPopulationPyramidChart('COMUNAL', 5);
                        charts.ageGroupDistribution = createAgeGroupDistributionChart('COMUNAL');
                        charts.populationTrend = createPopulationTrendChart('COMUNAL');
                        charts.ageHeatmap = createAgeHeatmapChart('COMUNAL');
                        
                        createResumenTable('COMUNAL');
                        updateActiveFilters();
                        
                        showNotification('Sistema INFOGES Premium inicializado correctamente', 'success');
                        console.log('🎉 INFOGES Premium - Sistema inicializado completamente');
                        
                    } catch (error) {
                        console.error('Error al inicializar el sistema:', error);
                        showNotification('Error durante la inicialización', 'error');
                    }
                }, 1000);
                
                // Global function assignments
                window.showDetails = showDetails;
                window.removeFilter = removeFilter;
                window.navigateToMetasSanitarias = navigateToMetasSanitarias;
                window.navigateToIAAPS = navigateToIAAPS;
                
            } catch (error) {
                console.error('Error durante la inicialización:', error);
                showNotification('Error crítico durante la inicialización', 'error');
            }
        });

        // ENHANCED CSS ANIMATIONS
        const additionalStyles = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            @keyframes fadeInUp {
                from {
                    transform: translateY(30px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            .dashboard-card {
                animation: fadeInUp 0.6s ease-out;
            }
            
            .dashboard-card:nth-child(1) { animation-delay: 0.1s; }
            .dashboard-card:nth-child(2) { animation-delay: 0.2s; }
            .dashboard-card:nth-child(3) { animation-delay: 0.3s; }
            .dashboard-card:nth-child(4) { animation-delay: 0.4s; }
            .dashboard-card:nth-child(5) { animation-delay: 0.5s; }
            .dashboard-card:nth-child(6) { animation-delay: 0.6s; }
            
            .hover-highlight:hover {
                background: linear-gradient(135deg, var(--primary)10, var(--secondary)10) !important;
                transform: translateX(4px);
                border-left: 4px solid var(--primary);
            }
        `;
        
        const styleElement = document.createElement('style');
        styleElement.textContent = additionalStyles;
        document.head.appendChild(styleElement);
        
        console.log('🚀 INFOGES Premium - Sistema de tablero poblacional cargado completamente');
            // Funciones para gestionar los modales y todas sus funcionalidades
    document.addEventListener('DOMContentLoaded', function() {
        // Referencias a elementos DOM
        const helpModal = document.getElementById('helpModal');
        const configModal = document.getElementById('configModal');
        const helpBtns = document.querySelectorAll('.header-btn');
        const closeButtons = document.querySelectorAll('.modal-close');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const cancelConfigBtn = document.getElementById('cancelConfigBtn');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        
        // Sistema de notificaciones mejorado
        const showCustomNotification = function(title, message, type = 'info', duration = null) {
            // Verificar si las notificaciones están desactivadas
            const screenNotificationsEnabled = localStorage.getItem('screenNotifications') !== 'false';
            
            if (!screenNotificationsEnabled) {
                console.log(`Notificación (${type}): ${title} - ${message}`);
                return;
            }
            
            // Verificar si este tipo de notificación está desactivado
            const typeEnabled = localStorage.getItem(`${type}Notifications`) !== 'false';
            if (!typeEnabled) {
                console.log(`Notificación (${type}) desactivada: ${title} - ${message}`);
                return;
            }
            
            // Eliminar notificaciones anteriores
            const existingNotifications = document.querySelectorAll('.custom-notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            // Crear nueva notificación
            const notification = document.createElement('div');
            notification.className = `custom-notification notification-${type}`;
            
            let iconClass = 'info-circle';
            if (type === 'success') iconClass = 'check-circle';
            if (type === 'warning') iconClass = 'exclamation-circle';
            if (type === 'error') iconClass = 'times-circle';
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-${iconClass}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Reproducir sonido si está activado
            const soundEnabled = localStorage.getItem('soundNotifications') === 'true';
            if (soundEnabled) {
                const audio = new Audio();
                if (type === 'success') audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAfdlRJVDIAAAAZAAAASW5mb0dlcyBTdWNjZXNzIFNvdW5kAAAA';
                if (type === 'error') audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAfdlRJVDIAAAAXAAAASW5mb0dlcyBFcnJvciBTb3VuZAAAAA==';
                if (type === 'info') audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAfdlRJVDIAAAAWAAAASW5mb0dlcyBJbmZvIFNvdW5kAAAA';
                if (type === 'warning') audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAfdlRJVDIAAAAZAAAASW5mb0dlcyBXYXJuaW5nIFNvdW5kAAAA';
                audio.play().catch(e => console.warn('No se pudo reproducir el sonido:', e));
            }
            
            // Mostrar con animación
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Obtener duración configurada
            const configuredDuration = parseInt(localStorage.getItem('notificationDuration') || '3000');
            const actualDuration = duration || configuredDuration;
            
            // Ocultar después del tiempo especificado
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, actualDuration);
            
            return notification;
        };
        
        // Función para mostrar un diálogo de confirmación
        const showConfirmDialog = function(title, message, onConfirm, onCancel = null) {
            // Crear overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            document.body.appendChild(overlay);
            
            // Crear diálogo
            const dialog = document.createElement('div');
            dialog.className = 'confirmation-modal';
            dialog.innerHTML = `
                <div class="confirmation-title">${title}</div>
                <div class="confirmation-message">${message}</div>
                <div class="confirmation-actions">
                    <button class="btn-secondary" id="cancelConfirmBtn">Cancelar</button>
                    <button class="btn-premium" id="confirmBtn">Confirmar</button>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // Manejar botones
            const cancelBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            
            cancelBtn.addEventListener('click', function() {
                dialog.remove();
                overlay.remove();
                if (onCancel) onCancel();
            });
            
            confirmBtn.addEventListener('click', function() {
                dialog.remove();
                overlay.remove();
                onConfirm();
            });
            
            return dialog;
        };
        
        // Mostrar modal de ayuda
        helpBtns[0].addEventListener('click', function(e) {
            e.preventDefault();
            helpModal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Evitar scroll en la página
            
            // Inicializar gráfico de ejemplo en la pestaña de gráficos
            setTimeout(() => {
                const exampleChartCanvas = document.getElementById('helpChartExample');
                if (exampleChartCanvas && window.Chart) {
                    new Chart(exampleChartCanvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Infantil', 'Adolescente', 'Adulto', 'Adulto Mayor'],
                            datasets: [{
                                data: [15, 20, 50, 15],
                                backgroundColor: [
                                    getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--info').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()
                                ],
                                borderWidth: 2,
                                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--surface').trim()
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        font: {
                                            size: 11,
                                            weight: 600
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                    titleColor: '#0f172a',
                                    bodyColor: '#0f172a',
                                    borderWidth: 1,
                                    borderColor: '#e2e8f0',
                                    cornerRadius: 8,
                                    boxPadding: 6,
                                    titleFont: {
                                        weight: 700
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.label}: ${context.raw}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 500);
        });
        
        // Mostrar modal de configuración
        helpBtns[1].addEventListener('click', function(e) {
            e.preventDefault();
            configModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Cargar configuraciones guardadas
            loadSavedSettings();
        });
        
        // Cerrar modales con botón X
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                helpModal.style.display = 'none';
                configModal.style.display = 'none';
                document.body.style.overflow = ''; // Restaurar scroll
            });
        });
        
        // Cerrar con botones específicos
        if (closeHelpBtn) {
            closeHelpBtn.addEventListener('click', function() {
                helpModal.style.display = 'none';
                document.body.style.overflow = '';
            });
        }
        
        if (cancelConfigBtn) {
            cancelConfigBtn.addEventListener('click', function() {
                configModal.style.display = 'none';
                document.body.style.overflow = '';
                showCustomNotification('Operación cancelada', 'Cambios no guardados', 'info');
            });
        }
        
        if (saveConfigBtn) {
            saveConfigBtn.addEventListener('click', function() {
                saveSettings();
                configModal.style.display = 'none';
                document.body.style.overflow = '';
                showCustomNotification('Configuración guardada', 'Cambios aplicados correctamente', 'success');
            });
        }
        
        // Cerrar modal al hacer clic fuera del contenido
        window.addEventListener('click', function(event) {
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
                document.body.style.overflow = '';
            }
            if (event.target === configModal) {
                configModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        
        // Gestión de pestañas en modal de ayuda
        const helpTabs = document.querySelectorAll('.help-tab');
        const helpPanels = document.querySelectorAll('.help-panel');
        
        helpTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                
                // Desactivar todas las pestañas
                helpTabs.forEach(t => t.classList.remove('active'));
                helpPanels.forEach(p => p.classList.remove('active'));
                
                // Activar pestaña seleccionada
                this.classList.add('active');
                document.getElementById(`${targetTab}-panel`).classList.add('active');
            });
        });
        
        // Gestión de pestañas en modal de configuración
        const configTabs = document.querySelectorAll('.config-tab');
        const configPanels = document.querySelectorAll('.config-panel');
        
        configTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                
                // Desactivar todas las pestañas
                configTabs.forEach(t => t.classList.remove('active'));
                configPanels.forEach(p => p.classList.remove('active'));
                
                // Activar pestaña seleccionada
                this.classList.add('active');
                document.getElementById(`${targetTab}-panel`).classList.add('active');
            });
        });
        
        // Función para aplicar cambios en tema
        function applyTheme(themeName) {
            // Remover todas las clases de tema anteriores
            document.body.classList.remove(
                'theme-ocean', 
                'theme-forest', 
                'theme-sunset', 
                'theme-lavender', 
                'theme-contrast'
            );
            
            // Aplicar nuevo tema si no es el predeterminado
            if (themeName !== 'default') {
                document.body.classList.add(`theme-${themeName}`);
            }
            
            // Actualizar gradientes y colores primarios en gráficos
            updateChartsColors();
            
            // Guardar preferencia
            localStorage.setItem('selectedTheme', themeName);
        }
        
        // Control de tema
        const themeOptions = document.querySelectorAll('.theme-option');
        
        themeOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remover clase active de todas las opciones
                themeOptions.forEach(opt => opt.classList.remove('active'));
                
                // Marcar la opción seleccionada
                this.classList.add('active');
                
                // Aplicar el tema seleccionado
                const theme = this.dataset.theme;
                applyTheme(theme);
                
                showCustomNotification('Tema cambiado', `Tema "${theme}" aplicado correctamente`, 'success');
            });
        });
        
        // Función para aplicar densidad
        function applyDensity(densityValue) {
            // Remover clases de densidad anteriores
            document.body.classList.remove('density-compact', 'density-comfortable');
            
            // Aplicar nueva densidad si no es la estándar
            if (densityValue !== 'standard') {
                document.body.classList.add(`density-${densityValue}`);
            }
            
            // Guardar preferencia
            localStorage.setItem('selectedDensity', densityValue);
        }
        
        // Control de densidad
        const densityRadios = document.querySelectorAll('input[name="density"]');
        densityRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    applyDensity(this.value);
                }
            });
        });
        
        // Control de tamaño de fuente
        const fontSizeRange = document.getElementById('fontSizeRange');
        const fontSizeValue = document.getElementById('fontSizeValue');
        
        if (fontSizeRange && fontSizeValue) {
            fontSizeRange.addEventListener('input', function() {
                fontSizeValue.textContent = `${this.value}%`;
                document.documentElement.style.setProperty('--font-size-base', `calc(16px * ${this.value / 100})`);
                
                // Actualizar tamaño en elementos existentes
                document.body.style.fontSize = `${this.value}%`;
                
                // Guardar preferencia
                localStorage.setItem('fontSize', this.value);
            });
        }
        
        // Control de opciones de datos
        const dataToggles = [
            'showAbsoluteValues',
            'showPercentages',
            'showTrends',
            'showProjections'
        ];
        
        dataToggles.forEach(toggleId => {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                toggle.addEventListener('change', function() {
                    localStorage.setItem(toggleId, this.checked);
                    updateChartDisplay();
                });
            }
        });
        
        // Control de precisión numérica
        const precisionRadios = document.querySelectorAll('input[name="precision"]');
        precisionRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    localStorage.setItem('numberPrecision', this.value);
                    updateNumberFormatting(parseInt(this.value));
                }
            });
        });
        
        // Función para actualizar formato de números
        function updateNumberFormatting(precision) {
            // Esta función actualizaría todos los números visualizados
            // Podría ser implementada para recorrer elementos con clase 'formatted-number'
            window.formatNumber = function(number) {
                return new Intl.NumberFormat('es-CL', {
                    maximumFractionDigits: precision
                }).format(number);
            };
            
            // Actualizar números formateados en la página
            document.querySelectorAll('.formatted-number').forEach(el => {
                const rawValue = parseFloat(el.dataset.value || el.textContent);
                if (!isNaN(rawValue)) {
                    el.textContent = formatNumber(rawValue);
                }
            });
            
            // Actualizar gráficos
            updateChartsLabels();
        }
        
        // Control de duración de notificaciones
        const notificationDurationRange = document.getElementById('notificationDurationRange');
        const notificationDurationValue = document.getElementById('notificationDurationValue');
        
        if (notificationDurationRange && notificationDurationValue) {
            notificationDurationRange.addEventListener('input', function() {
                const durationSeconds = parseInt(this.value);
                notificationDurationValue.textContent = `${durationSeconds} segundos`;
                localStorage.setItem('notificationDuration', durationSeconds * 1000);
            });
        }
        
        // Controles de notificación
        const notificationToggles = [
            'screenNotifications',
            'soundNotifications',
            'successNotifications',
            'infoNotifications',
            'warningNotifications',
            'errorNotifications'
        ];
        
        notificationToggles.forEach(toggleId => {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                toggle.addEventListener('change', function() {
                    localStorage.setItem(toggleId, this.checked);
                });
            }
        });
        
        // Botón para probar notificaciones
        const testNotificationBtn = document.getElementById('testNotificationBtn');
        if (testNotificationBtn) {
            testNotificationBtn.addEventListener('click', function() {
                const duration = parseInt(notificationDurationRange.value) * 1000;
                showCustomNotification(
                    'Notificación de prueba', 
                    'Esta es una notificación con la duración configurada.', 
                    'info',
                    duration
                );
            });
        }
        
        // Controles de accesibilidad
        const accessibilityToggles = {
            highContrastToggle: function(enabled) {
                if (enabled) {
                    document.body.classList.add('high-contrast');
                } else {
                    document.body.classList.remove('high-contrast');
                }
                localStorage.setItem('highContrast', enabled);
            },
            
            dyslexiaFontToggle: function(enabled) {
                if (enabled) {
                    document.body.classList.add('font-dyslexic');
                    // Intentar cargar la fuente si no está disponible
                    if (!document.getElementById('dyslexia-font')) {
                        const fontLink = document.createElement('link');
                        fontLink.id = 'dyslexia-font';
                        fontLink.rel = 'stylesheet';
                        fontLink.href = 'https://cdn.jsdelivr.net/npm/font-opendyslexic@1.0.3/open-dyslexic.min.css';
                        document.head.appendChild(fontLink);
                    }
                } else {
                    document.body.classList.remove('font-dyslexic');
                }
                localStorage.setItem('dyslexiaFont', enabled);
            },
            
            reducedMotionToggle: function(enabled) {
                if (enabled) {
                    document.body.classList.add('reduced-motion');
                } else {
                    document.body.classList.remove('reduced-motion');
                }
                localStorage.setItem('reducedMotion', enabled);
            },
            
            voiceCommandsToggle: function(enabled) {
                localStorage.setItem('voiceCommandsEnabled', enabled);
                // Habilitar/deshabilitar comandos de voz
                const voiceCommandBtn = document.getElementById('voiceCommandBtn');
                if (voiceCommandBtn) {
                    voiceCommandBtn.style.display = enabled ? 'flex' : 'none';
                }
            }
        };
        
        // Configurar los toggles de accesibilidad
        Object.keys(accessibilityToggles).forEach(toggleId => {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                toggle.addEventListener('change', function() {
                    accessibilityToggles[toggleId](this.checked);
                });
            }
        });
        
        // Control de idioma de reconocimiento de voz
        const voiceLanguageSelect = document.getElementById('voiceLanguageSelect');
        if (voiceLanguageSelect) {
            voiceLanguageSelect.addEventListener('change', function() {
                localStorage.setItem('voiceLanguage', this.value);
                // Actualizar idioma en el reconocimiento de voz
                if (window.recognition) {
                    window.recognition.lang = this.value;
                }
            });
        }
        
        // Prueba de reconocimiento de voz
        const testVoiceRecBtn = document.getElementById('testVoiceRecBtn');
        const testVoiceCommandBtn = document.getElementById('testVoiceCommandBtn');
        
        [testVoiceRecBtn, testVoiceCommandBtn].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', function() {
                    // Verificar soporte de reconocimiento de voz
                    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                        showCustomNotification('No compatible', 'Tu navegador no soporta reconocimiento de voz', 'error');
                        return;
                    }
                    
                    // Iniciar reconocimiento de voz
                    const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.lang = localStorage.getItem('voiceLanguage') || 'es-ES';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                    
                    recognition.onstart = function() {
                        showCustomNotification('Escuchando...', 'Di un comando de voz', 'info');
                        btn.innerHTML = '<i class="fas fa-microphone-slash"></i> Detener';
                        btn.classList.add('listening');
                    };
                    
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        showCustomNotification('Comando reconocido', `"${transcript}"`, 'success');
                        
                        // Simular procesamiento del comando
                        setTimeout(() => {
                            showCustomNotification('Comando ejecutado', 'Se procesó correctamente el comando de voz', 'success');
                        }, 1000);
                    };
                    
                    recognition.onerror = function(event) {
                        showCustomNotification('Error', `No se pudo reconocer: ${event.error}`, 'error');
                    };
                    
                    recognition.onend = function() {
                        btn.innerHTML = btn === testVoiceRecBtn ? 
                            '<i class="fas fa-microphone"></i> Probar Reconocimiento' :
                            '<i class="fas fa-microphone"></i> Probar Reconocimiento de Voz';
                        btn.classList.remove('listening');
                    };
                    
                    if (btn.classList.contains('listening')) {
                        recognition.abort();
                    } else {
                        recognition.start();
                    }
                });
            }
        });
        
        // Control de paleta de colores
        const colorSchemeRadios = document.querySelectorAll('input[name="colorScheme"]');
        colorSchemeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    localStorage.setItem('colorScheme', this.value);
                    updateChartColors(this.value);
                }
            });
        });
        
        // Función para actualizar colores de gráficos
        function updateChartColors(scheme) {
            let colors;
            
            switch(scheme) {
                case 'colorblind':
                    colors = ['#0072B2', '#E69F00', '#56B4E9', '#009E73', '#F0E442', '#D55E00', '#CC79A7', '#999999'];
                    break;
                case 'pastel':
                    colors = ['#8dd3c7', '#bebada', '#fb8072', '#80b1d3', '#fdb462', '#b3de69', '#fccde5', '#d9d9d9'];
                    break;
                default: // default
                    colors = [
                        getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--info').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--success').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--warning').trim()
                    ];
            }
            
            // Actualizar variables CSS
            document.documentElement.style.setProperty('--chart-color-1', colors[0]);
            document.documentElement.style.setProperty('--chart-color-2', colors[1]);
            document.documentElement.style.setProperty('--chart-color-3', colors[2]);
            document.documentElement.style.setProperty('--chart-color-4', colors[3]);
            
            // Actualizar colores en gráficos existentes
            updateChartsColors();
        }
        
        // Controles de rendimiento avanzado
        const highPerformanceToggle = document.getElementById('highPerformanceToggle');
        if (highPerformanceToggle) {
            highPerformanceToggle.addEventListener('change', function() {
                const enabled = this.checked;
                localStorage.setItem('highPerformance', enabled);
                
                if (enabled) {
                    document.body.classList.add('high-performance');
                    // Reducir efectos visuales
                    document.documentElement.style.setProperty('--animation-speed', '0.5');
                } else {
                    document.body.classList.remove('high-performance');
                    document.documentElement.style.setProperty('--animation-speed', '1');
                }
                
                // Notificar al usuario
                showCustomNotification(
                    enabled ? 'Modo alto rendimiento activado' : 'Modo normal activado',
                    enabled ? 'Se han reducido los efectos visuales' : 'Efectos visuales restaurados',
                    'info'
                );
            });
        }
        
        const dataPreloadToggle = document.getElementById('dataPreloadToggle');
        if (dataPreloadToggle) {
            dataPreloadToggle.addEventListener('change', function() {
                localStorage.setItem('dataPreload', this.checked);
            });
        }
        
        // Controles de exportación
        const exportFormatSelect = document.getElementById('exportFormatSelect');
        if (exportFormatSelect) {
            exportFormatSelect.addEventListener('change', function() {
                localStorage.setItem('defaultExportFormat', this.value);
            });
        }
        
const pdfQualitySelect = document.getElementById('pdfQualitySelect');
        if (pdfQualitySelect) {
            pdfQualitySelect.addEventListener('change', function() {
                localStorage.setItem('pdfQuality', this.value);
            });
        }
        
        // Controles de caché y datos
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        if (clearCacheBtn) {
            clearCacheBtn.addEventListener('click', function() {
                showConfirmDialog(
                    'Limpiar caché',
                    '¿Estás seguro de que deseas limpiar los datos en caché? Esto eliminará temporalmente datos guardados localmente, pero no afectará la configuración.',
                    function() {
                        // Simular limpieza de caché
                        setTimeout(() => {
                            // Actualizar información de caché
                            document.getElementById('cacheSize').textContent = '0 MB';
                            document.getElementById('lastCleanDate').textContent = new Date().toLocaleDateString();
                            
                            // Guardar fecha de limpieza
                            localStorage.setItem('lastCacheClean', new Date().toISOString());
                            localStorage.setItem('cacheSize', '0');
                            
                            showCustomNotification('Caché limpiada', 'Se han eliminado correctamente los datos en caché', 'success');
                        }, 1500);
                    }
                );
            });
        }
        
        const resetAllBtn = document.getElementById('resetAllBtn');
        if (resetAllBtn) {
            resetAllBtn.addEventListener('click', function() {
                showConfirmDialog(
                    'Restablecer configuración',
                    '¿Estás seguro de que deseas restablecer TODAS las configuraciones a valores predeterminados? Esta acción no se puede deshacer.',
                    function() {
                        // Eliminar todas las configuraciones guardadas
                        const keysToKeep = ['userPreferences']; // Mantener preferencias del usuario si existen
                        
                        Object.keys(localStorage).forEach(key => {
                            if (!keysToKeep.includes(key)) {
                                localStorage.removeItem(key);
                            }
                        });
                        
                        // Restaurar valores predeterminados
                        resetToDefaultSettings();
                        
                        // Actualizar UI con valores predeterminados
                        loadSavedSettings();
                        
                        showCustomNotification('Configuración restablecida', 'Todas las configuraciones han sido restauradas a valores predeterminados', 'success');
                    }
                );
            });
        }
        
        // Botón para verificar actualizaciones
        const checkUpdatesBtn = document.getElementById('checkUpdatesBtn');
        if (checkUpdatesBtn) {
            checkUpdatesBtn.addEventListener('click', function() {
                // Simular verificación de actualizaciones
                const updateCheckingNotification = showCustomNotification(
                    'Verificando actualizaciones', 
                    'Buscando nuevas actualizaciones de datos...', 
                    'info'
                );
                
                // Simular espera de red
                setTimeout(() => {
                    updateCheckingNotification.remove();
                    
                    // Simular resultado (sin actualizaciones)
                    showCustomNotification(
                        'Actualización de datos', 
                        'Los datos están actualizados. Última actualización: Septiembre 2024', 
                        'success'
                    );
                }, 2500);
            });
        }
        
        // Botón de demostración de exportación
        const demoExportBtn = document.getElementById('demoExportBtn');
        if (demoExportBtn) {
            demoExportBtn.addEventListener('click', function() {
                // Simular proceso de exportación
                const exportNotification = showCustomNotification(
                    'Generando PDF', 
                    'Preparando el informe de población...', 
                    'info'
                );
                
                // Simular progreso de exportación
                setTimeout(() => {
                    exportNotification.querySelector('.notification-message').textContent = 'Procesando gráficos y tablas...';
                }, 1000);
                
                setTimeout(() => {
                    exportNotification.querySelector('.notification-message').textContent = 'Generando documento final...';
                }, 2000);
                
                // Finalizar simulación
                setTimeout(() => {
                    exportNotification.remove();
                    
                    showCustomNotification(
                        'Exportación completada', 
                        'El informe ha sido generado correctamente', 
                        'success'
                    );
                    
                    // Simular descarga del archivo
                    const dummyLink = document.createElement('a');
                    dummyLink.setAttribute('download', `informe_demografico_demo_${new Date().toISOString().split('T')[0]}.pdf`);
                    dummyLink.setAttribute('href', 'javascript:void(0)');
                    dummyLink.click();
                }, 3000);
            });
        }
        
        // Botón de tutorial en video
        const playTutorialBtn = document.getElementById('playTutorialBtn');
        if (playTutorialBtn) {
            playTutorialBtn.addEventListener('click', function() {
                // Crear modal de video
                const videoModal = document.createElement('div');
                videoModal.className = 'video-tutorial-modal';
                
                videoModal.innerHTML = `
                    <button class="video-close"><i class="fas fa-times"></i></button>
                    <div class="video-container">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; color: white;">
                            <i class="fas fa-film" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 16px;">Tutorial INFOGES Premium</h3>
                            <p style="margin-bottom: 20px;">Este es un tutorial simulado para demostración.</p>
                            <div style="width: 100%; max-width: 400px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; margin-bottom: 10px;">
                                <div class="progress-bar" style="width: 0%; height: 100%; background: #00695c; border-radius: 4px; transition: width 3s linear;"></div>
                            </div>
                            <p class="progress-text">Cargando tutorial...</p>
                        </div>
                    </div>
                `;
                
                // Crear overlay
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                document.body.appendChild(overlay);
                document.body.appendChild(videoModal);
                
                // Animar barra de progreso
                setTimeout(() => {
                    const progressBar = videoModal.querySelector('.progress-bar');
                    const progressText = videoModal.querySelector('.progress-text');
                    progressBar.style.width = '100%';
                    
                    setTimeout(() => {
                        progressText.textContent = 'Tutorial cargado';
                    }, 2000);
                }, 100);
                
                // Cerrar video
                const closeBtn = videoModal.querySelector('.video-close');
                closeBtn.addEventListener('click', function() {
                    videoModal.remove();
                    overlay.remove();
                });
                
                // También cerrar al hacer clic en overlay
                overlay.addEventListener('click', function() {
                    videoModal.remove();
                    overlay.remove();
                });
            });
        }
        
        // Función para cargar configuraciones guardadas
        function loadSavedSettings() {
            // Cargar tema
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            themeOptions.forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === savedTheme) {
                    option.classList.add('active');
                }
            });
            applyTheme(savedTheme);
            
            // Cargar densidad
            const savedDensity = localStorage.getItem('selectedDensity') || 'standard';
            document.querySelectorAll('input[name="density"]').forEach(radio => {
                radio.checked = radio.value === savedDensity;
            });
            applyDensity(savedDensity);
            
            // Cargar tamaño de fuente
            const savedFontSize = localStorage.getItem('fontSize') || '100';
            if (fontSizeRange && fontSizeValue) {
                fontSizeRange.value = savedFontSize;
                fontSizeValue.textContent = `${savedFontSize}%`;
                document.body.style.fontSize = `${savedFontSize}%`;
            }
            
            // Cargar opciones de datos
            dataToggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.checked = localStorage.getItem(toggleId) !== 'false';
                }
            });
            
            // Cargar precisión numérica
            const savedPrecision = localStorage.getItem('numberPrecision') || '1';
            document.querySelectorAll('input[name="precision"]').forEach(radio => {
                radio.checked = radio.value === savedPrecision;
            });
            
            // Cargar duración de notificaciones
            const savedDuration = parseInt(localStorage.getItem('notificationDuration') || '3000') / 1000;
            if (notificationDurationRange && notificationDurationValue) {
                notificationDurationRange.value = savedDuration;
                notificationDurationValue.textContent = `${savedDuration} segundos`;
            }
            
            // Cargar opciones de notificación
            notificationToggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.checked = localStorage.getItem(toggleId) !== 'false';
                }
            });
            
            // Cargar opciones de accesibilidad
            const accessibilityOptions = {
                highContrastToggle: localStorage.getItem('highContrast') === 'true',
                dyslexiaFontToggle: localStorage.getItem('dyslexiaFont') === 'true',
                reducedMotionToggle: localStorage.getItem('reducedMotion') === 'true',
                voiceCommandsToggle: localStorage.getItem('voiceCommandsEnabled') !== 'false'
            };
            
            Object.keys(accessibilityOptions).forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.checked = accessibilityOptions[toggleId];
                    // Aplicar configuración
                    if (accessibilityToggles[toggleId]) {
                        accessibilityToggles[toggleId](accessibilityOptions[toggleId]);
                    }
                }
            });
            
            // Cargar idioma de reconocimiento de voz
            const savedLanguage = localStorage.getItem('voiceLanguage') || 'es-ES';
            if (voiceLanguageSelect) {
                voiceLanguageSelect.value = savedLanguage;
            }
            
            // Cargar esquema de color
            const savedColorScheme = localStorage.getItem('colorScheme') || 'default';
            document.querySelectorAll('input[name="colorScheme"]').forEach(radio => {
                radio.checked = radio.value === savedColorScheme;
            });
            
            // Cargar opciones avanzadas
            if (highPerformanceToggle) {
                highPerformanceToggle.checked = localStorage.getItem('highPerformance') === 'true';
                if (highPerformanceToggle.checked) {
                    document.body.classList.add('high-performance');
                    document.documentElement.style.setProperty('--animation-speed', '0.5');
                }
            }
            
            if (dataPreloadToggle) {
                dataPreloadToggle.checked = localStorage.getItem('dataPreload') !== 'false';
            }
            
            // Cargar opciones de exportación
            const savedExportFormat = localStorage.getItem('defaultExportFormat') || 'pdf';
            if (exportFormatSelect) {
                exportFormatSelect.value = savedExportFormat;
            }
            
            const savedPdfQuality = localStorage.getItem('pdfQuality') || 'medium';
            if (pdfQualitySelect) {
                pdfQualitySelect.value = savedPdfQuality;
            }
            
            // Cargar información de caché
            const lastCleanDate = localStorage.getItem('lastCacheClean');
            const cacheSize = localStorage.getItem('cacheSize') || '5.2';
            
            if (document.getElementById('lastCleanDate')) {
                document.getElementById('lastCleanDate').textContent = lastCleanDate ? 
                    new Date(lastCleanDate).toLocaleDateString() : 'Nunca';
            }
            
            if (document.getElementById('cacheSize')) {
                document.getElementById('cacheSize').textContent = `${cacheSize} MB`;
            }
        }
        
        // Función para restaurar valores predeterminados
        function resetToDefaultSettings() {
            // Establecer valores predeterminados
            const defaultSettings = {
                selectedTheme: 'default',
                selectedDensity: 'standard',
                fontSize: '100',
                showAbsoluteValues: true,
                showPercentages: true,
                showTrends: true,
                showProjections: true,
                numberPrecision: '1',
                notificationDuration: '3000',
                screenNotifications: true,
                soundNotifications: false,
                successNotifications: true,
                infoNotifications: true,
                warningNotifications: true,
                errorNotifications: true,
                highContrast: false,
                dyslexiaFont: false,
                reducedMotion: false,
                voiceCommandsEnabled: true,
                voiceLanguage: 'es-ES',
                colorScheme: 'default',
                highPerformance: false,
                dataPreload: true,
                defaultExportFormat: 'pdf',
                pdfQuality: 'medium'
            };
            
            // Guardar configuraciones predeterminadas
            Object.keys(defaultSettings).forEach(key => {
                localStorage.setItem(key, defaultSettings[key]);
            });
            
            // Remover clases y estilos
            document.body.classList.remove(
                'theme-ocean', 
                'theme-forest', 
                'theme-sunset', 
                'theme-lavender', 
                'theme-contrast',
                'density-compact', 
                'density-comfortable',
                'high-contrast',
                'font-dyslexic',
                'reduced-motion',
                'high-performance'
            );
            
            // Restaurar tamaño de fuente
            document.body.style.fontSize = '100%';
            
            // Restaurar velocidad de animación
            document.documentElement.style.setProperty('--animation-speed', '1');
        }
        
        // Función para guardar todas las configuraciones
        function saveSettings() {
            // Todas las configuraciones ya se guardan en sus respectivos manejadores de eventos
            // Esta función se podría usar para realizar validaciones o para guardar
            // configuraciones en un servidor en una implementación real
            
            // Aplicar configuraciones actuales
            const currentTheme = document.querySelector('.theme-option.active').dataset.theme;
            applyTheme(currentTheme);
            
            const currentDensity = document.querySelector('input[name="density"]:checked').value;
            applyDensity(currentDensity);
            
            const currentFontSize = fontSizeRange.value;
            document.body.style.fontSize = `${currentFontSize}%`;
            
            const currentPrecision = document.querySelector('input[name="precision"]:checked').value;
            updateNumberFormatting(parseInt(currentPrecision));
            
            const currentColorScheme = document.querySelector('input[name="colorScheme"]:checked').value;
            updateChartColors(currentColorScheme);
            
            // Aplicar otras configuraciones según corresponda
            
            // En una implementación real, se podrían guardar las configuraciones en un servidor
            console.log('Configuraciones guardadas:', {
                theme: currentTheme,
                density: currentDensity,
                fontSize: currentFontSize,
                precision: currentPrecision,
                colorScheme: currentColorScheme,
                // Otras configuraciones...
            });
        }
        
        // Función para actualizar colores en gráficos
        function updateChartsColors() {
            // En una implementación real, esta función recorrería los gráficos existentes
            // y actualizaría sus colores según la configuración actual
            
            if (window.Chart && window.charts) {
                // Ejemplo de actualización para un gráfico específico
                Object.values(window.charts).forEach(chart => {
                    if (chart && chart.options && chart.data) {
                        // Actualizar colores según el esquema seleccionado
                        const colorScheme = localStorage.getItem('colorScheme') || 'default';
                        let colors;
                        
                        switch(colorScheme) {
                            case 'colorblind':
                                colors = ['#0072B2', '#E69F00', '#56B4E9', '#009E73', '#F0E442', '#D55E00', '#CC79A7', '#999999'];
                                break;
                            case 'pastel':
                                colors = ['#8dd3c7', '#bebada', '#fb8072', '#80b1d3', '#fdb462', '#b3de69', '#fccde5', '#d9d9d9'];
                                break;
                            default: // default
                                colors = [
                                    getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--info').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--success').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--warning').trim()
                                ];
                        }
                        
                        // Aplicar colores a datasets
                        if (chart.data.datasets && chart.data.datasets.length > 0) {
                            chart.data.datasets.forEach((dataset, i) => {
                                if (dataset.backgroundColor && Array.isArray(dataset.backgroundColor)) {
                                    // Para gráficos de torta/dona
                                    dataset.backgroundColor = colors.slice(0, dataset.backgroundColor.length);
                                } else if (dataset.backgroundColor) {
                                    // Para gráficos de línea/barra con un solo color
                                    dataset.backgroundColor = colors[i % colors.length];
                                }
                                
                                if (dataset.borderColor) {
                                    dataset.borderColor = colors[i % colors.length];
                                }
                            });
                        }
                        
                        chart.update();
                    }
                });
            }
        }
        
        // Función para actualizar etiquetas en gráficos
        function updateChartsLabels() {
            // En una implementación real, esta función actualizaría los formatos de números
            // en las etiquetas de los gráficos
            
            if (window.Chart && window.charts) {
                const precision = parseInt(localStorage.getItem('numberPrecision') || '1');
                
                Object.values(window.charts).forEach(chart => {
                    if (chart && chart.options) {
                        if (chart.options.scales && chart.options.scales.y) {
                            chart.options.scales.y.ticks.callback = function(value) {
                                return new Intl.NumberFormat('es-CL', {
                                    maximumFractionDigits: precision
                                }).format(value);
                            };
                        }
                        
                        if (chart.options.plugins && chart.options.plugins.tooltip) {
                            const originalCallbacks = chart.options.plugins.tooltip.callbacks || {};
                            chart.options.plugins.tooltip.callbacks = {
                                ...originalCallbacks,
                                label: function(context) {
                                    if (originalCallbacks.label) {
                                        const result = originalCallbacks.label(context);
                                        if (typeof result === 'string') {
                                            return result.replace(/\d+(\.\d+)?/g, match => {
                                                return new Intl.NumberFormat('es-CL', {
                                                    maximumFractionDigits: precision
                                                }).format(parseFloat(match));
                                            });
                                        }
                                        return result;
                                    }
                                    
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += new Intl.NumberFormat('es-CL', {
                                        maximumFractionDigits: precision
                                    }).format(context.raw);
                                    return label;
                                }
                            };
                        }
                        
                        chart.update();
                    }
                });
            }
        }
        
        // Función para actualizar visualización de datos
        function updateChartDisplay() {
            // Esta función actualizaría la visibilidad de elementos según configuración
            
            const showValues = localStorage.getItem('showAbsoluteValues') !== 'false';
            const showPercentages = localStorage.getItem('showPercentages') !== 'false';
            const showTrends = localStorage.getItem('showTrends') !== 'false';
            const showProjections = localStorage.getItem('showProjections') !== 'false';
            
            // Actualizar elementos de valores absolutos
            document.querySelectorAll('.absolute-value').forEach(el => {
                el.style.display = showValues ? '' : 'none';
            });
            
            // Actualizar elementos de porcentajes
            document.querySelectorAll('.percentage-value').forEach(el => {
                el.style.display = showPercentages ? '' : 'none';
            });
            
            // Actualizar elementos de tendencias
            document.querySelectorAll('.trend-indicator').forEach(el => {
                el.style.display = showTrends ? '' : 'none';
            });
            
            // Actualizar elementos de proyecciones
            document.querySelectorAll('.projection-data').forEach(el => {
                el.style.display = showProjections ? '' : 'none';
            });
            
            // También se podrían actualizar los gráficos para mostrar/ocultar series
            if (window.charts) {
                Object.values(window.charts).forEach(chart => {
                    if (chart && chart.data && chart.data.datasets) {
                        // Ocultar datasets de proyecciones si corresponde
                        chart.data.datasets.forEach(dataset => {
                            if (dataset.label && dataset.label.includes('Proyección')) {
                                dataset.hidden = !showProjections;
                            }
                        });
                        chart.update();
                    }
                });
            }
        }
        
        // Inicializar configuraciones al cargar la página
        loadSavedSettings();
        
        // Exponer funciones útiles globalmente para uso en otros scripts
        window.infogesConfig = {
            showNotification: showCustomNotification,
            showConfirmDialog: showConfirmDialog,
            applyTheme: applyTheme,
            resetSettings: resetToDefaultSettings,
            updateChartColors: updateChartColors
        };
        
        console.log('🎛️ Sistema de configuración INFOGES inicializado correctamente');
    });

/**
 * SISTEMA COMPLETO DE EXPORTACIÓN DE REPORTES - INFOGES
 * 
 * Este sistema permite generar reportes profesionales en múltiples formatos (PDF, Excel, PowerPoint)
 * con vista previa, personalización completa y funcionalidades avanzadas.
 * 
 * Características principales:
 * - Exportación a PDF con html2canvas y jsPDF
 * - Generación de archivos Excel/CSV
 * - Creación de presentaciones HTML
 * - Vista previa en tiempo real
 * - Personalización de plantillas y contenido
 * - Sistema de notificaciones integrado
 */

 document.addEventListener('DOMContentLoaded', function() {
    // =================================================================
    // SECCIÓN 1: REFERENCIAS DOM Y VARIABLES GLOBALES
    // =================================================================
    
    // Referencias principales del modal de reportes
    const reportsModal = document.getElementById('reportsModal');
    const cancelExportBtn = document.getElementById('cancelExportBtn');
    const exportReportBtn = document.getElementById('exportReportBtn');
    const previewExportBtn = document.getElementById('previewExportBtn');
    
    // Controles de navegación de páginas
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageDots = document.querySelectorAll('.page-dot');
    const currentPageEl = document.getElementById('currentPage');
    const totalPagesEl = document.getElementById('totalPages');
    
    // Referencias a las páginas del reporte
    const reportPages = document.querySelectorAll('.report-page');
    
    // Elementos de personalización del reporte
    const reportTitle = document.getElementById('reportTitle');
    const reportTitlePreview = document.getElementById('reportTitlePreview');
    const logoUpload = document.getElementById('logoUpload');
    const previewLogo = document.getElementById('previewLogo');
    const includeCover = document.getElementById('includeCover');
    const imageQuality = document.getElementById('imageQuality');
    const includeWatermark = document.getElementById('includeWatermark');
    
    // Selectores de contenido y configuración
    const contentCheckboxes = document.querySelectorAll('.content-checkbox');
    const reportTypes = document.querySelectorAll('.report-type');
    const formatOptions = document.querySelectorAll('.format-option');
    const templateOptions = document.querySelectorAll('.template');

    // =================================================================
    // SECCIÓN 2: SISTEMA DE NOTIFICACIONES PROFESIONAL
    // =================================================================
    
    /**
     * Sistema de notificaciones integrado con configuraciones personalizadas
     * Soporta diferentes tipos, duraciones y efectos de sonido
     */
    function showCustomNotification(title, message, type = 'info', duration = null) {
        // Verificar configuraciones de usuario
        const screenNotificationsEnabled = localStorage.getItem('screenNotifications') !== 'false';
        
        if (!screenNotificationsEnabled) {
            console.log(`Notificación (${type}): ${title} - ${message}`);
            return;
        }
        
        // Verificar si el tipo específico está habilitado
        const typeEnabled = localStorage.getItem(`${type}Notifications`) !== 'false';
        if (!typeEnabled) {
            console.log(`Notificación (${type}) desactivada: ${title} - ${message}`);
            return;
        }
        
        // Eliminar notificaciones anteriores para evitar saturación
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => {
            notification.remove();
        });
        
        // Crear nueva notificación con estructura completa
        const notification = document.createElement('div');
        notification.className = `custom-notification notification-${type}`;
        
        // Seleccionar icono según el tipo de notificación
        let iconClass = 'info-circle';
        if (type === 'success') iconClass = 'check-circle';
        if (type === 'warning') iconClass = 'exclamation-circle';
        if (type === 'error') iconClass = 'times-circle';
        
        // Estructura HTML de la notificación
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="fas fa-${iconClass}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Reproducir sonido si está habilitado
        const soundEnabled = localStorage.getItem('soundNotifications') === 'true';
        if (soundEnabled) {
            const audio = new Audio();
            // Base64 simulado para diferentes tipos de sonido
            if (type === 'success') audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAfdlRJVDIAAAAZAAAASW5mb0dlcyBTdWNjZXNzIFNvdW5kAAAA';
            if (type === 'error') audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAfdlRJVDIAAAAXAAAASW5mb0dlcyBFcnJvciBTb3VuZAAAAA==';
            if (type === 'info') audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAfdlRJVDIAAAAWAAAASW5mb0dlcyBJbmZvIFNvdW5kAAAA';
            if (type === 'warning') audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAfdlRJVDIAAAAZAAAASW5mb0dlcyBXYXJuaW5nIFNvdW5kAAAA';
            audio.play().catch(e => console.warn('No se pudo reproducir el sonido:', e));
        }
        
        // Animación de entrada suave
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        // Configurar duración basada en preferencias del usuario
        const configuredDuration = parseInt(localStorage.getItem('notificationDuration') || '3000');
        const actualDuration = duration || configuredDuration;
        
        // Ocultar con animación después del tiempo especificado
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, actualDuration);
        
        return notification;
    }

    // =================================================================
    // SECCIÓN 3: GESTIÓN DE NAVEGACIÓN DE PÁGINAS
    // =================================================================
    
    /**
     * Función para mostrar una página específica del reporte
     * Maneja la navegación entre diferentes secciones del reporte
     */
    function showPage(pageNumber) {
        // Validación de límites de página
        const totalPages = reportPages.length;
        if (pageNumber < 1 || pageNumber > totalPages) return;
        
        // Ocultar todas las páginas actuales
        reportPages.forEach(page => page.classList.remove('active'));
        
        // Actualizar indicadores visuales de página (dots)
        pageDots.forEach(dot => {
            dot.classList.remove('active');
            if (parseInt(dot.dataset.page) === pageNumber) {
                dot.classList.add('active');
            }
        });
        
        // Mostrar la página seleccionada
        reportPages[pageNumber - 1].classList.add('active');
        
        // Actualizar contador numérico de página
        currentPageEl.textContent = pageNumber;
        
        // Gestionar estado de botones de navegación
        prevPageBtn.disabled = pageNumber === 1;
        nextPageBtn.disabled = pageNumber === totalPages;
    }
    
    /**
     * Función para actualizar el conteo total de páginas
     * Recalcula páginas visibles según el contenido seleccionado
     */
    function updatePageCount() {
        const visiblePages = document.querySelectorAll('.report-page.content-included').length;
        const pagesCountEl = document.getElementById('reportPagesCount');
        
        if (pagesCountEl) {
            pagesCountEl.textContent = `${visiblePages} páginas`;
        }
        totalPagesEl.textContent = visiblePages;
        
        // Regenerar indicadores de páginas (dots)
        const pageDots = document.getElementById('pageDots');
        pageDots.innerHTML = '';
        
        for (let i = 1; i <= visiblePages; i++) {
            const dot = document.createElement('span');
            dot.className = 'page-dot';
            if (i === parseInt(currentPageEl.textContent)) {
                dot.classList.add('active');
            }
            dot.dataset.page = i;
            dot.addEventListener('click', function() {
                showPage(parseInt(this.dataset.page));
            });
            pageDots.appendChild(dot);
        }
    }

    // =================================================================
    // SECCIÓN 4: FUNCIÓN PRINCIPAL DE EXPORTACIÓN
    // =================================================================
    
    /**
     * FUNCIÓN PRINCIPAL DE EXPORTACIÓN
     * 
     * Esta es la función central que maneja la exportación en todos los formatos.
     * Utiliza diferentes estrategias según el formato seleccionado:
     * - PDF: html2canvas + jsPDF para generar PDFs de alta calidad
     * - Excel: Generación de CSV con datos tabulares
     * - PowerPoint: Creación de HTML estructurado como presentación
     */
    function exportReport() {
        // Obtener configuración actual del usuario
        const formatOption = document.querySelector('.format-option.active');
        const format = formatOption ? formatOption.dataset.format : 'pdf';
        
        // Obtener título personalizado o usar predeterminado
        const title = reportTitle.value || 'Análisis Demográfico INFOGES';
        
        // Crear notificación de progreso inicial
        const exportingNotification = showCustomNotification(
            'Exportando reporte', 
            `Preparando ${format.toUpperCase()}...`, 
            'info'
        );
        
        // =============================================================
        // EXPORTACIÓN A PDF - La más compleja y profesional
        // =============================================================
        if (format === 'pdf') {
            // Verificar disponibilidad de jsPDF
            if (!window.jspdf) {
                exportingNotification.remove();
                showCustomNotification(
                    'Error de dependencias', 
                    'La librería jsPDF no está disponible. Verifica que esté cargada.', 
                    'error'
                );
                return;
            }
            
            const { jsPDF } = window.jspdf;
            
            // Crear documento PDF con configuración profesional
            // Orientación vertical (portrait), unidades en milímetros, tamaño A4
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Actualizar notificación para mostrar progreso
            exportingNotification.querySelector('.notification-message').textContent = 'Capturando páginas...';
            
            // Obtener todas las páginas que el usuario ha seleccionado para incluir
            const visiblePages = document.querySelectorAll('.report-page.content-included');
            let processedPages = 0;
            
            /**
             * Función recursiva para procesar cada página secuencialmente
             * Esto es importante para evitar problemas de renderizado simultáneo
             */
            function processPage(index) {
                // Condición de parada: hemos procesado todas las páginas
                if (index >= visiblePages.length) {
                    exportingNotification.remove();
                    showCustomNotification(
                        'Exportación completada', 
                        `El reporte "${title}" ha sido exportado en formato PDF`, 
                        'success'
                    );
                    
                    // Guardar y descargar el archivo PDF
                    const fileName = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    return;
                }
                
                // Actualizar progreso en la notificación
                exportingNotification.querySelector('.notification-message').textContent = 
                    `Procesando página ${index + 1} de ${visiblePages.length}...`;
                
                const page = visiblePages[index];
                
                // Preparar página para captura
                // Guardamos el estado original para restaurarlo después
                const originalDisplay = page.style.display;
                page.style.display = 'block';
                page.classList.add('active');
                
                // Usar html2canvas para capturar la página como imagen
                html2canvas(page, {
                    scale: 2,           // Mayor escala para mejor calidad
                    useCORS: true,      // Permitir recursos de otros dominios
                    allowTaint: true,   // Permitir imágenes "tainted"
                    backgroundColor: '#ffffff',  // Fondo blanco consistente
                    logging: false,     // Desactivar logs para performance
                    imageTimeout: 15000, // Timeout para cargar imágenes
                    removeContainer: true // Limpiar contenedores temporales
                }).then(canvas => {
                    // Añadir nueva página al PDF (excepto para la primera)
                    if (index > 0) {
                        doc.addPage();
                    }
                    
                    // Convertir canvas a imagen en formato JPEG con alta calidad
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // Calcular dimensiones para ajustar a página A4
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    
                    // Calcular proporción para mantener el aspecto original
                    const ratio = canvas.width / canvas.height;
                    let imgWidth = pageWidth;
                    let imgHeight = imgWidth / ratio;
                    
                    // Ajustar si la imagen es más alta que la página
                    if (imgHeight > pageHeight) {
                        imgHeight = pageHeight;
                        imgWidth = imgHeight * ratio;
                    }
                    
                    // Centrar la imagen en la página
                    const xOffset = (pageWidth - imgWidth) / 2;
                    const yOffset = (pageHeight - imgHeight) / 2;
                    
                    // Añadir imagen al PDF
                    doc.addImage(imgData, 'JPEG', xOffset, yOffset, imgWidth, imgHeight);
                    
                    // Restaurar estado original de la página
                    page.style.display = originalDisplay;
                    if (!originalDisplay.includes('active')) {
                        page.classList.remove('active');
                    }
                    
                    // Procesar siguiente página
                    processedPages++;
                    processPage(index + 1);
                    
                }).catch(error => {
                    console.error('Error al capturar página:', error);
                    exportingNotification.remove();
                    showCustomNotification(
                        'Error en exportación', 
                        'Hubo un problema al generar el PDF. Por favor intente nuevamente.', 
                        'error'
                    );
                });
            }
            
            // Iniciar el procesamiento con la primera página
            processPage(0);
        }
        
        // =============================================================
        // EXPORTACIÓN A EXCEL/CSV
        // =============================================================
        else if (format === 'excel') {
            // Simular proceso de exportación con retroalimentación visual
            setTimeout(() => {
                exportingNotification.querySelector('.notification-message').textContent = 'Preparando datos...';
            }, 800);
            
            setTimeout(() => {
                exportingNotification.querySelector('.notification-message').textContent = 'Generando archivo Excel...';
            }, 1600);
            
            setTimeout(() => {
                exportingNotification.remove();
                
                showCustomNotification(
                    'Exportación completada', 
                    `El reporte "${title}" ha sido exportado en formato Excel`, 
                    'success'
                );
                
                // Extraer datos de todas las tablas del reporte
                const tablesData = Array.from(document.querySelectorAll('.data-table')).map(table => {
                    // Extraer encabezados de la tabla
                    const headers = Array.from(table.querySelectorAll('th')).map(th => 
                        th.textContent.trim()
                    );
                    
                    // Extraer filas de datos
                    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
                        return Array.from(tr.querySelectorAll('td')).map(td => 
                            td.textContent.trim()
                        );
                    });
                    
                    // Crear formato CSV simple
                    let csv = headers.join(',') + '\n';
                    rows.forEach(row => {
                        // Escapar comas y comillas en los datos
                        const escapedRow = row.map(cell => {
                            if (cell.includes(',') || cell.includes('"')) {
                                return '"' + cell.replace(/"/g, '""') + '"';
                            }
                            return cell;
                        });
                        csv += escapedRow.join(',') + '\n';
                    });
                    
                    return csv;
                }).join('\n\n');
                
                // Crear y descargar archivo
                const blob = new Blob([tablesData], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Cerrar modal después de exportar
                closeReportsModal();
            }, 2500);
        }
        
        // =============================================================
        // EXPORTACIÓN A POWERPOINT/HTML
        // =============================================================
        else if (format === 'ppt') {
            // Simular proceso de creación de presentación
            setTimeout(() => {
                exportingNotification.querySelector('.notification-message').textContent = 'Preparando diapositivas...';
            }, 800);
            
            setTimeout(() => {
                exportingNotification.querySelector('.notification-message').textContent = 'Generando presentación...';
            }, 1600);
            
            setTimeout(() => {
                exportingNotification.remove();
                
                showCustomNotification(
                    'Exportación completada', 
                    `El reporte "${title}" ha sido exportado en formato PowerPoint`, 
                    'success'
                );
                
                // Crear documento HTML estructurado como presentación
                let htmlContent = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${title} - Presentación INFOGES</title>
                    <style>
                        body { 
                            font-family: 'Arial', sans-serif; 
                            margin: 0; 
                            padding: 0; 
                            background: #f5f5f5; 
                        }
                        .slide { 
                            page-break-after: always; 
                            padding: 60px; 
                            background: white;
                            margin: 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            min-height: 500px;
                        }
                        .slide:last-child { page-break-after: auto; }
                        h1 { 
                            color: #00695c; 
                            font-size: 2.5rem;
                            margin-bottom: 20px;
                            border-bottom: 3px solid #00695c;
                            padding-bottom: 10px;
                        }
                        h2 { 
                            color: #1e3a8a; 
                            font-size: 2rem;
                            margin-bottom: 15px;
                        }
                        h3 { 
                            color: #374151; 
                            font-size: 1.5rem;
                            margin-bottom: 10px;
                        }
                        .slide-content {
                            line-height: 1.6;
                            font-size: 1.1rem;
                        }
                        .footer {
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            font-size: 0.9rem;
                            color: #666;
                        }
                        @media print {
                            .slide { 
                                margin: 0; 
                                box-shadow: none; 
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="slide">
                        <h1>${title}</h1>
                        <h3>Presentación generada el ${new Date().toLocaleDateString('es-ES')}</h3>
                        <div class="slide-content">
                            <p><strong>Sistema:</strong> INFOGES Salud Curicó</p>
                            <p><strong>Tipo:</strong> Análisis Demográfico Avanzado</p>
                            <p><strong>Fecha de datos:</strong> Septiembre 2024</p>
                        </div>
                    </div>
                `;
                
                // Añadir diapositivas para cada sección incluida
                document.querySelectorAll('.report-page.content-included').forEach((page, index) => {
                    const pageTitle = page.querySelector('.page-title')?.textContent || `Sección ${index + 1}`;
                    const pageContent = page.querySelector('.page-content')?.textContent || 'Contenido de la sección';
                    
                    htmlContent += `
                    <div class="slide">
                        <h2>${pageTitle}</h2>
                        <div class="slide-content">
                            <p>${pageContent.substring(0, 500)}${pageContent.length > 500 ? '...' : ''}</p>
                        </div>
                    </div>
                    `;
                });
                
                // Cerrar documento HTML
                htmlContent += `
                    <div class="footer">
                        Generado por INFOGES Premium - ${new Date().toLocaleDateString('es-ES')}
                    </div>
                </body>
                </html>`;
                
                // Crear y descargar archivo
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Cerrar modal después de exportar
                closeReportsModal();
            }, 2500);
        }
    }

    // =================================================================
    // SECCIÓN 5: VISTA PREVIA AVANZADA
    // =================================================================
    
    /**
     * Función para generar vista previa completa del reporte
     * Crea un modal a pantalla completa con todas las páginas visibles
     */
   /**
 * FUNCIÓN DE VISTA PREVIA MEJORADA CON CONTENIDO REAL
 * 
 * Esta función soluciona el problema de las páginas vacías capturando
 * correctamente los gráficos, datos y estilos para mostrar el contenido
 * real en la vista previa.
 */

function generateFullPreviewWithRealContent() {
    // Crear modal de vista previa
    const previewModal = document.createElement('div');
    previewModal.className = 'modal-overlay';
    previewModal.style.zIndex = '3000';
    
    const previewContent = document.createElement('div');
    previewContent.className = 'preview-export-container';
    previewContent.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        height: 90%;
        background: white;
        border-radius: 12px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    `;
    
    // Crear encabezado del preview
    const previewHeader = document.createElement('div');
    previewHeader.style.cssText = `
        padding: 16px 24px;
        background: linear-gradient(135deg, #00695c 0%, #1e3a8a 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    `;

    const previewTitle = document.createElement('h3');
    previewTitle.style.cssText = `
        font-family: 'Poppins', sans-serif;
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0;
    `;
    previewTitle.textContent = `Vista Previa: ${reportTitle?.value || 'Análisis Demográfico INFOGES'}`;

    const closePreviewBtn = document.createElement('button');
    closePreviewBtn.style.cssText = `
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    `;
    closePreviewBtn.innerHTML = '<i class="fas fa-times"></i>';
    closePreviewBtn.addEventListener('click', function() {
        document.body.removeChild(previewModal);
    });

    previewHeader.appendChild(previewTitle);
    previewHeader.appendChild(closePreviewBtn);
    previewContent.appendChild(previewHeader);

    // Crear contenido del preview con indicador de carga
    const previewBody = document.createElement('div');
    previewBody.style.cssText = `
        flex: 1;
        overflow: auto;
        padding: 30px;
        background: #e2e8f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
    `;

    // Mostrar indicador de carga inicial
    const loadingIndicator = document.createElement('div');
    loadingIndicator.style.cssText = `
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px;
        color: #64748b;
    `;
    loadingIndicator.innerHTML = `
        <div style="width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #00695c; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
        <p style="margin: 0; font-weight: 600;">Generando vista previa con datos reales...</p>
        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">Capturando gráficos y contenido</p>
    `;
    previewBody.appendChild(loadingIndicator);

    // Agregar la animación de spin
    const spinStyle = document.createElement('style');
    spinStyle.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(spinStyle);

    previewContent.appendChild(previewBody);

    // Crear pie del preview con controles
    const previewFooter = document.createElement('div');
    previewFooter.style.cssText = `
        padding: 16px 24px;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    `;

    const visiblePages = document.querySelectorAll('.report-page.content-included');
    const previewInfo = document.createElement('div');
    previewInfo.style.cssText = `
        font-size: 0.9rem;
        color: #64748b;
    `;
    previewInfo.textContent = `${visiblePages.length} páginas - Formato: ${document.querySelector('.format-option.active')?.dataset.format.toUpperCase() || 'PDF'}`;

    const previewActions = document.createElement('div');
    previewActions.style.cssText = `
        display: flex;
        gap: 12px;
    `;

    // Botón de impresión
    const printPreviewBtn = document.createElement('button');
    printPreviewBtn.className = 'btn-secondary';
    printPreviewBtn.innerHTML = '<i class="fas fa-print"></i> Imprimir';
    printPreviewBtn.addEventListener('click', function() {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>${reportTitle?.value || 'Análisis Demográfico INFOGES'}</title>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: white; }
                    .page { page-break-after: always; margin-bottom: 30px; padding: 20px; }
                    .page:last-child { page-break-after: auto; }
                    @media print {
                        body { margin: 0; padding: 0; }
                        .page { margin: 0; padding: 20px; page-break-inside: avoid; }
                    }
                </style>
            </head>
            <body>
                ${previewBody.innerHTML}
            </body>
            </html>
        `);
        printWindow.document.close();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 1000);
    });

    // Botón de exportación
    const exportPreviewBtn = document.createElement('button');
    exportPreviewBtn.className = 'btn-premium';
    exportPreviewBtn.innerHTML = '<i class="fas fa-file-export"></i> Exportar';
    exportPreviewBtn.addEventListener('click', function() {
        document.body.removeChild(previewModal);
        exportReport();
    });

    previewActions.appendChild(printPreviewBtn);
    previewActions.appendChild(exportPreviewBtn);
    previewFooter.appendChild(previewInfo);
    previewFooter.appendChild(previewActions);
    previewContent.appendChild(previewFooter);

    previewModal.appendChild(previewContent);
    document.body.appendChild(previewModal);

    // AQUÍ ESTÁ LA MAGIA: Procesar páginas con contenido real
    processRealContentPages(previewBody, loadingIndicator, visiblePages);

    // Animación de entrada
    previewContent.style.animation = 'fadeIn 0.3s ease';
}

/**
 * FUNCIÓN PRINCIPAL PARA PROCESAR CONTENIDO REAL
 * 
 * Esta función maneja la captura de gráficos, preservación de estilos
 * y clonado correcto del contenido para la vista previa.
 */
async function processRealContentPages(previewBody, loadingIndicator, visiblePages) {
    try {
        // Limpiar el indicador de carga
        previewBody.innerHTML = '';
        
        // Procesar cada página secuencialmente para mantener el orden
        for (let i = 0; i < visiblePages.length; i++) {
            const page = visiblePages[i];
            
            // Actualizar indicador de progreso si existe
            if (loadingIndicator && loadingIndicator.parentNode) {
                loadingIndicator.querySelector('p:last-child').textContent = 
                    `Procesando página ${i + 1} de ${visiblePages.length}...`;
            }
            
            const processedPage = await createRealContentPage(page, i + 1);
            previewBody.appendChild(processedPage);
            
            // Pequeña pausa para permitir renderizado
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Eliminar indicador de carga si aún existe
        if (loadingIndicator && loadingIndicator.parentNode) {
            loadingIndicator.remove();
        }
        
    } catch (error) {
        console.error('Error procesando contenido real:', error);
        
        // Mostrar mensaje de error en caso de falla
        previewBody.innerHTML = `
            <div style="text-align: center; padding: 60px; color: #dc2626;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h3>Error al generar vista previa</h3>
                <p>Hubo un problema al procesar el contenido. La exportación seguirá funcionando correctamente.</p>
            </div>
        `;
    }
}

/**
 * FUNCIÓN PARA CREAR UNA PÁGINA CON CONTENIDO REAL
 * 
 * Esta función es el corazón de la solución. Clona correctamente
 * el contenido, captura gráficos como imágenes y preserva estilos.
 */
async function createRealContentPage(originalPage, pageNumber) {
    // Crear contenedor para la página procesada
    const pageContainer = document.createElement('div');
    pageContainer.style.cssText = `
        width: 100%;
        max-width: 800px;
        min-height: 600px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow: hidden;
        position: relative;
    `;
    
    // Agregar número de página como overlay
    const pageNumberOverlay = document.createElement('div');
    pageNumberOverlay.style.cssText = `
        position: absolute;
        top: 10px;
        right: 15px;
        background: rgba(0, 105, 92, 0.8);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 10;
    `;
    pageNumberOverlay.textContent = `Página ${pageNumber}`;
    pageContainer.appendChild(pageNumberOverlay);
    
    // Crear el contenido de la página
    const pageContent = document.createElement('div');
    pageContent.style.cssText = `
        padding: 40px;
        position: relative;
    `;
    
    // PASO 1: Clonar la estructura básica
    const pageClone = originalPage.cloneNode(true);
    
    // PASO 2: Copiar estilos computados importantes
    const originalStyles = window.getComputedStyle(originalPage);
    pageClone.style.display = 'block';
    pageClone.style.visibility = 'visible';
    pageClone.style.fontFamily = originalStyles.fontFamily || "'Inter', sans-serif";
    pageClone.style.fontSize = originalStyles.fontSize || '14px';
    pageClone.style.color = originalStyles.color || '#1f2937';
    pageClone.style.lineHeight = originalStyles.lineHeight || '1.6';
    
    // PASO 3: Procesar elementos hijos para preservar estilos
    const allClonedElements = pageClone.querySelectorAll('*');
    const allOriginalElements = originalPage.querySelectorAll('*');
    
    allClonedElements.forEach((element, index) => {
        if (allOriginalElements[index]) {
            const origStyle = window.getComputedStyle(allOriginalElements[index]);
            
            // Copiar estilos críticos
            element.style.color = origStyle.color;
            element.style.backgroundColor = origStyle.backgroundColor;
            element.style.fontSize = origStyle.fontSize;
            element.style.fontWeight = origStyle.fontWeight;
            element.style.textAlign = origStyle.textAlign;
            element.style.padding = origStyle.padding;
            element.style.margin = origStyle.margin;
            element.style.border = origStyle.border;
            element.style.borderRadius = origStyle.borderRadius;
            element.style.display = origStyle.display;
            
            // Preservar colores de fondo y gradientes
            if (origStyle.background && origStyle.background !== 'rgba(0, 0, 0, 0)') {
                element.style.background = origStyle.background;
            }
        }
    });
    
    // PASO 4: CAPTURAR GRÁFICOS COMO IMÁGENES ESTÁTICAS
    const canvasElements = pageClone.querySelectorAll('canvas');
    const originalCanvasElements = originalPage.querySelectorAll('canvas');
    
    for (let i = 0; i < canvasElements.length; i++) {
        const clonedCanvas = canvasElements[i];
        const originalCanvas = originalCanvasElements[i];
        
        if (originalCanvas && originalCanvas.width > 0 && originalCanvas.height > 0) {
            try {
                // Crear imagen estática del gráfico
                const chartImage = document.createElement('img');
                chartImage.src = originalCanvas.toDataURL('image/png', 1.0);
                chartImage.style.cssText = `
                    width: ${originalCanvas.style.width || originalCanvas.width + 'px'};
                    height: ${originalCanvas.style.height || originalCanvas.height + 'px'};
                    max-width: 100%;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                `;
                
                // Reemplazar canvas con imagen
                clonedCanvas.parentNode.replaceChild(chartImage, clonedCanvas);
                
            } catch (error) {
                console.warn('No se pudo capturar gráfico:', error);
                
                // Crear placeholder si falla la captura
                const placeholder = document.createElement('div');
                placeholder.style.cssText = `
                    width: ${originalCanvas.style.width || '400px'};
                    height: ${originalCanvas.style.height || '300px'};
                    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
                    border: 2px dashed #cbd5e1;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #64748b;
                    font-weight: 600;
                    text-align: center;
                    padding: 20px;
                `;
                placeholder.innerHTML = `
                    <div>
                        <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        Gráfico ${i + 1}
                        <div style="font-size: 0.8rem; margin-top: 5px; font-weight: normal;">
                            Se mostrará en la exportación final
                        </div>
                    </div>
                `;
                
                clonedCanvas.parentNode.replaceChild(placeholder, clonedCanvas);
            }
        }
    }
    
    // PASO 5: Procesar tablas para mejorar su apariencia
    const tables = pageClone.querySelectorAll('table');
    tables.forEach(table => {
        table.style.cssText = `
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        `;
        
        // Estilizar encabezados de tabla
        const headers = table.querySelectorAll('th');
        headers.forEach(header => {
            header.style.cssText = `
                background: linear-gradient(135deg, #00695c 0%, #1e3a8a 100%);
                color: white;
                padding: 12px 16px;
                font-weight: 600;
                text-align: left;
                border: none;
            `;
        });
        
        // Estilizar celdas de datos
        const cells = table.querySelectorAll('td');
        cells.forEach((cell, index) => {
            cell.style.cssText = `
                padding: 12px 16px;
                border-bottom: 1px solid #e2e8f0;
                background: ${index % 2 === 0 ? '#ffffff' : '#f8fafc'};
            `;
        });
    });
    
    // PASO 6: Mejorar títulos y encabezados
    const headings = pageClone.querySelectorAll('h1, h2, h3, h4, h5, h6');
    headings.forEach((heading, index) => {
        const level = parseInt(heading.tagName.substring(1));
        heading.style.cssText = `
            color: ${level <= 2 ? '#00695c' : '#1e293b'};
            font-family: 'Poppins', sans-serif;
            font-weight: ${level <= 2 ? '700' : '600'};
            margin: ${level === 1 ? '0 0 30px 0' : '24px 0 16px 0'};
            padding-bottom: ${level <= 2 ? '8px' : '0'};
            border-bottom: ${level <= 2 ? '2px solid #e2e8f0' : 'none'};
        `;
    });
    
    // PASO 7: Si no hay contenido visible, agregar contenido de muestra
    if (pageClone.textContent.trim() === '') {
        pageClone.innerHTML = createSampleContent(pageNumber);
    }
    
    // Agregar el contenido clonado al contenedor
    pageContent.appendChild(pageClone);
    pageContainer.appendChild(pageContent);
    
    return pageContainer;
}

/**
 * FUNCIÓN PARA CREAR CONTENIDO DE MUESTRA
 * 
 * Se usa cuando una página está marcada como incluida pero no tiene contenido visible.
 */
function createSampleContent(pageNumber) {
    const sampleTitles = [
        'Resumen Ejecutivo',
        'Indicadores Demográficos Clave',
        'Distribución por Grupos Etarios',
        'Análisis por Sexo',
        'Tendencias Poblacionales',
        'Conclusiones y Recomendaciones'
    ];
    
    const title = sampleTitles[pageNumber - 1] || `Sección ${pageNumber}`;
    
    return `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #00695c 0%, #1e3a8a 100%); border-radius: 50%; margin: 0 auto 30px auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                <i class="fas fa-chart-line"></i>
            </div>
            <h2 style="color: #00695c; margin-bottom: 20px; font-family: 'Poppins', sans-serif;">${title}</h2>
            <p style="color: #64748b; max-width: 500px; margin: 0 auto 30px auto; line-height: 1.6;">
                Esta sección contendrá análisis detallado de datos demográficos, gráficos interactivos 
                y métricas clave según la configuración seleccionada en el generador de reportes.
            </p>
            <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; padding: 30px; margin: 20px 0; border-left: 4px solid #00695c;">
                <h4 style="color: #1e293b; margin-bottom: 15px;">Contenido Esperado:</h4>
                <ul style="text-align: left; color: #64748b; max-width: 400px; margin: 0 auto;">
                    <li>Gráficos y visualizaciones de datos</li>
                    <li>Tablas con indicadores específicos</li>
                    <li>Análisis comparativo y tendencias</li>
                    <li>Métricas poblacionales detalladas</li>
                </ul>
            </div>
            <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <p style="margin: 0; font-size: 0.9rem; color: #64748b; font-style: italic;">
                    Los datos reales y gráficos se generarán automáticamente durante la exportación final del reporte.
                </p>
            </div>
        </div>
    `;
}

// FUNCIÓN PARA REEMPLAZAR LA ORIGINAL
// Simplemente cambia el nombre de la función en tu event listener:
if (previewExportBtn) {
    previewExportBtn.addEventListener('click', generateFullPreviewWithRealContent);
}
    // =================================================================
    // SECCIÓN 6: GESTIÓN DE PLANTILLAS Y PERSONALIZACIÓN
    // =================================================================
    
    /**
     * Configuración avanzada de plantillas de reporte
     * Cada plantilla define colores, estilos y estructura visual
     */
    function applyReportTemplate(templateName) {
        const reportCover = document.querySelector('.report-cover');
        const pageHeaders = document.querySelectorAll('.page-header');
        
        if (!reportCover) return;
        
        // Definir configuraciones de plantillas
        const templateConfigs = {
            'modern': {
                coverBackground: 'linear-gradient(135deg, #00695c 0%, #1e3a8a 100%)',
                headerBackground: '#f8fafc',
                accentColor: '#00695c',
                textColor: '#ffffff'
            },
            'classic': {
                coverBackground: 'linear-gradient(135deg, #334155 0%, #1e293b 100%)',
                headerBackground: '#f1f5f9',
                accentColor: '#334155',
                textColor: '#ffffff'
            },
            'vibrant': {
                coverBackground: 'linear-gradient(135deg, #7e57c2 0%, #4527a0 100%)',
                headerBackground: '#f5f3ff',
                accentColor: '#7e57c2',
                textColor: '#ffffff'
            },
            'minimal': {
                coverBackground: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
                headerBackground: '#ffffff',
                accentColor: '#0f172a',
                textColor: '#0f172a'
            }
        };
        
        const config = templateConfigs[templateName];
        if (!config) return;
        
        // Aplicar estilos de la plantilla
        reportCover.style.background = config.coverBackground;
        reportCover.style.color = config.textColor;
        
        pageHeaders.forEach(header => {
            header.style.background = config.headerBackground;
        });
        
        // Actualizar colores de acento en elementos dinámicos
        document.documentElement.style.setProperty('--report-accent-color', config.accentColor);
        
        showCustomNotification(
            'Plantilla aplicada', 
            `Se ha aplicado la plantilla: ${templateName.charAt(0).toUpperCase() + templateName.slice(1)}`, 
            'success'
        );
    }

    // =================================================================
    // SECCIÓN 7: FUNCIONES DE UTILIDAD Y GESTIÓN DEL MODAL
    // =================================================================
    
    /**
     * Función para mostrar el modal principal de reportes
     */
    function showReportsModal() {
        if (reportsModal) {
            reportsModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Inicializar vista previa
            showPage(1);
            updatePageCount();
        }
    }
    
    /**
     * Función para cerrar el modal de reportes
     */
    function closeReportsModal() {
        if (reportsModal) {
            reportsModal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }
    
    /**
     * Crear botón flotante para acceder al sistema de reportes
     */
    function createReportButton() {
        // Verificar si ya existe para evitar duplicados
        if (document.getElementById('openReportsBtn')) return;
        
        const reportBtn = document.createElement('button');
        reportBtn.id = 'openReportsBtn';
        reportBtn.className = 'report-floating-btn';
        reportBtn.innerHTML = '<i class="fas fa-file-export"></i>';
        reportBtn.title = 'Generar Reporte';
        
        // Estilos del botón flotante
        reportBtn.style.cssText = `
            position: fixed;
            bottom: 32px;
            right: 120px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00695c 0%, #1e3a8a 100%);
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 990;
            border: none;
            transition: all 0.3s ease;
        `;
        
        // Efectos de hover
        reportBtn.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
        });
        
        reportBtn.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
        
        // Acción principal
        reportBtn.addEventListener('click', showReportsModal);
        
        document.body.appendChild(reportBtn);
    }

    // =================================================================
    // SECCIÓN 8: EVENT LISTENERS Y CONFIGURACIÓN INICIAL
    // =================================================================
    
    // Navegación de páginas
    if (prevPageBtn) {
        prevPageBtn.addEventListener('click', function() {
            const currentPage = parseInt(currentPageEl.textContent);
            showPage(currentPage - 1);
        });
    }
    
    if (nextPageBtn) {
        nextPageBtn.addEventListener('click', function() {
            const currentPage = parseInt(currentPageEl.textContent);
            showPage(currentPage + 1);
        });
    }
    
    // Dots de paginación
    pageDots.forEach(dot => {
        dot.addEventListener('click', function() {
            const pageNumber = parseInt(this.dataset.page);
            showPage(pageNumber);
        });
    });
    
    // Actualización de título en tiempo real
    if (reportTitle && reportTitlePreview) {
        reportTitle.addEventListener('input', function() {
            reportTitlePreview.textContent = this.value || 'Análisis Demográfico INFOGES';
        });
    }
    
    // Subida de logo personalizado
    if (logoUpload && previewLogo) {
        logoUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.match('image.*')) {
                    showCustomNotification('Error', 'Por favor selecciona un archivo de imagen válido', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewLogo.src = e.target.result;
                    showCustomNotification('Logo actualizado', 'El logo se ha actualizado correctamente', 'success');
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Configuración de contenido del reporte
    contentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const contentType = this.dataset.content;
            const contentPage = document.querySelector(`.report-page[data-page="${contentType}"]`);
            
            if (contentPage) {
                if (this.checked) {
                    contentPage.classList.add('content-included');
                } else {
                    contentPage.classList.remove('content-included');
                    contentPage.classList.remove('active');
                }
                updatePageCount();
            }
        });
    });
    
    // Selección de tipo de reporte
    reportTypes.forEach(reportType => {
        reportType.addEventListener('click', function() {
            reportTypes.forEach(type => type.classList.remove('active'));
            this.classList.add('active');
            
            const type = this.dataset.type;
            
            // Configurar contenido según tipo de reporte
            const contentConfig = {
                'executive': ['summary', 'keyIndicators', 'genderDistribution'],
                'detailed': ['summary', 'keyIndicators', 'ageGroups', 'genderDistribution', 'trends', 'appendix'],
                'comparative': ['summary', 'keyIndicators', 'trends'],
                'demographic': ['ageGroups', 'genderDistribution', 'keyIndicators']
            };
            
            const activeContent = contentConfig[type] || [];
            
            contentCheckboxes.forEach(checkbox => {
                checkbox.checked = activeContent.includes(checkbox.dataset.content);
                const contentPage = document.querySelector(`.report-page[data-page="${checkbox.dataset.content}"]`);
                if (contentPage) {
                    if (checkbox.checked) {
                        contentPage.classList.add('content-included');
                    } else {
                        contentPage.classList.remove('content-included');
                    }
                }
            });
            
            updatePageCount();
            showPage(1);
            
            showCustomNotification(
                'Tipo de reporte cambiado', 
                `Se ha seleccionado: ${type.charAt(0).toUpperCase() + type.slice(1)}`, 
                'success'
            );
        });
    });
    
    // Selección de formato de exportación
    formatOptions.forEach(option => {
        option.addEventListener('click', function() {
            formatOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            const format = this.dataset.format;
            const exportBtn = document.getElementById('exportReportBtn');
            
            if (exportBtn) {
                const formatLabels = {
                    'pdf': '<i class="fas fa-file-pdf"></i> Exportar a PDF',
                    'excel': '<i class="fas fa-file-excel"></i> Exportar a Excel',
                    'ppt': '<i class="fas fa-file-powerpoint"></i> Exportar a PowerPoint'
                };
                exportBtn.innerHTML = formatLabels[format];
            }
            
            showCustomNotification('Formato cambiado', `Se utilizará: ${format.toUpperCase()}`, 'info');
        });
    });
    
    // Selección de plantillas
    templateOptions.forEach(template => {
        template.addEventListener('click', function() {
            templateOptions.forEach(temp => temp.classList.remove('active'));
            this.classList.add('active');
            
            const templateName = this.dataset.template;
            applyReportTemplate(templateName);
        });
    });
    
    // Botones principales del modal
    if (cancelExportBtn) {
        cancelExportBtn.addEventListener('click', closeReportsModal);
    }
    
    if (exportReportBtn) {
        exportReportBtn.addEventListener('click', exportReport);
    }
    
    if (previewExportBtn) {
        previewExportBtn.addEventListener('click', generateFullPreviewWithRealContent);
    }
    
    // =================================================================
    // SECCIÓN 9: INICIALIZACIÓN DEL SISTEMA
    // =================================================================
    
    /**
     * Función de inicialización principal
     * Se ejecuta cuando el DOM está completamente cargado
     */
    function initReportsModal() {
        // Crear botón flotante de acceso
        createReportButton();
        
        // Configuración inicial
        showPage(1);
        updatePageCount();
        
        // Inicializar todas las páginas como incluidas
        reportPages.forEach(page => {
            page.classList.add('content-included');
        });
        
        // Cargar configuraciones guardadas
        const savedTitle = localStorage.getItem('reportTitle');
        if (savedTitle && reportTitle) {
            reportTitle.value = savedTitle;
            if (reportTitlePreview) {
                reportTitlePreview.textContent = savedTitle;
            }
        }
        
        // Guardar título cuando cambie
        if (reportTitle) {
            reportTitle.addEventListener('change', function() {
                localStorage.setItem('reportTitle', this.value);
            });
        }
        
        console.log('🎯 Sistema de exportación INFOGES inicializado correctamente');
    }
    
    // Ejecutar inicialización
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initReportsModal);
    } else {
        initReportsModal();
    }
});

// =================================================================
// CSS ADICIONAL REQUERIDO PARA EL SISTEMA
// =================================================================

/**
 * Estilos CSS necesarios para el correcto funcionamiento del sistema.
 * Estos estilos deben estar definidos en tu CSS principal o ser inyectados.
 */
const requiredStyles = `
.custom-notification {
    position: fixed;
    top: 120px;
    right: 32px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    z-index: 10000;
    max-width: 400px;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    padding: 16px;
    gap: 12px;
}

.custom-notification.show {
    transform: translateX(0);
    opacity: 1;
}

.notification-success {
    border-left: 4px solid #059669;
}

.notification-error {
    border-left: 4px solid #dc2626;
}

.notification-warning {
    border-left: 4px solid #d97706;
}

.notification-info {
    border-left: 4px solid #0ea5e9;
}

.notification-icon {
    font-size: 1.2rem;
}

.notification-success .notification-icon {
    color: #059669;
}

.notification-error .notification-icon {
    color: #dc2626;
}

.notification-warning .notification-icon {
    color: #d97706;
}

.notification-info .notification-icon {
    color: #0ea5e9;
}

.notification-title {
    font-weight: 700;
    font-size: 0.9rem;
    color: #0f172a;
    margin-bottom: 4px;
}

.notification-message {
    font-size: 0.8rem;
    color: #64748b;
    line-height: 1.4;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-secondary {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: #e2e8f0;
}

.btn-premium {
    background: linear-gradient(135deg, #00695c 0%, #1e3a8a 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-premium:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 105, 92, 0.3);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}
`;

// Inyectar estilos si no existen
if (!document.getElementById('infoges-export-styles')) {
    const styleElement = document.createElement('style');
    styleElement.id = 'infoges-export-styles';
    styleElement.textContent = requiredStyles;
    document.head.appendChild(styleElement);
}



console.log('📊 Sistema completo de exportación INFOGES cargado - Versión Premium');
    </script>
</body>
</html>
           