<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IAAPS Curic√≥</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/iaaps_abril.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
     <script src="iaaps-chatbot.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/siteConfig.js"></script>
    <script src="js/userTracker.js"></script>
    <script src="js/contactModule.js"></script>
     <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable (si luego vas a usar autoTable en otro m√©todo) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Tu script que define exportarPDFBasico -->

     <!-- Chart.js + DataLabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

     <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Para exportaci√≥n a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Para exportaci√≥n a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    

</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-heartbeat me-2"></i>
                INFOGES Curic√≥
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="../../index.html">
                            <i class="fas fa-sign-out-alt me-1"></i> Salir
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="dashboardLink">
                            <i class="fas fa-tachometer-alt me-1"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="detailLink">
                            <i class="fas fa-chart-bar me-1"></i> Detalle
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../biblioteca/" id="exportDataLink">
                            <i class="fas fa-file-alt me-1"></i> Docs IAAPS
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="helpLink">
                            <i class="fas fa-question-circle me-1"></i> Ayuda
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#historicoModal">
                            <i class="fas fa-history me-1"></i> Hist√≥rico
                        </a>
                    </li>

                </ul>
                
                <div class="d-flex">
                    <div class="input-group">
                        <span class="input-group-text" id="search-addon">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Buscar indicador..." aria-label="Buscar" aria-describedby="search-addon" id="searchInput">
                    </div>
                    
                    <div class="custom-switch ms-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="darkModeToggle">
                            <label class="form-check-label" for="darkModeToggle">
                                <i class="fas fa-moon"></i>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-light ms-3" id="refreshDataBtn">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid">
        <!-- Dashboard View -->
        <div id="dashboardView">
            <div class="dashboard-header">
                <h2><i class="fas fa-chart-line me-2"></i>Dashboard IAAPS - Corte Abril 2025</h2>
                <p class="text-muted">Monitoreo de √çndices de Actividad de la Atenci√≥n Primaria de Salud (IAAPS) para la comuna de Curic√≥</p>
            </div>
            
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <p class="summary-value" id="indicadorCumplidosValue">0</p>
                            <p class="summary-label">Indicadores Cumplidos</p>
                            <div class="progress">
                                <div class="progress-bar bg-success" id="indicadorCumplidosProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <p class="summary-value" id="indicadorParcialValue">0</p>
                            <p class="summary-label">Cumplimiento Parcial</p>
                            <div class="progress">
                                <div class="progress-bar bg-warning" id="indicadorParcialProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <p class="summary-value" id="indicadorCriticosValue">0</p>
                            <p class="summary-label">Indicadores Cr√≠ticos</p>
                            <div class="progress">
                                <div class="progress-bar bg-danger" id="indicadorCriticosProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <p class="summary-value" id="cumplimientoComunalValue">0%</p>
                            <p class="summary-label">Cumplimiento Comunal</p>
                            <div class="progress">
                                <div class="progress-bar bg-primary" id="cumplimientoComunalProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cumplimiento por Centro -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-hospital me-2"></i>
                                Cumplimiento por Centro de Salud
                            </h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" id="viewTableBtn">
                                    <i class="fas fa-table me-1"></i> Ver Tabla
                                </button>
                                <button class="btn btn-sm btn-outline-success" id="viewChartBtn">
                                    <i class="fas fa-chart-bar me-1"></i> Ver Gr√°fico
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="centroChartContainer" class="chart-container">
                                <canvas id="centroChart"></canvas>
                            </div>
                            <div id="centroTableContainer" class="table-responsive" style="display: none;">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Centro de Salud</th>
                                            <th class="text-center">Cumplimiento</th>
                                            <th class="text-center">Indicadores Cumplidos</th>
                                            <th class="text-center">Parciales</th>
                                            <th class="text-center">Cr√≠ticos</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="centroCumplimientoTableBody">
                                        <!-- Tabla se llenar√° din√°micamente con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Indicadores IAAPS -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list-check me-2"></i>
                                Indicadores IAAPS - Avance Comunal
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Indicador</th>
                                            <th class="text-center">Meta</th>
                                            <th class="text-center">Actual</th>
                                            <th class="text-center">Cumplimiento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="indicadoresTableBody">
                                        <!-- Tabla se llenar√° din√°micamente con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-star me-2"></i>
                                Top 5 Indicadores
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="text-success">Mayor Cumplimiento</h6>
                                <div id="topIndicadoresContainer" class="chart-container">
                                    <canvas id="topIndicadoresChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h6 class="text-danger">Menor Cumplimiento</h6>
                                <div id="bottomIndicadoresContainer" class="chart-container">
                                    <canvas id="bottomIndicadoresChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Centros de Salud Cards -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="mb-3"><i class="fas fa-building me-2"></i>Centros de Salud</h4>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroCurico">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Curic√≥ Centro</h5>
                            <p class="centro-subtitle">Avda. Freire 189</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroCuricoProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroCuricoValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroMiguel">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Miguel √Ångel</h5>
                            <p class="centro-subtitle">Balmaceda 179</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroMiguelProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroMiguelValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroBetty">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Betty Mu√±oz</h5>
                            <p class="centro-subtitle">Marcelo Oxilia 1550</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroBettyProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroBettyValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="historicoModal" tabindex="-1" aria-labelledby="historicoModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="historicoModalLabel">Historial de Cortes</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="list-group">
                            <li class="list-group-item"><a href="../marzo/">üìÅ Corte Marzo</a></li>
                            <li class="list-group-item"><a href="../abril/">üìÅ Corte Abril</a></li>
                            <li class="list-group-item"><a href="../abril/">üìä Consolidado Anual</a></li>
                            </ul>
                        </div>
                        </div>
                    </div>
                </div>

                
                <div class="col-md-4 col-lg-2 mb-3" id="centroColon">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Col√≥n</h5>
                            <p class="centro-subtitle">Balmaceda 1661</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroColonProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroColonValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroSarmiento">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Sarmiento</h5>
                            <p class="centro-subtitle">Volc√°n Calbuco s/n</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroSarmientoProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroSarmientoValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroNiches">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Los Niches</h5>
                            <p class="centro-subtitle">Villa Santa Elena</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroNichesProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroNichesValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detail View -->
        <div id="detailView" style="display: none;">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#" id="backToDashboard">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page" id="detailBreadcrumb">Detalle</li>
                </ol>
            </nav>
            
            <div class="detail-header">
                <div>
                    <h3 class="detail-title" id="detailTitle">Detalle de Indicadores IAAPS</h3>
                    <p class="detail-subtitle" id="detailSubtitle">Seleccione un centro o indicador para ver detalles espec√≠ficos.</p>
                </div>
                
            </div>
            
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="detailTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="centro-tab" data-bs-toggle="tab" data-bs-target="#centro-content" 
                            type="button" role="tab" aria-controls="centro-content" aria-selected="true">
                        <i class="fas fa-hospital me-1"></i> Por Centro de Salud
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="indicador-tab" data-bs-toggle="tab" data-bs-target="#indicador-content" 
                            type="button" role="tab" aria-controls="indicador-content" aria-selected="false">
                        <i class="fas fa-list-check me-1"></i> Por Indicador
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comparativo-tab" data-bs-toggle="tab" data-bs-target="#comparativo-content" 
                            type="button" role="tab" aria-controls="comparativo-content" aria-selected="false">
                        <i class="fas fa-chart-bar me-1"></i> Comparativo
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="detailTabContent">
                <!-- Centro Content -->
                <div class="tab-pane fade show active" id="centro-content" role="tabpanel" aria-labelledby="centro-tab">
                    <div class="row mt-4">
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Centros de Salud</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group" id="centroListGroup">
                                        <a href="#" class="list-group-item list-group-item-action active" 
                                           data-centro="comunal">CURIC√ì (COMUNAL)</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="curico">CESFAM Curic√≥ Centro</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="miguel">CESFAM Miguel √Ångel Arenas</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="betty">CESFAM Betty Mu√±oz</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="colon">CESFAM Col√≥n</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="sarmiento">CESFAM Sarmiento</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="niches">CESFAM Los Niches</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="centroCumplimientoTitle">Cumplimiento IAAPS Comunal</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportCentroExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportCentroPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="centroCumplimientoChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="centroIndicadoresChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Indicador</th>
                                                    <th class="text-center">Numerador</th>
                                                    <th class="text-center">Denominador</th>
                                                    <th class="text-center">Resultado</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="centroIndicadoresTableBody">
                                                <!-- Se llenar√° din√°micamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card" id="establecimientosCard" style="display: none;">
                                <div class="card-header">
                                    <h5 class="mb-0">Establecimientos Asociados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Establecimiento</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Indicadores Cumplidos</th>
                                                    <th class="text-center">Parciales</th>
                                                    <th class="text-center">Cr√≠ticos</th>
                                                </tr>
                                            </thead>
                                            <tbody id="establecimientosTableBody">
                                                <!-- Se llenar√° din√°micamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Indicador Content -->
                <div class="tab-pane fade" id="indicador-content" role="tabpanel" aria-labelledby="indicador-tab">
                    <div class="row mt-4">
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Indicadores IAAPS</h5>
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <div class="list-group" id="indicadorListGroup">
                                        <!-- Se llenar√° din√°micamente con JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="indicadorDetailTitle">Detalle de Indicador</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportIndicadorExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportIndicadorPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="indicadorCentrosChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 id="indicadorNombreCompleto">Nombre del Indicador</h6>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>Meta:</strong> <span id="indicadorMetaValor">0%</span></p>
                                                            <p><strong>Importancia:</strong> <span id="indicadorImportanciaValor">0%</span></p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>Numerador:</strong> <span id="indicadorNumeradorFormula">F√≥rmula del numerador</span></p>
                                                            <p><strong>Denominador:</strong> <span id="indicadorDenominadorFormula">F√≥rmula del denominador</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Centro de Salud</th>
                                                    <th class="text-center">Numerador</th>
                                                    <th class="text-center">Denominador</th>
                                                    <th class="text-center">Resultado</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="indicadorCentrosTableBody">
                                                <!-- Se llenar√° din√°micamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparativo Content -->
                <div class="tab-pane fade" id="comparativo-content" role="tabpanel" aria-labelledby="comparativo-tab">
                    <div class="row mt-4">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Comparativo de Cumplimiento</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportComparativoExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportComparativoPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="chart-container">
                                                <canvas id="comparativoChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Matriz de Cumplimiento</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Indicador</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Comunal</th>
                                                    <th class="text-center">Curic√≥ Centro</th>
                                                    <th class="text-center">Miguel √Ångel</th>
                                                    <th class="text-center">Betty Mu√±oz</th>
                                                    <th class="text-center">Col√≥n</th>
                                                    <th class="text-center">Sarmiento</th>
                                                    <th class="text-center">Los Niches</th>
                                                </tr>
                                            </thead>
                                            <tbody id="comparativoTableBody">
                                                <!-- Se llenar√° din√°micamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="fas fa-question-circle me-2"></i>
                        Ayuda del Dashboard IAAPS
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h5>¬øQu√© son los IAAPS?</h5>
                            <p>
                                Los √çndices de Actividad de la Atenci√≥n Primaria de Salud (IAAPS) son un conjunto de 
                                indicadores que permiten evaluar el funcionamiento integral de la atenci√≥n primaria.
                                Estos indicadores miden diferentes aspectos como cobertura, continuidad, calidad 
                                de la atenci√≥n y m√°s.
                            </p>
                            
                            <h5>¬øC√≥mo leer el dashboard?</h5>
                            <p>
                                El dashboard proporciona una visi√≥n general del cumplimiento de los IAAPS a nivel comunal
                                y por cada centro de salud. Los indicadores se clasifican seg√∫n su cumplimiento:
                            </p>
                            <ul>
                                <li><span class="badge bg-success">Cumplido</span> - Cumplimiento igual o superior al 100% de la meta</li>
                                <li><span class="badge bg-warning">Parcial</span> - Cumplimiento entre 33.33% y 99% de la meta</li>
                                <li><span class="badge bg-danger">Cr√≠tico</span> - Cumplimiento inferior al 33.33% de la meta</li>
                            </ul>
                            
                            <h5>Secciones principales</h5>
                            <ul>
                                <li><strong>Dashboard</strong>: Vista general del cumplimiento comunal y por centro</li>
                                <li><strong>Detalle</strong>: Informaci√≥n detallada por centro o por indicador</li>
                                <li><strong>Exportar</strong>: Opciones para generar reportes en PDF o Excel</li>
                            </ul>
                            <h5>¬øC√≥mo usar el micr√≥fono?</h5>
<p>
  ‚Ä¢ Para <strong>iniciar</strong> la escucha: presiona cualquier tecla (fuera de campos de texto) o haz clic en el icono de micr√≥fono <code id="micButton">üé§</code>.<br>
  ‚Ä¢ Para <strong>detener</strong> la escucha: suelta la tecla que presionaste o vuelve a hacer clic en el mismo icono.
</p>

<h6>Comandos disponibles</h6>
<ul>
  <li><strong>dashboard</strong> / <strong>inicio</strong>: ir a la pantalla principal del sistema.</li>
  <li><strong>detalle</strong> / <strong>detalles</strong>: navegar a la vista de detalle del indicador o centro activo.</li>
  <li><strong>ayuda</strong>: abrir el modal de ayuda.</li>
  <li><strong>actualizar</strong> / <strong>refrescar</strong>: recargar datos en pantalla.</li>
  <li><strong>exportar excel</strong> / <strong>descargar excel</strong>: generar y descargar el informe en Excel.</li>
  <li><strong>exportar pdf</strong> / <strong>descargar pdf</strong>: generar y descargar el informe en PDF.</li>
  <li><strong>modo oscuro</strong> / <strong>modo noche</strong>: activar o desactivar el tema oscuro.</li>
  <li><strong>modo claro</strong> / <strong>modo d√≠a</strong>: volver al tema claro.</li>
  <li><strong>salir</strong>: volver a la pantalla de inicio de sesi√≥n.</li>
  <li><strong>iaaps</strong> / <strong>panel iaaps</strong>: ir al panel principal de IAAPS.</li>
  <li><strong>metas sanitarias</strong> / <strong>panel metas sanitarias</strong>: ir al panel de Metas Sanitarias.</li>
  <li><strong>tablero poblacional</strong> / <strong>poblacion</strong>: ir al Tablero Poblacional.</li>
  <li><strong>centro [nombre]</strong>: mostrar detalle de un centro espec√≠fico.</li>
  <li><strong>indicador [n√∫mero]</strong>: mostrar un indicador concreto.</li>
  <li><strong>buscar [t√©rmino]</strong>: filtrar indicadores por palabra clave.</li>
</ul>




                                

                            
                            <h5>Leyenda de c√°lculos</h5>
                            <ul>
                                <li><strong>Resultado</strong>: Numerador / Denominador</li>
                                <li><strong>Cumplimiento</strong>: (Resultado / Meta) * 100%</li>
                                <li><strong>Cumplimiento m√°ximo</strong>: 100% (aunque el c√°lculo sea superior)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Core JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>

    
        // Configuraci√≥n global de Chart.js
        Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#666';
        
        // Variables globales para datos
        let iaapsData = null;
        let currentCentro = 'comunal';
        let currentIndicador = '1';
        let darkMode = false;
        let indicadorCentrosChartInstance = null;
        
        // Mapeo de c√≥digos de indicadores a nombres completos
        const indicadoresMap = {
            '1': 'Porcentaje de centros de salud autoevaluados mediante MAIS',
            '2.1': 'Continuidad de Atenci√≥n',
            '2.2': 'Disponibilidad de f√°rmacos trazadores',
            '3': 'Tasa de consultas m√©dicas de morbilidad por habitante a√±o',
            '4': 'Porcentaje de derivaci√≥n al nivel secundario',
            '5': 'Tasa de Visita Domiciliaria Integral',
            '6.1.A': 'Cobertura EMP mujeres (20-64 a√±os)',
            '6.1.B': 'Cobertura EMP hombres (20-64 a√±os)',
            '6.2': 'Cobertura EMPAM (65+ a√±os)',
            '7': 'Cobertura evaluaci√≥n desarrollo psicomotor (12-23 meses)',
            '8': 'Cobertura control adolescentes (10-19 a√±os)',
            '9.1': 'Cobertura atenci√≥n salud mental',
            '9.2': 'Tasa controles salud mental',
            '9.3': 'Personas egresadas por alta cl√≠nica',
            '10': 'Cumplimiento GES en APS',
            '11': 'Cobertura vacunaci√≥n anti-influenza',
            '12': 'Ingreso precoz a control de embarazo',
            '13': 'Cobertura regulaci√≥n fertilidad adolescentes',
            '14': 'Cobertura DM2 (15+ a√±os)',
            '15': 'Cobertura HTA (15+ a√±os)',
            '16': 'Proporci√≥n ni√±os sin caries (<3 a√±os)',
            '17': 'Prevalencia normalidad menores de 2 a√±os'
        };
        
        // Mapeo de c√≥digos de centros a nombres completos
      const centrosMap = {
    'comunal':   'CURIC√ì TOTAL COMUNAL',
    'curico':    'CURICO CENTRO',
    'miguel':    'MIGUEL √ÅNGEL ARENAS',
    'betty':     'BETTY MU√ëOZ',
    'colon':     'COL√ìN',
    'sarmiento': 'SARMIENTO',
    'niches':    'LOS NICHES'
};

// Mapeo de establecimientos asociados a cada centro
const establecimientosMap = {
    'comunal':   [],
    'curico':    ['SAPU CURIC√ì CENTRO'],
    'miguel':    ['PROSPERIDAD','SAR AGUAS NEGRAS' ],
    'betty':     ['PSR PORVENIR'],
    'colon':     ['SAR BOMBERO GARRIDO', 'PSR TUTUQUEN', ],
    'sarmiento': ['SUR SARMIENTO', 'CECOSF DO√ëA CARMEN DE SARMIENTO'],
    'niches':    [
        'SUR LOS NICHES',
        'PSR POTRERO GRANDE',
        'PSR CHEQUENLEMU',
        'PSR UPEO',
        'PSR CORDILLERILLA',
        'PSR LA OBRA'
    ]
};

        
        // Importancia relativa de cada indicador
        const importanciaIndicadores = {
            '1': '4%',
            '2.1': '4%',
            '2.2': '4%',
            '3': '6%',
            '4': '5%',
            '5': '5%',
            '6.1.A': '3%',
            '6.1.B': '4%',
            '6.2': '5%',
            '7': '5%',
            '8': '6%',
            '9.1': '5.5%',
            '9.2': '3.3%',
            '9.3': '2.2%',
            '10': 'Cr√≠tico',
            '11': '5%',
            '12': '6%',
            '13': '6%',
            '14': '6%',
            '15': '6%',
            '16': '5%',
            '17': '4%'
        };
        
        // F√≥rmulas de numeradores y denominadores
        const formulasIndicadores = {
            '1': {
                numerador: 'N¬∞ de centros de salud de la comuna autoevaluados',
                denominador: 'Total de los establecimientos de salud de la comuna a√±o 2025'
            },
            '2.1': {
                numerador: 'N¬∞ establecimientos funcionando de 8:00 a 20:00 horas de lunes a viernes y s√°bados de 9:00 a 13:00 horas',
                denominador: 'N¬∞ total de establecimientos visitados'
            },
            '2.2': {
                numerador: 'N¬∞ de f√°rmacos trazadores disponibles',
                denominador: 'N¬∞ total de f√°rmacos trazadores'
            },
            '3': {
                numerador: 'N¬∞ de consultas de morbilidad realizadas por profesional m√©dico',
                denominador: 'Poblaci√≥n inscrita validada'
            },
            '4': {
                numerador: 'N¬∞ SIC de controles y consultas m√©dicas generadas en APS',
                denominador: 'N¬∞ total de controles y consultas m√©dicas realizadas en APS'
            },
            '5': {
                numerador: 'N¬∞ de visitas domiciliarias integrales realizadas',
                denominador: 'N¬∞ de familias (poblaci√≥n inscrita validada / 3,3)'
            },
            '6.1.A': {
                numerador: 'N¬∞ de EMP realizados a mujeres de 20 a 64 a√±os',
                denominador: 'Poblaci√≥n de mujeres de 20 a 64 a√±os inscrita - Poblaci√≥n embarazadas 20-54 a√±os'
            },
            '6.1.B': {
                numerador: 'N¬∞ de EMP realizados a hombres de 20 a 64 a√±os',
                denominador: 'Poblaci√≥n de hombres de 20 a 64 a√±os inscrita'
            },
            '6.2': {
                numerador: 'N¬∞ de EMP realizados a personas de 65 y m√°s a√±os',
                denominador: 'Poblaci√≥n de 65 y m√°s a√±os inscrita'
            },
            '7': {
                numerador: 'N¬∞ ni√±os/as de 12 a 23 meses con evaluaci√≥n del desarrollo psicomotor',
                denominador: 'N¬∞ total de ni√±os/as entre 12 a 23 meses bajo control'
            },
            '8': {
                numerador: 'N¬∞ de controles de salud integral realizados a adolescentes de 10 a 19 a√±os',
                denominador: 'Total poblaci√≥n adolescente de 10 a 19 a√±os inscrita'
            },
            '9.1': {
                numerador: 'N¬∞ de personas con trastornos mentales y condicionantes de la salud mental bajo control',
                denominador: 'N¬∞ de personas con trastornos mentales esperados seg√∫n prevalencia (22%)'
            },
            '9.2': {
                numerador: 'N¬∞ de controles de Salud Mental realizados en personas de 0 y m√°s a√±os',
                denominador: 'N¬∞ de personas bajo control en el programa de salud mental'
            },
            '9.3': {
                numerador: 'N¬∞ personas egresadas por alta cl√≠nica de 0 m√°s a√±os',
                denominador: 'N¬∞ de personas bajo control en el programa de salud mental'
            },
            '10': {
                numerador: 'N¬∞ de casos GES en atenci√≥n primaria con garant√≠a atendida',
                denominador: 'N¬∞ total de casos GES en APS'
            },
            '11': {
                numerador: 'N¬∞ de personas de grupos objetivos vacunados con anti-influenza',
                denominador: 'Total de poblaci√≥n inscrita de los grupos objetivos'
            },
            '12': {
                numerador: 'N¬∞ de mujeres embarazadas ingresadas antes de las 14 semanas a control',
                denominador: 'Total de mujeres embarazadas ingresadas a control'
            },
            '13': {
                numerador: 'N¬∞ de adolescentes de 15 a 19 a√±os que usan m√©todo de regulaci√≥n de la fertilidad',
                denominador: 'Total adolescentes de 15 a 19 a√±os inscritos'
            },
            '14': {
                numerador: 'N¬∞ de personas de 15 y m√°s a√±os con DM2 bajo control',
                denominador: 'N¬∞ de personas con DM2 de 15 y m√°s a√±os, esperados seg√∫n prevalencia'
            },
            '15': {
                numerador: 'N¬∞ de personas de 15 y m√°s a√±os con HTA bajo control',
                denominador: 'N¬∞ de personas con HTA de 15 y m√°s a√±os, esperados seg√∫n prevalencia'
            },
            '16': {
                numerador: 'N¬∞ de ni√±os y ni√±as menores de 3 a√±os con registro CEOD = 0',
                denominador: 'N¬∞ de ni√±as y ni√±os menores de 3 a√±os inscritos'
            },
            '17': {
                numerador: 'N¬∞ de ni√±as y ni√±os < dos a√±os con estado nutricional normal',
                denominador: 'N¬∞ de ni√±as y ni√±os < dos a√±os bajo control'
            }
        };
        
        // Funci√≥n para inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips y popovers de Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Cargar datos iniciales
            cargarDatos();
            
            // Event listeners para navegaci√≥n
            document.getElementById('dashboardLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('dashboardView');
            });
            
            document.getElementById('detailLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('detailView');
            });
            
            document.getElementById('backToDashboard').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('dashboardView');
            });
            
            document.getElementById('helpLink').addEventListener('click', function(e) {
                e.preventDefault();
                const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
                helpModal.show();
            });
            
            document.getElementById('refreshDataBtn').addEventListener('click', function(e) {
                cargarDatos();
            });
            
            document.getElementById('viewTableBtn').addEventListener('click', function(e) {
                document.getElementById('centroChartContainer').style.display = 'none';
                document.getElementById('centroTableContainer').style.display = 'block';
            });
            
            document.getElementById('viewChartBtn').addEventListener('click', function(e) {
                document.getElementById('centroChartContainer').style.display = 'block';
                document.getElementById('centroTableContainer').style.display = 'none';
            });
            
            // Event listeners para tarjetas de centros
            document.getElementById('centroCurico').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('curico');
            });
            
            document.getElementById('centroMiguel').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('miguel');
            });
            
            document.getElementById('centroBetty').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('betty');
            });
            
            document.getElementById('centroColon').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('colon');
            });
            
            document.getElementById('centroSarmiento').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('sarmiento');
            });
            
            document.getElementById('centroNiches').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('niches');
            });
            
            // Event listeners para lista de centros en vista detalle
            document.getElementById('centroListGroup').addEventListener('click', function(e) {
                if (e.target.classList.contains('list-group-item')) {
                    e.preventDefault();
                    
                    // Remover clase active de todos los items
                    document.querySelectorAll('#centroListGroup .list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Agregar clase active al item seleccionado
                    e.target.classList.add('active');
                    
                    // Mostrar detalles del centro seleccionado
                    seleccionarCentro(e.target.dataset.centro);
                }
            });
            
            // Event listeners para exportar
            document.getElementById('exportCentroExcelBtn').addEventListener('click', function() {
                exportarExcel('centro');
            });
            
            document.getElementById('exportCentroPdfBtn').addEventListener('click', function() {
                exportarPDF('centro');
            });
            
            document.getElementById('exportIndicadorExcelBtn').addEventListener('click', function() {
                exportarExcel('indicador');
            });
            
            document.getElementById('exportIndicadorPdfBtn').addEventListener('click', function() {
                exportarPDF('indicador');
            });
            
            document.getElementById('exportComparativoExcelBtn').addEventListener('click', function() {
                exportarExcel('comparativo');
            });
            
            document.getElementById('exportComparativoPdfBtn').addEventListener('click', function() {
                exportarPDF('comparativo');
            });
            
            // Toggle modo oscuro
            document.getElementById('darkModeToggle').addEventListener('change', function() {
                toggleDarkMode();
            });
            
            // B√∫squeda
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                buscarIndicadores(searchTerm);
            });
            
            // Llenar lista de indicadores
            llenarListaIndicadores();
            
            // Event listener para la lista de indicadores
            document.getElementById('indicadorListGroup').addEventListener('click', function(e) {
                if (e.target.classList.contains('list-group-item')) {
                    e.preventDefault();
                    
                    // Remover clase active de todos los items
                    document.querySelectorAll('#indicadorListGroup .list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Agregar clase active al item seleccionado
                    e.target.classList.add('active');
                    
                    // Mostrar detalles del indicador seleccionado
                    seleccionarIndicador(e.target.dataset.indicador);
                }
            });
        });
        
        // Funci√≥n para llenar la lista de indicadores
        function llenarListaIndicadores() {
            const indicadorListGroup = document.getElementById('indicadorListGroup');
            indicadorListGroup.innerHTML = '';
            
            // C√≥digos de los indicadores en orden espec√≠fico
            const indicadoresCodigos = ['1', '2.1', '2.2', '3', '4', '5', '6.1.A', '6.1.B', '6.2', '7', '8', '9.1', '9.2', '9.3', '10', '11', '12', '13', '14', '15', '16', '17'];
            
            indicadoresCodigos.forEach((codigo, index) => {
                const item = document.createElement('a');
                item.href = '#';
                item.classList.add('list-group-item', 'list-group-item-action');
                if (index === 0) item.classList.add('active');
                item.dataset.indicador = codigo;
                
                // Abreviaci√≥n del nombre para la lista
                const nombreCorto = codigo + '. ' + indicadoresMap[codigo].split('(')[0];
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${nombreCorto}</h6>
                    </div>
                    <small class="text-muted">Importancia: ${importanciaIndicadores[codigo]}</small>
                `;
                
                indicadorListGroup.appendChild(item);
            });
        }
        
// --------------------------------------------------
//  Funci√≥n para cargar datos y actualizar toda la UI
// --------------------------------------------------
async function cargarDatos() {
  // 1) Mostrar loader
  mostrarCargando(true);

  // 2) Cargar y procesar datos
  try {
    await simularCargaDeDatos();
    procesarDatos();
  } catch (err) {
    console.error('‚ùå Error al cargar o procesar datos:', err);
    // podemos notificar opcionalmente, pero NO salimos: igual intentamos dibujar lo que haya.
    mostrarNotificacion('No fue posible cargar los datos brutos. Ver consola para m√°s info.', 'error');
  }

  // 3) Actualizar el dashboard (tarjetas, gr√°ficos principales)
  try {
    actualizarDashboard();
  } catch (err) {
    console.error('‚ùå Error al actualizar el dashboard:', err);
    mostrarNotificacion('Error en la actualizaci√≥n del dashboard. Ver consola.', 'error');
  }

  // 4) Actualizar la vista de detalle (centro, indicador, comparativo)
  try {
    actualizarDetalle();
  } catch (err) {
    console.error('‚ùå Error al actualizar detalle:', err);
    mostrarNotificacion('Error en la vista de detalle. Ver consola.', 'error');
  }

  // 5) Siempre ocultar loader al final
  mostrarCargando(false);
}

// --------------------------------------------------
//  Arranca la carga al iniciarse la p√°gina
// --------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
  cargarDatos();
});

     // Funci√≥n para simular carga de datos desde el archivo Excel
     function simularCargaDeDatos() {
            return new Promise((resolve) => {
                // Simulamos datos para el ejemplo
                // En una implementaci√≥n real, se cargar√≠a desde el archivo Excel
                
                // Esta es una estructura de datos simplificada
iaapsData = {
  centros: [
    { codigo: 'comunal',   nombre: 'CURICO TOTAL COMUNAL' },
    { codigo: 'curico',    nombre: 'CURICO CENTRO' },
    { codigo: 'miguel',    nombre: 'MIGUEL ANGEL ARENAS' },
    { codigo: 'betty',     nombre: 'BETTY MU√ëOZ' },
    { codigo: 'colon',     nombre: 'COLON' },
    { codigo: 'sarmiento', nombre: 'SARMIENTO' },
    { codigo: 'niches',    nombre: 'LOS NICHES' }
  ],
  establecimientos: [
    { codigo: 'prosperidad', nombre: 'PROSPERIDAD',          centro: 'miguel' },
    { codigo: 'tutuquen',    nombre: 'PSR TUTUQUEN',         centro: 'colon' },
    { codigo: 'porvenir',    nombre: 'PSR PORVENIR',         centro: 'betty' },
    { codigo: 'dona_carmen', nombre: 'DO√ëA CARMEN',          centro: 'sarmiento' },
    { codigo: 'potrero',     nombre: 'PSR POTRERO GRANDE',   centro: 'niches' },
    { codigo: 'chequenlemu', nombre: 'PSR CHEQUENLEMU',      centro: 'niches' },
    { codigo: 'upeo',        nombre: 'PSR UPEO',             centro: 'niches' },
    { codigo: 'obra',        nombre: 'PSR LA OBRA',             centro: 'niches' },
    { codigo: 's_niches',        nombre: 'SUR LOS NICHES',             centro: 'niches' },
    { codigo: 'cordillerilla', nombre: 'PSR CORDILLERILLA',  centro: 'niches' },
    { codigo: 'sapu_curico',        nombre: 'SAPU CURICO CENTRO',   centro: 'curico' },
    { codigo: 'sar2',        nombre: 'SAR AGUAS NEGRAS',      centro: 'miguel' },
    { codigo: 'sar1',        nombre: 'SAR BOMBERO GARRIDO',   centro: 'colon' },
  ],
                    indicadores: [
                        {
                            codigo: '1',
                            nombre: 'Porcentaje de centros de salud autoevaluados mediante MAIS',
                            tipo: 'porcentaje',
                            meta: 100,
                            importancia: 4,
                            resultados: [
                                { centro: 'comunal', numerador: 15, denominador: 15, resultado: 100, cumplimiento: 100 },
                                { centro: 'curico', numerador: 1, denominador: 1, resultado: 100, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 2, denominador: 2, resultado: 100, cumplimiento: 100 },
                                { centro: 'betty', numerador: 2, denominador: 2, resultado: 100, cumplimiento: 100 },
                                { centro: 'colon', numerador: 2, denominador: 2, resultado: 100, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 2, denominador: 2, resultado: 100, cumplimiento: 100 },
                                { centro: 'niches', numerador: 6, denominador: 6, resultado: 100, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'dona_carmen', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'potrero', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'upeo', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'obra', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 }
                            ]
                        },
                        {
                            codigo: '2.1',
                            nombre: 'Continuidad de Atenci√≥n',
                            tipo: 'porcentaje',
                            meta: 100,
                            importancia: 4,
                            resultados: [
                                { centro: 'comunal', numerador: 6, denominador: 6, resultado: 100, cumplimiento: 100 },
                                { centro: 'curico', numerador: 1, denominador:1, resultado: 100, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 1, denominador: 1, resultado: 100, cumplimiento: 100 },
                                { centro: 'betty', numerador: 1, denominador: 1, resultado: 100, cumplimiento: 100 },
                                { centro: 'colon', numerador: 1, denominador: 1, resultado: 100, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 1, denominador: 1, resultado: 100, cumplimiento: 100 },
                                { centro: 'niches', numerador: 1, denominador: 1, resultado: 100, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'dona_carmen', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'potrero', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'upeo', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'obra', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 }
                            ]
                        },
                        {
                            codigo: '2.2',
                            nombre: 'Disponibilidad de f√°rmacos trazadores',
                            tipo: 'porcentaje',
                            meta: 100,
                            importancia: 4,
                            resultados: [
                                { centro: 'comunal', numerador: 14, denominador: 14, resultado: 100, cumplimiento: 100 },
                                { centro: 'curico', numerador: 14, denominador: 14, resultado: 100, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 14, denominador: 14, resultado: 100, cumplimiento: 100 },
                                { centro: 'betty', numerador: 14, denominador: 14, resultado: 100, cumplimiento: 100 },
                                { centro: 'colon', numerador: 14, denominador: 14, resultado: 100, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 14, denominador: 14, resultado: 100, cumplimiento: 100 },
                                { centro: 'niches', numerador: 14, denominador: 14, resultado: 100, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'dona_carmen', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'potrero', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'upeo', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 },
                                { centro: 'obra', numerador: 0, denominador: 0, resultado: 100, cumplimiento: 100 }
                            ]
                        },
// 3) Tasa de consultas m√©dicas de morbilidad por habitante a√±o
{
  codigo: '3',
  nombre: 'Tasa de consultas m√©dicas de morbilidad por habitante a√±o',
  tipo: 'tasa',
  meta: 0.82,
  importancia: 6,
  resultados: [
    // Centros principales AGREGADOS
    { centro: 'comunal',       numerador: 43678, denominador: 150113, resultado: 0.29, cumplimiento: 35.48, },
    { centro: 'curico',        numerador:  9581, denominador:  41532, resultado: 0.23, cumplimiento: 28.13, },
    { centro: 'miguel',        numerador:  9218, denominador:  28763, resultado: 0.32, cumplimiento: 39.08, },
    { centro: 'betty',         numerador:  7867, denominador:  28461, resultado: 0.28, cumplimiento: 33.71, },
    { centro: 'colon',         numerador:  6892, denominador:  23785, resultado: 0.29, cumplimiento: 35.34, },
    { centro: 'sarmiento',     numerador:  6342, denominador:  13722, resultado: 0.46, cumplimiento: 56.36, },
    { centro: 'niches',        numerador:  3778, denominador:  13850, resultado: 0.27, cumplimiento: 33.27, },

    // Establecimientos (SIN CAMBIOS)
    { centro: 'prosperidad',   numerador:   691, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'tutuquen',      numerador:    84, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'porvenir',      numerador:   202, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'dona_carmen',   numerador:   945, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'potrero',       numerador:    35, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'chequenlemu',   numerador:    47, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'upeo',          numerador:    55, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'cordillerilla', numerador:    21, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'obra',          numerador:    19, denominador:     0, resultado: 0.00, cumplimiento: 0.00, },
  ],
},


// 4) Porcentaje de derivaci√≥n al nivel secundario
{
  codigo: '4',
  nombre: 'Porcentaje de derivaci√≥n al nivel secundario',
  tipo: 'porcentaje',
  meta: 10,
  importancia: 5,
  resultados: [
    { centro: 'comunal',      numerador: 4158, denominador: 73188, resultado:  5.68, cumplimiento: 56.83, },
    { centro: 'curico',       numerador: 1064, denominador: 16574, resultado:  6.42, cumplimiento: 64.16, },
    { centro: 'miguel',       numerador:  880, denominador: 15339, resultado:  5.74, cumplimiento: 57.38, },
    { centro: 'betty',        numerador:  905, denominador: 13480, resultado:  6.71, cumplimiento: 67.14, },
    { centro: 'colon',        numerador:  524, denominador: 10940, resultado:  4.79, cumplimiento: 47.91, },
    { centro: 'sarmiento',    numerador:  326, denominador:  9452, resultado:  3.45, cumplimiento: 34.48, },
    { centro: 'niches',       numerador:  459, denominador:  7403, resultado:  6.20, cumplimiento: 61.99, },

    // Establecimientos (SIN CAMBIOS)
    { centro: 'prosperidad',   numerador:   0, denominador: 1337, resultado: 0.00, cumplimiento: 0, },
    { centro: 'tutuquen',      numerador:   3, denominador:  241, resultado: 1.24, cumplimiento: 12.45, },
    { centro: 'porvenir',      numerador:  18, denominador:  366, resultado: 4.92, cumplimiento: 49.18, },
    { centro: 'dona_carmen',   numerador:  14, denominador: 1447, resultado: 0.97, cumplimiento:  9.68, },
    { centro: 'potrero',       numerador:   0, denominador:  154, resultado: 0.00, cumplimiento:  0, },
    { centro: 'chequenlemu',   numerador:   0, denominador:  140, resultado: 0.00, cumplimiento:  0, },
    { centro: 'upeo',          numerador:   0, denominador:  133, resultado: 0.00, cumplimiento:  0, },
    { centro: 'cordillerilla', numerador:   0, denominador:  118, resultado: 0.00, cumplimiento:  0, },
    { centro: 'obra',          numerador:   0, denominador:  167, resultado: 0.00, cumplimiento:  0, },
  ],
},


// 5) Tasa de Visita Domiciliaria Integral
{
  codigo: '5',
  nombre: 'Tasa de Visita Domiciliaria Integral',
  tipo: 'tasa',
  meta: 0.24,
  importancia: 5,
  resultados: [
    // Centros principales (agregados con sus establecimientos)
    { centro: 'comunal',     numerador: 3525, denominador: 45489, resultado: 0.08, cumplimiento: 33.33, },
    { centro: 'curico',      numerador:  794, denominador: 12585, resultado: 0.06, cumplimiento: 25.00, },
    { centro: 'miguel',      numerador:  726, denominador:  8716, resultado: 0.08, cumplimiento: 33.33, },
    { centro: 'betty',       numerador:  653, denominador:  8625, resultado: 0.08, cumplimiento: 33.33, },
    { centro: 'colon',       numerador:  551, denominador:  7208, resultado: 0.08, cumplimiento: 33.33, },
    { centro: 'sarmiento',   numerador:  419, denominador:  4158, resultado: 0.10, cumplimiento: 41.67, },
    { centro: 'niches',      numerador:  382, denominador:  4197, resultado: 0.09, cumplimiento: 37.50, },

    // Establecimientos (sin cambios)
    { centro: 'prosperidad', numerador: 107, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'tutuquen',    numerador:  19, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'porvenir',    numerador:   3, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'dona_carmen', numerador:  83, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'potrero',     numerador:  29, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'chequenlemu', numerador:   6, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'upeo',        numerador:  12, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'cordillerilla',numerador:   9, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
    { centro: 'obra',        numerador:  22, denominador:    0, resultado: 0.00, cumplimiento: 0.00, },
  ],
},


// 6.1.A) Cobertura EMP mujeres (20-64 a√±os)
{
  codigo: '6.1.A',
  nombre: 'Cobertura EMP mujeres (20-64 a√±os)',
  tipo: 'porcentaje',
  meta: 23.89,
  importancia: 3,
  resultados: [
    { centro: 'comunal',        numerador: 6581, denominador: 49664, resultado: 13.25, cumplimiento: 55.47, },
    { centro: 'curico',         numerador: 1329, denominador: 14597, resultado:  9.10, cumplimiento: 38.11, },
    { centro: 'miguel',         numerador: 1582, denominador:  9158, resultado: 17.27, cumplimiento: 72.31, },
    { centro: 'betty',          numerador: 1218, denominador:  9639, resultado: 12.64, cumplimiento: 52.89, },
    { centro: 'colon',          numerador: 1032, denominador:  7738, resultado: 13.34, cumplimiento: 55.83, },
    { centro: 'sarmiento',      numerador:  640, denominador:  4343, resultado: 14.74, cumplimiento: 61.68, },
    { centro: 'niches',         numerador:  780, denominador:  4192, resultado: 18.61, cumplimiento: 77.89, },

    // Establecimientos (sin cambios)
    { centro: 'prosperidad',    numerador:  128, denominador:   -14, resultado: -914.29, cumplimiento:  0, },
    { centro: 'tutuquen',       numerador:   51, denominador:     0, resultado:    0.00, cumplimiento:  0, },
    { centro: 'porvenir',       numerador:   40, denominador:    -3, resultado: -1333.33, cumplimiento:  0, },
    { centro: 'dona_carmen',    numerador:  153, denominador:    -9, resultado: -1700.00, cumplimiento:  0, },
    { centro: 'potrero',        numerador:   11, denominador:    -2, resultado:  -550.00, cumplimiento:  0, },
    { centro: 'chequenlemu',    numerador:   12, denominador:     0, resultado:    0.00, cumplimiento:  0, },
    { centro: 'upeo',           numerador:   15, denominador:     0, resultado:    0.00, cumplimiento:  0, },
    { centro: 'cordillerilla',  numerador:   11, denominador:    -1, resultado: -1100.00, cumplimiento:  0, },
    { centro: 'obra',           numerador:   30, denominador:    -2, resultado: -1500.00, cumplimiento:  0, },
  ],
},
                    // 6.1.B) Cobertura EMP hombres (20-64 a√±os)
// 6.1.B) Cobertura EMP hombres (20-64 a√±os)
{
  codigo: '6.1.B',
  nombre: 'Cobertura EMP hombres (20-64 a√±os)',
  tipo: 'porcentaje',
  meta: 22.31,
  importancia: 4,
  resultados: [
    // Centros principales, sumado con sus establecimientos
    { centro: 'comunal',        numerador: 3114, denominador: 41825, resultado:  7.45, cumplimiento: 33.37, },
    { centro: 'curico',         numerador:  514, denominador: 10883, resultado:  4.72, cumplimiento: 21.17, },
    { centro: 'miguel',         numerador:  818, denominador:  8935, resultado:  9.16, cumplimiento: 41.04, },
    { centro: 'betty',          numerador:  552, denominador:  7094, resultado:  7.78, cumplimiento: 34.88, },
    { centro: 'colon',          numerador:  444, denominador:  6471, resultado:  6.86, cumplimiento: 30.75, },
    { centro: 'sarmiento',      numerador:  371, denominador:  4193, resultado:  8.85, cumplimiento: 39.66, },
    { centro: 'niches',         numerador:  415, denominador:  4249, resultado:  9.77, cumplimiento: 43.78, },

    // Establecimientos (sin cambios)
    { centro: 'prosperidad',    numerador:   56, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'tutuquen',       numerador:   50, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',       numerador:   20, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',    numerador:   86, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',        numerador:   13, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',    numerador:    8, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',           numerador:   23, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla',  numerador:    6, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',           numerador:   32, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 's_niches',       numerador:    0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'sapu_curico',    numerador:    0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'sar2',           numerador:    0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'sar1',           numerador:    0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
  ],
},



// 6.2) Cobertura EMPAM (65+ a√±os)
// 6.2) Cobertura EMPAM (65+ a√±os)
{
  codigo: '6.2',
  nombre: 'Cobertura EMPAM (65+ a√±os)',
  tipo: 'porcentaje',
  meta: 58.48,
  importancia: 5,
  resultados: [
    { centro: 'comunal',        numerador: 4623, denominador: 21097, resultado: 21.91, cumplimiento: 37.47, },
    { centro: 'curico',         numerador: 1147, denominador:  6609, resultado: 17.36, cumplimiento: 29.68, },
    { centro: 'miguel',         numerador:  885, denominador:  3659, resultado: 24.19, cumplimiento: 41.36, },
    { centro: 'betty',          numerador:  601, denominador:  3772, resultado: 15.93, cumplimiento: 27.25, },
    { centro: 'colon',          numerador:  914, denominador:  3331, resultado: 27.44, cumplimiento: 46.92, },
    { centro: 'sarmiento',      numerador:  512, denominador:  1592, resultado: 32.16, cumplimiento: 54.99, },
    { centro: 'niches',         numerador:  564, denominador:  2134, resultado: 26.43, cumplimiento: 45.19, },

    { centro: 'prosperidad',    numerador:  161, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'tutuquen',       numerador:   23, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',       numerador:   29, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',    numerador:   92, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',        numerador:   19, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',    numerador:    9, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',           numerador:   26, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla',  numerador:   21, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',           numerador:   28, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
  ],
},


// 7) Cobertura evaluaci√≥n desarrollo psicomotor (12-23 meses)
{
  codigo: '7',
  nombre: 'Cobertura evaluaci√≥n desarrollo psicomotor (12-23 meses)',
  tipo: 'porcentaje',
  meta: 95.00,
  importancia: 5,
  resultados: [
    // Centros principales (agregados con sus establecimientos)
    { centro: 'comunal',       numerador: 375, denominador: 1190, resultado: 31.51, cumplimiento: 33.17, },
    { centro: 'curico',        numerador:  61, denominador:  267, resultado: 22.85, cumplimiento: 24.05, },
    { centro: 'miguel',        numerador:  89, denominador:  255, resultado: 34.90, cumplimiento: 36.74, },
    { centro: 'betty',         numerador:  76, denominador:  292, resultado: 26.03, cumplimiento: 27.40, },
    { centro: 'colon',         numerador:  54, denominador:  210, resultado: 25.71, cumplimiento: 27.07, },
    { centro: 'sarmiento',     numerador:  48, denominador:  105, resultado: 33.33, cumplimiento: 35.09, },
    { centro: 'niches',        numerador:  47, denominador:  61, resultado: 33.33, cumplimiento: 35.09, },

    // Establecimientos (sin cambios)
    { centro: 'prosperidad',   numerador:   7, denominador:   63, resultado: 11.11, cumplimiento: 11.70, },
    { centro: 'tutuquen',      numerador:   0, denominador:    3, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',      numerador:   0, denominador:   18, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',   numerador:  11, denominador:   60, resultado: 18.33, cumplimiento: 19.30, },
    { centro: 'potrero',       numerador:   3, denominador:   27, resultado: 11.11, cumplimiento: 11.70, },
    { centro: 'chequenlemu',   numerador:   2, denominador:    3, resultado: 66.67, cumplimiento: 70.18, },
    { centro: 'upeo',          numerador:   1, denominador:    6, resultado: 16.67, cumplimiento: 17.54, },
    { centro: 'cordillerilla', numerador:   0, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',          numerador:   4, denominador:   15, resultado: 26.67, cumplimiento: 28.07, },
  ],
},

// 8) Cobertura control adolescentes (10-19 a√±os)
{
  codigo: '8',
  nombre: 'Cobertura control adolescentes (10-19 a√±os)',
  tipo: 'porcentaje',
  meta: 24.17,
  importancia: 6,
  resultados: [
    // Centros principales (agregados con sus establecimientos)
    { centro: 'comunal',       numerador: 1636, denominador: 20368, resultado:  8.03, cumplimiento: 33.22, },
    { centro: 'curico',        numerador:  442, denominador:  5444, resultado:  8.12, cumplimiento: 33.60, },
    { centro: 'miguel',        numerador:  253, denominador:  3687, resultado:  6.86, cumplimiento: 28.38, },
    { centro: 'betty',         numerador:  292, denominador:  4039, resultado:  7.23, cumplimiento: 29.91, },
    { centro: 'colon',         numerador:  331, denominador:  3281, resultado: 10.09, cumplimiento: 41.75, },
    { centro: 'sarmiento',     numerador:  176, denominador:  2078, resultado:  8.47, cumplimiento: 35.04, },
    { centro: 'niches',        numerador:  142, denominador:  1839, resultado:  7.72, cumplimiento: 31.94, },

    // Establecimientos (sin cambios)
    { centro: 'prosperidad',   numerador:   42, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'tutuquen',      numerador:    8, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',      numerador:   13, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',   numerador:   44, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',       numerador:    8, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',   numerador:    0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',          numerador:    0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla', numerador:    1, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',          numerador:    5, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
  ],
},


// 9.1) Cobertura atenci√≥n salud mental
{
  codigo: '9.1',
  nombre: 'Cobertura atenci√≥n salud mental',
  tipo: 'porcentaje',
  meta: 27.11,
  importancia: 5.5,
  resultados: [
    { centro: 'comunal',       numerador: 10960, denominador: 33025, resultado: 33.19, cumplimiento: 122.45, },
    { centro: 'curico',        numerador:  2787, denominador:  9137, resultado: 30.50, cumplimiento: 112.55, },
    { centro: 'miguel',        numerador:  1959, denominador:  6328, resultado: 30.96, cumplimiento: 114.20, },
    { centro: 'betty',         numerador:  2317, denominador:  6261, resultado: 37.01, cumplimiento: 136.59, },
    { centro: 'colon',         numerador:  1631, denominador:  5233, resultado: 31.17, cumplimiento: 114.99, },
    { centro: 'sarmiento',     numerador:  1061, denominador:  3019, resultado: 35.15, cumplimiento: 129.68, },
    { centro: 'niches',        numerador:  1205, denominador:  3047, resultado: 39.53, cumplimiento: 145.82, },

    { centro: 'prosperidad',   numerador:   153, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
    { centro: 'tutuquen',      numerador:    23, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
    { centro: 'porvenir',      numerador:    67, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
    { centro: 'dona_carmen',   numerador:   225, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
    { centro: 'potrero',       numerador:    57, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
    { centro: 'chequenlemu',   numerador:    16, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
    { centro: 'upeo',          numerador:    23, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
    { centro: 'cordillerilla', numerador:    37, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
    { centro: 'obra',          numerador:    74, denominador:     0, resultado:  0.00, cumplimiento:   0.00, },
  ],
},



// 9.2) Tasa controles salud mental
{
  codigo: '9.2',
  nombre: 'Tasa controles salud mental',
  tipo: 'tasa',
  meta: 6.00,
  importancia: 3.3,
  resultados: [
    { centro: 'comunal',        numerador: 18065, denominador: 10960, resultado: 1.65, cumplimiento: 27.50, },
    { centro: 'curico',         numerador:  4225, denominador:  2787, resultado: 1.52, cumplimiento: 25.33, },
    { centro: 'miguel',         numerador:  3408, denominador:  1959, resultado: 1.74, cumplimiento: 29.00, },
    { centro: 'betty',          numerador:  3729, denominador:  2317, resultado: 1.61, cumplimiento: 26.83, },
    { centro: 'colon',          numerador:  2786, denominador:  1631, resultado: 1.71, cumplimiento: 28.50, },
    { centro: 'sarmiento',      numerador:  2122, denominador:  1061, resultado: 2.00, cumplimiento: 33.33, },
    { centro: 'niches',         numerador:  1795, denominador:  1405, resultado: 1.28, cumplimiento: 21.33, },

    { centro: 'prosperidad',    numerador:   251, denominador:   153, resultado: 1.64, cumplimiento: 27.33, },
    { centro: 'tutuquen',       numerador:    34, denominador:    23, resultado: 1.48, cumplimiento: 24.67, },
    { centro: 'porvenir',       numerador:    56, denominador:    67, resultado: 0.84, cumplimiento: 14.00, },
    { centro: 'dona_carmen',    numerador:   416, denominador:   225, resultado: 1.85, cumplimiento: 30.83, },
    { centro: 'potrero',        numerador:    65, denominador:    57, resultado: 1.14, cumplimiento: 19.00, },
    { centro: 'chequenlemu',    numerador:    42, denominador:    16, resultado: 2.62, cumplimiento: 43.67, },
    { centro: 'upeo',           numerador:    46, denominador:    23, resultado: 2.00, cumplimiento: 33.33, },
    { centro: 'cordillerilla',  numerador:    53, denominador:    37, resultado: 1.43, cumplimiento: 23.83, },
    { centro: 'obra',           numerador:    79, denominador:    74, resultado: 1.07, cumplimiento: 17.83, },
  ],
},


// 9.3) Personas egresadas por alta cl√≠nica
{
  codigo: '9.3',
  nombre: 'Personas egresadas por alta cl√≠nica',
  tipo: 'porcentaje',
  meta: 13.00,
  importancia: 2.2,
  resultados: [
    // Centros principales (agregados con sus establecimientos)
    { centro: 'comunal',       numerador: 156, denominador: 10960, resultado:  1.42, cumplimiento: 10.95, },
    { centro: 'curico',        numerador:  18, denominador:  2787, resultado:  0.65, cumplimiento:  4.97, },
    { centro: 'miguel',        numerador:  48, denominador:  1959, resultado:  2.45, cumplimiento: 18.85, },
    { centro: 'betty',         numerador:  38, denominador:  2317, resultado:  1.64, cumplimiento: 12.62, },
    { centro: 'colon',         numerador:  12, denominador:  1631, resultado:  0.74, cumplimiento:  5.66, },
    { centro: 'sarmiento',     numerador:  12, denominador:  1061, resultado:  1.13, cumplimiento:  8.70, },
    { centro: 'niches',        numerador:  28, denominador:  1205, resultado:  2.32, cumplimiento: 17.87, },

    // Establecimientos (sin cambios)
    { centro: 'prosperidad',   numerador:   1, denominador:   153, resultado:  0.65, cumplimiento:  5.03, },
    { centro: 'tutuquen',      numerador:   0, denominador:    23, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',      numerador:   2, denominador:    67, resultado:  2.99, cumplimiento: 22.96, },
    { centro: 'dona_carmen',   numerador:   0, denominador:   225, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',       numerador:   0, denominador:    57, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',   numerador:   1, denominador:    16, resultado:  6.25, cumplimiento: 48.08, },
    { centro: 'upeo',          numerador:   0, denominador:    23, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla', numerador:   0, denominador:    37, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',          numerador:   1, denominador:    74, resultado:  1.35, cumplimiento: 10.40, },
  ],
},


// 10) Cumplimiento GES en APS
{
  codigo: '10',
  nombre: 'Cumplimiento GES en APS',
  tipo: 'porcentaje',
  meta: 100,
  importancia: 0,
  resultados: [
    // Todos los valores siguen en cero (suma de ceros)
    { centro: 'comunal',      numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'curico',       numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'miguel',       numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'betty',        numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'colon',        numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'sarmiento',    numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'niches',       numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100},

    // Establecimientos (sin cambios)
    { centro: 'prosperidad',   numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'tutuquen',      numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'porvenir',      numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'dona_carmen',   numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'potrero',       numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'chequenlemu',   numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'upeo',          numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'cordillerilla', numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 },
    { centro: 'obra',          numerador:    1, denominador:    1, resultado:   100, cumplimiento:   100 }
  ]
},

// 11) Cobertura vacunaci√≥n anti-influenza
{
  codigo: '11',
  nombre: 'Cobertura vacunaci√≥n anti-influenza',
  tipo: 'porcentaje',
  meta: 85.00,
  importancia: 5,
  resultados: [
    { centro: 'comunal',       numerador: 67226, denominador: 94867, resultado: 70.86, cumplimiento: 83.36, },
    { centro: 'curico',        numerador: 16408, denominador: 22004, resultado: 74.57, cumplimiento: 87.73, },
    { centro: 'miguel',        numerador: 10713, denominador: 16945, resultado: 63.22, cumplimiento: 74.38, },
    { centro: 'betty',         numerador: 13622, denominador: 19910, resultado: 68.42, cumplimiento: 80.49, },
    { centro: 'colon',         numerador: 10372, denominador: 13899, resultado: 74.62, cumplimiento: 87.79, },
    { centro: 'sarmiento',     numerador:  9896, denominador: 12852, resultado: 77.00, cumplimiento: 90.59, },
    { centro: 'niches',        numerador:  6215, denominador:  9258, resultado: 67.13, cumplimiento: 78.98, },

    { centro: 'prosperidad',   numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'tutuquen',      numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',      numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',   numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',       numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',   numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',          numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla', numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',          numerador:     0, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
  ],
},

// 12) Ingreso precoz a control de embarazo
{
  codigo: '12',
  nombre: 'Ingreso precoz a control de embarazo',
  tipo: 'porcentaje',
  meta: 90.04,
  importancia: 6,
  resultados: [
    // Centros principales (sumados con sus establecimientos)
    { centro: 'comunal',    numerador:  388, denominador: 426, resultado: 91.08, cumplimiento: 101.15, },
    { centro: 'curico',     numerador:  87, denominador:  88, resultado: 98.86, cumplimiento: 109.80, },
    { centro: 'miguel',     numerador:  87, denominador:  105, resultado: 82.61, cumplimiento: 91.75, },
    { centro: 'betty',      numerador:  93, denominador:  107, resultado: 86.92, cumplimiento: 96.53, },
    { centro: 'colon',      numerador:  61, denominador:  64, resultado: 95.31, cumplimiento: 105.86, },
    { centro: 'sarmiento',  numerador:  38, denominador:  40, resultado: 93.55, cumplimiento: 103.90, },
    { centro: 'niches',     numerador:  22, denominador:  22, resultado: 100.00, cumplimiento: 111.06, },

    // Establecimientos (sin cambios)
    { centro: 'prosperidad',   numerador: 11, denominador: 13, resultado: 84.62, cumplimiento: 93.98, },
    { centro: 'tutuquen',      numerador:  0, denominador:  0, resultado: 0.00, cumplimiento: 0, },
    { centro: 'porvenir',      numerador:  0, denominador:  0, resultado: 0.00, cumplimiento: 0, },
    { centro: 'dona_carmen',   numerador:  9, denominador:  9, resultado: 100.00, cumplimiento: 111.06, },
    { centro: 'potrero',       numerador:  2, denominador:  2, resultado: 100.00, cumplimiento: 111.06, },
    { centro: 'chequenlemu',   numerador:  0, denominador:  0, resultado: 0.00, cumplimiento: 0, },
    { centro: 'upeo',          numerador:  0, denominador:  0, resultado: 0.00, cumplimiento: 0, },
    { centro: 'cordillerilla', numerador:  0, denominador:  0, resultado: 0.00, cumplimiento: 0, },
    { centro: 'obra',          numerador:  2, denominador:  2, resultado: 100.00, cumplimiento: 111.06, },
  ],
},


{
  codigo: '13',
  nombre: 'Cobertura regulaci√≥n fertilidad adolescentes (Solo referencial con REM P Dic 2024)',
  tipo: 'porcentaje',
  meta: 25.91,
  importancia: 6,
  resultados: [
    { centro: 'comunal',         numerador: 2460,  denominador: 9956,  resultado: 24.71, cumplimiento: 95.36, },
    { centro: 'curico',          numerador:  740,  denominador: 2773,  resultado: 26.69, cumplimiento:102.99, },
    { centro: 'miguel',          numerador:  457,  denominador: 1746,  resultado: 26.17, cumplimiento:101.02, },
    { centro: 'betty',           numerador:  400,  denominador: 1891,  resultado: 21.15, cumplimiento: 81.64, },
    { centro: 'colon',           numerador:  348,  denominador: 1579,  resultado: 22.04, cumplimiento: 85.06, },
    { centro: 'sarmiento',       numerador:  283,  denominador: 1062,  resultado: 26.65, cumplimiento:102.85, },
    { centro: 'niches',          numerador:  232,  denominador:  905,  resultado: 25.64, cumplimiento: 98.94, },
    { centro: 'prosperidad',     numerador:   84,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'tutuquen',        numerador:    5,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',        numerador:   13,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',     numerador:   91,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',         numerador:    9,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',     numerador:    0,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',            numerador:    2,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla',   numerador:    5,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',            numerador:   12,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'region_del_maule',numerador:16809,  denominador:    0,  resultado:  0.00, cumplimiento:  0.00, },
  ],
},


{
  codigo: '14',
  nombre: 'Cobertura DM2 (15+ a√±os), (Solo referencial con REM P Dic 2024)',
  tipo: 'porcentaje',
  meta: 71.00,
  importancia: 6,
  resultados: [
    { centro: 'comunal',         numerador: 10992, denominador: 16542, resultado: 66.45, cumplimiento: 93.59, },
    { centro: 'curico',          numerador:  2901, denominador:  4868, resultado: 59.59, cumplimiento: 83.93, },
    { centro: 'miguel',          numerador:  2284, denominador:  3100, resultado: 73.68, cumplimiento:103.77, },
    { centro: 'betty',           numerador:  1864, denominador:  2982, resultado: 62.51, cumplimiento: 88.04, },
    { centro: 'colon',           numerador:  1639, denominador:  2564, resultado: 63.92, cumplimiento: 90.03, },
    { centro: 'sarmiento',       numerador:  1170, denominador:  1419, resultado: 82.45, cumplimiento:116.13, },
    { centro: 'niches',          numerador:  1256, denominador:  1608, resultado: 78.11, cumplimiento:110.01, },

    { centro: 'prosperidad',     numerador:   313, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'tutuquen',        numerador:    57, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',        numerador:    63, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',     numerador:   192, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',         numerador:    63, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',     numerador:    23, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',            numerador:    41, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla',   numerador:    52, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',            numerador:    99, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'region_del_maule',numerador:  89810, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
  ],
},


{
  codigo: '15',
  nombre: 'Cobertura HTA (15+ a√±os), (Solo referencial con REM P Dic 2024)',
  tipo: 'porcentaje',
  meta: 63.50,
  importancia: 6,
  resultados: [
    { centro: 'comunal',         numerador: 22072,  denominador: 37391, resultado: 59.03, cumplimiento: 92.96, },
    { centro: 'curico',          numerador:  5810,  denominador: 11065, resultado: 52.51, cumplimiento: 82.69, },
    { centro: 'miguel',          numerador:  4353,  denominador:  6986, resultado: 62.31, cumplimiento: 98.13, },
    { centro: 'betty',           numerador:  3864,  denominador:  6717, resultado: 57.53, cumplimiento: 90.59, },
    { centro: 'colon',           numerador:  3314,  denominador:  5780, resultado: 57.34, cumplimiento: 90.29, },
    { centro: 'sarmiento',       numerador:  2076,  denominador:  3184, resultado: 65.20, cumplimiento:102.68, },
    { centro: 'niches',          numerador:  2655,  denominador:  3658, resultado: 72.58, cumplimiento:114.30, },

    { centro: 'prosperidad',     numerador:   578,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'tutuquen',        numerador:   129,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',        numerador:   172,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',     numerador:   367,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',         numerador:   166,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',     numerador:    77,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',            numerador:    95,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla',   numerador:   106,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',            numerador:   190,  denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'region_del_maule',numerador: 173278, denominador:     0, resultado:  0.00, cumplimiento:  0.00, },
  ],
},



{
  codigo: '16',
  nombre: 'Proporci√≥n ni√±os sin caries (<3 a√±os)',
  tipo: 'porcentaje',
  meta: 64.67,
  importancia: 5,
  resultados: [
    // Centros principales con dependencias ya sumadas
    { centro: 'comunal',      numerador: 846, denominador: 3780, resultado: 22.38, cumplimiento: 34.61, },
    { centro: 'curico',       numerador: 173, denominador:  829, resultado: 20.87, cumplimiento: 32.27, },
    { centro: 'miguel',       numerador: 144, denominador:  801, resultado: 17.98, cumplimiento: 27.80, },
    { centro: 'betty',        numerador: 177, denominador:  914, resultado: 19.37, cumplimiento: 29.94, },
    { centro: 'colon',        numerador: 153, denominador:  632, resultado: 24.21, cumplimiento: 37.43, },
    { centro: 'sarmiento',    numerador: 109, denominador:  298, resultado: 36.58, cumplimiento: 56.56, },
    { centro: 'niches',       numerador:  90, denominador:  306, resultado: 29.41, cumplimiento: 45.48, },

    // Establecimientos dependientes (sin cambios)
    { centro: 'prosperidad',   numerador:  19, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'tutuquen',      numerador:   1, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',      numerador:   5, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'dona_carmen',   numerador:  29, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'potrero',       numerador:   0, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'chequenlemu',   numerador:   0, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',          numerador:   0, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'cordillerilla', numerador:   0, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'obra',          numerador:   0, denominador:    0, resultado:  0.00, cumplimiento:  0.00, },
  ],
},


    {
  codigo: '17',
  nombre: 'Prevalencia normalidad menores de 2 a√±os (Solo referencial con REM P Dic 2024)',
  tipo: 'porcentaje',
  meta: 61.13,
  importancia: 4,
  resultados: [
    { centro: 'comunal',      numerador: 1362, denominador: 2276, resultado: 59.84, cumplimiento: 97.89, },
    { centro: 'curico',       numerador:  324, denominador:  526, resultado: 61.60, cumplimiento:100.76, },
    { centro: 'miguel',       numerador:  294, denominador:  489, resultado: 60.12, cumplimiento: 98.35, },
    { centro: 'betty',        numerador:  311, denominador:  538, resultado: 57.81, cumplimiento: 94.56, },
    { centro: 'colon',        numerador:  226, denominador:  364, resultado: 62.09, cumplimiento:101.57, },
    { centro: 'sarmiento',    numerador:  109, denominador:  201, resultado: 54.23, cumplimiento: 88.71, },
    { centro: 'niches',       numerador:   98, denominador:  158, resultado: 62.03, cumplimiento:101.46, },
    { centro: 'prosperidad',  numerador:   30, denominador:   48, resultado: 62.50, cumplimiento:102.24, },
    { centro: 'tutuquen',     numerador:    0, denominador:    2, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'porvenir',     numerador:    5, denominador:    7, resultado: 71.43, cumplimiento:116.85, },
    { centro: 'dona_carmen',  numerador:   19, denominador:   40, resultado: 47.50, cumplimiento: 77.70, },
    { centro: 'potrero',      numerador:    8, denominador:   12, resultado: 66.67, cumplimiento:109.06, },
    { centro: 'chequenlemu',  numerador:    0, denominador:    1, resultado:  0.00, cumplimiento:  0.00, },
    { centro: 'upeo',         numerador:    2, denominador:    2, resultado:100.00, cumplimiento:163.59, },
    { centro: 'cordillerilla',numerador:    1, denominador:    2, resultado: 50.00, cumplimiento: 81.79, },
    { centro: 'obra',         numerador:    6, denominador:   10, resultado: 60.00, cumplimiento: 98.15, },
  ],
}
                ]
                };
                
                // Simular un retraso para mostrar el indicador de carga
                setTimeout(() => {
                    resolve(iaapsData);
                }, 1500);
         ¬†¬†¬†});
¬†¬†¬†¬†¬†¬†¬†¬†}
        
        
        // Funci√≥n para procesar datos
        function procesarDatos() {
            // Calcular estad√≠sticas y m√©tricas adicionales para el dashboard
            if (!iaapsData) return;
            
            // Normalizar cumplimientos (m√°ximo 100%)
            iaapsData.indicadores.forEach(indicador => {
                indicador.resultados.forEach(resultado => {
                    if (resultado.cumplimiento > 100) {
                        resultado.cumplimiento = 100;
                    }
                });
            });
        }
        
        // Funci√≥n para actualizar el dashboard
        function actualizarDashboard() {
            if (!iaapsData) return;
            
            // Actualizar tarjetas de resumen
            actualizarTarjetasResumen();
            
            // Actualizar gr√°fico de centros
            actualizarGraficoCentros();
            
            // Actualizar tabla de indicadores
            actualizarTablaIndicadores();
            
            // Actualizar top indicadores
            actualizarTopIndicadores();
            
            // Actualizar tarjetas de centros
            actualizarTarjetasCentros();
        }

        /**
 * Funci√≥n universal para aplicar colores de cumplimiento en todas las tablas
 * seg√∫n los criterios espec√≠ficos:
 * - Verde: Cumplimiento ‚â• 100%
 * - Amarillo: Cumplimiento entre 33.33% y 99%
 * - Rojo: Cumplimiento < 33.33%
 */
function aplicarColoresCumplimiento() {
    // Configuraci√≥n de colores
    const colores = {
        cumplido: {
            fondo: '#e8f5e9',
            texto: '#1b5e20',
            icono: 'fa-check-circle',
            clase: 'bg-success'
        },
        proceso: {
            fondo: '#fff8e1',
            texto: '#f57f17',
            icono: 'fa-exclamation-triangle',
            clase: 'bg-warning'
        },
        critico: {
            fondo: '#ffebee',
            texto: '#b71c1c',
            icono: 'fa-times-circle',
            clase: 'bg-danger'
        }
    };
    
    // Seleccionar todas las celdas de cumplimiento en cualquier tabla
    const selectorCumplimiento = '.cumplimiento, td:nth-child(6):not(.cumplimiento)';
    const celdasCumplimiento = document.querySelectorAll(selectorCumplimiento);
    
    celdasCumplimiento.forEach(celda => {
        // Obtener el texto de la celda
        let valor = celda.textContent.trim();
        
        // Asegurarse de que solo procesamos celdas con valores porcentuales
        if (valor && valor.includes('%')) {
            // Extraer valor num√©rico
            const porcentaje = parseFloat(valor.replace(/[^\d.-]/g, ''));
            
            // Determinar el estado seg√∫n el valor exacto
            let estado;
            if (porcentaje >= 100) {
                estado = colores.cumplido;
            } else if (porcentaje >= 33.33) {
                estado = colores.proceso;
            } else {
                estado = colores.critico;
            }
            
            // Aplicar estilo seg√∫n el tipo de celda
            
            // 1. Si tiene un √≠cono de checkmark, cambiarlo
            const icono = celda.querySelector('i, svg');
            if (icono) {
                // Quitar todas las clases de √≠cono y a√±adir la correcta
                icono.className = `fas ${estado.icono}`;
                icono.style.color = estado.texto;
            }
            
            // 2. Si tiene una barra de progreso, cambiar su color
            const progressBar = celda.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                progressBar.classList.add(estado.clase);
            }
            
            // 3. Si tiene un badge, actualizar su color
            const badge = celda.querySelector('.badge');
            if (badge) {
                badge.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                badge.classList.add(estado.clase);
            }
            
            // 4. Para celdas en la tabla de vista general
            if (celda.classList.contains('cumplimiento')) {
                // Guardar el valor actual
                const valorActual = celda.innerHTML;
                
                // Reemplazar con una versi√≥n coloreada
                celda.innerHTML = `<span style="color: ${estado.texto}; background-color: ${estado.fondo}; 
                                         padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                                        <i class="fas ${estado.icono} mr-1"></i> ${porcentaje.toFixed(2)}%
                                   </span>`;
            }
            
            // 5. Para celdas con formato especial de la tabla comparativa
            const percentageBg = celda.querySelector('.table-percentage-bg');
            if (percentageBg) {
                percentageBg.style.backgroundColor = estado.texto;
                percentageBg.style.opacity = "0.2";
                const percentageText = celda.querySelector('.table-percentage-text');
                if (percentageText) {
                    percentageText.style.color = estado.texto;
                    percentageText.style.fontWeight = "bold";
                }
            }
        }
    });
    
    // Tambi√©n actualizar la funci√≥n de estado para mantener consistencia
    window.determinarEstadoIndicador = function(cumplimiento) {
        if (cumplimiento >= 100) {
            return {
                statusClass: 'status-success',
                statusIcon: 'fa-check-circle',
                statusText: 'CUMPLIDO'
            };
        } else if (cumplimiento >= 33.33) {
            return {
                statusClass: 'status-warning',
                statusIcon: 'fa-exclamation-triangle',
                statusText: 'EN PROCESO'
            };
        } else {
            return {
                statusClass: 'status-danger',
                statusIcon: 'fa-times-circle',
                statusText: 'CR√çTICO'
            };
        }
    };
    
    console.log("Colores de cumplimiento aplicados seg√∫n los criterios: ‚â•100% verde, 25-99% amarillo, <33.33% rojo");
}

// Ejecutar la funci√≥n despu√©s de cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(aplicarColoresCumplimiento, 1000);
});

// Conectar con eventos de actualizaci√≥n existentes
const funcionesUpdate = ['actualizarDashboard', 'actualizarTablaIndicadores', 
                         'actualizarDetalleCentro', 'actualizarDetalleIndicador', 
                         'actualizarVistaComparativa'];

funcionesUpdate.forEach(nombre => {
    const funcionOriginal = window[nombre];
    if (typeof funcionOriginal === 'function') {
        window[nombre] = function() {
            const resultado = funcionOriginal.apply(this, arguments);
            setTimeout(aplicarColoresCumplimiento, 200);
            return resultado;
        };
    }
});

// Llamar inmediatamente para aplicar a la p√°gina actual
aplicarColoresCumplimiento();
        
        // Funci√≥n para actualizar las tarjetas de resumen
function actualizarTarjetasResumen() {
    // Calcular estad√≠sticas generales
    let totalIndicadores = 0;
    let indicadoresCumplidos = 0;
    let indicadoresParciales = 0;
    let indicadoresCriticos = 0;
    let cumplimientoTotal = 0;
    
    // Variables para c√°lculo ponderado
    let sumaPonderada = 0;
    let sumaPonderaciones = 0;
    
    // Solo contar indicadores comunales
    iaapsData.indicadores.forEach(indicador => {
        const resultadoComunal = indicador.resultados.find(r => r.centro === 'comunal');
        if (resultadoComunal) {
            totalIndicadores++;
            cumplimientoTotal += resultadoComunal.cumplimiento || 0;
            
            if (resultadoComunal.cumplimiento >= 100) {
                indicadoresCumplidos++;
            } else if (resultadoComunal.cumplimiento >= 33.33) {
                indicadoresParciales++;
            } else {
                indicadoresCriticos++;
            }
            
            // C√°lculo ponderado (ignorando indicador 10-GES)
            if (indicador.codigo !== '10') {
                // Extraer valor num√©rico de importancia
                const importanciaStr = importanciaIndicadores[indicador.codigo] || '0%';
                const importancia = parseFloat(importanciaStr.replace('%', '')) || 0;
                
                if (importancia > 0) {
                    // Limitar cumplimiento m√°ximo a 100%
                    const cumplimientoEfectivo = Math.min(resultadoComunal.cumplimiento || 0, 100);
                    sumaPonderada += cumplimientoEfectivo * importancia;
                    sumaPonderaciones += importancia;
                }
            }
        }
    });
    
    // C√°lculo simple (original)
    const cumplimientoPromedio = totalIndicadores > 0 ? (cumplimientoTotal / totalIndicadores).toFixed(2) : 0;
    
    // C√°lculo ponderado (nuevo)
    const cumplimientoGlobal = sumaPonderaciones > 0 ? 
        parseFloat((sumaPonderada / sumaPonderaciones).toFixed(2)) : 0;
    
    // Actualizar valores en la interfaz
    document.getElementById('indicadorCumplidosValue').textContent = indicadoresCumplidos;
    document.getElementById('indicadorParcialValue').textContent = indicadoresParciales;
    document.getElementById('indicadorCriticosValue').textContent = indicadoresCriticos;
    document.getElementById('cumplimientoComunalValue').textContent = cumplimientoGlobal + '%';
    
    // Actualizar barras de progreso
    document.getElementById('indicadorCumplidosProgress').style.width = (indicadoresCumplidos / totalIndicadores * 100) + '%';
    document.getElementById('indicadorParcialProgress').style.width = (indicadoresParciales / totalIndicadores * 100) + '%';
    document.getElementById('indicadorCriticosProgress').style.width = (indicadoresCriticos / totalIndicadores * 100) + '%';
    document.getElementById('cumplimientoComunalProgress').style.width = cumplimientoGlobal + '%';
}
        
       // Declaraci√≥n global (por ejemplo, justo despu√©s de tus imports y antes de cualquier funci√≥n)
let centroChartInstance = null;

// Funci√≥n para actualizar el gr√°fico de centros
function actualizarGraficoCentros() {
    const centrosLabels = iaapsData.centros
        .filter(centro => centro.codigo !== 'comunal')
        .map(centro => centro.nombre);
    
    const centrosCumplimiento = [];
    
    iaapsData.centros
        .filter(centro => centro.codigo !== 'comunal')
        .forEach(centro => {
            let cumplimientoTotal = 0;
            let indicadoresContados = 0;
            
            iaapsData.indicadores.forEach(indicador => {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado && resultado.denominador > 0) {
                    cumplimientoTotal += resultado.cumplimiento || 0;
                    indicadoresContados++;
                }
            });
            
            const cumplimientoPromedio = indicadoresContados > 0
                ? parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2))
                : 0;
            
            centrosCumplimiento.push(cumplimientoPromedio);
        });
    
    const ctx = document.getElementById('centroChart').getContext('2d');
    
    // Destruye la instancia anterior (si existe)
    if (centroChartInstance) {
        centroChartInstance.destroy();
    }
    
    // Crea y guarda la nueva instancia
    centroChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: centrosLabels,
            datasets: [{
                label: 'Cumplimiento (%)',
                data: centrosCumplimiento,
                backgroundColor: function(context) {
                    const value = context.dataset.data[context.dataIndex];
                    if (value >= 100) return '#27ae60';
                    else if (value >= 33.33) return '#f39c12';
                    else return '#e74c3c';
                },
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `Cumplimiento: ${ctx.formattedValue}%`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Cumplimiento (%)' }
                },
                x: {
                    title: { display: true, text: 'Centros de Salud' }
                }
            }
        }
    });
    
    // Finalmente actualiza tambi√©n la tabla
    actualizarTablaCentros();
}

        
        // Funci√≥n para actualizar la tabla de centros
        function actualizarTablaCentros() {
            const tableBody = document.getElementById('centroCumplimientoTableBody');
            tableBody.innerHTML = '';
            
            iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                let indicadoresCumplidos = 0;
                let indicadoresParciales = 0;
                let indicadoresCriticos = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (resultado && resultado.denominador > 0) {
                        const cumplimiento = resultado.cumplimiento || 0;
                        cumplimientoTotal += cumplimiento;
                        indicadoresContados++;
                        
                        if (cumplimiento >= 100) {
                            indicadoresCumplidos++;
                        } else if (cumplimiento >= 33.33) {
                            indicadoresParciales++;
                        } else {
                            indicadoresCriticos++;
                        }
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2)) : 0;
                
                let statusClass = '';
                if (cumplimientoPromedio >= 100) statusClass = 'bg-success';
                else if (cumplimientoPromedio >= 33.33) statusClass = 'bg-warning';
                else statusClass = 'bg-danger';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${centro.nombre}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${cumplimientoPromedio}%" aria-valuenow="${cumplimientoPromedio}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${cumplimientoPromedio}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${indicadoresCumplidos}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning">${indicadoresParciales}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-danger">${indicadoresCriticos}</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary btn-ver-detalle" data-centro="${centro.codigo}">
                            <i class="fas fa-eye me-1"></i> Ver detalle
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Event listeners para los botones de ver detalle
            document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const centro = this.dataset.centro;
                    mostrarVista('detailView');
                    seleccionarCentro(centro);
                });
            });
        }
        
       // Variables globales para almacenar las instancias de Chart.js
let topIndicadoresChartInstance = null;
let bottomIndicadoresChartInstance = null;





/**
 * Funci√≥n para actualizar los top/bottom 5 indicadores comunales
 */
function actualizarTopIndicadores() {
    // 1) Recopilar cumplimiento comunal de cada indicador
    const indicadoresComunales = iaapsData.indicadores
        .map(ind => {
            const res = ind.resultados.find(r => r.centro === 'comunal');
            return res && res.denominador > 0
                ? { codigo: ind.codigo, nombre: ind.nombre, cumplimiento: res.cumplimiento || 0 }
                : null;
        })
        .filter(x => x !== null);

    // 2) Ordenar de mayor a menor cumplimiento
    const ordenadosDesc = [...indicadoresComunales].sort((a, b) => b.cumplimiento - a.cumplimiento);

    // 3) Top 5 y bottom 5
    const top5    = ordenadosDesc.slice(0, 5);
    const bottom5 = [...ordenadosDesc].reverse().slice(0, 5);

    // 4) Renderizar los dos gr√°ficos
    actualizarGraficoTop(top5,    'topIndicadoresChart',    true);
    actualizarGraficoTop(bottom5, 'bottomIndicadoresChart', false);
}

/**
 * Funci√≥n para (re)dibujar uno de los gr√°ficos horizontales de top/bottom indicadores
 *
 * @param {Array}  indicadores Array de objetos { codigo, nombre, cumplimiento }
 * @param {string} canvasId     ID del <canvas> en el DOM
 * @param {boolean} isTop       true si es el gr√°fico de top, false si es bottom
 */
function actualizarGraficoTop(indicadores, canvasId, isTop) {
    // Extraer etiquetas y datos
    const labels = indicadores.map(i => i.codigo);
    const data   = indicadores.map(i => i.cumplimiento);

    // Colores seg√∫n rangos
    const backgroundColors = data.map(v =>
        v >= 100 ? '#27ae60'
      : v >= 33.33 ? '#f39c12'
      :            '#e74c3c'
    );

    // Obtener contexto
    const ctx = document.getElementById(canvasId).getContext('2d');

    // Destruir instancia previa si exist√≠a
    if (isTop && topIndicadoresChartInstance) {
        topIndicadoresChartInstance.destroy();
    }
    if (!isTop && bottomIndicadoresChartInstance) {
        bottomIndicadoresChartInstance.destroy();
    }

    // Configuraci√≥n del nuevo gr√°fico
    const cfg = {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Cumplimiento (%)',
                data,
                backgroundColor: backgroundColors,
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: ctxItems => {
                            const idx = ctxItems[0].dataIndex;
                            const ind = indicadores[idx];
                            return `${ind.codigo} ‚Äì ${ind.nombre}`;
                        },
                        label: ctxItem => `Cumplimiento: ${ctxItem.formattedValue}%`
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Cumplimiento (%)' }
                },
                y: {
                    title: { display: true, text: 'Indicador' }
                }
            }
        }
    };

    // Crear la instancia y guardarla
    const newChart = new Chart(ctx, cfg);
    if (isTop) {
        topIndicadoresChartInstance = newChart;
    } else {
        bottomIndicadoresChartInstance = newChart;
    }
}



        
        // Funci√≥n para actualizar las tarjetas de centros
        function actualizarTarjetasCentros() {
            iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (resultado && resultado.denominador > 0) {
                        cumplimientoTotal += resultado.cumplimiento || 0;
                        indicadoresContados++;
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    (cumplimientoTotal / indicadoresContados).toFixed(2) : 0;
                
                // Determinar clase de color
                let colorClass = '';
                if (cumplimientoPromedio >= 100) colorClass = 'bg-success';
                else if (cumplimientoPromedio >= 33.33) colorClass = 'bg-warning';
                else colorClass = 'bg-danger';
                
                // Actualizar tarjeta
                switch (centro.codigo) {
                    case 'curico':
                        document.getElementById('centroCuricoValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroCuricoProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroCuricoProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'miguel':
                        document.getElementById('centroMiguelValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroMiguelProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroMiguelProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'betty':
                        document.getElementById('centroBettyValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroBettyProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroBettyProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'colon':
                        document.getElementById('centroColonValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroColonProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroColonProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'sarmiento':
                        document.getElementById('centroSarmientoValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroSarmientoProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroSarmientoProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'niches':
                        document.getElementById('centroNichesValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroNichesProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroNichesProgress').className = `progress-bar ${colorClass}`;
                        break;
                }
            });
        }
        
        // Funci√≥n para actualizar la vista de detalle
        function actualizarDetalle() {
            if (!iaapsData) return;
            
            // Actualizar detalle de centro seleccionado
            actualizarDetalleCentro();
            
            // Actualizar detalle de indicador seleccionado
            actualizarDetalleIndicador();
            
            // Actualizar vista comparativa
            actualizarVistaComparativa();
        }

        // Variables globales para las instancias de Chart.js
let centroCumplimientoChartInstance = null;
let centroIndicadoresChartInstance = null;

/**
 * Actualiza los gr√°ficos de detalle para el centro seleccionado.
 * Esta funci√≥n unificada sustituye a las versiones anteriores para evitar conflictos.
 */
function actualizarGraficosDetalleCentro() {
    console.log("Actualizando gr√°ficos de detalle para centro:", currentCentro);
    
    // 1) Recolectar datos para el gr√°fico de donut (estado de indicadores)
    const datosCumplimiento = [0, 0, 0]; // [Cumplidos, Parciales, Cr√≠ticos]
    
    // Contador para debugging
    let indicadoresAnalizados = 0;
    
    iaapsData.indicadores.forEach(indicador => {
        const res = indicador.resultados.find(r => r.centro === currentCentro);
        if (res && res.denominador > 0) {
            indicadoresAnalizados++;
            if (res.cumplimiento >= 100) {
                datosCumplimiento[0]++; // Cumplidos
            } else if (res.cumplimiento >= 33.33) {
                datosCumplimiento[1]++; // Parciales
            } else {
                datosCumplimiento[2]++; // Cr√≠ticos
            }
        }
    });
    
    console.log("Indicadores analizados:", indicadoresAnalizados);
    console.log("Datos de cumplimiento:", datosCumplimiento);

    // 2) Destruir instancia previa si existe
    if (centroCumplimientoChartInstance) {
        centroCumplimientoChartInstance.destroy();
    }
    
    // Verificar que el elemento del DOM exista
    const ctxCumplimiento = document.getElementById('centroCumplimientoChart');
    if (!ctxCumplimiento) {
        console.error("No se encontr√≥ el elemento 'centroCumplimientoChart' en el DOM");
        return;
    }
    
    // 3) Crear gr√°fico de tipo "doughnut"
    try {
        centroCumplimientoChartInstance = new Chart(ctxCumplimiento.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Cumplidos', 'Parciales', 'Cr√≠ticos'],
                datasets: [{
                    data: datosCumplimiento,
                    backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                    borderColor: ['#ffffff', '#ffffff', '#ffffff'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    title: { 
                        display: true, 
                        text: 'Estado de Indicadores',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const dataset = tooltipItem.dataset;
                                const total = dataset.data.reduce((acc, data) => acc + data, 0);
                                const value = dataset.data[tooltipItem.dataIndex];
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                return `${tooltipItem.label}: ${value} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error("Error al crear gr√°fico de cumplimiento:", error);
    }

    // 4) Preparar datos para el gr√°fico de barras por categor√≠a
    const categoriasAcum = { 
        Cobertura: [], 
        Tasa: [], 
        Porcentaje: [], 
        Otros: [] 
    };
    
    iaapsData.indicadores.forEach(ind => {
        const res = ind.resultados.find(r => r.centro === currentCentro);
        if (res && res.denominador > 0) {
            // Clasificar por nombre o tipo
            if (/cobertura/i.test(ind.nombre)) {
                categoriasAcum.Cobertura.push(res.cumplimiento);
            } else if (ind.tipo === 'tasa') {
                categoriasAcum.Tasa.push(res.cumplimiento);
            } else if (ind.tipo === 'porcentaje') {
                categoriasAcum.Porcentaje.push(res.cumplimiento);
            } else {
                categoriasAcum.Otros.push(res.cumplimiento);
            }
        }
    });
    
    // Calcular promedios por categor√≠a
    const categorias = [];
    const promedios = [];
    
    for (const [cat, vals] of Object.entries(categoriasAcum)) {
        if (vals.length) {
            categorias.push(cat);
            const suma = vals.reduce((a, b) => a + b, 0);
            promedios.push(parseFloat((suma / vals.length).toFixed(2)));
        }
    }
    
    console.log("Categor√≠as:", categorias);
    console.log("Promedios:", promedios);

    // 5) Destruir instancia previa si existe
    if (centroIndicadoresChartInstance) {
        centroIndicadoresChartInstance.destroy();
    }
    
    // Verificar que el elemento del DOM exista
    const ctxCategoria = document.getElementById('centroIndicadoresChart');
    if (!ctxCategoria) {
        console.error("No se encontr√≥ el elemento 'centroIndicadoresChart' en el DOM");
        return;
    }

    // 6) Crear gr√°fico de barras solo si hay datos
    if (categorias.length > 0) {
        try {
            centroIndicadoresChartInstance = new Chart(ctxCategoria.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: categorias,
                    datasets: [{
                        label: 'Cumplimiento promedio (%)',
                        data: promedios,
                        backgroundColor: function(ctx) {
                            const v = ctx.raw;
                            return v >= 100 ? '#27ae60' : v >= 33.33 ? '#f39c12' : '#e74c3c';
                        },
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { 
                            display: true, 
                            text: 'Cumplimiento por Categor√≠a',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { 
                                display: true, 
                                text: 'Cumplimiento (%)',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            title: { 
                                display: true, 
                                text: 'Categor√≠a',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error al crear gr√°fico de categor√≠as:", error);
        }
    } else {
        console.warn("No hay datos suficientes para crear el gr√°fico de categor√≠as");
        // Mostrar mensaje en el canvas
        const ctx = ctxCategoria.getContext('2d');
        ctx.clearRect(0, 0, ctxCategoria.width, ctxCategoria.height);
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#666';
        ctx.fillText('No hay datos suficientes para esta visualizaci√≥n', 
                    ctxCategoria.width / 2, ctxCategoria.height / 2);
    }
}

// Modificaci√≥n de la funci√≥n actualizarDetalleCentro para asegurar que llame correctamente
function actualizarDetalleCentro() {
    if (!iaapsData) {
        console.error("Datos IAAPS no disponibles");
        return;
    }
    
    console.log("Actualizando detalle del centro:", currentCentro);
    
    if (currentCentro === 'comunal') {
        document.getElementById('establecimientosCard').style.display = 'none';
        document.getElementById('centroCumplimientoTitle').textContent = 'Cumplimiento IAAPS Comunal';
    } else {
        const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
        if (centro) {
            document.getElementById('centroCumplimientoTitle').textContent = `Cumplimiento IAAPS - ${centro.nombre}`;
            
            // Verificar si tiene establecimientos
            const tieneEstablecimientos = establecimientosMap[currentCentro] && establecimientosMap[currentCentro].length > 0;
            document.getElementById('establecimientosCard').style.display = tieneEstablecimientos ? 'block' : 'none';
            
            if (tieneEstablecimientos) {
                actualizarTablaEstablecimientos();
            }
        } else {
            console.error("Centro no encontrado:", currentCentro);
        }
    }
    
    // Actualizar gr√°ficos y tabla de indicadores del centro
    // Envolver en setTimeout para asegurar que el DOM est√© actualizado
    setTimeout(() => {
        actualizarGraficosDetalleCentro();
        actualizarTablaIndicadoresCentro();
    }, 50);
}

// Asegurarse de que Chart.js tenga la configuraci√≥n correcta
function configurarChart() {
    // Configuraci√≥n global para todos los gr√°ficos
    Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#666';
    
    // Configurar animaciones m√°s suaves
    Chart.defaults.animation.duration = 1000;
    Chart.defaults.animation.easing = 'easeOutQuart';
    
    // Configurar colores para modo oscuro si est√° activo
    if (document.body.classList.contains('dark-mode')) {
        Chart.defaults.color = '#e0e0e0';
        Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.1)';
    }
}

// Llamar a la configuraci√≥n cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', configurarChart);

// Tambi√©n configurar cuando se cambia el modo oscuro
document.getElementById('darkModeToggle').addEventListener('change', configurarChart);


        
        
        // Funci√≥n para actualizar la tabla de indicadores del centro
        function actualizarTablaIndicadoresCentro() {
            const tableBody = document.getElementById('centroIndicadoresTableBody');
            tableBody.innerHTML = '';
            
            // Ordenar indicadores por c√≥digo
            const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
                const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
                const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
                return codigoA - codigoB;
            });
            
            indicadoresOrdenados.forEach(indicador => {
                const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                if (!resultado) return;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                
                if (resultado.cumplimiento >= 100) {
                    statusClass = 'bg-success';
                    statusIcon = 'fa-check-circle';
                    statusText = 'Cumplido';
                } else if (resultado.cumplimiento >= 33.33) {
                    statusClass = 'bg-warning';
                    statusIcon = 'fa-exclamation-triangle';
                    statusText = 'Parcial';
                } else {
                    statusClass = 'bg-danger';
                    statusIcon = 'fa-times-circle';
                    statusText = 'Cr√≠tico';
                }
                
                // Verificar si el valor de resultado debe mostrarse como porcentaje o n√∫mero
                let resultadoFormateado = '';
                let metaFormateada = '';
                
                if (indicador.tipo === 'porcentaje') {
                    resultadoFormateado = resultado.resultado.toFixed(2) + '%';
                    metaFormateada = indicador.meta.toFixed(2) + '%';
                } else {
                    resultadoFormateado = resultado.resultado.toFixed(2);
                    metaFormateada = indicador.meta.toFixed(2);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${indicador.codigo}</strong> - ${indicador.nombre}
                    </td>
                    <td class="text-center">${resultado.numerador}</td>
                    <td class="text-center">${resultado.denominador}</td>
                    <td class="text-center">${resultadoFormateado}</td>
                    <td class="text-center">${metaFormateada}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${Math.min(resultado.cumplimiento, 100)}%" aria-valuenow="${resultado.cumplimiento}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${resultado.cumplimiento.toFixed(2)}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge ${statusClass}">
                            <i class="fas ${statusIcon} me-1"></i> ${statusText}
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Funci√≥n para actualizar la tabla de establecimientos
        function actualizarTablaEstablecimientos() {
            const tableBody = document.getElementById('establecimientosTableBody');
            tableBody.innerHTML = '';
            
            // Obtener los establecimientos del centro actual
            const establecimientos = establecimientosMap[currentCentro] || [];
            
            establecimientos.forEach(establecimientoNombre => {
                const establecimientoCodigo = iaapsData.establecimientos
                    .find(e => e.nombre === establecimientoNombre)?.codigo;
                
                if (!establecimientoCodigo) return;
                
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                let indicadoresCumplidos = 0;
                let indicadoresParciales = 0;
                let indicadoresCriticos = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === establecimientoCodigo);
                    if (resultado && resultado.denominador > 0) {
                        cumplimientoTotal += resultado.cumplimiento || 0;
                        indicadoresContados++;
                        
                        if (resultado.cumplimiento >= 33.33) {
                            indicadoresCumplidos++;
                        } else if (resultado.cumplimiento >= 20) {
                            indicadoresParciales++;
                        } else {
                            indicadoresCriticos++;
                        }
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2)) : 0;
                
                let statusClass = '';
                if (cumplimientoPromedio >= 33.33) statusClass = 'bg-success';
                else if (cumplimientoPromedio >= 80) statusClass = 'bg-warning';
                else statusClass = 'bg-danger';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${establecimientoNombre}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${cumplimientoPromedio}%" aria-valuenow="${cumplimientoPromedio}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${cumplimientoPromedio}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${indicadoresCumplidos}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning">${indicadoresParciales}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-danger">${indicadoresCriticos}</span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
       // Instancias globales para los dos charts de indicador

/**
 * Actualiza todo el bloque de detalle de un indicador:
 * - T√≠tulos, f√≥rmulas, meta e importancia
 * - Gr√°ficos de barras y de l√≠nea
 * - Tabla de valores por centro
 */
function actualizarDetalleIndicador() {
    const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
    if (!indicador) return;
    
    // 1) Actualizar texto descriptivo
    document.getElementById('indicadorDetailTitle').textContent =
      `Indicador ${indicador.codigo}: ${indicador.nombre}`;
    document.getElementById('indicadorNombreCompleto').textContent = indicador.nombre;
    document.getElementById('indicadorMetaValor').textContent =
      indicador.meta.toFixed(2) + (indicador.tipo === 'porcentaje' ? '%' : '');
    document.getElementById('indicadorImportanciaValor').textContent =
      importanciaIndicadores[indicador.codigo];
    document.getElementById('indicadorNumeradorFormula').textContent =
      formulasIndicadores[indicador.codigo].numerador;
    document.getElementById('indicadorDenominadorFormula').textContent =
      formulasIndicadores[indicador.codigo].denominador;
    
    // 2) Actualizar gr√°ficos
    actualizarGraficosDetalleIndicador(indicador);
    
    // 3) Actualizar tabla
    actualizarTablaDetalleIndicador(indicador);
}


/**
 * Dibuja (o redibuja) los dos gr√°ficos dentro de la pesta√±a de detalle
 */
function actualizarGraficosDetalleIndicador(indicador) {
  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  //  A) GR√ÅFICO DE BARRAS: cumplimiento por centro
  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  const labels = [];
  const data = [];
  iaapsData.centros
    .filter(c => c.codigo !== 'comunal')
    .forEach(c => {
      const r = indicador.resultados.find(x => x.centro === c.codigo);
      if (r && r.denominador > 0) {
        labels.push(c.nombre);
        data.push(r.cumplimiento || 0);
      }
    });

  // destruir instancia previa si existe
  if (indicadorCentrosChartInstance) {
    indicadorCentrosChartInstance.destroy();
  }

  const ctxBar = document.getElementById('indicadorCentrosChart').getContext('2d');
  indicadorCentrosChartInstance = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Cumplimiento (%)',
        data,
        backgroundColor: ctx => {
          const v = ctx.dataset.data[ctx.dataIndex];
          return v >= 100 ? '#27ae60' : v >= 20 ? '#f39c12' : '#e74c3c';
        },
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Cumplimiento por Centro' }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Cumplimiento (%)' }
        },
        x: {
          title: { display: true, text: 'Centro de Salud' }
        }
      }
    }
  });

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  //  B) GR√ÅFICO DE L√çNEA: tendencia mensual (simulada)
  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  const meses = ['Ene','Feb','Mar','Abr','May','Jun'];
  let v = Math.random() * 50 + 30;
  const trend = meses.map(() => {
    v = Math.max(0, Math.min(100, v + (Math.random()*10-5)));
    return parseFloat(v.toFixed(2));
  });
  const metaArr = Array(meses.length).fill(indicador.meta);

  if (indicadorTendenciaChartInstance) {
    indicadorTendenciaChartInstance.destroy();
  }

  const ctxLine = document.getElementById('indicadorTendenciaChart').getContext('2d');
  indicadorTendenciaChartInstance = new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Resultado',
          data: trend,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52,152,219,0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Meta',
          data: metaArr,
          borderColor: '#e74c3c',
          borderDash: [5,5],
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Tendencia Mensual' }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: indicador.tipo === 'porcentaje' ? 'Resultado (%)' : 'Resultado'
          }
        }
      }
    }
  });
}

/**
 * Rellena la tabla de detalle de indicador fila a fila
 */
function actualizarTablaDetalleIndicador(indicador) {
  const tbody = document.getElementById('indicadorCentrosTableBody');
  tbody.innerHTML = '';

  // fila comunal
  const rc = indicador.resultados.find(r => r.centro === 'comunal');
  if (rc) agregarFilaIndicador(tbody, indicador, rc, 'CURIC√ì (COMUNAL)');

  // dem√°s centros
  iaapsData.centros
    .filter(c => c.codigo !== 'comunal')
    .forEach(c => {
      const r = indicador.resultados.find(x => x.centro === c.codigo);
      if (r) agregarFilaIndicador(tbody, indicador, r, c.nombre);
    });
}

/**
 * Inserta una fila en la tabla dada, con sus badges
 */
function agregarFilaIndicador(tbody, indicador, resultado, nombre) {
  let cls, icon, txt;
  if (resultado.cumplimiento >= 100) {
    cls = 'bg-success'; icon = 'fa-check-circle'; txt = 'Cumplido';
  } else if (resultado.cumplimiento >= 20) {
    cls = 'bg-warning'; icon = 'fa-exclamation-triangle'; txt = 'Parcial';
  } else {
    cls = 'bg-danger'; icon = 'fa-times-circle'; txt = 'Cr√≠tico';
  }

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${nombre}</td>
    <td class="text-center">${resultado.numerador}</td>
    <td class="text-center">${resultado.denominador}</td>
    <td class="text-center">${
      indicador.tipo==='porcentaje'
        ? resultado.resultado.toFixed(2)+'%'
        : resultado.resultado.toFixed(2)
    }</td>
    <td class="text-center">${
      indicador.tipo==='porcentaje'
        ? indicador.meta.toFixed(2)+'%'
        : indicador.meta.toFixed(2)
    }</td>
    <td class="text-center">
      <span class="badge ${cls}">
        <i class="fas ${icon} me-1"></i> ${txt}
      </span>
    </td>
  `;
  tbody.appendChild(tr);
}

        
        // Funci√≥n auxiliar para agregar una fila a la tabla de indicadores
        function agregarFilaIndicador(tableBody, indicador, resultado, nombreCentro) {
            let statusClass = '';
            let statusIcon = '';
            let statusText = '';
            
            if (resultado.cumplimiento >=100) {
                statusClass = 'bg-success';
                statusIcon = 'fa-check-circle';
                statusText = 'Cumplido';
            } else if (resultado.cumplimiento >= 33.33) {
                statusClass = 'bg-warning';
                statusIcon = 'fa-exclamation-triangle';
                statusText = 'Parcial';
            } else {
                statusClass = 'bg-danger';
                statusIcon = 'fa-times-circle';
                statusText = 'Cr√≠tico';
            }
            
            // Verificar si el valor de resultado debe mostrarse como porcentaje o n√∫mero
            let resultadoFormateado = '';
            let metaFormateada = '';
            
            if (indicador.tipo === 'porcentaje') {
                resultadoFormateado = resultado.resultado.toFixed(2) + '%';
                metaFormateada = indicador.meta.toFixed(2) + '%';
            } else {
                resultadoFormateado = resultado.resultado.toFixed(2);
                metaFormateada = indicador.meta.toFixed(2);
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${nombreCentro}</td>
                <td class="text-center">${resultado.numerador}</td>
                <td class="text-center">${resultado.denominador}</td>
                <td class="text-center">${resultadoFormateado}</td>
                <td class="text-center">${metaFormateada}</td>
                <td class="text-center">
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                            <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${Math.min(resultado.cumplimiento, 100)}%" aria-valuenow="${resultado.cumplimiento}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span>${resultado.cumplimiento.toFixed(2)}%</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge ${statusClass}">
                        <i class="fas ${statusIcon} me-1"></i> ${statusText}
                    </span>
                </td>
            `;
            
            tableBody.appendChild(row);
        }
        
      
        
     /* IAAPS DASHBOARD - PARTE 2: FUNCIONALIDADES AVANZADAS */

/*
 * Este archivo complementa la parte 1 del dashboard IAAPS, a√±adiendo:
 * - Finalizaci√≥n de funciones principales
 * - Reconocimiento de voz para navegaci√≥n
 * - Opciones avanzadas de exportaci√≥n
 * - Integraci√≥n de data warehouse
 * - Funcionalidades premium
 */

// Variable global para la instancia del gr√°fico comparativo
let comparativoChartInstance = null;

/**
 * Actualiza la vista comparativa completa
 * Esta funci√≥n coordina la actualizaci√≥n de gr√°ficos y tablas en la vista comparativa
 */
function actualizarVistaComparativa() {
    if (!iaapsData) {
        console.error("Datos IAAPS no disponibles");
        return;
    }
    
    console.log("Actualizando vista comparativa...");
    
    // Actualizar gr√°fico comparativo
    setTimeout(() => {
        actualizarGraficoComparativo();
    }, 50);
    
    // Actualizar tabla comparativa
    setTimeout(() => {
        actualizarTablaComparativa();
    }, 100);
}

/**
 * Actualiza el gr√°fico comparativo de radar
 * Versi√≥n mejorada con mejor manejo de errores y visualizaci√≥n
 */


function actualizarGraficoComparativo() {
    console.log("Actualizando gr√°fico comparativo...");
    
    const canvasElement = document.getElementById('comparativoChart');
    if (!canvasElement) {
        console.error("No se encontr√≥ el elemento 'comparativoChart' en el DOM");
        return;
    }
    
    try {
        // 1) Incluir todos los centros (incluyendo 'comunal')
        const centros = iaapsData.centros;  // ahora con los 6 centros m√°s el comunal
        
        // 2) Definir categor√≠as
        const categorias = {
            'Cobertura': [],
            'Tasa': [],
            'Porcentaje': [],
            'Otro': []
        };
        iaapsData.indicadores.forEach(indicador => {
            const nombre = indicador.nombre.toLowerCase();
            if (nombre.includes('cobertura')) {
                categorias['Cobertura'].push(indicador.codigo);
            } else if (indicador.tipo === 'tasa') {
                categorias['Tasa'].push(indicador.codigo);
            } else if (indicador.tipo === 'porcentaje') {
                categorias['Porcentaje'].push(indicador.codigo);
            } else {
                categorias['Otro'].push(indicador.codigo);
            }
        });
        
        // 3) Preparar datasets
        const colores = [
            { border: 'rgb(52, 152, 219)', background: 'rgba(52, 152, 219, 0.2)' },
            { border: 'rgb(39, 174, 96)',  background: 'rgba(39, 174, 96, 0.2)'  },
            { border: 'rgb(231, 76, 60)',  background: 'rgba(231, 76, 60, 0.2)'  },
            { border: 'rgb(243, 156, 18)', background: 'rgba(243, 156, 18, 0.2)' }
        ];
        const datasets = [];
        let colorIndex = 0;
        
        for (const categoria in categorias) {
            const codigos = categorias[categoria];
            if (!codigos.length) continue;
            
            // Calcular cumplimiento promedio por centro
            const datosCentros = centros.map(centro => {
                let total = 0, count = 0;
                codigos.forEach(codigo => {
                    const ind = iaapsData.indicadores.find(i => i.codigo === codigo);
                    if (ind) {
                        const res = ind.resultados.find(r => r.centro === centro.codigo);
                        if (res && res.denominador > 0) {
                            total += res.cumplimiento || 0;
                            count++;
                        }
                    }
                });
                return count ? +(total / count).toFixed(2) : 0;
            });
            
            if (datosCentros.some(v => v > 0)) {
                const { border, background } = colores[colorIndex];
                datasets.push({
                    label: categoria,
                    data: datosCentros,
                    backgroundColor: background,
                    borderColor: border,
                    borderWidth: 1
                });
                colorIndex = (colorIndex + 1) % colores.length;
            }
        }
        
        // 4) Destruir instancia previa
        if (comparativoChartInstance) {
            comparativoChartInstance.destroy();
        }
        
        // 5) Validar que existan datos
        if (!datasets.length || !centros.length) {
            const ctx = canvasElement.getContext('2d');
            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#666';
            ctx.fillText(
                'No hay datos suficientes para esta visualizaci√≥n',
                canvasElement.width / 2,
                canvasElement.height / 2
            );
            return;
        }
        
        // 6) Crear gr√°fico de barras
        const ctx = canvasElement.getContext('2d');
        comparativoChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: centros.map(c => c.nombre),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Centros' },
                        ticks: { font: { size: 12 } }
                    },
                    y: {
                        min: 0,
                        max: 100,
                        title: { display: true, text: 'Cumplimiento (%)' },
                        ticks: {
                            stepSize: 20,
                            font: { size: 12 }
                        }
                    }
                },
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: value => `${value}%`,
                        font: { size: 10 }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12 },
                            padding: 20
                        }
                    },
                    title: {
                        display: true,
                        text: 'Comparativo de Cumplimiento por Categor√≠a',
                        font: { size: 16, weight: 'bold' },
                        padding: 20
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
        
        console.log("Gr√°fico comparativo actualizado correctamente");
    } catch (error) {
        console.error("Error al actualizar gr√°fico comparativo:", error);
        const ctx = canvasElement.getContext('2d');
        ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#e74c3c';
        ctx.fillText(
            'Error al generar la visualizaci√≥n',
            canvasElement.width / 2,
            canvasElement.height / 2
        );
        ctx.font = '14px Arial';
        ctx.fillText(
            'Consulte la consola para m√°s detalles',
            canvasElement.width / 2,
            canvasElement.height / 2 + 30
        );
    }
}


/**
 * Actualiza la tabla comparativa con datos de todos los centros e indicadores
 * Versi√≥n mejorada con mejor formateo y manejo de errores
 */
function actualizarTablaComparativa() {
    console.log("Actualizando tabla comparativa...");
    
    const tableBody = document.getElementById('comparativoTableBody');
    if (!tableBody) {
        console.error("No se encontr√≥ el elemento 'comparativoTableBody' en el DOM");
        return;
    }
    
    try {
        tableBody.innerHTML = '';
        
        // Ordenar indicadores por c√≥digo
        const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
            const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
            const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
            return codigoA - codigoB;
        });
        
        // Crear una fila para cada indicador
        indicadoresOrdenados.forEach(indicador => {
            const row = document.createElement('tr');
            
            // Primera columna: nombre del indicador
            const tdIndicador = document.createElement('td');
            tdIndicador.innerHTML = `<strong>${indicador.codigo}</strong> - ${indicador.nombre}`;
            row.appendChild(tdIndicador);
            
            // Segunda columna: meta
            const tdMeta = document.createElement('td');
            tdMeta.className = 'text-center';
            tdMeta.textContent = indicador.tipo === 'porcentaje' ? 
                indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2);
            row.appendChild(tdMeta);
            
            // Columna para cada centro
            iaapsData.centros.forEach(centro => {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado) {
                    const tdCentro = document.createElement('td');
                    tdCentro.className = 'text-center table-percentage-cell';
                    
                    // Calcular color seg√∫n porcentaje de cumplimiento
                    let color = '';
                    
                    if (resultado.cumplimiento >= 100) {
                        color = '#27ae60'; // Verde - Cumplido
                    } else if (resultado.cumplimiento >= 33.33) {
                        color = '#f39c12'; // Amarillo - Parcial
                    } else {
                        color = '#e74c3c'; // Rojo - Cr√≠tico
                    }
                    
                    // Limitar cumplimiento m√°ximo a 100% para la visualizaci√≥n
                    const cumplimientoMostrado = Math.min(resultado.cumplimiento, 100);
                    
                    // Crear visualizaci√≥n de porcentaje con barra de fondo
                    tdCentro.innerHTML = `
                        <div class="table-percentage-bg" style="background-color: ${color}; width: ${cumplimientoMostrado}%;"></div>
                        <span class="table-percentage-text">${resultado.cumplimiento.toFixed(2)}%</span>
                    `;
                    
                    row.appendChild(tdCentro);
                } else {
                    const tdCentro = document.createElement('td');
                    tdCentro.className = 'text-center';
                    tdCentro.textContent = '-';
                    row.appendChild(tdCentro);
                }
            });
            
            tableBody.appendChild(row);
        });
        
        // Agregar evento para interactividad (opcional)
        const filas = tableBody.querySelectorAll('tr');
        filas.forEach(fila => {
            fila.addEventListener('mouseover', function() {
                this.style.backgroundColor = document.body.classList.contains('dark-mode') ?
                    'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.02)';
            });
            
            fila.addEventListener('mouseout', function() {
                this.style.backgroundColor = '';
            });
        });
        
        console.log("Tabla comparativa actualizada correctamente");
    } catch (error) {
        console.error("Error al actualizar tabla comparativa:", error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="${iaapsData.centros.length + 2}" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar la tabla comparativa. Consulte la consola para m√°s detalles.
                </td>
            </tr>
        `;
    }
}

/**
 * Funci√≥n auxiliar para exportar el gr√°fico comparativo a imagen
 * Nueva funcionalidad √∫til
 */
function exportarGraficoComparativoImagen() {
    if (!comparativoChartInstance) {
        mostrarNotificacion('No hay gr√°fico para exportar', 'error');
        return;
    }
    
    try {
        const canvas = document.getElementById('comparativoChart');
        const imgData = canvas.toDataURL('image/png');
        
        // Crear enlace de descarga
        const link = document.createElement('a');
        link.href = imgData;
        link.download = `IAAPS_Comparativo_${new Date().toISOString().split('T')[0]}.png`;
        link.click();
        
        mostrarNotificacion('Imagen exportada correctamente', 'success');
    } catch (error) {
        console.error("Error al exportar imagen:", error);
        mostrarNotificacion('Error al exportar imagen', 'error');
    }
}

// A√±adir bot√≥n de exportar imagen (opcional, puedes implementarlo en tu HTML)
function agregarBotonExportarImagen() {
    const btnContainer = document.querySelector('#comparativo-content .card-header div');
    if (btnContainer) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-primary ms-2';
        btn.innerHTML = '<i class="fas fa-image me-1"></i> PNG';
        btn.id = 'exportarComparativoImgBtn';
        btn.addEventListener('click', exportarGraficoComparativoImagen);
        btnContainer.appendChild(btn);
    }
}

// Ejecutar cuando se cargue la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    // Escuchar cambios de pesta√±a para actualizar gr√°ficos cuando se seleccione "Comparativo"
    const comparativoTab = document.getElementById('comparativo-tab');
    if (comparativoTab) {
        comparativoTab.addEventListener('shown.bs.tab', () => {
            setTimeout(actualizarVistaComparativa, 100);
        });
    }
    
    // Agregar bot√≥n de exportar imagen (opcional)
    setTimeout(agregarBotonExportarImagen, 1000);
});

// Funci√≥n para buscar indicadores
function buscarIndicadores(searchTerm) {
    if (!searchTerm) {
        // Si no hay t√©rmino de b√∫squeda, mostrar todos los indicadores
        document.querySelectorAll('.indicador-row').forEach(row => {
            row.style.display = '';
        });
        return;
    }
    
    document.querySelectorAll('.indicador-row').forEach(row => {
        const indicadorCodigo = row.dataset.indicador;
        const indicador = iaapsData.indicadores.find(i => i.codigo === indicadorCodigo);
        
        if (indicador) {
            const textoIndicador = (indicador.codigo + ' ' + indicador.nombre).toLowerCase();
            
            if (textoIndicador.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}

// Funci√≥n para seleccionar un centro
function seleccionarCentro(codigo) {
    currentCentro = codigo;
    
    // Actualizar t√≠tulo del breadcrumb
    if (codigo === 'comunal') {
        document.getElementById('detailBreadcrumb').textContent = 'Detalle Comunal';
    } else {
        const centro = iaapsData.centros.find(c => c.codigo === codigo);
        if (centro) {
            document.getElementById('detailBreadcrumb').textContent = 'Detalle ' + centro.nombre;
        }
    }
    
    // Actualizar vista de detalle
    actualizarDetalleCentro();
}

// Funci√≥n para seleccionar un indicador
function seleccionarIndicador(codigo) {
    currentIndicador = codigo;
    
    // Actualizar t√≠tulo del breadcrumb
    const indicador = iaapsData.indicadores.find(i => i.codigo === codigo);
    if (indicador) {
        document.getElementById('detailBreadcrumb').textContent = 'Indicador ' + indicador.codigo;
    }
    
    // Actualizar vista de detalle
    actualizarDetalleIndicador();
}

// Funci√≥n para mostrar una vista
function mostrarVista(vista) {
    const vistas = ['dashboardView', 'detailView'];
    
    vistas.forEach(v => {
        document.getElementById(v).style.display = v === vista ? 'block' : 'none';
    });
    
    // Actualizar clase active en la navegaci√≥n
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    if (vista === 'dashboardView') {
        document.getElementById('dashboardLink').classList.add('active');
    } else if (vista === 'detailView') {
        document.getElementById('detailLink').classList.add('active');
    }
}

// Funci√≥n para mostrar/ocultar indicador de carga
function mostrarCargando(mostrar) {
    document.getElementById('loadingOverlay').style.display = mostrar ? 'flex' : 'none';
}

// Funci√≥n para mostrar notificaci√≥n
function mostrarNotificacion(mensaje, tipo) {
    // Crear elemento de notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `toast align-items-center text-white bg-${tipo} border-0`;
    notificacion.setAttribute('role', 'alert');
    notificacion.setAttribute('aria-live', 'assertive');
    notificacion.setAttribute('aria-atomic', 'true');
    
    notificacion.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${mensaje}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Agregar al contenedor de notificaciones
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.appendChild(notificacion);
    document.body.appendChild(container);
    
    // Mostrar notificaci√≥n
    const toast = new bootstrap.Toast(notificacion, { delay: 3000 });
    toast.show();
    
    // Eliminar del DOM despu√©s de ocultarse
    notificacion.addEventListener('hidden.bs.toast', function() {
        container.remove();
    });
}

// Funci√≥n para exportar a Excel
function exportarExcel(tipo) {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            let data = [];
            let nombreArchivo = '';
            
            if (tipo === 'centro') {
                // Exportar datos del centro seleccionado
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (!centro) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_${centro.nombre}_Abril_2025.xlsx`;
                
                // Encabezados
                data.push(['Indicador', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']);
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                    if (!resultado) return;
                    
                    let estado = '';
                    if (resultado.cumplimiento >= 100) estado = 'Cumplido';
                    else if (resultado.cumplimiento >= 33.33) estado = 'Parcial';
                    else estado = 'Cr√≠tico';
                    
                    data.push([
                        `${indicador.codigo} - ${indicador.nombre}`,
                        resultado.numerador,
                        resultado.denominador,
                        indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        resultado.cumplimiento.toFixed(2) + '%',
                        estado
                    ]);
                });
            } else if (tipo === 'indicador') {
                // Exportar datos del indicador seleccionado
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                if (!indicador) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_Indicador_${indicador.codigo}_Abril_2025.xlsx`;
                
                // Encabezados
                data.push(['Centro', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']);
                
                // Datos
                iaapsData.centros.forEach(centro => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (!resultado) return;
                    
                    let estado = '';
                    if (resultado.cumplimiento >= 100) estado = 'Cumplido';
                    else if (resultado.cumplimiento >= 33.33) estado = 'Parcial';
                    else estado = 'Cr√≠tico';
                    
                    data.push([
                        centro.nombre,
                        resultado.numerador,
                        resultado.denominador,
                        indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        resultado.cumplimiento.toFixed(2) + '%',
                        estado
                    ]);
                });
            } else if (tipo === 'comparativo') {
                // Exportar tabla comparativa
                nombreArchivo = `IAAPS_Comparativo_Abril_2025.xlsx`;
                
                // Encabezados
                const headers = ['Indicador', 'Meta'];
                iaapsData.centros.forEach(centro => {
                    headers.push(centro.nombre);
                });
                data.push(headers);
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const row = [
                        `${indicador.codigo} - ${indicador.nombre}`,
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
                    ];
                    
                    iaapsData.centros.forEach(centro => {
                        const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                        if (resultado) {
                            row.push(resultado.cumplimiento.toFixed(2) + '%');
                        } else {
                            row.push('-');
                        }
                    });
                    
                    data.push(row);
                });
            }
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Ajustar ancho de columnas
            const wscols = data[0].map((col, i) => {
                const maxLength = data.reduce((w, r) => Math.max(w, r[i] ? r[i].toString().length : 0), col.length);
                return { wch: maxLength + 2 };
            });
            ws['!cols'] = wscols;
            
            // Aplicar formato de celda
            for (let i = 1; i < data.length; i++) {
                for (let j = 0; j < data[i].length; j++) {
                    const cell_ref = XLSX.utils.encode_cell({ r: i, c: j });
                    
                    // Aplicar colores seg√∫n estado para columna de cumplimiento
                    if (tipo === 'centro' && j === 5 || tipo === 'indicador' && j === 5) {
                        const cumplimiento = parseFloat(data[i][j]);
                        if (cumplimiento >= 100) {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "27AE60" } }, font: { color: { rgb: "FFFFFF" } } };
                        } else if (cumplimiento >=33.33) {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "F39C12" } }, font: { color: { rgb: "FFFFFF" } } };
                        } else {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "E74C3C" } }, font: { color: { rgb: "FFFFFF" } } };
                        }
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "IAAPS");
            XLSX.writeFile(wb, nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('Datos exportados correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a Excel:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos', 'error');
        }
    }, 1000);
}

// Funci√≥n para exportar a PDF
function exportarPDF(tipo) {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let nombreArchivo = '';
            let titulo = '';
            let datos = [];
            let columnas = [];
            
            if (tipo === 'centro') {
                // Exportar datos del centro seleccionado
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (!centro) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_${centro.nombre}_Abril_2025.pdf`;
                titulo = `Reporte IAAPS - ${centro.nombre} - Abril 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Indicador', dataKey: 'indicador' },
                    { header: 'Numerador', dataKey: 'numerador' },
                    { header: 'Denominador', dataKey: 'denominador' },
                    { header: 'Resultado', dataKey: 'resultado' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Cumplimiento', dataKey: 'cumplimiento' }
                ];
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                    if (!resultado) return;
                    
                    datos.push({
                        indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 30)}...`,
                        numerador: resultado.numerador,
                        denominador: resultado.denominador,
                        resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
            } else if (tipo === 'indicador') {
                // Exportar datos del indicador seleccionado
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                if (!indicador) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_Indicador_${indicador.codigo}_Abril_2025.pdf`;
                titulo = `Reporte IAAPS - Indicador ${indicador.codigo} - Abril 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Centro', dataKey: 'centro' },
                    { header: 'Numerador', dataKey: 'numerador' },
                    { header: 'Denominador', dataKey: 'denominador' },
                    { header: 'Resultado', dataKey: 'resultado' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Cumplimiento', dataKey: 'cumplimiento' }
                ];
                
                // Datos
                iaapsData.centros.forEach(centro => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (!resultado) return;
                    
                    datos.push({
                        centro: centro.nombre,
                        numerador: resultado.numerador,
                        denominador: resultado.denominador,
                        resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
            } else if (tipo === 'comparativo') {
                // Exportar tabla comparativa
                nombreArchivo = `IAAPS_Comparativo_Abril_2025.pdf`;
                titulo = `Reporte IAAPS - Comparativo - Abril 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Indicador', dataKey: 'indicador' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Comunal', dataKey: 'comunal' }
                ];
                
                // Agregar columnas para cada centro excepto el comunal
                iaapsData.centros.filter(c => c.codigo !== 'comunal').forEach(centro => {
                    columnas.push({ header: centro.nombre, dataKey: centro.codigo });
                });
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const row = {
                        indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 20)}...`,
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
                    };
                    
                    // Agregar datos para cada centro
                    iaapsData.centros.forEach(centro => {
                        const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                        if (resultado) {
                            row[centro.codigo] = resultado.cumplimiento.toFixed(2) + '%';
                        } else {
                            row[centro.codigo] = '-';
                        }
                    });
                    
                    datos.push(row);
                });
            }
            
            // A√±adir t√≠tulo
            doc.setFontSize(18);
            doc.text(titulo, 14, 22);
            
            // A√±adir fecha
            doc.setFontSize(11);
            doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // A√±adir tabla
            doc.autoTable({
                columns: columnas,
                body: datos,
                startY: 35,
                styles: { fontSize: 8 },
                columnStyles: {
                    indicador: { cellWidth: 60 }
                },
                didDrawCell: function(data) {
                    // Colorear celdas de cumplimiento
                    if ((tipo === 'centro' && data.column.dataKey === 'cumplimiento') || 
                        (tipo === 'indicador' && data.column.dataKey === 'cumplimiento')) {
                        
                        if (data.cell.text.length > 0) {
                            const cumplimiento = parseFloat(data.cell.text[0]);
                            
                            if (cumplimiento >= 100) {
                                doc.setFillColor(39, 174, 96); // Verde
                            } else if (cumplimiento >= 100) {
                                doc.setFillColor(243, 156, 18); // Amarillo
                            } else {
                                doc.setFillColor(231, 76, 60); // Rojo
                            }
                            
                            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                            doc.setTextColor(255, 255, 255); // Texto blanco
                            doc.text(data.cell.text, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, {
                                align: 'center',
                                baseline: 'middle'
                            });
                        }
                    }
                }
            });
            
            // A√±adir pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`P√°gina ${i} de ${pageCount} - INFOGES Curic√≥ - Dashboard de Control`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, {
                    align: 'center'
                });
            }
            
            // Guardar PDF
            doc.save(nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('PDF exportado correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a PDF:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos', 'error');
        }
    }, 1000);
}

// Funci√≥n para alternar el modo oscuro
function toggleDarkMode() {
    darkMode = !darkMode;
    
    if (darkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
    
    // Actualizar gr√°ficos con nuevos colores
    actualizarDashboard();
    actualizarDetalle();
}

// ==================== FUNCIONALIDADES AVANZADAS ====================

// Integraci√≥n de comandos de voz
function inicializarComandosVoz() {
    if (!('webkitSpeechRecognition' in window)) {
        console.error('API de reconocimiento de voz no soportada');
        return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    // Agregar bot√≥n de micr√≥fono al navbar
    const navbarEnd = document.querySelector('.navbar .d-flex');
    const micButton = document.createElement('button');
    micButton.className = 'btn btn-outline-light ms-3';
    micButton.id = 'micButton';
    micButton.innerHTML = '<i class="fas fa-microphone"></i>';
    navbarEnd.appendChild(micButton);
    
    // Estado del reconocimiento
    let isListening = false;
    
    // Evento de click del bot√≥n de micr√≥fono
    micButton.addEventListener('click', function() {
        if (isListening) {
            recognition.stop();
            micButton.innerHTML = '<i class="fas fa-microphone"></i>';
            isListening = false;
        } else {
            recognition.start();
            micButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            isListening = true;
            
            mostrarNotificacion('Escuchando... diga un comando', 'success');
        }
    });
    

    // Aqu√≠ asumimos que tu bot√≥n de micr√≥fono usa id="micButton" y que su handler .click() inicia/parar el reconocimiento
document.addEventListener('keydown', function(event) {
    // Si est√°s escribiendo en un input o textarea, evitamos dispararlo
    const tag = event.target.tagName.toLowerCase();
    if (tag === 'input' || tag === 'textarea') return;

    // ‚ÄúClickea‚Äù el bot√≥n para activar el micr√≥fono
    document.getElementById('micButton').click();
});


    
    // Evento de finalizaci√≥n del reconocimiento
    recognition.onend = function() {
        micButton.innerHTML = '<i class="fas fa-microphone"></i>';
        isListening = false;
    };
    
    // Evento de error del reconocimiento
    recognition.onerror = function(event) {
        console.error('Error en reconocimiento de voz:', event.error);
        micButton.innerHTML = '<i class="fas fa-microphone"></i>';
        isListening = false;
        
        mostrarNotificacion('Error en reconocimiento de voz', 'error');
    };
    
    // Evento de resultado del reconocimiento
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.toLowerCase();
        console.log('Comando de voz:', transcript);
        
        // Procesar comandos
        procesarComandoVoz(transcript);
    };
}

// Procesar comandos de voz
function procesarComandoVoz(comando) {
    // Comandos de navegaci√≥n
    if (comando.includes('dashboard') || comando.includes('inicio')) {
        mostrarVista('dashboardView');
        mostrarNotificacion('Mostrando dashboard', 'success');
    } else if (comando.includes('detalle') || comando.includes('detalles')) {
        mostrarVista('detailView');
        mostrarNotificacion('Mostrando vista de detalle', 'success');
    } else if (comando.includes('ayuda')) {
        const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
        helpModal.show();
        mostrarNotificacion('Mostrando ayuda', 'success');
    } else if (comando.includes('actualizar') || comando.includes('refrescar')) {
        cargarDatos();
        mostrarNotificacion('Actualizando datos', 'success');
    } else if (comando.includes('modo oscuro') || comando.includes('modo noche')) {
        document.getElementById('darkModeToggle').checked = !document.getElementById('darkModeToggle').checked;
        toggleDarkMode();
        mostrarNotificacion(
          `Modo oscuro ${document.getElementById('darkModeToggle').checked ? 'activado' : 'desactivado'}`,
          'success'
        );
    } else if (comando.includes('modo claro') || comando.includes('modo d√≠a')) {
        if (document.getElementById('darkModeToggle').checked) {
            document.getElementById('darkModeToggle').checked = false;
            toggleDarkMode();
            mostrarNotificacion('Modo claro activado', 'success');
        } else {
            mostrarNotificacion('Ya est√°s en modo claro', 'info');
        }
    }
    // Comando salir
    else if (comando.includes('salir')) {
        window.location.href = '../../index.html';
    }
    // Comando IAAPS
    else if (comando.includes('panel iaaps') || comando.includes('iaaps')) {
        if (window.location.pathname.endsWith('../../iaaps/abril/')) {
            mostrarNotificacion('Ya est√°s en IAAPS', 'info');
        } else {
            window.location.href = 'index.html';
        }
    }
    // Comando Metas Sanitarias
    else if (comando.includes('panel metas sanitarias') || comando.includes('meta sanitaria')) {
        if (window.location.pathname.endsWith('../../metassanitarias/abril/')) {
            mostrarNotificacion('Ya est√°s en Metas Sanitarias', 'info');
        } else {
            window.location.href = 'index.html';
        }
    }
    // Comando Tablero Poblacional
    else if (comando.includes('tablero poblacional') || comando.includes('poblacion')) {
        if (window.location.pathname.endsWith('../../tablero/')) {
            mostrarNotificacion('Ya est√°s en Tablero Poblacional', 'info');
        } else {
            window.location.href = 'index.html';
        }
    }
       
    // Comandos de exportaci√≥n
    else if (comando.includes('exportar') || comando.includes('descargar')) {
        if (comando.includes('excel')) {
            if (document.getElementById('dashboardView').style.display !== 'none') {
                exportarExcel('comparativo');
            } else {
                if (document.getElementById('centro-content').classList.contains('active')) {
                    exportarExcel('centro');
                } else if (document.getElementById('indicador-content').classList.contains('active')) {
                    exportarExcel('indicador');
                } else {
                    exportarExcel('comparativo');
                }
            }
            mostrarNotificacion('Exportando a Excel', 'success');
        } else if (comando.includes('pdf')) {
            if (document.getElementById('dashboardView').style.display !== 'none') {
                exportarPDF('comparativo');
            } else {
                if (document.getElementById('centro-content').classList.contains('active')) {
                    exportarPDF('centro');
                } else if (document.getElementById('indicador-content').classList.contains('active')) {
                    exportarPDF('indicador');
                } else {
                    exportarPDF('comparativo');
                }
            }
            mostrarNotificacion('Exportando a PDF', 'success');
        }
    }
    
    // Comandos de centros
    else if (comando.includes('centro')) {
        if (comando.includes('curic√≥ centro') || comando.includes('curico centro')) {
            mostrarVista('detailView');
            seleccionarCentro('curico');
            mostrarNotificacion('Mostrando CESFAM Curic√≥ Centro', 'success');
        } else if (comando.includes('miguel √°ngel') || comando.includes('miguel angel')) {
            mostrarVista('detailView');
            seleccionarCentro('miguel');
            mostrarNotificacion('Mostrando CESFAM Miguel √Ångel Arenas', 'success');
        } else if (comando.includes('betty mu√±oz') || comando.includes('betty munoz')) {
            mostrarVista('detailView');
            seleccionarCentro('betty');
            mostrarNotificacion('Mostrando CESFAM Betty Mu√±oz', 'success');
        } else if (comando.includes('col√≥n') || comando.includes('colon')) {
            mostrarVista('detailView');
            seleccionarCentro('colon');
            mostrarNotificacion('Mostrando CESFAM Col√≥n', 'success');
        } else if (comando.includes('sarmiento')) {
            mostrarVista('detailView');
            seleccionarCentro('sarmiento');
            mostrarNotificacion('Mostrando CESFAM Sarmiento', 'success');
        } else if (comando.includes('los niches') || comando.includes('niches')) {
            mostrarVista('detailView');
            seleccionarCentro('niches');
            mostrarNotificacion('Mostrando CESFAM Los Niches', 'success');
        } else if (comando.includes('comunal')) {
            mostrarVista('detailView');
            seleccionarCentro('comunal');
            mostrarNotificacion('Mostrando detalle comunal', 'success');
        }
    }
    
    // Comandos para indicadores espec√≠ficos
    else if (comando.includes('indicador')) {
        // Extraer n√∫mero de indicador
        let numeroIndicador = null;
        const match = comando.match(/indicador\s+(\d+(\.\d+)?([a-zA-Z])?)/);
        
        if (match) {
            numeroIndicador = match[1];
            
            // Buscar indicador
            const indicador = iaapsData.indicadores.find(i => i.codigo === numeroIndicador);
            
            if (indicador) {
                mostrarVista('detailView');
                document.getElementById('indicador-tab').click();
                seleccionarIndicador(numeroIndicador);
                mostrarNotificacion(`Mostrando indicador ${numeroIndicador}`, 'success');
            } else {
                mostrarNotificacion(`Indicador ${numeroIndicador} no encontrado`, 'error');
            }
        } else {
            mostrarNotificacion('Por favor, especifique un n√∫mero de indicador', 'error');
        }
    }
    
    // Comando para buscar
    else if (comando.includes('buscar')) {
        const termino = comando.replace('buscar', '').trim();
        document.getElementById('searchInput').value = termino;
        buscarIndicadores(termino);
        mostrarNotificacion(`Buscando: ${termino}`, 'success');
    }
    
    // Comando no reconocido
    else {
        mostrarNotificacion('Comando no reconocido', 'error');
    }
}



// ==================== EXTENSI√ìN DE FUNCIONALIDADES PRINCIPALES ====================

// Extender funci√≥n mostrarVista para incluir nueva vista
const mostrarVistaOriginal = mostrarVista;
mostrarVista = function(vista) {
    const vistas = ['dashboardView', 'detailView', 'tendenciasView'];
    
    vistas.forEach(v => {
        const elemento = document.getElementById(v);
        if (elemento) {
            elemento.style.display = v === vista ? 'block' : 'none';
        }
    });
    
    // Actualizar clase active en la navegaci√≥n
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    if (vista === 'dashboardView') {
        document.getElementById('dashboardLink').classList.add('active');
    } else if (vista === 'detailView') {
        document.getElementById('detailLink').classList.add('active');
    } else if (vista === 'tendenciasView') {
        const tendenciasLink = document.getElementById('tendenciasLink');
        if (tendenciasLink) {
            tendenciasLink.classList.add('active');
        }
    }
};

// Funci√≥n para inicializar funcionalidades avanzadas
function inicializarFuncionalidadesAvanzadas() {
    // Inicializar comandos de voz
    inicializarComandosVoz();
    
    // Inicializar visualizaci√≥n de tendencias
    visualizarTendenciasHistoricas();
    
    // A√±adir otras funcionalidades avanzadas seg√∫n sea necesario
}

// Event listener para inicializar funcionalidades avanzadas
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que todo el dashboard est√© cargado
    setTimeout(inicializarFuncionalidadesAvanzadas, 1000);
});

// Instancias globales para Chart.js (detalle de indicador)


/**
 * Actualiza los gr√°ficos de detalle para el indicador seleccionado.
 * @param {Object} indicador  El objeto indicador de iaapsData.indicadores
 */
function actualizarGraficosDetalleIndicador(indicador) {
  // --- GR√ÅFICO 1: Barras de Cumplimiento por Centro (incluye 'comunal') ---
  const centrosLabels = [];
  const centrosCumplimiento = [];
  iaapsData.centros.forEach(centro => {
    const res = indicador.resultados.find(r => r.centro === centro.codigo);
    if (res && res.denominador > 0) {
      centrosLabels.push(centro.nombre);
      centrosCumplimiento.push(res.cumplimiento || 0);
    }
  });

  // Destruir la instancia previa si existe
  if (indicadorCentrosChartInstance) {
    indicadorCentrosChartInstance.destroy();
  }

  // Crear nuevo gr√°fico de barras
  const ctxCentros = document
    .getElementById('indicadorCentrosChart')
    .getContext('2d');
  indicadorCentrosChartInstance = new Chart(ctxCentros, {
    type: 'bar',
    data: {
      labels: centrosLabels,
      datasets: [{
        label: 'Cumplimiento (%)',
        data: centrosCumplimiento,
        backgroundColor: ctx => {
          const v = ctx.dataset.data[ctx.dataIndex];
          return v >= 100 ? '#27ae60'
               : v >= 33.33  ? '#f39c12'
                          : '#e74c3c';
        },
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Cumplimiento por Centro' },
        tooltip: {
          callbacks: {
            label: ctx => `Cumplimiento: ${ctx.formattedValue}%`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Cumplimiento (%)' }
        },
        x: {
          title: { display: true, text: 'Centro de Salud' }
        }
      }
    }
  });

  // --- GR√ÅFICO 2: L√≠nea de Tendencia (simulada) ---
  const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
  let valor = Math.random() * 50 + 25;
  const tendenciaData = meses.map(() => {
    valor = Math.max(0, Math.min(100, valor + (Math.random() * 10 - 5)));
    return parseFloat(valor.toFixed(2));
  });
  const metaArray = Array(meses.length).fill(indicador.meta);

  // Destruir instancia previa si existe
  if (indicadorTendenciaChartInstance) {
    indicadorTendenciaChartInstance.destroy();
  }

  // Crear gr√°fico de l√≠nea
  const ctxTend = document
    .getElementById('indicadorTendenciaChart')
    .getContext('2d');
  indicadorTendenciaChartInstance = new Chart(ctxTend, {
    type: 'line',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Resultado',
          data: tendenciaData,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52,152,219,0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Meta',
          data: metaArray,
          borderColor: '#e74c3c',
          borderDash: [5,5],
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Tendencia Mensual' }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: indicador.tipo === 'porcentaje' ? 'Resultado (%)' : 'Resultado'
          }
        }
      }
    }
  });
}

/**
 * Eval√∫a el cumplimiento de una o varias metas (indicadores) para todos los centros.
 *
 * @param {string[]} codigosIndicadores  Array de c√≥digos de indicador (p.ej. ['11','17','15','14','12','13','9.1'])
 * @returns {Object}  
 *   Claves = c√≥digo de indicador;  
 *   Valor = array de { centro, cumplimiento, cumplio } para cada centro (exc. 'comunal').
 */
function evaluarCumplimientoMetas(codigosIndicadores) {
  const resultadoGlobal = {};

  codigosIndicadores.forEach(codigo => {
    const indicador = iaapsData.indicadores.find(i => i.codigo === codigo);
    if (!indicador) {
      console.warn(`Indicador "${codigo}" no encontrado.`);
      return;
    }
    const meta = indicador.meta;

    // Para cada centro (excepto comunal) calculamos cumplimiento y si cumple la meta
    const detalles = iaapsData.centros
      .filter(c => c.codigo !== 'comunal')
      .map(centro => {
        const res = indicador.resultados.find(r => r.centro === centro.codigo);
        const cumplimiento = res ? res.cumplimiento : 0;
        return {
          centro: centro.nombre,
          cumplimiento,
          cumplio: cumplimiento >= meta
        };
      });

    resultadoGlobal[codigo] = detalles;
  });

  return resultadoGlobal;
}

// Ejemplo de uso:
const metas = ['11','17','15','14','12','13','9.1'];
const reporte = evaluarCumplimientoMetas(metas);
console.log(reporte);



const datos11 = reporte['11'];
const meta11 = iaapsData.indicadores.find(i => i.codigo === '11').meta;
const ctx = document.getElementById('miCanvas').getContext('2d');

new Chart(ctx, {
  type: 'bar',
  data: {
    labels: datos11.map(r => r.centro),
    datasets: [{
      label: 'Cumplimiento %',
      data: datos11.map(r => r.cumplimiento),
      backgroundColor: ctx => {
        const v = ctx.dataset.data[ctx.dataIndex];
        return v >= meta11 ? '#27ae60' : '#e74c3c';
      }
    }]
  },
  options: { /* ... */ }
});

/**
 * CORRECCIONES DEL DASHBOARD IAAPS
 * ===============================
 * Principales correcciones:
 * 1. Eliminar duplicaci√≥n de la funci√≥n actualizarTablaIndicadores()
 * 2. Consolidar y mejorar funciones de actualizaci√≥n de detalles
 * 3. Extraer l√≥gica com√∫n a funciones utilitarias
 */

// ==================== FUNCIONES UTILITARIAS ====================

/**
 * Determina el estado de un indicador seg√∫n su cumplimiento y tipo
 * @param {number} cumplimiento Porcentaje de cumplimiento (0-100)
 * @param {number} umbral Umbral para determinar cumplimiento (normalmente 33.33% o valor de meta)
 * @param {string} tipo Tipo de retorno ('class', 'icon', 'text', o 'all')
 * @returns {object|string} Clase, icono, texto o todos seg√∫n el tipo solicitado
 */
/**
 * Determina el estado de un indicador seg√∫n su cumplimiento y meta
 * Versi√≥n modificada para metas especiales en Abril
 * Para indicadores 3, 5, 6.1.A, 6.1.B, 6.2, 7, 8, 9.2, 9.3, 11, 16:
 * - CUMPLIDO (verde): cumplimiento >= 100% de la meta
 * - EN PROCESO (amarillo): cumplimiento >= 33.33% de la meta pero < 100% de la meta
 * - CR√çTICO (rojo): cumplimiento < 33.33% de la meta
 * 
 * @param {number} cumplimiento - Porcentaje de cumplimiento actual
 * @param {number} meta - Porcentaje de la meta establecida
 * @param {string} codigoIndicador - C√≥digo del indicador para aplicar reglas espec√≠ficas
 * @return {Object} Objeto con clases CSS, √≠cono y texto descriptivo del estado
 */
/**
 * Determina el estado de un indicador seg√∫n su cumplimiento
 * Versi√≥n modificada para indicadores especiales (3, 5, 6.1.A, 6.1.B, 6.2, 7, 8, 9.2, 9.3, 11, 16)
 * 
 * Para estos indicadores:
 * - CUMPLIDO (verde): cumplimiento >= 100% (cumplimiento es igual o superior a la meta)
 * - EN PROCESO (amarillo): cumplimiento >= 33.33% pero < 100% (por debajo de la meta)
 * - CR√çTICO (rojo): cumplimiento < 33.33%
 * 
 * @param {number} cumplimiento - Porcentaje de cumplimiento (valor absoluto)
 * @param {number} meta - Valor de la meta establecida
 * @param {string} codigoIndicador - C√≥digo del indicador para aplicar reglas espec√≠ficas
 * @return {Object} Objeto con clases CSS, √≠cono y texto descriptivo del estado
 */
function determinarEstadoIndicador(cumplimiento, meta, codigoIndicador = '') {
    // Lista de indicadores con reglas especiales
    const indicadoresEspecialesMetas = ['3', '5', '6.1.A', '6.1.B', '6.2', '7', '8', '9.2', '9.3', '11', '16'];
    
    // Verificar si el indicador est√° en la lista de reglas especiales
    const tieneReglasEspeciales = indicadoresEspecialesMetas.includes(codigoIndicador);
    
    // Aplicar l√≥gica seg√∫n corresponda
    if (tieneReglasEspeciales) {
        // Para los indicadores especiales:
        if (cumplimiento >= 100) {
            // Si cumplimiento es igual o superior a la meta (100%)
            return {
                statusClass: 'status-success',
                statusIcon: 'fa-check-circle',
                statusText: 'CUMPLIDO'
            };
        } else if (cumplimiento >=33.33) {
            // Si cumplimiento es igual o superior a 33.33% pero menos que 100%
            return {
                statusClass: 'status-warning',
                statusIcon: 'fa-exclamation-triangle',
                statusText: 'EN PROCESO'
            };
        } else {
            // Si cumplimiento es inferior a 33.33%
            return {
                statusClass: 'status-danger',
                statusIcon: 'fa-times-circle',
                statusText: 'CR√çTICO'
            };
        }
    } else {
        // L√≥gica est√°ndar para el resto de indicadores (mantener comportamiento original)
        if (cumplimiento >= meta) {
            return {
                statusClass: 'status-success',
                statusIcon: 'fa-check-circle',
                statusText: 'CUMPLIDO'
            };
        } else if (cumplimiento >= (meta * 0.8)) {
            return {
                statusClass: 'status-warning',
                statusIcon: 'fa-exclamation-triangle',
                statusText: 'EN PROCESO'
            };
        } else {
            return {
                statusClass: 'status-danger',
                statusIcon: 'fa-times-circle',
                statusText: 'CR√çTICO'
            };
        }
    }
}
/**
 * Formatea un valor seg√∫n su tipo
 * @param {number} valor Valor a formatear
 * @param {string} tipo Tipo de dato ('porcentaje' u otro)
 * @param {number} decimales N√∫mero de decimales (por defecto 2)
 * @returns {string} Valor formateado
 */
function formatearValor(valor, tipo, decimales = 2) {
    if (tipo === 'porcentaje') {
        return valor.toFixed(decimales) + '%';
    }
    return valor.toFixed(decimales);
}

/**
 * Genera HTML para mostrar tendencia
 * @param {string} indicadorCodigo C√≥digo del indicador
 * @returns {string} HTML con la tendencia formateada
 */
function formatearTendencia(indicadorCodigo) {
    // Indicadores que siempre deben mostrarse "0.00%" en verde
    const siempreMeta100 = ['1', '2.1', '2.2', '10'];
    if (siempreMeta100.includes(indicadorCodigo)) {
        return `
            <span class="text-success">
                <i class="fas fa-arrow-up me-1"></i>0.00%
            </span>
        `;
    }
    
    // Para los dem√°s, simular flecha y porcentaje
    const valor = (Math.random() * 5).toFixed(2);
    const positivo = Math.random() > 0.5;
    const cls = positivo ? 'text-success' : 'text-danger';
    const iconClass = positivo ? 'fa-arrow-up' : 'fa-arrow-down';
    
    return `
        <span class="${cls}">
            <i class="fas ${iconClass} me-1"></i>${valor}%
        </span>
    `;
}

// ==================== CORRECCI√ìN DE FUNCIONES DUPLICADAS ====================

/**
 * Actualiza la tabla de indicadores en la vista principal
 * Versi√≥n consolidada y mejorada que sustituye a las versiones duplicadas
 */
function actualizarTablaIndicadores() {
    const tableBody = document.getElementById('indicadoresTableBody');
    if (!tableBody) {
        console.error("Elemento 'indicadoresTableBody' no encontrado");
        return;
    }
    
    tableBody.innerHTML = '';
    
    // Indicadores que usan su propia meta para determinar "Cumplido"
    const specialMetas = ['11','17','15','14','12','13','9.1'];
    // Indicadores cuya tendencia siempre debe mostrarse como 0% en verde
    const trendAlwaysZero = ['1','2.1','2.2','10'];

    
    
    // Ordenar indicadores por c√≥digo
    const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
        const aNum = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
        const bNum = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
        return aNum - bNum;
    });
    
    indicadoresOrdenados.forEach(indicador => {
        const rc = indicador.resultados.find(r => r.centro === 'comunal');
        if (!rc) return;
        
        // Determinar umbral din√°mico (cumplimiento vs meta o 33.33%)
        const umbral = specialMetas.includes(indicador.codigo) ? indicador.meta : 33.33;
        
        // Obtener estado del indicador
        const estado = determinarEstadoIndicador(rc.cumplimiento, umbral, indicador.codigo);

        
        // Formatear resultado y meta
        const resultadoFormateado = formatearValor(rc.resultado, indicador.tipo);
        const metaFormateada = formatearValor(indicador.meta, indicador.tipo);
        
        // Obtener HTML de tendencia
        const tendenciaHtml = formatearTendencia(indicador.codigo);
        
        // Construir fila
        const row = document.createElement('tr');
        row.setAttribute('data-indicador', indicador.codigo);
        row.classList.add('indicador-row');
        row.innerHTML = `
          <td><strong>${indicador.codigo}</strong> ‚Äì ${indicador.nombre}</td>
          <td class="text-center">${metaFormateada}</td>
          <td class="text-center">${resultadoFormateado}</td>
          <td class="text-center">
            <span class="${estado.statusClass}">
              <i class="fas ${estado.statusIcon} me-1"></i>
              ${rc.cumplimiento.toFixed(2)}%
            </span>
          </td>
          </td>
        `;
        tableBody.appendChild(row);
    });
    
    // Vincular eventos de clic para detalles
    document.querySelectorAll('.indicador-row').forEach(row => {
        row.addEventListener('click', () => {
            const codigo = row.dataset.indicador;
            mostrarVista('detailView');
            document.getElementById('indicador-tab').click();
            seleccionarIndicador(codigo);
        });
    });
}

/**
 * Actualiza la tabla de indicadores del centro seleccionado
 * Versi√≥n mejorada con manejo de errores
 */
function actualizarTablaIndicadoresCentro() {
    const tableBody = document.getElementById('centroIndicadoresTableBody');
    if (!tableBody) {
        console.error("Elemento 'centroIndicadoresTableBody' no encontrado");
        return;
    }
    
    tableBody.innerHTML = '';
    
    // Umbral especial para ciertos indicadores
    const specialMetas = ['11','17','15','14','12','13','9.1'];
    
    // Ordenar indicadores por c√≥digo
    const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
        const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
        const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
        return codigoA - codigoB;
    });
    
    indicadoresOrdenados.forEach(indicador => {
        const resultado = indicador.resultados.find(r => r.centro === currentCentro);
        if (!resultado) return;
        
        // Determinar umbral
        const umbral = specialMetas.includes(indicador.codigo) ? indicador.meta : 33.33;
        
        // Obtener estado
const estado = determinarEstadoIndicador(resultado.cumplimiento, umbral, indicador.codigo);

        
        // Formatear valores
        const resultadoFormateado = formatearValor(resultado.resultado, indicador.tipo);
        const metaFormateada = formatearValor(indicador.meta, indicador.tipo);
        
        // Construir fila
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <strong>${indicador.codigo}</strong> - ${indicador.nombre}
            </td>
            <td class="text-center">${resultado.numerador}</td>
            <td class="text-center">${resultado.denominador}</td>
            <td class="text-center">${resultadoFormateado}</td>
            <td class="text-center">${metaFormateada}</td>
            <td class="text-center">
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                        <div class="progress-bar ${estado.statusClass.replace('status-', 'bg-')}" 
                             role="progressbar" 
                             style="width: ${Math.min(resultado.cumplimiento, 100)}%" 
                             aria-valuenow="${resultado.cumplimiento}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <span>${resultado.cumplimiento.toFixed(2)}%</span>
                </div>
            </td>
            <td class="text-center">
                <span class="badge ${estado.statusClass.replace('status-', 'bg-')}">
                    <i class="fas ${estado.statusIcon} me-1"></i> ${estado.statusText}
                </span>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

/**
 * Actualiza todos los componentes del detalle de un indicador
 * Versi√≥n consolidada que unifica las funcionalidades duplicadas
 */
function actualizarDetalleIndicador() {
    console.log("Actualizando detalle del indicador:", currentIndicador);
    
    const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
    if (!indicador) {
        console.error("Indicador no encontrado:", currentIndicador);
        return;
    }
    
    try {
        // 1) Actualizar texto descriptivo
        document.getElementById('indicadorDetailTitle').textContent =
          `Indicador ${indicador.codigo}: ${indicador.nombre}`;
        document.getElementById('indicadorNombreCompleto').textContent = indicador.nombre;
        document.getElementById('indicadorMetaValor').textContent =
          formatearValor(indicador.meta, indicador.tipo);
        document.getElementById('indicadorImportanciaValor').textContent =
          importanciaIndicadores[indicador.codigo];
        document.getElementById('indicadorNumeradorFormula').textContent =
          formulasIndicadores[indicador.codigo].numerador;
        document.getElementById('indicadorDenominadorFormula').textContent =
          formulasIndicadores[indicador.codigo].denominador;
        
        // 2) Actualizar gr√°ficos
        actualizarGraficosDetalleIndicador(indicador);
        
        // 3) Actualizar tabla
        actualizarTablaDetalleIndicador(indicador);
    } catch (error) {
        console.error("Error al actualizar detalle del indicador:", error);
    }
}

/**
 * Actualiza los gr√°ficos de detalle para el indicador seleccionado.
 * Versi√≥n mejorada con mejor manejo de errores y visualizaci√≥n.
 * @param {Object} indicador El objeto indicador de iaapsData.indicadores
 */
function actualizarGraficosDetalleIndicador(indicador) {
    if (!indicador) {
        console.error("Se requiere un indicador v√°lido");
        return;
    }
    
    try {
        // --- GR√ÅFICO 1: Barras de Cumplimiento por Centro ---
        actualizarGraficoCentrosPorIndicador(indicador);
        
        // --- GR√ÅFICO 2: L√≠nea de Tendencia (simulada) ---
        actualizarGraficoTendenciaPorIndicador(indicador);
    } catch (error) {
        console.error("Error al actualizar gr√°ficos:", error);
    }
}

/**
 * Actualiza el gr√°fico de barras mostrando el cumplimiento por centro
 * @param {Object} indicador El objeto indicador
 */
function actualizarGraficoCentrosPorIndicador(indicador) {
    const centrosLabels = [];
    const centrosCumplimiento = [];
    
    iaapsData.centros
        .filter(c => c.codigo !== 'comunal')
        .forEach(centro => {
            const res = indicador.resultados.find(r => r.centro === centro.codigo);
            if (res && res.denominador > 0) {
                centrosLabels.push(centro.nombre);
                centrosCumplimiento.push(res.cumplimiento || 0);
            }
        });
    
    // Destruir la instancia previa si existe
    if (indicadorCentrosChartInstance) {
        indicadorCentrosChartInstance.destroy();
    }
    
    // Obtener el elemento canvas
    const ctxCentros = document.getElementById('indicadorCentrosChart');
    if (!ctxCentros) {
        console.error("Elemento 'indicadorCentrosChart' no encontrado");
        return;
    }
    
    // Crear nuevo gr√°fico de barras
    indicadorCentrosChartInstance = new Chart(ctxCentros.getContext('2d'), {
        type: 'bar',
        data: {
            labels: centrosLabels,
            datasets: [{
                label: 'Cumplimiento (%)',
                data: centrosCumplimiento,
                backgroundColor: function(context) {
                    const value = context.dataset.data[context.dataIndex];
                    if (value >= 100) return '#27ae60';
                    else if (value >= 33.33) return '#f39c12';
                    else return '#e74c3c';
                },
                borderColor: 'rgba(0,0,0,0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Cumplimiento por Centro' },
                tooltip: {
                    callbacks: {
                        label: ctx => `Cumplimiento: ${ctx.formattedValue}%`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Cumplimiento (%)' }
                },
                x: {
                    title: { display: true, text: 'Centro de Salud' }
                }
            }
        }
    });
}

/**
 * Actualiza el gr√°fico de l√≠nea mostrando la tendencia del indicador
 * @param {Object} indicador El objeto indicador
 */
function actualizarGraficoTendenciaPorIndicador(indicador) {
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
    let valor = Math.random() * 50 + 25;
    const tendenciaData = meses.map(() => {
        valor = Math.max(0, Math.min(100, valor + (Math.random() * 10 - 5)));
        return parseFloat(valor.toFixed(2));
    });
    const metaArray = Array(meses.length).fill(indicador.meta);
    
    // Destruir instancia previa si existe
    if (indicadorTendenciaChartInstance) {
        indicadorTendenciaChartInstance.destroy();
    }
    
    // Obtener el elemento canvas
    const ctxTend = document.getElementById('indicadorTendenciaChart');
    if (!ctxTend) {
        console.error("Elemento 'indicadorTendenciaChart' no encontrado");
        return;
    }
    
    // Crear gr√°fico de l√≠nea
    indicadorTendenciaChartInstance = new Chart(ctxTend.getContext('2d'), {
        type: 'line',
        data: {
            labels: meses,
            datasets: [
                {
                    label: 'Resultado',
                    data: tendenciaData,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52,152,219,0.2)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Meta',
                    data: metaArray,
                    borderColor: '#e74c3c',
                    borderDash: [5,5],
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: 'Tendencia Mensual' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: indicador.tipo === 'porcentaje' ? 'Resultado (%)' : 'Resultado'
                    }
                }
            }
        }
    });
}

/**
 * Actualiza la tabla de detalle del indicador con datos por centro
 * @param {Object} indicador El objeto indicador
 */
function actualizarTablaDetalleIndicador(indicador) {
    const tbody = document.getElementById('indicadorCentrosTableBody');
    if (!tbody) {
        console.error("Elemento 'indicadorCentrosTableBody' no encontrado");
        return;
    }
    
    tbody.innerHTML = '';
    
    // Umbral especial para ciertos indicadores
    const specialMetas = ['11','17','15','14','12','13','9.1'];
    const umbral = specialMetas.includes(indicador.codigo) ? indicador.meta : 100;
    
    // Primero a√±adir fila comunal
    const resultadoComunal = indicador.resultados.find(r => r.centro === 'comunal');
    if (resultadoComunal) {
        agregarFilaIndicador(tbody, indicador, resultadoComunal, 'CURIC√ì (COMUNAL)', umbral);
    }
    
    // A√±adir filas para cada centro
    iaapsData.centros
        .filter(c => c.codigo !== 'comunal')
        .forEach(centro => {
            const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
            if (resultado) {
                agregarFilaIndicador(tbody, indicador, resultado, centro.nombre, umbral);
            }
        });
}

/**
 * A√±ade una fila a la tabla de detalle de indicador
 * @param {HTMLElement} tbody Elemento tbody donde a√±adir la fila
 * @param {Object} indicador Objeto indicador
 * @param {Object} resultado Objeto resultado con datos de cumplimiento
 * @param {string} nombreCentro Nombre del centro de salud
 * @param {number} umbral Umbral para determinar cumplimiento
 */
function agregarFilaIndicador(tbody, indicador, resultado, nombreCentro, umbral) {
    // Obtener estado
const estado = determinarEstadoIndicador(resultado.cumplimiento, umbral, indicador.codigo);

    
    // Formatear valores
    const resultadoFormateado = formatearValor(resultado.resultado, indicador.tipo);
    const metaFormateada = formatearValor(indicador.meta, indicador.tipo);
    
    // Construir fila
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${nombreCentro}</td>
        <td class="text-center">${resultado.numerador}</td>
        <td class="text-center">${resultado.denominador}</td>
        <td class="text-center">${resultadoFormateado}</td>
        <td class="text-center">${metaFormateada}</td>
        <td class="text-center">
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                    <div class="progress-bar ${estado.statusClass.replace('status-', 'bg-')}" 
                         role="progressbar" 
                         style="width: ${Math.min(resultado.cumplimiento, 100)}%" 
                         aria-valuenow="${resultado.cumplimiento}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
                <span>${resultado.cumplimiento.toFixed(2)}%</span>
            </div>
        </td>
        <td class="text-center">
            <span class="badge ${estado.statusClass.replace('status-', 'bg-')}">
                <i class="fas ${estado.statusIcon} me-1"></i> ${estado.statusText}
            </span>
        </td>
    `;
    
    tbody.appendChild(row);
}

// ==================== MEJORAS ADICIONALES ====================

/**
 * Asegura que el modo oscuro se aplique correctamente a todos los gr√°ficos
 */
function aplicarTemaAGraficos() {
    // Configuraci√≥n global para todos los gr√°ficos
    Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.font.size = 12;
    
    // Aplicar colores seg√∫n modo oscuro
    if (document.body.classList.contains('dark-mode')) {
        Chart.defaults.color = '#e0e0e0';
        Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 255)';
    } else {
        Chart.defaults.color = '#666';
        Chart.defaults.scale.grid.color = 'rgba(0, 0, 0, 0.1)';
    }
    
    // Actualizar gr√°ficos existentes
    if (centroChartInstance) centroChartInstance.update();
    if (topIndicadoresChartInstance) topIndicadoresChartInstance.update();
    if (bottomIndicadoresChartInstance) bottomIndicadoresChartInstance.update();
    if (centroCumplimientoChartInstance) centroCumplimientoChartInstance.update();
    if (centroIndicadoresChartInstance) centroIndicadoresChartInstance.update();
    if (indicadorCentrosChartInstance) indicadorCentrosChartInstance.update();
    if (comparativoChartInstance) comparativoChartInstance.update();
}

/**
 * Versi√≥n mejorada de la funci√≥n toggleDarkMode
 */
function toggleDarkMode() {
    darkMode = !darkMode;
    
    if (darkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
    
    // Aplicar tema a gr√°ficos
    aplicarTemaAGraficos();
    
    // Actualizar dashboard y detalles
    actualizarDashboard();
    actualizarDetalle();
}

/**
 * Mejora en la funci√≥n para actualizar el detalle del centro seleccionado
 */
function actualizarDetalleCentro() {
    if (!iaapsData) {
        console.error("Datos IAAPS no disponibles");
        return;
    }
    
    console.log("Actualizando detalle del centro:", currentCentro);
    
    try {
        // Actualizar t√≠tulo y visibilidad de tarjeta de establecimientos
        if (currentCentro === 'comunal') {
            document.getElementById('establecimientosCard').style.display = 'none';
            document.getElementById('centroCumplimientoTitle').textContent = 'Cumplimiento IAAPS Comunal';
        } else {
            const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
            if (centro) {
                document.getElementById('centroCumplimientoTitle').textContent = 
                    `Cumplimiento IAAPS - ${centro.nombre}`;
                
                // Verificar si tiene establecimientos
                const tieneEstablecimientos = establecimientosMap[currentCentro] && 
                                          establecimientosMap[currentCentro].length > 0;
                document.getElementById('establecimientosCard').style.display = 
                    tieneEstablecimientos ? 'block' : 'none';
                
                if (tieneEstablecimientos) {
                    actualizarTablaEstablecimientos();
                }
            }
        }
        
        // Actualizar gr√°ficos y tabla de indicadores del centro
        setTimeout(() => {
            actualizarGraficosDetalleCentro();
            actualizarTablaIndicadoresCentro();
        }, 50);
    } catch (error) {
        console.error("Error al actualizar detalle del centro:", error);
    }
}

function highlightByMeta() {
  const metas = ['17','13','14','15'];
  document
    .querySelectorAll('#centroCumplimientoTableBody tr')
    .forEach(tr => {
      // tomamos el texto de la celda "Meta" (√≠ndice 1)
      const metaText = tr.cells[1].textContent.trim().replace('%','');
      if (metas.includes(metaText)) {
        // agregamos la clase a la celda de cumplimiento (√≠ndice 5)
        tr.cells[5].classList.add('highlight-cumpl');
      }
    });
}

// ‚Äî‚Äî‚Äî Funci√≥n para agregar nota referencial en metas espec√≠ficas ‚Äî‚Äî‚Äî
function agregarNotaReferencial() {
  const metas = ['13', '14', '15', '17'];
  // Recorre cada fila de la tabla de detalle de indicadores del centro
  document.querySelectorAll('#centroIndicadoresTableBody tr').forEach(fila => {
    const tdIndicador = fila.querySelector('td:first-child');
    if (!tdIndicador) return;
    // Extrae el c√≥digo (antes del gui√≥n o espacio)
    const codigo = tdIndicador.textContent.trim().split(/[\s.-]/)[0];
    if (metas.includes(codigo)) {
      // Si a√∫n no existe la nota, la agrega
      if (!tdIndicador.querySelector('.nota-referencial')) {
        const span = document.createElement('span');
        span.className = 'nota-referencial';
        span.textContent = ' (solo referencial P dic 2024)';
        span.style.color = 'black';
        span.style.fontWeight = 'bold';
        tdIndicador.appendChild(span);
      }
    }
  });
}

// Llamar a la funci√≥n justo despu√©s de que se haya cargado/actualizado el detalle:
document.addEventListener('DOMContentLoaded', () => {
  // Si tu tabla ya se llena tras cargar datos, tambi√©n puedes hacerlo as√≠:
  setTimeout(agregarNotaReferencial, 1000);
});

// Lista de indicadores a evaluar con estado "En Proceso"
const indicadoresProceso = ['3','5','6.1.A','6.1.B','6.2','7','8','9.2','9.3','11','16'];

/**
 * Determina el estado seg√∫n reglas:
 * - Si es uno de indicadoresProceso y 33.33% ‚â§ cumplimiento < meta: En Proceso (amarillo)
 * - Si cumplimiento ‚â• meta: Cumplido (verde)
 * - Si cumplimiento < meta: Cr√≠tico (rojo)
 */
function determinarEstadoMeta(codigo, cumplimiento, meta) {
  if (indicadoresProceso.includes(codigo) && cumplimiento >= 33.33 && cumplimiento < meta) {
    return { class: 'bg-warning', icon: 'fa-hourglass-half', text: 'En Proceso' };
  } else if (cumplimiento >= meta) {
    return { class: 'bg-success', icon: 'fa-check-circle', text: 'Cumplido' };
  } else {
    return { class: 'bg-danger', icon: 'fa-times-circle', text: 'Cr√≠tico' };
  }
}




/**
 * Calcula el cumplimiento global de todos los indicadores IAAPS
 * considerando su ponderaci√≥n (importancia relativa)
 * @param {string} centroCodigo - C√≥digo del centro para el cual calcular (default: 'comunal')
 * @returns {number} - Porcentaje de cumplimiento global
 */
function calcularCumplimientoGlobal(centroCodigo = 'comunal') {
    // Verificar que existan datos
    if (!iaapsData || !iaapsData.indicadores) {
        console.error("Datos IAAPS no disponibles");
        return 0;
    }
    
    let sumaPonderada = 0;
    let sumaPonderacion = 0;
    
    // Recorrer cada indicador
    iaapsData.indicadores.forEach(indicador => {
        // Buscar resultado para el centro especificado
        const resultado = indicador.resultados.find(r => r.centro === centroCodigo);
        if (!resultado || resultado.denominador <= 0) return;
        
        // Obtener la ponderaci√≥n del indicador (importancia relativa)
        let ponderacion = 0;
        
        // El indicador 10 (GES) es cr√≠tico y no se incluye en la suma ponderada
        if (indicador.codigo === '10') return;
        
        // Convertir la importancia de string a n√∫mero (quitar el s√≠mbolo %)
        const importanciaStr = importanciaIndicadores[indicador.codigo];
        if (importanciaStr) {
            ponderacion = parseFloat(importanciaStr.replace('%', ''));
        }
        
        // Si no se pudo obtener la ponderaci√≥n, continuar con el siguiente
        if (isNaN(ponderacion) || ponderacion <= 0) return;
        
        // Limitar el cumplimiento a un m√°ximo de 100%
        const cumplimientoAjustado = Math.min(resultado.cumplimiento, 100);
        
        // Acumular suma ponderada y suma de ponderaciones
        sumaPonderada += (cumplimientoAjustado * ponderacion);
        sumaPonderacion += ponderacion;
    });
    
    // Calcular porcentaje global (evitar divisi√≥n por cero)
    const porcentajeGlobal = sumaPonderacion > 0 ? 
        (sumaPonderada / sumaPonderacion) : 0;
    
    // Redondear a 2 decimales y retornar
    return parseFloat(porcentajeGlobal.toFixed(2));
}

/**
 * Calcula el cumplimiento global ponderado de todos los indicadores IAAPS
 * para un centro espec√≠fico o a nivel comunal.
 * 
 * @param {string} codigoCentro - C√≥digo del centro ('comunal' u otro c√≥digo de centro)
 * @param {Array} indicadores - Array de indicadores con sus resultados
 * @returns {number} - Porcentaje de cumplimiento global ponderado (0-100)
 */
function calcularCumplimientoGlobal(codigoCentro, indicadores) {
    // 1) Validaci√≥n de par√°metros
    if (!codigoCentro || !indicadores || !Array.isArray(indicadores)) {
        console.error("Par√°metros incorrectos para calcular cumplimiento global");
        return 0;
    }

    // 2) Variables para acumular valores
    let sumaPonderada = 0;          // Suma de (cumplimiento √ó ponderaci√≥n)
    let sumaPonderaciones = 0;      // Suma total de ponderaciones
    let indicadoresContados = 0;    // Contador de indicadores v√°lidos

    // 3) Recorrer cada indicador
    indicadores.forEach(indicador => {
        // Buscar resultado del centro espec√≠fico
        const resultado = indicador.resultados.find(r => r.centro === codigoCentro);
        
        // Continuar solo si hay resultados y tiene denominador
        if (resultado && resultado.denominador > 0) {
            // Obtener la importancia del indicador (como n√∫mero, quitando el %)
            let importancia = 0;
            
            // El indicador 10 es cr√≠tico y se eval√∫a por separado
            if (indicador.codigo === '10') {
                return; // Saltamos este indicador
            }
            
            // Extraer el valor num√©rico de la importancia (quitar el % y convertir a n√∫mero)
            const importanciaStr = importanciaIndicadores[indicador.codigo] || '0%';
            importancia = parseFloat(importanciaStr.replace('%', '')) || 0;
            
            // Verificar que la importancia sea v√°lida
            if (importancia > 0) {
                // Calcular la contribuci√≥n ponderada de este indicador
                // (limitando el cumplimiento a m√°ximo 100%)
                const cumplimientoEfectivo = Math.min(resultado.cumplimiento, 100);
                sumaPonderada += cumplimientoEfectivo * importancia;
                sumaPonderaciones += importancia;
                indicadoresContados++;
            }
        }
    });

    // 4) Calcular el cumplimiento global ponderado
    if (sumaPonderaciones === 0 || indicadoresContados === 0) {
        console.warn("No se encontraron indicadores v√°lidos para calcular el cumplimiento global");
        return 0;
    }

    // 5) Retornar el cumplimiento ponderado, redondeado a dos decimales
    return parseFloat((sumaPonderada / sumaPonderaciones).toFixed(2));
}

function diagnosticarDashboard() {
    console.log("=== DIAGN√ìSTICO DEL DASHBOARD ===");
    
    // Verificar datos IAAPS
    console.log("iaapsData existe:", iaapsData ? "S√ç" : "NO");
    if (!iaapsData) return "ERROR: iaapsData es null o undefined";
    
    console.log("iaapsData.indicadores existe:", iaapsData.indicadores ? "S√ç" : "NO");
    if (!iaapsData.indicadores) return "ERROR: iaapsData.indicadores es null o undefined";
    
    console.log("iaapsData.centros existe:", iaapsData.centros ? "S√ç" : "NO");
    if (!iaapsData.centros) return "ERROR: iaapsData.centros es null o undefined";
    
    // Verificar elementos DOM cr√≠ticos
    const elementosDOM = [
        'indicadorCumplidosValue', 
        'indicadorParcialValue',
        'indicadorCriticosValue',
        'cumplimientoComunalValue',
        'indicadorCumplidosProgress',
        'indicadorParcialProgress',
        'indicadorCriticosProgress',
        'cumplimientoComunalProgress'
    ];
    
    let elementosFaltantes = [];
    elementosDOM.forEach(id => {
        if (!document.getElementById(id)) {
            elementosFaltantes.push(id);
        }
    });
    
    if (elementosFaltantes.length > 0) {
        return "ERROR: Faltan elementos DOM: " + elementosFaltantes.join(", ");
    }
    
    return "OK: Diagn√≥stico completado sin problemas evidentes";
}

/**
 * FUNCIONES B√ÅSICAS DE EXPORTACI√ìN PARA DASHBOARD IAAPS
 * Soluci√≥n simplificada para corregir errores en exportaci√≥n PDF y Excel
 */

// ==================== FUNCI√ìN PARA EXPORTAR A EXCEL ====================

/**
 * Exporta datos a Excel seg√∫n el tipo seleccionado
 * @param {string} tipo - 'centro', 'indicador' o 'comparativo'
 */


// ==================== FUNCI√ìN PARA EXPORTAR A PDF ====================

/**
 * Exporta datos a PDF seg√∫n el tipo seleccionado
 * Soluci√≥n para el error "doc.autoTable is not a function"
 * @param {string} tipo - 'centro', 'indicador' o 'comparativo'
 */
function exportarPDF(tipo) {
  // Mostrar indicador de carga
  mostrarCargando(true);
  
  setTimeout(() => {
    try {
      // Verificar si jsPDF est√° disponible correctamente
      if (typeof window.jspdf === 'undefined') {
        console.error("Error: La librer√≠a jsPDF no est√° disponible");
        mostrarNotificacion('Error: Librer√≠a PDF no disponible', 'error');
        mostrarCargando(false);
        return;
      }
      
      // Crear instancia jsPDF (sintaxis corregida)
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Verificar si el plugin autoTable est√° disponible
      if (typeof window.jspdf.jsPDF.prototype.autoTable !== 'function') {
        console.error("Error: Plugin autoTable no disponible");
        // Usar m√©todo b√°sico sin autoTable
        exportarPDFBasico(doc, tipo);
        return;
      }
      
      let nombreArchivo = '';
      let titulo = '';
      let datos = [];
      let columnas = [];
      
      if (tipo === 'centro') {
        // Exportar datos del centro seleccionado
        const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
        if (!centro) {
          mostrarCargando(false);
          mostrarNotificacion('Error: Centro no encontrado', 'error');
          return;
        }
        
        nombreArchivo = `IAAPS_${centro.nombre.replace(/\s/g, '_')}_Abril_2025.pdf`;
        titulo = `Reporte IAAPS - ${centro.nombre} - Abril 2025`;
        
        // Definir columnas para autoTable
        columnas = [
          { header: 'Indicador', dataKey: 'indicador' },
          { header: 'Numerador', dataKey: 'numerador' },
          { header: 'Denominador', dataKey: 'denominador' },
          { header: 'Resultado', dataKey: 'resultado' },
          { header: 'Meta', dataKey: 'meta' },
          { header: 'Cumplimiento', dataKey: 'cumplimiento' }
        ];
        
        // Datos
        iaapsData.indicadores.forEach(indicador => {
          const resultado = indicador.resultados.find(r => r.centro === currentCentro);
          if (!resultado) return;
          
          datos.push({
            indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 40)}...`,
            numerador: resultado.numerador,
            denominador: resultado.denominador,
            resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
            meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
            cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
          });
        });
      } else if (tipo === 'indicador') {
        // Exportar datos del indicador seleccionado
        const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
        if (!indicador) {
          mostrarCargando(false);
          mostrarNotificacion('Error: Indicador no encontrado', 'error');
          return;
        }
        
        nombreArchivo = `IAAPS_Indicador_${indicador.codigo.replace('.', '_')}_Abril_2025.pdf`;
        titulo = `Reporte IAAPS - Indicador ${indicador.codigo} - Abril 2025`;
        
        // Definir columnas para autoTable
        columnas = [
          { header: 'Centro', dataKey: 'centro' },
          { header: 'Numerador', dataKey: 'numerador' },
          { header: 'Denominador', dataKey: 'denominador' },
          { header: 'Resultado', dataKey: 'resultado' },
          { header: 'Meta', dataKey: 'meta' },
          { header: 'Cumplimiento', dataKey: 'cumplimiento' }
        ];
        
        // Datos
        iaapsData.centros.forEach(centro => {
          const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
          if (!resultado) return;
          
          datos.push({
            centro: centro.nombre,
            numerador: resultado.numerador,
            denominador: resultado.denominador,
            resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
            meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
            cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
          });
        });
      } else if (tipo === 'comparativo') {
        // Exportar tabla comparativa
        nombreArchivo = `IAAPS_Comparativo_Abril_2025.pdf`;
        titulo = `Reporte IAAPS - Comparativo - Abril 2025`;
        
        // Definir columnas para autoTable
        columnas = [
          { header: 'Indicador', dataKey: 'indicador' },
          { header: 'Meta', dataKey: 'meta' }
        ];
        
        // Agregar columnas para cada centro (limitado a algunos para que quepa en PDF)
        const centrosLimitados = iaapsData.centros.slice(0, 4); // Solo 4 centros para que quepa en el PDF
        centrosLimitados.forEach(centro => {
          columnas.push({ header: centro.nombre.substring(0, 8), dataKey: centro.codigo });
        });
        
        // Datos
        iaapsData.indicadores.forEach(indicador => {
          const fila = {
            indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 20)}...`,
            meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
          };
          
          // Agregar datos para cada centro
          centrosLimitados.forEach(centro => {
            const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
            if (resultado) {
              fila[centro.codigo] = resultado.cumplimiento.toFixed(2) + '%';
            } else {
              fila[centro.codigo] = '-';
            }
          });
          
          datos.push(fila);
        });
      }
      
      // A√±adir t√≠tulo
      doc.setFontSize(18);
      doc.text(titulo, 14, 22);
      
      // A√±adir fecha
      doc.setFontSize(11);
      doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleDateString()}`, 14, 30);
      
      // Comprobar nuevamente el m√©todo autoTable antes de usarlo
      if (typeof doc.autoTable === 'function') {
        // Utilizar autoTable si est√° disponible
        doc.autoTable({
          columns: columnas,
          body: datos,
          startY: 35,
          styles: { fontSize: 9 },
          columnStyles: {
            indicador: { cellWidth: 60 }
          }
        });
      } else {
        // M√©todo alternativo si autoTable no est√° disponible
        exportarPDFBasico(doc, tipo);
        return;
      }
      
      // A√±adir pie de p√°gina
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`P√°gina ${i} de ${pageCount} - INFOGES Curic√≥ - Dashboard de Control`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, {
          align: 'center'
        });
      }
      
      // Guardar PDF
      doc.save(nombreArchivo);
      
      mostrarCargando(false);
      mostrarNotificacion('PDF exportado correctamente', 'success');
    } catch (error) {
      console.error('Error al exportar a PDF:', error);
      mostrarCargando(false);
      mostrarNotificacion('Error al exportar PDF: ' + error.message, 'error');
    }
  }, 500);
}

/**
 * M√©todo alternativo b√°sico para exportar a PDF si autoTable no est√° disponible
 * @param {jsPDF} doc - Instancia de jsPDF
 * @param {string} tipo - Tipo de exportaci√≥n
 */
/**
 * Funci√≥n para exportar informes IAAPS a PDF con dise√±o profesional
 * @param {string} tipo - Tipo de informe: 'centro', 'indicador' o 'comparativo'
 */
/**
 * Funci√≥n para exportar informes a PDF con dise√±o formal, elegante y premium
 * Usa solo datos reales y gr√°ficos existentes en el sistema
 * @param {string} tipo - Tipo de informe: 'centro', 'indicador' o 'comparativo'
 */
function exportarPDF(tipo) {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            // Inicializaci√≥n del documento PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Variables para el informe
            let nombreArchivo = '';
            let titulo = '';
            let subtitulo = 'Reporte del Sistema IAAPS - Abril 2025';
            let datos = [];
            
            // Dimensiones de la p√°gina
            const anchoPagina = doc.internal.pageSize.getWidth();
            const altoPagina = doc.internal.pageSize.getHeight();
            const margen = 15;
            
            // Definir paleta de colores formal pero premium
            const colores = {
                principal: [0, 123, 70],      // Azul oscuro formal
                secundario: [0, 123, 30],     // Verde institucional
                acento: [180, 151, 90],       // Dorado premium
                neutro: [79, 79, 79],         // Gris oscuro para textos
                grisClaro: [245, 245, 245],   // Gris claro para alternar filas
                grisMedio: [220, 220, 220],   // Gris medio para bordes
                blanco: [255, 255, 255]       // Blanco puro
            };
            
            // ======== PREPARACI√ìN DE DATOS SEG√öN EL TIPO DE INFORME ========
            if (tipo === 'centro') {
                // Datos para informe de centro
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (!centro) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error: Centro no encontrado', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_${centro.nombre.replace(/\s/g, '_')}_Abril_2025.pdf`;
                titulo = `Centro de Salud: ${centro.nombre}`;
                
                // Datos de la tabla con textos recortados
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                    if (!resultado) return;
                    
                    datos.push({
                        indicador: `${indicador.codigo} - ${recortarTexto(indicador.nombre, 35)}`,
                        numerador: formatearNumero(resultado.numerador),
                        denominador: formatearNumero(resultado.denominador),
                        resultado: formatearValor(resultado.resultado, indicador.tipo),
                        meta: formatearValor(indicador.meta, indicador.tipo),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
                
            } else if (tipo === 'indicador') {
                // Datos para informe de indicador
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                if (!indicador) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error: Indicador no encontrado', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_Indicador_${indicador.codigo.replace('.', '_')}_Abril_2025.pdf`;
                titulo = `Indicador: ${indicador.codigo}`;
                subtitulo = `${indicador.nombre} - Abril 2025`;
                
                // Datos de la tabla
                iaapsData.centros.forEach(centro => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (!resultado) return;
                    
                    datos.push({
                        centro: recortarTexto(centro.nombre, 25),
                        numerador: formatearNumero(resultado.numerador),
                        denominador: formatearNumero(resultado.denominador),
                        resultado: formatearValor(resultado.resultado, indicador.tipo),
                        meta: formatearValor(indicador.meta, indicador.tipo),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
                
            } else if (tipo === 'comparativo') {
                // Datos para informe comparativo
                nombreArchivo = `IAAPS_Comparativo_Abril_2025.pdf`;
                titulo = `Informe Comparativo IAAPS`;
                subtitulo = `Todos los Centros - Abril 2025`;
                
                // Datos para tabla comparativa
                const datosTabulares = [];
                
                // Preparar encabezados de centros (recortados)
                const centrosHeader = ['Indicador', 'Meta', 'Comunal'];
                iaapsData.centros.filter(c => c.codigo !== 'comunal').forEach(centro => {
                    centrosHeader.push(recortarTexto(centro.nombre, 12));
                });
                
                datosTabulares.push(centrosHeader);
                
                // A√±adir datos para cada indicador
                iaapsData.indicadores.forEach(indicador => {
                    const fila = [
                        `${indicador.codigo} - ${recortarTexto(indicador.nombre, 25)}`,
                        formatearValor(indicador.meta, indicador.tipo)
                    ];
                    
                    // A√±adir datos para cada centro
                    iaapsData.centros.forEach(centro => {
                        const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                        if (resultado) {
                            fila.push(resultado.cumplimiento.toFixed(2) + '%');
                        } else {
                            fila.push('-');
                        }
                    });
                    
                    datosTabulares.push(fila);
                });
                
                datos = datosTabulares;
            }
            
            // ============ FUNCI√ìN PARA CREAR ENCABEZADO FORMAL Y ELEGANTE ============
            function agregarEncabezado(pagina) {
    // --- 1) Fondo blanco en todo el encabezado ---
    doc.setFillColor(colores.blanco[0], colores.blanco[1], colores.blanco[2]);
    doc.rect(0, 0, anchoPagina, 25, 'F');

    // --- 2) Logo ---
    const logoX = margen;
    const logoY = 4;
    const logoW = 18;
    const logoH = 18;
    try {
        const rutaLogo = './images/logo2.png';
        doc.addImage(rutaLogo, 'PNG', logoX, logoY, logoW, logoH);
    } catch (e) {
        console.warn('No se pudo cargar el logo:', e);
        // Marco un recuadro gris si falla
        doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
        doc.setLineWidth(0.2);
        doc.rect(logoX, logoY, logoW, logoH, 'S');
    }

    // --- 3) Texto en verde (colores.secundario) ---
    doc.setTextColor(colores.secundario[0], colores.secundario[1], colores.secundario[2]);

    // T√≠tulo principal
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('DEPARTAMENTO DE SALUD CURIC√ì', margen + 25, 12);

    // Subt√≠tulo
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(
        'INFOGES CURIC√ì',
        margen + 25,
        18
    );

    // N√∫mero de p√°gina
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(
        `P√°gina ${pagina}`,
        anchoPagina - margen - 15,
        15,
        { align: 'center' }
    );

    // --- 4) L√≠nea separadora inferior ---
    doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
    doc.setLineWidth(0.5);
    doc.line(0, 25, anchoPagina, 25);

    // Retorna la Y donde termina el encabezado
    return 32;
}

            
            // ============ FUNCI√ìN PARA CREAR PIE DE P√ÅGINA ELEGANTE ============
            function agregarPiePagina() {
                const alturaPie = 12;
                const posY = altoPagina - alturaPie;
                
                // Fondo blanco para el pie de p√°gina
                doc.setFillColor(colores.blanco[0], colores.blanco[1], colores.blanco[2]);
                doc.rect(0, posY, anchoPagina, alturaPie, 'F');
                
                // L√≠nea superior que separa el contenido del pie de p√°gina
                doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
                doc.setLineWidth(0.5);
                doc.line(0, posY, anchoPagina, posY);
                
                // L√≠nea inferior de color principal
                doc.setFillColor(colores.principal[0], colores.principal[1], colores.principal[2]);
                doc.rect(0, altoPagina - 3, anchoPagina, 3, 'F');
                
                // L√≠nea secundaria de color acento (dorado)
                doc.setFillColor(colores.acento[0], colores.acento[1], colores.acento[2]);
                doc.rect(0, altoPagina - 3.5, anchoPagina, 0.5, 'F');
                
                // Texto del pie con estilo elegante
                doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                
                // Informaci√≥n a mostrar en el pie de p√°gina
                const fechaGen = new Date().toLocaleDateString('es-CL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                doc.text(`INFOGES Curic√≥ - Dashboard de Control IAAPS - Generado: ${fechaGen}`, margen, posY + 5);
                doc.text('Servicio de Salud Curic√≥ - Carmen N¬∞925, Curic√≥', anchoPagina - margen, posY + 5, {align: 'right'});
                
                return posY;
            }
            
            // ============ FUNCI√ìN PARA CREAR TABLA PROFESIONAL ============
            function crearTablaManual(datos, startY) {
                // Configuraci√≥n de la tabla
                const margenTabla = margen;
                const anchoDisponible = anchoPagina - (2 * margenTabla);
                let posY = startY;
                const altoFila = 9; // Altura para cada fila
                const altoEncabezado = 14;  // altura mayor para que quepa el texto wrappeado

                
                // Definir anchos de columna seg√∫n el tipo de informe
                let anchoColumnas = [];
                let encabezados = [];
                
                if (tipo === 'centro') {
                    // Para informe de centro
                    anchoColumnas = [
                        anchoDisponible * 0.40, // Indicador
                        anchoDisponible * 0.12, // Numerador
                        anchoDisponible * 0.12, // Denominador
                        anchoDisponible * 0.12, // Resultado
                        anchoDisponible * 0.12, // Meta
                        anchoDisponible * 0.12  // Cumplimiento
                    ];
                    
                    encabezados = ['Indicador', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento'];
                } else if (tipo === 'indicador') {
                    // Para informe de indicador
                    anchoColumnas = [
                        anchoDisponible * 0.30, // Centro
                        anchoDisponible * 0.14, // Numerador
                        anchoDisponible * 0.14, // Denominador
                        anchoDisponible * 0.14, // Resultado
                        anchoDisponible * 0.14, // Meta
                        anchoDisponible * 0.14  // Cumplimiento
                    ];
                    
                    encabezados = ['Centro', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento'];
                } else if (tipo === 'comparativo') {
                    // Para informe comparativo
                    encabezados = datos[0];
                    const numColumnas = encabezados.length;
                    
                    // Ajustar anchos espec√≠ficamente para este caso
                    anchoColumnas = [];
                    anchoColumnas.push(anchoDisponible * 0.30); // Indicador
                    anchoColumnas.push(anchoDisponible * 0.10); // Meta
                    
                    // Distribuir el resto del espacio equitativamente entre los centros
                    const espacioRestante = anchoDisponible - (anchoDisponible * 0.40);
                    const anchoPorCentro = espacioRestante / (numColumnas - 2);
                    
                    for (let i = 2; i < numColumnas; i++) {
                        anchoColumnas.push(anchoPorCentro);
                    }
                }
                
                // Marco completo para la tabla
                doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
                doc.setLineWidth(0.3);
                
                // Altura total aproximada basada en la cantidad de filas
                const numFilas = tipo === 'comparativo' ? datos.length : datos.length;
                const alturaTabla = (altoFila * numFilas) + 5;
                
                // Marco exterior de la tabla completa
                doc.rect(margenTabla, posY - 5, anchoDisponible, altoEncabezado, 'F');
                
                // ---- FILA DE ENCABEZADOS ----
                doc.setFillColor(colores.principal[0], colores.principal[1], colores.principal[2]);
                doc.rect(margenTabla, posY - 5, anchoDisponible, altoFila, 'F');
                
                // Texto blanco para encabezados
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                
                // Colocar texto de encabezados 
                let posX = margenTabla;
                encabezados.forEach((encabezado, index) => {
                    // Centrar el texto en cada columna
                    const textoX = posX + anchoColumnas[index]/2;
                    doc.text(encabezado, textoX, posY, {align: 'center'});
                    
                    // Dibujar l√≠neas verticales separadoras (excepto √∫ltima)
                    if (index < encabezados.length - 1) {
                        doc.setDrawColor(255, 255, 255);
                        doc.setLineWidth(0.2);
                        doc.line(posX + anchoColumnas[index], posY - 5, posX + anchoColumnas[index], posY + altoFila - 5);
                    }
                    
                    posX += anchoColumnas[index];
                });
                
                // ---- FILAS DE DATOS ----
                posY += altoFila; // Avanzar a la primera fila de datos
                doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
                doc.setFont(undefined, 'normal');
                doc.setLineWidth(0.2);
                
                // Calcular cu√°ntas filas caben por p√°gina
                const filasPorPagina = Math.floor((altoPagina - posY - 25) / altoFila);
                
                // Determinar qu√© datos procesar seg√∫n el tipo de informe
                let datosAProcesar = [];
                if (tipo === 'comparativo') {
                    datosAProcesar = datos.slice(1); // Quitar la fila de encabezados
                } else {
                    datosAProcesar = datos;
                }
                
                // Calcular n√∫mero total de p√°ginas
                const paginasTotales = Math.ceil(datosAProcesar.length / filasPorPagina);
                
                // Procesar cada p√°gina
                for (let pagina = 0; pagina < paginasTotales; pagina++) {
                    if (pagina > 0) {
                        // Nueva p√°gina
                        doc.addPage();
                        posY = agregarEncabezado(pagina + 2);
                        agregarPiePagina();
                        
                        // Repetir encabezados en la nueva p√°gina
                        doc.setFillColor(colores.principal[0], colores.principal[1], colores.principal[2]);
                        doc.rect(margenTabla, posY - 5, anchoDisponible, altoFila, 'F');
                        
                        // Marco para esta p√°gina
                        const filasRestantes = Math.min(filasPorPagina, datosAProcesar.length - (pagina * filasPorPagina));
                        const alturaTablaRestante = (altoFila * (filasRestantes + 1));
                        
                        doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
                        doc.rect(margenTabla, posY - 5, anchoDisponible, alturaTablaRestante, 'S');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        
                        posX = margenTabla;
                        encabezados.forEach((encabezado, index) => {
                            // Centrar el texto en cada columna
                            const textoX = posX + anchoColumnas[index]/2;
                            doc.text(encabezado, textoX, posY, {align: 'center'});
                            
                            // Dibujar l√≠neas verticales separadoras (excepto √∫ltima)
                            if (index < encabezados.length - 1) {
                                doc.setDrawColor(255, 255, 255);
                                doc.setLineWidth(0.2);
                                doc.line(posX + anchoColumnas[index], posY - 5, posX + anchoColumnas[index], posY + altoFila - 5);
                            }
                            
                            posX += anchoColumnas[index];
                        });
                        
                        posY += altoFila; // Avanzar a la primera fila de datos en la nueva p√°gina
                        doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
                        doc.setFont(undefined, 'normal');
                    }
                    
                    // Calcular rango de filas para esta p√°gina
                    const inicio = pagina * filasPorPagina;
                    const fin = Math.min((pagina + 1) * filasPorPagina, datosAProcesar.length);
                    
                    // Procesar cada fila de esta p√°gina
                    for (let i = inicio; i < fin; i++) {
                        const fila = datosAProcesar[i];
                        
                        // Alternar colores de fondo para las filas
                        if (i % 2 === 0) {
                            doc.setFillColor(colores.grisClaro[0], colores.grisClaro[1], colores.grisClaro[2]);
                        } else {
                            doc.setFillColor(colores.blanco[0], colores.blanco[1], colores.blanco[2]);
                        }
                        doc.rect(margenTabla, posY - 5, anchoDisponible, altoFila, 'F');
                        
                        // Dibujar l√≠neas horizontales para separar filas
                        doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
                        doc.line(margenTabla, posY - 5, margenTabla + anchoDisponible, posY - 5);
                        
                        // Procesar cada celda seg√∫n el tipo de informe
                        if (tipo === 'centro' || tipo === 'indicador') {
                            posX = margenTabla;
                            
                            // Primera columna (Indicador o Centro)
                            const primeraColumna = tipo === 'centro' ? fila.indicador : fila.centro;
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'bold');
                            doc.text(primeraColumna, posX + 2, posY);
                            
                            // Dibujar l√≠nea vertical despu√©s de la primera columna
                            doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
                            doc.line(posX + anchoColumnas[0], posY - 5, posX + anchoColumnas[0], posY + altoFila - 5);
                            
                            posX += anchoColumnas[0];
                            
                            // Restaurar estilo para datos
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                            
                            // Numerador
                            doc.text(fila.numerador, posX + anchoColumnas[1]/2, posY, {align: 'center'});
                            doc.line(posX + anchoColumnas[1], posY - 5, posX + anchoColumnas[1], posY + altoFila - 5);
                            posX += anchoColumnas[1];
                            
                            // Denominador
                            doc.text(fila.denominador, posX + anchoColumnas[2]/2, posY, {align: 'center'});
                            doc.line(posX + anchoColumnas[2], posY - 5, posX + anchoColumnas[2], posY + altoFila - 5);
                            posX += anchoColumnas[2];
                            
                            // Resultado
                            doc.text(fila.resultado, posX + anchoColumnas[3]/2, posY, {align: 'center'});
                            doc.line(posX + anchoColumnas[3], posY - 5, posX + anchoColumnas[3], posY + altoFila - 5);
                            posX += anchoColumnas[3];
                            
                            // Meta
                            doc.text(fila.meta, posX + anchoColumnas[4]/2, posY, {align: 'center'});
                            doc.line(posX + anchoColumnas[4], posY - 5, posX + anchoColumnas[4], posY + altoFila - 5);
                            posX += anchoColumnas[4];
                            
                            // Cumplimiento con formato especial
                            const cumplimiento = parseFloat(fila.cumplimiento);
                            
                            if (cumplimiento >= 100) {
                                doc.setFillColor(colores.secundario[0], colores.secundario[1], colores.secundario[2]);
                                doc.rect(posX, posY - 5, anchoColumnas[5], altoFila, 'F');
                                
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(9);
                                doc.setFont(undefined, 'bold');
                                doc.text(fila.cumplimiento, posX + anchoColumnas[5]/2, posY, {align: 'center'});
                                doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
                                doc.setFont(undefined, 'normal');
                            } else {
                                doc.text(fila.cumplimiento, posX + anchoColumnas[5]/2, posY, {align: 'center'});
                            }
                            
                        } else if (tipo === 'comparativo') {
                            // Informe comparativo (tabla especial)
                            posX = margenTabla;
                            
                            fila.forEach((celda, j) => {
                                // Primera columna (indicador)
                                if (j === 0) {
                                    doc.setFontSize(9);
                                    doc.setFont(undefined, 'bold');
                                    doc.text(celda, posX + 2, posY);
                                } else {
                                    // Centrar texto en otras columnas
                                    doc.setFontSize(9);
                                    doc.setFont(undefined, 'normal');
                                    
                                    // Celda de cumplimiento
                                    if (j >= 2 && celda !== '-' && celda.includes('%')) {
                                        const cumplimiento = parseFloat(celda);
                                        
                                        if (cumplimiento >= 100) {
                                            doc.setFillColor(colores.secundario[0], colores.secundario[1], colores.secundario[2]);
                                            doc.rect(posX, posY - 5, anchoColumnas[j], altoFila, 'F');
                                            
                                            doc.setTextColor(255, 255, 255);
                                            doc.setFont(undefined, 'bold');
                                            doc.text(celda, posX + anchoColumnas[j]/2, posY, {align: 'center'});
                                            doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
                                            doc.setFont(undefined, 'normal');
                                        } else {
                                            doc.text(celda, posX + anchoColumnas[j]/2, posY, {align: 'center'});
                                        }
                                    } else {
                                        doc.text(celda, posX + anchoColumnas[j]/2, posY, {align: 'center'});
                                    }
                                }
                                
                                // Dibujar l√≠nea vertical despu√©s de cada columna (excepto la √∫ltima)
                                if (j < fila.length - 1) {
                                    doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
                                    doc.line(posX + anchoColumnas[j], posY - 5, posX + anchoColumnas[j], posY + altoFila - 5);
                                }
                                
                                posX += anchoColumnas[j];
                            });
                        }
                        
                        // Avanzar a la siguiente fila
                        posY += altoFila;
                    }
                }
                
                return posY + 10; // Retornar la posici√≥n final
            }
            
            // ============ FUNCI√ìN PARA CREAR MARCO PARA GR√ÅFICOS ============
            function crearMarcoGrafico(x, y, ancho, alto, titulo) {
                // Marco para el gr√°fico
                doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
                doc.setLineWidth(0.5);
                doc.rect(x, y, ancho, alto, 'S');
                
                // Barra superior para el t√≠tulo
                doc.setFillColor(colores.principal[0], colores.principal[1], colores.principal[2]);
                doc.rect(x, y, ancho, 8, 'F');
                
                // T√≠tulo del gr√°fico
                if (titulo) {
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(titulo, x + ancho/2, y + 5.5, {align: 'center'});
                }
                
                // Retornar el √°rea √∫til para el gr√°fico (con m√°rgenes internos)
                return {
                    x: x + 5,
                    y: y + 12, // Despu√©s del t√≠tulo
                    ancho: ancho - 10,
                    alto: alto - 15
                };
            }
            
            // ============ INICIAR CONSTRUCCI√ìN DEL PDF ============
            // Primera p√°gina - Portada formal y elegante
            let posY = agregarEncabezado(1);
            agregarPiePagina();
            
            // T√≠tulo principal
            posY += 15;
            doc.setTextColor(colores.principal[0], colores.principal[1], colores.principal[2]);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(titulo, anchoPagina / 2, posY, { align: 'center' });
            
            // L√≠nea decorativa bajo el t√≠tulo
            const anchoTitulo = doc.getTextWidth(titulo);
            doc.setDrawColor(colores.acento[0], colores.acento[1], colores.acento[2]);
            doc.setLineWidth(0.8);
            doc.line(anchoPagina/2 - anchoTitulo/2, posY + 3, anchoPagina/2 + anchoTitulo/2, posY + 3);
            
            // Subt√≠tulo
            posY += 15;
            doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text(subtitulo, anchoPagina / 2, posY, { align: 'center' });
            
            // Fecha del reporte
            posY += 12;
            doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
            doc.setLineWidth(0.3);
            doc.rect(anchoPagina/2 - 40, posY - 8, 80, 12, 'S');
            
            doc.setFillColor(colores.grisClaro[0], colores.grisClaro[1], colores.grisClaro[2]);
            doc.rect(anchoPagina/2 - 40, posY - 8, 80, 12, 'F');
            
            doc.setTextColor(colores.principal[0], colores.principal[1], colores.principal[2]);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            const fechaTexto = new Date().toLocaleDateString('es-CL', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            doc.text(fechaTexto, anchoPagina / 2, posY, { align: 'center' });
            
            // Separador
            posY += 20;
            doc.setDrawColor(colores.principal[0], colores.principal[1], colores.principal[2]);
            doc.setLineWidth(0.5);
            doc.line(margen, posY, anchoPagina - margen, posY);
            
            // Descripci√≥n del informe
            posY += 15;
            doc.setFontSize(11);
            doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
            doc.setFont(undefined, 'normal');
            
            // Marco para la descripci√≥n
            doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
            doc.setLineWidth(0.3);
            doc.rect(margen, posY - 10, anchoPagina - 2*margen, 60, 'S');
            
            doc.setFillColor(colores.grisClaro[0], colores.grisClaro[1], colores.grisClaro[2]);
            doc.rect(margen, posY - 10, anchoPagina - 2*margen, 10, 'F');
            
            // T√≠tulo de la secci√≥n
            doc.setTextColor(colores.principal[0], colores.principal[1], colores.principal[2]);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text("DESCRIPCI√ìN DEL INFORME", margen + 10, posY - 3);
            
            // Texto de la descripci√≥n
            doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            let descripcion = '';
            if (tipo === 'centro') {
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                descripcion = `Este informe presenta el cumplimiento de los indicadores IAAPS para el centro "${centro.nombre}" durante el mes de Abril de 2025. El informe incluye el detalle de cada indicador con sus respectivos resultados, metas y nivel de cumplimiento.`;
            } else if (tipo === 'indicador') {
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                descripcion = `Este informe presenta el comportamiento del indicador "${indicador.nombre}" (${indicador.codigo}) en todos los centros de salud durante el mes de Abril de 2025. Se incluye el detalle para cada centro y su nivel de cumplimiento respecto a la meta establecida.`;
            } else {
                descripcion = `Este informe comparativo muestra el cumplimiento de todos los indicadores IAAPS para todos los centros de salud durante el mes de Abril de 2025. La tabla permite visualizar y comparar el desempe√±o de cada centro respecto a cada indicador.`;
            }
            
            const lineasDescripcion = doc.splitTextToSize(descripcion, anchoPagina - 2 * margen - 10);
            doc.text(lineasDescripcion, margen + 5, posY + 5);
            
           // ‚Äî‚Äî‚Äî Leyenda de Cumplimiento como tarjeta ‚Äî‚Äî‚Äî
posY += 65;

// Coordenadas y dimensiones de la tarjeta
const leyendaX = margen;
const leyendaWidth = anchoPagina - 2 * margen;
const leyendaHeight = 50;  // altura total de la tarjeta

// 1) Marco exterior de la tarjeta
doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
doc.setLineWidth(0.3);
doc.rect(leyendaX, posY - 5, leyendaWidth, leyendaHeight, 'S');

// 2) Fondo de header
doc.setFillColor(colores.grisClaro[0], colores.grisClaro[1], colores.grisClaro[2]);
doc.rect(leyendaX, posY - 5, leyendaWidth, 10, 'F');

// 3) T√≠tulo (header)
doc.setTextColor(colores.principal[0], colores.principal[1], colores.principal[2]);
doc.setFontSize(10);
doc.setFont(undefined, 'bold');
doc.text('LEYENDA DE CUMPLIMIENTO', leyendaX + 8, posY + 2);

// 4) Definir items de la leyenda
const items = [
  { tipo: 'fill',  color: colores.secundario, texto: 'Cumplido (‚â• 100%)' },
  { tipo: 'stroke', color: colores.grisMedio,  texto: 'No Cumplido (< 100%)' }
];

const boxSize   = 7;    // tama√±o de la ‚Äútarjeta‚Äù interna
const gapX      = 60;   // separaci√≥n horizontal entre tarjetas
const startX    = leyendaX + 10;
let   currentX  = startX;
const textOffsetY = 5;  // para centrar verticalmente el texto

// 5) Dibujar cada tarjeta y su texto, alineadas dentro de la tarjeta
items.forEach(item => {
  if (item.tipo === 'fill') {
    doc.setFillColor(item.color[0], item.color[1], item.color[2]);
    doc.rect(currentX, posY + 8, boxSize, boxSize, 'F');
  } else {
    doc.setDrawColor(item.color[0], item.color[1], item.color[2]);
    doc.rect(currentX, posY + 8, boxSize, boxSize, 'S');
  }

  doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
  doc.setFontSize(9);
  doc.setFont(undefined, 'normal');
  doc.text(item.texto, currentX + boxSize + 4, posY + 8 + textOffsetY);

  // Avanzar X para la siguiente tarjeta
  currentX += gapX;
});

            // ============ P√ÅGINA DE TABLA DE DATOS ============
            doc.addPage();
            posY = agregarEncabezado(2);
            agregarPiePagina();
            
            // T√≠tulo de la secci√≥n
            posY += 5;
            // Barra de t√≠tulo
            doc.setFillColor(colores.principal[0], colores.principal[1], colores.principal[2]);
            doc.rect(margen, posY - 5, anchoPagina - 2*margen, 10, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('RESULTADOS DETALLADOS', anchoPagina / 2, posY + 2, { align: 'center' });
            
            // Crear tabla formal
            posY += 15;
            const posYFinTabla = crearTablaManual(datos, posY);
            
            // ============ P√ÅGINA DE GR√ÅFICOS REALES ============
            try {
                // Verificar si hay alg√∫n gr√°fico real para el informe actual
                let hayGraficos = false;
                let graficos = [];
                
                if (tipo === 'centro') {
                    const graficoEvolucion = document.getElementById('evolucionChart');
                    const graficoDistribucion = document.getElementById('distribucionChart');
                    
                    if (graficoEvolucion) {
                        graficos.push({
                            elemento: graficoEvolucion,
                            titulo: 'EVOLUCI√ìN MENSUAL DEL CUMPLIMIENTO'
                        });
                        hayGraficos = true;
                    }
                    
                    if (graficoDistribucion) {
                        graficos.push({
                            elemento: graficoDistribucion,
                            titulo: 'DISTRIBUCI√ìN POR TIPOS DE INDICADOR'
                        });
                        hayGraficos = true;
                    }
                } else if (tipo === 'indicador') {
                    const graficoComparativo = document.getElementById('comparativoIndicadorChart');
                    if (graficoComparativo) {
                        graficos.push({
                            elemento: graficoComparativo,
                            titulo: 'COMPARATIVO DEL INDICADOR ENTRE CENTROS'
                        });
                        hayGraficos = true;
                    }
                } else if (tipo === 'comparativo') {
                    const graficoComparativo = document.getElementById('comparativoChart');
                    if (graficoComparativo) {
                        graficos.push({
                            elemento: graficoComparativo,
                            titulo: 'AN√ÅLISIS COMPARATIVO ENTRE CENTROS'
                        });
                        hayGraficos = true;
                    }
                }
                
                // Si hay gr√°ficos reales, crear una p√°gina para ellos
                if (hayGraficos) {
                    doc.addPage();
                    posY = agregarEncabezado(3);
                    agregarPiePagina();
                    
                    // T√≠tulo de la secci√≥n
                    posY += 5;
                    // Barra de t√≠tulo
                    doc.setFillColor(colores.principal[0], colores.principal[1], colores.principal[2]);
                    doc.rect(margen, posY - 5, anchoPagina - 2*margen, 10, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('VISUALIZACI√ìN GR√ÅFICA', anchoPagina / 2, posY + 2, { align: 'center' });
                    
                    // Agregar cada gr√°fico real
                    posY += 15;
                    
                    graficos.forEach((grafico, index) => {
                        // Si no es el primer gr√°fico y no cabe en la p√°gina actual, crear nueva p√°gina
                        if (index > 0) {
                            const alturaDisponible = altoPagina - posY - 20;
                            if (alturaDisponible < 120) { // Altura m√≠nima para un gr√°fico
                                doc.addPage();
                                posY = agregarEncabezado(4) + 5;
                                agregarPiePagina();
                                
                                // Repetir t√≠tulo en la nueva p√°gina
                                posY += 5;
                                doc.setFillColor(colores.principal[0], colores.principal[1], colores.principal[2]);
                                doc.rect(margen, posY - 5, anchoPagina - 2*margen, 10, 'F');
                                
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(12);
                                doc.setFont(undefined, 'bold');
                                doc.text('VISUALIZACI√ìN GR√ÅFICA (CONTINUACI√ìN)', anchoPagina / 2, posY + 2, { align: 'center' });
                                
                                posY += 15;
                            } else {
                                posY += 15; // Espacio entre gr√°ficos
                            }
                        }
                        
                        // Altura del gr√°fico adaptada seg√∫n el espacio disponible
                        const altoGrafico = 120;
                        
                        // Crear marco formal para el gr√°fico
                        const areaGrafico = crearMarcoGrafico(
                            margen, 
                            posY, 
                            anchoPagina - 2*margen, 
                            altoGrafico, 
                            grafico.titulo
                        );
                        
                        // Agregar el gr√°fico real
                        try {
                            const imgData = grafico.elemento.toDataURL('image/png');
                            doc.addImage(
                                imgData, 
                                'PNG', 
                                areaGrafico.x, 
                                areaGrafico.y, 
                                areaGrafico.ancho, 
                                areaGrafico.alto
                            );
                        } catch (e) {
                            console.warn('Error al capturar gr√°fico:', e);
                            // Si falla la captura, mostrar un mensaje de error formal
                            doc.setDrawColor(colores.grisMedio[0], colores.grisMedio[1], colores.grisMedio[2]);
                            doc.setLineWidth(0.2);
                            doc.rect(areaGrafico.x, areaGrafico.y, areaGrafico.ancho, areaGrafico.alto, 'S');
                            
                            doc.setTextColor(colores.neutro[0], colores.neutro[1], colores.neutro[2]);
                            doc.setFontSize(10);
                            doc.text('No se pudo cargar el gr√°fico. Verifique que est√© disponible en el sistema.', 
                                areaGrafico.x + areaGrafico.ancho/2, 
                                areaGrafico.y + areaGrafico.alto/2, 
                                { align: 'center' });
                        }
                        
                        // Actualizar posici√≥n para el siguiente gr√°fico
                        posY += altoGrafico + 5;
                    });
                }
            } catch (error) {
                console.warn('Error al procesar gr√°ficos:', error);
            }
            
            // Guardar el PDF
            doc.save(nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('PDF exportado correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a PDF:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos: ' + error.message, 'error');
        }
    }, 1000);
}

/**
 * Recorta un texto a una longitud espec√≠fica y a√±ade puntos suspensivos
 * @param {string} texto - Texto a recortar
 * @param {number} longitud - Longitud m√°xima
 * @returns {string} Texto recortado
 */
function recortarTexto(texto, longitud) {
    if (!texto) return '';
    return texto.length > longitud ? texto.substring(0, longitud) + '...' : texto;
}

/**
 * Formatea un n√∫mero con separador de miles
 * @param {number} numero - N√∫mero a formatear
 * @returns {string} N√∫mero formateado
 */
function formatearNumero(numero) {
    if (numero === undefined || numero === null) return '-';
    return numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

/**
 * Formatea un valor seg√∫n su tipo (porcentaje o n√∫mero)
 * @param {number} valor - Valor a formatear
 * @param {string} tipo - Tipo de valor ('porcentaje', 'tasa', etc.)
 * @returns {string} Valor formateado
 */
function formatearValor(valor, tipo) {
    if (valor === undefined || valor === null) return '-';
    
    if (tipo === 'porcentaje') {
        return valor.toFixed(2) + '%';
    } else {
        return valor.toFixed(2);
    }
}

// ==================== CONFIGURACI√ìN DE EVENTOS ====================

/**
 * Configura los event listeners para los botones de exportaci√≥n
 * Esta funci√≥n debe llamarse al cargar la p√°gina
 */
function configurarEventosExportacion() {
  console.log("Configurando eventos de exportaci√≥n...");
  
  // Botones para exportar detalles de centro
  const btnExcelCentro = document.getElementById('exportCentroExcelBtn');
  const btnPdfCentro = document.getElementById('exportCentroPdfBtn');
  
  if (btnExcelCentro) {
    btnExcelCentro.addEventListener('click', function() {
      console.log("Exportando centro a Excel...");
      exportarExcel('centro');
    });
  }
  
  if (btnPdfCentro) {
    btnPdfCentro.addEventListener('click', function() {
      console.log("Exportando centro a PDF...");
      exportarPDF('centro');
    });
  }
  
  // Botones para exportar detalles de indicador
  const btnExcelIndicador = document.getElementById('exportIndicadorExcelBtn');
  const btnPdfIndicador = document.getElementById('exportIndicadorPdfBtn');
  
  if (btnExcelIndicador) {
    btnExcelIndicador.addEventListener('click', function() {
      console.log("Exportando indicador a Excel...");
      exportarExcel('indicador');
    });
  }
  
  if (btnPdfIndicador) {
    btnPdfIndicador.addEventListener('click', function() {
      console.log("Exportando indicador a PDF...");
      exportarPDF('indicador');
    });
  }
  
  // Botones para exportar detalles comparativos
  const btnExcelComparativo = document.getElementById('exportComparativoExcelBtn');
  const btnPdfComparativo = document.getElementById('exportComparativoPdfBtn');
  
  if (btnExcelComparativo) {
    btnExcelComparativo.addEventListener('click', function() {
      console.log("Exportando comparativo a Excel...");
      exportarExcel('comparativo');
    });
  }
  
  if (btnPdfComparativo) {
    btnPdfComparativo.addEventListener('click', function() {
      console.log("Exportando comparativo a PDF...");
      exportarPDF('comparativo');
    });
  }
  
  // Bot√≥n general de exportaci√≥n de detalle
  const btnExportDetail = document.getElementById('exportDetailBtn');
  if (btnExportDetail) {
    btnExportDetail.addEventListener('click', function() {
      console.log("Exportando detalle...");
      
      // Determinar qu√© vista est√° activa y exportar seg√∫n corresponda
      if (document.getElementById('centro-content') && 
          document.getElementById('centro-content').classList.contains('active')) {
        exportarPDF('centro');
      } 
      else if (document.getElementById('indicador-content') && 
              document.getElementById('indicador-content').classList.contains('active')) {
        exportarPDF('indicador');
      }
      else if (document.getElementById('comparativo-content') && 
              document.getElementById('comparativo-content').classList.contains('active')) {
        exportarPDF('comparativo');
      }
      else {
        // Si no se puede determinar, usar la vista de centro por defecto
        exportarPDF('centro');
      }
    });
  }
  
  console.log("Configuraci√≥n de eventos de exportaci√≥n completada.");
}

// ==================== CARGAR DIN√ÅMICAMENTE LIBRER√çAS FALTANTES ====================

/**
 * Carga din√°micamente las librer√≠as necesarias para la exportaci√≥n
 * si no est√°n disponibles
 */
function cargarLibreriasExportacion() {
  console.log("Verificando librer√≠as de exportaci√≥n...");
  
  // Verificar SheetJS (XLSX)
  if (typeof XLSX === 'undefined') {
    console.warn("Librer√≠a XLSX no encontrada. Cargando din√°micamente...");
    
    const xlsxScript = document.createElement('script');
    xlsxScript.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
    xlsxScript.onload = function() {
      console.log("Librer√≠a XLSX cargada correctamente");
    };
    document.head.appendChild(xlsxScript);
  } else {
    console.log("Librer√≠a XLSX ya est√° disponible");
  }
  
  // Verificar jsPDF
  if (typeof window.jspdf === 'undefined') {
    console.warn("Librer√≠a jsPDF no encontrada. Cargando din√°micamente...");
    
    const jspdfScript = document.createElement('script');
    jspdfScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
    jspdfScript.onload = function() {
      console.log("Librer√≠a jsPDF cargada correctamente");
      
      // Cargar el plugin AutoTable despu√©s de jsPDF
      if (typeof window.jspdf.jsPDF.prototype.autoTable === 'undefined') {
        console.warn("Plugin AutoTable no encontrado. Cargando din√°micamente...");
        
        const autoTableScript = document.createElement('script');
        autoTableScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js";
        autoTableScript.onload = function() {
          console.log("Plugin AutoTable cargado correctamente");
        };
        document.head.appendChild(autoTableScript);
      }
    };
    document.head.appendChild(jspdfScript);
  } else {
    console.log("Librer√≠a jsPDF ya est√° disponible");
    
    // Verificar AutoTable si jsPDF ya est√° disponible
    if (typeof window.jspdf.jsPDF.prototype.autoTable === 'undefined') {
      console.warn("Plugin AutoTable no encontrado. Cargando din√°micamente...");
      
      const autoTableScript = document.createElement('script');
      autoTableScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js";
      autoTableScript.onload = function() {
        console.log("Plugin AutoTable cargado correctamente");
      };
      document.head.appendChild(autoTableScript);
    } else {
      console.log("Plugin AutoTable ya est√° disponible");
    }
  }
}

// Inicializar las funciones de exportaci√≥n cuando se carga el documento
document.addEventListener('DOMContentLoaded', function() {
  console.log("Inicializando funcionalidades de exportaci√≥n...");
  
  // Cargar librer√≠as necesarias
  cargarLibreriasExportacion();
  
  // Configurar eventos despu√©s de un retraso para asegurar que todo est√° cargado
  setTimeout(function() {
    configurarEventosExportacion();
  }, 1000);
  
  console.log("Inicializaci√≥n de funcionalidades de exportaci√≥n completada.");
});

// Ejecutar la inicializaci√≥n inmediatamente si el documento ya est√° cargado
if (document.readyState === 'complete' || document.readyState === 'interactive') {
  setTimeout(function() {
    cargarLibreriasExportacion();
    configurarEventosExportacion();
  }, 1000);
}
document.getElementById('currentYear').textContent = new Date().getFullYear();
</script>

</html>