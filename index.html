<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IAAPS Curicó</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
   
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color:rgb(28, 186, 225);
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        .navbar {
            background-color: var(--primary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.85) !important;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .nav-link:hover {
            color: rgba(255, 255, 255, 1) !important;
        }
        
        .container-fluid {
            padding: 20px;
        }
        
        .dashboard-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            margin-bottom: 20px;
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            padding: 15px 20px;
            font-weight: 600;
            border-radius: 8px 8px 0 0 !important;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #219a52;
            border-color: #219a52;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
            border-color: #e67e22;
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            border-color: #c0392b;
        }
        
        .summary-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .progress {
            height: 10px;
            margin-top: auto;
        }
        
        .table-responsive {
            margin-top: 20px;
        }
        
        .table {
            width: 100%;
            margin-bottom: 0;
        }
        
        .table th {
            font-weight: 600;
            background-color: #f8f9fa;
        }
        
        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .badge {
            padding: 0.5em 0.75em;
            font-weight: 500;
        }
        
        /* Dashboard grid layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-gap: 20px;
        }
        
        .grid-span-3 {
            grid-column: span 3;
        }
        
        .grid-span-4 {
            grid-column: span 4;
        }
        
        .grid-span-6 {
            grid-column: span 6;
        }
        
        .grid-span-8 {
            grid-column: span 8;
        }
        
        .grid-span-12 {
            grid-column: span 12;
        }
        
        /* Indicador status */
        .status-success {
            color: var(--success-color);
        }
        
        .status-warning {
            color: var(--warning-color);
        }
        
        .status-danger {
            color: var(--danger-color);
        }
        
        /* Styling for the tabs */
        .tabs-container {
            margin-bottom: 20px;
        }
        
        .nav-tabs .nav-link {
            color: #495057;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
            font-weight: 600;
        }
        
        /* Custom styling for the charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* Tooltip styling */
        .tooltip-inner {
            max-width: 300px;
            padding: 10px;
            color: #fff;
            text-align: center;
            background-color: var(--dark-color);
            border-radius: 6px;
        }
        
        /* Centro cards */
        .centro-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .centro-card:hover {
            border-color: var(--secondary-color);
        }
        
        .centro-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .centro-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .centro-subtitle {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        /* Detail view */
        .breadcrumb {
            background-color: transparent;
            padding-left: 0;
            margin-bottom: 20px;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .detail-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0;
        }
        
        .detail-subtitle {
            font-size: 1rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* Table coloring based on percentage */
        .table-percentage-cell {
            position: relative;
        }
        
        .table-percentage-bg {
            position: absolute;
            height: 100%;
            left: 0;
            top: 0;
            z-index: 0;
            opacity: 0.15;
        }
        
        .table-percentage-text {
            position: relative;
            z-index: 1;
        }
        
        /* Custom toggle switch for dark/light mode */
        .custom-switch {
            display: inline-block;
            margin-left: 15px;
        }
        
        /* Modal styling */
        .modal-content {
            border-radius: 8px;
            border: none;
        }
        
        .modal-header {
            border-bottom: 1px solid #e1e5eb;
            padding: 15px 20px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            border-top: 1px solid #e1e5eb;
            padding: 15px 20px;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Dark mode */
        .dark-mode {
            background-color: #1a202c;
            color: #f7fafc;
        }
        
        .dark-mode .card {
            background-color: #2d3748;
            color: #f7fafc;
        }
        
        .dark-mode .card-header {
            background-color: #2d3748;
            border-bottom-color: #4a5568;
        }
        
        .dark-mode .table {
            color: #f7fafc;
        }
        
        .dark-mode .table th {
            background-color: #2d3748;
            color: #f7fafc;
            border-color: #4a5568;
        }
        
        .dark-mode .table td {
            border-color: #4a5568;
        }
        
        .dark-mode .table tbody tr:hover {
            background-color: rgba(66, 153, 225, 0.1);
        }
        
        .dark-mode .summary-label {
            color: #cbd5e0;
        }
        
        .dark-mode .nav-tabs .nav-link {
            color: #cbd5e0;
            background-color: #2d3748;
            border-color: #4a5568;
        }
        
        .dark-mode .nav-tabs .nav-link.active {
            color: #f7fafc;
            background-color: #4a5568;
            border-color: #4a5568;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .grid-span-3, .grid-span-4 {
                grid-column: span 3;
            }
            
            .grid-span-6, .grid-span-8, .grid-span-12 {
                grid-column: span 6;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .grid-span-3, .grid-span-4, .grid-span-6, .grid-span-8, .grid-span-12 {
                grid-column: span 3;
            }
            
            .summary-value {
                font-size: 1.8rem;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-grid {
                display: block;
            }
            
            .card {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-heartbeat me-2"></i>
                INFOGES Curicó
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="dashboardLink">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="detailLink">
                            <i class="fas fa-chart-bar me-1"></i> Detalle
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="exportDataLink">
                            <i class="fas fa-file-export me-1"></i> Exportar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="helpLink">
                            <i class="fas fa-question-circle me-1"></i> Ayuda
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex">
                    <div class="input-group">
                        <span class="input-group-text" id="search-addon">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Buscar indicador..." aria-label="Buscar" aria-describedby="search-addon" id="searchInput">
                    </div>
                    
                    <div class="custom-switch ms-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="darkModeToggle">
                            <label class="form-check-label" for="darkModeToggle">
                                <i class="fas fa-moon"></i>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-light ms-3" id="refreshDataBtn">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid">
        <!-- Dashboard View -->
        <div id="dashboardView">
            <div class="dashboard-header">
                <h2><i class="fas fa-chart-line me-2"></i>Dashboard IAAPS - Corte Marzo 2025</h2>
                <p class="text-muted">Monitoreo de Índices de Actividad de la Atención Primaria de Salud (IAAPS) para la comuna de Curicó</p>
            </div>
            
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <p class="summary-value" id="indicadorCumplidosValue">0</p>
                            <p class="summary-label">Indicadores Cumplidos</p>
                            <div class="progress">
                                <div class="progress-bar bg-success" id="indicadorCumplidosProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <p class="summary-value" id="indicadorParcialValue">0</p>
                            <p class="summary-label">Cumplimiento Parcial</p>
                            <div class="progress">
                                <div class="progress-bar bg-warning" id="indicadorParcialProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <p class="summary-value" id="indicadorCriticosValue">0</p>
                            <p class="summary-label">Indicadores Críticos</p>
                            <div class="progress">
                                <div class="progress-bar bg-danger" id="indicadorCriticosProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <p class="summary-value" id="cumplimientoComunalValue">0%</p>
                            <p class="summary-label">Cumplimiento Comunal</p>
                            <div class="progress">
                                <div class="progress-bar bg-primary" id="cumplimientoComunalProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cumplimiento por Centro -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-hospital me-2"></i>
                                Cumplimiento por Centro de Salud
                            </h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" id="viewTableBtn">
                                    <i class="fas fa-table me-1"></i> Ver Tabla
                                </button>
                                <button class="btn btn-sm btn-outline-success" id="viewChartBtn">
                                    <i class="fas fa-chart-bar me-1"></i> Ver Gráfico
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="centroChartContainer" class="chart-container">
                                <canvas id="centroChart"></canvas>
                            </div>
                            <div id="centroTableContainer" class="table-responsive" style="display: none;">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Centro de Salud</th>
                                            <th class="text-center">Cumplimiento</th>
                                            <th class="text-center">Indicadores Cumplidos</th>
                                            <th class="text-center">Parciales</th>
                                            <th class="text-center">Críticos</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="centroCumplimientoTableBody">
                                        <!-- Tabla se llenará dinámicamente con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Indicadores IAAPS -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list-check me-2"></i>
                                Indicadores IAAPS - Avance Comunal
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Indicador</th>
                                            <th class="text-center">Meta</th>
                                            <th class="text-center">Actual</th>
                                            <th class="text-center">Cumplimiento</th>
                                            <th class="text-center">Tendencia</th>
                                        </tr>
                                    </thead>
                                    <tbody id="indicadoresTableBody">
                                        <!-- Tabla se llenará dinámicamente con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-star me-2"></i>
                                Top 5 Indicadores
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="text-success">Mayor Cumplimiento</h6>
                                <div id="topIndicadoresContainer" class="chart-container">
                                    <canvas id="topIndicadoresChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h6 class="text-danger">Menor Cumplimiento</h6>
                                <div id="bottomIndicadoresContainer" class="chart-container">
                                    <canvas id="bottomIndicadoresChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Centros de Salud Cards -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="mb-3"><i class="fas fa-building me-2"></i>Centros de Salud</h4>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroCurico">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Curicó Centro</h5>
                            <p class="centro-subtitle">Avda. Freire 189</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroCuricoProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroCuricoValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroMiguel">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Miguel Ángel</h5>
                            <p class="centro-subtitle">Balmaceda 179</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroMiguelProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroMiguelValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroBetty">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Betty Muñoz</h5>
                            <p class="centro-subtitle">Marcelo Oxilia 1550</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroBettyProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroBettyValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroColon">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Colón</h5>
                            <p class="centro-subtitle">Balmaceda 1661</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroColonProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroColonValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroSarmiento">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Sarmiento</h5>
                            <p class="centro-subtitle">Volcán Calbuco s/n</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroSarmientoProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroSarmientoValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroNiches">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Los Niches</h5>
                            <p class="centro-subtitle">Villa Santa Elena</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroNichesProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroNichesValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detail View -->
        <div id="detailView" style="display: none;">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#" id="backToDashboard">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page" id="detailBreadcrumb">Detalle</li>
                </ol>
            </nav>
            
            <div class="detail-header">
                <div>
                    <h3 class="detail-title" id="detailTitle">Detalle de Indicadores IAAPS</h3>
                    <p class="detail-subtitle" id="detailSubtitle">Seleccione un centro o indicador para ver detalles específicos.</p>
                </div>
                <div>
                    <button class="btn btn-primary" id="exportDetailBtn">
                        <i class="fas fa-file-export me-1"></i> Exportar Reporte
                    </button>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="detailTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="centro-tab" data-bs-toggle="tab" data-bs-target="#centro-content" 
                            type="button" role="tab" aria-controls="centro-content" aria-selected="true">
                        <i class="fas fa-hospital me-1"></i> Por Centro de Salud
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="indicador-tab" data-bs-toggle="tab" data-bs-target="#indicador-content" 
                            type="button" role="tab" aria-controls="indicador-content" aria-selected="false">
                        <i class="fas fa-list-check me-1"></i> Por Indicador
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comparativo-tab" data-bs-toggle="tab" data-bs-target="#comparativo-content" 
                            type="button" role="tab" aria-controls="comparativo-content" aria-selected="false">
                        <i class="fas fa-chart-bar me-1"></i> Comparativo
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="detailTabContent">
                <!-- Centro Content -->
                <div class="tab-pane fade show active" id="centro-content" role="tabpanel" aria-labelledby="centro-tab">
                    <div class="row mt-4">
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Centros de Salud</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group" id="centroListGroup">
                                        <a href="#" class="list-group-item list-group-item-action active" 
                                           data-centro="comunal">CURICÓ (COMUNAL)</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="curico">CESFAM Curicó Centro</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="miguel">CESFAM Miguel Ángel Arenas</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="betty">CESFAM Betty Muñoz</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="colon">CESFAM Colón</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="sarmiento">CESFAM Sarmiento</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="niches">CESFAM Los Niches</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="centroCumplimientoTitle">Cumplimiento IAAPS Comunal</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportCentroExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportCentroPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="centroCumplimientoChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="centroIndicadoresChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Indicador</th>
                                                    <th class="text-center">Numerador</th>
                                                    <th class="text-center">Denominador</th>
                                                    <th class="text-center">Resultado</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="centroIndicadoresTableBody">
                                                <!-- Se llenará dinámicamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card" id="establecimientosCard" style="display: none;">
                                <div class="card-header">
                                    <h5 class="mb-0">Establecimientos Asociados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Establecimiento</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Indicadores Cumplidos</th>
                                                    <th class="text-center">Parciales</th>
                                                    <th class="text-center">Críticos</th>
                                                </tr>
                                            </thead>
                                            <tbody id="establecimientosTableBody">
                                                <!-- Se llenará dinámicamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Indicador Content -->
                <div class="tab-pane fade" id="indicador-content" role="tabpanel" aria-labelledby="indicador-tab">
                    <div class="row mt-4">
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Indicadores IAAPS</h5>
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <div class="list-group" id="indicadorListGroup">
                                        <!-- Se llenará dinámicamente con JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="indicadorDetailTitle">Detalle de Indicador</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportIndicadorExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportIndicadorPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="indicadorCentrosChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="indicadorTendenciaChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 id="indicadorNombreCompleto">Nombre del Indicador</h6>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>Meta:</strong> <span id="indicadorMetaValor">0%</span></p>
                                                            <p><strong>Importancia:</strong> <span id="indicadorImportanciaValor">0%</span></p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>Numerador:</strong> <span id="indicadorNumeradorFormula">Fórmula del numerador</span></p>
                                                            <p><strong>Denominador:</strong> <span id="indicadorDenominadorFormula">Fórmula del denominador</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Centro de Salud</th>
                                                    <th class="text-center">Numerador</th>
                                                    <th class="text-center">Denominador</th>
                                                    <th class="text-center">Resultado</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="indicadorCentrosTableBody">
                                                <!-- Se llenará dinámicamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparativo Content -->
                <div class="tab-pane fade" id="comparativo-content" role="tabpanel" aria-labelledby="comparativo-tab">
                    <div class="row mt-4">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Comparativo de Cumplimiento</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportComparativoExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportComparativoPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="chart-container">
                                                <canvas id="comparativoChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Matriz de Cumplimiento</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Indicador</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Comunal</th>
                                                    <th class="text-center">Curicó Centro</th>
                                                    <th class="text-center">Miguel Ángel</th>
                                                    <th class="text-center">Betty Muñoz</th>
                                                    <th class="text-center">Colón</th>
                                                    <th class="text-center">Sarmiento</th>
                                                    <th class="text-center">Los Niches</th>
                                                </tr>
                                            </thead>
                                            <tbody id="comparativoTableBody">
                                                <!-- Se llenará dinámicamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="fas fa-question-circle me-2"></i>
                        Ayuda del Dashboard IAAPS
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h5>¿Qué son los IAAPS?</h5>
                            <p>
                                Los Índices de Actividad de la Atención Primaria de Salud (IAAPS) son un conjunto de 
                                indicadores que permiten evaluar el funcionamiento integral de la atención primaria.
                                Estos indicadores miden diferentes aspectos como cobertura, continuidad, calidad 
                                de la atención y más.
                            </p>
                            
                            <h5>¿Cómo leer el dashboard?</h5>
                            <p>
                                El dashboard proporciona una visión general del cumplimiento de los IAAPS a nivel comunal
                                y por cada centro de salud. Los indicadores se clasifican según su cumplimiento:
                            </p>
                            <ul>
                                <li><span class="badge bg-success">Cumplido</span> - Cumplimiento igual o superior al 95% de la meta</li>
                                <li><span class="badge bg-warning">Parcial</span> - Cumplimiento entre 80% y 95% de la meta</li>
                                <li><span class="badge bg-danger">Crítico</span> - Cumplimiento inferior al 80% de la meta</li>
                            </ul>
                            
                            <h5>Secciones principales</h5>
                            <ul>
                                <li><strong>Dashboard</strong>: Vista general del cumplimiento comunal y por centro</li>
                                <li><strong>Detalle</strong>: Información detallada por centro o por indicador</li>
                                <li><strong>Exportar</strong>: Opciones para generar reportes en PDF o Excel</li>
                            </ul>
                            
                            <h5>¿Cómo actualizar los datos?</h5>
                            <p>
                                Los datos se cargan automáticamente desde el archivo IAAPS_Corte_Marzo.xlsx. 
                                Para actualizar los datos después de modificar el archivo Excel, haga clic en el 
                                botón "Actualizar" en la barra de navegación.
                            </p>
                            
                            <h5>Leyenda de cálculos</h5>
                            <ul>
                                <li><strong>Resultado</strong>: Numerador / Denominador</li>
                                <li><strong>Cumplimiento</strong>: (Resultado / Meta) * 100%</li>
                                <li><strong>Cumplimiento máximo</strong>: 100% (aunque el cálculo sea superior)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Core JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuración global de Chart.js
        Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#666';
        
        // Variables globales para datos
        let iaapsData = null;
        let currentCentro = 'comunal';
        let currentIndicador = '1';
        let darkMode = false;
        
        // Mapeo de códigos de indicadores a nombres completos
        const indicadoresMap = {
            '1': 'Porcentaje de centros de salud autoevaluados mediante MAIS',
            '2.1': 'Continuidad de Atención',
            '2.2': 'Disponibilidad de fármacos trazadores',
            '3': 'Tasa de consultas médicas de morbilidad por habitante año',
            '4': 'Porcentaje de derivación al nivel secundario',
            '5': 'Tasa de Visita Domiciliaria Integral',
            '6.1.A': 'Cobertura EMP mujeres (20-64 años)',
            '6.1.B': 'Cobertura EMP hombres (20-64 años)',
            '6.2': 'Cobertura EMPAM (65+ años)',
            '7': 'Cobertura evaluación desarrollo psicomotor (12-23 meses)',
            '8': 'Cobertura control adolescentes (10-19 años)',
            '9.1': 'Cobertura atención salud mental',
            '9.2': 'Tasa controles salud mental',
            '9.3': 'Personas egresadas por alta clínica',
            '10': 'Cumplimiento GES en APS',
            '11': 'Cobertura vacunación anti-influenza',
            '12': 'Ingreso precoz a control de embarazo',
            '13': 'Cobertura regulación fertilidad adolescentes',
            '14': 'Cobertura DM2 (15+ años)',
            '15': 'Cobertura HTA (15+ años)',
            '16': 'Proporción niños sin caries (<3 años)',
            '17': 'Prevalencia normalidad menores de 2 años'
        };
        
        // Mapeo de códigos de centros a nombres completos
        const centrosMap = {
            'comunal': 'CURICÓ TOTAL COMUNAL',
            'curico': 'CURICO CENTRO',
            'miguel': 'MIGUEL ANGEL ARENAS',
            'betty': 'BETTY MUÑOZ',
            'colon': 'COLON',
            'sarmiento': 'SARMIENTO',
            'niches': 'LOS NICHES'
        };
        
        // Mapeo de establecimientos asociados a cada centro
        const establecimientosMap = {
            'curico': [],
            'miguel': ['PROSPERIDAD'],
            'betty': ['PSR PORVENIR'],
            'colon': ["PSR TUTUQUEN"],
            'sarmiento': ['DOÑA CARMEN', 'PSR POTRERO GRANDE', 'PSR CHEQUENLEMU', 'PSR UPEO', 'PSR CORDILLERILLA'],
            'niches': ['PSR LA OBRA']
        };
        
        // Importancia relativa de cada indicador
        const importanciaIndicadores = {
            '1': '4%',
            '2.1': '4%',
            '2.2': '4%',
            '3': '6%',
            '4': '5%',
            '5': '5%',
            '6.1.A': '3%',
            '6.1.B': '4%',
            '6.2': '5%',
            '7': '5%',
            '8': '6%',
            '9.1': '5.5%',
            '9.2': '3.3%',
            '9.3': '2.2%',
            '10': 'Crítico',
            '11': '5%',
            '12': '6%',
            '13': '6%',
            '14': '6%',
            '15': '6%',
            '16': '5%',
            '17': '4%'
        };
        
        // Fórmulas de numeradores y denominadores
        const formulasIndicadores = {
            '1': {
                numerador: 'N° de centros de salud de la comuna autoevaluados',
                denominador: 'Total de los establecimientos de salud de la comuna año 2025'
            },
            '2.1': {
                numerador: 'N° establecimientos funcionando de 8:00 a 20:00 horas de lunes a viernes y sábados de 9:00 a 13:00 horas',
                denominador: 'N° total de establecimientos visitados'
            },
            '2.2': {
                numerador: 'N° de fármacos trazadores disponibles',
                denominador: 'N° total de fármacos trazadores'
            },
            '3': {
                numerador: 'N° de consultas de morbilidad realizadas por profesional médico',
                denominador: 'Población inscrita validada'
            },
            '4': {
                numerador: 'N° SIC de controles y consultas médicas generadas en APS',
                denominador: 'N° total de controles y consultas médicas realizadas en APS'
            },
            '5': {
                numerador: 'N° de visitas domiciliarias integrales realizadas',
                denominador: 'N° de familias (población inscrita validada / 3,3)'
            },
            '6.1.A': {
                numerador: 'N° de EMP realizados a mujeres de 20 a 64 años',
                denominador: 'Población de mujeres de 20 a 64 años inscrita - Población embarazadas 20-54 años'
            },
            '6.1.B': {
                numerador: 'N° de EMP realizados a hombres de 20 a 64 años',
                denominador: 'Población de hombres de 20 a 64 años inscrita'
            },
            '6.2': {
                numerador: 'N° de EMP realizados a personas de 65 y más años',
                denominador: 'Población de 65 y más años inscrita'
            },
            '7': {
                numerador: 'N° niños/as de 12 a 23 meses con evaluación del desarrollo psicomotor',
                denominador: 'N° total de niños/as entre 12 a 23 meses bajo control'
            },
            '8': {
                numerador: 'N° de controles de salud integral realizados a adolescentes de 10 a 19 años',
                denominador: 'Total población adolescente de 10 a 19 años inscrita'
            },
            '9.1': {
                numerador: 'N° de personas con trastornos mentales y condicionantes de la salud mental bajo control',
                denominador: 'N° de personas con trastornos mentales esperados según prevalencia (22%)'
            },
            '9.2': {
                numerador: 'N° de controles de Salud Mental realizados en personas de 0 y más años',
                denominador: 'N° de personas bajo control en el programa de salud mental'
            },
            '9.3': {
                numerador: 'N° personas egresadas por alta clínica de 0 más años',
                denominador: 'N° de personas bajo control en el programa de salud mental'
            },
            '10': {
                numerador: 'N° de casos GES en atención primaria con garantía atendida',
                denominador: 'N° total de casos GES en APS'
            },
            '11': {
                numerador: 'N° de personas de grupos objetivos vacunados con anti-influenza',
                denominador: 'Total de población inscrita de los grupos objetivos'
            },
            '12': {
                numerador: 'N° de mujeres embarazadas ingresadas antes de las 14 semanas a control',
                denominador: 'Total de mujeres embarazadas ingresadas a control'
            },
            '13': {
                numerador: 'N° de adolescentes de 15 a 19 años que usan método de regulación de la fertilidad',
                denominador: 'Total adolescentes de 15 a 19 años inscritos'
            },
            '14': {
                numerador: 'N° de personas de 15 y más años con DM2 bajo control',
                denominador: 'N° de personas con DM2 de 15 y más años, esperados según prevalencia'
            },
            '15': {
                numerador: 'N° de personas de 15 y más años con HTA bajo control',
                denominador: 'N° de personas con HTA de 15 y más años, esperados según prevalencia'
            },
            '16': {
                numerador: 'N° de niños y niñas menores de 3 años con registro CEOD = 0',
                denominador: 'N° de niñas y niños menores de 3 años inscritos'
            },
            '17': {
                numerador: 'N° de niñas y niños < dos años con estado nutricional normal',
                denominador: 'N° de niñas y niños < dos años bajo control'
            }
        };
        
        // Función para inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips y popovers de Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Cargar datos iniciales
            cargarDatos();
            
            // Event listeners para navegación
            document.getElementById('dashboardLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('dashboardView');
            });
            
            document.getElementById('detailLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('detailView');
            });
            
            document.getElementById('backToDashboard').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('dashboardView');
            });
            
            document.getElementById('helpLink').addEventListener('click', function(e) {
                e.preventDefault();
                const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
                helpModal.show();
            });
            
            document.getElementById('refreshDataBtn').addEventListener('click', function(e) {
                cargarDatos();
            });
            
            document.getElementById('viewTableBtn').addEventListener('click', function(e) {
                document.getElementById('centroChartContainer').style.display = 'none';
                document.getElementById('centroTableContainer').style.display = 'block';
            });
            
            document.getElementById('viewChartBtn').addEventListener('click', function(e) {
                document.getElementById('centroChartContainer').style.display = 'block';
                document.getElementById('centroTableContainer').style.display = 'none';
            });
            
            // Event listeners para tarjetas de centros
            document.getElementById('centroCurico').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('curico');
            });
            
            document.getElementById('centroMiguel').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('miguel');
            });
            
            document.getElementById('centroBetty').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('betty');
            });
            
            document.getElementById('centroColon').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('colon');
            });
            
            document.getElementById('centroSarmiento').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('sarmiento');
            });
            
            document.getElementById('centroNiches').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('niches');
            });
            
            // Event listeners para lista de centros en vista detalle
            document.getElementById('centroListGroup').addEventListener('click', function(e) {
                if (e.target.classList.contains('list-group-item')) {
                    e.preventDefault();
                    
                    // Remover clase active de todos los items
                    document.querySelectorAll('#centroListGroup .list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Agregar clase active al item seleccionado
                    e.target.classList.add('active');
                    
                    // Mostrar detalles del centro seleccionado
                    seleccionarCentro(e.target.dataset.centro);
                }
            });
            
            // Event listeners para exportar
            document.getElementById('exportCentroExcelBtn').addEventListener('click', function() {
                exportarExcel('centro');
            });
            
            document.getElementById('exportCentroPdfBtn').addEventListener('click', function() {
                exportarPDF('centro');
            });
            
            document.getElementById('exportIndicadorExcelBtn').addEventListener('click', function() {
                exportarExcel('indicador');
            });
            
            document.getElementById('exportIndicadorPdfBtn').addEventListener('click', function() {
                exportarPDF('indicador');
            });
            
            document.getElementById('exportComparativoExcelBtn').addEventListener('click', function() {
                exportarExcel('comparativo');
            });
            
            document.getElementById('exportComparativoPdfBtn').addEventListener('click', function() {
                exportarPDF('comparativo');
            });
            
            // Toggle modo oscuro
            document.getElementById('darkModeToggle').addEventListener('change', function() {
                toggleDarkMode();
            });
            
            // Búsqueda
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                buscarIndicadores(searchTerm);
            });
            
            // Llenar lista de indicadores
            llenarListaIndicadores();
            
            // Event listener para la lista de indicadores
            document.getElementById('indicadorListGroup').addEventListener('click', function(e) {
                if (e.target.classList.contains('list-group-item')) {
                    e.preventDefault();
                    
                    // Remover clase active de todos los items
                    document.querySelectorAll('#indicadorListGroup .list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Agregar clase active al item seleccionado
                    e.target.classList.add('active');
                    
                    // Mostrar detalles del indicador seleccionado
                    seleccionarIndicador(e.target.dataset.indicador);
                }
            });
        });
        
        // Función para llenar la lista de indicadores
        function llenarListaIndicadores() {
            const indicadorListGroup = document.getElementById('indicadorListGroup');
            indicadorListGroup.innerHTML = '';
            
            // Códigos de los indicadores en orden específico
            const indicadoresCodigos = ['1', '2.1', '2.2', '3', '4', '5', '6.1.A', '6.1.B', '6.2', '7', '8', '9.1', '9.2', '9.3', '10', '11', '12', '13', '14', '15', '16', '17'];
            
            indicadoresCodigos.forEach((codigo, index) => {
                const item = document.createElement('a');
                item.href = '#';
                item.classList.add('list-group-item', 'list-group-item-action');
                if (index === 0) item.classList.add('active');
                item.dataset.indicador = codigo;
                
                // Abreviación del nombre para la lista
                const nombreCorto = codigo + '. ' + indicadoresMap[codigo].split('(')[0];
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${nombreCorto}</h6>
                    </div>
                    <small class="text-muted">Importancia: ${importanciaIndicadores[codigo]}</small>
                `;
                
                indicadorListGroup.appendChild(item);
            });
        }
        
        // Función para cargar datos
        async function cargarDatos() {
            mostrarCargando(true);
            
            try {
                // Simular carga de datos desde el archivo
                // En una implementación real, esto se haría con una solicitud AJAX o fetch
                await simularCargaDeDatos();
                
                // Procesamiento de datos
                procesarDatos();
                
                // Actualizar la interfaz
                actualizarDashboard();
                actualizarDetalle();
                
                mostrarCargando(false);
                mostrarNotificacion('Datos actualizados correctamente', 'success');
            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarCargando(false);
                mostrarNotificacion('Error al cargar datos. Por favor, intente nuevamente.', 'error');
            }
        }
        
        // Función para simular carga de datos desde el archivo Excel
        function simularCargaDeDatos() {
            return new Promise((resolve) => {
                // Simulamos datos para el ejemplo
                // En una implementación real, se cargaría desde el archivo Excel
                
                // Esta es una estructura de datos simplificada
                iaapsData = {
                    centros: [
                        { codigo: 'comunal', nombre: 'CURICO TOTAL COMUNAL' },
                        { codigo: 'curico', nombre: 'CURICO CENTRO' },
                        { codigo: 'miguel', nombre: 'MIGUEL ANGEL ARENAS' },
                        { codigo: 'betty', nombre: 'BETTY MUÑOZ' },
                        { codigo: 'colon', nombre: 'COLON' },
                        { codigo: 'sarmiento', nombre: 'SARMIENTO' },
                        { codigo: 'niches', nombre: 'LOS NICHES' }
                    ],
                    establecimientos: [
                        { codigo: 'prosperidad', nombre: 'PROSPERIDAD', centro: 'miguel' },
                        { codigo: 'tutuquen', nombre: 'PSR TUTUQUEN', centro: 'colon' },
                        { codigo: 'porvenir', nombre: 'PSR PORVENIR', centro: 'betty' },
                        { codigo: 'dona_carmen', nombre: 'DOÑA CARMEN', centro: 'sarmiento' },
                        { codigo: 'potrero', nombre: 'PSR POTRERO GRANDE', centro: 'sarmiento' },
                        { codigo: 'chequenlemu', nombre: 'PSR CHEQUENLEMU', centro: 'sarmiento' },
                        { codigo: 'upeo', nombre: 'PSR UPEO', centro: 'sarmiento' },
                        { codigo: 'cordillerilla', nombre: 'PSR CORDILLERILLA', centro: 'sarmiento' },
                        { codigo: 'obra', nombre: 'PSR LA OBRA', centro: 'niches' }
                    ],
                    indicadores: [
                        {
                            codigo: '1',
                            nombre: 'Porcentaje de centros de salud autoevaluados mediante MAIS',
                            tipo: 'porcentaje',
                            meta: 100,
                            importancia: 4,
                            resultados: [
                                { centro: 'comunal', numerador: 675, denominador: 675, resultado: 100, cumplimiento: 100 },
                                { centro: 'curico', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'betty', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'colon', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'niches', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'tutuquen', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'porvenir', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'dona_carmen', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'potrero', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'chequenlemu', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'upeo', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'cordillerilla', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 },
                                { centro: 'obra', numerador: 45, denominador: 45, resultado: 100, cumplimiento: 100 }
                            ]
                        },
                        {
                            codigo: '2.1',
                            nombre: 'Continuidad de Atención',
                            tipo: 'porcentaje',
                            meta: 100,
                            importancia: 4,
                            resultados: [
                                { centro: 'comunal', numerador: 270, denominador: 270, resultado: 100, cumplimiento: 100 },
                                { centro: 'curico', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'betty', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'colon', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'niches', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'tutuquen', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'porvenir', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'dona_carmen', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'potrero', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'chequenlemu', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'upeo', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'cordillerilla', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 },
                                { centro: 'obra', numerador: 18, denominador: 18, resultado: 100, cumplimiento: 100 }
                            ]
                        },
                        {
                            codigo: '2.2',
                            nombre: 'Disponibilidad de fármacos trazadores',
                            tipo: 'porcentaje',
                            meta: 100,
                            importancia: 4,
                            resultados: [
                                { centro: 'comunal', numerador: 540, denominador: 540, resultado: 100, cumplimiento: 100 },
                                { centro: 'curico', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'betty', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'colon', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'niches', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'tutuquen', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'porvenir', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'dona_carmen', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'potrero', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'chequenlemu', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'upeo', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'cordillerilla', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 },
                                { centro: 'obra', numerador: 36, denominador: 36, resultado: 100, cumplimiento: 100 }
                            ]
                        },
                        {
                            codigo: '3',
                            nombre: 'Tasa de consultas médicas de morbilidad por habitante año',
                            tipo: 'tasa',
                            meta: 0.82,
                            importancia: 6,
                            resultados: [
                                { centro: 'comunal', numerador: 32316, denominador: 150113, resultado: 0.22, cumplimiento: 26.25 },
                                { centro: 'curico', numerador: 6873, denominador: 41532, resultado: 0.17, cumplimiento: 20.18 },
                                { centro: 'miguel', numerador: 6487, denominador: 28763, resultado: 0.23, cumplimiento: 27.50 },
                                { centro: 'betty', numerador: 5722, denominador: 28461, resultado: 0.20, cumplimiento: 24.52 },
                                { centro: 'colon', numerador: 5051, denominador: 23785, resultado: 0.21, cumplimiento: 25.90 },
                                { centro: 'sarmiento', numerador: 4134, denominador: 13722, resultado: 0.30, cumplimiento: 36.74 },
                                { centro: 'niches', numerador: 2518, denominador: 13850, resultado: 0.18, cumplimiento: 22.17 },
                                { centro: 'prosperidad', numerador: 523, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 56, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 123, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 707, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 12, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 40, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 40, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 19, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 11, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '4',
                            nombre: 'Porcentaje de derivación al nivel secundario',
                            tipo: 'porcentaje',
                            meta: 10,
                            importancia: 5,
                            resultados: [
                                { centro: 'comunal', numerador: 3101, denominador: 53969, resultado: 5.75, cumplimiento: 57.46 },
                                { centro: 'curico', numerador: 746, denominador: 11905, resultado: 6.27, cumplimiento: 62.66 },
                                { centro: 'miguel', numerador: 689, denominador: 10609, resultado: 6.49, cumplimiento: 64.94 },
                                { centro: 'betty', numerador: 682, denominador: 9647, resultado: 7.07, cumplimiento: 70.70 },
                                { centro: 'colon', numerador: 374, denominador: 7864, resultado: 4.76, cumplimiento: 47.56 },
                                { centro: 'sarmiento', numerador: 228, denominador: 6029, resultado: 3.78, cumplimiento: 37.82 },
                                { centro: 'niches', numerador: 357, denominador: 4943, resultado: 7.22, cumplimiento: 72.22 },
                                { centro: 'prosperidad', numerador: 0, denominador: 966, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 1, denominador: 162, resultado: 0.62, cumplimiento: 6.17 },
                                { centro: 'porvenir', numerador: 10, denominador: 235, resultado: 4.26, cumplimiento: 42.55 },
                                { centro: 'dona_carmen', numerador: 14, denominador: 1088, resultado: 1.29, cumplimiento: 12.87 },
                                { centro: 'potrero', numerador: 0, denominador: 100, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 117, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 0, denominador: 95, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 101, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 0, denominador: 108, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '5',
                            nombre: 'Tasa de Visita Domiciliaria Integral',
                            tipo: 'tasa',
                            meta: 0.24,
                            importancia: 5,
                            resultados: [
                                { centro: 'comunal', numerador: 2474, denominador: 45489, resultado: 0.05, cumplimiento: 22.66 },
                                { centro: 'curico', numerador: 542, denominador: 12585, resultado: 0.04, cumplimiento: 17.94 },
                                { centro: 'miguel', numerador: 438, denominador: 8716, resultado: 0.05, cumplimiento: 20.94 },
                                { centro: 'betty', numerador: 454, denominador: 8625, resultado: 0.05, cumplimiento: 21.93 },
                                { centro: 'colon', numerador: 375, denominador: 7208, resultado: 0.05, cumplimiento: 21.68 },
                                { centro: 'sarmiento', numerador: 247, denominador: 4158, resultado: 0.06, cumplimiento: 24.75 },
                                { centro: 'niches', numerador: 221, denominador: 4197, resultado: 0.05, cumplimiento: 21.94 },
                                { centro: 'prosperidad', numerador: 68, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 15, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 2, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 61, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 21, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 4, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 8, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 5, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 13, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '6.1.A',
                            nombre: 'Cobertura EMP mujeres (20-64 años)',
                            tipo: 'porcentaje',
                            meta: 23.89,
                            importancia: 3,
                            resultados: [
                                { centro: 'comunal', numerador: 4908, denominador: 49664, resultado: 9.88, cumplimiento: 41.37 },
                                { centro: 'curico', numerador: 1030, denominador: 14597, resultado: 7.06, cumplimiento: 29.54 },
                                { centro: 'miguel', numerador: 1106, denominador: 9172, resultado: 12.06, cumplimiento: 50.47 },
                                { centro: 'betty', numerador: 838, denominador: 9642, resultado: 8.69, cumplimiento: 36.38 },
                                { centro: 'colon', numerador: 689, denominador: 7738, resultado: 8.90, cumplimiento: 37.27 },
                                { centro: 'sarmiento', numerador: 338, denominador: 4352, resultado: 7.77, cumplimiento: 32.51 },
                                { centro: 'niches', numerador: 456, denominador: 4194, resultado: 10.87, cumplimiento: 45.51 },
                                { centro: 'prosperidad', numerador: 128, denominador: -14, resultado: -914.29, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 51, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 40, denominador: -3, resultado: -1333.33, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 153, denominador: -9, resultado: -1700.00, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 11, denominador: -2, resultado: -550.00, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 12, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 15, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 11, denominador: -1, resultado: -1100.00, cumplimiento: 0 },
                                { centro: 'obra', numerador: 30, denominador: -2, resultado: -1500.00, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '6.1.B',
                            nombre: 'Cobertura EMP hombres (20-64 años)',
                            tipo: 'porcentaje',
                            meta: 22.31,
                            importancia: 4,
                            resultados: [
                                { centro: 'comunal', numerador: 2150, denominador: 41825, resultado: 5.14, cumplimiento: 23.04 },
                                { centro: 'curico', numerador: 380, denominador: 10883, resultado: 3.49, cumplimiento: 15.65 },
                                { centro: 'miguel', numerador: 538, denominador: 8935, resultado: 6.02, cumplimiento: 26.99 },
                                { centro: 'betty', numerador: 369, denominador: 7094, resultado: 5.20, cumplimiento: 23.32 },
                                { centro: 'colon', numerador: 254, denominador: 6471, resultado: 3.93, cumplimiento: 17.59 },
                                { centro: 'sarmiento', numerador: 192, denominador: 4193, resultado: 4.58, cumplimiento: 20.52 },
                                { centro: 'niches', numerador: 229, denominador: 4249, resultado: 5.39, cumplimiento: 24.16 },
                                { centro: 'prosperidad', numerador: 44, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 27, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 15, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 56, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 3, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 5, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 11, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 4, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 23, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '6.2',
                            nombre: 'Cobertura EMPAM (65+ años)',
                            tipo: 'porcentaje',
                            meta: 58.48,
                            importancia: 5,
                            resultados: [
                                { centro: 'comunal', numerador: 3334, denominador: 21097, resultado: 15.80, cumplimiento: 27.02 },
                                { centro: 'curico', numerador: 837, denominador: 6609, resultado: 12.66, cumplimiento: 21.66 },
                                { centro: 'miguel', numerador: 512, denominador: 3659, resultado: 13.99, cumplimiento: 23.93 },
                                { centro: 'betty', numerador: 424, denominador: 3772, resultado: 11.24, cumplimiento: 19.22 },
                                { centro: 'colon', numerador: 671, denominador: 3331, resultado: 20.14, cumplimiento: 34.45 },
                                { centro: 'sarmiento', numerador: 259, denominador: 1592, resultado: 16.27, cumplimiento: 27.82 },
                                { centro: 'niches', numerador: 354, denominador: 2134, resultado: 16.59, cumplimiento: 28.37 },
                                { centro: 'prosperidad', numerador: 111, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 14, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 25, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 61, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 12, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 9, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 14, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 11, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 20, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '7',
                            nombre: 'Cobertura evaluación desarrollo psicomotor (12-23 meses)',
                            tipo: 'porcentaje',
                            meta: 95.00,
                            importancia: 5,
                            resultados: [
                                { centro: 'comunal', numerador: 284, denominador: 1190, resultado: 23.87, cumplimiento: 25.12 },
                                { centro: 'curico', numerador: 38, denominador: 267, resultado: 14.23, cumplimiento: 14.98 },
                                { centro: 'miguel', numerador: 62, denominador: 234, resultado: 26.50, cumplimiento: 27.89 },
                                { centro: 'betty', numerador: 61, denominador: 286, resultado: 21.33, cumplimiento: 22.45 },
                                { centro: 'colon', numerador: 41, denominador: 209, resultado: 19.62, cumplimiento: 20.65 },
                                { centro: 'sarmiento', numerador: 23, denominador: 85, resultado: 27.06, cumplimiento: 28.48 },
                                { centro: 'niches', numerador: 38, denominador: 44, resultado: 86.36, cumplimiento: 90.91 },
                                { centro: 'prosperidad', numerador: 6, denominador: 21, resultado: 28.57, cumplimiento: 30.08 },
                                { centro: 'tutuquen', numerador: 0, denominador: 1, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 0, denominador: 6, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 7, denominador: 20, resultado: 35.00, cumplimiento: 36.84 },
                                { centro: 'potrero', numerador: 1, denominador: 9, resultado: 11.11, cumplimiento: 11.70 },
                                { centro: 'chequenlemu', numerador: 2, denominador: 1, resultado: 200.00, cumplimiento: 100 },
                                { centro: 'upeo', numerador: 1, denominador: 2, resultado: 50.00, cumplimiento: 52.63 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 4, denominador: 5, resultado: 80.00, cumplimiento: 84.21 }
                            ]
                        },
                        {
                            codigo: '8',
                            nombre: 'Cobertura control adolescentes (10-19 años)',
                            tipo: 'porcentaje',
                            meta: 24.17,
                            importancia: 6,
                            resultados: [
                                { centro: 'comunal', numerador: 1035, denominador: 20368, resultado: 5.08, cumplimiento: 21.02 },
                                { centro: 'curico', numerador: 236, denominador: 5444, resultado: 4.34, cumplimiento: 17.94 },
                                { centro: 'miguel', numerador: 129, denominador: 3687, resultado: 3.50, cumplimiento: 14.48 },
                                { centro: 'betty', numerador: 165, denominador: 4039, resultado: 4.09, cumplimiento: 16.90 },
                                { centro: 'colon', numerador: 254, denominador: 3281, resultado: 7.74, cumplimiento: 32.03 },
                                { centro: 'sarmiento', numerador: 72, denominador: 2078, resultado: 3.46, cumplimiento: 14.34 },
                                { centro: 'niches', numerador: 88, denominador: 1839, resultado: 4.79, cumplimiento: 19.80 },
                                { centro: 'prosperidad', numerador: 31, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 7, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 12, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 39, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 1, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 1, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '9.1',
                            nombre: 'Cobertura atención salud mental',
                            tipo: 'porcentaje',
                            meta: 27.11,
                            importancia: 5.5,
                            resultados: [
                                { centro: 'comunal', numerador: 10663, denominador: 33025, resultado: 32.29, cumplimiento: 100 },
                                { centro: 'curico', numerador: 2678, denominador: 9137, resultado: 29.31, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 1786, denominador: 6328, resultado: 28.22, cumplimiento: 100 },
                                { centro: 'betty', numerador: 2269, denominador: 6261, resultado: 36.24, cumplimiento: 100 },
                                { centro: 'colon', numerador: 1501, denominador: 5233, resultado: 28.69, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 800, denominador: 3019, resultado: 26.50, cumplimiento: 97.75 },
                                { centro: 'niches', numerador: 979, denominador: 3047, resultado: 32.13, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 138, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 23, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 69, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 217, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 56, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 17, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 20, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 37, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 73, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '9.2',
                            nombre: 'Tasa controles salud mental',
                            tipo: 'tasa',
                            meta: 6.00,
                            importancia: 3.3,
                            resultados: [
                                { centro: 'comunal', numerador: 12868, denominador: 10663, resultado: 1.21, cumplimiento: 20.11 },
                                { centro: 'curico', numerador: 3029, denominador: 2678, resultado: 1.13, cumplimiento: 18.85 },
                                { centro: 'miguel', numerador: 2291, denominador: 1786, resultado: 1.28, cumplimiento: 21.38 },
                                { centro: 'betty', numerador: 2575, denominador: 2269, resultado: 1.13, cumplimiento: 18.91 },
                                { centro: 'colon', numerador: 1936, denominador: 1501, resultado: 1.29, cumplimiento: 21.50 },
                                { centro: 'sarmiento', numerador: 1239, denominador: 800, resultado: 1.55, cumplimiento: 25.81 },
                                { centro: 'niches', numerador: 1086, denominador: 979, resultado: 1.11, cumplimiento: 18.49 },
                                { centro: 'prosperidad', numerador: 157, denominador: 138, resultado: 1.14, cumplimiento: 18.96 },
                                { centro: 'tutuquen', numerador: 30, denominador: 23, resultado: 1.30, cumplimiento: 21.74 },
                                { centro: 'porvenir', numerador: 28, denominador: 69, resultado: 0.41, cumplimiento: 6.76 },
                                { centro: 'dona_carmen', numerador: 301, denominador: 217, resultado: 1.39, cumplimiento: 23.12 },
                                { centro: 'potrero', numerador: 38, denominador: 56, resultado: 0.68, cumplimiento: 11.31 },
                                { centro: 'chequenlemu', numerador: 28, denominador: 17, resultado: 1.65, cumplimiento: 27.45 },
                                { centro: 'upeo', numerador: 37, denominador: 20, resultado: 1.85, cumplimiento: 30.83 },
                                { centro: 'cordillerilla', numerador: 38, denominador: 37, resultado: 1.03, cumplimiento: 17.12 },
                                { centro: 'obra', numerador: 55, denominador: 73, resultado: 0.75, cumplimiento: 12.56 }
                            ]
                        },
                        {
                            codigo: '9.3',
                            nombre: 'Personas egresadas por alta clínica',
                            tipo: 'porcentaje',
                            meta: 13.00,
                            importancia: 2.2,
                            resultados: [
                                { centro: 'comunal', numerador: 82, denominador: 10663, resultado: 0.77, cumplimiento: 5.92 },
                                { centro: 'curico', numerador: 14, denominador: 2678, resultado: 0.52, cumplimiento: 4.02 },
                                { centro: 'miguel', numerador: 24, denominador: 1786, resultado: 1.34, cumplimiento: 10.34 },
                                { centro: 'betty', numerador: 25, denominador: 2269, resultado: 1.10, cumplimiento: 8.48 },
                                { centro: 'colon', numerador: 10, denominador: 1501, resultado: 0.67, cumplimiento: 5.12 },
                                { centro: 'sarmiento', numerador: 8, denominador: 800, resultado: 1.00, cumplimiento: 7.69 },
                                { centro: 'niches', numerador: 0, denominador: 979, resultado: 0, cumplimiento: 0 },
                                { centro: 'prosperidad', numerador: 0, denominador: 138, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 0, denominador: 23, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 1, denominador: 69, resultado: 1.45, cumplimiento: 11.15 },
                                { centro: 'dona_carmen', numerador: 0, denominador: 217, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 0, denominador: 56, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 17, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 0, denominador: 20, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 37, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 0, denominador: 73, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '10',
                            nombre: 'Cumplimiento GES en APS',
                            tipo: 'porcentaje',
                            meta: 100,
                            importancia: 0,
                            resultados: [
                                { centro: 'comunal', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'curico', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'miguel', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'betty', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'colon', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'sarmiento', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'niches', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'prosperidad', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '11',
                            nombre: 'Cobertura vacunación anti-influenza',
                            tipo: 'porcentaje',
                            meta: 85.00,
                            importancia: 5,
                            resultados: [
                                { centro: 'comunal', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'curico', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'miguel', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'betty', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'colon', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'sarmiento', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'niches', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'prosperidad', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '12',
                            nombre: 'Ingreso precoz a control de embarazo',
                            tipo: 'porcentaje',
                            meta: 90.04,
                            importancia: 6,
                            resultados: [
                                { centro: 'comunal', numerador: 284, denominador: 105, resultado: 271.34, cumplimiento: 100 },
                                { centro: 'curico', numerador: 69, denominador: 23, resultado: 295.71, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 47, denominador: 20, resultado: 238.98, cumplimiento: 100 },
                                { centro: 'betty', numerador: 74, denominador: 28, resultado: 264.29, cumplimiento: 100 },
                                { centro: 'colon', numerador: 42, denominador: 15, resultado: 280.00, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 19, denominador: 7, resultado: 271.43, cumplimiento: 100 },
                                { centro: 'niches', numerador: 16, denominador: 5, resultado: 300.00, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 8, denominador: 3, resultado: 240.00, cumplimiento: 100 },
                                { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 7, denominador: 2, resultado: 300.00, cumplimiento: 100 },
                                { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 2, denominador: 1, resultado: 300.00, cumplimiento: 100 }
                            ]
                        },
                        {
                            codigo: '13',
                            nombre: 'Cobertura regulación fertilidad adolescentes',
                            tipo: 'porcentaje',
                            meta: 25.91,
                            importancia: 6,
                            resultados: [
                                { centro: 'comunal', numerador: 7380, denominador: 9956, resultado: 74.13, cumplimiento: 100 },
                                { centro: 'curico', numerador: 2220, denominador: 2773, resultado: 80.06, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 1119, denominador: 1746, resultado: 64.09, cumplimiento: 100 },
                                { centro: 'betty', numerador: 1161, denominador: 1891, resultado: 61.40, cumplimiento: 100 },
                                { centro: 'colon', numerador: 1029, denominador: 1579, resultado: 65.17, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 576, denominador: 1062, resultado: 54.24, cumplimiento: 100 },
                                { centro: 'niches', numerador: 612, denominador: 905, resultado: 67.62, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 252, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 15, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 39, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 273, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 27, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 6, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 15, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 36, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '14',
                            nombre: 'Cobertura DM2 (15+ años)',
                            tipo: 'porcentaje',
                            meta: 71.00,
                            importancia: 6,
                            resultados: [
                                { centro: 'comunal', numerador: 32976, denominador: 16542, resultado: 199.35, cumplimiento: 100 },
                                { centro: 'curico', numerador: 8703, denominador: 4868, resultado: 178.78, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 5913, denominador: 3100, resultado: 190.74, cumplimiento: 100 },
                                { centro: 'betty', numerador: 5403, denominador: 2982, resultado: 181.19, cumplimiento: 100 },
                                { centro: 'colon', numerador: 4746, denominador: 2564, resultado: 185.10, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 2568, denominador: 1419, resultado: 180.97, cumplimiento: 100 },
                                { centro: 'niches', numerador: 2934, denominador: 1608, resultado: 182.46, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 939, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 171, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 189, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 576, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 189, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 69, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 123, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 156, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 297, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '15',
                            nombre: 'Cobertura HTA (15+ años)',
                            tipo: 'porcentaje',
                            meta: 63.50,
                            importancia: 6,
                            resultados: [
                                { centro: 'comunal', numerador: 66216, denominador: 37391, resultado: 177.09, cumplimiento: 100 },
                                { centro: 'curico', numerador: 17430, denominador: 11065, resultado: 157.52, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 11325, denominador: 6986, resultado: 162.11, cumplimiento: 100 },
                                { centro: 'betty', numerador: 11076, denominador: 6717, resultado: 164.90, cumplimiento: 100 },
                                { centro: 'colon', numerador: 9555, denominador: 5780, resultado: 165.31, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 5127, denominador: 3184, resultado: 161.02, cumplimiento: 100 },
                                { centro: 'niches', numerador: 6063, denominador: 3658, resultado: 165.75, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 1734, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 387, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 516, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 1101, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 498, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 231, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 285, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 318, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 570, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '16',
                            nombre: 'Proporción niños sin caries (<3 años)',
                            tipo: 'porcentaje',
                            meta: 64.67,
                            importancia: 5,
                            resultados: [
                                { centro: 'comunal', numerador: 597, denominador: 3780, resultado: 15.79, cumplimiento: 24.42 },
                                { centro: 'curico', numerador: 114, denominador: 829, resultado: 13.75, cumplimiento: 21.26 },
                                { centro: 'miguel', numerador: 83, denominador: 801, resultado: 10.36, cumplimiento: 16.02 },
                                { centro: 'betty', numerador: 136, denominador: 914, resultado: 14.88, cumplimiento: 23.01 },
                                { centro: 'colon', numerador: 99, denominador: 632, resultado: 15.66, cumplimiento: 24.22 },
                                { centro: 'sarmiento', numerador: 68, denominador: 298, resultado: 22.82, cumplimiento: 35.28 },
                                { centro: 'niches', numerador: 56, denominador: 306, resultado: 18.30, cumplimiento: 28.30 },
                                { centro: 'prosperidad', numerador: 13, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 4, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'dona_carmen', numerador: 24, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 },
                                { centro: 'obra', numerador: 0, denominador: 0, resultado: 0, cumplimiento: 0 }
                            ]
                        },
                        {
                            codigo: '17',
                            nombre: 'Prevalencia normalidad menores de 2 años',
                            tipo: 'porcentaje',
                            meta: 61.13,
                            importancia: 4,
                            resultados: [
                                { centro: 'comunal', numerador: 1362, denominador: 2276, resultado: 59.84, cumplimiento: 97.89 },
                                { centro: 'curico', numerador: 324, denominador: 526, resultado: 61.60, cumplimiento: 100 },
                                { centro: 'miguel', numerador: 264, denominador: 441, resultado: 59.86, cumplimiento: 97.93 },
                                { centro: 'betty', numerador: 306, denominador: 531, resultado: 57.63, cumplimiento: 94.27 },
                                { centro: 'colon', numerador: 226, denominador: 362, resultado: 62.43, cumplimiento: 100 },
                                { centro: 'sarmiento', numerador: 90, denominador: 161, resultado: 55.90, cumplimiento: 91.45 },
                                { centro: 'niches', numerador: 81, denominador: 131, resultado: 61.83, cumplimiento: 100 },
                                { centro: 'prosperidad', numerador: 30, denominador: 48, resultado: 62.50, cumplimiento: 100 },
                                { centro: 'tutuquen', numerador: 0, denominador: 2, resultado: 0, cumplimiento: 0 },
                                { centro: 'porvenir', numerador: 5, denominador: 7, resultado: 71.43, cumplimiento: 100 },
                                { centro: 'dona_carmen', numerador: 19, denominador: 40, resultado: 47.50, cumplimiento: 77.70 },
                                { centro: 'potrero', numerador: 8, denominador: 12, resultado: 66.67, cumplimiento: 100 },
                                { centro: 'chequenlemu', numerador: 0, denominador: 1, resultado: 0, cumplimiento: 0 },
                                { centro: 'upeo', numerador: 2, denominador: 2, resultado: 100, cumplimiento: 100 },
                                { centro: 'cordillerilla', numerador: 1, denominador: 2, resultado: 50, cumplimiento: 81.79 },
                                { centro: 'obra', numerador: 6, denominador: 10, resultado: 60, cumplimiento: 98.15 }
                            ]
                        }
                    ]
                };
                
                // Simular un retraso para mostrar el indicador de carga
                setTimeout(() => {
                    resolve(iaapsData);
                }, 1500);
            });
        }
        
        // Función para procesar datos
        function procesarDatos() {
            // Calcular estadísticas y métricas adicionales para el dashboard
            if (!iaapsData) return;
            
            // Normalizar cumplimientos (máximo 100%)
            iaapsData.indicadores.forEach(indicador => {
                indicador.resultados.forEach(resultado => {
                    if (resultado.cumplimiento > 100) {
                        resultado.cumplimiento = 100;
                    }
                });
            });
        }
        
        // Función para actualizar el dashboard
        function actualizarDashboard() {
            if (!iaapsData) return;
            
            // Actualizar tarjetas de resumen
            actualizarTarjetasResumen();
            
            // Actualizar gráfico de centros
            actualizarGraficoCentros();
            
            // Actualizar tabla de indicadores
            actualizarTablaIndicadores();
            
            // Actualizar top indicadores
            actualizarTopIndicadores();
            
            // Actualizar tarjetas de centros
            actualizarTarjetasCentros();
        }
        
        // Función para actualizar las tarjetas de resumen
        function actualizarTarjetasResumen() {
            // Calcular estadísticas generales
            let totalIndicadores = 0;
            let indicadoresCumplidos = 0;
            let indicadoresParciales = 0;
            let indicadoresCriticos = 0;
            let cumplimientoTotal = 0;
            
            // Solo contar indicadores comunales
            iaapsData.indicadores.forEach(indicador => {
                const resultadoComunal = indicador.resultados.find(r => r.centro === 'comunal');
                if (resultadoComunal) {
                    totalIndicadores++;
                    cumplimientoTotal += resultadoComunal.cumplimiento || 0;
                    
                    if (resultadoComunal.cumplimiento >= 95) {
                        indicadoresCumplidos++;
                    } else if (resultadoComunal.cumplimiento >= 80) {
                        indicadoresParciales++;
                    } else {
                        indicadoresCriticos++;
                    }
                }
            });
            
            const cumplimientoPromedio = totalIndicadores > 0 ? (cumplimientoTotal / totalIndicadores).toFixed(2) : 0;
            
            // Actualizar valores en la interfaz
            document.getElementById('indicadorCumplidosValue').textContent = indicadoresCumplidos;
            document.getElementById('indicadorParcialValue').textContent = indicadoresParciales;
            document.getElementById('indicadorCriticosValue').textContent = indicadoresCriticos;
            document.getElementById('cumplimientoComunalValue').textContent = cumplimientoPromedio + '%';
            
            // Actualizar barras de progreso
            document.getElementById('indicadorCumplidosProgress').style.width = (indicadoresCumplidos / totalIndicadores * 100) + '%';
            document.getElementById('indicadorParcialProgress').style.width = (indicadoresParciales / totalIndicadores * 100) + '%';
            document.getElementById('indicadorCriticosProgress').style.width = (indicadoresCriticos / totalIndicadores * 100) + '%';
            document.getElementById('cumplimientoComunalProgress').style.width = cumplimientoPromedio + '%';
        }
        
       // Declaración global (por ejemplo, justo después de tus imports y antes de cualquier función)
let centroChartInstance = null;

// Función para actualizar el gráfico de centros
function actualizarGraficoCentros() {
    const centrosLabels = iaapsData.centros
        .filter(centro => centro.codigo !== 'comunal')
        .map(centro => centro.nombre);
    
    const centrosCumplimiento = [];
    
    iaapsData.centros
        .filter(centro => centro.codigo !== 'comunal')
        .forEach(centro => {
            let cumplimientoTotal = 0;
            let indicadoresContados = 0;
            
            iaapsData.indicadores.forEach(indicador => {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado && resultado.denominador > 0) {
                    cumplimientoTotal += resultado.cumplimiento || 0;
                    indicadoresContados++;
                }
            });
            
            const cumplimientoPromedio = indicadoresContados > 0
                ? parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2))
                : 0;
            
            centrosCumplimiento.push(cumplimientoPromedio);
        });
    
    const ctx = document.getElementById('centroChart').getContext('2d');
    
    // Destruye la instancia anterior (si existe)
    if (centroChartInstance) {
        centroChartInstance.destroy();
    }
    
    // Crea y guarda la nueva instancia
    centroChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: centrosLabels,
            datasets: [{
                label: 'Cumplimiento (%)',
                data: centrosCumplimiento,
                backgroundColor: function(context) {
                    const value = context.dataset.data[context.dataIndex];
                    if (value >= 95) return '#27ae60';
                    else if (value >= 80) return '#f39c12';
                    else return '#e74c3c';
                },
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `Cumplimiento: ${ctx.formattedValue}%`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Cumplimiento (%)' }
                },
                x: {
                    title: { display: true, text: 'Centros de Salud' }
                }
            }
        }
    });
    
    // Finalmente actualiza también la tabla
    actualizarTablaCentros();
}

        
        // Función para actualizar la tabla de centros
        function actualizarTablaCentros() {
            const tableBody = document.getElementById('centroCumplimientoTableBody');
            tableBody.innerHTML = '';
            
            iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                let indicadoresCumplidos = 0;
                let indicadoresParciales = 0;
                let indicadoresCriticos = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (resultado && resultado.denominador > 0) {
                        const cumplimiento = resultado.cumplimiento || 0;
                        cumplimientoTotal += cumplimiento;
                        indicadoresContados++;
                        
                        if (cumplimiento >= 95) {
                            indicadoresCumplidos++;
                        } else if (cumplimiento >= 80) {
                            indicadoresParciales++;
                        } else {
                            indicadoresCriticos++;
                        }
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2)) : 0;
                
                let statusClass = '';
                if (cumplimientoPromedio >= 95) statusClass = 'bg-success';
                else if (cumplimientoPromedio >= 80) statusClass = 'bg-warning';
                else statusClass = 'bg-danger';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${centro.nombre}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${cumplimientoPromedio}%" aria-valuenow="${cumplimientoPromedio}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${cumplimientoPromedio}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${indicadoresCumplidos}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning">${indicadoresParciales}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-danger">${indicadoresCriticos}</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary btn-ver-detalle" data-centro="${centro.codigo}">
                            <i class="fas fa-eye me-1"></i> Ver detalle
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Event listeners para los botones de ver detalle
            document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const centro = this.dataset.centro;
                    mostrarVista('detailView');
                    seleccionarCentro(centro);
                });
            });
        }
        
        // Función para actualizar la tabla de indicadores
        function actualizarTablaIndicadores() {
            const tableBody = document.getElementById('indicadoresTableBody');
            tableBody.innerHTML = '';
            
            // Ordenar indicadores por código
            const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
                const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
                const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
                return codigoA - codigoB;
            });
            
            indicadoresOrdenados.forEach(indicador => {
                const resultadoComunal = indicador.resultados.find(r => r.centro === 'comunal');
                if (!resultadoComunal) return;
                
                let statusClass = '';
                let statusIcon = '';
                
                if (resultadoComunal.cumplimiento >= 95) {
                    statusClass = 'status-success';
                    statusIcon = 'fa-check-circle';
                } else if (resultadoComunal.cumplimiento >= 80) {
                    statusClass = 'status-warning';
                    statusIcon = 'fa-exclamation-triangle';
                } else {
                    statusClass = 'status-danger';
                    statusIcon = 'fa-times-circle';
                }
                
                // Verificar si el valor de resultado debe mostrarse como porcentaje o número
                let resultadoFormateado = '';
                let metaFormateada = '';
                
                if (indicador.tipo === 'porcentaje') {
                    resultadoFormateado = resultadoComunal.resultado.toFixed(2) + '%';
                    metaFormateada = indicador.meta.toFixed(2) + '%';
                } else {
                    resultadoFormateado = resultadoComunal.resultado.toFixed(2);
                    metaFormateada = indicador.meta.toFixed(2);
                }
                
                // Determinar tendencia (simular datos históricos)
                const tendencia = Math.random() > 0.5 ? 'up' : 'down';
                const tendenciaClass = tendencia === 'up' ? 'text-success' : 'text-danger';
                const tendenciaIcon = tendencia === 'up' ? 'fa-arrow-up' : 'fa-arrow-down';
                
                const row = document.createElement('tr');
                row.setAttribute('data-indicador', indicador.codigo);
                row.classList.add('indicador-row');
                row.innerHTML = `
                    <td>
                        <strong>${indicador.codigo}</strong> - ${indicador.nombre}
                    </td>
                    <td class="text-center">${metaFormateada}</td>
                    <td class="text-center">${resultadoFormateado}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass === 'status-success' ? 'bg-success' : statusClass === 'status-warning' ? 'bg-warning' : 'bg-danger'}" role="progressbar" style="width: ${Math.min(resultadoComunal.cumplimiento, 100)}%" aria-valuenow="${resultadoComunal.cumplimiento}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span class="${statusClass}">
                                <i class="fas ${statusIcon} me-1"></i> ${resultadoComunal.cumplimiento.toFixed(2)}%
                            </span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="${tendenciaClass}">
                            <i class="fas ${tendenciaIcon}"></i> ${(Math.random() * 5).toFixed(2)}%
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Event listeners para filas de indicadores
            document.querySelectorAll('.indicador-row').forEach(row => {
                row.addEventListener('click', function() {
                    const indicador = this.dataset.indicador;
                    mostrarVista('detailView');
                    
                    // Activar la pestaña de indicadores
                    document.getElementById('indicador-tab').click();
                    
                    seleccionarIndicador(indicador);
                });
            });
        }
        
      // Variables globales para almacenar las instancias de Chart.js
let topIndicadoresChartInstance = null;
let bottomIndicadoresChartInstance = null;

/**
 * Función para actualizar los top/bottom 5 indicadores comunales
 */
function actualizarTopIndicadores() {
    // 1) Recopilar cumplimiento comunal de cada indicador
    const indicadoresComunales = iaapsData.indicadores
        .map(ind => {
            const res = ind.resultados.find(r => r.centro === 'comunal');
            return res && res.denominador > 0
                ? { codigo: ind.codigo, nombre: ind.nombre, cumplimiento: res.cumplimiento || 0 }
                : null;
        })
        .filter(x => x !== null);

    // 2) Ordenar de mayor a menor cumplimiento
    const ordenadosDesc = [...indicadoresComunales].sort((a, b) => b.cumplimiento - a.cumplimiento);

    // 3) Top 5 y bottom 5
    const top5    = ordenadosDesc.slice(0, 5);
    const bottom5 = [...ordenadosDesc].reverse().slice(0, 5);

    // 4) Renderizar los dos gráficos
    actualizarGraficoTop(top5,    'topIndicadoresChart',    true);
    actualizarGraficoTop(bottom5, 'bottomIndicadoresChart', false);
}

/**
 * Función para (re)dibujar uno de los gráficos horizontales de top/bottom indicadores
 *
 * @param {Array}  indicadores Array de objetos { codigo, nombre, cumplimiento }
 * @param {string} canvasId     ID del <canvas> en el DOM
 * @param {boolean} isTop       true si es el gráfico de top, false si es bottom
 */
function actualizarGraficoTop(indicadores, canvasId, isTop) {
    // Extraer etiquetas y datos
    const labels = indicadores.map(i => i.codigo);
    const data   = indicadores.map(i => i.cumplimiento);

    // Colores según rangos
    const backgroundColors = data.map(v =>
        v >= 95 ? '#27ae60'
      : v >= 80 ? '#f39c12'
      :            '#e74c3c'
    );

    // Obtener contexto
    const ctx = document.getElementById(canvasId).getContext('2d');

    // Destruir instancia previa si existía
    if (isTop && topIndicadoresChartInstance) {
        topIndicadoresChartInstance.destroy();
    }
    if (!isTop && bottomIndicadoresChartInstance) {
        bottomIndicadoresChartInstance.destroy();
    }

    // Configuración del nuevo gráfico
    const cfg = {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Cumplimiento (%)',
                data,
                backgroundColor: backgroundColors,
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: ctxItems => {
                            const idx = ctxItems[0].dataIndex;
                            const ind = indicadores[idx];
                            return `${ind.codigo} – ${ind.nombre}`;
                        },
                        label: ctxItem => `Cumplimiento: ${ctxItem.formattedValue}%`
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Cumplimiento (%)' }
                },
                y: {
                    title: { display: true, text: 'Indicador' }
                }
            }
        }
    };

    // Crear la instancia y guardarla
    const newChart = new Chart(ctx, cfg);
    if (isTop) {
        topIndicadoresChartInstance = newChart;
    } else {
        bottomIndicadoresChartInstance = newChart;
    }
}


// Variables globales para las instancias de Chart.js en la vista detalle de centro
let centroCumplimientoChartInstance = null;
let centroIndicadoresChartInstance = null;

/**
 * Actualiza los gráficos de detalle para el centro seleccionado.
 */
function actualizarGraficosDetalleCentro() {
  // 1) Recolectar datos para el gráfico de donut (estado de indicadores)
  const datosCumplimiento = [0, 0, 0]; // [Cumplidos, Parciales, Críticos]
  iaapsData.indicadores.forEach(indicador => {
    const res = indicador.resultados.find(r => r.centro === currentCentro);
    if (res && res.denominador > 0) {
      if (res.cumplimiento >= 95) datosCumplimiento[0]++;
      else if (res.cumplimiento >= 80) datosCumplimiento[1]++;
      else datosCumplimiento[2]++;
    }
  });

  // 2) Destruir instancia previa si existe
  if (centroCumplimientoChartInstance) {
    centroCumplimientoChartInstance.destroy();
  }

  // 3) Crear gráfico de tipo "doughnut"
  const ctxCumplimiento = document
    .getElementById('centroCumplimientoChart')
    .getContext('2d');
  centroCumplimientoChartInstance = new Chart(ctxCumplimiento, {
    type: 'doughnut',
    data: {
      labels: ['Cumplidos', 'Parciales', 'Críticos'],
      datasets: [{
        data: datosCumplimiento,
        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
        borderColor: ['#27ae60', '#f39c12', '#e74c3c'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        title: { display: true, text: 'Estado de Indicadores' }
      }
    }
  });

  // 4) Preparar datos para el gráfico de barras por categoría
  const categoriasAcum = { Cobertura: [], Tasa: [], Porcentaje: [], Otro: [] };
  iaapsData.indicadores.forEach(ind => {
    const res = ind.resultados.find(r => r.centro === currentCentro);
    if (res && res.denominador > 0) {
      // Clasificar por nombre o tipo
      if (/cobertura/i.test(ind.nombre))       categoriasAcum.Cobertura.push(res.cumplimiento);
      else if (ind.tipo === 'tasa')            categoriasAcum.Tasa.push(res.cumplimiento);
      else if (ind.tipo === 'porcentaje')      categoriasAcum.Porcentaje.push(res.cumplimiento);
      else                                     categoriasAcum.Otro.push(res.cumplimiento);
    }
  });

  const categorias = [], promedios = [];
  for (const [cat, vals] of Object.entries(categoriasAcum)) {
    if (vals.length) {
      categorias.push(cat);
      const suma = vals.reduce((a, b) => a + b, 0);
      promedios.push(parseFloat((suma / vals.length).toFixed(2)));
    }
  }

  // 5) Destruir instancia previa si existe
  if (centroIndicadoresChartInstance) {
    centroIndicadoresChartInstance.destroy();
  }

  // 6) Crear gráfico de barras
  const ctxCategoria = document
    .getElementById('centroIndicadoresChart')
    .getContext('2d');
  centroIndicadoresChartInstance = new Chart(ctxCategoria, {
    type: 'bar',
    data: {
      labels: categorias,
      datasets: [{
        label: 'Cumplimiento promedio (%)',
        data: promedios,
        backgroundColor: function(ctx) {
          const v = ctx.dataset.data[ctx.dataIndex];
          return v >= 95 ? '#27ae60' : v >= 80 ? '#f39c12' : '#e74c3c';
        },
        borderColor: 'rgba(0, 0, 0, 0.1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Cumplimiento por Categoría' }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Cumplimiento (%)' }
        }
      }
    }
  });
}

        
        // Función para actualizar las tarjetas de centros
        function actualizarTarjetasCentros() {
            iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (resultado && resultado.denominador > 0) {
                        cumplimientoTotal += resultado.cumplimiento || 0;
                        indicadoresContados++;
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    (cumplimientoTotal / indicadoresContados).toFixed(2) : 0;
                
                // Determinar clase de color
                let colorClass = '';
                if (cumplimientoPromedio >= 95) colorClass = 'bg-success';
                else if (cumplimientoPromedio >= 80) colorClass = 'bg-warning';
                else colorClass = 'bg-danger';
                
                // Actualizar tarjeta
                switch (centro.codigo) {
                    case 'curico':
                        document.getElementById('centroCuricoValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroCuricoProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroCuricoProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'miguel':
                        document.getElementById('centroMiguelValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroMiguelProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroMiguelProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'betty':
                        document.getElementById('centroBettyValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroBettyProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroBettyProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'colon':
                        document.getElementById('centroColonValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroColonProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroColonProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'sarmiento':
                        document.getElementById('centroSarmientoValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroSarmientoProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroSarmientoProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'niches':
                        document.getElementById('centroNichesValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroNichesProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroNichesProgress').className = `progress-bar ${colorClass}`;
                        break;
                }
            });
        }
        
        // Función para actualizar la vista de detalle
        function actualizarDetalle() {
            if (!iaapsData) return;
            
            // Actualizar detalle de centro seleccionado
            actualizarDetalleCentro();
            
            // Actualizar detalle de indicador seleccionado
            actualizarDetalleIndicador();
            
            // Actualizar vista comparativa
            actualizarVistaComparativa();
        }
        
        // Función para actualizar el detalle del centro
        function actualizarDetalleCentro() {
            if (currentCentro === 'comunal') {
                document.getElementById('establecimientosCard').style.display = 'none';
                document.getElementById('centroCumplimientoTitle').textContent = 'Cumplimiento IAAPS Comunal';
            } else {
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (centro) {
                    document.getElementById('centroCumplimientoTitle').textContent = `Cumplimiento IAAPS - ${centro.nombre}`;
                    
                    // Verificar si tiene establecimientos
                    const tieneEstablecimientos = establecimientosMap[currentCentro] && establecimientosMap[currentCentro].length > 0;
                    document.getElementById('establecimientosCard').style.display = tieneEstablecimientos ? 'block' : 'none';
                    
                    if (tieneEstablecimientos) {
                        actualizarTablaEstablecimientos();
                    }
                }
            }
            
            // Actualizar gráficos y tabla de indicadores del centro
            actualizarGraficosDetalleCentro();
            actualizarTablaIndicadoresCentro();
        }
        
        // Función para actualizar los gráficos de detalle del centro
        function actualizarGraficosDetalleCentro() {
            // Gráfico de cumplimiento
            const datosCumplimiento = [];
            let cumplimientoTotal = 0;
            let indicadoresCumplidos = 0;
            let indicadoresParciales = 0;
            let indicadoresCriticos = 0;
            let indicadoresContados = 0;
            
            iaapsData.indicadores.forEach(indicador => {
                const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                if (resultado && resultado.denominador > 0) {
                    cumplimientoTotal += resultado.cumplimiento || 0;
                    indicadoresContados++;
                    
                    if (resultado.cumplimiento >= 95) {
                        indicadoresCumplidos++;
                    } else if (resultado.cumplimiento >= 80) {
                        indicadoresParciales++;
                    } else {
                        indicadoresCriticos++;
                    }
                }
            });
            
            datosCumplimiento.push(indicadoresCumplidos, indicadoresParciales, indicadoresCriticos);
            
            // Destruir gráficos anteriores si existen
            if (window.centroCumplimientoChart) {
                window.centroCumplimientoChart.destroy();
            }
            
            if (window.centroIndicadoresChart) {
                window.centroIndicadoresChart.destroy();
            }
            
            // Actualizar gráfico de cumplimiento
            const ctxCumplimiento = document.getElementById('centroCumplimientoChart').getContext('2d');
            window.centroCumplimientoChart = new Chart(ctxCumplimiento, {
                type: 'doughnut',
                data: {
                    labels: ['Cumplidos', 'Parciales', 'Críticos'],
                    datasets: [{
                        data: datosCumplimiento,
                        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                        borderColor: ['#27ae60', '#f39c12', '#e74c3c'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Estado de Indicadores'
                        }
                    }
                }
            });
            
            // Preparar datos para gráfico por categoría
            const categoriasIndicadores = {
                'Cobertura': [],
                'Tasa': [],
                'Porcentaje': [],
                'Otro': []
            };
            
            iaapsData.indicadores.forEach(indicador => {
                const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                if (resultado && resultado.denominador > 0) {
                    if (indicador.nombre.toLowerCase().includes('cobertura')) {
                        categoriasIndicadores['Cobertura'].push(resultado.cumplimiento || 0);
                    } else if (indicador.tipo === 'tasa') {
                        categoriasIndicadores['Tasa'].push(resultado.cumplimiento || 0);
                    } else if (indicador.tipo === 'porcentaje') {
                        categoriasIndicadores['Porcentaje'].push(resultado.cumplimiento || 0);
                    } else {
                        categoriasIndicadores['Otro'].push(resultado.cumplimiento || 0);
                    }
                }
            });
            
            // Calcular promedios por categoría
            const categorias = [];
            const promedios = [];
            
            for (const categoria in categoriasIndicadores) {
                const valores = categoriasIndicadores[categoria];
                if (valores.length > 0) {
                    categorias.push(categoria);
                    const promedio = valores.reduce((a, b) => a + b, 0) / valores.length;
                    promedios.push(promedio);
                }
            }
            
            // Actualizar gráfico por categoría
            const ctxCategoria = document.getElementById('centroIndicadoresChart').getContext('2d');
            window.centroIndicadoresChart = new Chart(ctxCategoria, {
                type: 'bar',
                data: {
                    labels: categorias,
                    datasets: [{
                        label: 'Cumplimiento promedio (%)',
                        data: promedios,
                        backgroundColor: function(context) {
                            const value = context.dataset.data[context.dataIndex];
                            if (value >= 95) return '#27ae60';
                            else if (value >= 80) return '#f39c12';
                            else return '#e74c3c';
                        },
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Cumplimiento por Categoría'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Cumplimiento (%)'
                            }
                        }
                    }
                }
            });
        }
        
        // Función para actualizar la tabla de indicadores del centro
        function actualizarTablaIndicadoresCentro() {
            const tableBody = document.getElementById('centroIndicadoresTableBody');
            tableBody.innerHTML = '';
            
            // Ordenar indicadores por código
            const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
                const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
                const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
                return codigoA - codigoB;
            });
            
            indicadoresOrdenados.forEach(indicador => {
                const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                if (!resultado) return;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                
                if (resultado.cumplimiento >= 95) {
                    statusClass = 'bg-success';
                    statusIcon = 'fa-check-circle';
                    statusText = 'Cumplido';
                } else if (resultado.cumplimiento >= 80) {
                    statusClass = 'bg-warning';
                    statusIcon = 'fa-exclamation-triangle';
                    statusText = 'Parcial';
                } else {
                    statusClass = 'bg-danger';
                    statusIcon = 'fa-times-circle';
                    statusText = 'Crítico';
                }
                
                // Verificar si el valor de resultado debe mostrarse como porcentaje o número
                let resultadoFormateado = '';
                let metaFormateada = '';
                
                if (indicador.tipo === 'porcentaje') {
                    resultadoFormateado = resultado.resultado.toFixed(2) + '%';
                    metaFormateada = indicador.meta.toFixed(2) + '%';
                } else {
                    resultadoFormateado = resultado.resultado.toFixed(2);
                    metaFormateada = indicador.meta.toFixed(2);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${indicador.codigo}</strong> - ${indicador.nombre}
                    </td>
                    <td class="text-center">${resultado.numerador}</td>
                    <td class="text-center">${resultado.denominador}</td>
                    <td class="text-center">${resultadoFormateado}</td>
                    <td class="text-center">${metaFormateada}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${Math.min(resultado.cumplimiento, 100)}%" aria-valuenow="${resultado.cumplimiento}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${resultado.cumplimiento.toFixed(2)}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge ${statusClass}">
                            <i class="fas ${statusIcon} me-1"></i> ${statusText}
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Función para actualizar la tabla de establecimientos
        function actualizarTablaEstablecimientos() {
            const tableBody = document.getElementById('establecimientosTableBody');
            tableBody.innerHTML = '';
            
            // Obtener los establecimientos del centro actual
            const establecimientos = establecimientosMap[currentCentro] || [];
            
            establecimientos.forEach(establecimientoNombre => {
                const establecimientoCodigo = iaapsData.establecimientos
                    .find(e => e.nombre === establecimientoNombre)?.codigo;
                
                if (!establecimientoCodigo) return;
                
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                let indicadoresCumplidos = 0;
                let indicadoresParciales = 0;
                let indicadoresCriticos = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === establecimientoCodigo);
                    if (resultado && resultado.denominador > 0) {
                        cumplimientoTotal += resultado.cumplimiento || 0;
                        indicadoresContados++;
                        
                        if (resultado.cumplimiento >= 95) {
                            indicadoresCumplidos++;
                        } else if (resultado.cumplimiento >= 80) {
                            indicadoresParciales++;
                        } else {
                            indicadoresCriticos++;
                        }
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2)) : 0;
                
                let statusClass = '';
                if (cumplimientoPromedio >= 95) statusClass = 'bg-success';
                else if (cumplimientoPromedio >= 80) statusClass = 'bg-warning';
                else statusClass = 'bg-danger';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${establecimientoNombre}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${cumplimientoPromedio}%" aria-valuenow="${cumplimientoPromedio}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${cumplimientoPromedio}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${indicadoresCumplidos}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning">${indicadoresParciales}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-danger">${indicadoresCriticos}</span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Función para actualizar el detalle del indicador
        function actualizarDetalleIndicador() {
            const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
            if (!indicador) return;
            
            // Actualizar título y detalles
            document.getElementById('indicadorDetailTitle').textContent = `Indicador ${indicador.codigo}: ${indicador.nombre}`;
            document.getElementById('indicadorNombreCompleto').textContent = indicador.nombre;
            document.getElementById('indicadorMetaValor').textContent = indicador.meta.toFixed(2) + (indicador.tipo === 'porcentaje' ? '%' : '');
            document.getElementById('indicadorImportanciaValor').textContent = importanciaIndicadores[indicador.codigo];
            document.getElementById('indicadorNumeradorFormula').textContent = formulasIndicadores[indicador.codigo].numerador;
            document.getElementById('indicadorDenominadorFormula').textContent = formulasIndicadores[indicador.codigo].denominador;
            
            // Actualizar gráficos
            actualizarGraficosDetalleIndicador(indicador);
            
            // Actualizar tabla
            actualizarTablaDetalleIndicador(indicador);
        }
        
        // Función para actualizar los gráficos de detalle del indicador
        function actualizarGraficosDetalleIndicador(indicador) {
            // Preparar datos para gráfico por centro
            const centrosLabels = [];
            const centrosCumplimiento = [];
            
            iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado && resultado.denominador > 0) {
                    centrosLabels.push(centro.nombre);
                    centrosCumplimiento.push(resultado.cumplimiento || 0);
                }
            });
            
            // Destruir gráficos anteriores si existen
            if (window.indicadorCentrosChart) {
                window.indicadorCentrosChart.destroy();
            }
            
            if (window.indicadorTendenciaChart) {
                window.indicadorTendenciaChart.destroy();
            }
            
            // Actualizar gráfico por centro
            const ctxCentros = document.getElementById('indicadorCentrosChart').getContext('2d');
            window.indicadorCentrosChart = new Chart(ctxCentros, {
                type: 'bar',
                data: {
                    labels: centrosLabels,
                    datasets: [{
                        label: 'Cumplimiento (%)',
                        data: centrosCumplimiento,
                        backgroundColor: function(context) {
                            const value = context.dataset.data[context.dataIndex];
                            if (value >= 95) return '#27ae60';
                            else if (value >= 80) return '#f39c12';
                            else return '#e74c3c';
                        },
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Cumplimiento por Centro'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Cumplimiento (%)'
                            }
                        }
                    }
                }
            });
            
            // Simular datos de tendencia
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'];
            const datosTendencia = [];
            
            // Generar valores que aumenten o disminuyan gradualmente
            const valorInicial = Math.random() * 50 + 30; // Entre 30 y 80
            let valorActual = valorInicial;
            
            for (let i = 0; i < meses.length; i++) {
                // Variación aleatoria entre -5 y +5
                const variacion = (Math.random() * 10) - 5;
                valorActual = Math.max(0, Math.min(100, valorActual + variacion));
                datosTendencia.push(valorActual);
            }
            
            // Destacar valores por encima y por debajo de la meta
            const backgroundColors = datosTendencia.map(valor => 
                valor >= indicador.meta ? '#27ae60' : '#e74c3c'
            );
            
            // Actualizar gráfico de tendencia
            const ctxTendencia = document.getElementById('indicadorTendenciaChart').getContext('2d');
            window.indicadorTendenciaChart = new Chart(ctxTendencia, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: 'Resultado',
                            data: datosTendencia,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Meta',
                            data: Array(meses.length).fill(indicador.meta),
                            borderColor: '#e74c3c',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tendencia Mensual'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: indicador.tipo === 'porcentaje' ? 'Resultado (%)' : 'Resultado'
                            }
                        }
                    }
                }
            });
        }
        
        // Función para actualizar la tabla de detalle del indicador
        function actualizarTablaDetalleIndicador(indicador) {
            const tableBody = document.getElementById('indicadorCentrosTableBody');
            tableBody.innerHTML = '';
            
            // Agregar fila comunal
            const resultadoComunal = indicador.resultados.find(r => r.centro === 'comunal');
            if (resultadoComunal) {
                agregarFilaIndicador(tableBody, indicador, resultadoComunal, 'CURICÓ (COMUNAL)');
            }
            
            // Agregar filas por centro
            iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado) {
                    agregarFilaIndicador(tableBody, indicador, resultado, centro.nombre);
                }
            });
        }
        
        // Función auxiliar para agregar una fila a la tabla de indicadores
        function agregarFilaIndicador(tableBody, indicador, resultado, nombreCentro) {
            let statusClass = '';
            let statusIcon = '';
            let statusText = '';
            
            if (resultado.cumplimiento >= 95) {
                statusClass = 'bg-success';
                statusIcon = 'fa-check-circle';
                statusText = 'Cumplido';
            } else if (resultado.cumplimiento >= 80) {
                statusClass = 'bg-warning';
                statusIcon = 'fa-exclamation-triangle';
                statusText = 'Parcial';
            } else {
                statusClass = 'bg-danger';
                statusIcon = 'fa-times-circle';
                statusText = 'Crítico';
            }
            
            // Verificar si el valor de resultado debe mostrarse como porcentaje o número
            let resultadoFormateado = '';
            let metaFormateada = '';
            
            if (indicador.tipo === 'porcentaje') {
                resultadoFormateado = resultado.resultado.toFixed(2) + '%';
                metaFormateada = indicador.meta.toFixed(2) + '%';
            } else {
                resultadoFormateado = resultado.resultado.toFixed(2);
                metaFormateada = indicador.meta.toFixed(2);
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${nombreCentro}</td>
                <td class="text-center">${resultado.numerador}</td>
                <td class="text-center">${resultado.denominador}</td>
                <td class="text-center">${resultadoFormateado}</td>
                <td class="text-center">${metaFormateada}</td>
                <td class="text-center">
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                            <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${Math.min(resultado.cumplimiento, 100)}%" aria-valuenow="${resultado.cumplimiento}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span>${resultado.cumplimiento.toFixed(2)}%</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge ${statusClass}">
                        <i class="fas ${statusIcon} me-1"></i> ${statusText}
                    </span>
                </td>
            `;
            
            tableBody.appendChild(row);
        }
        
        // Función para actualizar la vista comparativa
        function actualizarVistaComparativa() {
            // Actualizar gráfico comparativo
            actualizarGraficoComparativo();
            
            // Actualizar tabla comparativa
            actualizarTablaComparativa();
        }
        
        // Función para actualizar el gráfico comparativo
        function actualizarGraficoComparativo() {
            // Preparar datos para el gráfico
            const centros = iaapsData.centros;
            const datasets = [];
            
            // Obtener categorías de indicadores
            const categorias = {
                'Cobertura': [],
                'Tasa': [],
                'Porcentaje': [],
                'Otro': []
            };
            
            iaapsData.indicadores.forEach(indicador => {
                if (indicador.nombre.toLowerCase().includes('cobertura')) {
                    categorias['Cobertura'].push(indicador.codigo);
                } else if (indicador.tipo === 'tasa') {
                    categorias['Tasa'].push(indicador.codigo);
                } else if (indicador.tipo === 'porcentaje') {
                    categorias['Porcentaje'].push(indicador.codigo);
                } else {
                    categorias['Otro'].push(indicador.codigo);
                }
            });
            
            // Crear un dataset por categoría
            const colores = ['#3498db', '#27ae60', '#e74c3c', '#f39c12'];
            let colorIndex = 0;
            
            for (const categoria in categorias) {
                if (categorias[categoria].length === 0) continue;
                
                const codigos = categorias[categoria];
                const datosCentros = [];
                
                // Para cada centro, calcular el promedio de cumplimiento de esta categoría
                centros.forEach(centro => {
                    let total = 0;
                    let count = 0;
                    
                    codigos.forEach(codigo => {
                        const indicador = iaapsData.indicadores.find(i => i.codigo === codigo);
                        if (indicador) {
                            const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                            if (resultado && resultado.denominador > 0) {
                                total += resultado.cumplimiento || 0;
                                count++;
                            }
                        }
                    });
                    
                    const promedio = count > 0 ? parseFloat((total / count).toFixed(2)) : 0;
                    datosCentros.push(promedio);
                });
                
                datasets.push({
                    label: categoria,
                    data: datosCentros,
                    backgroundColor: colores[colorIndex],
                    borderColor: colores[colorIndex],
                    borderWidth: 1
                });
                
                colorIndex = (colorIndex + 1) % colores.length;
            }
            
            // Destruir gráfico anterior si existe
            if (window.comparativoChart) {
                window.comparativoChart.destroy();
            }
            
            // Crear gráfico
            const ctx = document.getElementById('comparativoChart').getContext('2d');
            window.comparativoChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: centros.map(c => c.nombre),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });
        }
        
     /* IAAPS DASHBOARD - PARTE 2: FUNCIONALIDADES AVANZADAS */

/*
 * Este archivo complementa la parte 1 del dashboard IAAPS, añadiendo:
 * - Finalización de funciones principales
 * - Reconocimiento de voz para navegación
 * - Opciones avanzadas de exportación
 * - Integración de data warehouse
 * - Funcionalidades premium
 */

// Continuación de actualizarTablaComparativa()
function actualizarTablaComparativa() {
    const tableBody = document.getElementById('comparativoTableBody');
    tableBody.innerHTML = '';
    
    // Ordenar indicadores por código
    const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
        const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
        const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
        return codigoA - codigoB;
    });
    
    indicadoresOrdenados.forEach(indicador => {
        const row = document.createElement('tr');
        
        // Primera columna: nombre del indicador
        const tdIndicador = document.createElement('td');
        tdIndicador.innerHTML = `<strong>${indicador.codigo}</strong> - ${indicador.nombre}`;
        row.appendChild(tdIndicador);
        
        // Segunda columna: meta
        const tdMeta = document.createElement('td');
        tdMeta.className = 'text-center';
        tdMeta.textContent = indicador.tipo === 'porcentaje' ? 
            indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2);
        row.appendChild(tdMeta);
        
        // Columna para cada centro
        iaapsData.centros.forEach(centro => {
            if (centro.codigo === 'comunal') {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado) {
                    const tdCentro = document.createElement('td');
                    tdCentro.className = 'text-center table-percentage-cell';
                    
                    // Calcular color según porcentaje de cumplimiento
                    let color = '';
                    let textColor = '';
                    
                    if (resultado.cumplimiento >= 95) {
                        color = '#27ae60';
                        textColor = '#fff';
                    } else if (resultado.cumplimiento >= 80) {
                        color = '#f39c12';
                        textColor = '#fff';
                    } else {
                        color = '#e74c3c';
                        textColor = '#fff';
                    }
                    
                    // Limitar cumplimiento máximo a 100% para la visualización
                    const cumplimientoMostrado = Math.min(resultado.cumplimiento, 100);
                    
                    // Crear visualización de porcentaje con barra de fondo
                    tdCentro.innerHTML = `
                        <div class="table-percentage-bg" style="background-color: ${color}; width: ${cumplimientoMostrado}%;"></div>
                        <span class="table-percentage-text">${resultado.cumplimiento.toFixed(2)}%</span>
                    `;
                    
                    row.appendChild(tdCentro);
                }
            } else {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado) {
                    const tdCentro = document.createElement('td');
                    tdCentro.className = 'text-center table-percentage-cell';
                    
                    // Calcular color según porcentaje de cumplimiento
                    let color = '';
                    let textColor = '';
                    
                    if (resultado.cumplimiento >= 95) {
                        color = '#27ae60';
                        textColor = '#fff';
                    } else if (resultado.cumplimiento >= 80) {
                        color = '#f39c12';
                        textColor = '#fff';
                    } else {
                        color = '#e74c3c';
                        textColor = '#fff';
                    }
                    
                    // Limitar cumplimiento máximo a 100% para la visualización
                    const cumplimientoMostrado = Math.min(resultado.cumplimiento, 100);
                    
                    // Crear visualización de porcentaje con barra de fondo
                    tdCentro.innerHTML = `
                        <div class="table-percentage-bg" style="background-color: ${color}; width: ${cumplimientoMostrado}%;"></div>
                        <span class="table-percentage-text">${resultado.cumplimiento.toFixed(2)}%</span>
                    `;
                    
                    row.appendChild(tdCentro);
                } else {
                    const tdCentro = document.createElement('td');
                    tdCentro.className = 'text-center';
                    tdCentro.textContent = '-';
                    row.appendChild(tdCentro);
                }
            }
        });
        
        tableBody.appendChild(row);
    });
}

// Función para buscar indicadores
function buscarIndicadores(searchTerm) {
    if (!searchTerm) {
        // Si no hay término de búsqueda, mostrar todos los indicadores
        document.querySelectorAll('.indicador-row').forEach(row => {
            row.style.display = '';
        });
        return;
    }
    
    document.querySelectorAll('.indicador-row').forEach(row => {
        const indicadorCodigo = row.dataset.indicador;
        const indicador = iaapsData.indicadores.find(i => i.codigo === indicadorCodigo);
        
        if (indicador) {
            const textoIndicador = (indicador.codigo + ' ' + indicador.nombre).toLowerCase();
            
            if (textoIndicador.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}

// Función para seleccionar un centro
function seleccionarCentro(codigo) {
    currentCentro = codigo;
    
    // Actualizar título del breadcrumb
    if (codigo === 'comunal') {
        document.getElementById('detailBreadcrumb').textContent = 'Detalle Comunal';
    } else {
        const centro = iaapsData.centros.find(c => c.codigo === codigo);
        if (centro) {
            document.getElementById('detailBreadcrumb').textContent = 'Detalle ' + centro.nombre;
        }
    }
    
    // Actualizar vista de detalle
    actualizarDetalleCentro();
}

// Función para seleccionar un indicador
function seleccionarIndicador(codigo) {
    currentIndicador = codigo;
    
    // Actualizar título del breadcrumb
    const indicador = iaapsData.indicadores.find(i => i.codigo === codigo);
    if (indicador) {
        document.getElementById('detailBreadcrumb').textContent = 'Indicador ' + indicador.codigo;
    }
    
    // Actualizar vista de detalle
    actualizarDetalleIndicador();
}

// Función para mostrar una vista
function mostrarVista(vista) {
    const vistas = ['dashboardView', 'detailView'];
    
    vistas.forEach(v => {
        document.getElementById(v).style.display = v === vista ? 'block' : 'none';
    });
    
    // Actualizar clase active en la navegación
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    if (vista === 'dashboardView') {
        document.getElementById('dashboardLink').classList.add('active');
    } else if (vista === 'detailView') {
        document.getElementById('detailLink').classList.add('active');
    }
}

// Función para mostrar/ocultar indicador de carga
function mostrarCargando(mostrar) {
    document.getElementById('loadingOverlay').style.display = mostrar ? 'flex' : 'none';
}

// Función para mostrar notificación
function mostrarNotificacion(mensaje, tipo) {
    // Crear elemento de notificación
    const notificacion = document.createElement('div');
    notificacion.className = `toast align-items-center text-white bg-${tipo} border-0`;
    notificacion.setAttribute('role', 'alert');
    notificacion.setAttribute('aria-live', 'assertive');
    notificacion.setAttribute('aria-atomic', 'true');
    
    notificacion.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${mensaje}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Agregar al contenedor de notificaciones
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.appendChild(notificacion);
    document.body.appendChild(container);
    
    // Mostrar notificación
    const toast = new bootstrap.Toast(notificacion, { delay: 3000 });
    toast.show();
    
    // Eliminar del DOM después de ocultarse
    notificacion.addEventListener('hidden.bs.toast', function() {
        container.remove();
    });
}

// Función para exportar a Excel
function exportarExcel(tipo) {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            let data = [];
            let nombreArchivo = '';
            
            if (tipo === 'centro') {
                // Exportar datos del centro seleccionado
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (!centro) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_${centro.nombre}_Marzo_2025.xlsx`;
                
                // Encabezados
                data.push(['Indicador', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']);
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                    if (!resultado) return;
                    
                    let estado = '';
                    if (resultado.cumplimiento >= 95) estado = 'Cumplido';
                    else if (resultado.cumplimiento >= 80) estado = 'Parcial';
                    else estado = 'Crítico';
                    
                    data.push([
                        `${indicador.codigo} - ${indicador.nombre}`,
                        resultado.numerador,
                        resultado.denominador,
                        indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        resultado.cumplimiento.toFixed(2) + '%',
                        estado
                    ]);
                });
            } else if (tipo === 'indicador') {
                // Exportar datos del indicador seleccionado
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                if (!indicador) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_Indicador_${indicador.codigo}_Marzo_2025.xlsx`;
                
                // Encabezados
                data.push(['Centro', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']);
                
                // Datos
                iaapsData.centros.forEach(centro => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (!resultado) return;
                    
                    let estado = '';
                    if (resultado.cumplimiento >= 95) estado = 'Cumplido';
                    else if (resultado.cumplimiento >= 80) estado = 'Parcial';
                    else estado = 'Crítico';
                    
                    data.push([
                        centro.nombre,
                        resultado.numerador,
                        resultado.denominador,
                        indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        resultado.cumplimiento.toFixed(2) + '%',
                        estado
                    ]);
                });
            } else if (tipo === 'comparativo') {
                // Exportar tabla comparativa
                nombreArchivo = `IAAPS_Comparativo_Marzo_2025.xlsx`;
                
                // Encabezados
                const headers = ['Indicador', 'Meta'];
                iaapsData.centros.forEach(centro => {
                    headers.push(centro.nombre);
                });
                data.push(headers);
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const row = [
                        `${indicador.codigo} - ${indicador.nombre}`,
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
                    ];
                    
                    iaapsData.centros.forEach(centro => {
                        const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                        if (resultado) {
                            row.push(resultado.cumplimiento.toFixed(2) + '%');
                        } else {
                            row.push('-');
                        }
                    });
                    
                    data.push(row);
                });
            }
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Ajustar ancho de columnas
            const wscols = data[0].map((col, i) => {
                const maxLength = data.reduce((w, r) => Math.max(w, r[i] ? r[i].toString().length : 0), col.length);
                return { wch: maxLength + 2 };
            });
            ws['!cols'] = wscols;
            
            // Aplicar formato de celda
            for (let i = 1; i < data.length; i++) {
                for (let j = 0; j < data[i].length; j++) {
                    const cell_ref = XLSX.utils.encode_cell({ r: i, c: j });
                    
                    // Aplicar colores según estado para columna de cumplimiento
                    if (tipo === 'centro' && j === 5 || tipo === 'indicador' && j === 5) {
                        const cumplimiento = parseFloat(data[i][j]);
                        if (cumplimiento >= 95) {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "27AE60" } }, font: { color: { rgb: "FFFFFF" } } };
                        } else if (cumplimiento >= 80) {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "F39C12" } }, font: { color: { rgb: "FFFFFF" } } };
                        } else {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "E74C3C" } }, font: { color: { rgb: "FFFFFF" } } };
                        }
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "IAAPS");
            XLSX.writeFile(wb, nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('Datos exportados correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a Excel:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos', 'error');
        }
    }, 1000);
}

// Función para exportar a PDF
function exportarPDF(tipo) {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let nombreArchivo = '';
            let titulo = '';
            let datos = [];
            let columnas = [];
            
            if (tipo === 'centro') {
                // Exportar datos del centro seleccionado
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (!centro) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_${centro.nombre}_Marzo_2025.pdf`;
                titulo = `Reporte IAAPS - ${centro.nombre} - Marzo 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Indicador', dataKey: 'indicador' },
                    { header: 'Numerador', dataKey: 'numerador' },
                    { header: 'Denominador', dataKey: 'denominador' },
                    { header: 'Resultado', dataKey: 'resultado' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Cumplimiento', dataKey: 'cumplimiento' }
                ];
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                    if (!resultado) return;
                    
                    datos.push({
                        indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 30)}...`,
                        numerador: resultado.numerador,
                        denominador: resultado.denominador,
                        resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
            } else if (tipo === 'indicador') {
                // Exportar datos del indicador seleccionado
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                if (!indicador) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_Indicador_${indicador.codigo}_Marzo_2025.pdf`;
                titulo = `Reporte IAAPS - Indicador ${indicador.codigo} - Marzo 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Centro', dataKey: 'centro' },
                    { header: 'Numerador', dataKey: 'numerador' },
                    { header: 'Denominador', dataKey: 'denominador' },
                    { header: 'Resultado', dataKey: 'resultado' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Cumplimiento', dataKey: 'cumplimiento' }
                ];
                
                // Datos
                iaapsData.centros.forEach(centro => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (!resultado) return;
                    
                    datos.push({
                        centro: centro.nombre,
                        numerador: resultado.numerador,
                        denominador: resultado.denominador,
                        resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
            } else if (tipo === 'comparativo') {
                // Exportar tabla comparativa
                nombreArchivo = `IAAPS_Comparativo_Marzo_2025.pdf`;
                titulo = `Reporte IAAPS - Comparativo - Marzo 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Indicador', dataKey: 'indicador' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Comunal', dataKey: 'comunal' }
                ];
                
                // Agregar columnas para cada centro excepto el comunal
                iaapsData.centros.filter(c => c.codigo !== 'comunal').forEach(centro => {
                    columnas.push({ header: centro.nombre, dataKey: centro.codigo });
                });
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const row = {
                        indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 20)}...`,
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
                    };
                    
                    // Agregar datos para cada centro
                    iaapsData.centros.forEach(centro => {
                        const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                        if (resultado) {
                            row[centro.codigo] = resultado.cumplimiento.toFixed(2) + '%';
                        } else {
                            row[centro.codigo] = '-';
                        }
                    });
                    
                    datos.push(row);
                });
            }
            
            // Añadir título
            doc.setFontSize(18);
            doc.text(titulo, 14, 22);
            
            // Añadir fecha
            doc.setFontSize(11);
            doc.text(`Fecha de generación: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Añadir tabla
            doc.autoTable({
                columns: columnas,
                body: datos,
                startY: 35,
                styles: { fontSize: 8 },
                columnStyles: {
                    indicador: { cellWidth: 60 }
                },
                didDrawCell: function(data) {
                    // Colorear celdas de cumplimiento
                    if ((tipo === 'centro' && data.column.dataKey === 'cumplimiento') || 
                        (tipo === 'indicador' && data.column.dataKey === 'cumplimiento')) {
                        
                        if (data.cell.text.length > 0) {
                            const cumplimiento = parseFloat(data.cell.text[0]);
                            
                            if (cumplimiento >= 95) {
                                doc.setFillColor(39, 174, 96); // Verde
                            } else if (cumplimiento >= 80) {
                                doc.setFillColor(243, 156, 18); // Amarillo
                            } else {
                                doc.setFillColor(231, 76, 60); // Rojo
                            }
                            
                            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                            doc.setTextColor(255, 255, 255); // Texto blanco
                            doc.text(data.cell.text, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, {
                                align: 'center',
                                baseline: 'middle'
                            });
                        }
                    }
                }
            });
            
            // Añadir pie de página
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${pageCount} - IAAPS Curicó - Dashboard de Control`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, {
                    align: 'center'
                });
            }
            
            // Guardar PDF
            doc.save(nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('PDF exportado correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a PDF:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos', 'error');
        }
    }, 1000);
}

// Función para alternar el modo oscuro
function toggleDarkMode() {
    darkMode = !darkMode;
    
    if (darkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
    
    // Actualizar gráficos con nuevos colores
    actualizarDashboard();
    actualizarDetalle();
}

// ==================== FUNCIONALIDADES AVANZADAS ====================

// Integración de comandos de voz
function inicializarComandosVoz() {
    if (!('webkitSpeechRecognition' in window)) {
        console.error('API de reconocimiento de voz no soportada');
        return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    // Agregar botón de micrófono al navbar
    const navbarEnd = document.querySelector('.navbar .d-flex');
    const micButton = document.createElement('button');
    micButton.className = 'btn btn-outline-light ms-3';
    micButton.id = 'micButton';
    micButton.innerHTML = '<i class="fas fa-microphone"></i>';
    navbarEnd.appendChild(micButton);
    
    // Estado del reconocimiento
    let isListening = false;
    
    // Evento de click del botón de micrófono
    micButton.addEventListener('click', function() {
        if (isListening) {
            recognition.stop();
            micButton.innerHTML = '<i class="fas fa-microphone"></i>';
            isListening = false;
        } else {
            recognition.start();
            micButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            isListening = true;
            
            mostrarNotificacion('Escuchando... diga un comando', 'success');
        }
    });
    
    // Evento de finalización del reconocimiento
    recognition.onend = function() {
        micButton.innerHTML = '<i class="fas fa-microphone"></i>';
        isListening = false;
    };
    
    // Evento de error del reconocimiento
    recognition.onerror = function(event) {
        console.error('Error en reconocimiento de voz:', event.error);
        micButton.innerHTML = '<i class="fas fa-microphone"></i>';
        isListening = false;
        
        mostrarNotificacion('Error en reconocimiento de voz', 'error');
    };
    
    // Evento de resultado del reconocimiento
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.toLowerCase();
        console.log('Comando de voz:', transcript);
        
        // Procesar comandos
        procesarComandoVoz(transcript);
    };
}

// Procesar comandos de voz
function procesarComandoVoz(comando) {
    // Comandos de navegación
    if (comando.includes('dashboard') || comando.includes('inicio')) {
        mostrarVista('dashboardView');
        mostrarNotificacion('Mostrando dashboard', 'success');
    } else if (comando.includes('detalle') || comando.includes('detalles')) {
        mostrarVista('detailView');
        mostrarNotificacion('Mostrando vista de detalle', 'success');
    } else if (comando.includes('ayuda')) {
        const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
        helpModal.show();
        mostrarNotificacion('Mostrando ayuda', 'success');
    } else if (comando.includes('actualizar') || comando.includes('refrescar')) {
        cargarDatos();
        mostrarNotificacion('Actualizando datos', 'success');
    } else if (comando.includes('modo oscuro') || comando.includes('modo noche')) {
        document.getElementById('darkModeToggle').checked = !document.getElementById('darkModeToggle').checked;
        toggleDarkMode();
        mostrarNotificacion(`Modo oscuro ${darkMode ? 'activado' : 'desactivado'}`, 'success');
    }
    
    // Comandos de exportación
    else if (comando.includes('exportar') || comando.includes('descargar')) {
        if (comando.includes('excel')) {
            if (document.getElementById('dashboardView').style.display !== 'none') {
                exportarExcel('comparativo');
            } else {
                if (document.getElementById('centro-content').classList.contains('active')) {
                    exportarExcel('centro');
                } else if (document.getElementById('indicador-content').classList.contains('active')) {
                    exportarExcel('indicador');
                } else {
                    exportarExcel('comparativo');
                }
            }
            mostrarNotificacion('Exportando a Excel', 'success');
        } else if (comando.includes('pdf')) {
            if (document.getElementById('dashboardView').style.display !== 'none') {
                exportarPDF('comparativo');
            } else {
                if (document.getElementById('centro-content').classList.contains('active')) {
                    exportarPDF('centro');
                } else if (document.getElementById('indicador-content').classList.contains('active')) {
                    exportarPDF('indicador');
                } else {
                    exportarPDF('comparativo');
                }
            }
            mostrarNotificacion('Exportando a PDF', 'success');
        }
    }
    
    // Comandos de centros
    else if (comando.includes('centro')) {
        if (comando.includes('curicó centro') || comando.includes('curico centro')) {
            mostrarVista('detailView');
            seleccionarCentro('curico');
            mostrarNotificacion('Mostrando CESFAM Curicó Centro', 'success');
        } else if (comando.includes('miguel ángel') || comando.includes('miguel angel')) {
            mostrarVista('detailView');
            seleccionarCentro('miguel');
            mostrarNotificacion('Mostrando CESFAM Miguel Ángel Arenas', 'success');
        } else if (comando.includes('betty muñoz') || comando.includes('betty munoz')) {
            mostrarVista('detailView');
            seleccionarCentro('betty');
            mostrarNotificacion('Mostrando CESFAM Betty Muñoz', 'success');
        } else if (comando.includes('colón') || comando.includes('colon')) {
            mostrarVista('detailView');
            seleccionarCentro('colon');
            mostrarNotificacion('Mostrando CESFAM Colón', 'success');
        } else if (comando.includes('sarmiento')) {
            mostrarVista('detailView');
            seleccionarCentro('sarmiento');
            mostrarNotificacion('Mostrando CESFAM Sarmiento', 'success');
        } else if (comando.includes('los niches') || comando.includes('niches')) {
            mostrarVista('detailView');
            seleccionarCentro('niches');
            mostrarNotificacion('Mostrando CESFAM Los Niches', 'success');
        } else if (comando.includes('comunal')) {
            mostrarVista('detailView');
            seleccionarCentro('comunal');
            mostrarNotificacion('Mostrando detalle comunal', 'success');
        }
    }
    
    // Comandos para indicadores específicos
    else if (comando.includes('indicador')) {
        // Extraer número de indicador
        let numeroIndicador = null;
        const match = comando.match(/indicador\s+(\d+(\.\d+)?([a-zA-Z])?)/);
        
        if (match) {
            numeroIndicador = match[1];
            
            // Buscar indicador
            const indicador = iaapsData.indicadores.find(i => i.codigo === numeroIndicador);
            
            if (indicador) {
                mostrarVista('detailView');
                document.getElementById('indicador-tab').click();
                seleccionarIndicador(numeroIndicador);
                mostrarNotificacion(`Mostrando indicador ${numeroIndicador}`, 'success');
            } else {
                mostrarNotificacion(`Indicador ${numeroIndicador} no encontrado`, 'error');
            }
        } else {
            mostrarNotificacion('Por favor, especifique un número de indicador', 'error');
        }
    }
    
    // Comando para buscar
    else if (comando.includes('buscar')) {
        const termino = comando.replace('buscar', '').trim();
        document.getElementById('searchInput').value = termino;
        buscarIndicadores(termino);
        mostrarNotificacion(`Buscando: ${termino}`, 'success');
    }
    
    // Comando no reconocido
    else {
        mostrarNotificacion('Comando no reconocido', 'error');
    }
}

// Visualización de tendencias históricas
function visualizarTendenciasHistoricas() {
    // Agregar botón de tendencias históricas
    const navbarMenu = document.querySelector('.navbar-nav');
    const tendenciasLink = document.createElement('li');
    tendenciasLink.className = 'nav-item';
    tendenciasLink.innerHTML = `
        <a class="nav-link" href="#" id="tendenciasLink">
            <i class="fas fa-chart-line me-1"></i> Tendencias
        </a>
    `;
    navbarMenu.appendChild(tendenciasLink);
    
    // Crear vista de tendencias
    const container = document.querySelector('.container-fluid');
    const tendenciasView = document.createElement('div');
    tendenciasView.id = 'tendenciasView';
    tendenciasView.style.display = 'none';
    
    tendenciasView.innerHTML = `
        <div class="dashboard-header">
            <h2><i class="fas fa-chart-line me-2"></i>Tendencias Históricas IAAPS</h2>
            <p class="text-muted">Análisis de evolución temporal de indicadores IAAPS para la comuna de Curicó</p>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Filtro de Tendencias</h5>
                    </div>
                    <div class="card-body">
                        <form id="tendenciasForm">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Gráfico</label>
                                <select class="form-select" id="tipoGraficoSelect">
                                    <option value="line">Línea</option>
                                    <option value="bar">Barras</option>
                                    <option value="radar">Radar</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Periodo</label>
                                <select class="form-select" id="periodoSelect">
                                    <option value="mensual">Mensual</option>
                                    <option value="trimestral">Trimestral</option>
                                    <option value="anual">Anual</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Indicador</label>
                                <select class="form-select" id="indicadorTendenciaSelect">
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Centro</label>
                                <select class="form-select" id="centroTendenciaSelect">
                                    <option value="comunal">CURICÓ (COMUNAL)</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            
                            <button type="button" class="btn btn-primary" id="generarTendenciaBtn">
                                <i class="fas fa-sync-alt me-1"></i> Generar Gráfico
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="tendenciaChartTitle">Tendencia Histórica</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-success" id="exportarTendenciaExcelBtn">
                                <i class="fas fa-file-excel me-1"></i> Excel
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="exportarTendenciaPdfBtn">
                                <i class="fas fa-file-pdf me-1"></i> PDF
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="tendenciaHistoricaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Datos Históricos</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead id="tendenciaTableHead">
                                    <!-- Se llenará dinámicamente -->
                                </thead>
                                <tbody id="tendenciaTableBody">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(tendenciasView);
    
    // Event listener para el enlace de tendencias
    document.getElementById('tendenciasLink').addEventListener('click', function(e) {
        e.preventDefault();
        mostrarVista('tendenciasView');
        
        // Actualizar clase active en la navegación
        document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
            link.classList.remove('active');
        });
        this.classList.add('active');
        
        // Llenar select de indicadores
        const indicadorSelect = document.getElementById('indicadorTendenciaSelect');
        indicadorSelect.innerHTML = '';
        
        iaapsData.indicadores.forEach(indicador => {
            const option = document.createElement('option');
            option.value = indicador.codigo;
            option.textContent = `${indicador.codigo} - ${indicador.nombre}`;
            indicadorSelect.appendChild(option);
        });
        
        // Llenar select de centros
        const centroSelect = document.getElementById('centroTendenciaSelect');
        centroSelect.innerHTML = '<option value="comunal">CURICÓ (COMUNAL)</option>';
        
        iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
            const option = document.createElement('option');
            option.value = centro.codigo;
            option.textContent = centro.nombre;
            centroSelect.appendChild(option);
        });
        
        // Event listener para generar tendencia
        document.getElementById('generarTendenciaBtn').addEventListener('click', function() {
            generarGraficoTendencia();
        });
        
        // Event listeners para exportar tendencia
        document.getElementById('exportarTendenciaExcelBtn').addEventListener('click', function() {
            exportarTendenciaExcel();
        });
        
        document.getElementById('exportarTendenciaPdfBtn').addEventListener('click', function() {
            exportarTendenciaPDF();
        });
        
        // Generar gráfico inicial
        generarGraficoTendencia();
    });
}

// Generar gráfico de tendencia histórica
function generarGraficoTendencia() {
    const tipoGrafico = document.getElementById('tipoGraficoSelect').value;
    const periodo = document.getElementById('periodoSelect').value;
    const indicadorCodigo = document.getElementById('indicadorTendenciaSelect').value;
    const centroCodigo = document.getElementById('centroTendenciaSelect').value;
    
    // Obtener indicador y centro
    const indicador = iaapsData.indicadores.find(i => i.codigo === indicadorCodigo);
    const centro = iaapsData.centros.find(c => c.codigo === centroCodigo);
    
    if (!indicador || !centro) {
        mostrarNotificacion('Error al generar tendencia', 'error');
        return;
    }
    
    // Actualizar título
    document.getElementById('tendenciaChartTitle').textContent = 
        `Tendencia Histórica: ${indicador.codigo} - ${centro.nombre}`;
    
    // Generar datos simulados para la tendencia
    const periodos = [];
    const datos = [];
    const meta = [];
    
    if (periodo === 'mensual') {
        // Datos mensuales (últimos 12 meses)
        const meses = ['Abril 2024', 'Mayo 2024', 'Junio 2024', 'Julio 2024', 'Agosto 2024', 'Septiembre 2024', 
                      'Octubre 2024', 'Noviembre 2024', 'Diciembre 2024', 'Enero 2025', 'Febrero 2025', 'Marzo 2025'];
        
        periodos.push(...meses);
        
        // Generar valores que aumentan gradualmente
        let valorBase = Math.random() * 50 + 20; // Entre 20 y 70
        
        for (let i = 0; i < meses.length; i++) {
            // Variación aleatoria entre -5 y +8
            const variacion = (Math.random() * 13) - 5;
            valorBase = Math.max(0, Math.min(100, valorBase + variacion));
            datos.push(parseFloat(valorBase.toFixed(2)));
            meta.push(indicador.meta);
        }
    } else if (periodo === 'trimestral') {
        // Datos trimestrales (últimos 8 trimestres)
        const trimestres = ['Q2 2023', 'Q3 2023', 'Q4 2023', 'Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024', 'Q1 2025'];
        
        periodos.push(...trimestres);
        
        // Generar valores que aumentan gradualmente
        let valorBase = Math.random() * 50 + 20; // Entre 20 y 70
        
        for (let i = 0; i < trimestres.length; i++) {
            // Variación aleatoria entre -5 y +12
            const variacion = (Math.random() * 17) - 5;
            valorBase = Math.max(0, Math.min(100, valorBase + variacion));
            datos.push(parseFloat(valorBase.toFixed(2)));
            meta.push(indicador.meta);
        }
    } else { // anual
        // Datos anuales (últimos 5 años)
        const años = ['2021', '2022', '2023', '2024', '2025'];
        
        periodos.push(...años);
        
        // Generar valores que aumentan gradualmente
        let valorBase = Math.random() * 40 + 20; // Entre 20 y 60
        
        for (let i = 0; i < años.length; i++) {
            // Variación aleatoria entre -5 y +15
            const variacion = (Math.random() * 20) - 5;
            valorBase = Math.max(0, Math.min(100, valorBase + variacion));
            datos.push(parseFloat(valorBase.toFixed(2)));
            meta.push(indicador.meta);
        }
    }
    
    // Destruir gráfico anterior si existe
    if (window.tendenciaHistoricaChart) {
        window.tendenciaHistoricaChart.destroy();
    }
    
    // Crear gráfico
    const ctx = document.getElementById('tendenciaHistoricaChart').getContext('2d');
    
    if (tipoGrafico === 'radar') {
        // Para el gráfico radar, se necesita otro tipo de datos
        // Crear datos comparativos entre distintos centros para un periodo
        const centrosLabels = iaapsData.centros.map(c => c.nombre);
        const datosRadar = [];
        
        // Generar datos para cada centro
        iaapsData.centros.forEach(c => {
            const resultado = indicador.resultados.find(r => r.centro === c.codigo);
            
            if (resultado) {
                datosRadar.push(resultado.cumplimiento);
            } else {
                datosRadar.push(0);
            }
        });
        
        window.tendenciaHistoricaChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: centrosLabels,
                datasets: [{
                    label: `Indicador ${indicador.codigo}`,
                    data: datosRadar,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgb(52, 152, 219)',
                    pointBackgroundColor: 'rgb(52, 152, 219)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(52, 152, 219)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        min: 0,
                        max: 100,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 20
                        }
                    }
                }
            }
        });
    } else {
        window.tendenciaHistoricaChart = new Chart(ctx, {
            type: tipoGrafico,
            data: {
                labels: periodos,
                datasets: [
                    {
                        label: `${indicador.codigo} - ${centro.nombre}`,
                        data: datos,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgb(52, 152, 219)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Meta',
                        data: meta,
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderColor: 'rgb(231, 76, 60)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: indicador.tipo === 'porcentaje' ? 'Valor (%)' : 'Valor'
                        }
                    }
                }
            }
        });
    }
    
    // Actualizar tabla de datos
    actualizarTablaTendencia(periodos, datos, meta, indicador);
}

// Actualizar tabla de tendencia
function actualizarTablaTendencia(periodos, datos, meta, indicador) {
    const tableHead = document.getElementById('tendenciaTableHead');
    const tableBody = document.getElementById('tendenciaTableBody');
    
    // Limpiar tabla
    tableHead.innerHTML = '';
    tableBody.innerHTML = '';
    
    // Crear encabezados
    const trHead = document.createElement('tr');
    trHead.innerHTML = `
        <th>Periodo</th>
        <th class="text-center">Resultado</th>
        <th class="text-center">Meta</th>
        <th class="text-center">Cumplimiento</th>
        <th class="text-center">Estado</th>
    `;
    tableHead.appendChild(trHead);
    
    // Crear filas
    periodos.forEach((periodo, index) => {
        const resultado = datos[index];
        const metaValor = meta[index];
        const cumplimiento = (resultado / metaValor) * 100;
        
        let estado = '';
        let statusClass = '';
        
        if (cumplimiento >= 95) {
            estado = 'Cumplido';
            statusClass = 'bg-success';
        } else if (cumplimiento >= 80) {
            estado = 'Parcial';
            statusClass = 'bg-warning';
        } else {
            estado = 'Crítico';
            statusClass = 'bg-danger';
        }
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${periodo}</td>
            <td class="text-center">${indicador.tipo === 'porcentaje' ? resultado + '%' : resultado}</td>
            <td class="text-center">${indicador.tipo === 'porcentaje' ? metaValor + '%' : metaValor}</td>
            <td class="text-center">
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                        <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${Math.min(cumplimiento, 100)}%" aria-valuenow="${cumplimiento}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span>${cumplimiento.toFixed(2)}%</span>
                </div>
            </td>
            <td class="text-center">
                <span class="badge ${statusClass}">${estado}</span>
            </td>
        `;
        
        tableBody.appendChild(tr);
    });
}

// Exportar tendencia a Excel
function exportarTendenciaExcel() {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            const tipoGrafico = document.getElementById('tipoGraficoSelect').value;
            const periodo = document.getElementById('periodoSelect').value;
            const indicadorCodigo = document.getElementById('indicadorTendenciaSelect').value;
            const centroCodigo = document.getElementById('centroTendenciaSelect').value;
            
            // Obtener indicador y centro
            const indicador = iaapsData.indicadores.find(i => i.codigo === indicadorCodigo);
            const centro = iaapsData.centros.find(c => c.codigo === centroCodigo);
            
            if (!indicador || !centro) {
                mostrarCargando(false);
                mostrarNotificacion('Error al exportar datos', 'error');
                return;
            }
            
            // Nombre del archivo
            const nombreArchivo = `IAAPS_Tendencia_${indicador.codigo}_${centro.nombre}_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Obtener datos de la tabla
            const filas = Array.from(document.querySelectorAll('#tendenciaTableBody tr'));
            const data = [
                ['Periodo', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']
            ];
            
            filas.forEach(fila => {
                const celdas = Array.from(fila.querySelectorAll('td'));
                const periodo = celdas[0].textContent;
                const resultado = celdas[1].textContent;
                const meta = celdas[2].textContent;
                const cumplimiento = celdas[3].textContent.trim();
                const estado = celdas[4].textContent;
                
                data.push([periodo, resultado, meta, cumplimiento, estado]);
            });
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Ajustar ancho de columnas
            const wscols = data[0].map((col, i) => {
                const maxLength = data.reduce((w, r) => Math.max(w, r[i] ? r[i].toString().length : 0), col.length);
                return { wch: maxLength + 2 };
            });
            ws['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(wb, ws, "Tendencia");
            XLSX.writeFile(wb, nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('Datos exportados correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a Excel:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos', 'error');
        }
    }, 1000);
}

// Exportar tendencia a PDF
function exportarTendenciaPDF() {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const tipoGrafico = document.getElementById('tipoGraficoSelect').value;
            const periodo = document.getElementById('periodoSelect').value;
            const indicadorCodigo = document.getElementById('indicadorTendenciaSelect').value;
            const centroCodigo = document.getElementById('centroTendenciaSelect').value;
            
            // Obtener indicador y centro
            const indicador = iaapsData.indicadores.find(i => i.codigo === indicadorCodigo);
            const centro = iaapsData.centros.find(c => c.codigo === centroCodigo);
            
            if (!indicador || !centro) {
                mostrarCargando(false);
                mostrarNotificacion('Error al exportar datos', 'error');
                return;
            }
            
            // Nombre del archivo
            const nombreArchivo = `IAAPS_Tendencia_${indicador.codigo}_${centro.nombre}_${new Date().toISOString().split('T')[0]}.pdf`;
            
            // Título
            const titulo = `Tendencia Histórica: ${indicador.codigo} - ${centro.nombre}`;
            
            // Añadir título
            doc.setFontSize(18);
            doc.text(titulo, 14, 22);
            
            // Añadir fecha
            doc.setFontSize(11);
            doc.text(`Fecha de generación: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Capturar gráfico
            const canvas = document.getElementById('tendenciaHistoricaChart');
            const imgData = canvas.toDataURL('image/png');
            
            // Añadir gráfico
            doc.addImage(imgData, 'PNG', 14, 35, 180, 100);
            
            // Añadir tabla
            const filas = Array.from(document.querySelectorAll('#tendenciaTableBody tr'));
            const columnas = [
                { header: 'Periodo', dataKey: 'periodo' },
                { header: 'Resultado', dataKey: 'resultado' },
                { header: 'Meta', dataKey: 'meta' },
                { header: 'Cumplimiento', dataKey: 'cumplimiento' },
                { header: 'Estado', dataKey: 'estado' }
            ];
            
            const datos = filas.map(fila => {
                const celdas = Array.from(fila.querySelectorAll('td'));
                return {
                    periodo: celdas[0].textContent,
                    resultado: celdas[1].textContent,
                    meta: celdas[2].textContent,
                    cumplimiento: celdas[3].textContent.trim(),
                    estado: celdas[4].textContent
                };
            });
            
            doc.autoTable({
                columns: columnas,
                body: datos,
                startY: 140,
                styles: { fontSize: 8 },
                didDrawCell: function(data) {
                    // Colorear celdas de estado
                    if (data.column.dataKey === 'estado') {
                        if (data.cell.text.length > 0) {
                            const estado = data.cell.text[0];
                            
                            if (estado === 'Cumplido') {
                                doc.setFillColor(39, 174, 96); // Verde
                            } else if (estado === 'Parcial') {
                                doc.setFillColor(243, 156, 18); // Amarillo
                            } else {
                                doc.setFillColor(231, 76, 60); // Rojo
                            }
                            
                            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                            doc.setTextColor(255, 255, 255); // Texto blanco
                            doc.text(data.cell.text, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, {
                                align: 'center',
                                baseline: 'middle'
                            });
                        }
                    }
                }
            });
            
            // Añadir pie de página
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${pageCount} - IAAPS Curicó - Dashboard de Control`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, {
                    align: 'center'
                });
            }
            
            // Guardar PDF
            doc.save(nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('PDF exportado correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a PDF:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos', 'error');
        }
    }, 1000);
}

// ==================== EXTENSIÓN DE FUNCIONALIDADES PRINCIPALES ====================

// Extender función mostrarVista para incluir nueva vista
const mostrarVistaOriginal = mostrarVista;
mostrarVista = function(vista) {
    const vistas = ['dashboardView', 'detailView', 'tendenciasView'];
    
    vistas.forEach(v => {
        const elemento = document.getElementById(v);
        if (elemento) {
            elemento.style.display = v === vista ? 'block' : 'none';
        }
    });
    
    // Actualizar clase active en la navegación
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    if (vista === 'dashboardView') {
        document.getElementById('dashboardLink').classList.add('active');
    } else if (vista === 'detailView') {
        document.getElementById('detailLink').classList.add('active');
    } else if (vista === 'tendenciasView') {
        const tendenciasLink = document.getElementById('tendenciasLink');
        if (tendenciasLink) {
            tendenciasLink.classList.add('active');
        }
    }
};

// Función para inicializar funcionalidades avanzadas
function inicializarFuncionalidadesAvanzadas() {
    // Inicializar comandos de voz
    inicializarComandosVoz();
    
    // Inicializar visualización de tendencias
    visualizarTendenciasHistoricas();
    
    // Añadir otras funcionalidades avanzadas según sea necesario
}

// Event listener para inicializar funcionalidades avanzadas
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que todo el dashboard esté cargado
    setTimeout(inicializarFuncionalidadesAvanzadas, 1000);
});

// Instancias globales para Chart.js (detalle de indicador)
let indicadorCentrosChartInstance = null;
let indicadorTendenciaChartInstance = null;

/**
 * Actualiza los gráficos de detalle para el indicador seleccionado.
 * @param {Object} indicador  El objeto indicador de iaapsData.indicadores
 */
function actualizarGraficosDetalleIndicador(indicador) {
  // --- GRÁFICO 1: Barras de Cumplimiento por Centro ---
  const centrosLabels = [];
  const centrosCumplimiento = [];
  iaapsData.centros
    .filter(c => c.codigo !== 'comunal')
    .forEach(centro => {
      const res = indicador.resultados.find(r => r.centro === centro.codigo);
      if (res && res.denominador > 0) {
        centrosLabels.push(centro.nombre);
        centrosCumplimiento.push(res.cumplimiento || 0);
      }
    });

  // Destruir la instancia previa si existe
  if (indicadorCentrosChartInstance) {
    indicadorCentrosChartInstance.destroy();
  }

  // Crear nuevo gráfico de barras
  const ctxCentros = document.getElementById('indicadorCentrosChart').getContext('2d');
  indicadorCentrosChartInstance = new Chart(ctxCentros, {
    type: 'bar',
    data: {
      labels: centrosLabels,
      datasets: [{
        label: 'Cumplimiento (%)',
        data: centrosCumplimiento,
        backgroundColor: ctx => {
          const v = ctx.dataset.data[ctx.dataIndex];
          return v >= 95 ? '#27ae60' : v >= 80 ? '#f39c12' : '#e74c3c';
        },
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Cumplimiento por Centro' },
        tooltip: {
          callbacks: {
            label: ctx => `Cumplimiento: ${ctx.formattedValue}%`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Cumplimiento (%)' }
        },
        x: {
          title: { display: true, text: 'Centro de Salud' }
        }
      }
    }
  });

  // --- GRÁFICO 2: Línea de Tendencia (simulada) ---
  const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
  let valor = Math.random() * 50 + 25;
  const tendenciaData = meses.map(() => {
    valor = Math.max(0, Math.min(100, valor + (Math.random() * 10 - 5)));
    return parseFloat(valor.toFixed(2));
  });
  const metaArray = Array(meses.length).fill(indicador.meta);

  // Destruir instancia previa si existe
  if (indicadorTendenciaChartInstance) {
    indicadorTendenciaChartInstance.destroy();
  }

  // Crear gráfico de línea
  const ctxTend = document.getElementById('indicadorTendenciaChart').getContext('2d');
  indicadorTendenciaChartInstance = new Chart(ctxTend, {
    type: 'line',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Resultado',
          data: tendenciaData,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52,152,219,0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Meta',
          data: metaArray,
          borderColor: '#e74c3c',
          borderDash: [5,5],
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Tendencia Mensual' }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: indicador.tipo === 'porcentaje' ? 'Resultado (%)' : 'Resultado'
          }
        }
      }
    }
  });
}



</script>

</html>