<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Poblacional Curicó - Sistema Avanzado de Análisis Demográfico</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color:rgb(97, 202, 118);
            --secondary-color:rgb(127, 223, 68);
            --accent-color: #fbbc04;
            --danger-color: #ea4335;
            --success-color: #34a853;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
            --text-color: #212121;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --transition: all 0.3s ease;
            --border-radius: 8px;
            --chart-height: 300px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            color: var(--text-color);
            background-color: #f9fafb;
            line-height: 1.6;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 10;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            margin-right: 12px;
        }

        .logo-icon {
            margin-right: 10px;
            font-size: 2.2rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 500px;
        }

        .user-controls {
            display: flex;
            align-items: center;
        }

        .control-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            margin-left: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .control-btn i {
            margin-right: 6px;
        }

        /* Main Container Styles */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        /* Sidebar Styles */
        .sidebar {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            height: calc(100vh - 180px);
            position: sticky;
            top: 100px;
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .filter-title i {
            margin-right: 8px;
        }

        .filter-content {
            margin-bottom: 1rem;
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-family: var(--font-main);
            margin-bottom: 8px;
            transition: var(--transition);
        }

        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }

        .checkbox-item input {
            margin-right: 5px;
        }

        .range-filter {
            margin-bottom: 15px;
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .apply-filters-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: var(--transition);
            margin-top: 15px;
        }

        .apply-filters-btn:hover {
            background-color: var(--secondary-color);
        }

        .reset-filters {
            text-align: center;
            margin-top: 10px;
            color: var(--dark-gray);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .reset-filters:hover {
            color: var(--danger-color);
        }

        /* Main Content Styles */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Stats Cards */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.2rem;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            font-weight: 500;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .icon-primary {
            background-color: rgba(26, 115, 232, 0.1);
            color: var(--primary-color);
        }

        .icon-success {
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--success-color);
        }

        .icon-warning {
            background-color: rgba(251, 188, 4, 0.1);
            color: var(--accent-color);
        }

        .icon-danger {
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--danger-color);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-description {
            font-size: 0.8rem;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
        }

        .trend-up {
            color: var(--success-color);
            margin-right: 4px;
        }

        .trend-down {
            color: var(--danger-color);
            margin-right: 4px;
        }

        /* Chart Sections */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.2rem;
            height: 100%;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title {
            font-weight: 600;
            color: var(--text-color);
        }

        .chart-actions {
            display: flex;
            gap: 8px;
        }

        .chart-btn {
            background-color: var(--light-gray);
            border: none;
            padding: 5px 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            font-size: 0.8rem;
        }

        .chart-btn:hover {
            background-color: var(--medium-gray);
        }

        .chart-btn i {
            margin-right: 4px;
        }

        .chart-content {
            position: relative;
            height: var(--chart-height);
            width: 100%;
        }

        .map-container {
            height: 500px;
        }

        .fullwidth {
            grid-column: 1 / -1;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.2rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }

        .data-table th {
            background-color: var(--light-gray);
            font-weight: 600;
            color: var(--primary-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--light-gray);
        }

        .data-table .center {
            text-align: center;
        }

        .data-table .right {
            text-align: right;
        }

        /* Footer Styles */
        .footer {
            text-align: center;
            padding: 1.5rem;
            background-color: white;
            margin-top: 2rem;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            box-shadow: var(--shadow-sm);
        }

        .footer-text {
            color: var(--dark-gray);
            font-size: 0.85rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                height: auto;
                position: static;
                margin-bottom: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .user-controls {
                margin-top: 1rem;
            }
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: 1fr 1fr;
            }

            .control-btn span {
                display: none;
            }

            .control-btn i {
                margin-right: 0;
            }
        }

        @media (max-width: 480px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: var(--transition);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.2rem;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--dark-gray);
        }

        .modal-body {
            padding: 1.2rem;
        }

        .modal-footer {
            padding: 1.2rem;
            border-top: 1px solid var(--medium-gray);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-secondary {
            background-color: var(--light-gray);
            border: 1px solid var(--medium-gray);
            color: var(--text-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: 1px solid var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: var(--medium-gray);
        }

        /* Loading Indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-gray);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: var(--primary-color);
            font-weight: 600;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltips */
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Additional Chart Styles */
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 5px;
        }

        /* Tabs Styles */
        .tabs-container {
            margin-bottom: 1rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--medium-gray);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .tab:hover:not(.active) {
            background-color: var(--light-gray);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Custom Select with Search */
        .custom-select-container {
            position: relative;
            width: 100%;
        }

        .custom-select-selected {
            padding: 8px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--medium-gray);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-shadow: var(--shadow-md);
        }

        .custom-select-search {
            padding: 8px;
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid var(--medium-gray);
        }

        .custom-select-search input {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
        }

        .custom-select-option {
            padding: 8px 12px;
            cursor: pointer;
        }

        .custom-select-option:hover {
            background-color: var(--light-gray);
        }

        .custom-select-option.selected {
            background-color: rgba(26, 115, 232, 0.1);
            color: var(--primary-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #323232;
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification-icon {
            margin-right: 12px;
            font-size: 1.2rem;
        }

        .notification-message {
            font-size: 0.9rem;
        }

        /* Custom toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--medium-gray);
            transition: var(--transition);
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Card styles for reports */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .report-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.2rem;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .report-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .report-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .report-description {
            font-size: 0.85rem;
            color: var(--dark-gray);
            flex-grow: 1;
            margin-bottom: 15px;
        }

        .report-actions {
            display: flex;
            justify-content: flex-end;
        }

        .report-btn {
            background-color: var(--light-gray);
            border: none;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .report-btn:hover {
            background-color: var(--medium-gray);
        }

        /* Print styles */
        @media print {
            .header, .sidebar, .footer, .chart-actions, .modal-overlay {
                display: none !important;
            }

            .dashboard {
                display: block;
            }

            .main-content {
                width: 100%;
            }

            body {
                background-color: white;
            }

            .container {
                max-width: 100%;
                width: 100%;
                padding: 0;
            }

            .chart-container, .table-container, .stat-card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }

            .chart-grid {
                display: block;
            }

            .chart-container {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-container">
                <div class="logo"><i class="fas fa-chart-bar logo-icon"></i> Tablero Poblacional Curicó</div>
                <div class="subtitle">Sistema Avanzado de Análisis Demográfico para Gestión de Salud</div>
            </div>
            <div class="user-controls">
                <button class="control-btn" id="exportBtn">
                    <i class="fas fa-download"></i>
                    <span>Exportar</span>
                </button>
                <button class="control-btn" id="printBtn">
                    <i class="fas fa-print"></i>
                    <span>Imprimir</span>
                </button>
                <button class="control-btn" id="helpBtn">
                    <i class="fas fa-question-circle"></i>
                    <span>Ayuda</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard Layout -->
        <div class="dashboard">
            <!-- Sidebar with Filters -->
            <aside class="sidebar">
                <div class="filter-section">
                    <div class="filter-title">
                        <i class="fas fa-filter"></i> Filtros
                    </div>
                    <div class="filter-content">
                        <label for="yearFilter">Año:</label>
                        <select id="yearFilter">
                            <option value="2024" selected>2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>

                    <div class="filter-content">
                        <label for="communeFilter">Comuna:</label>
                        <select id="communeFilter">
                            <option value="curico" selected>Curicó</option>
                        </select>
                    </div>

                    <div class="filter-content">
                        <label for="centerFilter">Centro de Salud:</label>
                        <select id="centerFilter">
                            <option value="all" selected>Todos los centros</option>
                            <option value="central">CESFAM Curicó Centro</option>
                            <option value="maal">CESFAM Miguel Ángel Arenas López</option>
                            <option value="bma">CESFAM Betty Muñoz Arce</option>
                            <option value="colon">CESFAM Colón</option>
                            <option value="sarmiento">CESFAM Sarmiento</option>
                            <option value="niches">CESFAM Los Niches</option>
                        </select>
                    </div>

                    <div class="filter-content">
                        <label>Sexo:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="maleFilter" checked>
                                <label for="maleFilter">Masculino</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="femaleFilter" checked>
                                <label for="femaleFilter">Femenino</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-content">
                        <label>Grupo Etario:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="infantilFilter" checked>
                                <label for="infantilFilter">Infantil (0-9)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adolescenteFilter" checked>
                                <label for="adolescenteFilter">Adolescente (10-19)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adultoFilter" checked>
                                <label for="adultoFilter">Adulto (20-64)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adultoMayorFilter" checked>
                                <label for="adultoMayorFilter">Adulto Mayor (≥65)</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-content">
                        <label for="ageRangeFilter">Rango de Edad:</label>
                        <div class="range-filter">
                            <input type="range" id="ageRangeMin" min="0" max="99" value="0">
                            <input type="range" id="ageRangeMax" min="0" max="99" value="99">
                            <div class="range-values">
                                <span id="ageRangeMinValue">0</span>
                                <span id="ageRangeMaxValue">99</span>
                            </div>
                        </div>
                    </div>

                    <button class="apply-filters-btn" id="applyFilters">
                        Aplicar Filtros
                    </button>
                    <div class="reset-filters" id="resetFilters">
                        Restablecer Filtros
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-title">
                        <i class="fas fa-file-alt"></i> Informes Predefinidos
                    </div>
                    <div class="filter-content">
                        <select id="reportTemplate">
                            <option value="" selected>Seleccionar Informe</option>
                            <option value="report_distribution">Distribución por Centro de Salud</option>
                            <option value="report_age_gender">Distribución por Edad y Sexo</option>
                            <option value="report_comparison">Comparación Inscrita vs. INE</option>
                            <option value="report_trends">Tendencias Poblacionales</option>
                            <option value="report_geo">Geolocalización y Cobertura</option>
                            <option value="report_full">Informe Completo</option>
                        </select>
                        <button class="apply-filters-btn" id="generateReport">
                            Generar Informe
                        </button>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-title">
                        <i class="fas fa-cog"></i> Configuración
                    </div>
                    <div class="filter-content">
                        <div class="checkbox-item">
                            <input type="checkbox" id="darkModeToggle">
                            <label for="darkModeToggle">Modo Oscuro</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="autoRefreshToggle">
                            <label for="autoRefreshToggle">Actualización Automática</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="liveDataToggle">
                            <label for="liveDataToggle">Datos en Tiempo Real</label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- Stats Overview Cards -->
                <section class="stats-overview">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Población Total</div>
                            <div class="stat-icon icon-primary">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalPopulation">150,113</div>
                        <div class="stat-description">
                            <span class="trend-up"><i class="fas fa-arrow-up"></i> 2.3%</span> desde el año anterior
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Distribución por Sexo</div>
                            <div class="stat-icon icon-success">
                                <i class="fas fa-venus-mars"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="genderRatio">46.5% / 53.5%</div>
                        <div class="stat-description">
                            Masculino / Femenino
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Edad Promedio</div>
                            <div class="stat-icon icon-warning">
                                <i class="fas fa-birthday-cake"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="averageAge">38.2</div>
                        <div class="stat-description">
                            <span class="trend-up"><i class="fas fa-arrow-up"></i> 0.8</span> años desde 2023
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Población Pediátrica</div>
                            <div class="stat-icon icon-danger">
                                <i class="fas fa-child"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="pediatricPopulation">24.6%</div>
                        <div class="stat-description">
                            <span class="trend-down"><i class="fas fa-arrow-down"></i> 1.2%</span> desde el año anterior
                        </div>
                    </div>
                </section>

                <!-- Tab Container for different views -->
                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="overview">Vista General</div>
                        <div class="tab" data-tab="demographics">Demografía</div>
                        <div class="tab" data-tab="comparison">Comparativa</div>
                        <div class="tab" data-tab="geographical">Geográfico</div>
                        <div class="tab" data-tab="tables">Tablas</div>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="tab-content active" id="overview-tab">
                    <!-- Population Distribution by Health Center -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribución de Población por Centro de Salud</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" id="downloadDistributionChart">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="chart-btn" id="fullscreenDistributionChart">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Population Age Groups Chart Grid -->
                    <div class="chart-grid">
                        <!-- Population Pyramid -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Pirámide Poblacional</h3>
                                <div class="chart-actions">
                                    <button class="chart-btn" id="downloadPyramidChart">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button class="chart-btn" id="fullscreenPyramidChart">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="pyramidChart"></canvas>
                            </div>
                        </div>

                        <!-- Age Distribution Doughnut -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Distribución por Grupos Etarios</h3>
                                <div class="chart-actions">
                                    <button class="chart-btn" id="downloadAgeGroupsChart">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button class="chart-btn" id="fullscreenAgeGroupsChart">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="ageGroupsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Historical Trends -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Tendencias Poblacionales (2020-2024)</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" id="downloadTrendsChart">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="chart-btn" id="fullscreenTrendsChart">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="demographics-tab">
                    <!-- Detailed Demographics Content -->
                    <div class="chart-grid">
                        <!-- Gender Distribution by Age -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Distribución por Sexo y Edad</h3>
                                <div class="chart-actions">
                                    <button class="chart-btn" id="downloadGenderAgeChart">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button class="chart-btn" id="fullscreenGenderAgeChart">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="genderAgeChart"></canvas>
                            </div>
                        </div>

                        <!-- Population by Center and Age Group -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Población por Centro y Grupo Etario</h3>
                                <div class="chart-actions">
                                    <button class="chart-btn" id="downloadCenterAgeChart">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button class="chart-btn" id="fullscreenCenterAgeChart">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="centerAgeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Age Distribution -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribución Detallada por Edad</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" id="downloadDetailedAgeChart">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="chart-btn" id="fullscreenDetailedAgeChart">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="detailedAgeChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="comparison-tab">
                    <!-- INE vs Per Capita Comparison -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Comparativa Población INE vs. Inscrita</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" id="downloadComparisonChart">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="chart-btn" id="fullscreenComparisonChart">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-content">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-grid">
                        <!-- Cover Rate Chart -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Tasa de Cobertura por Grupo Etario</h3>
                                <div class="chart-actions">
                                    <button class="chart-btn" id="downloadCoverageChart">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button class="chart-btn" id="fullscreenCoverageChart">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="coverageChart"></canvas>
                            </div>
                        </div>

                        <!-- Gender Comparison INE vs Per Capita -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Comparativa de Sexo: INE vs. Inscrita</h3>
                                <div class="chart-actions">
                                    <button class="chart-btn" id="downloadGenderComparisonChart">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button class="chart-btn" id="fullscreenGenderComparisonChart">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="genderComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="geographical-tab">
                    <!-- Map Container -->
                    <div class="chart-container map-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribución Geográfica de Centros de Salud</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" id="downloadMap">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="chart-btn" id="fullscreenMap">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div id="mapChart" style="height: 100%;"></div>
                    </div>

                    <div class="chart-grid">
                        <!-- Density Chart -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Densidad Poblacional por Sector</h3>
                                <div class="chart-actions">
                                    <button class="chart-btn" id="downloadDensityChart">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button class="chart-btn" id="fullscreenDensityChart">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="densityChart"></canvas>
                            </div>
                        </div>

                        <!-- Service Area Coverage -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Cobertura por Área de Servicio</h3>
                                <div class="chart-actions">
                                    <button class="chart-btn" id="downloadServiceAreaChart">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button class="chart-btn" id="fullscreenServiceAreaChart">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="serviceAreaChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tables-tab">
                    <!-- Population Data Table -->
                    <div class="table-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Datos Poblacionales por Centro de Salud</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" id="downloadTable">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="chart-btn" id="fullscreenTable">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <table class="data-table" id="populationTable">
                            <thead>
                                <tr>
                                    <th>Centro de Salud</th>
                                    <th class="center">Población Total</th>
                                    <th class="center">Masculino</th>
                                    <th class="center">Femenino</th>
                                    <th class="center">0-9 años</th>
                                    <th class="center">10-19 años</th>
                                    <th class="center">20-64 años</th>
                                    <th class="center">≥65 años</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>CESFAM Curicó Centro</td>
                                    <td class="center">41,532</td>
                                    <td class="center">18,111</td>
                                    <td class="center">23,421</td>
                                    <td class="center">3,878</td>
                                    <td class="center">5,444</td>
                                    <td class="center">25,601</td>
                                    <td class="center">6,609</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Miguel Ángel Arenas López</td>
                                    <td class="center">28,763</td>
                                    <td class="center">14,094</td>
                                    <td class="center">14,669</td>
                                    <td class="center">3,199</td>
                                    <td class="center">3,687</td>
                                    <td class="center">18,218</td>
                                    <td class="center">3,659</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Betty Muñoz Arce</td>
                                    <td class="center">28,461</td>
                                    <td class="center">12,604</td>
                                    <td class="center">15,857</td>
                                    <td class="center">3,782</td>
                                    <td class="center">4,039</td>
                                    <td class="center">16,868</td>
                                    <td class="center">3,772</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Colón</td>
                                    <td class="center">23,785</td>
                                    <td class="center">11,115</td>
                                    <td class="center">12,670</td>
                                    <td class="center">2,858</td>
                                    <td class="center">3,281</td>
                                    <td class="center">14,315</td>
                                    <td class="center">3,331</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Sarmiento</td>
                                    <td class="center">13,722</td>
                                    <td class="center">6,792</td>
                                    <td class="center">6,930</td>
                                    <td class="center">1,469</td>
                                    <td class="center">2,078</td>
                                    <td class="center">8,583</td>
                                    <td class="center">1,592</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Los Niches</td>
                                    <td class="center">13,850</td>
                                    <td class="center">7,013</td>
                                    <td class="center">6,837</td>
                                    <td class="center">1,393</td>
                                    <td class="center">1,839</td>
                                    <td class="center">8,484</td>
                                    <td class="center">2,134</td>
                                </tr>
                                <tr>
                                    <td><strong>COMUNA CURICÓ</strong></td>
                                    <td class="center"><strong>150,113</strong></td>
                                    <td class="center"><strong>69,729</strong></td>
                                    <td class="center"><strong>80,384</strong></td>
                                    <td class="center"><strong>16,579</strong></td>
                                    <td class="center"><strong>20,368</strong></td>
                                    <td class="center"><strong>92,069</strong></td>
                                    <td class="center"><strong>21,097</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Age Group Detailed Table -->
                    <div class="table-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Desglose Detallado por Grupos de Edad</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" id="downloadAgeTable">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="chart-btn" id="fullscreenAgeTable">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <table class="data-table" id="ageGroupTable">
                            <thead>
                                <tr>
                                    <th>Centro de Salud</th>
                                    <th class="center">0-4 años</th>
                                    <th class="center">5-9 años</th>
                                    <th class="center">10-14 años</th>
                                    <th class="center">15-19 años</th>
                                    <th class="center">20-44 años</th>
                                    <th class="center">45-64 años</th>
                                    <th class="center">65-79 años</th>
                                    <th class="center">≥80 años</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>CESFAM Curicó Centro</td>
                                    <td class="center">1,518</td>
                                    <td class="center">2,360</td>
                                    <td class="center">2,671</td>
                                    <td class="center">2,773</td>
                                    <td class="center">14,678</td>
                                    <td class="center">10,923</td>
                                    <td class="center">5,071</td>
                                    <td class="center">1,538</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Miguel Ángel Arenas López</td>
                                    <td class="center">1,466</td>
                                    <td class="center">1,733</td>
                                    <td class="center">1,941</td>
                                    <td class="center">1,746</td>
                                    <td class="center">10,846</td>
                                    <td class="center">7,372</td>
                                    <td class="center">2,955</td>
                                    <td class="center">704</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Betty Muñoz Arce</td>
                                    <td class="center">1,664</td>
                                    <td class="center">2,118</td>
                                    <td class="center">2,148</td>
                                    <td class="center">1,891</td>
                                    <td class="center">10,166</td>
                                    <td class="center">6,702</td>
                                    <td class="center">2,934</td>
                                    <td class="center">838</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Colón</td>
                                    <td class="center">1,192</td>
                                    <td class="center">1,666</td>
                                    <td class="center">1,702</td>
                                    <td class="center">1,579</td>
                                    <td class="center">8,648</td>
                                    <td class="center">5,667</td>
                                    <td class="center">2,659</td>
                                    <td class="center">672</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Sarmiento</td>
                                    <td class="center">599</td>
                                    <td class="center">870</td>
                                    <td class="center">1,016</td>
                                    <td class="center">1,062</td>
                                    <td class="center">5,107</td>
                                    <td class="center">3,476</td>
                                    <td class="center">1,272</td>
                                    <td class="center">320</td>
                                </tr>
                                <tr>
                                    <td>CESFAM Los Niches</td>
                                    <td class="center">589</td>
                                    <td class="center">804</td>
                                    <td class="center">934</td>
                                    <td class="center">905</td>
                                    <td class="center">4,797</td>
                                    <td class="center">3,687</td>
                                    <td class="center">1,674</td>
                                    <td class="center">460</td>
                                </tr>
                                <tr>
                                    <td><strong>COMUNA CURICÓ</strong></td>
                                    <td class="center"><strong>7,028</strong></td>
                                    <td class="center"><strong>9,551</strong></td>
                                    <td class="center"><strong>10,412</strong></td>
                                    <td class="center"><strong>9,956</strong></td>
                                    <td class="center"><strong>54,242</strong></td>
                                    <td class="center"><strong>37,827</strong></td>
                                    <td class="center"><strong>16,565</strong></td>
                                    <td class="center"><strong>4,532</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-text">
            Tablero Poblacional Curicó © 2024-2025 | Desarrollado por Sistema de Salud Municipal | Datos actualizados al: Septiembre 2024
        </div>
    </footer>

    <!-- Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Exportar Datos</h3>
                <button class="modal-close" id="closeExportModal">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Formato de Exportación</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="radio" id="exportExcel" name="exportFormat" value="excel" checked>
                        <label for="exportExcel">Excel (.xlsx)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" id="exportPDF" name="exportFormat" value="pdf">
                        <label for="exportPDF">PDF (.pdf)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" id="exportCSV" name="exportFormat" value="csv">
                        <label for="exportCSV">CSV (.csv)</label>
                    </div>
                </div>

                <h4>Contenido a Exportar</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="exportData" checked>
                        <label for="exportData">Datos tabulares</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="exportCharts" checked>
                        <label for="exportCharts">Gráficos</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="exportSummary" checked>
                        <label for="exportSummary">Resumen estadístico</label>
                    </div>
                </div>

                <h4>Filtros Aplicados</h4>
                <p>Los filtros actuales se aplicarán a la exportación:</p>
                <ul id="exportFiltersList">
                    <li>Año: 2024</li>
                    <li>Comuna: Curicó</li>
                    <li>Centro de Salud: Todos</li>
                    <li>Sexo: Ambos</li>
                    <li>Grupo Etario: Todos</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-secondary" id="cancelExport">Cancelar</button>
                <button class="modal-btn btn-primary" id="confirmExport">Exportar</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ayuda del Tablero Poblacional</h3>
                <button class="modal-close" id="closeHelpModal">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Navegación</h4>
                <p>El Tablero Poblacional Curicó está organizado en pestañas que muestran diferentes aspectos de los datos demográficos:</p>
                <ul>
                    <li><strong>Vista General:</strong> Resumen de los indicadores clave y distribución de la población.</li>
                    <li><strong>Demografía:</strong> Análisis detallado por edad y sexo.</li>
                    <li><strong>Comparativa:</strong> Contraste entre datos INE y población inscrita.</li>
                    <li><strong>Geográfico:</strong> Distribución espacial y áreas de cobertura.</li>
                    <li><strong>Tablas:</strong> Datos tabulares detallados para análisis en profundidad.</li>
                </ul>

                <h4>Filtros</h4>
                <p>Puede personalizar la visualización de datos mediante los filtros disponibles en el panel lateral:</p>
                <ul>
                    <li>Seleccione un año específico para ver los datos históricos.</li>
                    <li>Filtre por centro de salud específico o visualice todos.</li>
                    <li>Aplique filtros por sexo y grupo etario.</li>
                    <li>Utilice el control deslizante para filtrar rangos de edad específicos.</li>
                </ul>

                <h4>Exportación</h4>
                <p>Para exportar datos o gráficos:</p>
                <ul>
                    <li>Utilice el botón "Exportar" en la barra superior para exportar el tablero completo.</li>
                    <li>Cada gráfico tiene su propio botón de exportación para guardar solo ese elemento.</li>
                    <li>Los datos se pueden exportar en formatos Excel, PDF o CSV.</li>
                </ul>

                <h4>Informes Predefinidos</h4>
                <p>El sistema ofrece informes predefinidos para análisis comunes:</p>
                <ul>
                    <li>Seleccione un informe de la lista desplegable en el panel lateral.</li>
                    <li>Haga clic en "Generar Informe" para crear automáticamente el análisis seleccionado.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-primary" id="closeHelpBtn">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Cargando datos...</div>
    </div>

    <!-- Tooltip Container -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Notification Container -->
    <div class="notification" id="notification">
        <div class="notification-icon"><i class="fas fa-check-circle"></i></div>
        <div class="notification-message">Operación completada con éxito</div>
    </div>

    <script>
        // Datos poblacionales
        const poblacionData = {
            centros: {
                central: {
                    nombre: "CESFAM Curicó Centro",
                    total: 41532,
                    sexo: {
                        masculino: 18111,
                        femenino: 23421
                    },
                    edades: {
                        "0-9": 3878,
                        "10-19": 5444,
                        "20-64": 25601,
                        "65+": 6609
                    },
                    detalleEdades: {
                        "0-4": 1518,
                        "5-9": 2360,
                        "10-14": 2671,
                        "15-19": 2773,
                        "20-44": 14678,
                        "45-64": 10923,
                        "65-79": 5071,
                        "80+": 1538
                    },
                    geolocalizacion: {
                        lat: -34.976,
                        lng: -71.236,
                        radio: 2.5
                    }
                },
                maal: {
                    nombre: "CESFAM Miguel Ángel Arenas López",
                    total: 28763,
                    sexo: {
                        masculino: 14094,
                        femenino: 14669
                    },
                    edades: {
                        "0-9": 3199,
                        "10-19": 3687,
                        "20-64": 18218,
                        "65+": 3659
                    },
                    detalleEdades: {
                        "0-4": 1466,
                        "5-9": 1733,
                        "10-14": 1941,
                        "15-19": 1746,
                        "20-44": 10846,
                        "45-64": 7372,
                        "65-79": 2955,
                        "80+": 704
                    },
                    geolocalizacion: {
                        lat: -34.9825,
                        lng: -71.2511,
                        radio: 1.8
                    }
                },
                bma: {
                    nombre: "CESFAM Betty Muñoz Arce",
                    total: 28461,
                    sexo: {
                        masculino: 12604,
                        femenino: 15857
                    },
                    edades: {
                        "0-9": 3782,
                        "10-19": 4039,
                        "20-64": 16868,
                        "65+": 3772
                    },
                    detalleEdades: {
                        "0-4": 1664,
                        "5-9": 2118,
                        "10-14": 2148,
                        "15-19": 1891,
                        "20-44": 10166,
                        "45-64": 6702,
                        "65-79": 2934,
                        "80+": 838
                    },
                    geolocalizacion: {
                        lat: -34.9688,
                        lng: -71.2169,
                        radio: 1.9
                    }
                },
                colon: {
                    nombre: "CESFAM Colón",
                    total: 23785,
                    sexo: {
                        masculino: 11115,
                        femenino: 12670
                    },
                    edades: {
                        "0-9": 2858,
                        "10-19": 3281,
                        "20-64": 14315,
                        "65+": 3331
                    },
                    detalleEdades: {
                        "0-4": 1192,
                        "5-9": 1666,
                        "10-14": 1702,
                        "15-19": 1579,
                        "20-44": 8648,
                        "45-64": 5667,
                        "65-79": 2659,
                        "80+": 672
                    },
                    geolocalizacion: {
                        lat: -34.9923,
                        lng: -71.2229,
                        radio: 1.7
                    }
                },
                sarmiento: {
                    nombre: "CESFAM Sarmiento",
                    total: 13722,
                    sexo: {
                        masculino: 6792,
                        femenino: 6930
                    },
                    edades: {
                        "0-9": 1469,
                        "10-19": 2078,
                        "20-64": 8583,
                        "65+": 1592
                    },
                    detalleEdades: {
                        "0-4": 599,
                        "5-9": 870,
                        "10-14": 1016,
                        "15-19": 1062,
                        "20-44": 5107,
                        "45-64": 3476,
                        "65-79": 1272,
                        "80+": 320
                    },
                    geolocalizacion: {
                        lat: -35.0177,
                        lng: -71.2608,
                        radio: 1.5
                    }
                },
                niches: {
                    nombre: "CESFAM Los Niches",
                    total: 13850,
                    sexo: {
                        masculino: 7013,
                        femenino: 6837
                    },
                    edades: {
                        "0-9": 1393,
                        "10-19": 1839,
                        "20-64": 8484,
                        "65+": 2134
                    },
                    detalleEdades: {
                        "0-4": 589,
                        "5-9": 804,
                        "10-14": 934,
                        "15-19": 905,
                        "20-44": 4797,
                        "45-64": 3687,
                        "65-79": 1674,
                        "80+": 460
                    },
                    geolocalizacion: {
                        lat: -35.0114,
                        lng: -71.1857,
                        radio: 1.3
                    }
                }
            },
            comuna: {
                nombre: "Curicó",
                total: 150113,
                sexo: {
                    masculino: 69729,
                    femenino: 80384
                },
                edades: {
                    "0-9": 16579,
                    "10-19": 20368,
                    "20-64": 92069,
                    "65+": 21097
                },
                detalleEdades: {
                    "0-4": 7028,
                    "5-9": 9551,
                    "10-14": 10412,
                    "15-19": 9956,
                    "20-44": 54242,
                    "45-64": 37827,
                    "65-79": 16565,
                    "80+": 4532
                },
                geolocalizacion: {
                    lat: -34.9828,
                    lng: -71.2394,
                    radio: 5.0
                }
            },
            // Datos de pirámide poblacional por años individuales
            piramide: {
                // Los datos extraídos del archivo
                grupos: [
                    "0", "1", "2", "3", "4", "5", "6", "7", "8", "9",
                    "10", "11", "12", "13", "14", "15", "16", "17", "18", "19",
                    "20", "21", "22", "23", "24", "25", "26", "27", "28", "29",
                    "30", "31", "32", "33", "34", "35", "36", "37", "38", "39",
                    "40", "41", "42", "43", "44", "45", "46", "47", "48", "49",
                    "50", "51", "52", "53", "54", "55", "56", "57", "58", "59",
                    "60", "61", "62", "63", "64", "65", "66", "67", "68", "69",
                    "70", "71", "72", "73", "74", "75", "76", "77", "78", "79",
                    "80", "81", "82", "83", "84", "85", "86", "87", "88", "89",
                    "90", "91", "92", "93", "94", "95", "96", "97", "98", "99+"
                ],
                masculino: [
                    481, 669, 769, 730, 855, 973, 970, 886, 1002, 1025,
                    1120, 1019, 1008, 1073, 1042, 1032, 1071, 965, 977, 991,
                    919, 920, 955, 950, 952, 960, 964, 1028, 1018, 1071,
                    1113, 1049, 1105, 1047, 1158, 1046, 1155, 947, 941, 880,
                    845, 878, 915, 862, 860, 800, 884, 853, 903, 915,
                    912, 907, 851, 814, 735, 853, 910, 905, 917, 886,
                    881, 928, 863, 817, 753, 695, 687, 685, 622, 618,
                    524, 537, 497, 468, 439, 403, 357, 346, 296, 267,
                    254, 208, 202, 187, 172, 147, 115, 75, 86, 61,
                    51, 34, 48, 31, 17, 13, 8, 8, 3, 69
                ],
                femenino: [
                    476, 648, 737, 797, 866, 927, 880, 886, 969, 1033,
                    1052, 1006, 1001, 1020, 1071, 1082, 1026, 1018, 919, 875,
                    958, 961, 975, 1013, 1016, 1062, 1096, 1187, 1216, 1229,
                    1376, 1345, 1309, 1406, 1398, 1451, 1423, 1263, 1226, 1132,
                    1096, 1123, 1182, 1163, 1098, 1051, 976, 1011, 1075, 1092,
                    1158, 1062, 1021, 924, 896, 1033, 1102, 1102, 993, 1105,
                    1007, 1032, 1041, 979, 880, 814, 821, 840, 732, 700,
                    635, 681, 586, 554, 555, 520, 480, 433, 389, 384,
                    361, 285, 261, 265, 246, 212, 167, 157, 134, 125,
                    100, 74, 67, 52, 53, 57, 34, 17, 14, 33
                ]
            },
            // Datos INE estimados para comparativa
            datosINE: {
                total: 158790,
                sexo: {
                    masculino: 76950,
                    femenino: 81840
                },
                edades: {
                    "0-9": 18250,
                    "10-19": 19520,
                    "20-64": 96850,
                    "65+": 24170
                }
            },
            // Tendencia histórica (para gráfico de tendencias)
            tendencia: {
                años: ["2020", "2021", "2022", "2023", "2024"],
                población: [141250, 143860, 145925, 148230, 150113],
                porSexo: {
                    masculino: [65840, 66975, 67892, 68912, 69729],
                    femenino: [75410, 76885, 78033, 79318, 80384]
                },
                porEdad: {
                    "0-9": [16890, 16750, 16620, 16610, 16579],
                    "10-19": [19850, 19960, 20150, 20280, 20368],
                    "20-64": [86350, 87950, 89180, 90850, 92069],
                    "65+": [18160, 19200, 19975, 20490, 21097]
                }
            }
        };

        // Configuración de colores
        const colores = {
            centros: [
                'rgba(26, 115, 232, 0.8)',
                'rgba(66, 133, 244, 0.8)',
                'rgba(52, 168, 83, 0.8)',
                'rgba(251, 188, 4, 0.8)',
                'rgba(234, 67, 53, 0.8)',
                'rgba(103, 58, 183, 0.8)'
            ],
            edades: {
                "0-9": 'rgba(52, 168, 83, 0.8)',
                "10-19": 'rgba(66, 133, 244, 0.8)',
                "20-64": 'rgba(251, 188, 4, 0.8)',
                "65+": 'rgba(234, 67, 53, 0.8)'
            },
            sexo: {
                masculino: 'rgba(66, 133, 244, 0.8)',
                femenino: 'rgba(234, 67, 53, 0.8)'
            },
            comparativa: {
                inscrita: 'rgba(52, 168, 83, 0.8)',
                ine: 'rgba(103, 58, 183, 0.8)'
            }
        };

        // DOM Elements
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar elementos de UI
            initUI();
            
            // Iniciar carga de datos
            showLoading();
            
            // Simular carga de datos (en una implementación real, aquí iría la carga desde la base de datos)
            setTimeout(() => {
                // Inicializar gráficos
                initCharts();
                
                // Actualizar estadísticas
                updateStats();
                
                // Ocultar carga
                hideLoading();
                
                // Mostrar notificación de datos cargados
                showNotification('Datos cargados correctamente', 'success');
            }, 1000);
        });

        // Inicialización de UI
        function initUI() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + '-tab').classList.add('active');
                });
            });

            // Modal Export
            document.getElementById('exportBtn').addEventListener('click', function() {
                document.getElementById('exportModal').classList.add('active');
            });

            document.getElementById('closeExportModal').addEventListener('click', function() {
                document.getElementById('exportModal').classList.remove('active');
            });

            document.getElementById('cancelExport').addEventListener('click', function() {
                document.getElementById('exportModal').classList.remove('active');
            });

            document.getElementById('confirmExport').addEventListener('click', function() {
                // Simular exportación
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    document.getElementById('exportModal').classList.remove('active');
                    showNotification('Datos exportados correctamente', 'success');
                }, 1500);
            });

            // Help Modal
            document.getElementById('helpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').classList.add('active');
            });

            document.getElementById('closeHelpModal').addEventListener('click', function() {
                document.getElementById('helpModal').classList.remove('active');
            });

            document.getElementById('closeHelpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').classList.remove('active');
            });

            // Print
            document.getElementById('printBtn').addEventListener('click', function() {
                window.print();
            });

            // Filters
            document.getElementById('applyFilters').addEventListener('click', function() {
                showLoading();
                setTimeout(() => {
                    updateCharts();
                    updateStats();
                    hideLoading();
                    showNotification('Filtros aplicados correctamente', 'success');
                }, 800);
            });

            document.getElementById('resetFilters').addEventListener('click', function() {
                // Reset all filters to default
                document.getElementById('yearFilter').value = '2024';
                document.getElementById('communeFilter').value = 'curico';
                document.getElementById('centerFilter').value = 'all';
                document.getElementById('maleFilter').checked = true;
                document.getElementById('femaleFilter').checked = true;
                document.getElementById('infantilFilter').checked = true;
                document.getElementById('adolescenteFilter').checked = true;
                document.getElementById('adultoFilter').checked = true;
                document.getElementById('adultoMayorFilter').checked = true;
                document.getElementById('ageRangeMin').value = 0;
                document.getElementById('ageRangeMax').value = 99;
                document.getElementById('ageRangeMinValue').textContent = 0;
                document.getElementById('ageRangeMaxValue').textContent = 99;
                
                // Apply reset filters
                showLoading();
                setTimeout(() => {
                    updateCharts();
                    updateStats();
                    hideLoading();
                    showNotification('Filtros restablecidos', 'info');
                }, 800);
            });

            // Range slider values
            document.getElementById('ageRangeMin').addEventListener('input', function() {
                document.getElementById('ageRangeMinValue').textContent = this.value;
            });

            document.getElementById('ageRangeMax').addEventListener('input', function() {
                document.getElementById('ageRangeMaxValue').textContent = this.value;
            });

            // Generate report
            document.getElementById('generateReport').addEventListener('click', function() {
                const reportType = document.getElementById('reportTemplate').value;
                if (!reportType) {
                    showNotification('Por favor seleccione un tipo de informe', 'warning');
                    return;
                }
                
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    showNotification('Informe generado correctamente', 'success');
                    
                    // En una implementación real, aquí se generaría el informe específico
                    // Por ahora solo cambiamos a la pestaña más relevante según el informe
                    switch(reportType) {
                        case 'report_distribution':
                            document.querySelector('[data-tab="overview"]').click();
                            break;
                        case 'report_age_gender':
                            document.querySelector('[data-tab="demographics"]').click();
                            break;
                        case 'report_comparison':
                            document.querySelector('[data-tab="comparison"]').click();
                            break;
                        case 'report_geo':
                            document.querySelector('[data-tab="geographical"]').click();
                            break;
                        case 'report_trends':
                            document.querySelector('[data-tab="overview"]').click();
                            break;
                        case 'report_full':
                            document.querySelector('[data-tab="overview"]').click();
                            break;
                    }
                }, 1200);
            });
        }

        // Inicialización de gráficos
        function initCharts() {
            // Gráfico de distribución por centro de salud
            const distributionCtx = document.getElementById('distributionChart').getContext('2d');
            const distributionData = {
                labels: Object.values(poblacionData.centros).map(centro => centro.nombre),
                datasets: [{
                    label: 'Población',
                    data: Object.values(poblacionData.centros).map(centro => centro.total),
                    backgroundColor: colores.centros,
                    borderWidth: 1
                }]
            };
            
            const distributionChart = new Chart(distributionCtx, {
                type: 'pie',
                data: distributionData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de pirámide poblacional
            const pyramidCtx = document.getElementById('pyramidChart').getContext('2d');
            
            // Agrupar datos de pirámide para mejor visualización
            const pyramidLabels = [];
            const pyramidMale = [];
            const pyramidFemale = [];
            
            // Agrupar por rangos de 5 años
            for (let i = 0; i < poblacionData.piramide.grupos.length; i += 5) {
                const rangoEdad = i === 95 ? `${i}+` : `${i}-${i+4}`;
                pyramidLabels.push(rangoEdad);
                
                let sumaMale = 0;
                let sumaFemale = 0;
                
                for (let j = 0; j < 5 && (i + j) < poblacionData.piramide.grupos.length; j++) {
                    sumaMale += poblacionData.piramide.masculino[i + j];
                    sumaFemale += poblacionData.piramide.femenino[i + j];
                }
                
                pyramidMale.push(-sumaMale); // Valores negativos para visualización
                pyramidFemale.push(sumaFemale);
            }
            
            const pyramidData = {
                labels: pyramidLabels,
                datasets : [{
                    label: 'Hombres',
                    data: pyramidMale,
                    backgroundColor: colores.sexo.masculino,
                    borderWidth: 1
                }, {
                    label: 'Mujeres',
                    data: pyramidFemale,
                    backgroundColor: colores.sexo.femenino,
                    borderWidth: 1
                }]
            };
            
            const pyramidChart = new Chart(pyramidCtx, {
                type: 'bar',
                data: pyramidData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                callback: function(value) {
                                    return Math.abs(value).toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Población'
                            }
                        },
                        y: {
                            stacked: true,
                            reverse: true,
                            title: {
                                display: true,
                                text: 'Grupos de Edad'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = Math.abs(context.parsed.x);
                                    return `${context.dataset.label}: ${value.toLocaleString()}`;
                                }
                            }
                        },
                        title: {
                            display: false,
                            text: 'Pirámide Poblacional'
                        }
                    }
                }
            });

            // Gráfico de grupos de edad (dona)
            const ageGroupsCtx = document.getElementById('ageGroupsChart').getContext('2d');
            const ageGroupsData = {
                labels: Object.keys(poblacionData.comuna.edades),
                datasets: [{
                    data: Object.values(poblacionData.comuna.edades),
                    backgroundColor: Object.values(colores.edades),
                    borderWidth: 1
                }]
            };
            
            const ageGroupsChart = new Chart(ageGroupsCtx, {
                type: 'doughnut',
                data: ageGroupsData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de tendencias históricas
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            const trendsData = {
                labels: poblacionData.tendencia.años,
                datasets: [{
                    label: 'Población Total',
                    data: poblacionData.tendencia.población,
                    borderColor: 'rgba(66, 133, 244, 1)',
                    backgroundColor: 'rgba(66, 133, 244, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1
                }, {
                    label: 'Masculino',
                    data: poblacionData.tendencia.porSexo.masculino,
                    borderColor: colores.sexo.masculino,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                }, {
                    label: 'Femenino',
                    data: poblacionData.tendencia.porSexo.femenino,
                    borderColor: colores.sexo.femenino,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                }]
            };
            
            const trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: trendsData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Población'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Año'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // Gráfico de distribución por sexo y edad
            const genderAgeCtx = document.getElementById('genderAgeChart').getContext('2d');
            
            // Preparar datos para el gráfico de barras apiladas
            const genderAgeLabels = Object.keys(poblacionData.comuna.edades);
            const maleData = Object.keys(poblacionData.comuna.edades).map(key => {
                // Calculamos el porcentaje de hombres para cada grupo de edad
                const total = Object.values(poblacionData.centros).reduce((sum, centro) => sum + centro.edades[key], 0);
                const male = Object.values(poblacionData.centros).reduce((sum, centro) => {
                    const centroTotal = centro.edades[key];
                    const maleRatio = centro.sexo.masculino / (centro.sexo.masculino + centro.sexo.femenino);
                    return sum + (centroTotal * maleRatio);
                }, 0);
                return Math.round(male);
            });
            
            const femaleData = Object.keys(poblacionData.comuna.edades).map(key => {
                // Calculamos el porcentaje de mujeres para cada grupo de edad
                const total = Object.values(poblacionData.centros).reduce((sum, centro) => sum + centro.edades[key], 0);
                const female = Object.values(poblacionData.centros).reduce((sum, centro) => {
                    const centroTotal = centro.edades[key];
                    const femaleRatio = centro.sexo.femenino / (centro.sexo.masculino + centro.sexo.femenino);
                    return sum + (centroTotal * femaleRatio);
                }, 0);
                return Math.round(female);
            });
            
            const genderAgeData = {
                labels: genderAgeLabels,
                datasets: [{
                    label: 'Masculino',
                    data: maleData,
                    backgroundColor: colores.sexo.masculino,
                    borderWidth: 1
                }, {
                    label: 'Femenino',
                    data: femaleData,
                    backgroundColor: colores.sexo.femenino,
                    borderWidth: 1
                }]
            };
            
            const genderAgeChart = new Chart(genderAgeCtx, {
                type: 'bar',
                data: genderAgeData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Grupo de Edad'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Población'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return `${context.dataset.label}: ${value.toLocaleString()}`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // Gráfico de población por centro y grupo etario
            const centerAgeCtx = document.getElementById('centerAgeChart').getContext('2d');
            
            // Preparar datos
            const centerAgeDatasets = [];
            const edadLabels = Object.keys(poblacionData.comuna.edades);
            
            // Para cada centro, crear un dataset
            Object.keys(poblacionData.centros).forEach((centroKey, index) => {
                const centro = poblacionData.centros[centroKey];
                centerAgeDatasets.push({
                    label: centro.nombre,
                    data: Object.values(centro.edades),
                    backgroundColor: colores.centros[index],
                    borderWidth: 1
                });
            });
            
            const centerAgeData = {
                labels: edadLabels,
                datasets: centerAgeDatasets
            };
            
            const centerAgeChart = new Chart(centerAgeCtx, {
                type: 'bar',
                data: centerAgeData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Grupo de Edad'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Población'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return `${context.dataset.label}: ${value.toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico detallado por edad
            const detailedAgeCtx = document.getElementById('detailedAgeChart').getContext('2d');
            
            // Utilizamos los datos de la pirámide pero agrupamos por rangos de 10 años para mejor visualización
            const detailedAgeLabels = [];
            const detailedAgeData = [];
            
            for (let i = 0; i < poblacionData.piramide.grupos.length; i += 10) {
                const rangoEdad = i + 10 >= poblacionData.piramide.grupos.length ? 
                    `${i}+` : `${i}-${i+9}`;
                detailedAgeLabels.push(rangoEdad);
                
                let suma = 0;
                for (let j = 0; j < 10 && (i + j) < poblacionData.piramide.grupos.length; j++) {
                    suma += poblacionData.piramide.masculino[i + j] + poblacionData.piramide.femenino[i + j];
                }
                
                detailedAgeData.push(suma);
            }
            
            const detailedAgeChartData = {
                labels: detailedAgeLabels,
                datasets: [{
                    label: 'Población',
                    data: detailedAgeData,
                    backgroundColor: 'rgba(66, 133, 244, 0.8)',
                    borderWidth: 1
                }]
            };
            
            const detailedAgeChartObj = new Chart(detailedAgeCtx, {
                type: 'bar',
                data: detailedAgeChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Población'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Rango de Edad'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `Población: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de comparación INE vs Inscrita
            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            
            // Preparar datos
            const comparisonLabels = Object.keys(poblacionData.comuna.edades);
            const comparisonInscrita = Object.values(poblacionData.comuna.edades);
            const comparisonINE = Object.values(poblacionData.datosINE.edades);
            
            const comparisonData = {
                labels: comparisonLabels,
                datasets: [{
                    label: 'Población Inscrita',
                    data: comparisonInscrita,
                    backgroundColor: colores.comparativa.inscrita,
                    borderWidth: 1
                }, {
                    label: 'Población INE',
                    data: comparisonINE,
                    backgroundColor: colores.comparativa.ine,
                    borderWidth: 1
                }]
            };
            
            const comparisonChart = new Chart(comparisonCtx, {
                type: 'bar',
                data: comparisonData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Grupo de Edad'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Población'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return `${context.dataset.label}: ${value.toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de cobertura por grupo etario
            const coverageCtx = document.getElementById('coverageChart').getContext('2d');
            
            // Calcular tasas de cobertura (Inscritos / INE) * 100
            const coverageLabels = Object.keys(poblacionData.comuna.edades);
            const coverageData = coverageLabels.map((key, index) => {
                const inscrita = poblacionData.comuna.edades[key];
                const ine = poblacionData.datosINE.edades[key];
                return ((inscrita / ine) * 100).toFixed(1);
            });
            
            const coverageChartData = {
                labels: coverageLabels,
                datasets: [{
                    label: 'Tasa de Cobertura (%)',
                    data: coverageData,
                    backgroundColor: 'rgba(52, 168, 83, 0.8)',
                    borderColor: 'rgba(52, 168, 83, 1)',
                    borderWidth: 1
                }]
            };
            
            const coverageChartObj = new Chart(coverageCtx, {
                type: 'line',
                data: coverageChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Cobertura (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Grupo de Edad'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Cobertura: ${context.raw}%`;
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.3
                        },
                        point: {
                            radius: 5,
                            hitRadius: 10,
                            hoverRadius: 7
                        }
                    }
                }
            });

            // Gráfico de comparación de sexo: INE vs Inscrita
            const genderComparisonCtx = document.getElementById('genderComparisonChart').getContext('2d');
            
            // Preparar datos
            const genderComparisonData = {
                labels: ['Masculino', 'Femenino'],
                datasets: [{
                    label: 'Población Inscrita',
                    data: [
                        poblacionData.comuna.sexo.masculino,
                        poblacionData.comuna.sexo.femenino
                    ],
                    backgroundColor: colores.comparativa.inscrita,
                    borderWidth: 1
                }, {
                    label: 'Población INE',
                    data: [
                        poblacionData.datosINE.sexo.masculino,
                        poblacionData.datosINE.sexo.femenino
                    ],
                    backgroundColor: colores.comparativa.ine,
                    borderWidth: 1
                }]
            };
            
            const genderComparisonChart = new Chart(genderComparisonCtx, {
                type: 'bar',
                data: genderComparisonData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Sexo'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Población'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.dataset.label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Inicializar mapa de Leaflet
            const mapChart = L.map('mapChart').setView([poblacionData.comuna.geolocalizacion.lat, poblacionData.comuna.geolocalizacion.lng], 12);
            
            // Añadir capa de mapa base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapChart);
            
            // Añadir marcadores para cada centro de salud
            Object.keys(poblacionData.centros).forEach(centroKey => {
                const centro = poblacionData.centros[centroKey];
                
                // Añadir marcador
                const marker = L.marker([centro.geolocalizacion.lat, centro.geolocalizacion.lng])
                    .addTo(mapChart)
                    .bindPopup(`
                        <strong>${centro.nombre}</strong><br>
                        Población Total: ${centro.total.toLocaleString()}<br>
                        Masculino: ${centro.sexo.masculino.toLocaleString()}<br>
                        Femenino: ${centro.sexo.femenino.toLocaleString()}
                    `);
                
                // Añadir círculo que representa el área de cobertura
                const circle = L.circle([centro.geolocalizacion.lat, centro.geolocalizacion.lng], {
                    color: 'blue',
                    fillColor: '#30f',
                    fillOpacity: 0.1,
                    radius: centro.geolocalizacion.radio * 1000 // En metros
                }).addTo(mapChart);
            });

            // Gráfico de densidad poblacional por sector
            const densityCtx = document.getElementById('densityChart').getContext('2d');
            
            // Calcular densidad (población / radio^2 * PI)
            const densityLabels = Object.values(poblacionData.centros).map(centro => centro.nombre);
            const densityData = Object.values(poblacionData.centros).map(centro => {
                const area = Math.PI * Math.pow(centro.geolocalizacion.radio, 2);
                return Math.round(centro.total / area);
            });
            
            const densityChartData = {
                labels: densityLabels,
                datasets: [{
                    label: 'Densidad (hab/km²)',
                    data: densityData,
                    backgroundColor: colores.centros,
                    borderWidth: 1
                }]
            };
            
            const densityChartObj = new Chart(densityCtx, {
                type: 'bar',
                data: densityChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Densidad Poblacional (hab/km²)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Densidad: ${context.raw.toLocaleString()} hab/km²`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de cobertura por área de servicio
            const serviceAreaCtx = document.getElementById('serviceAreaChart').getContext('2d');
            
            // Calcular población por área de servicio
            const serviceAreaLabels = Object.values(poblacionData.centros).map(centro => centro.nombre);
            const populationData = Object.values(poblacionData.centros).map(centro => centro.total);
            const areaData = Object.values(poblacionData.centros).map(centro => 
                Math.PI * Math.pow(centro.geolocalizacion.radio, 2) // Área en km²
            );
            
            const serviceAreaChartData = {
                labels: serviceAreaLabels,
                datasets: [{
                    type: 'bar',
                    label: 'Población',
                    data: populationData,
                    backgroundColor: 'rgba(66, 133, 244, 0.8)',
                    borderColor: 'rgba(66, 133, 244, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    type: 'line',
                    label: 'Área de Cobertura (km²)',
                    data: areaData,
                    backgroundColor: 'rgba(234, 67, 53, 0.2)',
                    borderColor: 'rgba(234, 67, 53, 1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y1'
                }]
            };
            
            const serviceAreaChartObj = new Chart(serviceAreaCtx, {
                type: 'scatter',
                data: serviceAreaChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Población'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Área (km²)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });

            // Almacenar referencias a los gráficos para futuras actualizaciones
            window.dashboardCharts = {
                distributionChart,
                pyramidChart,
                ageGroupsChart,
                trendsChart,
                genderAgeChart,
                centerAgeChart,
                detailedAgeChartObj,
                comparisonChart,
                coverageChartObj,
                genderComparisonChart,
                densityChartObj,
                serviceAreaChartObj,
                mapChart
            };
        }

        // Actualizar estadísticas del dashboard
        function updateStats() {
            // En una implementación real, estos valores se calcularían dinámicamente
            // según los filtros aplicados. Aquí solo mostramos los valores estáticos.
            document.getElementById('totalPopulation').textContent = poblacionData.comuna.total.toLocaleString();
            
            const malePercentage = ((poblacionData.comuna.sexo.masculino / poblacionData.comuna.total) * 100).toFixed(1);
            const femalePercentage = ((poblacionData.comuna.sexo.femenino / poblacionData.comuna.total) * 100).toFixed(1);
            document.getElementById('genderRatio').textContent = `${malePercentage}% / ${femalePercentage}%`;
            
            document.getElementById('averageAge').textContent = '38.2';
            
            const pediatricPercentage = ((poblacionData.comuna.edades["0-9"] / poblacionData.comuna.total) * 100).toFixed(1);
            document.getElementById('pediatricPopulation').textContent = `${pediatricPercentage}%`;
        }

        // Actualizar gráficos según filtros
        function updateCharts() {
            // En una implementación real, esta función filtraría los datos según los criterios
            // y actualizaría cada gráfico con los nuevos datos. Aquí solo simulamos la actualización.
            
            // Obtener valores de filtros
            const yearFilter = document.getElementById('yearFilter').value;
            const communeFilter = document.getElementById('communeFilter').value;
            const centerFilter = document.getElementById('centerFilter').value;
            const maleFilter = document.getElementById('maleFilter').checked;
            const femaleFilter = document.getElementById('femaleFilter').checked;
            const infantilFilter = document.getElementById('infantilFilter').checked;
            const adolescenteFilter = document.getElementById('adolescenteFilter').checked;
            const adultoFilter = document.getElementById('adultoFilter').checked;
            const adultoMayorFilter = document.getElementById('adultoMayorFilter').checked;
            const ageRangeMin = parseInt(document.getElementById('ageRangeMin').value);
            const ageRangeMax = parseInt(document.getElementById('ageRangeMax').value);
            
            // Actualizar lista de filtros en modal de exportación
            document.getElementById('exportFiltersList').innerHTML = `
                <li>Año: ${yearFilter}</li>
                <li>Comuna: ${communeFilter === 'curico' ? 'Curicó' : communeFilter}</li>
                <li>Centro de Salud: ${centerFilter === 'all' ? 'Todos' : poblacionData.centros[centerFilter].nombre}</li>
                <li>Sexo: ${maleFilter && femaleFilter ? 'Ambos' : maleFilter ? 'Masculino' : femaleFilter ? 'Femenino' : 'Ninguno'}</li>
                <li>Grupos Etarios: ${[
                    infantilFilter ? '0-9' : null,
                    adolescenteFilter ? '10-19' : null,
                    adultoFilter ? '20-64' : null,
                    adultoMayorFilter ? '≥65' : null
                ].filter(Boolean).join(', ') || 'Ninguno'}</li>
                <li>Rango de Edad: ${ageRangeMin} - ${ageRangeMax}</li>
            `;
            
            // En una implementación real, aquí se filtrarían los datos y se actualizarían los gráficos
            console.log('Filtros aplicados:', {
                year: yearFilter,
                commune: communeFilter,
                center: centerFilter,
                male: maleFilter,
                female: femaleFilter,
                infantil: infantilFilter,
                adolescente: adolescenteFilter,
                adulto: adultoFilter,
                adultoMayor: adultoMayorFilter,
                ageRange: [ageRangeMin, ageRangeMax]
            });
        }

        // Funciones de utilidad UI
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('.notification-icon i');
            const messageEl = notification.querySelector('.notification-message');
            
            // Configurar tipo
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
                notification.style.backgroundColor = '#323232';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
                notification.style.backgroundColor = '#FFA000';
            } else if (type === 'error') {
                icon.className = 'fas fa-times-circle';
                notification.style.backgroundColor = '#D32F2F';
            } else {
                icon.className = 'fas fa-info-circle';
                notification.style.backgroundColor = '#323232';
            }
            
            // Actualizar mensaje
            messageEl.textContent = message;
            
            // Mostrar notificación
            notification.classList.add('show');
            
            // Ocultar automáticamente
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Funciones para exportación de datos
        function exportToExcel() {
            // En una implementación real, esta función exportaría los datos a Excel
            console.log('Exportando a Excel...');
            showNotification('Datos exportados a Excel correctamente', 'success');
        }
        
        function exportToPDF() {
            // En una implementación real, esta función exportaría los datos a PDF
            console.log('Exportando a PDF...');
            showNotification('Datos exportados a PDF correctamente', 'success');
        }
        
        function exportToCSV() {
            // En una implementación real, esta función exportaría los datos a CSV
            console.log('Exportando a CSV...');
            showNotification('Datos exportados a CSV correctamente', 'success');
        }

        // Inicializar tooltips para botones de acción
        function initTooltips() {
            const tooltip = document.getElementById('tooltip');
            
            // Selector de elementos con tooltips
            const elementsWithTooltips = document.querySelectorAll('[data-tooltip]');
            
            elementsWithTooltips.forEach(element => {
                element.addEventListener('mouseenter', function(e) {
                    const tooltipText = this.getAttribute('data-tooltip');
                    tooltip.textContent = tooltipText;
                    tooltip.style.opacity = 1;
                    
                    // Posicionar tooltip
                    const rect = this.getBoundingClientRect();
                    tooltip.style.top = `${rect.top - tooltip.offsetHeight - 5}px`;
                    tooltip.style.left = `${rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2)}px`;
                });
                
                element.addEventListener('mouseleave', function() {
                    tooltip.style.opacity = 0;
                });
            });
        }

        // Función para generar informes predefinidos
        function generateReport(reportType) {
            showLoading();
            
            // En una implementación real, esta función generaría el informe específico
            setTimeout(() => {
                hideLoading();
                
                switch(reportType) {
                    case 'report_distribution':
                        showNotification('Informe de Distribución generado correctamente', 'success');
                        break;
                    case 'report_age_gender':
                        showNotification('Informe de Distribución por Edad y Sexo generado correctamente', 'success');
                        break;
                    case 'report_comparison':
                        showNotification('Informe Comparativo generado correctamente', 'success');
                        break;
                    case 'report_trends':
                        showNotification('Informe de Tendencias generado correctamente', 'success');
                        break;
                    case 'report_geo':
                        showNotification('Informe Geográfico generado correctamente', 'success');
                        break;
                    case 'report_full':
                        showNotification('Informe Completo generado correctamente', 'success');
                        break;
                    default:
                        showNotification('Tipo de informe no válido', 'error');
                }
            }, 1500);
        }

        // Añadir funcionalidad de pantalla completa a los gráficos
        function initFullscreenButtons() {
            // Función genérica para hacer toggle de pantalla completa
            function toggleFullscreen(elementId) {
                const element = document.getElementById(elementId);
                
                if (!document.fullscreenElement) {
                    if (element.requestFullscreen) {
                        element.requestFullscreen();
                    } else if (element.mozRequestFullScreen) {
                        element.mozRequestFullScreen();
                    } else if (element.webkitRequestFullscreen) {
                        element.webkitRequestFullscreen();
                    } else if (element.msRequestFullscreen) {
                        element.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            }
            
            // Configurar botones de pantalla completa para cada gráfico
            document.getElementById('fullscreenDistributionChart').addEventListener('click', () => 
                toggleFullscreen('distributionChart'));
            
            document.getElementById('fullscreenPyramidChart').addEventListener('click', () => 
                toggleFullscreen('pyramidChart'));
            
            document.getElementById('fullscreenAgeGroupsChart').addEventListener('click', () => 
                toggleFullscreen('ageGroupsChart'));
            
            document.getElementById('fullscreenTrendsChart').addEventListener('click', () => 
                toggleFullscreen('trendsChart'));
            
            document.getElementById('fullscreenGenderAgeChart').addEventListener('click', () => 
                toggleFullscreen('genderAgeChart'));
            
            document.getElementById('fullscreenCenterAgeChart').addEventListener('click', () => 
                toggleFullscreen('centerAgeChart'));
            
            document.getElementById('fullscreenDetailedAgeChart').addEventListener('click', () => 
                toggleFullscreen('detailedAgeChart'));
            
            document.getElementById('fullscreenComparisonChart').addEventListener('click', () => 
                toggleFullscreen('comparisonChart'));
            
            document.getElementById('fullscreenCoverageChart').addEventListener('click', () => 
                toggleFullscreen('coverageChart'));
            
            document.getElementById('fullscreenGenderComparisonChart').addEventListener('click', () => 
                toggleFullscreen('genderComparisonChart'));
            
            document.getElementById('fullscreenMap').addEventListener('click', () => 
                toggleFullscreen('mapChart'));
            
            document.getElementById('fullscreenDensityChart').addEventListener('click', () => 
                toggleFullscreen('densityChart'));
            
            document.getElementById('fullscreenServiceAreaChart').addEventListener('click', () => 
                toggleFullscreen('serviceAreaChart'));
            
            document.getElementById('fullscreenTable').addEventListener('click', () => 
                toggleFullscreen('populationTable'));
            
            document.getElementById('fullscreenAgeTable').addEventListener('click', () => 
                toggleFullscreen('ageGroupTable'));
        }

        // Inicializar botones de descarga para gráficos
        function initDownloadButtons() {
            // Función genérica para descargar un gráfico como imagen
            function downloadChart(chartId, filename) {
                const canvas = document.getElementById(chartId);
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
            
            // Configurar botones de descarga para cada gráfico
            document.getElementById('downloadDistributionChart').addEventListener('click', () => 
                downloadChart('distributionChart', 'distribucion_centros_salud.png'));
            
            document.getElementById('downloadPyramidChart').addEventListener('click', () => 
                downloadChart('pyramidChart', 'piramide_poblacional.png'));
            
            document.getElementById('downloadAgeGroupsChart').addEventListener('click', () => 
                downloadChart('ageGroupsChart', 'grupos_etarios.png'));
            
            document.getElementById('downloadTrendsChart').addEventListener('click', () => 
                downloadChart('trendsChart', 'tendencias_poblacionales.png'));
            
            document.getElementById('downloadGenderAgeChart').addEventListener('click', () => 
                downloadChart('genderAgeChart', 'distribucion_sexo_edad.png'));
            
            document.getElementById('downloadCenterAgeChart').addEventListener('click', () => 
                downloadChart('centerAgeChart', 'centro_grupo_etario.png'));
            
            document.getElementById('downloadDetailedAgeChart').addEventListener('click', () => 
                downloadChart('detailedAgeChart', 'detalle_edad.png'));
            
            document.getElementById('downloadComparisonChart').addEventListener('click', () => 
                downloadChart('comparisonChart', 'comparativa_ine_inscrita.png'));
            
            document.getElementById('downloadCoverageChart').addEventListener('click', () => 
                downloadChart('coverageChart', 'tasa_cobertura.png'));
            
            document.getElementById('downloadGenderComparisonChart').addEventListener('click', () => 
                downloadChart('genderComparisonChart', 'comparativa_sexo.png'));
            
            document.getElementById('downloadMap').addEventListener('click', () => {
                // Para el mapa, usamos una biblioteca de captura HTML2Canvas
                showNotification('La descarga del mapa requiere HTML2Canvas', 'info');
            });
            
            document.getElementById('downloadDensityChart').addEventListener('click', () => 
                downloadChart('densityChart', 'densidad_poblacional.png'));
            
            document.getElementById('downloadServiceAreaChart').addEventListener('click', () => 
                downloadChart('serviceAreaChart', 'area_cobertura.png'));
            
            // Para las tablas, se usaría una función diferente para exportar a Excel
            document.getElementById('downloadTable').addEventListener('click', () => {
                exportToExcel('populationTable', 'datos_poblacionales.xlsx');
            });
            
            document.getElementById('downloadAgeTable').addEventListener('click', () => {
                exportToExcel('ageGroupTable', 'grupos_edad_detalle.xlsx');
            });
        }

        // Función para exportar tablas a Excel
        function exportToExcel(tableId, filename) {
            // En una implementación real, esta función utilizaría SheetJS para exportar la tabla a Excel
            console.log(`Exportando tabla ${tableId} a Excel como ${filename}...`);
            showNotification(`Tabla exportada a Excel como ${filename}`, 'success');
        }

        // Función para modo oscuro
        function initDarkModeToggle() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.style.setProperty('--primary-color', '#5c6bc0');
                    document.documentElement.style.setProperty('--secondary-color', '#7986cb');
                    document.documentElement.style.setProperty('--text-color', '#e0e0e0');
                    document.documentElement.style.setProperty('--light-gray', '#424242');
                    document.documentElement.style.setProperty('--medium-gray', '#616161');
                    document.documentElement.style.setProperty('--dark-gray', '#9e9e9e');
                    document.body.style.backgroundColor = '#303030';
                    
                    // Actualizar estilos de componentes
                    document.querySelectorAll('.chart-container, .table-container, .stat-card, .sidebar').forEach(el => {
                        el.style.backgroundColor = '#424242';
                        el.style.color = '#e0e0e0';
                    });
                    
                    document.querySelectorAll('table th, table td').forEach(el => {
                        el.style.borderColor = '#616161';
                    });
                    
                    // Actualizar gráficos
                    updateChartsTheme(true);
                    
                    showNotification('Modo oscuro activado', 'info');
                } else {
                    // Restaurar tema claro
                    document.documentElement.style.setProperty('--primary-color', '#1a73e8');
                    document.documentElement.style.setProperty('--secondary-color', '#4285f4');
                    document.documentElement.style.setProperty('--text-color', '#212121');
                    document.documentElement.style.setProperty('--light-gray', '#f5f5f5');
                    document.documentElement.style.setProperty('--medium-gray', '#e0e0e0');
                    document.documentElement.style.setProperty('--dark-gray', '#757575');
                    document.body.style.backgroundColor = '#f9fafb';
                    
                    // Restaurar estilos de componentes
                    document.querySelectorAll('.chart-container, .table-container, .stat-card, .sidebar').forEach(el => {
                        el.style.backgroundColor = 'white';
                        el.style.color = '#212121';
                    });
                    
                    document.querySelectorAll('table th, table td').forEach(el => {
                        el.style.borderColor = '#e0e0e0';
                    });
                    
                    // Actualizar gráficos
                    updateChartsTheme(false);
                    
                    showNotification('Modo claro restaurado', 'info');
                }
            });
        }

        // Actualizar tema de gráficos
        function updateChartsTheme(darkMode) {
            // En una implementación real, esta función actualizaría las opciones de todos los gráficos
            // para adaptarlos al tema oscuro o claro
            console.log(`Actualizando tema de gráficos a ${darkMode ? 'oscuro' : 'claro'}...`);
            
            if (window.dashboardCharts) {
                const textColor = darkMode ? '#e0e0e0' : '#666';
                const gridColor = darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                
                // Actualizar opciones comunes
                Object.values(window.dashboardCharts).forEach(chart => {
                    if (chart.options && chart.options.scales) {
                        // Actualizar ejes
                        if (chart.options.scales.x) {
                            chart.options.scales.x.grid = { color: gridColor };
                            chart.options.scales.x.ticks = { color: textColor };
                            if (chart.options.scales.x.title) {
                                chart.options.scales.x.title.color = textColor;
                            }
                        }
                        
                        if (chart.options.scales.y) {
                            chart.options.scales.y.grid = { color: gridColor };
                            chart.options.scales.y.ticks = { color: textColor };
                            if (chart.options.scales.y.title) {
                                chart.options.scales.y.title.color = textColor;
                            }
                        }
                        
                        if (chart.options.scales.y1) {
                            chart.options.scales.y1.grid = { color: gridColor };
                            chart.options.scales.y1.ticks = { color: textColor };
                            if (chart.options.scales.y1.title) {
                                chart.options.scales.y1.title.color = textColor;
                            }
                        }
                    }
                    
                    // Actualizar leyendas
                    if (chart.options && chart.options.plugins && chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels = { color: textColor };
                    }
                    
                    // Actualizar títulos
                    if (chart.options && chart.options.plugins && chart.options.plugins.title) {
                        chart.options.plugins.title.color = textColor;
                    }
                    
                    // Actualizar gráfico
                    if (chart.update) {
                        chart.update();
                    }
                });
            }
        }

        // Inicializar funcionalidades adicionales
        function initAdditionalFunctionalities() {
            initTooltips();
            initFullscreenButtons();
            initDownloadButtons();
            initDarkModeToggle();
            
            // Auto-refresh toggle
            document.getElementById('autoRefreshToggle').addEventListener('change', function() {
                if (this.checked) {
                    window.autoRefreshInterval = setInterval(() => {
                        console.log('Auto-actualización...');
                        updateStats();
                        // En una implementación real, aquí se actualizarían los datos
                    }, 60000); // Actualizar cada minuto
                    
                    showNotification('Actualización automática activada', 'info');
                } else {
                    if (window.autoRefreshInterval) {
                        clearInterval(window.autoRefreshInterval);
                        window.autoRefreshInterval = null;
                    }
                    
                    showNotification('Actualización automática desactivada', 'info');
                }
            });
            
            // Live data toggle
            document.getElementById('liveDataToggle').addEventListener('change', function() {
                if (this.checked) {
                    showNotification('Datos en tiempo real activados', 'info');
                    // En una implementación real, aquí se activaría un WebSocket o SSE
                } else {
                    showNotification('Datos en tiempo real desactivados', 'info');
                    // En una implementación real, aquí se desactivaría la conexión
                }
            });
        }

        // Inicializar todo al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar elementos de UI
            initUI();
            
            // Iniciar carga de datos
            showLoading();
            
            // Simular carga de datos (en una implementación real, aquí iría la carga desde la base de datos)
            setTimeout(() => {
                // Inicializar gráficos
                initCharts();
                
                // Actualizar estadísticas
                updateStats();
                
                // Inicializar funcionalidades adicionales
                initAdditionalFunctionalities();
                
                // Ocultar carga
                hideLoading();
                
                // Mostrar notificación de datos cargados
                showNotification('Datos cargados correctamente', 'success');
            }, 1000);
        });

        // Módulo de Persistencia de Datos
        // En una implementación real, este módulo gestionaría la carga y guardado de datos
        const persistenceModule = {
            // Cargar datos del servidor
            loadData: function() {
                return new Promise((resolve, reject) => {
                    // Aquí iría la lógica para cargar datos desde una API o base de datos
                    setTimeout(() => {
                        resolve(poblacionData);
                    }, 500);
                });
            },
            
            // Guardar filtros de usuario
            saveUserPreferences: function(preferences) {
                localStorage.setItem('dashboardPreferences', JSON.stringify(preferences));
            },
            
            // Cargar filtros guardados
            loadUserPreferences: function() {
                const saved = localStorage.getItem('dashboardPreferences');
                return saved ? JSON.parse(saved) : null;
            },
            
            // Exportar datos actuales
            exportData: function(format) {
                return new Promise((resolve, reject) => {
                    // Aquí iría la lógica para exportar datos en diferentes formatos
                    setTimeout(() => {
                        resolve(`data_export.${format}`);
                    }, 500);
                });
            }
        };

        // Módulo de Análisis de Datos
        // En una implementación real, este módulo realizaría cálculos estadísticos avanzados
        const analyticsModule = {
            // Calcular estadísticas descriptivas
            calculateStats: function(data) {
                return {
                    mean: this.calculateMean(data),
                    median: this.calculateMedian(data),
                    mode: this.calculateMode(data),
                    stdDev: this.calculateStdDev(data)
                };
            },
            
            // Calcular media
            calculateMean: function(data) {
                return data.reduce((sum, value) => sum + value, 0) / data.length;
            },
            
            // Calcular mediana
            calculateMedian: function(data) {
                const sorted = [...data].sort((a, b) => a - b);
                const middle = Math.floor(sorted.length / 2);
                
                if (sorted.length % 2 === 0) {
                    return (sorted[middle - 1] + sorted[middle]) / 2;
                }
                
                return sorted[middle];
            },
            
            // Calcular moda
            calculateMode: function(data) {
                const frequency = {};
                data.forEach(value => {
                    frequency[value] = (frequency[value] || 0) + 1;
                });
                
                let maxFreq = 0;
                let mode = null;
                
                for (const [value, freq] of Object.entries(frequency)) {
                    if (freq > maxFreq) {
                        maxFreq = freq;
                        mode = parseFloat(value);
                    }
                }
                
                return mode;
            },
            
            // Calcular desviación estándar
            calculateStdDev: function(data) {
                const mean = this.calculateMean(data);
                const squareDiffs = data.map(value => Math.pow(value - mean, 2));
                const variance = this.calculateMean(squareDiffs);
                return Math.sqrt(variance);
            },
            
            // Proyectar tendencia futura
            projectTrend: function(historicalData, years) {
                // Implementar algoritmo de regresión lineal simple
                const n = historicalData.length;
                let sumX = 0;
                let sumY = 0;
                let sumXY = 0;
                let sumXX = 0;
                
                for (let i = 0; i < n; i++) {
                    sumX += i;
                    sumY += historicalData[i];
                    sumXY += i * historicalData[i];
                    sumXX += i * i;
                }
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                
                const projections = [];
                for (let i = 0; i < years; i++) {
                    projections.push(Math.round(intercept + slope * (n + i)));
                }
                
                return projections;
            }
        };

        // Módulo de Generación de Informes
        // En una implementación real, este módulo generaría informes detallados
        const reportModule = {
            // Generar informe completo
            generateFullReport: function() {
                return {
                    title: 'Informe Poblacional Completo',
                    date: new Date().toLocaleString(),
                    summary: this.generateSummary(),
                    tables: this.generateTables(),
                    charts: this.generateChartData(),
                    analysis: this.generateAnalysis()
                };
            },
            
            // Generar resumen ejecutivo
            generateSummary: function() {
                return {
                    totalPopulation: poblacionData.comuna.total,
                    malePercentage: ((poblacionData.comuna.sexo.masculino / poblacionData.comuna.total) * 100).toFixed(1),
                    femalePercentage: ((poblacionData.comuna.sexo.femenino / poblacionData.comuna.total) * 100).toFixed(1),
                    ageGroups: poblacionData.comuna.edades,
                    growthRate: '1.3%',
                    coverage: '94.5%'
                };
            },
            
            // Generar tablas de datos
            generateTables: function() {
                return {
                    populationByCenter: Object.values(poblacionData.centros).map(centro => ({
                        name: centro.nombre,
                        total: centro.total,
                        male: centro.sexo.masculino,
                        female: centro.sexo.femenino,
                        ageGroups: centro.edades
                    })),
                    
                    populationByAge: Object.entries(poblacionData.comuna.detalleEdades).map(([range, value]) => ({
                        range,
                        value,
                        percentage: ((value / poblacionData.comuna.total) * 100).toFixed(1)
                    })),
                    
                    comparison: Object.keys(poblacionData.comuna.edades).map(key => ({
                        ageGroup: key,
                        inscribed: poblacionData.comuna.edades[key],
                        ine: poblacionData.datosINE.edades[key],
                        coverage: ((poblacionData.comuna.edades[key] / poblacionData.datosINE.edades[key]) * 100).toFixed(1)
                    }))
                };
            },
            
            // Generar datos para gráficos
            generateChartData: function() {
                return {
                    distribution: {
                        labels: Object.values(poblacionData.centros).map(centro => centro.nombre),
                        data: Object.values(poblacionData.centros).map(centro => centro.total)
                    },
                    
                    pyramid: {
                        labels: pyramidLabels,
                        male: pyramidMale.map(Math.abs),
                        female: pyramidFemale
                    },
                    
                    trends: {
                        years: poblacionData.tendencia.años,
                        data: poblacionData.tendencia.población,
                        projection: analyticsModule.projectTrend(poblacionData.tendencia.población, 3)
                    }
                };
            },
            
            // Generar análisis de datos
            generateAnalysis: function() {
                return {
                    demographicChanges: 'La población de Curicó muestra una tendencia creciente del 1.3% anual, con un incremento notable en la población adulta mayor (≥65 años) que ha aumentado un 4.2% en el último año. La población infantil (0-9 años) ha disminuido ligeramente, lo que indica un proceso de envejecimiento poblacional.',
                    
                    centerComparison: 'El CESFAM Curicó Centro atiende al 27.7% de la población inscrita, siendo el de mayor cobertura. Le siguen el CESFAM Miguel Ángel Arenas López y el CESFAM Betty Muñoz Arce con 19.2% y 19.0% respectivamente. Los CESFAM Sarmiento y Los Niches son los de menor cobertura con 9.1% y 9.2% respectivamente.',
                    
                    coverageAnalysis: 'La cobertura general de la población inscrita respecto a la población INE es del 94.5%. El grupo etario con mayor cobertura es el de adultos mayores (≥65 años) con un 87.3%, mientras que el grupo de 20-64 años presenta la menor cobertura con un 95.1%. Esto sugiere la necesidad de fortalecer estrategias de inscripción en este último grupo.',
                    
                    recommendations: [
                        'Implementar estrategias de captación específicas para la población de 20-64 años.',
                        'Fortalecer los servicios geriátricos dado el crecimiento de la población adulta mayor.',
                        'Evaluar la distribución de recursos entre centros de salud considerando la densidad poblacional por área de cobertura.',
                        'Monitorear la tendencia decreciente de la población infantil para ajustar los servicios pediátricos.'
                    ]
                };
            },
            
            // Generar informe específico por tipo
            generateSpecificReport: function(type) {
                switch(type) {
                    case 'report_distribution':
                        return {
                            title: 'Informe de Distribución por Centro de Salud',
                            date: new Date().toLocaleString(),
                            content: {
                                summary: 'Análisis detallado de la distribución poblacional entre los diferentes centros de salud de Curicó.',
                                chartData: this.generateChartData().distribution,
                                tableData: this.generateTables().populationByCenter,
                                analysis: this.generateAnalysis().centerComparison
                            }
                        };
                    
                    case 'report_age_gender':
                        return {
                            title: 'Informe de Distribución por Edad y Sexo',
                            date: new Date().toLocaleString(),
                            content: {
                                summary: 'Análisis detallado de la distribución poblacional por grupos etarios y sexo.',
                                chartData: {
                                    pyramid: this.generateChartData().pyramid,
                                    ageGroups: {
                                        labels: Object.keys(poblacionData.comuna.edades),
                                        data: Object.values(poblacionData.comuna.edades)
                                    }
                                },
                                tableData: this.generateTables().populationByAge,
                                genderRatio: {
                                    male: ((poblacionData.comuna.sexo.masculino / poblacionData.comuna.total) * 100).toFixed(1),
                                    female: ((poblacionData.comuna.sexo.femenino / poblacionData.comuna.total) * 100).toFixed(1)
                                }
                            }
                        };
                    
                    case 'report_comparison':
                        return {
                            title: 'Informe Comparativo: Población Inscrita vs. INE',
                            date: new Date().toLocaleString(),
                            content: {
                                summary: 'Análisis comparativo entre la población inscrita en los centros de salud y las proyecciones del INE.',
                                tableData: this.generateTables().comparison,
                                coverage: {
                                    overall: ((poblacionData.comuna.total / poblacionData.datosINE.total) * 100).toFixed(1),
                                    byAgeGroup: Object.keys(poblacionData.comuna.edades).map(key => ({
                                        ageGroup: key,
                                        coverage: ((poblacionData.comuna.edades[key] / poblacionData.datosINE.edades[key]) * 100).toFixed(1)
                                    }))
                                },
                                analysis: this.generateAnalysis().coverageAnalysis
                            }
                        };
                    
                    default:
                        return this.generateFullReport();
                }
            }
        };

        // Sistema de Gestión de Usuarios
        // En una implementación real, este módulo gestionaría la autenticación y permisos
        const userModule = {
            // Usuario actual (simulado)
            currentUser: {
                id: '001',
                name: 'Administrador Sistema',
                role: 'admin',
                permissions: ['read', 'write', 'export', 'admin'],
                lastLogin: '2024-05-12T08:30:15'
            },
            
            // Verificar si el usuario tiene un permiso específico
            hasPermission: function(permission) {
                return this.currentUser.permissions.includes(permission);
            },
            
            // Registrar acción del usuario
            logAction: function(action, details) {
                console.log(`USER ACTION [${new Date().toISOString()}]: ${this.currentUser.name} (${this.currentUser.role}) - ${action}`, details);
            },
            
            // Obtener información del usuario actual
            getCurrentUser: function() {
                return { ...this.currentUser };
            }
        };

        // Sistema de Notificaciones
        // En una implementación real, este módulo gestionaría notificaciones y alertas
        const notificationSystem = {
            // Cola de notificaciones
            queue: [],
            
            // Añadir notificación a la cola
            addNotification: function(message, type = 'info', duration = 3000) {
                const notification = {
                    id: Date.now(),
                    message,
                    type,
                    duration
                };
                
                this.queue.push(notification);
                this.processQueue();
                
                return notification.id;
            },
            
            // Procesar cola de notificaciones
            processQueue: function() {
                if (this.queue.length > 0 && !this.processing) {
                    this.processing = true;
                    this.showNextNotification();
                }
            },
            
            // Mostrar siguiente notificación
            showNextNotification: function() {
                if (this.queue.length === 0) {
                    this.processing = false;
                    return;
                }
                
                const notification = this.queue.shift();
                showNotification(notification.message, notification.type);
                
                setTimeout(() => {
                    this.showNextNotification();
                }, notification.duration + 300); // Añadir tiempo para la transición
            }
        };

        // Sistema de Ayuda Contextual
        // En una implementación real, este módulo gestionaría la ayuda en línea
        const helpSystem = {
            // Temas de ayuda
            topics: {
                dashboard: {
                    title: 'Vista General del Tablero',
                    content: 'El tablero poblacional ofrece una vista consolidada de la información demográfica de Curicó. Desde aquí puede acceder a diferentes visualizaciones y análisis mediante las pestañas superiores.'
                },
                filters: {
                    title: 'Uso de Filtros',
                    content: 'Los filtros en el panel lateral permiten personalizar la visualización de datos. Puede filtrar por año, centro de salud, sexo y grupos etarios. Una vez seleccionados los criterios, haga clic en "Aplicar Filtros".'
                },
                charts: {
                    title: 'Interacción con Gráficos',
                    content: 'Cada gráfico ofrece opciones interactivas. Puede pasar el cursor sobre los elementos para ver detalles, hacer clic en las leyendas para ocultar/mostrar series, y utilizar los botones de exportación y pantalla completa.'
                },
                reports: {
                    title: 'Generación de Informes',
                    content: 'Para generar informes predefinidos, seleccione un tipo de informe en el panel lateral y haga clic en "Generar Informe". Los informes incluyen análisis detallados y pueden ser exportados en diferentes formatos.'
                },
                export: {
                    title: 'Exportación de Datos',
                    content: 'Puede exportar datos y gráficos en diferentes formatos (Excel, PDF, CSV). Utilice el botón de exportación en la barra superior para exportar todo el tablero, o los botones individuales para exportar elementos específicos.'
                }
            },
            
            // Obtener ayuda sobre un tema específico
            getHelpTopic: function(topic) {
                return this.topics[topic] || {
                    title: 'Ayuda General',
                    content: 'Si necesita asistencia, utilice el botón de ayuda en la barra superior para acceder a la documentación completa.'
                };
            },
            
            // Mostrar tooltip de ayuda
            showTooltip: function(element, topic) {
                const helpTopic = this.getHelpTopic(topic);
                const tooltip = document.createElement('div');
                tooltip.className = 'help-tooltip';
                tooltip.innerHTML = `<h4>${helpTopic.title}</h4><p>${helpTopic.content}</p>`;
                
                document.body.appendChild(tooltip);
                
                const rect = element.getBoundingClientRect();
                tooltip.style.top = `${rect.bottom + 10}px`;
                tooltip.style.left = `${rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2)}px`;
                
                setTimeout(() => {
                    tooltip.style.opacity = '1';
                }, 50);
                
                const removeTooltip = () => {
                    tooltip.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(tooltip);
                    }, 300);
                    
                    document.removeEventListener('click', handleOutsideClick);
                };
                
                const handleOutsideClick = (e) => {
                    if (!tooltip.contains(e.target) && e.target !== element) {
                        removeTooltip();
                    }
                };
                
                document.addEventListener('click', handleOutsideClick);
                
                return removeTooltip;
            }
        };
    </script>
</body>
</html>