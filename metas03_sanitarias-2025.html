<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Meta Sanitaria Curicó</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
     <script src="iaaps-chatbot.js"></script>
     <!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- jsPDF AutoTable (si luego vas a usar autoTable en otro método) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Tu script que define exportarPDFBasico -->
<script src="ruta/a/tu/script.js"></script>

     <!-- Chart.js + DataLabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

     <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Para exportación a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Para exportación a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
       /* Variables de colores y estilos base */
       :root {
    /* Paleta de colores premium - Verde institucional mejorado */
    --primary-color: #17a558;       /* Verde esmeralda - más saturado */
    --primary-dark: #128a47;        /* Verde oscuro más elegante */
    --primary-light: #54d68b;       /* Verde jade brillante */
    --primary-ultra-light: #edfcf5; /* Verde perlado sutil */
    --secondary-color: #2c8ec6;     /* Azul complementario más profundo */
    --success-color: #1fc069;       /* Verde éxito más vibrante */
    --warning-color: #ffaa00;       /* Ámbar cálido */
    --danger-color: #fc3d3d;        /* Rojo más vibrante */
    --light-color: #fbfefd;         /* Blanco premium con sutil tinte */
    --dark-color: #192228;          /* Gris carbomax - más profundo */
    --text-dark: #192228;           /* Texto mejorado para contraste */
    --text-light: #ffffff;          /* Blanco puro */
    
    /* Sombras premium con más profundidad */
    --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.08), 0 5px 15px rgba(0, 0, 0, 0.04);
    --shadow-medium: 0 15px 35px rgba(0, 0, 0, 0.12), 0 8px 20px rgba(0, 0, 0, 0.08);
    --shadow-strong: 0 20px 40px rgba(0, 0, 0, 0.16), 0 10px 25px rgba(0, 0, 0, 0.1);
    
    /* Radios de borde más generosos */
    --border-radius-sm: 10px;
    --border-radius-md: 16px;
    --border-radius-lg: 22px;
    
    /* Transiciones refinadas */
    --transition-fast: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    --transition-normal: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    --transition-slow: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    
    /* Gradientes más ricos y vibrantes */
    --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    --gradient-secondary: linear-gradient(135deg, var(--secondary-color) 0%, #3d93ff 100%);
    --gradient-success: linear-gradient(135deg, #0db35f 0%, #16e37d 100%);
    --gradient-warning: linear-gradient(135deg, #fc9700 0%, #ffcc00 100%);
    --gradient-danger: linear-gradient(135deg, #e02020 0%, #ff5a5a 100%);
}

/* Estilos base mejorados */
body {
    font-family: 'Poppins', 'Segoe UI', 'Roboto', 'Open Sans', sans-serif;
    background-color: #f7faf8; /* Fondo sutil mejorado */
    color: var(--text-dark);
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    transition: var(--transition-normal);
    letter-spacing: 0.01em;
    line-height: 1.6;
}

/* Navbar premium con efecto de vidrio */
.navbar {
    background: var(--gradient-primary);
    color: var(--text-light);
    padding: 1.2rem 1.8rem;
    box-shadow: var(--shadow-medium);
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.navbar-brand {
    font-size: 1.7rem;
    font-weight: 700;
    letter-spacing: 0.8px;
    position: relative;
    padding-left: 2.8rem;
    text-transform: uppercase;
    background: linear-gradient(90deg, #ffffff, #e8f5ef); /* Efecto de texto metálico */
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.navbar-brand i {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    font-size: 2rem;
    background: var(--text-light);
    color: var(--primary-color);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.4), 0 0 10px rgba(255, 255, 255, 0.2);
    animation: pulse-premium 3s infinite;
}

@keyframes pulse-premium {
    0% { transform: translateY(-50%) scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
    50% { transform: translateY(-50%) scale(1.1); box-shadow: 0 0 20px 10px rgba(255, 255, 255, 0.2); }
    100% { transform: translateY(-50%) scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
}

.nav-link {
    color: rgba(255, 255, 255, 0.95) !important;
    font-weight: 600;
    position: relative;
    margin: 0 0.3rem;
    padding: 0.7rem 1.2rem !important;
    border-radius: var(--border-radius-sm);
    transition: var(--transition-fast);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.9rem;
}

.nav-link:hover {
    color: var(--text-light) !important;
    background: rgba(255, 255, 255, 0.18);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.nav-link.active {
    color: var(--text-light) !important;
    background: rgba(255, 255, 255, 0.25);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.nav-link i {
    margin-right: 0.5rem;
    font-size: 1.1em;
}

/* Contenedor principal con más espacio */
.container-fluid {
    padding: 2rem;
}

/* Header del dashboard con más presencia */
.dashboard-header {
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 3px solid rgba(23, 165, 88, 0.15);
    position: relative;
}

.dashboard-header h2 {
    font-weight: 700;
    color: var(--primary-dark);
    font-size: 2.2rem;
    letter-spacing: -0.02em;
    text-shadow: 1px 1px 0 rgba(255,255,255,0.8);
}

.dashboard-header p {
    opacity: 0.85;
    max-width: 800px;
    font-size: 1.05rem;
}

/* Tarjetas 3D elegantes */
.card {
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-light);
    margin-bottom: 2rem;
    border: none;
    overflow: hidden;
    background-color: var(--light-color);
    transition: var(--transition-normal);
    position: relative;
    transform-style: preserve-3d;
    perspective: 1000px;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 6px;
    height: 100%;
    background: var(--gradient-primary);
    opacity: 0.8;
    z-index: 1;
}

.card:hover {
    transform: translateY(-10px) rotateX(2deg);
    box-shadow: var(--shadow-strong);
}

.card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.2) 0%, 
                rgba(255, 255, 255, 0) 100%);
    opacity: 0;
    transition: var(--transition-normal);
}

.card:hover::after {
    opacity: 1;
}

.card-header {
    background-color: rgba(255, 255, 255, 0.95);
    border-bottom: 1px solid rgba(23, 165, 88, 0.18);
    padding: 1.4rem 1.8rem;
    font-weight: 600;
    color: var(--primary-dark);
    border-radius: var(--border-radius-md) var(--border-radius-md) 0 0 !important;
    display: flex;
    align-items: center;
    position: relative;
    z-index: 2;
}

.card-header h5 {
    margin-bottom: 0;
    font-weight: 700;
    font-size: 1.25rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card-header i {
    margin-right: 0.9rem;
    background: var(--primary-ultra-light);
    color: var(--primary-color);
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    box-shadow: 0 5px 15px rgba(23, 165, 88, 0.15);
    transition: var(--transition-normal);
}

.card:hover .card-header i {
    transform: rotateY(360deg);
}

.card-body {
    padding: 1.8rem;
    position: relative;
    z-index: 2;
}

/* Botones premium con efecto metálico */
.btn {
    border-radius: 30px;
    font-weight: 600;
    padding: 0.6rem 1.5rem;
    transition: var(--transition-fast);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.8px;
    position: relative;
    overflow: hidden;
    transform: translateZ(0);
}

.btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.6);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

.btn:active::after {
    animation: ripple 0.7s ease-out;
}

@keyframes ripple {
    0% {
        transform: scale(0, 0);
        opacity: 0.6;
    }
    100% {
        transform: scale(20, 20);
        opacity: 0;
    }
}

.btn-primary {
    background: var(--gradient-primary);
    border: none;
    color: var(--text-light);
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(23, 165, 88, 0.35);
}

.btn-secondary {
    background: var(--gradient-secondary);
    border: none;
    color: var(--text-light);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #2676a9 0%, #3086f8 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(44, 142, 198, 0.35);
}

.btn-success {
    background: var(--gradient-success);
    border: none;
    color: var(--text-light);
}

.btn-success:hover {
    background: linear-gradient(135deg, #0a9e55 0%, #12db75 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(31, 192, 105, 0.35);
}

.btn-warning {
    background: var(--gradient-warning);
    border: none;
    color: var(--text-dark);
    font-weight: 600;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #e58b00 0%, #ffc000 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(255, 170, 0, 0.35);
    color: var(--text-dark);
}

.btn-danger {
    background: var(--gradient-danger);
    border: none;
    color: var(--text-light);
}

.btn-danger:hover {
    background: linear-gradient(135deg, #cc1e1e 0%, #ff5252 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(252, 61, 61, 0.35);
}

.btn-outline-primary {
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
    background: transparent;
    font-weight: 600;
}

.btn-outline-primary:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(23, 165, 88, 0.25);
}

.btn-outline-light {
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.6);
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    font-weight: 500;
}

.btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border-color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(255, 255, 255, 0.15);
}

.btn-sm {
    padding: 0.3rem 1rem;
    font-size: 0.75rem;
    border-radius: 20px;
}

/* Tarjetas de resumen con efecto neomorfismo */
.summary-card {
    height: 100%;
    display: flex;
    flex-direction: column;
    border-radius: var(--border-radius-md);
    overflow: hidden;
    position: relative;
    background: linear-gradient(145deg, #ffffff, #f8f8f8);
    box-shadow: 20px 20px 60px rgba(0,0,0,0.05), 
                -20px -20px 60px rgba(255,255,255,0.8);
}

.summary-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: var(--gradient-primary);
    opacity: 0.8;
}

.summary-card:nth-child(1)::before {
    background: var(--gradient-success);
}

.summary-card:nth-child(2)::before {
    background: var(--gradient-warning);
}

.summary-card:nth-child(3)::before {
    background: var(--gradient-danger);
}

.summary-card:nth-child(4)::before {
    background: var(--gradient-secondary);
}

.summary-card .card-body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 2.2rem 1.8rem;
}

.centro-icon {
    font-size: 2.8rem;
    color: var(--primary-color);
    background: var(--primary-ultra-light);
    width: 90px;
    height: 90px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.8rem;
    box-shadow: 8px 8px 16px rgba(0,0,0,0.06), 
                -8px -8px 16px rgba(255,255,255,0.8);
    transition: var(--transition-normal);
    position: relative;
    z-index: 1;
}

.summary-card:nth-child(1) .centro-icon {
    color: var(--success-color);
    background: rgba(31, 192, 105, 0.1);
}

.summary-card:nth-child(2) .centro-icon {
    color: var(--warning-color);
    background: rgba(255, 170, 0, 0.1);
}

.summary-card:nth-child(3) .centro-icon {
    color: var(--danger-color);
    background: rgba(252, 61, 61, 0.1);
}

.summary-card:nth-child(4) .centro-icon {
    color: var(--secondary-color);
    background: rgba(44, 142, 198, 0.1);
}

.card:hover .centro-icon {
    transform: scale(1.1) translateY(-5px);
    box-shadow: 10px 10px 20px rgba(0,0,0,0.1), 
                -10px -10px 20px rgba(255,255,255,0.9);
}

.summary-value {
    font-size: 3.2rem;
    font-weight: 800;
    margin-bottom: 0.2rem;
    color: var(--primary-dark);
    text-shadow: 2px 2px 5px rgba(23, 165, 88, 0.1);
    position: relative;
    background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.summary-card:nth-child(1) .summary-value {
    background: linear-gradient(to right, #0a9e55, #1fc069);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.summary-card:nth-child(2) .summary-value {
    background: linear-gradient(to right, #e58b00, #ffaa00);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.summary-card:nth-child(3) .summary-value {
    background: linear-gradient(to right, #cc1e1e, #fc3d3d);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.summary-card:nth-child(4) .summary-value {
    background: linear-gradient(to right, #246fa1, #2c8ec6);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.summary-label {
    font-size: 1.05rem;
    color: #536073;
    margin-bottom: 1.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
}

.highlight-cumpl-blue {
    background-color: rgba(204, 229, 255, 0.7) !important;
    border-radius: 6px;
    padding: 0.3rem 0.6rem;
    box-shadow: 0 2px 10px rgba(44, 123, 229, 0.15);
}

.progress {
    height: 12px;
    margin-top: auto;
    border-radius: 6px;
    background-color: rgba(230, 230, 230, 0.6);
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 
                0 2px 6px rgba(255, 255, 255, 0.8);
}

.progress-bar {
    transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    background-image: linear-gradient(45deg, 
                      rgba(255, 255, 255, 0.2) 25%, 
                      transparent 25%, 
                      transparent 50%, 
                      rgba(255, 255, 255, 0.2) 50%, 
                      rgba(255, 255, 255, 0.2) 75%, 
                      transparent 75%, 
                      transparent);
    background-size: 20px 20px;
    animation: progress-animation 1.5s linear infinite;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

@keyframes progress-animation {
    0% {
        background-position: 0 0;
    }
    100% {
        background-position: 20px 0;
    }
}

.bg-success {
    background: var(--gradient-success) !important;
}

.bg-warning {
    background: var(--gradient-warning) !important;
}

.bg-danger {
    background: var(--gradient-danger) !important;
}

.bg-primary {
    background: var(--gradient-primary) !important;
}

/* Tablas premium elegantes */
.table-responsive {
    margin-top: 1.8rem;
    border-radius: var(--border-radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-light);
}

.table {
    width: 100%;
    margin-bottom: 0;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
}

.table th {
    font-weight: 700;
    background-color: var(--primary-ultra-light);
    color: var(--primary-dark);
    border-bottom: 3px solid rgba(23, 165, 88, 0.2);
    padding: 1.2rem 1.5rem;
    position: relative;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9rem;
}

.table tbody tr {
    transition: var(--transition-normal);
    background-color: white;
}

.table tbody tr:hover {
    background-color: rgba(23, 165, 88, 0.05);
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    z-index: 10;
    position: relative;
}

.table td {
    padding: 1.2rem 1.5rem;
    vertical-align: middle;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    font-weight: 500;
}

/* Badges futuristas */
.badge {
    padding: 0.5em 0.8em;
    font-weight: 600;
    border-radius: 30px;
    letter-spacing: 0.8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    text-transform: uppercase;
    font-size: 0.75rem;
}

/* Indicadores de estado */
.status-success {
    color: var(--success-color);
    font-weight: 600;
}

.status-warning {
    color: var(--warning-color);
    font-weight: 600;
}

.status-danger {
    color: var(--danger-color);
    font-weight: 600;
}

/* Tarjetas de centro premium */
.centro-card {
    cursor: pointer;
    transition: var(--transition-normal);
    overflow: hidden;
    border-radius: var(--border-radius-md);
    background: linear-gradient(145deg, #ffffff, #f8f8f8);
    box-shadow: 10px 10px 30px rgba(0,0,0,0.05), 
                -10px -10px 30px rgba(255,255,255,0.8);
    border: none;
}

.centro-card:hover {
    transform: translateY(-12px) scale(1.03);
    box-shadow: var(--shadow-strong);
    z-index: 10;
}

.centro-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: var(--gradient-primary);
    opacity: 0.8;
}

.centro-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 5px;
    color: var(--primary-dark);
    letter-spacing: -0.01em;
}

.centro-subtitle {
    font-size: 0.95rem;
    color: #6c757d;
    margin-bottom: 1.8rem;
    font-weight: 500;
}

/* Gráficos mejorados */
.chart-container {
    position: relative;
    height: 350px;
    margin-bottom: 1.8rem;
    padding: 1.5rem;
    background: white;
    border-radius: var(--border-radius-md);
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.03),
                0 8px 20px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(23, 165, 88, 0.1);
}

/* Tabs premium */
.nav-tabs {
    border-bottom: none;
    margin-bottom: 2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
}

.highlight-cumpl-blue {
    background-color: rgba(204, 229, 255, 0.7);
    color: #0056b3;
    border-radius: 8px;
    padding: 0.35rem 0.7rem;
    display: inline-block;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0, 86, 179, 0.15);
}

.nav-tabs .nav-link {
    color: #ffffff;
    background-color: rgba(23, 165, 88, 0.85);
    border: none;
    border-radius: var(--border-radius-sm);
    padding: 1rem 1.8rem;
    margin-right: 0;
    font-weight: 600;
    transition: var(--transition-fast);
    position: relative;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(23, 165, 88, 0.2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.nav-tabs .nav-link::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 4px;
    background: rgba(255, 255, 255, 0.6);
    transition: var(--transition-fast);
}

.nav-tabs .nav-link:hover {
    color: #ffffff;
    background-color: rgba(18, 138, 71, 0.9);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(23, 165, 88, 0.3);
}

.nav-tabs .nav-link:hover::before {
    width: 100%;
}

.nav-tabs .nav-link.active {
    color: #ffffff;
    background-color: var(--primary-dark);
    font-weight: 700;
    box-shadow: 0 8px 20px rgba(18, 138, 71, 0.3);
    transform: translateY(-3px);
}

.nav-tabs .nav-link.active::before {
    width: 100%;
}

/* Breadcrumb premium */
.breadcrumb {
    background-color: transparent;
    padding-left: 0;
    margin-bottom: 2rem;
}

.breadcrumb-item a {
    color: var(--primary-color);
    font-weight: 600;
    text-decoration: none;
    transition: var(--transition-fast);
}

.breadcrumb-item a:hover {
    color: var(--primary-dark);
}

.breadcrumb-item + .breadcrumb-item::before {
    content: "›";
    color: #aaa;
    font-size: 1.2rem;
    line-height: 0.8;
}

.breadcrumb-item.active {
    color: #536073;
    font-weight: 600;
}

/* Efectos de animación */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

/* Loading overlay con blur */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(8px);
}

.spinner-border {
    width: 3.5rem;
    height: 3.5rem;
    border-width: 0.25rem;
    color: var(--primary-color);
    animation: spinner-border 1.2s linear infinite;
}

/* Barra de búsqueda premium */
.input-group {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    border-radius: 30px;
    overflow: hidden;
    background: white;
}

.input-group-text {
    background-color: white;
    border: none;
    color: var(--primary-color);
    padding-left: 1.5rem;
    font-size: 1.2rem;
}

.form-control {
    border: none;
    padding: 0.8rem 1.5rem 0.8rem 0.5rem;
    font-size: 1.2rem;
    font-weight: 500;
}

.form-control:focus {
    box-shadow: none;
    border-color: var(--primary-color);
}

.form-control::placeholder {
    color: #adb5bd;
    opacity: 0.7;
}

/* Switch para modo oscuro */
.custom-switch {
    display: inline-block;
    margin-left: 15px;
}

.form-check-input {
    height: 1.5rem;
    width: 3rem;
    cursor: pointer;
    background-color: rgba(255, 255, 255, 0.3);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='white'/%3e%3c/svg%3e");
    background-position: left center;
    background-repeat: no-repeat;
    background-size: contain;
    border: none;
    transition: var(--transition-fast);
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2), 0 0 10px rgba(255, 255, 255, 0.2);
}

.form-check-input:checked {
    background-color: white;
    background-position: right center;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%2317a558'/%3e%3c/svg%3e");
}

.form-check-label {
    color: white;
    cursor: pointer;
    font-size: 1.2rem;
}

/* Modal premium */
.modal-content {
    border-radius: var(--border-radius-lg);
    border: none;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
    overflow: hidden;
}

.modal-header {
    background: var(--primary-ultra-light);
    border-bottom: 1px solid rgba(23, 165, 88, 0.15);
    padding: 1.5rem 2rem;
}

.modal-title {
    color: var(--primary-dark);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    padding: 1.5rem 2rem;
}

/* Customización de scrollbar */
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: rgba(23, 165, 88, 0.6);
    border-radius: 10px;
    border: 3px solid #f1f1f1;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color);
}

/* AJUSTES PARA MODO OSCURO */
.dark-mode {
    background-color: #121a23;
    color: #e0e6ed;
}

.dark-mode .navbar {
    background: linear-gradient(135deg, #16854b 0%, #0a4026 100%);
}

.dark-mode .card {
    background-color: #1c2531;
    box-shadow: var(--shadow-light);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.dark-mode .card-header {
    background-color: #232f3e;
    color: #e0e6ed;
    border-bottom-color: rgba(23, 165, 88, 0.1);
}

.dark-mode .summary-card {
    background: linear-gradient(145deg, #1c2531, #1a2130);
    box-shadow: 8px 8px 16px rgba(0,0,0,0.3), 
                -8px -8px 16px rgba(40, 52, 73, 0.4);
}

.dark-mode .summary-value {
    color: var(--primary-light);
    text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
}

.dark-mode .summary-label,
.dark-mode .centro-subtitle {
    color: #a0aec0;
}

.dark-mode .centro-title,
.dark-mode h1, 
.dark-mode h2, 
.dark-mode h3, 
.dark-mode h4, 
.dark-mode h5, 
.dark-mode h6 {
    color: #e0e6ed;
}

.dark-mode .table {
    color: #e0e6ed;
}

.dark-mode .table th {
    background-color: #232f3e;
    color: var(--primary-light);
    border-bottom-color: rgba(23, 165, 88, 0.15);
}

.dark-mode .table td {
    border-color: rgba(255, 255, 255, 0.05);
}

.dark-mode .table tbody tr {
    background-color: #1c2531;
}

.dark-mode .table tbody tr:hover {
    background-color: #232f3e;
}

.dark-mode .nav-tabs .nav-link {
    color: #e0e6ed;
    background-color: rgba(23, 165, 88, 0.6);
}

.dark-mode .nav-tabs .nav-link.active {
    color: white;
    background-color: var(--primary-dark);
}

.dark-mode .progress {
    background-color: rgba(40, 52, 73, 0.8);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 
                0 1px 2px rgba(255, 255, 255, 0.1);
}

.dark-mode .chart-container {
    background: #1c2531;
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
    border-color: rgba(23, 165, 88, 0.15);
}

.dark-mode .breadcrumb-item.active {
    color: #a0aec0;
}

.dark-mode .loading-overlay {
    background-color: rgba(18, 26, 35, 0.8);
}

.dark-mode .input-group {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.dark-mode .input-group-text,
.dark-mode .form-control {
    background-color: #232f3e;
    color: #e0e6ed;
    border: none;
}

.dark-mode .form-control::placeholder {
    color: #718096;
}

.dark-mode .centro-icon {
    background: rgba(23, 165, 88, 0.15);
    color: var(--primary-light);
    box-shadow: 8px 8px 16px rgba(0,0,0,0.2), 
                -8px -8px 16px rgba(40, 52, 73, 0.3);
}

.dark-mode .text-muted {
    color: #a0aec0 !important;
}

.dark-mode ::-webkit-scrollbar-track {
    background: #232f3e;
}

.dark-mode ::-webkit-scrollbar-thumb {
    background: rgba(23, 165, 88, 0.5);
    border: 3px solid #232f3e;
}

/* Estilos para detalles de tabla */
.table-percentage-cell {
    position: relative;
}

.table-percentage-bg {
    position: absolute;
    height: 100%;
    left: 0;
    top: 0;
    z-index: 0;
    opacity: 0.2;
    transition: var(--transition-fast);
    border-radius: 4px;
}

.dark-mode .table-percentage-bg {
    opacity: 0.3;
}

.table-percentage-text {
    position: relative;
    z-index: 1;
    font-weight: 600;
}

/* Media queries para responsividad */
@media (max-width: 992px) {
    .navbar-brand {
        font-size: 1.4rem;
    }
    
    .summary-value {
        font-size: 2.5rem;
    }
    
    .centro-icon {
        width: 75px;
        height: 75px;
        font-size: 2.2rem;
    }
    
    .chart-container {
        height: 300px;
    }
}

@media (max-width: 768px) {
    .navbar-toggler {
        border: none;
        color: white;
    }
    
    .summary-value {
        font-size: 2rem;
    }
    
    .centro-icon {
        width: 65px;
        height: 65px;
        font-size: 1.8rem;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .nav-tabs .nav-link {
        padding: 0.8rem 1.2rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 576px) {
    .container-fluid {
        padding: 1.2rem;
    }
    
    .card {
        margin-bottom: 1.2rem;
    }
    
    .card-header {
        padding: 1.2rem;
    }
    
    .card-body {
        padding: 1.2rem;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
    }
    
    .btn-sm {
        padding: 0.3rem 0.8rem;
        font-size: 0.7rem;
    }
    
    .table td, 
    .table th {
        padding: 0.8rem;
    }
}

/* Efectos especiales y animaciones para diseño premium */
.pulse {
    box-shadow: 0 0 0 rgba(23, 165, 88, 0.4);
    animation: pulse-premium 2s infinite;
}

@keyframes pulse-premium {
    0% {
        box-shadow: 0 0 0 0 rgba(23, 165, 88, 0.4);
    }
    70% {
        box-shadow: 0 0 0 20px rgba(23, 165, 88, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(23, 165, 88, 0);
    }
}

/* Notificación Toast */
.toast-container {
    z-index: 1080;
}

.toast {
    backdrop-filter: blur(15px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border: none;
    border-radius: var(--border-radius-md);
    overflow: hidden;
}

.bg-success {
    background-color: var(--success-color) !important;
}

.bg-error {
    background-color: var(--danger-color) !important;
}

/* Diseño de cuadrícula */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-gap: 1.8rem;
}

.grid-span-3 {
    grid-column: span 3;
}

.grid-span-4 {
    grid-column: span 4;
}

.grid-span-6 {
    grid-column: span 6;
}

.grid-span-8 {
    grid-column: span 8;
}

.grid-span-12 {
    grid-column: span 12;
}

/* Efecto de barrido brillante para tarjetas */
.card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 200%;
    height: 100%;
    background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0) 0%, 
                rgba(255, 255, 255, 0.08) 25%, 
                rgba(255, 255, 255, 0.15) 50%, 
                rgba(255, 255, 255, 0.08) 75%, 
                rgba(255, 255, 255, 0) 100%);
    transform: translateX(-100%);
    transition: transform 1.2s ease;
    pointer-events: none;
}

.card:hover::after {
    transform: translateX(0);
}

/* Aumenta el tamaño de la fuente del input */
#searchInput {
    font-size: 1.2rem;
    font-weight: 500;
}

/* Aumenta específicamente el placeholder */
#searchInput::placeholder {
    font-size: 1.2rem;
    opacity: 0.6;
    font-weight: 400;
}

/* Estilos para la celda de cumplimiento cuando la meta es específica */
#centroCumplimientoTableBody td.highlight-cumpl {
    background-color: rgba(204, 229, 255, 0.7) !important;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(44, 123, 229, 0.15);
    font-weight: 600;
}



    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-heartbeat me-2"></i>
                INFOGES Curicó
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-sign-out-alt me-1"></i> Salir
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="dashboardLink">
                            <i class="fas fa-tachometer-alt me-1"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="detailLink">
                            <i class="fas fa-chart-bar me-1"></i> Detalle
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="bibliotecas_Meta_Sanitaria.html" id="exportDataLink">
                            <i class="fas fa-file-alt me-1"></i> Docs Meta Sanitaria 
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="helpLink">
                            <i class="fas fa-question-circle me-1"></i> Ayuda
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex">
                    <div class="input-group">
                        <span class="input-group-text" id="search-addon">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Buscar indicador..." aria-label="Buscar" aria-describedby="search-addon" id="searchInput">
                    </div>
                    
                    <div class="custom-switch ms-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="darkModeToggle">
                            <label class="form-check-label" for="darkModeToggle">
                                <i class="fas fa-moon"></i>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-light ms-3" id="refreshDataBtn">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid">
        <!-- Dashboard View -->
        <div id="dashboardView">
            <div class="dashboard-header">
                <h2><i class="fas fa-chart-line me-2"></i>Dashboard Meta Sanitaria  - Corte Marzo 2025</h2>
                <p class="text-muted">Monitoreo de Índices de Actividad de la Atención Primaria de Salud (Meta Sanitaria ) para la comuna de Curicó</p>
            </div>
            
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <p class="summary-value" id="indicadorCumplidosValue">0</p>
                            <p class="summary-label">Indicadores Cumplidos</p>
                            <div class="progress">
                                <div class="progress-bar bg-success" id="indicadorCumplidosProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <p class="summary-value" id="indicadorParcialValue">0</p>
                            <p class="summary-label">Cumplimiento Parcial</p>
                            <div class="progress">
                                <div class="progress-bar bg-warning" id="indicadorParcialProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <p class="summary-value" id="indicadorCriticosValue">0</p>
                            <p class="summary-label">Indicadores Críticos</p>
                            <div class="progress">
                                <div class="progress-bar bg-danger" id="indicadorCriticosProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card summary-card">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <p class="summary-value" id="cumplimientoComunalValue">0%</p>
                            <p class="summary-label">Cumplimiento Comunal</p>
                            <div class="progress">
                                <div class="progress-bar bg-primary" id="cumplimientoComunalProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cumplimiento por Centro -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-hospital me-2"></i>
                                Cumplimiento por Centro de Salud
                            </h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" id="viewTableBtn">
                                    <i class="fas fa-table me-1"></i> Ver Tabla
                                </button>
                                <button class="btn btn-sm btn-outline-success" id="viewChartBtn">
                                    <i class="fas fa-chart-bar me-1"></i> Ver Gráfico
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="centroChartContainer" class="chart-container">
                                <canvas id="centroChart"></canvas>
                            </div>
                            <div id="centroTableContainer" class="table-responsive" style="display: none;">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Centro de Salud</th>
                                            <th class="text-center">Cumplimiento</th>
                                            <th class="text-center">Indicadores Cumplidos</th>
                                            <th class="text-center">Parciales</th>
                                            <th class="text-center">Críticos</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="centroCumplimientoTableBody">
                                        <!-- Tabla se llenará dinámicamente con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Indicadores IAAPS -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list-check me-2"></i>
                                Indicadores Meta Sanitaria  - Avance Comunal
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Indicador</th>
                                            <th class="text-center">Meta</th>
                                            <th class="text-center">Actual</th>
                                            <th class="text-center">Cumplimiento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="indicadoresTableBody">
                                        <!-- Tabla se llenará dinámicamente con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-star me-2"></i>
                                Top 5 Indicadores
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="text-success">Mayor Cumplimiento</h6>
                                <div id="topIndicadoresContainer" class="chart-container">
                                    <canvas id="topIndicadoresChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h6 class="text-danger">Menor Cumplimiento</h6>
                                <div id="bottomIndicadoresContainer" class="chart-container">
                                    <canvas id="bottomIndicadoresChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Centros de Salud Cards -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="mb-3"><i class="fas fa-building me-2"></i>Centros de Salud</h4>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroCurico">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Curicó Centro</h5>
                            <p class="centro-subtitle">Avda. Freire 189</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroCuricoProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroCuricoValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroMiguel">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Miguel Ángel</h5>
                            <p class="centro-subtitle">Balmaceda 179</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroMiguelProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroMiguelValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroBetty">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Betty Muñoz</h5>
                            <p class="centro-subtitle">Marcelo Oxilia 1550</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroBettyProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroBettyValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroColon">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Colón</h5>
                            <p class="centro-subtitle">Balmaceda 1661</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroColonProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroColonValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroSarmiento">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Sarmiento</h5>
                            <p class="centro-subtitle">Volcán Calbuco s/n</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroSarmientoProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroSarmientoValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 col-lg-2 mb-3" id="centroNiches">
                    <div class="card centro-card h-100">
                        <div class="card-body text-center">
                            <div class="centro-icon">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h5 class="centro-title">CESFAM Los Niches</h5>
                            <p class="centro-subtitle">Villa Santa Elena</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="centroNichesProgress"></div>
                            </div>
                            <p class="mb-0"><strong id="centroNichesValue">0%</strong> de cumplimiento</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detail View -->
        <div id="detailView" style="display: none;">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#" id="backToDashboard">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page" id="detailBreadcrumb">Detalle</li>
                </ol>
            </nav>
            
            <div class="detail-header">
                <div>
                    <h3 class="detail-title" id="detailTitle">Detalle de Indicadores Meta Sanitaria </h3>
                    <p class="detail-subtitle" id="detailSubtitle">Seleccione un centro o indicador para ver detalles específicos.</p>
                </div>
                
            </div>
            
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="detailTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="centro-tab" data-bs-toggle="tab" data-bs-target="#centro-content" 
                            type="button" role="tab" aria-controls="centro-content" aria-selected="true">
                        <i class="fas fa-hospital me-1"></i> Por Centro de Salud
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="indicador-tab" data-bs-toggle="tab" data-bs-target="#indicador-content" 
                            type="button" role="tab" aria-controls="indicador-content" aria-selected="false">
                        <i class="fas fa-list-check me-1"></i> Por Indicador
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comparativo-tab" data-bs-toggle="tab" data-bs-target="#comparativo-content" 
                            type="button" role="tab" aria-controls="comparativo-content" aria-selected="false">
                        <i class="fas fa-chart-bar me-1"></i> Comparativo
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="detailTabContent">
                <!-- Centro Content -->
                <div class="tab-pane fade show active" id="centro-content" role="tabpanel" aria-labelledby="centro-tab">
                    <div class="row mt-4">
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Centros de Salud</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group" id="centroListGroup">
                                        <a href="#" class="list-group-item list-group-item-action active" 
                                           data-centro="comunal">CURICÓ (COMUNAL)</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="curico">CESFAM Curicó Centro</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="miguel">CESFAM Miguel Ángel Arenas</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="betty">CESFAM Betty Muñoz</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="colon">CESFAM Colón</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="sarmiento">CESFAM Sarmiento</a>
                                        <a href="#" class="list-group-item list-group-item-action" 
                                           data-centro="niches">CESFAM Los Niches</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="centroCumplimientoTitle">Cumplimiento Metas Sanitarias Comunal</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportCentroExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportCentroPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="centroCumplimientoChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="centroIndicadoresChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Indicador</th>
                                                    <th class="text-center">Numerador</th>
                                                    <th class="text-center">Denominador</th>
                                                    <th class="text-center">Resultado</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="centroIndicadoresTableBody">
                                                <!-- Se llenará dinámicamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card" id="establecimientosCard" style="display: none;">
                                <div class="card-header">
                                    <h5 class="mb-0">Establecimientos Asociados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Establecimiento</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Indicadores Cumplidos</th>
                                                    <th class="text-center">Parciales</th>
                                                    <th class="text-center">Críticos</th>
                                                </tr>
                                            </thead>
                                            <tbody id="establecimientosTableBody">
                                                <!-- Se llenará dinámicamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Indicador Content -->
                <div class="tab-pane fade" id="indicador-content" role="tabpanel" aria-labelledby="indicador-tab">
                    <div class="row mt-4">
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Indicadores Meta Sanitaria </h5>
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <div class="list-group" id="indicadorListGroup">
                                        <!-- Se llenará dinámicamente con JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="indicadorDetailTitle">Detalle de Indicador</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportIndicadorExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportIndicadorPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                                <canvas id="indicadorCentrosChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="chart-container">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 id="indicadorNombreCompleto">Nombre del Indicador</h6>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>Meta:</strong> <span id="indicadorMetaValor">0%</span></p>
                                                            <p><strong>Importancia:</strong> <span id="indicadorImportanciaValor">0%</span></p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>Numerador:</strong> <span id="indicadorNumeradorFormula">Fórmula del numerador</span></p>
                                                            <p><strong>Denominador:</strong> <span id="indicadorDenominadorFormula">Fórmula del denominador</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Centro de Salud</th>
                                                    <th class="text-center">Numerador</th>
                                                    <th class="text-center">Denominador</th>
                                                    <th class="text-center">Resultado</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="indicadorCentrosTableBody">
                                                <!-- Se llenará dinámicamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparativo Content -->
                <div class="tab-pane fade" id="comparativo-content" role="tabpanel" aria-labelledby="comparativo-tab">
                    <div class="row mt-4">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Comparativo de Cumplimiento</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success" id="exportComparativoExcelBtn">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="exportComparativoPdfBtn">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="chart-container">
                                                <canvas id="comparativoChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Matriz de Cumplimiento</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Indicador</th>
                                                    <th class="text-center">Meta</th>
                                                    <th class="text-center">Comunal</th>
                                                    <th class="text-center">Curicó Centro</th>
                                                    <th class="text-center">Miguel Ángel</th>
                                                    <th class="text-center">Betty Muñoz</th>
                                                    <th class="text-center">Colón</th>
                                                    <th class="text-center">Sarmiento</th>
                                                    <th class="text-center">Los Niches</th>
                                                </tr>
                                            </thead>
                                            <tbody id="comparativoTableBody">
                                                <!-- Se llenará dinámicamente con JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="fas fa-question-circle me-2"></i>
                        Ayuda del Dashboard Meta Sanitaria 
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h5>¿Qué son los Meta Sanitaria ?</h5>
                            <p>
                                Los Índices de Actividad de la Atención Primaria de Salud (Meta Sanitaria ) son un conjunto de 
                                indicadores que permiten evaluar el funcionamiento integral de la atención primaria.
                                Estos indicadores miden diferentes aspectos como cobertura, continuidad, calidad 
                                de la atención y más.
                            </p>
                            
                            <h5>¿Cómo leer el dashboard?</h5>
                            <p>
                                El dashboard proporciona una visión general del cumplimiento de los Meta Sanitaria  a nivel comunal
                                y por cada centro de salud. Los indicadores se clasifican según su cumplimiento:
                            </p>
                            <ul>
                                <li><span class="badge bg-success">Cumplido</span> - Cumplimiento igual o superior al 100% de la meta</li>
                                <li><span class="badge bg-warning">Parcial</span> - Cumplimiento entre 25% y 99% de la meta</li>
                                <li><span class="badge bg-danger">Crítico</span> - Cumplimiento inferior al 25% de la meta</li>
                            </ul>
                            
                            <h5>Secciones principales</h5>
                            <ul>
                                <li><strong>Dashboard</strong>: Vista general del cumplimiento comunal y por centro</li>
                                <li><strong>Detalle</strong>: Información detallada por centro o por indicador</li>
                                <li><strong>Exportar</strong>: Opciones para generar reportes en PDF o Excel</li>
                            </ul>
                            
                            <h5>¿Cómo actualizar los datos?</h5>
                            <p>
                                Los datos se cargan automáticamente desde el archivo Meta_Sanitaria _Corte_Marzo.xlsx. 
                                Para actualizar los datos después de modificar el archivo Excel, haga clic en el 
                                botón "Actualizar" en la barra de navegación.
                            </p>
                            
                            <h5>Leyenda de cálculos</h5>
                            <ul>
                                <li><strong>Resultado</strong>: Numerador / Denominador</li>
                                <li><strong>Cumplimiento</strong>: (Resultado / Meta) * 100%</li>
                                <li><strong>Cumplimiento máximo</strong>: 100% (aunque el cálculo sea superior)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Core JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>

    
        // Configuración global de Chart.js
        Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#666';
        
        // Variables globales para datos
        let iaapsData = null;
        let currentCentro = 'comunal';
        let currentIndicador = '1';
        let darkMode = false;
        let indicadorCentrosChartInstance = null;
        
        const indicadoresMap = {
    'I': 'Recuperación desarrollo psicomotor niños 12-23 meses',
    'II': 'Tamizaje cáncer cuello uterino 25-64 años',
    'III.A': 'Niños 0-9 años con pauta CERO aplicada',
    'III.B': 'Niños 6 años libres de caries',
    'IV.A': 'Cobertura efectiva DM2 personas 15+ años',
    'IV.B': 'Evaluación pie diabético DM2 15+ años',
    'V': 'Cobertura efectiva HTA 15+ años',
    'VI': 'Prevalencia lactancia materna exclusiva 6° mes',
    'VII': 'Cobertura efectiva enfermedades respiratorias 5+ años',
    'VIII': 'Plan participación social funcionando'
};
        
        // Mapeo de códigos de centros a nombres completos
      const centrosMap = {
    'comunal':   'CURICÓ TOTAL COMUNAL',
    'curico':    'CURICO CENTRO',
    'miguel':    'MIGUEL ÁNGEL ARENAS',
    'betty':     'BETTY MUÑOZ',
    'colon':     'COLÓN',
    'sarmiento': 'SARMIENTO',
    'niches':    'LOS NICHES'
};

// Mapeo de establecimientos asociados a cada centro
const establecimientosMap = {
    'comunal':   [],
    'curico':    ['SAPU CURICÓ CENTRO'],
    'miguel':    ['PROSPERIDAD','SAR AGUAS NEGRAS' ],
    'betty':     ['PSR PORVENIR'],
    'colon':     ['SAR BOMBERO GARRIDO', 'PSR TUTUQUEN', ],
    'sarmiento': ['SUR SARMIENTO', 'CECOSF DOÑA CARMEN DE SARMIENTO'],
    'niches':    [
        'SUR LOS NICHES',
        'PSR POTRERO GRANDE',
        'PSR CHEQUENLEMU',
        'PSR UPEO',
        'PSR CORDILLERILLA',
        'PSR LA OBRA'
    ]
};

        
const importanciaIndicadores = {
    'I': '12.50%',
    'II': '12.50%',
    'III.A': '6.25%',
    'III.B': '6.25%',
    'IV.A': '12.50%',
    'IV.B': '12.50%',
    'V': '12.50%',
    'VI': '12.50%',
    'VII': '6.25%',
    'VIII': '6.25%'
};
const formulasIndicadores = {
    'I': {
        numerador: 'N° de niñas y niños de 12 a 23 meses diagnosticados con riesgo del desarrollo psicomotor (DSM) recuperados en el período de enero a diciembre de 2025',
        denominador: 'N° de niñas y niños de 12 a 23 meses diagnosticados en su primera evaluación con riesgo del desarrollo psicomotor de octubre 2024 a septiembre de 2025'
    },
    'II': {
        numerador: 'N° logrado de personas de 25 a 64 años inscritas validadas por FONASA, con PAP o Test de VPH vigente a diciembre 2025',
        denominador: 'N° de personas de 25 a 64 años inscritas validadas por FONASA para el año 2025'
    },
    'III.A': {
        numerador: 'N° de niños y niñas de 0 a 9 años en control con enfoque de riesgo odontológico y pauta CERO aplicada en el periodo enero a diciembre 2025',
        denominador: 'N° total de niños y niñas inscritos validados de 0 a 9 años, año 2025'
    },
    'III.B': {
        numerador: 'N° de niños y niñas de 6 años con CEOD igual a 0 en el período enero a diciembre 2025',
        denominador: 'N° total de niños y niñas inscritos validados de 6 años, año 2025'
    },
    'IV.A': {
        numerador: 'N° de personas con DM2 de 15 a 79 años, con Hemoglobina Glicosilada bajo 7%, más el N° de personas con DM2 de 80 y más años con Hemoglobina Glicosilada bajo 8% según último control vigente, en los últimos 12 meses',
        denominador: 'N° Total de personas de 15 años y más con DM2 estimadas según prevalencia'
    },
    'IV.B': {
        numerador: 'N° de personas de 15 años y más con DM2 bajo control, con evaluación de pie diabético vigente, en los últimos 12 meses',
        denominador: 'N° de personas de 15 años y más con DM2 bajo control en los últimos 12 meses'
    },
    'V': {
        numerador: 'N° personas con hipertensión arterial de 15 a 79 años con presión arterial <140/90 mmHg, más N° personas con hipertensión arterial de 80 y más años con presión arterial <150/90 mmHg, según último control vigente, en los últimos 12 meses',
        denominador: 'Total de personas de 15 y más años con hipertensión arterial estimadas según prevalencia estimada'
    },
    'VI': {
        numerador: 'N° de niños y niñas controlados en el período de enero a diciembre de 2025 que al control de salud del sexto mes recibieron LME',
        denominador: 'N° de niños y niñas con control de salud del sexto mes realizado en el período de enero a diciembre de 2025'
    },
    'VII': {
        numerador: 'N° de personas con EPOC de 40 años y más que logran nivel de control "adecuado" más el N° de personas con asma de 5 años y más, que logran nivel de control "controlado", durante el año 2025',
        denominador: 'N° Total de personas con EPOC de 40 años y más, más N° de personas con asma de 5 años y más, esperadas según prevalencia nacional para año 2025'
    },
    'VIII': {
        numerador: 'Total de actividades ejecutadas',
        denominador: 'Total de actividades programadas'
    }
};
        
        // Función para inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips y popovers de Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Cargar datos iniciales
            cargarDatos();
            
            // Event listeners para navegación
            document.getElementById('dashboardLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('dashboardView');
            });
            
            document.getElementById('detailLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('detailView');
            });
            
            document.getElementById('backToDashboard').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarVista('dashboardView');
            });
            
            document.getElementById('helpLink').addEventListener('click', function(e) {
                e.preventDefault();
                const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
                helpModal.show();
            });
            
            document.getElementById('refreshDataBtn').addEventListener('click', function(e) {
                cargarDatos();
            });
            
            document.getElementById('viewTableBtn').addEventListener('click', function(e) {
                document.getElementById('centroChartContainer').style.display = 'none';
                document.getElementById('centroTableContainer').style.display = 'block';
            });
            
            document.getElementById('viewChartBtn').addEventListener('click', function(e) {
                document.getElementById('centroChartContainer').style.display = 'block';
                document.getElementById('centroTableContainer').style.display = 'none';
            });
            
            // Event listeners para tarjetas de centros
            document.getElementById('centroCurico').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('curico');
            });
            
            document.getElementById('centroMiguel').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('miguel');
            });
            
            document.getElementById('centroBetty').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('betty');
            });
            
            document.getElementById('centroColon').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('colon');
            });
            
            document.getElementById('centroSarmiento').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('sarmiento');
            });
            
            document.getElementById('centroNiches').addEventListener('click', function() {
                mostrarVista('detailView');
                seleccionarCentro('niches');
            });
            
            // Event listeners para lista de centros en vista detalle
            document.getElementById('centroListGroup').addEventListener('click', function(e) {
                if (e.target.classList.contains('list-group-item')) {
                    e.preventDefault();
                    
                    // Remover clase active de todos los items
                    document.querySelectorAll('#centroListGroup .list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Agregar clase active al item seleccionado
                    e.target.classList.add('active');
                    
                    // Mostrar detalles del centro seleccionado
                    seleccionarCentro(e.target.dataset.centro);
                }
            });
            
            // Event listeners para exportar
            document.getElementById('exportCentroExcelBtn').addEventListener('click', function() {
                exportarExcel('centro');
            });
            
            document.getElementById('exportCentroPdfBtn').addEventListener('click', function() {
                exportarPDF('centro');
            });
            
            document.getElementById('exportIndicadorExcelBtn').addEventListener('click', function() {
                exportarExcel('indicador');
            });
            
            document.getElementById('exportIndicadorPdfBtn').addEventListener('click', function() {
                exportarPDF('indicador');
            });
            
            document.getElementById('exportComparativoExcelBtn').addEventListener('click', function() {
                exportarExcel('comparativo');
            });
            
            document.getElementById('exportComparativoPdfBtn').addEventListener('click', function() {
                exportarPDF('comparativo');
            });
            
            // Toggle modo oscuro
            document.getElementById('darkModeToggle').addEventListener('change', function() {
                toggleDarkMode();
            });
            
            // Búsqueda
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                buscarIndicadores(searchTerm);
            });
            
            // Llenar lista de indicadores
            llenarListaIndicadores();
            
            // Event listener para la lista de indicadores
            document.getElementById('indicadorListGroup').addEventListener('click', function(e) {
                if (e.target.classList.contains('list-group-item')) {
                    e.preventDefault();
                    
                    // Remover clase active de todos los items
                    document.querySelectorAll('#indicadorListGroup .list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Agregar clase active al item seleccionado
                    e.target.classList.add('active');
                    
                    // Mostrar detalles del indicador seleccionado
                    seleccionarIndicador(e.target.dataset.indicador);
                }
            });
        });
        
        function llenarListaIndicadores() {
    const indicadorListGroup = document.getElementById('indicadorListGroup');
    indicadorListGroup.innerHTML = '';
    
    // Códigos de los indicadores en orden específico
    const indicadoresCodigos = ['I', 'II', 'III.A', 'III.B', 'IV.A', 'IV.B', 'V', 'VI', 'VII', 'VIII'];
    
    indicadoresCodigos.forEach((codigo, index) => {
        const item = document.createElement('a');
        item.href = '#';
        item.classList.add('list-group-item', 'list-group-item-action');
        if (index === 0) item.classList.add('active');
        item.dataset.indicador = codigo;
        
        // Abreviación del nombre para la lista
        const nombreCorto = codigo + '. ' + indicadoresMap[codigo].split('(')[0];
        
        item.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${nombreCorto}</h6>
            </div>
            <small class="text-muted">Importancia: ${importanciaIndicadores[codigo]}</small>
        `;
        
        indicadorListGroup.appendChild(item);
    });
}
        
// --------------------------------------------------
//  Función para cargar datos y actualizar toda la UI
// --------------------------------------------------
async function cargarDatos() {
  // 1) Mostrar loader
  mostrarCargando(true);

  // 2) Cargar y procesar datos
  try {
    await simularCargaDeDatos();
    procesarDatos();
  } catch (err) {
    console.error('❌ Error al cargar o procesar datos:', err);
    // podemos notificar opcionalmente, pero NO salimos: igual intentamos dibujar lo que haya.
    mostrarNotificacion('No fue posible cargar los datos brutos. Ver consola para más info.', 'error');
  }

  // 3) Actualizar el dashboard (tarjetas, gráficos principales)
  try {
    actualizarDashboard();
  } catch (err) {
    console.error('❌ Error al actualizar el dashboard:', err);
    mostrarNotificacion('Error en la actualización del dashboard. Ver consola.', 'error');
  }

  // 4) Actualizar la vista de detalle (centro, indicador, comparativo)
  try {
    actualizarDetalle();
  } catch (err) {
    console.error('❌ Error al actualizar detalle:', err);
    mostrarNotificacion('Error en la vista de detalle. Ver consola.', 'error');
  }

  // 5) Siempre ocultar loader al final
  mostrarCargando(false);
}

// --------------------------------------------------
//  Arranca la carga al iniciarse la página
// --------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
  cargarDatos();
});

        // Función para simular carga de datos desde el archivo Excel
        function simularCargaDeDatos() {
            return new Promise((resolve) => {
                // Simulamos datos para el ejemplo
                // En una implementación real, se cargaría desde el archivo Excel
                
                // Esta es una estructura de datos simplificada
iaapsData = {
  centros: [
    { codigo: 'comunal',   nombre: 'CURICO TOTAL COMUNAL' },
    { codigo: 'curico',    nombre: 'CURICO CENTRO' },
    { codigo: 'miguel',    nombre: 'MIGUEL ANGEL ARENAS' },
    { codigo: 'betty',     nombre: 'BETTY MUÑOZ' },
    { codigo: 'colon',     nombre: 'COLON' },
    { codigo: 'sarmiento', nombre: 'SARMIENTO' },
    { codigo: 'niches',    nombre: 'LOS NICHES' }
  ],
  establecimientos: [
    { codigo: 'prosperidad', nombre: 'PROSPERIDAD',          centro: 'miguel' },
    { codigo: 'tutuquen',    nombre: 'PSR TUTUQUEN',         centro: 'colon' },
    { codigo: 'porvenir',    nombre: 'PSR PORVENIR',         centro: 'betty' },
    { codigo: 'dona_carmen', nombre: 'DOÑA CARMEN',          centro: 'sarmiento' },
    { codigo: 'potrero',     nombre: 'PSR POTRERO GRANDE',   centro: 'niches' },
    { codigo: 'chequenlemu', nombre: 'PSR CHEQUENLEMU',      centro: 'niches' },
    { codigo: 'upeo',        nombre: 'PSR UPEO',             centro: 'niches' },
    { codigo: 'obra',        nombre: 'PSR LA OBRA',             centro: 'niches' },
    { codigo: 's_niches',        nombre: 'SUR LOS NICHES',             centro: 'niches' },
    { codigo: 'cordillerilla', nombre: 'PSR CORDILLERILLA',  centro: 'niches' },
    { codigo: 'sapu_curico',        nombre: 'SAPU CURICO CENTRO',   centro: 'curico' },
    { codigo: 'sar2',        nombre: 'SAR AGUAS NEGRAS',      centro: 'miguel' },
    { codigo: 'sar1',        nombre: 'SAR BOMBERO GARRIDO',   centro: 'colon' },
  ],

  indicadores: [
    {
        codigo: 'I',
        nombre: 'Recuperación desarrollo psicomotor niños 12-23 meses',
        tipo: 'porcentaje',
        meta: 87.10,
        importancia: 12.50,
        resultados: [
            { centro: 'comunal', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'curico', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'miguel', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'prosperidad', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'colon', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'betty', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'sarmiento', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'dona_carmen', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'niches', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'obra', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 }
        ]
    },
    {
        codigo: 'II',
        nombre: 'Tamizaje cáncer cuello uterino 25-64 años',
        tipo: 'porcentaje',
        meta: 80.00,
        importancia: 12.50,
        resultados: [
            { centro: 'comunal', numerador: 36091, denominador: 45321, resultado: 79.63, cumplimiento: 99.54 },
            { centro: 'curico', numerador: 11700, denominador: 13289, resultado: 88.04, cumplimiento: 110.05 },
            { centro: 'miguel', numerador: 5376, denominador: 8300, resultado: 64.77, cumplimiento: 80.96 },
            { centro: 'prosperidad', numerador: 1390, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'colon', numerador: 5000, denominador: 7076, resultado: 70.66, cumplimiento: 88.33 },
            { centro: 'tutuquen', numerador: 57, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'betty', numerador: 5924, denominador: 8917, resultado: 66.43, cumplimiento: 83.04 },
            { centro: 'porvenir', numerador: 451, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'sarmiento', numerador: 2514, denominador: 3902, resultado: 64.43, cumplimiento: 80.54 },
            { centro: 'dona_carmen', numerador: 839, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'niches', numerador: 2366, denominador: 3837, resultado: 61.66, cumplimiento: 77.08 },
            { centro: 'potrero', numerador: 130, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'chequenlemu', numerador: 37, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'upeo', numerador: 36, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'cordillerilla', numerador: 101, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'obra', numerador: 170, denominador: 0, resultado: 0.00, cumplimiento: 0.00 }
        ]
    },
    {
        codigo: 'III.A',
        nombre: 'Niños 0-9 años con pauta CERO aplicada',
        tipo: 'porcentaje',
        meta: 45.00,
        importancia: 6.25,
        resultados: [
            { centro: 'comunal', numerador: 1936, denominador: 49737, resultado: 3.89, cumplimiento: 8.65 },
            { centro: 'curico', numerador: 426, denominador: 11634, resultado: 3.66, cumplimiento: 8.14 },
            { centro: 'miguel', numerador: 239, denominador: 9597, resultado: 2.49, cumplimiento: 5.53 },
            { centro: 'prosperidad', numerador: 56, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'colon', numerador: 264, denominador: 8574, resultado: 3.08, cumplimiento: 6.84 },
            { centro: 'tutuquen', numerador: 3, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'betty', numerador: 395, denominador: 11346, resultado: 3.48, cumplimiento: 7.74 },
            { centro: 'porvenir', numerador: 19, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'sarmiento', numerador: 191, denominador: 4407, resultado: 4.33, cumplimiento: 9.63 },
            { centro: 'dona_carmen', numerador: 65, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'niches', numerador: 278, denominador: 4179, resultado: 6.65, cumplimiento: 14.78 },
            { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'obra', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 }
        ]
    },
    {
        codigo: 'III.B',
        nombre: 'Niños 6 años libres de caries',
        tipo: 'porcentaje',
        meta: 20.00,
        importancia: 6.25,
        resultados: [
            { centro: 'comunal', numerador: 42, denominador: 1850, resultado: 2.27, cumplimiento: 11.35 },
            { centro: 'curico', numerador: 8, denominador: 468, resultado: 1.71, cumplimiento: 8.55 },
            { centro: 'miguel', numerador: 3, denominador: 266, resultado: 1.13, cumplimiento: 5.64 },
            { centro: 'prosperidad', numerador: 2, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'colon', numerador: 6, denominador: 347, resultado: 1.73, cumplimiento: 8.65 },
            { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'betty', numerador: 11, denominador: 466, resultado: 2.36, cumplimiento: 11.80 },
            { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'sarmiento', numerador: 4, denominador: 158, resultado: 2.53, cumplimiento: 12.66 },
            { centro: 'dona_carmen', numerador: 1, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'niches', numerador: 7, denominador: 145, resultado: 4.83, cumplimiento: 24.14 },
            { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'obra', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 }
        ]
    },
    {
        codigo: 'IV.A',
        nombre: 'Cobertura efectiva DM2 personas 15+ años',
        tipo: 'porcentaje',
        meta: 29.00,
        importancia: 12.50,
        resultados: [
            { centro: 'comunal', numerador: 16173, denominador: 16542, resultado: 97.77, cumplimiento: 337.14 },
            { centro: 'curico', numerador: 4527, denominador: 4868, resultado: 92.99, cumplimiento: 320.65 },
            { centro: 'miguel', numerador: 2772, denominador: 3100, resultado: 89.41, cumplimiento: 308.30 },
            { centro: 'prosperidad', numerador: 336, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'colon', numerador: 2316, denominador: 2564, resultado: 90.34, cumplimiento: 311.51 },
            { centro: 'tutuquen', numerador: 87, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'betty', numerador: 2730, denominador: 2982, resultado: 91.56, cumplimiento: 315.72 },
            { centro: 'porvenir', numerador: 93, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'sarmiento', numerador: 1314, denominador: 1419, resultado: 92.59, cumplimiento: 319.29 },
            { centro: 'dona_carmen', numerador: 288, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'niches', numerador: 1311, denominador: 1608, resultado: 81.52, cumplimiento: 281.09 },
            { centro: 'potrero', numerador: 105, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'chequenlemu', numerador: 42, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'upeo', numerador: 57, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'cordillerilla', numerador: 90, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'obra', numerador: 105, denominador: 0, resultado: 0.00, cumplimiento: 0.00 }
        ]
    },
    {
        codigo: 'IV.B',
        nombre: 'Evaluación pie diabético DM2 15+ años',
        tipo: 'porcentaje',
        meta: 88.84,
        importancia: 12.50,
        resultados: [
            { centro: 'comunal', numerador: 29292, denominador: 32976, resultado: 88.83, cumplimiento: 99.99 },
            { centro: 'curico', numerador: 7362, denominador: 8703, resultado: 84.59, cumplimiento: 95.22 },
            { centro: 'miguel', numerador: 5220, denominador: 5913, resultado: 88.28, cumplimiento: 99.37 },
            { centro: 'prosperidad', numerador: 891, denominador: 939, resultado: 94.89, cumplimiento: 106.81 },
            { centro: 'colon', numerador: 4257, denominador: 4746, resultado: 89.70, cumplimiento: 100.96 },
            { centro: 'tutuquen', numerador: 150, denominador: 171, resultado: 87.72, cumplimiento: 98.74 },
            { centro: 'betty', numerador: 4833, denominador: 5403, resultado: 89.45, cumplimiento: 100.69 },
            { centro: 'porvenir', numerador: 171, denominador: 189, resultado: 90.48, cumplimiento: 101.84 },
            { centro: 'sarmiento', numerador: 2433, denominador: 2568, resultado: 94.74, cumplimiento: 106.64 },
            { centro: 'dona_carmen', numerador: 522, denominador: 576, resultado: 90.63, cumplimiento: 102.01 },
            { centro: 'niches', numerador: 2658, denominador: 2934, resultado: 90.59, cumplimiento: 101.97 },
            { centro: 'potrero', numerador: 186, denominador: 189, resultado: 98.41, cumplimiento: 110.78 },
            { centro: 'chequenlemu', numerador: 66, denominador: 69, resultado: 95.65, cumplimiento: 107.67 },
            { centro: 'upeo', numerador: 111, denominador: 123, resultado: 90.24, cumplimiento: 101.58 },
            { centro: 'cordillerilla', numerador: 156, denominador: 156, resultado: 100.00, cumplimiento: 112.56 },
            { centro: 'obra', numerador: 276, denominador: 297, resultado: 92.93, cumplimiento: 104.60 }
        ]
    },
    {
        codigo: 'V',
        nombre: 'Cobertura efectiva HTA 15+ años',
        tipo: 'porcentaje',
        meta: 42.00,
        importancia: 12.50,
        resultados: [
            { centro: 'comunal', numerador: 45540, denominador: 112173, resultado: 40.60, cumplimiento: 96.66 },
            { centro: 'curico', numerador: 12300, denominador: 33196, resultado: 37.05, cumplimiento: 88.22 },
            { centro: 'miguel', numerador: 7806, denominador: 20958, resultado: 37.25, cumplimiento: 88.68 },
            { centro: 'prosperidad', numerador: 1083, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'colon', numerador: 7347, denominador: 17341, resultado: 42.37, cumplimiento: 100.88 },
            { centro: 'tutuquen', numerador: 249, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'betty', numerador: 7506, denominador: 20150, resultado: 37.25, cumplimiento: 88.69 },
            { centro: 'porvenir', numerador: 303, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'sarmiento', numerador: 3405, denominador: 9553, resultado: 35.64, cumplimiento: 84.86 },
            { centro: 'dona_carmen', numerador: 753, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'niches', numerador: 3693, denominador: 10975, resultado: 33.65, cumplimiento: 80.12 },
            { centro: 'potrero', numerador: 285, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'chequenlemu', numerador: 162, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'upeo', numerador: 147, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'cordillerilla', numerador: 204, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'obra', numerador: 297, denominador: 0, resultado: 0.00, cumplimiento: 0.00 }
        ]
    },
    {
        codigo: 'VI',
        nombre: 'Prevalencia lactancia materna exclusiva 6° mes',
        tipo: 'porcentaje',
        meta: 60.00,
        importancia: 12.50,
        resultados: [
            { centro: 'comunal', numerador: 163, denominador: 281, resultado: 58.01, cumplimiento: 96.68 },
            { centro: 'curico', numerador: 31, denominador: 49, resultado: 63.27, cumplimiento: 105.44 },
            { centro: 'miguel', numerador: 24, denominador: 48, resultado: 50.00, cumplimiento: 83.33 },
            { centro: 'prosperidad', numerador: 2, denominador: 7, resultado: 28.57, cumplimiento: 47.62 },
            { centro: 'colon', numerador: 35, denominador: 57, resultado: 61.40, cumplimiento: 102.34 },
            { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'betty', numerador: 35, denominador: 58, resultado: 60.34, cumplimiento: 100.57 },
            { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'sarmiento', numerador: 16, denominador: 26, resultado: 61.54, cumplimiento: 102.56 },
            { centro: 'dona_carmen', numerador: 4, denominador: 10, resultado: 40.00, cumplimiento: 66.67 },
            { centro: 'niches', numerador: 15, denominador: 25, resultado: 60.00, cumplimiento: 100.00 },
            { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'cordillerilla', numerador: 1, denominador: 1, resultado: 100.00, cumplimiento: 166.67 },
            { centro: 'obra', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 }
        ]
    },
    {
        codigo: 'VII',
        nombre: 'Cobertura efectiva enfermedades respiratorias 5+ años',
        tipo: 'porcentaje',
        meta: 13.58,
        importancia: 6.25,
        resultados: [
            { centro: 'comunal', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'curico', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'miguel', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'prosperidad', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'colon', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'tutuquen', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'betty', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'porvenir', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'sarmiento', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'dona_carmen', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'niches', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'potrero', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'chequenlemu', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'upeo', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'cordillerilla', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 },
            { centro: 'obra', numerador: 0, denominador: 0, resultado: 0.00, cumplimiento: 0.00 }
        ]
    },
    {
        codigo: 'VIII',
        nombre: 'Plan participación social funcionando',
        tipo: 'porcentaje',
        meta: 100.00,
        importancia: 6.25,
        resultados: [
            { centro: 'comunal', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'curico', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'miguel', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'prosperidad', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'colon', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'tutuquen', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'betty', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'porvenir', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'sarmiento', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'dona_carmen', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'niches', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'potrero', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'chequenlemu', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'upeo', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'cordillerilla', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 },
            { centro: 'obra', numerador: 100, denominador: 100, resultado: 100.00, cumplimiento: 100.00 }
            ]
}
                ]
                };
                
                // Simular un retraso para mostrar el indicador de carga
                setTimeout(() => {
                    resolve(iaapsData);
                }, 1500);
            });
        }

        
        
        // Función para procesar datos
        function procesarDatos() {
            // Calcular estadísticas y métricas adicionales para el dashboard
            if (!iaapsData) return;
            
            // Normalizar cumplimientos (máximo 100%)
            iaapsData.indicadores.forEach(indicador => {
                indicador.resultados.forEach(resultado => {
                    if (resultado.cumplimiento > 100) {
                        resultado.cumplimiento = 100;
                    }
                });
            });
        }
        
        // Función para actualizar el dashboard
        function actualizarDashboard() {
            if (!iaapsData) return;
            
            // Actualizar tarjetas de resumen
            actualizarTarjetasResumen();
            
            // Actualizar gráfico de centros
            actualizarGraficoCentros();
            
            // Actualizar tabla de indicadores
            actualizarTablaIndicadores();
            
            // Actualizar top indicadores
            actualizarTopIndicadores();
            
            // Actualizar tarjetas de centros
            actualizarTarjetasCentros();
        }
        
        // Función para actualizar las tarjetas de resumen
function actualizarTarjetasResumen() {
    // Calcular estadísticas generales
    let totalIndicadores = 0;
    let indicadoresCumplidos = 0;
    let indicadoresParciales = 0;
    let indicadoresCriticos = 0;
    let cumplimientoTotal = 0;
    
    // Variables para cálculo ponderado
    let sumaPonderada = 0;
    let sumaPonderaciones = 0;
    
    // Solo contar indicadores comunales
    iaapsData.indicadores.forEach(indicador => {
        const resultadoComunal = indicador.resultados.find(r => r.centro === 'comunal');
        if (resultadoComunal) {
            totalIndicadores++;
            cumplimientoTotal += resultadoComunal.cumplimiento || 0;
            
            if (resultadoComunal.cumplimiento >= 100) {
                indicadoresCumplidos++;
            } else if (resultadoComunal.cumplimiento >= 25) {
                indicadoresParciales++;
            } else {
                indicadoresCriticos++;
            }
            
            // Cálculo ponderado (ignorando indicador 10-GES)
            if (indicador.codigo !== '10') {
                // Extraer valor numérico de importancia
                const importanciaStr = importanciaIndicadores[indicador.codigo] || '0%';
                const importancia = parseFloat(importanciaStr.replace('%', '')) || 0;
                
                if (importancia > 0) {
                    // Limitar cumplimiento máximo a 100%
                    const cumplimientoEfectivo = Math.min(resultadoComunal.cumplimiento || 0, 100);
                    sumaPonderada += cumplimientoEfectivo * importancia;
                    sumaPonderaciones += importancia;
                }
            }
        }
    });
    
    // Cálculo simple (original)
    const cumplimientoPromedio = totalIndicadores > 0 ? (cumplimientoTotal / totalIndicadores).toFixed(2) : 0;
    
    // Cálculo ponderado (nuevo)
    const cumplimientoGlobal = sumaPonderaciones > 0 ? 
        parseFloat((sumaPonderada / sumaPonderaciones).toFixed(2)) : 0;
    
    // Actualizar valores en la interfaz
    document.getElementById('indicadorCumplidosValue').textContent = indicadoresCumplidos;
    document.getElementById('indicadorParcialValue').textContent = indicadoresParciales;
    document.getElementById('indicadorCriticosValue').textContent = indicadoresCriticos;
    document.getElementById('cumplimientoComunalValue').textContent = cumplimientoGlobal + '%';
    
    // Actualizar barras de progreso
    document.getElementById('indicadorCumplidosProgress').style.width = (indicadoresCumplidos / totalIndicadores * 100) + '%';
    document.getElementById('indicadorParcialProgress').style.width = (indicadoresParciales / totalIndicadores * 100) + '%';
    document.getElementById('indicadorCriticosProgress').style.width = (indicadoresCriticos / totalIndicadores * 100) + '%';
    document.getElementById('cumplimientoComunalProgress').style.width = cumplimientoGlobal + '%';
}
        
       // Declaración global (por ejemplo, justo después de tus imports y antes de cualquier función)
let centroChartInstance = null;

// Función para actualizar el gráfico de centros
function actualizarGraficoCentros() {
    const centrosLabels = iaapsData.centros
        .filter(centro => centro.codigo !== 'comunal')
        .map(centro => centro.nombre);
    
    const centrosCumplimiento = [];
    
    iaapsData.centros
        .filter(centro => centro.codigo !== 'comunal')
        .forEach(centro => {
            let cumplimientoTotal = 0;
            let indicadoresContados = 0;
            
            iaapsData.indicadores.forEach(indicador => {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado && resultado.denominador > 0) {
                    cumplimientoTotal += resultado.cumplimiento || 0;
                    indicadoresContados++;
                }
            });
            
            const cumplimientoPromedio = indicadoresContados > 0
                ? parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2))
                : 0;
            
            centrosCumplimiento.push(cumplimientoPromedio);
        });
    
    const ctx = document.getElementById('centroChart').getContext('2d');
    
    // Destruye la instancia anterior (si existe)
    if (centroChartInstance) {
        centroChartInstance.destroy();
    }
    
    // Crea y guarda la nueva instancia
    centroChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: centrosLabels,
            datasets: [{
                label: 'Cumplimiento (%)',
                data: centrosCumplimiento,
                backgroundColor: function(context) {
                    const value = context.dataset.data[context.dataIndex];
                    if (value >= 100) return '#27ae60';
                    else if (value >= 25) return '#f39c12';
                    else return '#e74c3c';
                },
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `Cumplimiento: ${ctx.formattedValue}%`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Cumplimiento (%)' }
                },
                x: {
                    title: { display: true, text: 'Centros de Salud' }
                }
            }
        }
    });
    
    // Finalmente actualiza también la tabla
    actualizarTablaCentros();
}

        
        // Función para actualizar la tabla de centros
        function actualizarTablaCentros() {
            const tableBody = document.getElementById('centroCumplimientoTableBody');
            tableBody.innerHTML = '';
            
            iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                let indicadoresCumplidos = 0;
                let indicadoresParciales = 0;
                let indicadoresCriticos = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (resultado && resultado.denominador > 0) {
                        const cumplimiento = resultado.cumplimiento || 0;
                        cumplimientoTotal += cumplimiento;
                        indicadoresContados++;
                        
                        if (cumplimiento >= 100) {
                            indicadoresCumplidos++;
                        } else if (cumplimiento >= 25) {
                            indicadoresParciales++;
                        } else {
                            indicadoresCriticos++;
                        }
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2)) : 0;
                
                let statusClass = '';
                if (cumplimientoPromedio >= 100) statusClass = 'bg-success';
                else if (cumplimientoPromedio >= 25) statusClass = 'bg-warning';
                else statusClass = 'bg-danger';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${centro.nombre}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${cumplimientoPromedio}%" aria-valuenow="${cumplimientoPromedio}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${cumplimientoPromedio}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${indicadoresCumplidos}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning">${indicadoresParciales}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-danger">${indicadoresCriticos}</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary btn-ver-detalle" data-centro="${centro.codigo}">
                            <i class="fas fa-eye me-1"></i> Ver detalle
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Event listeners para los botones de ver detalle
            document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const centro = this.dataset.centro;
                    mostrarVista('detailView');
                    seleccionarCentro(centro);
                });
            });
        }
        
       // Variables globales para almacenar las instancias de Chart.js
let topIndicadoresChartInstance = null;
let bottomIndicadoresChartInstance = null;





/**
 * Función para actualizar los top/bottom 5 indicadores comunales
 */
function actualizarTopIndicadores() {
    // 1) Recopilar cumplimiento comunal de cada indicador
    const indicadoresComunales = iaapsData.indicadores
        .map(ind => {
            const res = ind.resultados.find(r => r.centro === 'comunal');
            return res && res.denominador > 0
                ? { codigo: ind.codigo, nombre: ind.nombre, cumplimiento: res.cumplimiento || 0 }
                : null;
        })
        .filter(x => x !== null);

    // 2) Ordenar de mayor a menor cumplimiento
    const ordenadosDesc = [...indicadoresComunales].sort((a, b) => b.cumplimiento - a.cumplimiento);

    // 3) Top 5 y bottom 5
    const top5    = ordenadosDesc.slice(0, 5);
    const bottom5 = [...ordenadosDesc].reverse().slice(0, 5);

    // 4) Renderizar los dos gráficos
    actualizarGraficoTop(top5,    'topIndicadoresChart',    true);
    actualizarGraficoTop(bottom5, 'bottomIndicadoresChart', false);
}

/**
 * Función para (re)dibujar uno de los gráficos horizontales de top/bottom indicadores
 *
 * @param {Array}  indicadores Array de objetos { codigo, nombre, cumplimiento }
 * @param {string} canvasId     ID del <canvas> en el DOM
 * @param {boolean} isTop       true si es el gráfico de top, false si es bottom
 */
function actualizarGraficoTop(indicadores, canvasId, isTop) {
    // Extraer etiquetas y datos
    const labels = indicadores.map(i => i.codigo);
    const data   = indicadores.map(i => i.cumplimiento);

    // Colores según rangos
    const backgroundColors = data.map(v =>
        v >= 100 ? '#27ae60'
      : v >= 25 ? '#f39c12'
      :            '#e74c3c'
    );

    // Obtener contexto
    const ctx = document.getElementById(canvasId).getContext('2d');

    // Destruir instancia previa si existía
    if (isTop && topIndicadoresChartInstance) {
        topIndicadoresChartInstance.destroy();
    }
    if (!isTop && bottomIndicadoresChartInstance) {
        bottomIndicadoresChartInstance.destroy();
    }

    // Configuración del nuevo gráfico
    const cfg = {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Cumplimiento (%)',
                data,
                backgroundColor: backgroundColors,
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: ctxItems => {
                            const idx = ctxItems[0].dataIndex;
                            const ind = indicadores[idx];
                            return `${ind.codigo} – ${ind.nombre}`;
                        },
                        label: ctxItem => `Cumplimiento: ${ctxItem.formattedValue}%`
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Cumplimiento (%)' }
                },
                y: {
                    title: { display: true, text: 'Indicador' }
                }
            }
        }
    };

    // Crear la instancia y guardarla
    const newChart = new Chart(ctx, cfg);
    if (isTop) {
        topIndicadoresChartInstance = newChart;
    } else {
        bottomIndicadoresChartInstance = newChart;
    }
}



        
        // Función para actualizar las tarjetas de centros
        function actualizarTarjetasCentros() {
            iaapsData.centros.filter(centro => centro.codigo !== 'comunal').forEach(centro => {
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (resultado && resultado.denominador > 0) {
                        cumplimientoTotal += resultado.cumplimiento || 0;
                        indicadoresContados++;
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    (cumplimientoTotal / indicadoresContados).toFixed(2) : 0;
                
                // Determinar clase de color
                let colorClass = '';
                if (cumplimientoPromedio >= 100) colorClass = 'bg-success';
                else if (cumplimientoPromedio >= 25) colorClass = 'bg-warning';
                else colorClass = 'bg-danger';
                
                // Actualizar tarjeta
                switch (centro.codigo) {
                    case 'curico':
                        document.getElementById('centroCuricoValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroCuricoProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroCuricoProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'miguel':
                        document.getElementById('centroMiguelValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroMiguelProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroMiguelProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'betty':
                        document.getElementById('centroBettyValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroBettyProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroBettyProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'colon':
                        document.getElementById('centroColonValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroColonProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroColonProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'sarmiento':
                        document.getElementById('centroSarmientoValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroSarmientoProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroSarmientoProgress').className = `progress-bar ${colorClass}`;
                        break;
                    case 'niches':
                        document.getElementById('centroNichesValue').textContent = cumplimientoPromedio + '%';
                        document.getElementById('centroNichesProgress').style.width = cumplimientoPromedio + '%';
                        document.getElementById('centroNichesProgress').className = `progress-bar ${colorClass}`;
                        break;
                }
            });
        }
        
        // Función para actualizar la vista de detalle
        function actualizarDetalle() {
            if (!iaapsData) return;
            
            // Actualizar detalle de centro seleccionado
            actualizarDetalleCentro();
            
            // Actualizar detalle de indicador seleccionado
            actualizarDetalleIndicador();
            
            // Actualizar vista comparativa
            actualizarVistaComparativa();
        }

        // Variables globales para las instancias de Chart.js
let centroCumplimientoChartInstance = null;
let centroIndicadoresChartInstance = null;

/**
 * Actualiza los gráficos de detalle para el centro seleccionado.
 * Esta función unificada sustituye a las versiones anteriores para evitar conflictos.
 */
function actualizarGraficosDetalleCentro() {
    console.log("Actualizando gráficos de detalle para centro:", currentCentro);
    
    // 1) Recolectar datos para el gráfico de donut (estado de indicadores)
    const datosCumplimiento = [0, 0, 0]; // [Cumplidos, Parciales, Críticos]
    
    // Contador para debugging
    let indicadoresAnalizados = 0;
    
    iaapsData.indicadores.forEach(indicador => {
        const res = indicador.resultados.find(r => r.centro === currentCentro);
        if (res && res.denominador > 0) {
            indicadoresAnalizados++;
            if (res.cumplimiento >= 100) {
                datosCumplimiento[0]++; // Cumplidos
            } else if (res.cumplimiento >= 25) {
                datosCumplimiento[1]++; // Parciales
            } else {
                datosCumplimiento[2]++; // Críticos
            }
        }
    });
    
    console.log("Indicadores analizados:", indicadoresAnalizados);
    console.log("Datos de cumplimiento:", datosCumplimiento);

    // 2) Destruir instancia previa si existe
    if (centroCumplimientoChartInstance) {
        centroCumplimientoChartInstance.destroy();
    }
    
    // Verificar que el elemento del DOM exista
    const ctxCumplimiento = document.getElementById('centroCumplimientoChart');
    if (!ctxCumplimiento) {
        console.error("No se encontró el elemento 'centroCumplimientoChart' en el DOM");
        return;
    }
    
    // 3) Crear gráfico de tipo "doughnut"
    try {
        centroCumplimientoChartInstance = new Chart(ctxCumplimiento.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Cumplidos', 'Parciales', 'Críticos'],
                datasets: [{
                    data: datosCumplimiento,
                    backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                    borderColor: ['#ffffff', '#ffffff', '#ffffff'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    title: { 
                        display: true, 
                        text: 'Estado de Indicadores',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const dataset = tooltipItem.dataset;
                                const total = dataset.data.reduce((acc, data) => acc + data, 0);
                                const value = dataset.data[tooltipItem.dataIndex];
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                return `${tooltipItem.label}: ${value} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error("Error al crear gráfico de cumplimiento:", error);
    }

    // 4) Preparar datos para el gráfico de barras por categoría
    const categoriasAcum = { 
        Cobertura: [], 
        Tasa: [], 
        Porcentaje: [], 
        Otros: [] 
    };
    
    iaapsData.indicadores.forEach(ind => {
        const res = ind.resultados.find(r => r.centro === currentCentro);
        if (res && res.denominador > 0) {
            // Clasificar por nombre o tipo
            if (/cobertura/i.test(ind.nombre)) {
                categoriasAcum.Cobertura.push(res.cumplimiento);
            } else if (ind.tipo === 'tasa') {
                categoriasAcum.Tasa.push(res.cumplimiento);
            } else if (ind.tipo === 'porcentaje') {
                categoriasAcum.Porcentaje.push(res.cumplimiento);
            } else {
                categoriasAcum.Otros.push(res.cumplimiento);
            }
        }
    });
    
    // Calcular promedios por categoría
    const categorias = [];
    const promedios = [];
    
    for (const [cat, vals] of Object.entries(categoriasAcum)) {
        if (vals.length) {
            categorias.push(cat);
            const suma = vals.reduce((a, b) => a + b, 0);
            promedios.push(parseFloat((suma / vals.length).toFixed(2)));
        }
    }
    
    console.log("Categorías:", categorias);
    console.log("Promedios:", promedios);

    // 5) Destruir instancia previa si existe
    if (centroIndicadoresChartInstance) {
        centroIndicadoresChartInstance.destroy();
    }
    
    // Verificar que el elemento del DOM exista
    const ctxCategoria = document.getElementById('centroIndicadoresChart');
    if (!ctxCategoria) {
        console.error("No se encontró el elemento 'centroIndicadoresChart' en el DOM");
        return;
    }

    // 6) Crear gráfico de barras solo si hay datos
    if (categorias.length > 0) {
        try {
            centroIndicadoresChartInstance = new Chart(ctxCategoria.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: categorias,
                    datasets: [{
                        label: 'Cumplimiento promedio (%)',
                        data: promedios,
                        backgroundColor: function(ctx) {
                            const v = ctx.raw;
                            return v >= 100 ? '#27ae60' : v >= 25 ? '#f39c12' : '#e74c3c';
                        },
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { 
                            display: true, 
                            text: 'Cumplimiento por Categoría',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { 
                                display: true, 
                                text: 'Cumplimiento (%)',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            title: { 
                                display: true, 
                                text: 'Categoría',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error al crear gráfico de categorías:", error);
        }
    } else {
        console.warn("No hay datos suficientes para crear el gráfico de categorías");
        // Mostrar mensaje en el canvas
        const ctx = ctxCategoria.getContext('2d');
        ctx.clearRect(0, 0, ctxCategoria.width, ctxCategoria.height);
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#666';
        ctx.fillText('No hay datos suficientes para esta visualización', 
                    ctxCategoria.width / 2, ctxCategoria.height / 2);
    }
}

// Modificación de la función actualizarDetalleCentro para asegurar que llame correctamente
function actualizarDetalleCentro() {
    if (!iaapsData) {
        console.error("Datos Meta Sanitaria  no disponibles");
        return;
    }
    
    console.log("Actualizando detalle del centro:", currentCentro);
    
    if (currentCentro === 'comunal') {
        document.getElementById('establecimientosCard').style.display = 'none';
        document.getElementById('centroCumplimientoTitle').textContent = 'Cumplimiento Meta Sanitaria  Comunal';
    } else {
        const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
        if (centro) {
            document.getElementById('centroCumplimientoTitle').textContent = `Cumplimiento Meta Sanitaria - ${centro.nombre}`;
            
            // Verificar si tiene establecimientos
            const tieneEstablecimientos = establecimientosMap[currentCentro] && establecimientosMap[currentCentro].length > 0;
            document.getElementById('establecimientosCard').style.display = tieneEstablecimientos ? 'block' : 'none';
            
            if (tieneEstablecimientos) {
                actualizarTablaEstablecimientos();
            }
        } else {
            console.error("Centro no encontrado:", currentCentro);
        }
    }
    
    // Actualizar gráficos y tabla de indicadores del centro
    // Envolver en setTimeout para asegurar que el DOM esté actualizado
    setTimeout(() => {
        actualizarGraficosDetalleCentro();
        actualizarTablaIndicadoresCentro();
    }, 50);
}

// Asegurarse de que Chart.js tenga la configuración correcta
function configurarChart() {
    // Configuración global para todos los gráficos
    Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#666';
    
    // Configurar animaciones más suaves
    Chart.defaults.animation.duration = 1000;
    Chart.defaults.animation.easing = 'easeOutQuart';
    
    // Configurar colores para modo oscuro si está activo
    if (document.body.classList.contains('dark-mode')) {
        Chart.defaults.color = '#e0e0e0';
        Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.1)';
    }
}

// Llamar a la configuración cuando se carga la página
document.addEventListener('DOMContentLoaded', configurarChart);

// También configurar cuando se cambia el modo oscuro
document.getElementById('darkModeToggle').addEventListener('change', configurarChart);


        
        
        // Función para actualizar la tabla de indicadores del centro
        function actualizarTablaIndicadoresCentro() {
            const tableBody = document.getElementById('centroIndicadoresTableBody');
            tableBody.innerHTML = '';
            
            // Ordenar indicadores por código
            const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
                const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
                const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
                return codigoA - codigoB;
            });
            
            indicadoresOrdenados.forEach(indicador => {
                const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                if (!resultado) return;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                
                if (resultado.cumplimiento >= 100) {
                    statusClass = 'bg-success';
                    statusIcon = 'fa-check-circle';
                    statusText = 'Cumplido';
                } else if (resultado.cumplimiento >= 25) {
                    statusClass = 'bg-warning';
                    statusIcon = 'fa-exclamation-triangle';
                    statusText = 'Parcial';
                } else {
                    statusClass = 'bg-danger';
                    statusIcon = 'fa-times-circle';
                    statusText = 'Crítico';
                }
                
                // Verificar si el valor de resultado debe mostrarse como porcentaje o número
                let resultadoFormateado = '';
                let metaFormateada = '';
                
                if (indicador.tipo === 'porcentaje') {
                    resultadoFormateado = resultado.resultado.toFixed(2) + '%';
                    metaFormateada = indicador.meta.toFixed(2) + '%';
                } else {
                    resultadoFormateado = resultado.resultado.toFixed(2);
                    metaFormateada = indicador.meta.toFixed(2);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${indicador.codigo}</strong> - ${indicador.nombre}
                    </td>
                    <td class="text-center">${resultado.numerador}</td>
                    <td class="text-center">${resultado.denominador}</td>
                    <td class="text-center">${resultadoFormateado}</td>
                    <td class="text-center">${metaFormateada}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${Math.min(resultado.cumplimiento, 100)}%" aria-valuenow="${resultado.cumplimiento}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${resultado.cumplimiento.toFixed(2)}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge ${statusClass}">
                            <i class="fas ${statusIcon} me-1"></i> ${statusText}
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Función para actualizar la tabla de establecimientos
        function actualizarTablaEstablecimientos() {
            const tableBody = document.getElementById('establecimientosTableBody');
            tableBody.innerHTML = '';
            
            // Obtener los establecimientos del centro actual
            const establecimientos = establecimientosMap[currentCentro] || [];
            
            establecimientos.forEach(establecimientoNombre => {
                const establecimientoCodigo = iaapsData.establecimientos
                    .find(e => e.nombre === establecimientoNombre)?.codigo;
                
                if (!establecimientoCodigo) return;
                
                let cumplimientoTotal = 0;
                let indicadoresContados = 0;
                let indicadoresCumplidos = 0;
                let indicadoresParciales = 0;
                let indicadoresCriticos = 0;
                
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === establecimientoCodigo);
                    if (resultado && resultado.denominador > 0) {
                        cumplimientoTotal += resultado.cumplimiento || 0;
                        indicadoresContados++;
                        
                        if (resultado.cumplimiento >= 25) {
                            indicadoresCumplidos++;
                        } else if (resultado.cumplimiento >= 20) {
                            indicadoresParciales++;
                        } else {
                            indicadoresCriticos++;
                        }
                    }
                });
                
                const cumplimientoPromedio = indicadoresContados > 0 ? 
                    parseFloat((cumplimientoTotal / indicadoresContados).toFixed(2)) : 0;
                
                let statusClass = '';
                if (cumplimientoPromedio >= 25) statusClass = 'bg-success';
                else if (cumplimientoPromedio >= 80) statusClass = 'bg-warning';
                else statusClass = 'bg-danger';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${establecimientoNombre}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${cumplimientoPromedio}%" aria-valuenow="${cumplimientoPromedio}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span>${cumplimientoPromedio}%</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${indicadoresCumplidos}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning">${indicadoresParciales}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-danger">${indicadoresCriticos}</span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
       // Instancias globales para los dos charts de indicador

/**
 * Actualiza todo el bloque de detalle de un indicador:
 * - Títulos, fórmulas, meta e importancia
 * - Gráficos de barras y de línea
 * - Tabla de valores por centro
 */
function actualizarDetalleIndicador() {
    const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
    if (!indicador) return;
    
    // 1) Actualizar texto descriptivo
    document.getElementById('indicadorDetailTitle').textContent =
      `Indicador ${indicador.codigo}: ${indicador.nombre}`;
    document.getElementById('indicadorNombreCompleto').textContent = indicador.nombre;
    document.getElementById('indicadorMetaValor').textContent =
      indicador.meta.toFixed(2) + (indicador.tipo === 'porcentaje' ? '%' : '');
    document.getElementById('indicadorImportanciaValor').textContent =
      importanciaIndicadores[indicador.codigo];
    document.getElementById('indicadorNumeradorFormula').textContent =
      formulasIndicadores[indicador.codigo].numerador;
    document.getElementById('indicadorDenominadorFormula').textContent =
      formulasIndicadores[indicador.codigo].denominador;
    
    // 2) Actualizar gráficos
    actualizarGraficosDetalleIndicador(indicador);
    
    // 3) Actualizar tabla
    actualizarTablaDetalleIndicador(indicador);
}


/**
 * Dibuja (o redibuja) los dos gráficos dentro de la pestaña de detalle
 */
function actualizarGraficosDetalleIndicador(indicador) {
  // ————————————————
  //  A) GRÁFICO DE BARRAS: cumplimiento por centro
  // ————————————————
  const labels = [];
  const data = [];
  iaapsData.centros
    .filter(c => c.codigo !== 'comunal')
    .forEach(c => {
      const r = indicador.resultados.find(x => x.centro === c.codigo);
      if (r && r.denominador > 0) {
        labels.push(c.nombre);
        data.push(r.cumplimiento || 0);
      }
    });

  // destruir instancia previa si existe
  if (indicadorCentrosChartInstance) {
    indicadorCentrosChartInstance.destroy();
  }

  const ctxBar = document.getElementById('indicadorCentrosChart').getContext('2d');
  indicadorCentrosChartInstance = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Cumplimiento (%)',
        data,
        backgroundColor: ctx => {
          const v = ctx.dataset.data[ctx.dataIndex];
          return v >= 100 ? '#27ae60' : v >= 20 ? '#f39c12' : '#e74c3c';
        },
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Cumplimiento por Centro' }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Cumplimiento (%)' }
        },
        x: {
          title: { display: true, text: 'Centro de Salud' }
        }
      }
    }
  });

  // ————————————————
  //  B) GRÁFICO DE LÍNEA: tendencia mensual (simulada)
  // ————————————————
  const meses = ['Ene','Feb','Mar','Abr','May','Jun'];
  let v = Math.random() * 50 + 30;
  const trend = meses.map(() => {
    v = Math.max(0, Math.min(100, v + (Math.random()*10-5)));
    return parseFloat(v.toFixed(2));
  });
  const metaArr = Array(meses.length).fill(indicador.meta);

  if (indicadorTendenciaChartInstance) {
    indicadorTendenciaChartInstance.destroy();
  }

  const ctxLine = document.getElementById('indicadorTendenciaChart').getContext('2d');
  indicadorTendenciaChartInstance = new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Resultado',
          data: trend,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52,152,219,0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Meta',
          data: metaArr,
          borderColor: '#e74c3c',
          borderDash: [5,5],
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Tendencia Mensual' }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: indicador.tipo === 'porcentaje' ? 'Resultado (%)' : 'Resultado'
          }
        }
      }
    }
  });
}

/**
 * Rellena la tabla de detalle de indicador fila a fila
 */
function actualizarTablaDetalleIndicador(indicador) {
  const tbody = document.getElementById('indicadorCentrosTableBody');
  tbody.innerHTML = '';

  // fila comunal
  const rc = indicador.resultados.find(r => r.centro === 'comunal');
  if (rc) agregarFilaIndicador(tbody, indicador, rc, 'CURICÓ (COMUNAL)');

  // demás centros
  iaapsData.centros
    .filter(c => c.codigo !== 'comunal')
    .forEach(c => {
      const r = indicador.resultados.find(x => x.centro === c.codigo);
      if (r) agregarFilaIndicador(tbody, indicador, r, c.nombre);
    });
}

/**
 * Inserta una fila en la tabla dada, con sus badges
 */
function agregarFilaIndicador(tbody, indicador, resultado, nombre) {
  let cls, icon, txt;
  if (resultado.cumplimiento >= 100) {
    cls = 'bg-success'; icon = 'fa-check-circle'; txt = 'Cumplido';
  } else if (resultado.cumplimiento >= 20) {
    cls = 'bg-warning'; icon = 'fa-exclamation-triangle'; txt = 'Parcial';
  } else {
    cls = 'bg-danger'; icon = 'fa-times-circle'; txt = 'Crítico';
  }

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${nombre}</td>
    <td class="text-center">${resultado.numerador}</td>
    <td class="text-center">${resultado.denominador}</td>
    <td class="text-center">${
      indicador.tipo==='porcentaje'
        ? resultado.resultado.toFixed(2)+'%'
        : resultado.resultado.toFixed(2)
    }</td>
    <td class="text-center">${
      indicador.tipo==='porcentaje'
        ? indicador.meta.toFixed(2)+'%'
        : indicador.meta.toFixed(2)
    }</td>
    <td class="text-center">
      <span class="badge ${cls}">
        <i class="fas ${icon} me-1"></i> ${txt}
      </span>
    </td>
  `;
  tbody.appendChild(tr);
}

        
        // Función auxiliar para agregar una fila a la tabla de indicadores
        function agregarFilaIndicador(tableBody, indicador, resultado, nombreCentro) {
            let statusClass = '';
            let statusIcon = '';
            let statusText = '';
            
            if (resultado.cumplimiento >=100) {
                statusClass = 'bg-success';
                statusIcon = 'fa-check-circle';
                statusText = 'Cumplido';
            } else if (resultado.cumplimiento >= 25) {
                statusClass = 'bg-warning';
                statusIcon = 'fa-exclamation-triangle';
                statusText = 'Parcial';
            } else {
                statusClass = 'bg-danger';
                statusIcon = 'fa-times-circle';
                statusText = 'Crítico';
            }
            
            // Verificar si el valor de resultado debe mostrarse como porcentaje o número
            let resultadoFormateado = '';
            let metaFormateada = '';
            
            if (indicador.tipo === 'porcentaje') {
                resultadoFormateado = resultado.resultado.toFixed(2) + '%';
                metaFormateada = indicador.meta.toFixed(2) + '%';
            } else {
                resultadoFormateado = resultado.resultado.toFixed(2);
                metaFormateada = indicador.meta.toFixed(2);
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${nombreCentro}</td>
                <td class="text-center">${resultado.numerador}</td>
                <td class="text-center">${resultado.denominador}</td>
                <td class="text-center">${resultadoFormateado}</td>
                <td class="text-center">${metaFormateada}</td>
                <td class="text-center">
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                            <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${Math.min(resultado.cumplimiento, 100)}%" aria-valuenow="${resultado.cumplimiento}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span>${resultado.cumplimiento.toFixed(2)}%</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge ${statusClass}">
                        <i class="fas ${statusIcon} me-1"></i> ${statusText}
                    </span>
                </td>
            `;
            
            tableBody.appendChild(row);
        }
        
      
        
     /* IAAPS DASHBOARD - PARTE 2: FUNCIONALIDADES AVANZADAS */

/*
 * Este archivo complementa la parte 1 del dashboard IAAPS, añadiendo:
 * - Finalización de funciones principales
 * - Reconocimiento de voz para navegación
 * - Opciones avanzadas de exportación
 * - Integración de data warehouse
 * - Funcionalidades premium
 */

// Variable global para la instancia del gráfico comparativo
let comparativoChartInstance = null;

/**
 * Actualiza la vista comparativa completa
 * Esta función coordina la actualización de gráficos y tablas en la vista comparativa
 */
function actualizarVistaComparativa() {
    if (!iaapsData) {
        console.error("Datos Metas Sanitarias  no disponibles");
        return;
    }
    
    console.log("Actualizando vista comparativa...");
    
    // Actualizar gráfico comparativo
    setTimeout(() => {
        actualizarGraficoComparativo();
    }, 50);
    
    // Actualizar tabla comparativa
    setTimeout(() => {
        actualizarTablaComparativa();
    }, 100);
}

/**
 * Actualiza el gráfico comparativo de radar
 * Versión mejorada con mejor manejo de errores y visualización
 */


function actualizarGraficoComparativo() {
    console.log("Actualizando gráfico comparativo...");
    
    const canvasElement = document.getElementById('comparativoChart');
    if (!canvasElement) {
        console.error("No se encontró el elemento 'comparativoChart' en el DOM");
        return;
    }
    
    try {
        // 1) Incluir todos los centros (incluyendo 'comunal')
        const centros = iaapsData.centros;  // ahora con los 6 centros más el comunal
        
        // 2) Definir categorías
        const categorias = {
            'Cobertura': [],
            'Tasa': [],
            'Porcentaje': [],
            'Otro': []
        };
        iaapsData.indicadores.forEach(indicador => {
            const nombre = indicador.nombre.toLowerCase();
            if (nombre.includes('cobertura')) {
                categorias['Cobertura'].push(indicador.codigo);
            } else if (indicador.tipo === 'tasa') {
                categorias['Tasa'].push(indicador.codigo);
            } else if (indicador.tipo === 'porcentaje') {
                categorias['Porcentaje'].push(indicador.codigo);
            } else {
                categorias['Otro'].push(indicador.codigo);
            }
        });
        
        // 3) Preparar datasets
        const colores = [
            { border: 'rgb(52, 152, 219)', background: 'rgba(52, 152, 219, 0.2)' },
            { border: 'rgb(39, 174, 96)',  background: 'rgba(39, 174, 96, 0.2)'  },
            { border: 'rgb(231, 76, 60)',  background: 'rgba(231, 76, 60, 0.2)'  },
            { border: 'rgb(243, 156, 18)', background: 'rgba(243, 156, 18, 0.2)' }
        ];
        const datasets = [];
        let colorIndex = 0;
        
        for (const categoria in categorias) {
            const codigos = categorias[categoria];
            if (!codigos.length) continue;
            
            // Calcular cumplimiento promedio por centro
            const datosCentros = centros.map(centro => {
                let total = 0, count = 0;
                codigos.forEach(codigo => {
                    const ind = iaapsData.indicadores.find(i => i.codigo === codigo);
                    if (ind) {
                        const res = ind.resultados.find(r => r.centro === centro.codigo);
                        if (res && res.denominador > 0) {
                            total += res.cumplimiento || 0;
                            count++;
                        }
                    }
                });
                return count ? +(total / count).toFixed(2) : 0;
            });
            
            if (datosCentros.some(v => v > 0)) {
                const { border, background } = colores[colorIndex];
                datasets.push({
                    label: categoria,
                    data: datosCentros,
                    backgroundColor: background,
                    borderColor: border,
                    borderWidth: 1
                });
                colorIndex = (colorIndex + 1) % colores.length;
            }
        }
        
        // 4) Destruir instancia previa
        if (comparativoChartInstance) {
            comparativoChartInstance.destroy();
        }
        
        // 5) Validar que existan datos
        if (!datasets.length || !centros.length) {
            const ctx = canvasElement.getContext('2d');
            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#666';
            ctx.fillText(
                'No hay datos suficientes para esta visualización',
                canvasElement.width / 2,
                canvasElement.height / 2
            );
            return;
        }
        
        // 6) Crear gráfico de barras
        const ctx = canvasElement.getContext('2d');
        comparativoChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: centros.map(c => c.nombre),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Centros' },
                        ticks: { font: { size: 12 } }
                    },
                    y: {
                        min: 0,
                        max: 100,
                        title: { display: true, text: 'Cumplimiento (%)' },
                        ticks: {
                            stepSize: 20,
                            font: { size: 12 }
                        }
                    }
                },
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: value => `${value}%`,
                        font: { size: 10 }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12 },
                            padding: 20
                        }
                    },
                    title: {
                        display: true,
                        text: 'Comparativo de Cumplimiento por Categoría',
                        font: { size: 16, weight: 'bold' },
                        padding: 20
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
        
        console.log("Gráfico comparativo actualizado correctamente");
    } catch (error) {
        console.error("Error al actualizar gráfico comparativo:", error);
        const ctx = canvasElement.getContext('2d');
        ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#e74c3c';
        ctx.fillText(
            'Error al generar la visualización',
            canvasElement.width / 2,
            canvasElement.height / 2
        );
        ctx.font = '14px Arial';
        ctx.fillText(
            'Consulte la consola para más detalles',
            canvasElement.width / 2,
            canvasElement.height / 2 + 30
        );
    }
}


/**
 * Actualiza la tabla comparativa con datos de todos los centros e indicadores
 * Versión mejorada con mejor formateo y manejo de errores
 */
function actualizarTablaComparativa() {
    console.log("Actualizando tabla comparativa...");
    
    const tableBody = document.getElementById('comparativoTableBody');
    if (!tableBody) {
        console.error("No se encontró el elemento 'comparativoTableBody' en el DOM");
        return;
    }
    
    try {
        tableBody.innerHTML = '';
        
        // Ordenar indicadores por código
        const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
            const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
            const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
            return codigoA - codigoB;
        });
        
        // Crear una fila para cada indicador
        indicadoresOrdenados.forEach(indicador => {
            const row = document.createElement('tr');
            
            // Primera columna: nombre del indicador
            const tdIndicador = document.createElement('td');
            tdIndicador.innerHTML = `<strong>${indicador.codigo}</strong> - ${indicador.nombre}`;
            row.appendChild(tdIndicador);
            
            // Segunda columna: meta
            const tdMeta = document.createElement('td');
            tdMeta.className = 'text-center';
            tdMeta.textContent = indicador.tipo === 'porcentaje' ? 
                indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2);
            row.appendChild(tdMeta);
            
            // Columna para cada centro
            iaapsData.centros.forEach(centro => {
                const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                if (resultado) {
                    const tdCentro = document.createElement('td');
                    tdCentro.className = 'text-center table-percentage-cell';
                    
                    // Calcular color según porcentaje de cumplimiento
                    let color = '';
                    
                    if (resultado.cumplimiento >= 100) {
                        color = '#27ae60'; // Verde - Cumplido
                    } else if (resultado.cumplimiento >= 25) {
                        color = '#f39c12'; // Amarillo - Parcial
                    } else {
                        color = '#e74c3c'; // Rojo - Crítico
                    }
                    
                    // Limitar cumplimiento máximo a 100% para la visualización
                    const cumplimientoMostrado = Math.min(resultado.cumplimiento, 100);
                    
                    // Crear visualización de porcentaje con barra de fondo
                    tdCentro.innerHTML = `
                        <div class="table-percentage-bg" style="background-color: ${color}; width: ${cumplimientoMostrado}%;"></div>
                        <span class="table-percentage-text">${resultado.cumplimiento.toFixed(2)}%</span>
                    `;
                    
                    row.appendChild(tdCentro);
                } else {
                    const tdCentro = document.createElement('td');
                    tdCentro.className = 'text-center';
                    tdCentro.textContent = '-';
                    row.appendChild(tdCentro);
                }
            });
            
            tableBody.appendChild(row);
        });
        
        // Agregar evento para interactividad (opcional)
        const filas = tableBody.querySelectorAll('tr');
        filas.forEach(fila => {
            fila.addEventListener('mouseover', function() {
                this.style.backgroundColor = document.body.classList.contains('dark-mode') ?
                    'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.02)';
            });
            
            fila.addEventListener('mouseout', function() {
                this.style.backgroundColor = '';
            });
        });
        
        console.log("Tabla comparativa actualizada correctamente");
    } catch (error) {
        console.error("Error al actualizar tabla comparativa:", error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="${iaapsData.centros.length + 2}" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar la tabla comparativa. Consulte la consola para más detalles.
                </td>
            </tr>
        `;
    }
}

/**
 * Función auxiliar para exportar el gráfico comparativo a imagen
 * Nueva funcionalidad útil
 */
function exportarGraficoComparativoImagen() {
    if (!comparativoChartInstance) {
        mostrarNotificacion('No hay gráfico para exportar', 'error');
        return;
    }
    
    try {
        const canvas = document.getElementById('comparativoChart');
        const imgData = canvas.toDataURL('image/png');
        
        // Crear enlace de descarga
        const link = document.createElement('a');
        link.href = imgData;
        link.download = `Metas_Sanitaria_Comparativo_${new Date().toISOString().split('T')[0]}.png`;
        link.click();
        
        mostrarNotificacion('Imagen exportada correctamente', 'success');
    } catch (error) {
        console.error("Error al exportar imagen:", error);
        mostrarNotificacion('Error al exportar imagen', 'error');
    }
}

// Añadir botón de exportar imagen (opcional, puedes implementarlo en tu HTML)
function agregarBotonExportarImagen() {
    const btnContainer = document.querySelector('#comparativo-content .card-header div');
    if (btnContainer) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-primary ms-2';
        btn.innerHTML = '<i class="fas fa-image me-1"></i> PNG';
        btn.id = 'exportarComparativoImgBtn';
        btn.addEventListener('click', exportarGraficoComparativoImagen);
        btnContainer.appendChild(btn);
    }
}

// Ejecutar cuando se cargue la página
document.addEventListener('DOMContentLoaded', () => {
    // Escuchar cambios de pestaña para actualizar gráficos cuando se seleccione "Comparativo"
    const comparativoTab = document.getElementById('comparativo-tab');
    if (comparativoTab) {
        comparativoTab.addEventListener('shown.bs.tab', () => {
            setTimeout(actualizarVistaComparativa, 100);
        });
    }
    
    // Agregar botón de exportar imagen (opcional)
    setTimeout(agregarBotonExportarImagen, 1000);
});

// Función para buscar indicadores
function buscarIndicadores(searchTerm) {
    if (!searchTerm) {
        // Si no hay término de búsqueda, mostrar todos los indicadores
        document.querySelectorAll('.indicador-row').forEach(row => {
            row.style.display = '';
        });
        return;
    }
    
    document.querySelectorAll('.indicador-row').forEach(row => {
        const indicadorCodigo = row.dataset.indicador;
        const indicador = iaapsData.indicadores.find(i => i.codigo === indicadorCodigo);
        
        if (indicador) {
            const textoIndicador = (indicador.codigo + ' ' + indicador.nombre).toLowerCase();
            
            if (textoIndicador.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}

// Función para seleccionar un centro
function seleccionarCentro(codigo) {
    currentCentro = codigo;
    
    // Actualizar título del breadcrumb
    if (codigo === 'comunal') {
        document.getElementById('detailBreadcrumb').textContent = 'Detalle Comunal';
    } else {
        const centro = iaapsData.centros.find(c => c.codigo === codigo);
        if (centro) {
            document.getElementById('detailBreadcrumb').textContent = 'Detalle ' + centro.nombre;
        }
    }
    
    // Actualizar vista de detalle
    actualizarDetalleCentro();
}

// Función para seleccionar un indicador
function seleccionarIndicador(codigo) {
    currentIndicador = codigo;
    
    // Actualizar título del breadcrumb
    const indicador = iaapsData.indicadores.find(i => i.codigo === codigo);
    if (indicador) {
        document.getElementById('detailBreadcrumb').textContent = 'Indicador ' + indicador.codigo;
    }
    
    // Actualizar vista de detalle
    actualizarDetalleIndicador();
}

// Función para mostrar una vista
function mostrarVista(vista) {
    const vistas = ['dashboardView', 'detailView'];
    
    vistas.forEach(v => {
        document.getElementById(v).style.display = v === vista ? 'block' : 'none';
    });
    
    // Actualizar clase active en la navegación
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    if (vista === 'dashboardView') {
        document.getElementById('dashboardLink').classList.add('active');
    } else if (vista === 'detailView') {
        document.getElementById('detailLink').classList.add('active');
    }
}

// Función para mostrar/ocultar indicador de carga
function mostrarCargando(mostrar) {
    document.getElementById('loadingOverlay').style.display = mostrar ? 'flex' : 'none';
}

// Función para mostrar notificación
function mostrarNotificacion(mensaje, tipo) {
    // Crear elemento de notificación
    const notificacion = document.createElement('div');
    notificacion.className = `toast align-items-center text-white bg-${tipo} border-0`;
    notificacion.setAttribute('role', 'alert');
    notificacion.setAttribute('aria-live', 'assertive');
    notificacion.setAttribute('aria-atomic', 'true');
    
    notificacion.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${mensaje}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Agregar al contenedor de notificaciones
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.appendChild(notificacion);
    document.body.appendChild(container);
    
    // Mostrar notificación
    const toast = new bootstrap.Toast(notificacion, { delay: 3000 });
    toast.show();
    
    // Eliminar del DOM después de ocultarse
    notificacion.addEventListener('hidden.bs.toast', function() {
        container.remove();
    });
}

// Función para exportar a Excel
function exportarExcel(tipo) {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            let data = [];
            let nombreArchivo = '';
            
            if (tipo === 'centro') {
                // Exportar datos del centro seleccionado
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (!centro) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `Meta_Sanitaria _${centro.nombre}_Marzo_2025.xlsx`;
                
                // Encabezados
                data.push(['Indicador', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']);
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                    if (!resultado) return;
                    
                    let estado = '';
                    if (resultado.cumplimiento >= 100) estado = 'Cumplido';
                    else if (resultado.cumplimiento >= 25) estado = 'Parcial';
                    else estado = 'Crítico';
                    
                    data.push([
                        `${indicador.codigo} - ${indicador.nombre}`,
                        resultado.numerador,
                        resultado.denominador,
                        indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        resultado.cumplimiento.toFixed(2) + '%',
                        estado
                    ]);
                });
            } else if (tipo === 'indicador') {
                // Exportar datos del indicador seleccionado
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                if (!indicador) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `Meta_Sanitaria _Indicador_${indicador.codigo}_Marzo_2025.xlsx`;
                
                // Encabezados
                data.push(['Centro', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']);
                
                // Datos
                iaapsData.centros.forEach(centro => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (!resultado) return;
                    
                    let estado = '';
                    if (resultado.cumplimiento >= 100) estado = 'Cumplido';
                    else if (resultado.cumplimiento >= 25) estado = 'Parcial';
                    else estado = 'Crítico';
                    
                    data.push([
                        centro.nombre,
                        resultado.numerador,
                        resultado.denominador,
                        indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        resultado.cumplimiento.toFixed(2) + '%',
                        estado
                    ]);
                });
            } else if (tipo === 'comparativo') {
                // Exportar tabla comparativa
                nombreArchivo = `Meta_Sanitaria _Comparativo_Marzo_2025.xlsx`;
                
                // Encabezados
                const headers = ['Indicador', 'Meta'];
                iaapsData.centros.forEach(centro => {
                    headers.push(centro.nombre);
                });
                data.push(headers);
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const row = [
                        `${indicador.codigo} - ${indicador.nombre}`,
                        indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
                    ];
                    
                    iaapsData.centros.forEach(centro => {
                        const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                        if (resultado) {
                            row.push(resultado.cumplimiento.toFixed(2) + '%');
                        } else {
                            row.push('-');
                        }
                    });
                    
                    data.push(row);
                });
            }
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Ajustar ancho de columnas
            const wscols = data[0].map((col, i) => {
                const maxLength = data.reduce((w, r) => Math.max(w, r[i] ? r[i].toString().length : 0), col.length);
                return { wch: maxLength + 2 };
            });
            ws['!cols'] = wscols;
            
            // Aplicar formato de celda
            for (let i = 1; i < data.length; i++) {
                for (let j = 0; j < data[i].length; j++) {
                    const cell_ref = XLSX.utils.encode_cell({ r: i, c: j });
                    
                    // Aplicar colores según estado para columna de cumplimiento
                    if (tipo === 'centro' && j === 5 || tipo === 'indicador' && j === 5) {
                        const cumplimiento = parseFloat(data[i][j]);
                        if (cumplimiento >= 100) {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "27AE60" } }, font: { color: { rgb: "FFFFFF" } } };
                        } else if (cumplimiento >= 25) {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "F39C12" } }, font: { color: { rgb: "FFFFFF" } } };
                        } else {
                            ws[cell_ref].s = { fill: { fgColor: { rgb: "E74C3C" } }, font: { color: { rgb: "FFFFFF" } } };
                        }
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "Meta Sanitaria ");
            XLSX.writeFile(wb, nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('Datos exportados correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a Excel:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos', 'error');
        }
    }, 1000);
}

// Función para exportar a PDF
function exportarPDF(tipo) {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let nombreArchivo = '';
            let titulo = '';
            let datos = [];
            let columnas = [];
            
            if (tipo === 'centro') {
                // Exportar datos del centro seleccionado
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (!centro) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `Meta_Sanitaria _${centro.nombre}_Marzo_2025.pdf`;
                titulo = `Reporte Meta_Sanitaria  - ${centro.nombre} - Marzo 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Indicador', dataKey: 'indicador' },
                    { header: 'Numerador', dataKey: 'numerador' },
                    { header: 'Denominador', dataKey: 'denominador' },
                    { header: 'Resultado', dataKey: 'resultado' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Cumplimiento', dataKey: 'cumplimiento' }
                ];
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                    if (!resultado) return;
                    
                    datos.push({
                        indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 30)}...`,
                        numerador: resultado.numerador,
                        denominador: resultado.denominador,
                        resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
            } else if (tipo === 'indicador') {
                // Exportar datos del indicador seleccionado
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                if (!indicador) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error al exportar datos', 'error');
                    return;
                }
                
                nombreArchivo = `Meta_Sanitaria _Indicador_${indicador.codigo}_Marzo_2025.pdf`;
                titulo = `Reporte Meta Sanitaria  - Indicador ${indicador.codigo} - Marzo 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Centro', dataKey: 'centro' },
                    { header: 'Numerador', dataKey: 'numerador' },
                    { header: 'Denominador', dataKey: 'denominador' },
                    { header: 'Resultado', dataKey: 'resultado' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Cumplimiento', dataKey: 'cumplimiento' }
                ];
                
                // Datos
                iaapsData.centros.forEach(centro => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (!resultado) return;
                    
                    datos.push({
                        centro: centro.nombre,
                        numerador: resultado.numerador,
                        denominador: resultado.denominador,
                        resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
            } else if (tipo === 'comparativo') {
                // Exportar tabla comparativa
                nombreArchivo = `Meta_Sanitaria _Comparativo_Marzo_2025.pdf`;
                titulo = `Reporte Meta_Sanitaria - Comparativo - Marzo 2025`;
                
                // Encabezados
                columnas = [
                    { header: 'Indicador', dataKey: 'indicador' },
                    { header: 'Meta', dataKey: 'meta' },
                    { header: 'Comunal', dataKey: 'comunal' }
                ];
                
                // Agregar columnas para cada centro excepto el comunal
                iaapsData.centros.filter(c => c.codigo !== 'comunal').forEach(centro => {
                    columnas.push({ header: centro.nombre, dataKey: centro.codigo });
                });
                
                // Datos
                iaapsData.indicadores.forEach(indicador => {
                    const row = {
                        indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 20)}...`,
                        meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
                    };
                    
                    // Agregar datos para cada centro
                    iaapsData.centros.forEach(centro => {
                        const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                        if (resultado) {
                            row[centro.codigo] = resultado.cumplimiento.toFixed(2) + '%';
                        } else {
                            row[centro.codigo] = '-';
                        }
                    });
                    
                    datos.push(row);
                });
            }
            
            // Añadir título
            doc.setFontSize(18);
            doc.text(titulo, 14, 22);
            
            // Añadir fecha
            doc.setFontSize(11);
            doc.text(`Fecha de generación: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Añadir tabla
            doc.autoTable({
                columns: columnas,
                body: datos,
                startY: 35,
                styles: { fontSize: 8 },
                columnStyles: {
                    indicador: { cellWidth: 60 }
                },
                didDrawCell: function(data) {
                    // Colorear celdas de cumplimiento
                    if ((tipo === 'centro' && data.column.dataKey === 'cumplimiento') || 
                        (tipo === 'indicador' && data.column.dataKey === 'cumplimiento')) {
                        
                        if (data.cell.text.length > 0) {
                            const cumplimiento = parseFloat(data.cell.text[0]);
                            
                            if (cumplimiento >= 100) {
                                doc.setFillColor(39, 174, 96); // Verde
                            } else if (cumplimiento >= 100) {
                                doc.setFillColor(243, 156, 18); // Amarillo
                            } else {
                                doc.setFillColor(231, 76, 60); // Rojo
                            }
                            
                            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                            doc.setTextColor(255, 255, 255); // Texto blanco
                            doc.text(data.cell.text, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, {
                                align: 'center',
                                baseline: 'middle'
                            });
                        }
                    }
                }
            });
            
            // Añadir pie de página
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${pageCount} - INFOGES Curicó - Dashboard de Control`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, {
                    align: 'center'
                });
            }
            
            // Guardar PDF
            doc.save(nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('PDF exportado correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a PDF:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos', 'error');
        }
    }, 1000);
}

// Función para alternar el modo oscuro
function toggleDarkMode() {
    darkMode = !darkMode;
    
    if (darkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
    
    // Actualizar gráficos con nuevos colores
    actualizarDashboard();
    actualizarDetalle();
}

// ==================== FUNCIONALIDADES AVANZADAS ====================

// Integración de comandos de voz
function inicializarComandosVoz() {
    if (!('webkitSpeechRecognition' in window)) {
        console.error('API de reconocimiento de voz no soportada');
        return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    // Agregar botón de micrófono al navbar
    const navbarEnd = document.querySelector('.navbar .d-flex');
    const micButton = document.createElement('button');
    micButton.className = 'btn btn-outline-light ms-3';
    micButton.id = 'micButton';
    micButton.innerHTML = '<i class="fas fa-microphone"></i>';
    navbarEnd.appendChild(micButton);
    
    // Estado del reconocimiento
    let isListening = false;
    
    // Evento de click del botón de micrófono
    micButton.addEventListener('click', function() {
        if (isListening) {
            recognition.stop();
            micButton.innerHTML = '<i class="fas fa-microphone"></i>';
            isListening = false;
        } else {
            recognition.start();
            micButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            isListening = true;
            
            mostrarNotificacion('Escuchando... diga un comando', 'success');
        }
    });
    
    // Evento de finalización del reconocimiento
    recognition.onend = function() {
        micButton.innerHTML = '<i class="fas fa-microphone"></i>';
        isListening = false;
    };
    
    // Evento de error del reconocimiento
    recognition.onerror = function(event) {
        console.error('Error en reconocimiento de voz:', event.error);
        micButton.innerHTML = '<i class="fas fa-microphone"></i>';
        isListening = false;
        
        mostrarNotificacion('Error en reconocimiento de voz', 'error');
    };
    
    // Evento de resultado del reconocimiento
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.toLowerCase();
        console.log('Comando de voz:', transcript);
        
        // Procesar comandos
        procesarComandoVoz(transcript);
    };
}

// Procesar comandos de voz
function procesarComandoVoz(comando) {
    // Comandos de navegación
    if (comando.includes('dashboard') || comando.includes('inicio')) {
        mostrarVista('dashboardView');
        mostrarNotificacion('Mostrando dashboard', 'success');
    } else if (comando.includes('detalle') || comando.includes('detalles')) {
        mostrarVista('detailView');
        mostrarNotificacion('Mostrando vista de detalle', 'success');
    } else if (comando.includes('ayuda')) {
        const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
        helpModal.show();
        mostrarNotificacion('Mostrando ayuda', 'success');
    } else if (comando.includes('actualizar') || comando.includes('refrescar')) {
        cargarDatos();
        mostrarNotificacion('Actualizando datos', 'success');
    } else if (comando.includes('modo oscuro') || comando.includes('modo noche')) {
        document.getElementById('darkModeToggle').checked = !document.getElementById('darkModeToggle').checked;
        toggleDarkMode();
        mostrarNotificacion(`Modo oscuro ${darkMode ? 'activado' : 'desactivado'}`, 'success');
    }
    
    // Comandos de exportación
    else if (comando.includes('exportar') || comando.includes('descargar')) {
        if (comando.includes('excel')) {
            if (document.getElementById('dashboardView').style.display !== 'none') {
                exportarExcel('comparativo');
            } else {
                if (document.getElementById('centro-content').classList.contains('active')) {
                    exportarExcel('centro');
                } else if (document.getElementById('indicador-content').classList.contains('active')) {
                    exportarExcel('indicador');
                } else {
                    exportarExcel('comparativo');
                }
            }
            mostrarNotificacion('Exportando a Excel', 'success');
        } else if (comando.includes('pdf')) {
            if (document.getElementById('dashboardView').style.display !== 'none') {
                exportarPDF('comparativo');
            } else {
                if (document.getElementById('centro-content').classList.contains('active')) {
                    exportarPDF('centro');
                } else if (document.getElementById('indicador-content').classList.contains('active')) {
                    exportarPDF('indicador');
                } else {
                    exportarPDF('comparativo');
                }
            }
            mostrarNotificacion('Exportando a PDF', 'success');
        }
    }
    
    // Comandos de centros
    else if (comando.includes('centro')) {
        if (comando.includes('curicó centro') || comando.includes('curico centro')) {
            mostrarVista('detailView');
            seleccionarCentro('curico');
            mostrarNotificacion('Mostrando CESFAM Curicó Centro', 'success');
        } else if (comando.includes('miguel ángel') || comando.includes('miguel angel')) {
            mostrarVista('detailView');
            seleccionarCentro('miguel');
            mostrarNotificacion('Mostrando CESFAM Miguel Ángel Arenas', 'success');
        } else if (comando.includes('betty muñoz') || comando.includes('betty munoz')) {
            mostrarVista('detailView');
            seleccionarCentro('betty');
            mostrarNotificacion('Mostrando CESFAM Betty Muñoz', 'success');
        } else if (comando.includes('colón') || comando.includes('colon')) {
            mostrarVista('detailView');
            seleccionarCentro('colon');
            mostrarNotificacion('Mostrando CESFAM Colón', 'success');
        } else if (comando.includes('sarmiento')) {
            mostrarVista('detailView');
            seleccionarCentro('sarmiento');
            mostrarNotificacion('Mostrando CESFAM Sarmiento', 'success');
        } else if (comando.includes('los niches') || comando.includes('niches')) {
            mostrarVista('detailView');
            seleccionarCentro('niches');
            mostrarNotificacion('Mostrando CESFAM Los Niches', 'success');
        } else if (comando.includes('comunal')) {
            mostrarVista('detailView');
            seleccionarCentro('comunal');
            mostrarNotificacion('Mostrando detalle comunal', 'success');
        }
    }
    
    // Comandos para indicadores específicos
    else if (comando.includes('indicador')) {
        // Extraer número de indicador
        let numeroIndicador = null;
        const match = comando.match(/indicador\s+(\d+(\.\d+)?([a-zA-Z])?)/);
        
        if (match) {
            numeroIndicador = match[1];
            
            // Buscar indicador
            const indicador = iaapsData.indicadores.find(i => i.codigo === numeroIndicador);
            
            if (indicador) {
                mostrarVista('detailView');
                document.getElementById('indicador-tab').click();
                seleccionarIndicador(numeroIndicador);
                mostrarNotificacion(`Mostrando indicador ${numeroIndicador}`, 'success');
            } else {
                mostrarNotificacion(`Indicador ${numeroIndicador} no encontrado`, 'error');
            }
        } else {
            mostrarNotificacion('Por favor, especifique un número de indicador', 'error');
        }
    }
    
    // Comando para buscar
    else if (comando.includes('buscar')) {
        const termino = comando.replace('buscar', '').trim();
        document.getElementById('searchInput').value = termino;
        buscarIndicadores(termino);
        mostrarNotificacion(`Buscando: ${termino}`, 'success');
    }
    
    // Comando no reconocido
    else {
        mostrarNotificacion('Comando no reconocido', 'error');
    }
}



// ==================== EXTENSIÓN DE FUNCIONALIDADES PRINCIPALES ====================

// Extender función mostrarVista para incluir nueva vista
const mostrarVistaOriginal = mostrarVista;
mostrarVista = function(vista) {
    const vistas = ['dashboardView', 'detailView', 'tendenciasView'];
    
    vistas.forEach(v => {
        const elemento = document.getElementById(v);
        if (elemento) {
            elemento.style.display = v === vista ? 'block' : 'none';
        }
    });
    
    // Actualizar clase active en la navegación
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    if (vista === 'dashboardView') {
        document.getElementById('dashboardLink').classList.add('active');
    } else if (vista === 'detailView') {
        document.getElementById('detailLink').classList.add('active');
    } else if (vista === 'tendenciasView') {
        const tendenciasLink = document.getElementById('tendenciasLink');
        if (tendenciasLink) {
            tendenciasLink.classList.add('active');
        }
    }
};

// Función para inicializar funcionalidades avanzadas
function inicializarFuncionalidadesAvanzadas() {
    // Inicializar comandos de voz
    inicializarComandosVoz();
    
    // Inicializar visualización de tendencias
    visualizarTendenciasHistoricas();
    
    // Añadir otras funcionalidades avanzadas según sea necesario
}

// Event listener para inicializar funcionalidades avanzadas
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que todo el dashboard esté cargado
    setTimeout(inicializarFuncionalidadesAvanzadas, 1000);
});

// Instancias globales para Chart.js (detalle de indicador)


/**
 * Actualiza los gráficos de detalle para el indicador seleccionado.
 * @param {Object} indicador  El objeto indicador de iaapsData.indicadores
 */
function actualizarGraficosDetalleIndicador(indicador) {
  // --- GRÁFICO 1: Barras de Cumplimiento por Centro (incluye 'comunal') ---
  const centrosLabels = [];
  const centrosCumplimiento = [];
  iaapsData.centros.forEach(centro => {
    const res = indicador.resultados.find(r => r.centro === centro.codigo);
    if (res && res.denominador > 0) {
      centrosLabels.push(centro.nombre);
      centrosCumplimiento.push(res.cumplimiento || 0);
    }
  });

  // Destruir la instancia previa si existe
  if (indicadorCentrosChartInstance) {
    indicadorCentrosChartInstance.destroy();
  }

  // Crear nuevo gráfico de barras
  const ctxCentros = document
    .getElementById('indicadorCentrosChart')
    .getContext('2d');
  indicadorCentrosChartInstance = new Chart(ctxCentros, {
    type: 'bar',
    data: {
      labels: centrosLabels,
      datasets: [{
        label: 'Cumplimiento (%)',
        data: centrosCumplimiento,
        backgroundColor: ctx => {
          const v = ctx.dataset.data[ctx.dataIndex];
          return v >= 100 ? '#27ae60'
               : v >= 25  ? '#f39c12'
                          : '#e74c3c';
        },
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Cumplimiento por Centro' },
        tooltip: {
          callbacks: {
            label: ctx => `Cumplimiento: ${ctx.formattedValue}%`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Cumplimiento (%)' }
        },
        x: {
          title: { display: true, text: 'Centro de Salud' }
        }
      }
    }
  });

  // --- GRÁFICO 2: Línea de Tendencia (simulada) ---
  const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
  let valor = Math.random() * 50 + 25;
  const tendenciaData = meses.map(() => {
    valor = Math.max(0, Math.min(100, valor + (Math.random() * 10 - 5)));
    return parseFloat(valor.toFixed(2));
  });
  const metaArray = Array(meses.length).fill(indicador.meta);

  // Destruir instancia previa si existe
  if (indicadorTendenciaChartInstance) {
    indicadorTendenciaChartInstance.destroy();
  }

  // Crear gráfico de línea
  const ctxTend = document
    .getElementById('indicadorTendenciaChart')
    .getContext('2d');
  indicadorTendenciaChartInstance = new Chart(ctxTend, {
    type: 'line',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Resultado',
          data: tendenciaData,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52,152,219,0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Meta',
          data: metaArray,
          borderColor: '#e74c3c',
          borderDash: [5,5],
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Tendencia Mensual' }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: indicador.tipo === 'porcentaje' ? 'Resultado (%)' : 'Resultado'
          }
        }
      }
    }
  });
}

/**
 * Evalúa el cumplimiento de una o varias metas (indicadores) para todos los centros.
 *
 * @param {string[]} codigosIndicadores  Array de códigos de indicador (p.ej. ['11','17','15','14','12','13','9.1'])
 * @returns {Object}  
 *   Claves = código de indicador;  
 *   Valor = array de { centro, cumplimiento, cumplio } para cada centro (exc. 'comunal').
 */
function evaluarCumplimientoMetas(codigosIndicadores) {
  const resultadoGlobal = {};

  codigosIndicadores.forEach(codigo => {
    const indicador = iaapsData.indicadores.find(i => i.codigo === codigo);
    if (!indicador) {
      console.warn(`Indicador "${codigo}" no encontrado.`);
      return;
    }
    const meta = indicador.meta;

    // Para cada centro (excepto comunal) calculamos cumplimiento y si cumple la meta
    const detalles = iaapsData.centros
      .filter(c => c.codigo !== 'comunal')
      .map(centro => {
        const res = indicador.resultados.find(r => r.centro === centro.codigo);
        const cumplimiento = res ? res.cumplimiento : 0;
        return {
          centro: centro.nombre,
          cumplimiento,
          cumplio: cumplimiento >= meta
        };
      });

    resultadoGlobal[codigo] = detalles;
  });

  return resultadoGlobal;
}

// Ejemplo de uso:
const metas = ['11','17','15','14','12','13','9.1'];
const reporte = evaluarCumplimientoMetas(metas);
console.log(reporte);



const datos11 = reporte['11'];
const meta11 = iaapsData.indicadores.find(i => i.codigo === '11').meta;
const ctx = document.getElementById('miCanvas').getContext('2d');

new Chart(ctx, {
  type: 'bar',
  data: {
    labels: datos11.map(r => r.centro),
    datasets: [{
      label: 'Cumplimiento %',
      data: datos11.map(r => r.cumplimiento),
      backgroundColor: ctx => {
        const v = ctx.dataset.data[ctx.dataIndex];
        return v >= meta11 ? '#27ae60' : '#e74c3c';
      }
    }]
  },
  options: { /* ... */ }
});

/**
 * CORRECCIONES DEL DASHBOARD IAAPS
 * ===============================
 * Principales correcciones:
 * 1. Eliminar duplicación de la función actualizarTablaIndicadores()
 * 2. Consolidar y mejorar funciones de actualización de detalles
 * 3. Extraer lógica común a funciones utilitarias
 */

// ==================== FUNCIONES UTILITARIAS ====================

/**
 * Determina el estado de un indicador según su cumplimiento y tipo
 * @param {number} cumplimiento Porcentaje de cumplimiento (0-100)
 * @param {number} umbral Umbral para determinar cumplimiento (normalmente 25% o valor de meta)
 * @param {string} tipo Tipo de retorno ('class', 'icon', 'text', o 'all')
 * @returns {object|string} Clase, icono, texto o todos según el tipo solicitado
 */
/**
 * Determina el estado de un indicador según su cumplimiento y meta
 * Versión modificada para metas especiales en marzo
 * Para indicadores 3, 5, 6.1.A, 6.1.B, 6.2, 7, 8, 9.2, 9.3, 11, 16:
 * - CUMPLIDO (verde): cumplimiento >= 100% de la meta
 * - EN PROCESO (amarillo): cumplimiento >= 25% de la meta pero < 100% de la meta
 * - CRÍTICO (rojo): cumplimiento < 25% de la meta
 * 
 * @param {number} cumplimiento - Porcentaje de cumplimiento actual
 * @param {number} meta - Porcentaje de la meta establecida
 * @param {string} codigoIndicador - Código del indicador para aplicar reglas específicas
 * @return {Object} Objeto con clases CSS, ícono y texto descriptivo del estado
 */
/**
 * Determina el estado de un indicador según su cumplimiento
 * Versión modificada para indicadores especiales (3, 5, 6.1.A, 6.1.B, 6.2, 7, 8, 9.2, 9.3, 11, 16)
 * 
 * Para estos indicadores:
 * - CUMPLIDO (verde): cumplimiento >= 100% (cumplimiento es igual o superior a la meta)
 * - EN PROCESO (amarillo): cumplimiento >= 25% pero < 100% (por debajo de la meta)
 * - CRÍTICO (rojo): cumplimiento < 25%
 * 
 * @param {number} cumplimiento - Porcentaje de cumplimiento (valor absoluto)
 * @param {number} meta - Valor de la meta establecida
 * @param {string} codigoIndicador - Código del indicador para aplicar reglas específicas
 * @return {Object} Objeto con clases CSS, ícono y texto descriptivo del estado
 */
function determinarEstadoIndicador(cumplimiento, meta, codigoIndicador = '') {
    // Lista de indicadores con reglas especiales
    const indicadoresEspecialesMetas = ['3', '5', '6.1.A', '6.1.B', '6.2', '7', '8', '9.2', '9.3', '11', '16'];
    
    // Verificar si el indicador está en la lista de reglas especiales
    const tieneReglasEspeciales = indicadoresEspecialesMetas.includes(codigoIndicador);
    
    // Aplicar lógica según corresponda
    if (tieneReglasEspeciales) {
        // Para los indicadores especiales:
        if (cumplimiento >= 100) {
            // Si cumplimiento es igual o superior a la meta (100%)
            return {
                statusClass: 'status-success',
                statusIcon: 'fa-check-circle',
                statusText: 'CUMPLIDO'
            };
        } else if (cumplimiento >= 25) {
            // Si cumplimiento es igual o superior a 25% pero menos que 100%
            return {
                statusClass: 'status-warning',
                statusIcon: 'fa-exclamation-triangle',
                statusText: 'EN PROCESO'
            };
        } else {
            // Si cumplimiento es inferior a 25%
            return {
                statusClass: 'status-danger',
                statusIcon: 'fa-times-circle',
                statusText: 'CRÍTICO'
            };
        }
    } else {
        // Lógica estándar para el resto de indicadores (mantener comportamiento original)
        if (cumplimiento >= meta) {
            return {
                statusClass: 'status-success',
                statusIcon: 'fa-check-circle',
                statusText: 'CUMPLIDO'
            };
        } else if (cumplimiento >= (meta * 0.8)) {
            return {
                statusClass: 'status-warning',
                statusIcon: 'fa-exclamation-triangle',
                statusText: 'EN PROCESO'
            };
        } else {
            return {
                statusClass: 'status-danger',
                statusIcon: 'fa-times-circle',
                statusText: 'CRÍTICO'
            };
        }
    }
}
/**
 * Formatea un valor según su tipo
 * @param {number} valor Valor a formatear
 * @param {string} tipo Tipo de dato ('porcentaje' u otro)
 * @param {number} decimales Número de decimales (por defecto 2)
 * @returns {string} Valor formateado
 */
function formatearValor(valor, tipo, decimales = 2) {
    if (tipo === 'porcentaje') {
        return valor.toFixed(decimales) + '%';
    }
    return valor.toFixed(decimales);
}

/**
 * Genera HTML para mostrar tendencia
 * @param {string} indicadorCodigo Código del indicador
 * @returns {string} HTML con la tendencia formateada
 */
function formatearTendencia(indicadorCodigo) {
    // Indicadores que siempre deben mostrarse "0.00%" en verde
    const siempreMeta100 = ['1', '2.1', '2.2', '10'];
    if (siempreMeta100.includes(indicadorCodigo)) {
        return `
            <span class="text-success">
                <i class="fas fa-arrow-up me-1"></i>0.00%
            </span>
        `;
    }
    
    // Para los demás, simular flecha y porcentaje
    const valor = (Math.random() * 5).toFixed(2);
    const positivo = Math.random() > 0.5;
    const cls = positivo ? 'text-success' : 'text-danger';
    const iconClass = positivo ? 'fa-arrow-up' : 'fa-arrow-down';
    
    return `
        <span class="${cls}">
            <i class="fas ${iconClass} me-1"></i>${valor}%
        </span>
    `;
}

// ==================== CORRECCIÓN DE FUNCIONES DUPLICADAS ====================

/**
 * Actualiza la tabla de indicadores en la vista principal
 * Versión consolidada y mejorada que sustituye a las versiones duplicadas
 */
function actualizarTablaIndicadores() {
    const tableBody = document.getElementById('indicadoresTableBody');
    if (!tableBody) {
        console.error("Elemento 'indicadoresTableBody' no encontrado");
        return;
    }
    
    tableBody.innerHTML = '';
    
    // Indicadores que usan su propia meta para determinar "Cumplido"
    const specialMetas = ['11','17','15','14','12','13','9.1'];
    // Indicadores cuya tendencia siempre debe mostrarse como 0% en verde
    const trendAlwaysZero = ['1','2.1','2.2','10'];

    
    
    // Ordenar indicadores por código
    const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
        const aNum = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
        const bNum = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
        return aNum - bNum;
    });
    
    indicadoresOrdenados.forEach(indicador => {
        const rc = indicador.resultados.find(r => r.centro === 'comunal');
        if (!rc) return;
        
        // Determinar umbral dinámico (cumplimiento vs meta o 25%)
        const umbral = specialMetas.includes(indicador.codigo) ? indicador.meta : 25;
        
        // Obtener estado del indicador
        const estado = determinarEstadoIndicador(rc.cumplimiento, umbral, indicador.codigo);

        
        // Formatear resultado y meta
        const resultadoFormateado = formatearValor(rc.resultado, indicador.tipo);
        const metaFormateada = formatearValor(indicador.meta, indicador.tipo);
        
        // Obtener HTML de tendencia
        const tendenciaHtml = formatearTendencia(indicador.codigo);
        
        // Construir fila
        const row = document.createElement('tr');
        row.setAttribute('data-indicador', indicador.codigo);
        row.classList.add('indicador-row');
        row.innerHTML = `
          <td><strong>${indicador.codigo}</strong> – ${indicador.nombre}</td>
          <td class="text-center">${metaFormateada}</td>
          <td class="text-center">${resultadoFormateado}</td>
          <td class="text-center">
            <span class="${estado.statusClass}">
              <i class="fas ${estado.statusIcon} me-1"></i>
              ${rc.cumplimiento.toFixed(2)}%
            </span>
          </td>
          </td>
        `;
        tableBody.appendChild(row);
    });
    
    // Vincular eventos de clic para detalles
    document.querySelectorAll('.indicador-row').forEach(row => {
        row.addEventListener('click', () => {
            const codigo = row.dataset.indicador;
            mostrarVista('detailView');
            document.getElementById('indicador-tab').click();
            seleccionarIndicador(codigo);
        });
    });
}

/**
 * Actualiza la tabla de indicadores del centro seleccionado
 * Versión mejorada con manejo de errores
 */
function actualizarTablaIndicadoresCentro() {
    const tableBody = document.getElementById('centroIndicadoresTableBody');
    if (!tableBody) {
        console.error("Elemento 'centroIndicadoresTableBody' no encontrado");
        return;
    }
    
    tableBody.innerHTML = '';
    
    // Umbral especial para ciertos indicadores
    const specialMetas = ['11','17','15','14','12','13','9.1'];
    
    // Ordenar indicadores por código
    const indicadoresOrdenados = [...iaapsData.indicadores].sort((a, b) => {
        const codigoA = parseFloat(a.codigo.replace(/[^0-9.]/g, ''));
        const codigoB = parseFloat(b.codigo.replace(/[^0-9.]/g, ''));
        return codigoA - codigoB;
    });
    
    indicadoresOrdenados.forEach(indicador => {
        const resultado = indicador.resultados.find(r => r.centro === currentCentro);
        if (!resultado) return;
        
        // Determinar umbral
        const umbral = specialMetas.includes(indicador.codigo) ? indicador.meta : 25;
        
        // Obtener estado
const estado = determinarEstadoIndicador(resultado.cumplimiento, umbral, indicador.codigo);

        
        // Formatear valores
        const resultadoFormateado = formatearValor(resultado.resultado, indicador.tipo);
        const metaFormateada = formatearValor(indicador.meta, indicador.tipo);
        
        // Construir fila
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <strong>${indicador.codigo}</strong> - ${indicador.nombre}
            </td>
            <td class="text-center">${resultado.numerador}</td>
            <td class="text-center">${resultado.denominador}</td>
            <td class="text-center">${resultadoFormateado}</td>
            <td class="text-center">${metaFormateada}</td>
            <td class="text-center">
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                        <div class="progress-bar ${estado.statusClass.replace('status-', 'bg-')}" 
                             role="progressbar" 
                             style="width: ${Math.min(resultado.cumplimiento, 100)}%" 
                             aria-valuenow="${resultado.cumplimiento}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <span>${resultado.cumplimiento.toFixed(2)}%</span>
                </div>
            </td>
            <td class="text-center">
                <span class="badge ${estado.statusClass.replace('status-', 'bg-')}">
                    <i class="fas ${estado.statusIcon} me-1"></i> ${estado.statusText}
                </span>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

/**
 * Actualiza todos los componentes del detalle de un indicador
 * Versión consolidada que unifica las funcionalidades duplicadas
 */
function actualizarDetalleIndicador() {
    console.log("Actualizando detalle del indicador:", currentIndicador);
    
    const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
    if (!indicador) {
        console.error("Indicador no encontrado:", currentIndicador);
        return;
    }
    
    try {
        // 1) Actualizar texto descriptivo
        document.getElementById('indicadorDetailTitle').textContent =
          `Indicador ${indicador.codigo}: ${indicador.nombre}`;
        document.getElementById('indicadorNombreCompleto').textContent = indicador.nombre;
        document.getElementById('indicadorMetaValor').textContent =
          formatearValor(indicador.meta, indicador.tipo);
        document.getElementById('indicadorImportanciaValor').textContent =
          importanciaIndicadores[indicador.codigo];
        document.getElementById('indicadorNumeradorFormula').textContent =
          formulasIndicadores[indicador.codigo].numerador;
        document.getElementById('indicadorDenominadorFormula').textContent =
          formulasIndicadores[indicador.codigo].denominador;
        
        // 2) Actualizar gráficos
        actualizarGraficosDetalleIndicador(indicador);
        
        // 3) Actualizar tabla
        actualizarTablaDetalleIndicador(indicador);
    } catch (error) {
        console.error("Error al actualizar detalle del indicador:", error);
    }
}

/**
 * Actualiza los gráficos de detalle para el indicador seleccionado.
 * Versión mejorada con mejor manejo de errores y visualización.
 * @param {Object} indicador El objeto indicador de iaapsData.indicadores
 */
function actualizarGraficosDetalleIndicador(indicador) {
    if (!indicador) {
        console.error("Se requiere un indicador válido");
        return;
    }
    
    try {
        // --- GRÁFICO 1: Barras de Cumplimiento por Centro ---
        actualizarGraficoCentrosPorIndicador(indicador);
        
        // --- GRÁFICO 2: Línea de Tendencia (simulada) ---
        actualizarGraficoTendenciaPorIndicador(indicador);
    } catch (error) {
        console.error("Error al actualizar gráficos:", error);
    }
}

/**
 * Actualiza el gráfico de barras mostrando el cumplimiento por centro
 * @param {Object} indicador El objeto indicador
 */
function actualizarGraficoCentrosPorIndicador(indicador) {
    const centrosLabels = [];
    const centrosCumplimiento = [];
    
    iaapsData.centros
        .filter(c => c.codigo !== 'comunal')
        .forEach(centro => {
            const res = indicador.resultados.find(r => r.centro === centro.codigo);
            if (res && res.denominador > 0) {
                centrosLabels.push(centro.nombre);
                centrosCumplimiento.push(res.cumplimiento || 0);
            }
        });
    
    // Destruir la instancia previa si existe
    if (indicadorCentrosChartInstance) {
        indicadorCentrosChartInstance.destroy();
    }
    
    // Obtener el elemento canvas
    const ctxCentros = document.getElementById('indicadorCentrosChart');
    if (!ctxCentros) {
        console.error("Elemento 'indicadorCentrosChart' no encontrado");
        return;
    }
    
    // Crear nuevo gráfico de barras
    indicadorCentrosChartInstance = new Chart(ctxCentros.getContext('2d'), {
        type: 'bar',
        data: {
            labels: centrosLabels,
            datasets: [{
                label: 'Cumplimiento (%)',
                data: centrosCumplimiento,
                backgroundColor: function(context) {
                    const value = context.dataset.data[context.dataIndex];
                    if (value >= 100) return '#27ae60';
                    else if (value >= 25) return '#f39c12';
                    else return '#e74c3c';
                },
                borderColor: 'rgba(0,0,0,0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Cumplimiento por Centro' },
                tooltip: {
                    callbacks: {
                        label: ctx => `Cumplimiento: ${ctx.formattedValue}%`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Cumplimiento (%)' }
                },
                x: {
                    title: { display: true, text: 'Centro de Salud' }
                }
            }
        }
    });
}

/**
 * Actualiza el gráfico de línea mostrando la tendencia del indicador
 * @param {Object} indicador El objeto indicador
 */
function actualizarGraficoTendenciaPorIndicador(indicador) {
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
    let valor = Math.random() * 50 + 25;
    const tendenciaData = meses.map(() => {
        valor = Math.max(0, Math.min(100, valor + (Math.random() * 10 - 5)));
        return parseFloat(valor.toFixed(2));
    });
    const metaArray = Array(meses.length).fill(indicador.meta);
    
    // Destruir instancia previa si existe
    if (indicadorTendenciaChartInstance) {
        indicadorTendenciaChartInstance.destroy();
    }
    
    // Obtener el elemento canvas
    const ctxTend = document.getElementById('indicadorTendenciaChart');
    if (!ctxTend) {
        console.error("Elemento 'indicadorTendenciaChart' no encontrado");
        return;
    }
    
    // Crear gráfico de línea
    indicadorTendenciaChartInstance = new Chart(ctxTend.getContext('2d'), {
        type: 'line',
        data: {
            labels: meses,
            datasets: [
                {
                    label: 'Resultado',
                    data: tendenciaData,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52,152,219,0.2)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Meta',
                    data: metaArray,
                    borderColor: '#e74c3c',
                    borderDash: [5,5],
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: 'Tendencia Mensual' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: indicador.tipo === 'porcentaje' ? 'Resultado (%)' : 'Resultado'
                    }
                }
            }
        }
    });
}

/**
 * Actualiza la tabla de detalle del indicador con datos por centro
 * @param {Object} indicador El objeto indicador
 */
function actualizarTablaDetalleIndicador(indicador) {
    const tbody = document.getElementById('indicadorCentrosTableBody');
    if (!tbody) {
        console.error("Elemento 'indicadorCentrosTableBody' no encontrado");
        return;
    }
    
    tbody.innerHTML = '';
    
    // Umbral especial para ciertos indicadores
    const specialMetas = ['11','17','15','14','12','13','9.1'];
    const umbral = specialMetas.includes(indicador.codigo) ? indicador.meta : 100;
    
    // Primero añadir fila comunal
    const resultadoComunal = indicador.resultados.find(r => r.centro === 'comunal');
    if (resultadoComunal) {
        agregarFilaIndicador(tbody, indicador, resultadoComunal, 'CURICÓ (COMUNAL)', umbral);
    }
    
    // Añadir filas para cada centro
    iaapsData.centros
        .filter(c => c.codigo !== 'comunal')
        .forEach(centro => {
            const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
            if (resultado) {
                agregarFilaIndicador(tbody, indicador, resultado, centro.nombre, umbral);
            }
        });
}

/**
 * Añade una fila a la tabla de detalle de indicador
 * @param {HTMLElement} tbody Elemento tbody donde añadir la fila
 * @param {Object} indicador Objeto indicador
 * @param {Object} resultado Objeto resultado con datos de cumplimiento
 * @param {string} nombreCentro Nombre del centro de salud
 * @param {number} umbral Umbral para determinar cumplimiento
 */
function agregarFilaIndicador(tbody, indicador, resultado, nombreCentro, umbral) {
    // Obtener estado
const estado = determinarEstadoIndicador(resultado.cumplimiento, umbral, indicador.codigo);

    
    // Formatear valores
    const resultadoFormateado = formatearValor(resultado.resultado, indicador.tipo);
    const metaFormateada = formatearValor(indicador.meta, indicador.tipo);
    
    // Construir fila
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${nombreCentro}</td>
        <td class="text-center">${resultado.numerador}</td>
        <td class="text-center">${resultado.denominador}</td>
        <td class="text-center">${resultadoFormateado}</td>
        <td class="text-center">${metaFormateada}</td>
        <td class="text-center">
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                    <div class="progress-bar ${estado.statusClass.replace('status-', 'bg-')}" 
                         role="progressbar" 
                         style="width: ${Math.min(resultado.cumplimiento, 100)}%" 
                         aria-valuenow="${resultado.cumplimiento}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
                <span>${resultado.cumplimiento.toFixed(2)}%</span>
            </div>
        </td>
        <td class="text-center">
            <span class="badge ${estado.statusClass.replace('status-', 'bg-')}">
                <i class="fas ${estado.statusIcon} me-1"></i> ${estado.statusText}
            </span>
        </td>
    `;
    
    tbody.appendChild(row);
}

// ==================== MEJORAS ADICIONALES ====================

/**
 * Asegura que el modo oscuro se aplique correctamente a todos los gráficos
 */
function aplicarTemaAGraficos() {
    // Configuración global para todos los gráficos
    Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.font.size = 12;
    
    // Aplicar colores según modo oscuro
    if (document.body.classList.contains('dark-mode')) {
        Chart.defaults.color = '#e0e0e0';
        Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.1)';
    } else {
        Chart.defaults.color = '#666';
        Chart.defaults.scale.grid.color = 'rgba(0, 0, 0, 0.1)';
    }
    
    // Actualizar gráficos existentes
    if (centroChartInstance) centroChartInstance.update();
    if (topIndicadoresChartInstance) topIndicadoresChartInstance.update();
    if (bottomIndicadoresChartInstance) bottomIndicadoresChartInstance.update();
    if (centroCumplimientoChartInstance) centroCumplimientoChartInstance.update();
    if (centroIndicadoresChartInstance) centroIndicadoresChartInstance.update();
    if (indicadorCentrosChartInstance) indicadorCentrosChartInstance.update();
    if (comparativoChartInstance) comparativoChartInstance.update();
}

/**
 * Versión mejorada de la función toggleDarkMode
 */
function toggleDarkMode() {
    darkMode = !darkMode;
    
    if (darkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
    
    // Aplicar tema a gráficos
    aplicarTemaAGraficos();
    
    // Actualizar dashboard y detalles
    actualizarDashboard();
    actualizarDetalle();
}

/**
 * Mejora en la función para actualizar el detalle del centro seleccionado
 */
function actualizarDetalleCentro() {
    if (!iaapsData) {
        console.error("Datos Meta Sanitaria no disponibles");
        return;
    }
    
    console.log("Actualizando detalle del centro:", currentCentro);
    
    try {
        // Actualizar título y visibilidad de tarjeta de establecimientos
        if (currentCentro === 'comunal') {
            document.getElementById('establecimientosCard').style.display = 'none';
            document.getElementById('centroCumplimientoTitle').textContent = 'Cumplimiento Meta Sanitaria Comunal';
        } else {
            const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
            if (centro) {
                document.getElementById('centroCumplimientoTitle').textContent = 
                    `Cumplimiento Meta Sanitaria - ${centro.nombre}`;
                
                // Verificar si tiene establecimientos
                const tieneEstablecimientos = establecimientosMap[currentCentro] && 
                                          establecimientosMap[currentCentro].length > 0;
                document.getElementById('establecimientosCard').style.display = 
                    tieneEstablecimientos ? 'block' : 'none';
                
                if (tieneEstablecimientos) {
                    actualizarTablaEstablecimientos();
                }
            }
        }
        
        // Actualizar gráficos y tabla de indicadores del centro
        setTimeout(() => {
            actualizarGraficosDetalleCentro();
            actualizarTablaIndicadoresCentro();
        }, 50);
    } catch (error) {
        console.error("Error al actualizar detalle del centro:", error);
    }
}

function highlightByMeta() {
  const metas = ['17','13','14','15'];
  document
    .querySelectorAll('#centroCumplimientoTableBody tr')
    .forEach(tr => {
      // tomamos el texto de la celda "Meta" (índice 1)
      const metaText = tr.cells[1].textContent.trim().replace('%','');
      if (metas.includes(metaText)) {
        // agregamos la clase a la celda de cumplimiento (índice 5)
        tr.cells[5].classList.add('highlight-cumpl');
      }
    });
}

// ——— Función para agregar nota referencial en metas específicas ———
function agregarNotaReferencial() {
  const metas = ['13', '14', '15', '17'];
  // Recorre cada fila de la tabla de detalle de indicadores del centro
  document.querySelectorAll('#centroIndicadoresTableBody tr').forEach(fila => {
    const tdIndicador = fila.querySelector('td:first-child');
    if (!tdIndicador) return;
    // Extrae el código (antes del guión o espacio)
    const codigo = tdIndicador.textContent.trim().split(/[\s.-]/)[0];
    if (metas.includes(codigo)) {
      // Si aún no existe la nota, la agrega
      if (!tdIndicador.querySelector('.nota-referencial')) {
        const span = document.createElement('span');
        span.className = 'nota-referencial';
        span.textContent = ' (solo referencial P dic 2024)';
        span.style.color = 'black';
        span.style.fontWeight = 'bold';
        tdIndicador.appendChild(span);
      }
    }
  });
}

// Llamar a la función justo después de que se haya cargado/actualizado el detalle:
document.addEventListener('DOMContentLoaded', () => {
  // Si tu tabla ya se llena tras cargar datos, también puedes hacerlo así:
  setTimeout(agregarNotaReferencial, 1000);
});

// Lista de indicadores a evaluar con estado "En Proceso"
const indicadoresProceso = ['3','5','6.1.A','6.1.B','6.2','7','8','9.2','9.3','11','16'];

/**
 * Determina el estado según reglas:
 * - Si es uno de indicadoresProceso y 25% ≤ cumplimiento < meta: En Proceso (amarillo)
 * - Si cumplimiento ≥ meta: Cumplido (verde)
 * - Si cumplimiento < meta: Crítico (rojo)
 */
function determinarEstadoMeta(codigo, cumplimiento, meta) {
  if (indicadoresProceso.includes(codigo) && cumplimiento >= 25 && cumplimiento < meta) {
    return { class: 'bg-warning', icon: 'fa-hourglass-half', text: 'En Proceso' };
  } else if (cumplimiento >= meta) {
    return { class: 'bg-success', icon: 'fa-check-circle', text: 'Cumplido' };
  } else {
    return { class: 'bg-danger', icon: 'fa-times-circle', text: 'Crítico' };
  }
}




/**
 * Calcula el cumplimiento global de todos los indicadores IAAPS
 * considerando su ponderación (importancia relativa)
 * @param {string} centroCodigo - Código del centro para el cual calcular (default: 'comunal')
 * @returns {number} - Porcentaje de cumplimiento global
 */
function calcularCumplimientoGlobal(centroCodigo = 'comunal') {
    // Verificar que existan datos
    if (!iaapsData || !iaapsData.indicadores) {
        console.error("Datos Meta Sanitaria no disponibles");
        return 0;
    }
    
    let sumaPonderada = 0;
    let sumaPonderacion = 0;
    
    // Recorrer cada indicador
    iaapsData.indicadores.forEach(indicador => {
        // Buscar resultado para el centro especificado
        const resultado = indicador.resultados.find(r => r.centro === centroCodigo);
        if (!resultado || resultado.denominador <= 0) return;
        
        // Obtener la ponderación del indicador (importancia relativa)
        let ponderacion = 0;
        
        // El indicador 10 (GES) es crítico y no se incluye en la suma ponderada
        if (indicador.codigo === '10') return;
        
        // Convertir la importancia de string a número (quitar el símbolo %)
        const importanciaStr = importanciaIndicadores[indicador.codigo];
        if (importanciaStr) {
            ponderacion = parseFloat(importanciaStr.replace('%', ''));
        }
        
        // Si no se pudo obtener la ponderación, continuar con el siguiente
        if (isNaN(ponderacion) || ponderacion <= 0) return;
        
        // Limitar el cumplimiento a un máximo de 100%
        const cumplimientoAjustado = Math.min(resultado.cumplimiento, 100);
        
        // Acumular suma ponderada y suma de ponderaciones
        sumaPonderada += (cumplimientoAjustado * ponderacion);
        sumaPonderacion += ponderacion;
    });
    
    // Calcular porcentaje global (evitar división por cero)
    const porcentajeGlobal = sumaPonderacion > 0 ? 
        (sumaPonderada / sumaPonderacion) : 0;
    
    // Redondear a 2 decimales y retornar
    return parseFloat(porcentajeGlobal.toFixed(2));
}

/**
 * Calcula el cumplimiento global ponderado de todos los indicadores IAAPS
 * para un centro específico o a nivel comunal.
 * 
 * @param {string} codigoCentro - Código del centro ('comunal' u otro código de centro)
 * @param {Array} indicadores - Array de indicadores con sus resultados
 * @returns {number} - Porcentaje de cumplimiento global ponderado (0-100)
 */
function calcularCumplimientoGlobal(codigoCentro, indicadores) {
    // 1) Validación de parámetros
    if (!codigoCentro || !indicadores || !Array.isArray(indicadores)) {
        console.error("Parámetros incorrectos para calcular cumplimiento global");
        return 0;
    }

    // 2) Variables para acumular valores
    let sumaPonderada = 0;          // Suma de (cumplimiento × ponderación)
    let sumaPonderaciones = 0;      // Suma total de ponderaciones
    let indicadoresContados = 0;    // Contador de indicadores válidos

    // 3) Recorrer cada indicador
    indicadores.forEach(indicador => {
        // Buscar resultado del centro específico
        const resultado = indicador.resultados.find(r => r.centro === codigoCentro);
        
        // Continuar solo si hay resultados y tiene denominador
        if (resultado && resultado.denominador > 0) {
            // Obtener la importancia del indicador (como número, quitando el %)
            let importancia = 0;
            
            // El indicador 10 es crítico y se evalúa por separado
            if (indicador.codigo === '10') {
                return; // Saltamos este indicador
            }
            
            // Extraer el valor numérico de la importancia (quitar el % y convertir a número)
            const importanciaStr = importanciaIndicadores[indicador.codigo] || '0%';
            importancia = parseFloat(importanciaStr.replace('%', '')) || 0;
            
            // Verificar que la importancia sea válida
            if (importancia > 0) {
                // Calcular la contribución ponderada de este indicador
                // (limitando el cumplimiento a máximo 100%)
                const cumplimientoEfectivo = Math.min(resultado.cumplimiento, 100);
                sumaPonderada += cumplimientoEfectivo * importancia;
                sumaPonderaciones += importancia;
                indicadoresContados++;
            }
        }
    });

    // 4) Calcular el cumplimiento global ponderado
    if (sumaPonderaciones === 0 || indicadoresContados === 0) {
        console.warn("No se encontraron indicadores válidos para calcular el cumplimiento global");
        return 0;
    }

    // 5) Retornar el cumplimiento ponderado, redondeado a dos decimales
    return parseFloat((sumaPonderada / sumaPonderaciones).toFixed(2));
}

function diagnosticarDashboard() {
    console.log("=== DIAGNÓSTICO DEL DASHBOARD ===");
    
    // Verificar datos IAAPS
    console.log("iaapsData existe:", iaapsData ? "SÍ" : "NO");
    if (!iaapsData) return "ERROR: iaapsData es null o undefined";
    
    console.log("iaapsData.indicadores existe:", iaapsData.indicadores ? "SÍ" : "NO");
    if (!iaapsData.indicadores) return "ERROR: iaapsData.indicadores es null o undefined";
    
    console.log("iaapsData.centros existe:", iaapsData.centros ? "SÍ" : "NO");
    if (!iaapsData.centros) return "ERROR: iaapsData.centros es null o undefined";
    
    // Verificar elementos DOM críticos
    const elementosDOM = [
        'indicadorCumplidosValue', 
        'indicadorParcialValue',
        'indicadorCriticosValue',
        'cumplimientoComunalValue',
        'indicadorCumplidosProgress',
        'indicadorParcialProgress',
        'indicadorCriticosProgress',
        'cumplimientoComunalProgress'
    ];
    
    let elementosFaltantes = [];
    elementosDOM.forEach(id => {
        if (!document.getElementById(id)) {
            elementosFaltantes.push(id);
        }
    });
    
    if (elementosFaltantes.length > 0) {
        return "ERROR: Faltan elementos DOM: " + elementosFaltantes.join(", ");
    }
    
    return "OK: Diagnóstico completado sin problemas evidentes";
}

/**
 * FUNCIONES BÁSICAS DE EXPORTACIÓN PARA DASHBOARD IAAPS
 * Solución simplificada para corregir errores en exportación PDF y Excel
 */

// ==================== FUNCIÓN PARA EXPORTAR A EXCEL ====================

/**
 * Exporta datos a Excel según el tipo seleccionado
 * @param {string} tipo - 'centro', 'indicador' o 'comparativo'
 */
function exportarExcel(tipo) {
  // Mostrar indicador de carga
  mostrarCargando(true);
  
  setTimeout(() => {
    try {
      // Verificar si XLSX está disponible
      if (typeof XLSX === 'undefined') {
        console.error("Error: La librería SheetJS (XLSX) no está disponible");
        mostrarNotificacion('Error: Librería Excel no disponible', 'error');
        mostrarCargando(false);
        return;
      }
      
      let data = [];
      let nombreArchivo = '';
      
      if (tipo === 'centro') {
        // Exportar datos del centro seleccionado
        const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
        if (!centro) {
          mostrarNotificacion('Error: Centro no encontrado', 'error');
          mostrarCargando(false);
          return;
        }
        
        nombreArchivo = `Meta_Sanitaria_${centro.nombre.replace(/\s/g, '_')}_Marzo_2025.xlsx`;
        
        // Encabezados
        data.push(['Indicador', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']);
        
        // Datos
        iaapsData.indicadores.forEach(indicador => {
          const resultado = indicador.resultados.find(r => r.centro === currentCentro);
          if (!resultado) return;
          
          let estado = '';
          if (resultado.cumplimiento >= 100) estado = 'Cumplido';
          else if (resultado.cumplimiento >= 25) estado = 'Parcial';
          else estado = 'Crítico';
          
          data.push([
            `${indicador.codigo} - ${indicador.nombre}`,
            resultado.numerador,
            resultado.denominador,
            indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
            indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
            resultado.cumplimiento.toFixed(2) + '%',
            estado
          ]);
        });
      } else if (tipo === 'indicador') {
        // Exportar datos del indicador seleccionado
        const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
        if (!indicador) {
          mostrarNotificacion('Error: Indicador no encontrado', 'error');
          mostrarCargando(false);
          return;
        }
        
        nombreArchivo = `Meta_Sanitaria_Indicador_${indicador.codigo.replace('.', '_')}_Marzo_2025.xlsx`;
        
        // Encabezados
        data.push(['Centro', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento', 'Estado']);
        
        // Datos
        iaapsData.centros.forEach(centro => {
          const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
          if (!resultado) return;
          
          let estado = '';
          if (resultado.cumplimiento >= 100) estado = 'Cumplido';
          else if (resultado.cumplimiento >= 25) estado = 'Parcial';
          else estado = 'Crítico';
          
          data.push([
            centro.nombre,
            resultado.numerador,
            resultado.denominador,
            indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
            indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
            resultado.cumplimiento.toFixed(2) + '%',
            estado
          ]);
        });
      } else if (tipo === 'comparativo') {
        // Exportar tabla comparativa
        nombreArchivo = `Meta_Sanitaria_Comparativo_Marzo_2025.xlsx`;
        
        // Encabezados
        const headers = ['Indicador', 'Meta'];
        iaapsData.centros.forEach(centro => {
          headers.push(centro.nombre);
        });
        data.push(headers);
        
        // Datos
        iaapsData.indicadores.forEach(indicador => {
          const row = [
            `${indicador.codigo} - ${indicador.nombre}`,
            indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
          ];
          
          iaapsData.centros.forEach(centro => {
            const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
            if (resultado) {
              row.push(resultado.cumplimiento.toFixed(2) + '%');
            } else {
              row.push('-');
            }
          });
          
          data.push(row);
        });
      }
      
      // Crear libro de Excel usando método simple de XLSX
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Meta Sanitaria");
      
      // Exportar archivo
      XLSX.writeFile(wb, nombreArchivo);
      
      mostrarCargando(false);
      mostrarNotificacion('Excel exportado correctamente', 'success');
    } catch (error) {
      console.error('Error al exportar a Excel:', error);
      mostrarCargando(false);
      mostrarNotificacion('Error al exportar Excel: ' + error.message, 'error');
    }
  }, 500);
}

// ==================== FUNCIÓN PARA EXPORTAR A PDF ====================

/**
 * Exporta datos a PDF según el tipo seleccionado
 * Solución para el error "doc.autoTable is not a function"
 * @param {string} tipo - 'centro', 'indicador' o 'comparativo'
 */
function exportarPDF(tipo) {
  // Mostrar indicador de carga
  mostrarCargando(true);
  
  setTimeout(() => {
    try {
      // Verificar si jsPDF está disponible correctamente
      if (typeof window.jspdf === 'undefined') {
        console.error("Error: La librería jsPDF no está disponible");
        mostrarNotificacion('Error: Librería PDF no disponible', 'error');
        mostrarCargando(false);
        return;
      }
      
      // Crear instancia jsPDF (sintaxis corregida)
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Verificar si el plugin autoTable está disponible
      if (typeof window.jspdf.jsPDF.prototype.autoTable !== 'function') {
        console.error("Error: Plugin autoTable no disponible");
        // Usar método básico sin autoTable
        exportarPDFBasico(doc, tipo);
        return;
      }
      
      let nombreArchivo = '';
      let titulo = '';
      let datos = [];
      let columnas = [];
      
      if (tipo === 'centro') {
        // Exportar datos del centro seleccionado
        const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
        if (!centro) {
          mostrarCargando(false);
          mostrarNotificacion('Error: Centro no encontrado', 'error');
          return;
        }
        
        nombreArchivo = `Meta_Sanitaria_${centro.nombre.replace(/\s/g, '_')}_Marzo_2025.pdf`;
        titulo = `Reporte Meta Sanitaria - ${centro.nombre} - Marzo 2025`;
        
        // Definir columnas para autoTable
        columnas = [
          { header: 'Indicador', dataKey: 'indicador' },
          { header: 'Numerador', dataKey: 'numerador' },
          { header: 'Denominador', dataKey: 'denominador' },
          { header: 'Resultado', dataKey: 'resultado' },
          { header: 'Meta', dataKey: 'meta' },
          { header: 'Cumplimiento', dataKey: 'cumplimiento' }
        ];
        
        // Datos
        iaapsData.indicadores.forEach(indicador => {
          const resultado = indicador.resultados.find(r => r.centro === currentCentro);
          if (!resultado) return;
          
          datos.push({
            indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 40)}...`,
            numerador: resultado.numerador,
            denominador: resultado.denominador,
            resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
            meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
            cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
          });
        });
      } else if (tipo === 'indicador') {
        // Exportar datos del indicador seleccionado
        const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
        if (!indicador) {
          mostrarCargando(false);
          mostrarNotificacion('Error: Indicador no encontrado', 'error');
          return;
        }
        
        nombreArchivo = `Meta_Sanitaria_Indicador_${indicador.codigo.replace('.', '_')}_Marzo_2025.pdf`;
        titulo = `Reporte Meta Sanitaria - Indicador ${indicador.codigo} - Marzo 2025`;
        
        // Definir columnas para autoTable
        columnas = [
          { header: 'Centro', dataKey: 'centro' },
          { header: 'Numerador', dataKey: 'numerador' },
          { header: 'Denominador', dataKey: 'denominador' },
          { header: 'Resultado', dataKey: 'resultado' },
          { header: 'Meta', dataKey: 'meta' },
          { header: 'Cumplimiento', dataKey: 'cumplimiento' }
        ];
        
        // Datos
        iaapsData.centros.forEach(centro => {
          const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
          if (!resultado) return;
          
          datos.push({
            centro: centro.nombre,
            numerador: resultado.numerador,
            denominador: resultado.denominador,
            resultado: indicador.tipo === 'porcentaje' ? resultado.resultado.toFixed(2) + '%' : resultado.resultado.toFixed(2),
            meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2),
            cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
          });
        });
      } else if (tipo === 'comparativo') {
        // Exportar tabla comparativa
        nombreArchivo = `Meta_Sanitaria_Comparativo_Marzo_2025.pdf`;
        titulo = `Reporte Meta Sanitaria - Comparativo - Marzo 2025`;
        
        // Definir columnas para autoTable
        columnas = [
          { header: 'Indicador', dataKey: 'indicador' },
          { header: 'Meta', dataKey: 'meta' }
        ];
        
        // Agregar columnas para cada centro (limitado a algunos para que quepa en PDF)
        const centrosLimitados = iaapsData.centros.slice(0, 4); // Solo 4 centros para que quepa en el PDF
        centrosLimitados.forEach(centro => {
          columnas.push({ header: centro.nombre.substring(0, 8), dataKey: centro.codigo });
        });
        
        // Datos
        iaapsData.indicadores.forEach(indicador => {
          const fila = {
            indicador: `${indicador.codigo} - ${indicador.nombre.substring(0, 20)}...`,
            meta: indicador.tipo === 'porcentaje' ? indicador.meta.toFixed(2) + '%' : indicador.meta.toFixed(2)
          };
          
          // Agregar datos para cada centro
          centrosLimitados.forEach(centro => {
            const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
            if (resultado) {
              fila[centro.codigo] = resultado.cumplimiento.toFixed(2) + '%';
            } else {
              fila[centro.codigo] = '-';
            }
          });
          
          datos.push(fila);
        });
      }
      
      // Añadir título
      doc.setFontSize(18);
      doc.text(titulo, 14, 22);
      
      // Añadir fecha
      doc.setFontSize(11);
      doc.text(`Fecha de generación: ${new Date().toLocaleDateString()}`, 14, 30);
      
      // Comprobar nuevamente el método autoTable antes de usarlo
      if (typeof doc.autoTable === 'function') {
        // Utilizar autoTable si está disponible
        doc.autoTable({
          columns: columnas,
          body: datos,
          startY: 35,
          styles: { fontSize: 9 },
          columnStyles: {
            indicador: { cellWidth: 60 }
          }
        });
      } else {
        // Método alternativo si autoTable no está disponible
        exportarPDFBasico(doc, tipo);
        return;
      }
      
      // Añadir pie de página
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`Página ${i} de ${pageCount} - INFOGES Curicó - Dashboard de Control`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, {
          align: 'center'
        });
      }
      
      // Guardar PDF
      doc.save(nombreArchivo);
      
      mostrarCargando(false);
      mostrarNotificacion('PDF exportado correctamente', 'success');
    } catch (error) {
      console.error('Error al exportar a PDF:', error);
      mostrarCargando(false);
      mostrarNotificacion('Error al exportar PDF: ' + error.message, 'error');
    }
  }, 500);
}

/**
 * Método alternativo básico para exportar a PDF si autoTable no está disponible
 * @param {jsPDF} doc - Instancia de jsPDF
 * @param {string} tipo - Tipo de exportación
 */
/**
 * Función para exportar informes IAAPS a PDF con diseño profesional
 * @param {string} tipo - Tipo de informe: 'centro', 'indicador' o 'comparativo'
 */
function exportarPDF(tipo) {
    mostrarCargando(true);
    
    setTimeout(() => {
        try {
            // Inicialización del documento PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait', // Cambiado a vertical
                unit: 'mm',
                format: 'a4'
            });
            
            // Variables para el informe
            let nombreArchivo = '';
            let titulo = '';
            let subtitulo = 'Reporte del Sistema IAAPS - Marzo 2025';
            let datos = [];
            
            // Dimensiones de la página
            const anchoPagina = doc.internal.pageSize.getWidth();
            const altoPagina = doc.internal.pageSize.getHeight();
            const margen = 15;
            
            // Definir paleta de colores institucional (mejorada)
            const colores = {
                primario: [45, 116, 186],      // Azul institucional más vibrante
                secundario: [46, 204, 113],    // Verde más saturado (indicador bueno)
                alerta: [241, 196, 15],        // Amarillo más brillante (indicador en progreso)
                peligro: [231, 76, 60],        // Rojo (indicador crítico)
                textoOscuro: [44, 62, 80],     // Texto principal
                textoClaro: [255, 255, 255],   // Texto sobre fondos oscuros
                fondoClaro: [248, 249, 250]    // Fondo de secciones
            };
            
            // ======== PREPARACIÓN DE DATOS SEGÚN EL TIPO DE INFORME ========
            if (tipo === 'centro') {
                // Datos para informe de centro
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                if (!centro) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error: Centro no encontrado', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_${centro.nombre.replace(/\s/g, '_')}_Marzo_2025.pdf`;
                titulo = `Centro de Salud: ${centro.nombre}`;
                
                // Datos de la tabla
                iaapsData.indicadores.forEach(indicador => {
                    const resultado = indicador.resultados.find(r => r.centro === currentCentro);
                    if (!resultado) return;
                    
                    datos.push({
                        indicador: `${indicador.codigo} - ${recortarTexto(indicador.nombre, 40)}`,
                        numerador: formatearNumero(resultado.numerador),
                        denominador: formatearNumero(resultado.denominador),
                        resultado: formatearValor(resultado.resultado, indicador.tipo),
                        meta: formatearValor(indicador.meta, indicador.tipo),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
                
            } else if (tipo === 'indicador') {
                // Datos para informe de indicador
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                if (!indicador) {
                    mostrarCargando(false);
                    mostrarNotificacion('Error: Indicador no encontrado', 'error');
                    return;
                }
                
                nombreArchivo = `IAAPS_Indicador_${indicador.codigo.replace('.', '_')}_Marzo_2025.pdf`;
                titulo = `Indicador: ${indicador.codigo}`;
                subtitulo = `${indicador.nombre} - Marzo 2025`;
                
                // Datos de la tabla
                iaapsData.centros.forEach(centro => {
                    const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                    if (!resultado) return;
                    
                    datos.push({
                        centro: centro.nombre,
                        numerador: formatearNumero(resultado.numerador),
                        denominador: formatearNumero(resultado.denominador),
                        resultado: formatearValor(resultado.resultado, indicador.tipo),
                        meta: formatearValor(indicador.meta, indicador.tipo),
                        cumplimiento: resultado.cumplimiento.toFixed(2) + '%'
                    });
                });
                
            } else if (tipo === 'comparativo') {
                // Datos para informe comparativo
                nombreArchivo = `IAAPS_Comparativo_Marzo_2025.pdf`;
                titulo = `Informe Comparativo IAAPS`;
                subtitulo = `Todos los Centros - Marzo 2025`;
                
                // Datos para tabla comparativa - formato especial
                const datosTabulares = [];
                
                // Preparar encabezados de centros
                const centrosHeader = ['Indicador', 'Meta', 'Comunal'];
                iaapsData.centros.filter(c => c.codigo !== 'comunal').forEach(centro => {
                    centrosHeader.push(centro.nombre);
                });
                
                datosTabulares.push(centrosHeader);
                
                // Añadir datos para cada indicador
                iaapsData.indicadores.forEach(indicador => {
                    const fila = [
                        `${indicador.codigo} - ${recortarTexto(indicador.nombre, 30)}`,
                        formatearValor(indicador.meta, indicador.tipo)
                    ];
                    
                    // Añadir datos para cada centro
                    iaapsData.centros.forEach(centro => {
                        const resultado = indicador.resultados.find(r => r.centro === centro.codigo);
                        if (resultado) {
                            fila.push(resultado.cumplimiento.toFixed(2) + '%');
                        } else {
                            fila.push('-');
                        }
                    });
                    
                    datosTabulares.push(fila);
                });
                
                datos = datosTabulares;
            }
            
            // ============ FUNCIÓN PARA CREAR ENCABEZADO ============
            function agregarEncabezado(pagina) {
                // Fondo del encabezado
                doc.setFillColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                doc.rect(0, 0, anchoPagina, 22, 'F');
                
                // Línea decorativa
                doc.setFillColor(colores.secundario[0], colores.secundario[1], colores.secundario[2]);
                doc.rect(0, 22, anchoPagina, 2, 'F');
                
                // Logo
                try {
                    // Ruta relativa para web (ajustar según la estructura del proyecto)
                    const rutaLogo = './images/logo2.png';
                    doc.addImage(rutaLogo, 'PNG', margen, 4, 15, 15);
                } catch (e) {
                    console.warn('No se pudo cargar el logo:', e);
                    // Alternativa al logo
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.text('LOGO', margen + 5, 12);
                }
                
                // Título del documento
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('SERVICIO DE SALUD CURICÓ', margen + 25, 10);
                
                // Subtítulo
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Informe de Indicadores de Atención Primaria de Salud (IAAPS)', margen + 25, 17);
                
                // Número de página
                doc.text(`Página ${pagina}`, anchoPagina - margen - 15, 10);
                
                // Retornar posición Y donde termina el encabezado
                return 30;
            }
            
            // ============ FUNCIÓN PARA CREAR PIE DE PÁGINA ============
            function agregarPiePagina() {
                const alturaPie = 12;
                const posY = altoPagina - alturaPie;
                
                // Fondo del pie de página
                doc.setFillColor(colores.fondoClaro[0], colores.fondoClaro[1], colores.fondoClaro[2]);
                doc.rect(0, posY, anchoPagina, alturaPie, 'F');
                
                // Línea superior
                doc.setDrawColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                doc.setLineWidth(0.5);
                doc.line(0, posY, anchoPagina, posY);
                
                // Texto del pie
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                
                // Información a mostrar en el pie de página
                const fechaGen = new Date().toLocaleDateString('es-CL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                doc.text(`INFOGES Curicó - Dashboard de Control IAAPS - Generado el ${fechaGen}`, margen, posY + 5);
                doc.text('Servicio de Salud Curicó - Dirección: Carmen N°560, Curicó', margen, posY + 9);
                
                // Copyright y nota legal a la derecha
                doc.text('Documento confidencial - Uso interno', anchoPagina - margen - 50, posY + 7);
                
                return posY;
            }
            
            // ============ FUNCIÓN PARA CREAR TABLA MANUAL ============
            function crearTablaManual(datos, startY, columnas) {
                // Función para dibujar celdas con color de fondo
                function dibujarCelda(texto, x, y, ancho, colorFondo) {
                    if (colorFondo) {
                        doc.setFillColor(colorFondo[0], colorFondo[1], colorFondo[2], colorFondo[3] || 1);
                        doc.rect(x, y - 5, ancho, 7, 'F');
                    }
                    doc.text(texto, x + 2, y);
                }
                
                // Configuración de la tabla
                const margenTabla = margen;
                const anchoDisponible = anchoPagina - (2 * margenTabla);
                let posY = startY;
                
                // Definir anchos de columna según el tipo de informe
                let anchoColumnas = [];
                
                if (tipo === 'centro') {
                    // Para informe de centro
                    anchoColumnas = [
                        anchoDisponible * 0.40, // Indicador
                        anchoDisponible * 0.12, // Numerador
                        anchoDisponible * 0.12, // Denominador
                        anchoDisponible * 0.12, // Resultado
                        anchoDisponible * 0.12, // Meta
                        anchoDisponible * 0.12  // Cumplimiento
                    ];
                    
                    // Encabezados
                    const encabezados = ['Indicador', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento'];
                    let posX = margenTabla;
                    
                    // Fondo para encabezados
                    doc.setFillColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                    doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                    
                    // Texto de encabezados
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    
                    encabezados.forEach((encabezado, index) => {
                        doc.text(encabezado, posX + 2, posY);
                        posX += anchoColumnas[index];
                    });
                    
                    // Datos
                    posY += 10;
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    
                    // Limitar a 20 filas por página
                    const filasPorPagina = 15; // Reducido por orientación vertical
                    const paginasTotales = Math.ceil(datos.length / filasPorPagina);
                    
                    for (let pagina = 0; pagina < paginasTotales; pagina++) {
                        if (pagina > 0) {
                            // Nueva página
                            doc.addPage();
                            posY = agregarEncabezado(pagina + 2) + 10;
                            agregarPiePagina();
                            
                            // Repetir encabezados
                            posX = margenTabla;
                            doc.setFillColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                            doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            
                            encabezados.forEach((encabezado, index) => {
                                doc.text(encabezado, posX + 2, posY);
                                posX += anchoColumnas[index];
                            });
                            
                            posY += 10;
                            doc.setTextColor(0, 0, 0);
                            doc.setFont(undefined, 'normal');
                        }
                        
                        // Filas para esta página
                        const inicio = pagina * filasPorPagina;
                        const fin = Math.min((pagina + 1) * filasPorPagina, datos.length);
                        
                        for (let i = inicio; i < fin; i++) {
                            const dato = datos[i];
                            posX = margenTabla;
                            
                            // Fila con fondo alternado
                            if (i % 2 === 1) {
                                doc.setFillColor(245, 245, 250);
                                doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                            }
                            
                            // Indicador
                            doc.text(dato.indicador, posX + 2, posY);
                            posX += anchoColumnas[0];
                            
                            // Numerador
                            doc.text(dato.numerador, posX + 2, posY);
                            posX += anchoColumnas[1];
                            
                            // Denominador
                            doc.text(dato.denominador, posX + 2, posY);
                            posX += anchoColumnas[2];
                            
                            // Resultado
                            doc.text(dato.resultado, posX + 2, posY);
                            posX += anchoColumnas[3];
                            
                            // Meta
                            doc.text(dato.meta, posX + 2, posY);
                            posX += anchoColumnas[4];
                            
                            // Cumplimiento (con color según valor)
                            const cumplimiento = parseFloat(dato.cumplimiento);
                            let colorCumplimiento;
                            
                            // Colores más diferenciados y vibrantes para el estado
                            if (cumplimiento >= 100) {
                                colorCumplimiento = [colores.secundario[0], colores.secundario[1], colores.secundario[2], 0.3];
                            } else if (cumplimiento >= 90) {
                                colorCumplimiento = [colores.alerta[0], colores.alerta[1], colores.alerta[2], 0.3];
                            } else {
                                colorCumplimiento = [colores.peligro[0], colores.peligro[1], colores.peligro[2], 0.3];
                            }
                            
                            dibujarCelda(dato.cumplimiento, posX, posY, anchoColumnas[5], colorCumplimiento);
                            
                            posY += 8;
                        }
                    }
                } else if (tipo === 'indicador') {
                    // Para informe de indicador - similar a 'centro' pero con diferentes encabezados
                    anchoColumnas = [
                        anchoDisponible * 0.30, // Centro
                        anchoDisponible * 0.14, // Numerador
                        anchoDisponible * 0.14, // Denominador
                        anchoDisponible * 0.14, // Resultado
                        anchoDisponible * 0.14, // Meta
                        anchoDisponible * 0.14  // Cumplimiento
                    ];
                    
                    // Encabezados
                    const encabezados = ['Centro', 'Numerador', 'Denominador', 'Resultado', 'Meta', 'Cumplimiento'];
                    let posX = margenTabla;
                    
                    // Fondo para encabezados
                    doc.setFillColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                    doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                    
                    // Texto de encabezados
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    
                    encabezados.forEach((encabezado, index) => {
                        doc.text(encabezado, posX + 2, posY);
                        posX += anchoColumnas[index];
                    });
                    
                    // Datos
                    posY += 10;
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    
                    datos.forEach((dato, i) => {
                        posX = margenTabla;
                        
                        // Fila con fondo alternado
                        if (i % 2 === 1) {
                            doc.setFillColor(245, 245, 250);
                            doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                        }
                        
                        // Centro
                        doc.text(dato.centro, posX + 2, posY);
                        posX += anchoColumnas[0];
                        
                        // Numerador
                        doc.text(dato.numerador, posX + 2, posY);
                        posX += anchoColumnas[1];
                        
                        // Denominador
                        doc.text(dato.denominador, posX + 2, posY);
                        posX += anchoColumnas[2];
                        
                        // Resultado
                        doc.text(dato.resultado, posX + 2, posY);
                        posX += anchoColumnas[3];
                        
                        // Meta
                        doc.text(dato.meta, posX + 2, posY);
                        posX += anchoColumnas[4];
                        
                        // Cumplimiento (con color según valor)
                        const cumplimiento = parseFloat(dato.cumplimiento);
                        let colorCumplimiento;
                        
                        if (cumplimiento >= 100) {
                            colorCumplimiento = [colores.secundario[0], colores.secundario[1], colores.secundario[2], 0.3];
                        } else if (cumplimiento >= 90) {
                            colorCumplimiento = [colores.alerta[0], colores.alerta[1], colores.alerta[2], 0.3];
                        } else {
                            colorCumplimiento = [colores.peligro[0], colores.peligro[1], colores.peligro[2], 0.3];
                        }
                        
                        dibujarCelda(dato.cumplimiento, posX, posY, anchoColumnas[5], colorCumplimiento);
                        
                        posY += 8;
                        
                        // Si hay demasiadas filas, pasar a nueva página
                        if (posY > altoPagina - 30 && i < datos.length - 1) {
                            doc.addPage();
                            posY = agregarEncabezado(doc.internal.getNumberOfPages()) + 10;
                            agregarPiePagina();
                            
                            // Repetir encabezados
                            posX = margenTabla;
                            doc.setFillColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                            doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            
                            encabezados.forEach((encabezado, index) => {
                                doc.text(encabezado, posX + 2, posY);
                                posX += anchoColumnas[index];
                            });
                            
                            posY += 10;
                            doc.setTextColor(0, 0, 0);
                            doc.setFont(undefined, 'normal');
                        }
                    });
                } else if (tipo === 'comparativo') {
                    // Para informe comparativo - estructura específica con datos tabulares
                    const encabezados = datos[0];
                    const filasDatos = datos.slice(1);
                    
                    // Calcular anchos de columna
                    const numColumnas = encabezados.length;
                    const anchoPorColumna = anchoDisponible / numColumnas;
                    
                    // Ajustar para indicador y meta
                    anchoColumnas = Array(numColumnas).fill(anchoPorColumna);
                    anchoColumnas[0] = anchoDisponible * 0.35; // Indicador - mayor espacio en vertical
                    anchoColumnas[1] = anchoDisponible * 0.15; // Meta
                    
                    // Redistribuir el espacio restante para los centros
                    const espacioRestante = anchoDisponible - anchoColumnas[0] - anchoColumnas[1];
                    const anchoCentros = espacioRestante / (numColumnas - 2);
                    
                    for (let i = 2; i < numColumnas; i++) {
                        anchoColumnas[i] = anchoCentros;
                    }
                    
                    // Encabezados
                    let posX = margenTabla;
                    
                    // Fondo para encabezados
                    doc.setFillColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                    doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                    
                    // Texto de encabezados
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    
                    encabezados.forEach((encabezado, index) => {
                        doc.text(encabezado, posX + 2, posY);
                        posX += anchoColumnas[index];
                    });
                    
                    // Datos
                    posY += 10;
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    
                    // Limitar filas por página
                    const filasPorPagina = 15; // Reducido por orientación vertical
                    const paginasTotales = Math.ceil(filasDatos.length / filasPorPagina);
                    
                    for (let pagina = 0; pagina < paginasTotales; pagina++) {
                        if (pagina > 0) {
                            // Nueva página
                            doc.addPage();
                            posY = agregarEncabezado(pagina + 2) + 10;
                            agregarPiePagina();
                            
                            // Repetir encabezados
                            posX = margenTabla;
                            doc.setFillColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                            doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            
                            encabezados.forEach((encabezado, index) => {
                                doc.text(encabezado, posX + 2, posY);
                                posX += anchoColumnas[index];
                            });
                            
                            posY += 10;
                            doc.setTextColor(0, 0, 0);
                            doc.setFont(undefined, 'normal');
                        }
                        
                        // Filas para esta página
                        const inicio = pagina * filasPorPagina;
                        const fin = Math.min((pagina + 1) * filasPorPagina, filasDatos.length);
                        
                        for (let i = inicio; i < fin; i++) {
                            const fila = filasDatos[i];
                            posX = margenTabla;
                            
                            // Fila con fondo alternado
                            if (i % 2 === 1) {
                                doc.setFillColor(245, 245, 250);
                                doc.rect(margenTabla, posY - 5, anchoDisponible, 7, 'F');
                            }
                            
                            // Recorrer cada columna de la fila
                            fila.forEach((celda, j) => {
                                // Para las columnas de cumplimiento (excepto indicador y meta)
                                if (j >= 2 && celda !== '-' && celda.includes('%')) {
                                    const cumplimiento = parseFloat(celda);
                                    let colorCumplimiento;
                                    
                                    if (cumplimiento >= 100) {
                                        colorCumplimiento = [colores.secundario[0], colores.secundario[1], colores.secundario[2], 0.3];
                                    } else if (cumplimiento >= 90) {
                                        colorCumplimiento = [colores.alerta[0], colores.alerta[1], colores.alerta[2], 0.3];
                                    } else {
                                        colorCumplimiento = [colores.peligro[0], colores.peligro[1], colores.peligro[2], 0.3];
                                    }
                                    
                                    dibujarCelda(celda, posX, posY, anchoColumnas[j], colorCumplimiento);
                                } else {
                                    // Texto normal para otras columnas
                                    doc.text(celda, posX + 2, posY);
                                }
                                
                                posX += anchoColumnas[j];
                            });
                            
                            posY += 8;
                        }
                    }
                }
                
                return posY + 10; // Retornar la posición Y final
            }
            
            // ============ INICIAR CONSTRUCCIÓN DEL PDF ============
            // Primera página - Portada
            let posY = agregarEncabezado(1);
            agregarPiePagina();
            
            // Título del informe
            posY += 15;
            doc.setTextColor(colores.primario[0], colores.primario[1], colores.primario[2]);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text(titulo, anchoPagina / 2, posY, { align: 'center' });
            
            // Subtítulo
            posY += 10;
            doc.setTextColor(80, 80, 80);
            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text(subtitulo, anchoPagina / 2, posY, { align: 'center' });
            
            // Fecha de generación
            posY += 8;
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-CL', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            })}`, anchoPagina / 2, posY, { align: 'center' });
            
            // Línea separadora
            posY += 10;
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(margen, posY, anchoPagina - margen, posY);
            
            // Descripción del informe
            posY += 10;
            doc.setFontSize(12);
            
            let descripcion = '';
            if (tipo === 'centro') {
                const centro = iaapsData.centros.find(c => c.codigo === currentCentro);
                descripcion = `Este informe presenta el cumplimiento de los indicadores IAAPS para el centro "${centro.nombre}" durante el mes de Marzo de 2025. El informe incluye el detalle de cada indicador con sus respectivos resultados, metas y nivel de cumplimiento.`;
            } else if (tipo === 'indicador') {
                const indicador = iaapsData.indicadores.find(i => i.codigo === currentIndicador);
                descripcion = `Este informe presenta el comportamiento del indicador "${indicador.nombre}" (${indicador.codigo}) en todos los centros de salud durante el mes de Marzo de 2025. Se incluye el detalle para cada centro y su nivel de cumplimiento respecto a la meta establecida.`;
            } else {
                descripcion = `Este informe comparativo muestra el cumplimiento de todos los indicadores IAAPS para todos los centros de salud durante el mes de Marzo de 2025. La tabla permite visualizar y comparar el desempeño de cada centro respecto a cada indicador.`;
            }
            
            // Texto informativo
            const lineasDescripcion = doc.splitTextToSize(descripcion, anchoPagina - 2 * margen);
            doc.text(lineasDescripcion, margen, posY);
            
            // Leyenda de colores para estados
            posY += 25;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Leyenda de estados:", margen, posY);
            posY += 8;
            doc.setFont(undefined, 'normal');
            
            // Cumplido
            doc.setFillColor(colores.secundario[0], colores.secundario[1], colores.secundario[2], 0.3);
            doc.rect(margen, posY - 5, 15, 7, 'F');
            doc.text("Cumplido (≥ 100%)", margen + 20, posY);
            
            // Parcial
            posY += 10;
            doc.setFillColor(colores.alerta[0], colores.alerta[1], colores.alerta[2], 0.3);
            doc.rect(margen, posY - 5, 15, 7, 'F');
            doc.text("Parcial (90-99%)", margen + 20, posY);
            
            // Crítico
            posY += 10;
            doc.setFillColor(colores.peligro[0], colores.peligro[1], colores.peligro[2], 0.3);
            doc.rect(margen, posY - 5, 15, 7, 'F');
            doc.text("Crítico (< 90%)", margen + 20, posY);
            
            // ============ PÁGINA DE TABLA DE DATOS ============
            // Añadir nueva página para la tabla
            doc.addPage();
            posY = agregarEncabezado(2);
            agregarPiePagina();
            
            // Título de la sección
            posY += 10;
            doc.setTextColor(colores.primario[0], colores.primario[1], colores.primario[2]);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RESULTADOS DETALLADOS', anchoPagina / 2, posY, { align: 'center' });
            
            // Crear tabla manual
            posY += 10;
            const posYFinTabla = crearTablaManual(datos, posY);
            
            // ============ PÁGINA DE GRÁFICOS ============
            // Capturar y añadir gráficos si existen
            try {
                // Verificar si hay algún gráfico para el informe actual
                let hayGraficos = false;
                let graficos = [];
                
                if (tipo === 'centro') {
                    const graficoEvolucion = document.getElementById('evolucionChart');
                    const graficoDistribucion = document.getElementById('distribucionChart');
                    
                    if (graficoEvolucion) {
                        graficos.push({
                            elemento: graficoEvolucion,
                            titulo: 'Evolución Mensual',
                            ancho: anchoPagina - 2 * margen,
                            alto: 80
                        });
                        hayGraficos = true;
                    }
                    
                    if (graficoDistribucion) {
                        graficos.push({
                            elemento: graficoDistribucion,
                            titulo: 'Distribución por Tipo de Indicador',
                            ancho: anchoPagina - 2 * margen,
                            alto: 80
                        });
                        hayGraficos = true;
                    }
                } else if (tipo === 'indicador') {
                    const graficoComparativo = document.getElementById('comparativoIndicadorChart');
                    if (graficoComparativo) {
                        graficos.push({
                            elemento: graficoComparativo,
                            titulo: 'Comparativo Entre Centros',
                            ancho: anchoPagina - 2 * margen,
                            alto: 80
                        });
                        hayGraficos = true;
                    }
                } else if (tipo === 'comparativo') {
                    const graficoComparativo = document.getElementById('comparativoChart');
                    if (graficoComparativo) {
                        graficos.push({
                            elemento: graficoComparativo,
                            titulo: 'Cumplimiento por Categoría y Centro',
                            ancho: anchoPagina - 2 * margen,
                            alto: 90
                        });
                        hayGraficos = true;
                    }
                }
                
                // Si hay gráficos, crear una página para ellos
                if (hayGraficos) {
                    doc.addPage();
                    posY = agregarEncabezado(3);
                    agregarPiePagina();
                    
                    // Título de la sección
                    posY += 10;
                    doc.setTextColor(colores.primario[0], colores.primario[1], colores.primario[2]);
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text('VISUALIZACIÓN GRÁFICA', anchoPagina / 2, posY, { align: 'center' });
                    
                    // Agregar cada gráfico
                    posY += 15;
                    
                    graficos.forEach((grafico, index) => {
                        // Si no es el primer gráfico, agregar espacio
                        if (index > 0) {
                            posY += graficos[index-1].alto + 20;
                        }
                        
                        // Título del gráfico
                        doc.setTextColor(80, 80, 80);
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(grafico.titulo, anchoPagina / 2, posY, { align: 'center' });
                        
                        // Agregar el gráfico
                        try {
                            const imgData = grafico.elemento.toDataURL('image/png');
                            doc.addImage(imgData, 'PNG', margen, posY + 5, grafico.ancho, grafico.alto);
                        } catch (e) {
                            console.warn('Error al capturar gráfico:', e);
                            // Si falla la captura, mostrar un mensaje
                            doc.setFillColor(245, 245, 245);
                            doc.roundedRect(margen, posY + 5, grafico.ancho, grafico.alto, 2, 2, 'F');
                            doc.setTextColor(150, 150, 150);
                            doc.text('Error al cargar gráfico', anchoPagina / 2, posY + 5 + grafico.alto / 2, { align: 'center' });
                        }
                    });
                }
            } catch (error) {
                console.warn('Error al procesar gráficos:', error);
            }
            
            // Guardar el PDF
            doc.save(nombreArchivo);
            
            mostrarCargando(false);
            mostrarNotificacion('PDF exportado correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar a PDF:', error);
            mostrarCargando(false);
            mostrarNotificacion('Error al exportar datos: ' + error.message, 'error');
        }
    }, 1000);
}

/**
 * Recorta un texto a una longitud específica y añade puntos suspensivos
 * @param {string} texto - Texto a recortar
 * @param {number} longitud - Longitud máxima
 * @returns {string} Texto recortado
 */
function recortarTexto(texto, longitud) {
    if (!texto) return '';
    return texto.length > longitud ? texto.substring(0, longitud) + '...' : texto;
}

/**
 * Formatea un número con separador de miles
 * @param {number} numero - Número a formatear
 * @returns {string} Número formateado
 */
function formatearNumero(numero) {
    if (numero === undefined || numero === null) return '-';
    return numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

/**
 * Formatea un valor según su tipo (porcentaje o número)
 * @param {number} valor - Valor a formatear
 * @param {string} tipo - Tipo de valor ('porcentaje', 'tasa', etc.)
 * @returns {string} Valor formateado
 */
function formatearValor(valor, tipo) {
    if (valor === undefined || valor === null) return '-';
    
    if (tipo === 'porcentaje') {
        return valor.toFixed(2) + '%';
    } else {
        return valor.toFixed(2);
    }
}

// ==================== CONFIGURACIÓN DE EVENTOS ====================

/**
 * Configura los event listeners para los botones de exportación
 * Esta función debe llamarse al cargar la página
 */
function configurarEventosExportacion() {
  console.log("Configurando eventos de exportación...");
  
  // Botones para exportar detalles de centro
  const btnExcelCentro = document.getElementById('exportCentroExcelBtn');
  const btnPdfCentro = document.getElementById('exportCentroPdfBtn');
  
  if (btnExcelCentro) {
    btnExcelCentro.addEventListener('click', function() {
      console.log("Exportando centro a Excel...");
      exportarExcel('centro');
    });
  }
  
  if (btnPdfCentro) {
    btnPdfCentro.addEventListener('click', function() {
      console.log("Exportando centro a PDF...");
      exportarPDF('centro');
    });
  }
  
  // Botones para exportar detalles de indicador
  const btnExcelIndicador = document.getElementById('exportIndicadorExcelBtn');
  const btnPdfIndicador = document.getElementById('exportIndicadorPdfBtn');
  
  if (btnExcelIndicador) {
    btnExcelIndicador.addEventListener('click', function() {
      console.log("Exportando indicador a Excel...");
      exportarExcel('indicador');
    });
  }
  
  if (btnPdfIndicador) {
    btnPdfIndicador.addEventListener('click', function() {
      console.log("Exportando indicador a PDF...");
      exportarPDF('indicador');
    });
  }
  
  // Botones para exportar detalles comparativos
  const btnExcelComparativo = document.getElementById('exportComparativoExcelBtn');
  const btnPdfComparativo = document.getElementById('exportComparativoPdfBtn');
  
  if (btnExcelComparativo) {
    btnExcelComparativo.addEventListener('click', function() {
      console.log("Exportando comparativo a Excel...");
      exportarExcel('comparativo');
    });
  }
  
  if (btnPdfComparativo) {
    btnPdfComparativo.addEventListener('click', function() {
      console.log("Exportando comparativo a PDF...");
      exportarPDF('comparativo');
    });
  }
  
  // Botón general de exportación de detalle
  const btnExportDetail = document.getElementById('exportDetailBtn');
  if (btnExportDetail) {
    btnExportDetail.addEventListener('click', function() {
      console.log("Exportando detalle...");
      
      // Determinar qué vista está activa y exportar según corresponda
      if (document.getElementById('centro-content') && 
          document.getElementById('centro-content').classList.contains('active')) {
        exportarPDF('centro');
      } 
      else if (document.getElementById('indicador-content') && 
              document.getElementById('indicador-content').classList.contains('active')) {
        exportarPDF('indicador');
      }
      else if (document.getElementById('comparativo-content') && 
              document.getElementById('comparativo-content').classList.contains('active')) {
        exportarPDF('comparativo');
      }
      else {
        // Si no se puede determinar, usar la vista de centro por defecto
        exportarPDF('centro');
      }
    });
  }
  
  console.log("Configuración de eventos de exportación completada.");
}

// ==================== CARGAR DINÁMICAMENTE LIBRERÍAS FALTANTES ====================

/**
 * Carga dinámicamente las librerías necesarias para la exportación
 * si no están disponibles
 */
function cargarLibreriasExportacion() {
  console.log("Verificando librerías de exportación...");
  
  // Verificar SheetJS (XLSX)
  if (typeof XLSX === 'undefined') {
    console.warn("Librería XLSX no encontrada. Cargando dinámicamente...");
    
    const xlsxScript = document.createElement('script');
    xlsxScript.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
    xlsxScript.onload = function() {
      console.log("Librería XLSX cargada correctamente");
    };
    document.head.appendChild(xlsxScript);
  } else {
    console.log("Librería XLSX ya está disponible");
  }
  
  // Verificar jsPDF
  if (typeof window.jspdf === 'undefined') {
    console.warn("Librería jsPDF no encontrada. Cargando dinámicamente...");
    
    const jspdfScript = document.createElement('script');
    jspdfScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
    jspdfScript.onload = function() {
      console.log("Librería jsPDF cargada correctamente");
      
      // Cargar el plugin AutoTable después de jsPDF
      if (typeof window.jspdf.jsPDF.prototype.autoTable === 'undefined') {
        console.warn("Plugin AutoTable no encontrado. Cargando dinámicamente...");
        
        const autoTableScript = document.createElement('script');
        autoTableScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js";
        autoTableScript.onload = function() {
          console.log("Plugin AutoTable cargado correctamente");
        };
        document.head.appendChild(autoTableScript);
      }
    };
    document.head.appendChild(jspdfScript);
  } else {
    console.log("Librería jsPDF ya está disponible");
    
    // Verificar AutoTable si jsPDF ya está disponible
    if (typeof window.jspdf.jsPDF.prototype.autoTable === 'undefined') {
      console.warn("Plugin AutoTable no encontrado. Cargando dinámicamente...");
      
      const autoTableScript = document.createElement('script');
      autoTableScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js";
      autoTableScript.onload = function() {
        console.log("Plugin AutoTable cargado correctamente");
      };
      document.head.appendChild(autoTableScript);
    } else {
      console.log("Plugin AutoTable ya está disponible");
    }
  }
}

// ==================== INICIALIZACIÓN SIMPLIFICADA ====================

// Inicializar las funciones de exportación cuando se carga el documento
document.addEventListener('DOMContentLoaded', function() {
  console.log("Inicializando funcionalidades de exportación simplificadas...");
  
  // Cargar librerías necesarias
  cargarLibreriasExportacion();
  
  // Configurar eventos después de un retraso para asegurar que todo está cargado
  setTimeout(function() {
    configurarEventosExportacion();
  }, 1000);
  
  console.log("Inicialización de funcionalidades de exportación completada.");
});

// Ejecutar la inicialización inmediatamente si el documento ya está cargado
if (document.readyState === 'complete' || document.readyState === 'interactive') {
  setTimeout(function() {
    cargarLibreriasExportacion();
    configurarEventosExportacion();
  }, 1000);
}

</script>

</html>